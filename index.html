<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link href="style.css" rel="stylesheet" type="text/css" /><title>The Definitive Guide to DAX: Business intelligence with Microsoft Power BI, SQL Server Analysis Services, and Excel, Second Edition (for pre sume)</title></head><body><div class="calibre1" id="calibre_link-0">
<div id="calibre_link-2908" class="calibre2">
<div id="calibre_link-2909" class="calibre3"><section type="chapter" class="calibre4">
<h1 class="title"><span type="pagebreak" id="calibre_link-2910"></span>The Definitive Guide to DAX: Business intelligence with Microsoft Power BI, SQL Server Analysis Services, and Excel</h1>
<p class="edition"><em class="calibre5">Second Edition</em></p>
<p class="edition">Marco Russo and Alberto Ferrari</p>
<div class="pub"><img src="images/000342.jpg" alt="Image" class="calibre6" /></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1">
<div id="calibre_link-2911" class="calibre2">
<div id="calibre_link-2912" class="calibre3"><section type="chapter" class="calibre4">
<div class="copyright">
<p class="edition"><span type="pagebreak" id="calibre_link-2913"></span><strong class="calibre7">Published with the authorization of Microsoft Corporation by:</strong></p>
<p class="edition"><strong class="calibre7">Pearson Education, Inc.</strong></p>
<p class="edition"><strong class="calibre7">Copyright © 2020 by Alberto Ferrari and Marco Russo</strong></p>
<p class="edition">All rights reserved. This publication is protected by copyright, and permission must be obtained from the publisher prior to any prohibited reproduction, storage in a retrieval system, or transmission in any form or by any means, electronic, mechanical, photocopying, recording, or likewise. For information regarding permissions, request forms, and the appropriate contacts within the Pearson Education Global Rights &amp; Permissions Department, please visit <a href="http://www.pearsoned.com/permissions/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">www.pearsoned.com/permissions/</a>. No patent liability is assumed with respect to the use of the information contained herein. Although every precaution has been taken in the preparation of this book, the publisher and author assume no responsibility for errors or omissions. Nor is any liability assumed for damages resulting from the use of the information contained herein.</p>
<p class="edition">ISBN-13: 978-1-5093-0697-8</p>
<p class="edition">ISBN-10: 1-5093-0697-8</p>
<p class="edition">Library of Congress Control Number: 2019930884</p>
<p class="edition"><code class="calibre9">ScoutAutomatedPrintCode</code></p>
<p class="edition">Trademarks</p>
<p class="edition">Microsoft and the trademarks listed at <a href="http://www.microsoft.com" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://www.microsoft.com</a> on the “Trademarks” webpage are trademarks of the Microsoft group of companies. All other marks are property of their respective owners.</p>
<p class="edition">Warning and Disclaimer</p>
<p class="edition">Every effort has been made to make this book as complete and as accurate as possible, but no warranty or fitness is implied. The information provided is on an “as is” basis. The authors, the publisher, and Microsoft Corporation shall have neither liability nor responsibility to any person or entity with respect to any loss or damages arising from the information contained in this book.</p>
<p class="edition">Special Sales</p>
<p class="edition">For information about buying this title in bulk quantities, or for special sales opportunities (which may include electronic versions; custom cover designs; and content particular to your business, training goals, marketing focus, or branding interests), please contact our corporate sales department at <a href="mailto:corpsales@pearsoned.com" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">corpsales@pearsoned.com</a> or (800) 382-3419.</p>
<p class="edition">For government sales inquiries, please contact <a href="mailto:governmentsales@pearsoned.com" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">governmentsales@pearsoned.com</a>.</p>
<p class="edition">For questions about sales outside the U.S., please contact <a href="mailto:intlcs@pearson.com" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">intlcs@pearson.com</a>.</p>
<p class="edition"><strong class="calibre7">EDITOR-IN-CHIEF</strong></p>
<p class="edition">Brett Bartow</p>
<p class="edition"><strong class="calibre7">EXECUTIVE EDITOR</strong></p>
<p class="edition">Loretta Yates</p>
<p class="edition"><strong class="calibre7">DEVELOPMENT EDITOR</strong></p>
<p class="edition">Mark Renfrow</p>
<p class="edition"><strong class="calibre7">MANAGING EDITOR</strong></p>
<p class="edition">Sandra Schroeder</p>
<p class="edition"><strong class="calibre7">SENIOR PROJECT EDITOR</strong></p>
<p class="edition">Tonya Simpson</p>
<p class="edition"><strong class="calibre7">COPY EDITOR</strong></p>
<p class="edition">Chuck Hutchinson</p>
<p class="edition"><strong class="calibre7">INDEXER</strong></p>
<p class="edition">Ken Johnson</p>
<p class="edition"><strong class="calibre7">PROOFREADER</strong></p>
<p class="edition">Abigail Manheim</p>
<p class="edition"><strong class="calibre7">TECHNICAL EDITOR</strong></p>
<p class="edition">Daniil Maslyuk</p>
<p class="edition"><strong class="calibre7">EDITORIAL ASSISTANT</strong></p>
<p class="edition">Cindy Teeters</p>
<p class="edition"><strong class="calibre7">COVER DESIGNER</strong></p>
<p class="edition">Twist Creative, Seattle</p>
<p class="edition"><strong class="calibre7">COMPOSITOR</strong></p>
<p class="edition">codeMantra</p>
</div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2">
<div id="calibre_link-2914" class="calibre2">
<div id="calibre_link-2915" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-2916"><span type="pagebreak" id="calibre_link-2917"></span>Contents at a Glance</h2>
<p class="edition"><em class="calibre5"><a href="#calibre_link-3" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Foreword</a></em></p>
<p class="edition"><em class="calibre5"><a href="#calibre_link-4" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introduction to the second edition</a></em></p>
<p class="edition"><em class="calibre5"><a href="#calibre_link-5" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introduction to the first edition</a></em></p>
<p class="edition"><a href="#calibre_link-6" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 1&nbsp;&nbsp;&nbsp;<strong class="calibre7">What is DAX?</strong></a></p>
<p class="edition"><a href="#calibre_link-7" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 2&nbsp;&nbsp;&nbsp;<strong class="calibre7">Introducing DAX</strong></a></p>
<p class="edition"><a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 3&nbsp;&nbsp;&nbsp;<strong class="calibre7">Using basic table functions</strong></a></p>
<p class="edition"><a href="#calibre_link-9" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 4&nbsp;&nbsp;&nbsp;<strong class="calibre7">Understanding evaluation contexts</strong></a></p>
<p class="edition"><a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 5&nbsp;&nbsp;&nbsp;<strong class="calibre7">Understanding <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-11" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 6&nbsp;&nbsp;&nbsp;<strong class="calibre7">Variables</strong></a></p>
<p class="edition"><a href="#calibre_link-12" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 7&nbsp;&nbsp;&nbsp;<strong class="calibre7">Working with iterators and with <em class="calibre5">CALCULATE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-13" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 8&nbsp;&nbsp;&nbsp;<strong class="calibre7">Time intelligence calculations</strong></a></p>
<p class="edition"><a href="#calibre_link-14" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 9&nbsp;&nbsp;&nbsp;<strong class="calibre7">Calculation groups</strong></a></p>
<p class="edition"><a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 10 <strong class="calibre7">Working with the filter context</strong></a></p>
<p class="edition"><a href="#calibre_link-16" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 11 <strong class="calibre7">Handling hierarchies</strong></a></p>
<p class="edition"><a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 12 <strong class="calibre7">Working with tables</strong></a></p>
<p class="edition"><a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 13 <strong class="calibre7">Authoring queries</strong></a></p>
<p class="edition"><a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 14 <strong class="calibre7">Advanced DAX concepts</strong></a></p>
<p class="edition"><a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 15 <strong class="calibre7">Advanced relationships</strong></a></p>
<p class="edition"><a href="#calibre_link-21" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 16 <strong class="calibre7">Advanced calculations in DAX</strong></a></p>
<p class="edition"><a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 17 <strong class="calibre7">The DAX engines</strong></a></p>
<p class="edition"><a href="#calibre_link-23" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 18 <strong class="calibre7">Optimizing VertiPaq</strong></a></p>
<p class="edition"><a href="#calibre_link-24" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 19 <strong class="calibre7">Analyzing DAX query plans</strong></a></p>
<p class="edition"><a href="#calibre_link-25" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CHAPTER 20 <strong class="calibre7">Optimizing DAX</strong></a></p>
<p class="edition"><em class="calibre5"><a href="#calibre_link-26" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Index</a></em><span type="pagebreak" id="calibre_link-2918"></span></p>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-27">
<div id="calibre_link-2919" class="calibre2">
<div id="calibre_link-2920" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-2921"><span type="pagebreak" id="calibre_link-2922"></span>Contents</h2>
<p class="edition"><em class="calibre5"><a href="#calibre_link-3" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Foreword</a></em></p>
<p class="edition"><em class="calibre5"><a href="#calibre_link-4" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introduction to the second edition</a></em></p>
<p class="edition"><em class="calibre5"><a href="#calibre_link-5" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introduction to the first edition</a></em></p>
<p class="edition"><a href="#calibre_link-6" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 1&nbsp;&nbsp;&nbsp;What is DAX?</a></p>
<p class="edition"><a href="#calibre_link-28" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding the data model</a></p>
<p class="edition"><a href="#calibre_link-29" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding the direction of a relationship</a></p>
<p class="edition"><a href="#calibre_link-30" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">DAX for Excel users</a></p>
<p class="edition"><a href="#calibre_link-31" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Cells versus tables</a></p>
<p class="edition"><a href="#calibre_link-32" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Excel and DAX: Two functional languages</a></p>
<p class="edition"><a href="#calibre_link-33" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Iterators in DAX</a></p>
<p class="edition"><a href="#calibre_link-34" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">DAX requires theory</a></p>
<p class="edition"><a href="#calibre_link-35" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">DAX for SQL developers</a></p>
<p class="edition"><a href="#calibre_link-36" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Relationship handling</a></p>
<p class="edition"><a href="#calibre_link-37" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">DAX is a functional language</a></p>
<p class="edition"><a href="#calibre_link-38" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">DAX as a programming and querying language</a></p>
<p class="edition"><a href="#calibre_link-39" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Subqueries and conditions in DAX and SQL</a></p>
<p class="edition"><a href="#calibre_link-40" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">DAX for MDX developers</a></p>
<p class="edition"><a href="#calibre_link-41" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Multidimensional versus Tabular</a></p>
<p class="edition"><a href="#calibre_link-42" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">DAX as a programming and querying language</a></p>
<p class="edition"><a href="#calibre_link-43" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Hierarchies</a></p>
<p class="edition"><a href="#calibre_link-44" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Leaf-level calculations</a></p>
<p class="edition"><a href="#calibre_link-45" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">DAX for Power BI users</a></p>
<p class="edition"><a href="#calibre_link-7" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 2&nbsp;&nbsp;&nbsp;Introducing DAX</a></p>
<p class="edition"><a href="#calibre_link-46" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding DAX calculations</a></p>
<p class="edition"><a href="#calibre_link-47" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">DAX data types</a></p>
<p class="edition"><a href="#calibre_link-48" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">DAX operators</a></p>
<p class="edition"><a href="#calibre_link-49" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table constructors</a></p>
<p class="edition"><a href="#calibre_link-50" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conditional statements</a></p>
<p class="edition"><span type="pagebreak" id="calibre_link-2923"></span><a href="#calibre_link-51" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding calculated columns and measures</a></p>
<p class="edition"><a href="#calibre_link-52" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Calculated columns</a></p>
<p class="edition"><a href="#calibre_link-53" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Measures</a></p>
<p class="edition"><a href="#calibre_link-54" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing variables</a></p>
<p class="edition"><a href="#calibre_link-55" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Handling errors in DAX expressions</a></p>
<p class="edition"><a href="#calibre_link-56" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conversion errors</a></p>
<p class="edition"><a href="#calibre_link-57" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Arithmetic operations errors</a></p>
<p class="edition"><a href="#calibre_link-58" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Intercepting errors</a></p>
<p class="edition"><a href="#calibre_link-59" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Generating errors</a></p>
<p class="edition"><a href="#calibre_link-60" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Formatting DAX code</a></p>
<p class="edition"><a href="#calibre_link-61" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing aggregators and iterators</a></p>
<p class="edition"><a href="#calibre_link-62" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using common DAX functions</a></p>
<p class="edition"><a href="#calibre_link-63" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Aggregation functions</a></p>
<p class="edition"><a href="#calibre_link-64" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Logical functions</a></p>
<p class="edition"><a href="#calibre_link-65" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Information functions</a></p>
<p class="edition"><a href="#calibre_link-66" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Mathematical functions</a></p>
<p class="edition"><a href="#calibre_link-67" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Trigonometric functions</a></p>
<p class="edition"><a href="#calibre_link-68" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Text functions</a></p>
<p class="edition"><a href="#calibre_link-69" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conversion functions</a></p>
<p class="edition"><a href="#calibre_link-70" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Date and time functions</a></p>
<p class="edition"><a href="#calibre_link-71" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Relational functions</a></p>
<p class="edition"><a href="#calibre_link-72" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 3&nbsp;&nbsp;&nbsp;Using basic table functions</a></p>
<p class="edition"><a href="#calibre_link-73" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing table functions</a></p>
<p class="edition"><a href="#calibre_link-74" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing <strong class="calibre7"><em class="calibre5">EVALUATE</em></strong> syntax</a></p>
<p class="edition"><a href="#calibre_link-75" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">FILTER</em></strong></a></p>
<p class="edition"><a href="#calibre_link-76" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing <strong class="calibre7"><em class="calibre5">ALL</em></strong> and <strong class="calibre7"><em class="calibre5">ALLEXCEPT</em></strong></a></p>
<p class="edition"><a href="#calibre_link-77" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">VALUES</em></strong>, <strong class="calibre7"><em class="calibre5">DISTINCT</em></strong>, and the blank row</a></p>
<p class="edition"><a href="#calibre_link-78" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using tables as scalar values</a></p>
<p class="edition"><a href="#calibre_link-79" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing <strong class="calibre7"><em class="calibre5">ALLSELECTED</em></strong></a></p>
<p class="edition"><a href="#calibre_link-80" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><span type="pagebreak" id="calibre_link-2924"></span><a href="#calibre_link-9" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 4&nbsp;&nbsp;&nbsp;Understanding evaluation contexts</a></p>
<p class="edition"><a href="#calibre_link-81" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing evaluation contexts</a></p>
<p class="edition"><a href="#calibre_link-82" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding filter contexts</a></p>
<p class="edition"><a href="#calibre_link-83" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding the row context</a></p>
<p class="edition"><a href="#calibre_link-84" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Testing your understanding of evaluation contexts</a></p>
<p class="edition"><a href="#calibre_link-85" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">SUM</em></strong> in a calculated column</a></p>
<p class="edition"><a href="#calibre_link-86" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using columns in a measure</a></p>
<p class="edition"><a href="#calibre_link-87" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using the row context with iterators</a></p>
<p class="edition"><a href="#calibre_link-88" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Nested row contexts on different tables</a></p>
<p class="edition"><a href="#calibre_link-89" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Nested row contexts on the same table</a></p>
<p class="edition"><a href="#calibre_link-90" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using the <strong class="calibre7"><em class="calibre5">EARLIER</em></strong> function</a></p>
<p class="edition"><a href="#calibre_link-91" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">FILTER</em></strong>, <strong class="calibre7"><em class="calibre5">ALL</em></strong>, and context interactions</a></p>
<p class="edition"><a href="#calibre_link-92" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with several tables</a></p>
<p class="edition"><a href="#calibre_link-93" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Row contexts and relationships</a></p>
<p class="edition"><a href="#calibre_link-94" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Filter context and relationships</a></p>
<p class="edition"><a href="#calibre_link-95" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">DISTINCT</em></strong> and <strong class="calibre7"><em class="calibre5">SUMMARIZE</em></strong> in filter contexts</a></p>
<p class="edition"><a href="#calibre_link-96" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5&nbsp;&nbsp;&nbsp;Understanding <strong class="calibre7"><em class="calibre5">CALCULATE</em></strong> and <strong class="calibre7"><em class="calibre5">CALCULATETABLE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-97" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing <strong class="calibre7"><em class="calibre5">CALCULATE</em></strong> and <strong class="calibre7"><em class="calibre5">CALCULATETABLE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-98" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Creating filter contexts</a></p>
<p class="edition"><a href="#calibre_link-99" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing <strong class="calibre7"><em class="calibre5">CALCULATE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-100" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">CALCULATE</em></strong> to compute percentages</a></p>
<p class="edition"><a href="#calibre_link-101" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing <strong class="calibre7"><em class="calibre5">KEEPFILTERS</em></strong></a></p>
<p class="edition"><a href="#calibre_link-102" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Filtering a single column</a></p>
<p class="edition"><a href="#calibre_link-103" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Filtering with complex conditions</a></p>
<p class="edition"><a href="#calibre_link-104" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Evaluation order in <strong class="calibre7"><em class="calibre5">CALCULATE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-105" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding context transition</a></p>
<p class="edition"><a href="#calibre_link-106" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Row context and filter context recap</a></p>
<p class="edition"><a href="#calibre_link-107" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing context transition</a></p>
<p class="edition"><a href="#calibre_link-108" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Context transition in calculated columns</a></p>
<p class="edition"><a href="#calibre_link-109" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Context transition with measures</a></p>
<p class="edition"><span type="pagebreak" id="calibre_link-2925"></span><a href="#calibre_link-110" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding circular dependencies</a></p>
<p class="edition"><a href="#calibre_link-111" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><strong class="calibre7"><em class="calibre5">CALCULATE</em></strong> modifiers</a></p>
<p class="edition"><a href="#calibre_link-112" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">USERELATIONSHIP</em></strong></a></p>
<p class="edition"><a href="#calibre_link-113" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">CROSSFILTER</em></strong></a></p>
<p class="edition"><a href="#calibre_link-114" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">KEEPFILTERS</em></strong></a></p>
<p class="edition"><a href="#calibre_link-115" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">ALL</em></strong> in <strong class="calibre7"><em class="calibre5">CALCULATE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-116" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing <strong class="calibre7"><em class="calibre5">ALL</em></strong> and <strong class="calibre7"><em class="calibre5">ALLSELECTED</em></strong> with no parameters</a></p>
<p class="edition"><a href="#calibre_link-117" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><strong class="calibre7"><em class="calibre5">CALCULATE</em></strong> rules</a></p>
<p class="edition"><a href="#calibre_link-11" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 6&nbsp;&nbsp;&nbsp;Variables</a></p>
<p class="edition"><a href="#calibre_link-118" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing <strong class="calibre7"><em class="calibre5">VAR</em></strong> syntax</a></p>
<p class="edition"><a href="#calibre_link-119" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding that variables are constant</a></p>
<p class="edition"><a href="#calibre_link-120" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding the scope of variables</a></p>
<p class="edition"><a href="#calibre_link-121" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using table variables</a></p>
<p class="edition"><a href="#calibre_link-122" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding lazy evaluation</a></p>
<p class="edition"><a href="#calibre_link-123" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Common patterns using variables</a></p>
<p class="edition"><a href="#calibre_link-124" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-12" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 7&nbsp;&nbsp;&nbsp;Working with iterators and with <strong class="calibre7"><em class="calibre5">CALCULATE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-125" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using iterators</a></p>
<p class="edition"><a href="#calibre_link-126" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding iterator cardinality</a></p>
<p class="edition"><a href="#calibre_link-127" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Leveraging context transition in iterators</a></p>
<p class="edition"><a href="#calibre_link-128" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">CONCATENATEX</em></strong></a></p>
<p class="edition"><a href="#calibre_link-129" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Iterators returning tables</a></p>
<p class="edition"><a href="#calibre_link-130" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Solving common scenarios with iterators</a></p>
<p class="edition"><a href="#calibre_link-131" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Computing averages and moving averages</a></p>
<p class="edition"><a href="#calibre_link-132" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">RANKX</em></strong></a></p>
<p class="edition"><a href="#calibre_link-133" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Changing calculation granularity</a></p>
<p class="edition"><a href="#calibre_link-134" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-13" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 8&nbsp;&nbsp;&nbsp;Time intelligence calculations</a></p>
<p class="edition"><a href="#calibre_link-135" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing time intelligence</a></p>
<p class="edition"><a href="#calibre_link-136" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Automatic Date/Time in Power BI</a></p>
<p class="edition"><a href="#calibre_link-137" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Automatic date columns in Power Pivot for Excel</a></p>
<p class="edition"><a href="#calibre_link-138" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Date table template in Power Pivot for Excel</a></p>
<p class="edition"><span type="pagebreak" id="calibre_link-2926"></span><a href="#calibre_link-139" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Building a date table</a></p>
<p class="edition"><a href="#calibre_link-140" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">CALENDAR</em></strong> and <strong class="calibre7"><em class="calibre5">CALENDARAUTO</em></strong></a></p>
<p class="edition"><a href="#calibre_link-141" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with multiple dates</a></p>
<p class="edition"><a href="#calibre_link-142" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Handling multiple relationships to the <strong class="calibre7"><em class="calibre5">Date</em></strong> table</a></p>
<p class="edition"><a href="#calibre_link-143" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Handling multiple date tables</a></p>
<p class="edition"><a href="#calibre_link-144" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding basic time intelligence calculations</a></p>
<p class="edition"><a href="#calibre_link-145" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using Mark as Date Table</a></p>
<p class="edition"><a href="#calibre_link-146" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing basic time intelligence functions</a></p>
<p class="edition"><a href="#calibre_link-147" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using year-to-date, quarter-to-date, and month-to-date</a></p>
<p class="edition"><a href="#calibre_link-148" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Computing time periods from prior periods</a></p>
<p class="edition"><a href="#calibre_link-149" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Mixing time intelligence functions</a></p>
<p class="edition"><a href="#calibre_link-150" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Computing a difference over previous periods</a></p>
<p class="edition"><a href="#calibre_link-151" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Computing a moving annual total</a></p>
<p class="edition"><a href="#calibre_link-152" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using the right call order for nested time intelligence functions</a></p>
<p class="edition"><a href="#calibre_link-153" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding semi-additive calculations</a></p>
<p class="edition"><a href="#calibre_link-154" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">LASTDATE</em></strong> and <strong class="calibre7"><em class="calibre5">LASTNONBLANK</em></strong></a></p>
<p class="edition"><a href="#calibre_link-155" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with opening and closing balances</a></p>
<p class="edition"><a href="#calibre_link-156" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding advanced time intelligence calculations</a></p>
<p class="edition"><a href="#calibre_link-157" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding periods to date</a></p>
<p class="edition"><a href="#calibre_link-158" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">DATEADD</em></strong></a></p>
<p class="edition"><a href="#calibre_link-159" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">FIRSTDATE, LASTDATE, FIRSTNONBLANK</em>,</strong> and <strong class="calibre7"><em class="calibre5">LASTNONBLANK</em></strong></a></p>
<p class="edition"><a href="#calibre_link-160" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using drillthrough with time intelligence</a></p>
<p class="edition"><a href="#calibre_link-161" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with custom calendars</a></p>
<p class="edition"><a href="#calibre_link-162" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with weeks</a></p>
<p class="edition"><a href="#calibre_link-163" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Custom year-to-date, quarter-to-date, and month-to-date</a></p>
<p class="edition"><a href="#calibre_link-164" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-14" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 9&nbsp;&nbsp;&nbsp;Calculation groups</a></p>
<p class="edition"><a href="#calibre_link-165" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing calculation groups</a></p>
<p class="edition"><a href="#calibre_link-166" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Creating calculation groups</a></p>
<p class="edition"><a href="#calibre_link-167" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding calculation groups</a></p>
<p class="edition"><a href="#calibre_link-168" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding calculation item application</a></p>
<p class="edition"><a href="#calibre_link-169" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding calculation group precedence</a></p>
<p class="edition"><a href="#calibre_link-170" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Including and excluding measures from calculation items</a></p>
<p class="edition"><span type="pagebreak" id="calibre_link-2927"></span><a href="#calibre_link-171" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding sideways recursion</a></p>
<p class="edition"><a href="#calibre_link-172" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using the best practices</a></p>
<p class="edition"><a href="#calibre_link-173" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10 Working with the filter context</a></p>
<p class="edition"><a href="#calibre_link-174" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">HASONEVALUE</em></strong> and <strong class="calibre7"><em class="calibre5">SELECTEDVALUE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-175" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing <strong class="calibre7"><em class="calibre5">ISFILTERED</em></strong> and <strong class="calibre7"><em class="calibre5">ISCROSSFILTERED</em></strong></a></p>
<p class="edition"><a href="#calibre_link-176" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding differences between <strong class="calibre7"><em class="calibre5">VALUES</em></strong> and <strong class="calibre7"><em class="calibre5">FILTERS</em></strong></a></p>
<p class="edition"><a href="#calibre_link-177" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding the difference between <strong class="calibre7"><em class="calibre5">ALLEXCEPT</em></strong> and <strong class="calibre7"><em class="calibre5">ALL</em></strong>/<strong class="calibre7"><em class="calibre5">VALUES</em></strong></a></p>
<p class="edition"><a href="#calibre_link-178" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">ALL</em></strong> to avoid context transition</a></p>
<p class="edition"><a href="#calibre_link-179" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">ISEMPTY</em></strong></a></p>
<p class="edition"><a href="#calibre_link-180" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing data lineage and <strong class="calibre7"><em class="calibre5">TREATAS</em></strong></a></p>
<p class="edition"><a href="#calibre_link-181" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding arbitrarily shaped filters</a></p>
<p class="edition"><a href="#calibre_link-182" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-16" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 11 Handling hierarchies</a></p>
<p class="edition"><a href="#calibre_link-183" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Computing percentages over hierarchies</a></p>
<p class="edition"><a href="#calibre_link-184" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Handling parent/child hierarchies</a></p>
<p class="edition"><a href="#calibre_link-185" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 12 Working with tables</a></p>
<p class="edition"><a href="#calibre_link-186" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">CALCULATETABLE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-187" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Manipulating tables</a></p>
<p class="edition"><a href="#calibre_link-188" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">ADDCOLUMNS</em></strong></a></p>
<p class="edition"><a href="#calibre_link-189" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">SUMMARIZE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-190" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">CROSSJOIN</em></strong></a></p>
<p class="edition"><a href="#calibre_link-191" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">UNION</em></strong></a></p>
<p class="edition"><a href="#calibre_link-192" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">INTERSECT</em></strong></a></p>
<p class="edition"><a href="#calibre_link-193" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">EXCEPT</em></strong></a></p>
<p class="edition"><a href="#calibre_link-194" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using tables as filters</a></p>
<p class="edition"><a href="#calibre_link-195" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Implementing <strong class="calibre7"><em class="calibre5">OR</em></strong> conditions</a></p>
<p class="edition"><a href="#calibre_link-196" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Narrowing sales computation to the first year’s customers</a></p>
<p class="edition"><span type="pagebreak" id="calibre_link-2928"></span><a href="#calibre_link-197" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Computing new customers</a></p>
<p class="edition"><a href="#calibre_link-198" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Reusing table expressions with <strong class="calibre7"><em class="calibre5">DETAILROWS</em></strong></a></p>
<p class="edition"><a href="#calibre_link-199" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Creating calculated tables</a></p>
<p class="edition"><a href="#calibre_link-200" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">SELECTCOLUMNS</em></strong></a></p>
<p class="edition"><a href="#calibre_link-201" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Creating static tables with <strong class="calibre7"><em class="calibre5">ROW</em></strong></a></p>
<p class="edition"><a href="#calibre_link-202" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Creating static tables with <strong class="calibre7"><em class="calibre5">DATATABLE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-203" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">GENERATESERIES</em></strong></a></p>
<p class="edition"><a href="#calibre_link-204" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 13 Authoring queries</a></p>
<p class="edition"><a href="#calibre_link-205" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing DAX Studio</a></p>
<p class="edition"><a href="#calibre_link-206" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">EVALUATE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-207" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing the <strong class="calibre7"><em class="calibre5">EVALUATE</em></strong> syntax</a></p>
<p class="edition"><a href="#calibre_link-208" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">VAR</em></strong> in <strong class="calibre7"><em class="calibre5">DEFINE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-209" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">MEASURE</em></strong> in <strong class="calibre7"><em class="calibre5">DEFINE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-210" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Implementing common DAX query patterns</a></p>
<p class="edition"><a href="#calibre_link-211" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">ROW</em></strong> to test measures</a></p>
<p class="edition"><a href="#calibre_link-212" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">SUMMARIZE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-213" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">SUMMARIZECOLUMNS</em></strong></a></p>
<p class="edition"><a href="#calibre_link-214" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">TOPN</em></strong></a></p>
<p class="edition"><a href="#calibre_link-215" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">GENERATE</em></strong> and <strong class="calibre7"><em class="calibre5">GENERATEALL</em></strong></a></p>
<p class="edition"><a href="#calibre_link-216" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">ISONORAFTER</em></strong></a></p>
<p class="edition"><a href="#calibre_link-217" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">ADDMISSINGITEMS</em></strong></a></p>
<p class="edition"><a href="#calibre_link-218" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">TOPNSKIP</em></strong></a></p>
<p class="edition"><a href="#calibre_link-219" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">GROUPBY</em></strong></a></p>
<p class="edition"><a href="#calibre_link-220" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">NATURALINNERJOIN</em></strong> and <strong class="calibre7"><em class="calibre5">NATURALLEFTOUTERJOIN</em></strong></a></p>
<p class="edition"><a href="#calibre_link-221" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">SUBSTITUTEWITHINDEX</em></strong></a></p>
<p class="edition"><a href="#calibre_link-222" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">SAMPLE</em></strong></a></p>
<p class="edition"><a href="#calibre_link-223" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding the auto-exists behavior in DAX queries</a></p>
<p class="edition"><a href="#calibre_link-224" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14 Advanced DAX concepts</a></p>
<p class="edition"><a href="#calibre_link-225" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing expanded tables</a></p>
<p class="edition"><a href="#calibre_link-226" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">RELATED</em></strong></a></p>
<p class="edition"><a href="#calibre_link-227" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <strong class="calibre7"><em class="calibre5">RELATED</em></strong> in calculated columns</a></p>
<p class="edition"><span type="pagebreak" id="calibre_link-2929"></span><a href="#calibre_link-228" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding the difference between table filters and column filters</a></p>
<p class="edition"><a href="#calibre_link-229" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using table filters in measures</a></p>
<p class="edition"><a href="#calibre_link-230" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding active relationships</a></p>
<p class="edition"><a href="#calibre_link-231" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Difference between table expansion and filtering</a></p>
<p class="edition"><a href="#calibre_link-232" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Context transition in expanded tables</a></p>
<p class="edition"><a href="#calibre_link-233" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">ALLSELECTED</em></strong> and shadow filter contexts</a></p>
<p class="edition"><a href="#calibre_link-234" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing shadow filter contexts</a></p>
<p class="edition"><a href="#calibre_link-235" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><strong class="calibre7"><em class="calibre5">ALLSELECTED</em></strong> returns the iterated rows</a></p>
<p class="edition"><a href="#calibre_link-236" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><strong class="calibre7"><em class="calibre5">ALLSELECTED</em></strong> without parameters</a></p>
<p class="edition"><a href="#calibre_link-237" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">The <strong class="calibre7"><em class="calibre5">ALL*</em></strong> family of functions</a></p>
<p class="edition"><a href="#calibre_link-238" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><strong class="calibre7"><em class="calibre5">ALL</em></strong></a></p>
<p class="edition"><a href="#calibre_link-239" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><strong class="calibre7"><em class="calibre5">ALLEXCEPT</em></strong></a></p>
<p class="edition"><a href="#calibre_link-240" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><strong class="calibre7"><em class="calibre5">ALLNOBLANKROW</em></strong></a></p>
<p class="edition"><a href="#calibre_link-241" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><strong class="calibre7"><em class="calibre5">ALLSELECTED</em></strong></a></p>
<p class="edition"><a href="#calibre_link-242" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><strong class="calibre7"><em class="calibre5">ALLCROSSFILTERED</em></strong></a></p>
<p class="edition"><a href="#calibre_link-243" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding data lineage</a></p>
<p class="edition"><a href="#calibre_link-244" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 15 Advanced relationships</a></p>
<p class="edition"><a href="#calibre_link-245" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Implementing calculated physical relationships</a></p>
<p class="edition"><a href="#calibre_link-246" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Computing multiple-column relationships</a></p>
<p class="edition"><a href="#calibre_link-247" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Implementing relationships based on ranges</a></p>
<p class="edition"><a href="#calibre_link-248" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding circular dependency in calculated physical relationships</a></p>
<p class="edition"><a href="#calibre_link-249" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Implementing virtual relationships</a></p>
<p class="edition"><a href="#calibre_link-250" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Transferring filters in DAX</a></p>
<p class="edition"><a href="#calibre_link-251" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Transferring a filter using <strong class="calibre7"><em class="calibre5">TREATAS</em></strong></a></p>
<p class="edition"><a href="#calibre_link-252" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Transferring a filter using <strong class="calibre7"><em class="calibre5">INTERSECT</em></strong></a></p>
<p class="edition"><a href="#calibre_link-253" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Transferring a filter using <strong class="calibre7"><em class="calibre5">FILTER</em></strong></a></p>
<p class="edition"><a href="#calibre_link-254" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Implementing dynamic segmentation using virtual relationships</a></p>
<p class="edition"><a href="#calibre_link-255" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding physical relationships in DAX</a></p>
<p class="edition"><a href="#calibre_link-256" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using bidirectional cross-filters</a></p>
<p class="edition"><span type="pagebreak" id="calibre_link-2930"></span><a href="#calibre_link-257" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding one-to-many relationships</a></p>
<p class="edition"><a href="#calibre_link-258" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding one-to-one relationships</a></p>
<p class="edition"><a href="#calibre_link-259" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding many-to-many relationships</a></p>
<p class="edition"><a href="#calibre_link-260" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Implementing many-to-many using a bridge table</a></p>
<p class="edition"><a href="#calibre_link-261" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Implementing many-to-many using a common dimension</a></p>
<p class="edition"><a href="#calibre_link-262" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Implementing many-to-many using MMR weak relationships</a></p>
<p class="edition"><a href="#calibre_link-263" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Choosing the right type of relationships</a></p>
<p class="edition"><a href="#calibre_link-264" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Managing granularities</a></p>
<p class="edition"><a href="#calibre_link-265" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Managing ambiguity in relationships</a></p>
<p class="edition"><a href="#calibre_link-266" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding ambiguity in active relationships</a></p>
<p class="edition"><a href="#calibre_link-267" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Solving ambiguity in non-active relationships</a></p>
<p class="edition"><a href="#calibre_link-268" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-21" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 16 Advanced calculations in DAX</a></p>
<p class="edition"><a href="#calibre_link-269" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Computing the working days between two dates</a></p>
<p class="edition"><a href="#calibre_link-270" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Showing budget and sales together</a></p>
<p class="edition"><a href="#calibre_link-271" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Computing same-store sales</a></p>
<p class="edition"><a href="#calibre_link-272" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Numbering sequences of events</a></p>
<p class="edition"><a href="#calibre_link-273" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Computing previous year sales up to last date of sales</a></p>
<p class="edition"><a href="#calibre_link-274" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 17 The DAX engines</a></p>
<p class="edition"><a href="#calibre_link-275" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding the architecture of the DAX engines</a></p>
<p class="edition"><a href="#calibre_link-276" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing the formula engine</a></p>
<p class="edition"><a href="#calibre_link-277" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing the storage engine</a></p>
<p class="edition"><a href="#calibre_link-278" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing the VertiPaq (in-memory) storage engine</a></p>
<p class="edition"><a href="#calibre_link-279" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing the DirectQuery storage engine</a></p>
<p class="edition"><a href="#calibre_link-280" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding data refresh</a></p>
<p class="edition"><a href="#calibre_link-281" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding the VertiPaq storage engine</a></p>
<p class="edition"><a href="#calibre_link-282" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing columnar databases</a></p>
<p class="edition"><a href="#calibre_link-283" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding VertiPaq compression</a></p>
<p class="edition"><a href="#calibre_link-284" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding segmentation and partitioning</a></p>
<p class="edition"><a href="#calibre_link-285" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using Dynamic Management Views</a></p>
<p class="edition"><span type="pagebreak" id="calibre_link-2931"></span><a href="#calibre_link-286" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding the use of relationships in VertiPaq</a></p>
<p class="edition"><a href="#calibre_link-287" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing materialization</a></p>
<p class="edition"><a href="#calibre_link-288" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing aggregations</a></p>
<p class="edition"><a href="#calibre_link-289" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Choosing hardware for VertiPaq</a></p>
<p class="edition"><a href="#calibre_link-290" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Hardware choice as an option</a></p>
<p class="edition"><a href="#calibre_link-291" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Set hardware priorities</a></p>
<p class="edition"><a href="#calibre_link-292" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">CPU model</a></p>
<p class="edition"><a href="#calibre_link-293" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Memory speed</a></p>
<p class="edition"><a href="#calibre_link-294" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Number of cores</a></p>
<p class="edition"><a href="#calibre_link-295" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Memory size</a></p>
<p class="edition"><a href="#calibre_link-296" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Disk I/O and paging</a></p>
<p class="edition"><a href="#calibre_link-297" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Best practices in hardware selection</a></p>
<p class="edition"><a href="#calibre_link-298" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-23" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 18 Optimizing VertiPaq</a></p>
<p class="edition"><a href="#calibre_link-299" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Gathering information about the data model</a></p>
<p class="edition"><a href="#calibre_link-300" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Denormalization</a></p>
<p class="edition"><a href="#calibre_link-301" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Columns cardinality</a></p>
<p class="edition"><a href="#calibre_link-302" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Handling date and time</a></p>
<p class="edition"><a href="#calibre_link-303" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Calculated columns</a></p>
<p class="edition"><a href="#calibre_link-304" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing complex filters with <em class="calibre5">Boolean</em> calculated columns</a></p>
<p class="edition"><a href="#calibre_link-305" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Processing of calculated columns</a></p>
<p class="edition"><a href="#calibre_link-306" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Choosing the right columns to store</a></p>
<p class="edition"><a href="#calibre_link-307" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing column storage</a></p>
<p class="edition"><a href="#calibre_link-308" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using column split optimization</a></p>
<p class="edition"><a href="#calibre_link-309" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing high-cardinality columns</a></p>
<p class="edition"><a href="#calibre_link-310" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Disabling attribute hierarchies</a></p>
<p class="edition"><a href="#calibre_link-311" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing drill-through attributes</a></p>
<p class="edition"><a href="#calibre_link-312" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Managing VertiPaq Aggregations</a></p>
<p class="edition"><a href="#calibre_link-313" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><span type="pagebreak" id="calibre_link-2932"></span><a href="#calibre_link-24" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 19 Analyzing DAX query plans</a></p>
<p class="edition"><a href="#calibre_link-314" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Capturing DAX queries</a></p>
<p class="edition"><a href="#calibre_link-315" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing DAX query plans</a></p>
<p class="edition"><a href="#calibre_link-316" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Collecting query plans</a></p>
<p class="edition"><a href="#calibre_link-317" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing logical query plans</a></p>
<p class="edition"><a href="#calibre_link-318" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing physical query plans</a></p>
<p class="edition"><a href="#calibre_link-319" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing storage engine queries</a></p>
<p class="edition"><a href="#calibre_link-320" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Capturing profiling information</a></p>
<p class="edition"><a href="#calibre_link-321" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using DAX Studio</a></p>
<p class="edition"><a href="#calibre_link-322" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using the SQL Server Profiler</a></p>
<p class="edition"><a href="#calibre_link-323" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Reading VertiPaq storage engine queries</a></p>
<p class="edition"><a href="#calibre_link-324" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing xmSQL syntax</a></p>
<p class="edition"><a href="#calibre_link-325" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding scan time</a></p>
<p class="edition"><a href="#calibre_link-326" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">DISTINCTCOUNT</em></strong> internals</a></p>
<p class="edition"><a href="#calibre_link-327" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding parallelism and datacache</a></p>
<p class="edition"><a href="#calibre_link-328" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding the VertiPaq cache</a></p>
<p class="edition"><a href="#calibre_link-329" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <strong class="calibre7"><em class="calibre5">CallbackDataID</em></strong></a></p>
<p class="edition"><a href="#calibre_link-330" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Reading DirectQuery storage engine queries</a></p>
<p class="edition"><a href="#calibre_link-331" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Analyzing composite models</a></p>
<p class="edition"><a href="#calibre_link-332" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using aggregations in the data model</a></p>
<p class="edition"><a href="#calibre_link-333" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Reading query plans</a></p>
<p class="edition"><a href="#calibre_link-334" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><a href="#calibre_link-25" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 20 Optimizing DAX</a></p>
<p class="edition"><a href="#calibre_link-335" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Defining optimization strategies</a></p>
<p class="edition"><a href="#calibre_link-336" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Identifying a single DAX expression to optimize</a></p>
<p class="edition"><a href="#calibre_link-337" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Creating a reproduction query</a></p>
<p class="edition"><a href="#calibre_link-338" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Analyzing server timings and query plan information</a></p>
<p class="edition"><a href="#calibre_link-339" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Identifying bottlenecks in the storage engine or formula engine</a></p>
<p class="edition"><a href="#calibre_link-340" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Implementing changes and rerunning the test query</a></p>
<p class="edition"><a href="#calibre_link-341" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing bottlenecks in DAX expressions</a></p>
<p class="edition"><a href="#calibre_link-342" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing filter conditions</a></p>
<p class="edition"><a href="#calibre_link-343" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing context transitions</a></p>
<p class="edition"><span type="pagebreak" id="calibre_link-2933"></span><a href="#calibre_link-344" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing <strong class="calibre7"><em class="calibre5">IF</em></strong> conditions</a></p>
<p class="edition"><a href="#calibre_link-345" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Reducing the impact of <strong class="calibre7"><em class="calibre5">CallbackDataID</em></strong></a></p>
<p class="edition"><a href="#calibre_link-346" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing nested iterators</a></p>
<p class="edition"><a href="#calibre_link-347" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Avoiding table filters for <strong class="calibre7"><em class="calibre5">DISTINCTCOUNT</em></strong></a></p>
<p class="edition"><a href="#calibre_link-348" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Avoiding multiple evaluations by using variables</a></p>
<p class="edition"><a href="#calibre_link-349" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conclusions</a></p>
<p class="edition"><em class="calibre5"><a href="#calibre_link-26" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Index</a></em></p>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-350">
<div id="calibre_link-2934" class="calibre2">
<div id="calibre_link-2935" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-3"><span type="pagebreak" id="calibre_link-2936"></span>Foreword</h2>
<p class="edition">You may not know our names. We spend our days writing the code for the software you use in your daily job: We are part of the development team of Power BI, SQL Server Analysis Services, and...yes, we are among the authors of the DAX language and the VertiPaq engine.</p>
<p class="edition">The language you are going to learn using this book is our creation. We spent years working on this language, optimizing the engine, finding ways to improve the optimizer, and trying to build DAX into a simple, clean, and sound language to make your life as a data analyst easier and more productive.</p>
<p class="edition">But hey, this is intended to be the foreword of a book, so no more about us! Why are we writing a foreword for a book published by Marco and Alberto, the SQLBI guys? Well, because when you start learning DAX, it is a matter of a few clicks and searches on the web before you find articles written by them. You start reading their papers, learning the language, and hopefully appreciating our hard work. Having met them many years ago, we have great admiration for their deep knowledge of SQL Server Analysis Services. When the DAX adventure started, they were among the first to learn and adopt this new engine and language.</p>
<p class="edition">The articles, papers, and blog posts they publish and share on the web have become the source of learning for thousands of people. We write the code, but we do not spend much time teaching developers how to use it; Marco and Alberto are the ones who spread the knowledge about DAX.</p>
<p class="edition">Alberto and Marco’s books are among a few bestsellers on this topic, and now with this new guide to DAX, they have truly created a milestone publication about the language we author and love. We write the code, they write the books, and you learn DAX, providing unprecedented analytical power to your business. This is what we love: working all together as a team&mdash;we, they, and you&mdash;to extract better insights from data.</p>
<p class="edition"><em class="calibre5">Marius Dumitru, Architect, Power BI CTO’s Office</em></p>
<p class="edition"><em class="calibre5">Cristian Petculescu, Chief Architect of Power BI</em></p>
<p class="edition"><em class="calibre5">Jeffrey Wang, Principal Software Engineer Manager</em></p>
<p class="edition"><em class="calibre5">Christian Wade, Senior Program Manager</em></p>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-351">
<div id="calibre_link-2937" class="calibre2">
<div id="calibre_link-2938" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-2939"><span type="pagebreak" id="calibre_link-2940"></span>Acknowledgments</h2>
<p class="edition">Writing this second edition required an entire year’s worth of work, three months more than the first edition. It has been a long and amazing journey, connecting people all around the world in any latitude and time zone to be able to produce the result you are going to read. We have so many people to thank for this book that we know it is impossible to write a complete list. So, thanks so much to all of you who contributed to this book&mdash;even if you had no idea that you were doing so. Blog comments, forum posts, email discussions, chats with attendees and speakers at technical conferences, analysis of customer scenarios, and so much more have been useful to us, and many people have contributed significant ideas to this book. Moreover, big thanks to all the students of our courses: By teaching you, we got better!</p>
<p class="edition">That said, there are people we must mention personally, because of their particular contributions.</p>
<p class="edition">We want to start with Edward Melomed: He has inspired us, and we probably would not have started our journey with the DAX language without a passionate discussion we had with him several years ago and that ended with the table of contents of our first book about Power Pivot written on a napkin.</p>
<p class="edition">We want to thank Microsoft Press and the people who contributed to the project: They all greatly helped us along the process of book writing.</p>
<p class="edition">The only job longer than writing a book is the studying you must do in preparation for writing it. A group of people that we (in all friendliness) call “ssas-insiders” helped us get ready to write this book. A few people from Microsoft deserve a special mention as well, because they spent a lot of their precious time teaching us important concepts about Power BI and DAX: They are Marius Dumitru, Jeffrey Wang, Akshai Mirchandani, Krystian Sakowski, and Cristian Petculescu. Your help has been priceless, guys!</p>
<p class="edition">We also want to thank Amir Netz, Christian Wade, Ashvini Sharma, Kasper De Jonge, and T. K. Anand for their contributions to the many discussions we had about the product. We feel they helped us tremendously in strategic choices we made in this book and in our career.</p>
<p class="edition">We wanted to reserve a special mention to a woman who did an incredible job improving and cleaning up our English. Claire Costa proofread the entire manuscript and made it so much easier to read. Claire, your help is invaluable&mdash;Thanks!</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2941"></span>The last special mention goes to our technical reviewer: Daniil Maslyuk carefully tested every single line of code, text, example, and reference we had written. He found any and all kinds of mistakes we would have missed. He rarely made comments that did not require a change in the book. The result is amazing for us. If the book contains fewer errors than our original manuscript, it is only because of Daniil’s efforts. If it still contains errors, it is our fault, of course.</p>
<p class="edition">Thank you so much, folks!</p>
<section class="calibre4">
<h3 id="calibre_link-2942" class="h2a">Errata, updates, and book support</h3>
<p class="edition">We’ve made every effort to ensure the accuracy of this book and its companion content. You can access updates to this book&mdash;in the form of a list of submitted errata and their related corrections&mdash;at <a href="https://MicrosoftPressStore.com/DefinitiveGuideDAX/errata" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://MicrosoftPressStore.com/DefinitiveGuideDAX/errata</a></p>
<p class="edition">For additional book support and information, please visit <a href="https://MicrosoftPressStore.com/Support" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://MicrosoftPressStore.com/Support</a>.</p>
<p class="edition">Please note that product support for Microsoft software and hardware is not offered through the previous addresses. For help with Microsoft software or hardware, go to <em class="calibre5"><a href="http://support.microsoft.com" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://support.microsoft.com</a></em>.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-2943" class="h2a">Stay in touch</h3>
<p class="edition">Let’s keep the conversation going! We are on Twitter: <em class="calibre5"><a href="http://twitter.com/MicrosoftPress" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://twitter.com/MicrosoftPress</a></em>.</p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-352">
<div id="calibre_link-2944" class="calibre2">
<div id="calibre_link-2945" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-4"><span type="pagebreak" id="calibre_link-2946"></span>Introduction to the second edition</h2>
<p class="edition">When we decided it was time to update this book, we thought it would be an easy job: After all, not many things have changed in the DAX language, and the theoretical core of the book was still very good. We believed the focus would mainly be on updating the screenshots from Excel to Power BI, adding a few touch-ups here and there, and we would be done. How wrong we were!</p>
<p class="edition">As soon as we started updating the first chapter, we quickly discovered that we wanted to rewrite nearly everything. We felt so not only in the first chapter, but at every page of the book. Therefore, this is not really a second edition; it is a brand new book.</p>
<p class="edition">The reason is not that the language or the tools have changed so drastically. The reason is that over these last few years we&mdash;as authors and teachers&mdash;have evolved a lot, hopefully for the better. We have taught DAX to thousands of users and developers all around the world; we worked hard with our students, always striving for the best way to explain complex topics. Eventually, we found different ways of describing the language we love.</p>
<p class="edition">We increased the number of examples for this edition, showing practical uses of the functionalities after teaching the theoretical foundation of DAX. We tried to use a simpler style, without compromising on precision. We fought with the editor to increase the page count, as this was needed to cover all the topics we wanted to share. Nevertheless, we did not change the leitmotif of the book: we assume no previous knowledge of DAX, even though this is not a book for the casual DAX developer. This is a book for people who really want to learn the language and gain a deep understanding of the power and complexity of DAX.</p>
<p class="edition">Yes, if you want to leverage the real power of DAX, you need to be prepared for a long journey with us, reading the book from cover to cover, and then reading it again, searching for the many details that&mdash;at first sight&mdash;are not obvious.</p>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-353">
<div id="calibre_link-2947" class="calibre2">
<div id="calibre_link-2948" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-5"><span type="pagebreak" id="calibre_link-2949"></span>Introduction to the first edition</h2>
<p class="edition">We have created considerable amounts of content on DAX: books about Power Pivot and SSAS Tabular, blog posts, articles, white papers, and finally a book dedicated to DAX patterns. So why should we write (and, hopefully, you read) yet another book about DAX? Is there really so much to learn about this language? Of course, we think the answer is a definite yes.</p>
<p class="edition">When you write a book, the first thing that the editor wants to know is the number of pages. There are very good reasons why this is important: price, management, allocation of resources, and so on. In the end, nearly everything in a book goes back to the number of pages. As authors, this is somewhat frustrating. In fact, whenever we write a book, we have to carefully allocate space to the description of the product (either Power Pivot for Microsoft Excel or SSAS Tabular) and of to the DAX language. This has always left us with the bitter feeling of not having enough pages to describe all we wanted to teach about DAX. After all, you cannot write 1,000 pages about Power Pivot; a book of such size would be intimidating for anybody.</p>
<p class="edition">Thus, for years we wrote about SSAS Tabular and Power Pivot, and we kept the project of a book completely dedicated to DAX in a drawer. Then we opened the drawer and decided to avoid choosing what to include in the next book: We wanted to explain everything about DAX, with no compromises. The result of that decision is this book.</p>
<p class="edition">Here you will not find a description of how to create a calculated column, or which dialog box to use to set a property. This is not a step-by-step book that teaches you how to use Microsoft Visual Studio, Power BI, or Power Pivot for Excel. Instead, this is a deep dive into the DAX language, starting from the beginning and then reaching very technical details about how to optimize your code and model.</p>
<p class="edition">We loved each page of this book while we were writing it. We reviewed the content so many times that we had it memorized. We continued adding content whenever we thought there was something important to include, thus increasing the page count and never cutting something because there were no pages left. Doing that, we learned more about DAX and we enjoyed every moment spent doing so.</p>
<p class="edition">But there is one more thing. Why should you read a book about DAX?</p>
<p class="edition">Come on, you thought this after the first demo of Power Pivot or Power BI. You are not alone; we thought the same the first time we tried it. DAX is so easy! It looks so similar to Excel! Moreover, if you have already learned other programming and/or query <span type="pagebreak" id="calibre_link-2950"></span>languages, you are probably used to learning a new language by looking at examples of the syntax, matching patterns you find to those you already know. We made this mistake, and we would like you to avoid doing the same.</p>
<p class="edition">DAX is a mighty language, used in a growing number of analytical tools. It is very powerful, but it includes a few concepts that are hard to understand by inductive reasoning. The evaluation context, for instance, is a topic that requires a deductive approach: You start with a theory, and then you see a few examples that demonstrate how the theory works. Deductive reasoning is the approach of this book. We know that a number of people do not like learning this way, because they prefer a more practical approach&mdash;learning how to solve specific problems, and then with experience and practice, they understand the underlying theory with an inductive reasoning. If you are looking for that approach, this book is not for you. We wrote a book about DAX patterns, full of examples and without any explanation of why a formula works, or why a certain way of coding is better. That book is a good source for copying and pasting DAX formulas. The goal of this book here is different: to enable you to master DAX. All the examples demonstrate a DAX behavior; they do not solve a specific problem. If you find formulas that you can reuse in your models, good for you. However, always remember that this is just a side effect, not the goal of the example. Finally, always read any note to make sure there are no possible pitfalls in the code used in the examples. For educational purposes we have often used code that was not the best practice.</p>
<p class="edition">We really hope you will enjoy spending time with us in this beautiful trip to learn DAX, at least in the same way we enjoyed writing it.</p>
<section class="calibre4">
<h3 id="calibre_link-2951" class="h2a">Who this book is for</h3>
<p class="edition">If you are a casual user of DAX, then this book is probably not the best choice for you. Many books provide a simple introduction to the tools that implement DAX and to the DAX language itself, starting from the ground up and reaching a basic level of DAX programming. We know this very well, because we wrote some of those books, too!</p>
<p class="edition">If, on the other hand, you are serious about DAX and you really want to understand every detail of this beautiful language, then this is your book. This might be your first book about DAX; in that case you should not expect to benefit from the most advanced topics too early. We suggest you read the book from cover to cover and then read the most complex parts again, once you have gained some experience; it is very likely that some concepts will become clearer at that point.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2952"></span>DAX is useful to different people, for different purposes: Power BI users might need to author DAX formulas in their models, Excel users can leverage DAX to author Power Pivot data models, business intelligence (BI) professionals might need to implement DAX code in BI solutions of any size. In this book, we tried to provide information to all these different kinds of people. Some of the content (specifically the optimization part) is probably more targeted to BI professionals, because the knowledge needed to optimize a DAX measure is very technical; but we believe that Power BI and Excel users too should understand the range of possible performance of DAX expressions to achieve the best results for their models.</p>
<p class="edition">Finally, we wanted to write a book to study, not only a book to read. At the beginning, we try to keep it easy and follow a logical path from zero to DAX. However, when the concepts to learn start to become more complex, we stop trying to be simple, and we remain realistic. DAX is simple, but it is not easy. It took years for us to master it and to understand every detail of the engine. Do not expect to be able to learn all this content in a few days, by reading casually. This book requires your attention at a very high level. In exchange for that, we offer an unprecedented depth of coverage of all aspects of DAX, giving you the option to become a real DAX expert.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-2953" class="h2a">Assumptions about you</h3>
<p class="edition">We expect our reader to have basic knowledge of Power BI and some experience in the analysis of numbers. If you have already had prior exposure to the DAX language, then this is good for you&mdash;you will read the first part faster&mdash;but of course knowing DAX is not necessary.</p>
<p class="edition">There are references throughout the book to MDX and SQL code; however, you do not really need to know these languages because they just reflect comparisons between different ways of writing expressions. If you do not understand those lines of code, it is fine; it means that that specific topic is not for you.</p>
<p class="edition">In the most advanced parts of the book, we discuss parallelism, memory access, CPU usage, and other exquisitely geeky topics that not everybody might be familiar with. Any developer will feel at home there, whereas Power BI and Excel users might be a bit intimidated. Nevertheless, this information is required in order to discuss DAX optimization. Indeed, the most advanced part of the book is aimed more towards BI developers than towards Power BI and Excel users. However, we think that everybody will benefit from reading it.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-2954" class="h2a"><span type="pagebreak" id="calibre_link-2955"></span>Organization of this book</h3>
<p class="edition">The book is designed to flow from introductory chapters to complex ones, in a logical way. Each chapter is written with the assumption that the previous content is fully understood; there is nearly no repetition of concepts explained earlier. For this reason, we strongly suggest that you read it from cover to cover and avoid jumping to more advanced chapters too early.</p>
<p class="edition">Once you have read it for the first time, it becomes useful as a reference: For example, if you are in doubt about the behavior of <em class="calibre5">ALLSELECTED</em>, then you can jump straight to that section and clarify your mind on that. Nevertheless, reading that section without having digested the previous content might result in some frustration or, worse, in an incomplete understanding of the concepts.</p>
<p class="edition">With that said, here is the content at a glance:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><a href="#calibre_link-6" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 1</a> is a brief introduction to DAX, with a few sections dedicated to users who already have some knowledge of other languages, namely SQL, Excel, or MDX. We do not introduce any new concept here; we just give several hints about the differences between DAX and other languages that might be known to the reader.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-7" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 2</a> introduces the DAX language itself. We cover basic concepts such as calculated columns, measures, and error-handling functions; we also list most of the basic functions of the language.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 3</a> is dedicated to basic table functions. Many functions in DAX work on tables and return tables as a result. In this chapter we cover the most basic table functions, whereas we cover advanced table functions in <a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 12</a> and 13.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-9" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 4</a> describes evaluation contexts. Evaluation contexts are the foundation of the DAX language, so this chapter, along with the next one, is probably the most important in the entire book.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a> only covers two functions: <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em>. These are the most important functions in DAX, and they strongly rely on a good understanding of evaluation contexts.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-11" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 6</a> describes variables. We use variables in all the examples of the book, but <a href="#calibre_link-11" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 6</a> is where we introduce their syntax and explain how to use variables. This chapter will be useful as a reference when you see countless examples using variables in the following chapters.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-2956"></span><a href="#calibre_link-12" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 7</a> covers iterators and CALCULATE: a marriage made in heaven. Learning how to use iterators, along with the power of context transition, leverages much of the power of DAX. In this chapter, we show several examples that are useful to understand how to take advantage of these tools.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-13" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 8</a> describes time intelligence calculations at a very in-depth level. Year-to-date, month-to-date, values of the previous year, week-based periods, and custom calendars are some of the calculations covered in this chapter.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-14" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 9</a> is dedicated to the latest feature introduced in DAX: calculation groups. Calculation groups are very powerful as a modeling tool. This chapter describes how to create and use calculation groups, introducing the basic concepts and showing a few examples.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10</a> covers more advanced uses of the filter context, data lineage, inspection of the filter context, and other useful tools to compute advanced formulas.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-16" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 11</a> shows you how to perform calculations over hierarchies and how to handle parent/child structures using DAX.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapters 12</a> and <a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">13</a> cover advanced table functions that are useful both to author queries and/or to compute advanced calculations.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a> advances your knowledge of evaluation context one step further and discusses complex functions such as <em class="calibre5">ALLSELECTED</em> and <em class="calibre5">KEEPFILTERS</em>, with the aid of the theory of expanded tables. This is an advanced chapter that uncovers most of the secrets of complex DAX expressions.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 15</a> is about managing relationships in DAX. Indeed, thanks to DAX any type of relationship can be set within a data model. This chapter includes the description of many types of relationships that are common in an analytical data model.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-21" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 16</a> contains several examples of complex calculations solved in DAX. This is the final chapter about the language, useful to discover solutions and new ideas.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 17</a> includes a detailed description of the VertiPaq engine, which is the most common storage engine used by models running DAX. Understanding it is essential to learning how to get the best performance in DAX.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-23" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 18</a> uses the knowledge from <a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 17</a> to show possible optimizations that you can apply at the data model level. You learn how to reduce the cardinality of columns, how to choose columns to import, and how to improve performance by choosing the proper relationship types and by reducing memory usage in DAX.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-2957"></span><a href="#calibre_link-24" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 19</a> teaches you how to read a query plan and how to measure the performance of a DAX query with the aid of tools such as DAX Studio and SQL Server Profiler.</p></li>
<li class="calibre10"><p class="listp"><a href="#calibre_link-25" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 20</a> shows several optimization techniques, based on the content of the previous chapters about optimization. We show many DAX expressions, measure their performance, and then display and explain optimized formulas.</p></li>
</ul>
</section>
<section class="calibre4">
<h3 id="calibre_link-2958" class="h2a">Conventions</h3>
<p class="edition">The following conventions are used in this book:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Boldface</strong> type is used to indicate text that you type.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Italic</em> type is used to indicate new terms, measures, calculated columns, tables, and database names.</p></li>
<li class="calibre10"><p class="listp">The first letters of the names of dialog boxes, dialog box elements, and commands are capitalized. For example, the Save As dialog box.</p></li>
<li class="calibre10"><p class="listp">The names of ribbon tabs are given in ALL CAPS.</p></li>
<li class="calibre10"><p class="listp">Keyboard shortcuts are indicated by a plus sign (+) separating the key names. For example, Ctrl+Alt+Delete means that you press Ctrl, Alt, and Delete keys at the same time.</p></li>
</ul>
</section>
<section class="calibre4">
<h3 id="calibre_link-2959" class="h2a">About the companion content</h3>
<p class="edition">We have included companion content to enrich your learning experience. The companion content for this book can be downloaded from the following page:</p>
<p class="edition"><em class="calibre5"><a href="http://MicrosoftPressStore.com/DefinitiveGuideDAX/downloads" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">MicrosoftPressStore.com/DefinitiveGuideDAX/downloads</a></em></p>
<p class="edition">The companion content includes the following:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">A SQL Server backup of the Contoso Retail DW database that you can use to build the examples yourself. This is a standard demo database provided by Microsoft, which we have enriched with several views, to make it easier to create a data model on top of it.</p></li>
<li class="calibre10"><p class="listp">A separate Power BI Desktop model for each figure of the book. Every figure has its own file. The data model is almost always the same, but you can use these files to closely follow the steps outlined in the book.</p></li>
</ul>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-354">
<div id="calibre_link-2960" class="calibre2">
<div id="calibre_link-2961" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-6"><span type="pagebreak" id="calibre_link-1924"></span><span class="pd_ash">Chapter 1</span><br class="calibre3" />What is DAX?</h2>
<p class="edition">DAX, which stands for Data Analysis eXpressions, is the programming language of Microsoft Power BI, Microsoft Analysis Services, and Microsoft Power Pivot for Excel. It was created in 2010, with the first release of PowerPivot for Microsoft Excel 2010. In 2010, PowerPivot was spelled without the space. The space was introduced in the Power Pivot name in 2013. Since then, DAX has gained popularity, both within the Excel community, which uses DAX to create Power Pivot data models in Excel, and within the Business Intelligence (BI) community, which uses DAX to build models with Power BI and Analysis Services. DAX is present in many different tools, all sharing the same internal engine named <em class="calibre5">Tabular</em>. For this reason, we often refer to <em class="calibre5">Tabular models</em>, including all these different tools in a single word.</p>
<p class="edition">DAX is a simple language. That said, DAX is different from most programming languages, so becoming acquainted with some of its new concepts might take some time. In our experience, having taught DAX to thousands of people, learning the basics of DAX is straightforward: you will be able to start using it in a matter of hours. When it comes to understanding advanced concepts such as evaluation contexts, iterations, and context transitions, everything will likely seem complex. Do not give up! Be patient. When your brain starts to digest these concepts, you will discover that DAX is, indeed, an easy language. It just takes some getting used to.</p>
<p class="edition">This first chapter begins with a recap of what a data model is in terms of tables and relationships. We recommend readers of all experience levels read this section to gain familiarity with the terms used throughout the book when referring to tables, models, and different kinds of relationships.</p>
<p class="edition">In the following sections, we offer advice to readers who have experience with programming languages such as Microsoft Excel, SQL, and MDX. Each section is focused on a certain language, for readers curious to briefly compare DAX to it. Focus on languages you know if a comparison is helpful to you; then read the final section, “<a href="#calibre_link-45" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">DAX for Power BI users</a>,” and move on to the next chapter where our journey into the DAX language truly begins.</p>
<section class="calibre4">
<h3 id="calibre_link-28" class="h2a">Understanding the data model</h3>
<p class="edition">DAX is specifically designed to compute business formulas over a data model. The readers might already know what a data model is. If not, we start with a description of data models and relationships to create a foundation on which to build their DAX knowledge.</p>
<p class="edition">A data model is a set of tables, linked by relationships.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1641"></span>We all know what a table is: a set of rows containing data, with each row divided into columns. Each column has a data type and contains a single piece of information. We usually refer to a row in a table as a record. Tables are a convenient way to organize data. A table is a data model in itself although in its simplest form. Thus, when we write names and numbers in an Excel workbook, we are creating a data model.</p>
<p class="edition">If a data model contains many tables, it is likely that they are linked through relationships. A relationship is a link between two tables. When two tables are tied with a relationship, we say that they are related. Graphically, a relationship is represented by a line connecting the two tables. <a href="#calibre_link-355" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 1-1</a> shows an example of a data model.</p>
<figure id="calibre_link-355" class="image-l">
<img src="images/000061.jpg" alt="The figure shows a simple data model with Date, Sales, Customer, Product, Product Subcategory, and Product Category. Product has a relationship with Product Subcategory, which in turn has a relationship with Product Category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 1-1</strong> This data model is made up of six tables.</figcaption>
</figure>
<p class="edition">Following are a few important aspects of relationships:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Two tables in a relationship do not have the same role. They are called the <em class="calibre5">one-side</em> and the <em class="calibre5">many-side</em> of the relationship, represented respectively with a 1 and with a *. In <a href="#calibre_link-355" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 1-1</a>, focus on the relationship between Product and Product Subcategory. A single subcategory contains many products, whereas a single product has only one subcategory. Therefore, Product Subcategory is the one-side of the relationship, having one subcategory, while Product is the many-side having many products.</p></li>
<li class="calibre10"><p class="listp">Special kinds of relationships are 1:1 and weak relationships. In 1:1 relationships, both tables are the one-side, whereas in weak relationships, both tables can be the many-side. These special kinds of relationships are uncommon; we discuss them in detail in <a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 15</a>, “<a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Advanced relationships</a>.”</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-1723"></span>The columns used to create the relationship, which usually have the same name in both tables, are called the keys of the relationship. On the one-side of the relationship, the column needs to have a unique value for each row, and it cannot contain blanks. On the many-side, the same value can be repeated in many different rows, and it often is. When a column has a unique value for each row, it is called a key for the table.</p></li>
<li class="calibre10"><p class="listp">Relationships can form a chain. Each product has a subcategory, and each subcategory has a category. Thus, each product has a category. To retrieve the category of a product, one must traverse a chain of two relationships. <a href="#calibre_link-355" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 1-1</a> includes an example of a chain made up of three relationships, starting with Sales and continuing on to Product Category.</p></li>
<li class="calibre10"><p class="listp">In each relationship, one or two small arrows can determine the <em class="calibre5">cross filter direction</em>. <a href="#calibre_link-355" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 1-1</a> shows two arrows in the relationship between Sales and Product, whereas all other relationships have a single arrow. The arrow indicates the direction of the automatic filtering of the relationship (<em class="calibre5">cross filter</em>). Because determining the correct direction of filters is one of the most important skills to learn, we discuss this topic in more detail in later chapters. We usually discourage the use of bidirectional filters, as described in <a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 15</a>. They are present in this model for educational purposes only.</p></li>
</ul>
<section class="calibre4">
<h4 id="calibre_link-29" class="calibre13">Understanding the direction of a relationship</h4>
<p class="edition">Each relationship can have a unidirectional or bidirectional cross filter. Filtering always happens from the one-side of the relationship to the many-side. If the cross filter is bidirectional&mdash;that is, if it has two arrows on it&mdash;the filtering also happens from the many-side to the one-side.</p>
<p class="edition">An example might help in understanding this behavior. If a report is based on the data model shown in <a href="#calibre_link-355" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 1-1</a>, with the years on the rows and <em class="calibre5">Quantity</em> and <em class="calibre5">Count of Product Name</em> in the values area, it produces the result shown in <a href="#calibre_link-356" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 1-2</a>.</p>
<figure id="calibre_link-356" class="image-l">
<img src="images/000069.jpg" alt="A report with the years on rows, and Quantity, and Count of Product Name on the values." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 1-2</strong> This report shows the effect of filtering across multiple tables.</figcaption>
</figure>
<p class="edition"><em class="calibre5">Calendar Year</em> is a column that belongs to the <em class="calibre5">Date</em> table. Because <em class="calibre5">Date</em> is on the one-side of the relationship with <em class="calibre5">Sales</em>, the engine filters <em class="calibre5">Sales</em> based on the year. This is why the quantity shown is filtered by year.</p>
<p class="edition">With <em class="calibre5">Products</em>, the scenario is slightly different. The filtering happens because the relationship between the <em class="calibre5">Sales</em> and <em class="calibre5">Product</em> tables is bidirectional. When we put the count of product names in the report, we obtain the number of products sold in each year because the filter on the year propagates to <em class="calibre5">Product</em> through <em class="calibre5">Sales</em>. If the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em> were unidirectional, the result would be different, as we explain in the following sections.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1754"></span>If we modify the report by putting <em class="calibre5">Color</em> on the rows and adding <em class="calibre5">Count of Date</em> in the values area, the result is different, as shown in <a href="#calibre_link-357" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 1-3</a>.</p>
<figure id="calibre_link-357" class="image-l">
<img src="images/000077.jpg" alt="A report with the product color on rows, Quantity, Count of Product Name, and Count of Date on the values. The Count of Date always shows the same value, 2556." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 1-3</strong> This report shows that if bidirectional filtering is not active, tables are not filtered.</figcaption>
</figure>
<p class="edition">The filter on the rows is the <em class="calibre5">Color</em> column in the <em class="calibre5">Product</em> table. Because <em class="calibre5">Product</em> is on the one-side of the relationship with <em class="calibre5">Sales, Quantity</em> is filtered correctly. <em class="calibre5">Count of Product Name</em> is filtered because it is computing values from the table that is on the rows, that is <em class="calibre5">Product</em>. The unexpected number is <em class="calibre5">Count of Date</em>. Indeed, it always shows the same value for all the rows&mdash;that is, the total number of rows in the <em class="calibre5">Date</em> table.</p>
<p class="edition">The filter coming from the <em class="calibre5">Color</em> column does not propagate to <em class="calibre5">Date</em> because the relationship between <em class="calibre5">Date</em> and <em class="calibre5">Sales</em> is unidirectional. Thus, although <em class="calibre5">Sales</em> has an active filter on it, the filter cannot propagate to <em class="calibre5">Date</em> because the type of relationship prevents it.</p>
<p class="edition">If we change the relationship between <em class="calibre5">Date</em> and <em class="calibre5">Sales</em> to enable bidirectional cross-filtering, the result is as shown in <a href="#calibre_link-358" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 1-4</a>.</p>
<figure id="calibre_link-358" class="image-l">
<img src="images/000085.jpg" alt="Same report as Figure 1-3 but this time Count of Date shows different values for each row." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1872"></span><strong class="calibre7">Figure 1-4</strong> If we enable bidirectional filtering, the <em class="calibre5">Date</em> table is filtered using the <em class="calibre5">Color</em> column.</figcaption>
</figure>
<p class="edition">The numbers now reflect the number of days when at least one product of the given color was sold. At first sight, it might look as if all the relationships should be defined as bidirectional, so as to let the filter propagate in any direction and always return results that make sense. As you will learn later in this book, designing a data model this way is almost never appropriate. In fact, depending on the scenario you are working with, you will choose the correct propagation of relationships. If you follow our suggestions, you will avoid bidirectional filtering as much as you can.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-30" class="h2a">DAX for Excel users</h3>
<p class="edition">Chances are you already know the Excel formula language that DAX somewhat resembles. After all, the roots of DAX are in Power Pivot for Excel, and the development team tried to keep the two languages similar. This similarity makes the transition to this new language easier. However, there are some important differences.</p>
<section class="calibre4">
<h4 id="calibre_link-31" class="calibre13">Cells versus tables</h4>
<p class="edition">Excel performs calculations over cells. A cell is referenced using its coordinates. Thus, we can write formulas as follows:</p>
<div class="program"><pre class="calibre14">= (A1 * 1.25) - B2</pre></div>
<p class="edition">In DAX, the concept of a cell and its coordinates does not exist. DAX works on tables and columns, not cells. As a consequence, DAX expressions refer to tables and columns, and this means writing code differently. The concepts of tables and columns are not new in Excel. In fact, if we define an Excel range as a table by using the <em class="calibre5">Format as Table</em> function, we can write formulas in Excel that reference tables and columns. In <a href="#calibre_link-359" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 1-5</a>, the <em class="calibre5">SalesAmount</em> column evaluates an expression that references columns in the same table instead of cells in the workbook.</p>
<figure id="calibre_link-359" class="image-l">
<img src="images/000093.jpg" alt="Excel spreadsheet containing a table where some columns are computed using table expressions." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1966"></span><strong class="calibre7">Figure 1-5</strong> Excel can reference column names in tables.</figcaption>
</figure>
<p class="edition">Using Excel, we refer to columns in a table using the <em class="calibre5">[@ColumnName]</em> format. <em class="calibre5">ColumnName</em> is the name of the column to use, and the <em class="calibre5">@</em> symbol means “take the value for the current row.” Although the syntax is not intuitive, normally we do not write these expressions. They appear when we click a cell, and Excel takes care of inserting the right code for us.</p>
<p class="edition">You might think of Excel as having two different ways of performing calculations. We can use standard cell references, in which case the formula for F4 would be E4*D4, or we can use column references inside a table. Using column references offers the advantage that we can use the same expression in all the cells of a column and Excel will compute the formula with a different value for each row.</p>
<p class="edition">Unlike Excel, DAX works only on tables. All the formulas must reference columns inside tables. For example, in DAX we write the previous multiplication this way:</p>
<p class="codelink"><a href="#calibre_link-360" id="calibre_link-2110" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[SalesAmount] = Sales[ProductPrice] * Sales[ProductQuantity]</pre></div>
<p class="edition">As you can see, each column is prefixed with the name of its table. In Excel, we do not provide the table name because Excel formulas work inside a single table. However, DAX works on a data model containing many tables. As a consequence, we must specify the table name because two columns in different tables might have the same name.</p>
<p class="edition">Many functions in DAX work the same way as the equivalent Excel function. For example, the <em class="calibre5">IF</em> function reads the same way in DAX and in Excel:</p>
<p class="codelink"><a href="#calibre_link-361" id="calibre_link-2111" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">Excel</strong> IF ( [@SalesAmount] &gt; 10, 1, 0)
<strong class="calibre7">DAX</strong> IF ( Sales[SalesAmount] &gt; 10, 1, 0)</pre></div>
<p class="edition">One important aspect where the syntax of Excel and DAX is different is in the way to reference the entire column. In fact, in <em class="calibre5">[@ProductQuantity]</em>, the <em class="calibre5">@</em> means “the value in the current row.” In DAX, there is no need to specify that a value must be from the current row, because this is the default behavior of <span type="pagebreak" id="calibre_link-1878"></span>the language. In Excel, we can reference the entire column&mdash;that is, all the rows in that column&mdash;by removing the <em class="calibre5">@</em> symbol. You can see this in <a href="#calibre_link-362" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 1-6</a>.</p>
<figure id="calibre_link-362" class="image-l">
<img src="images/000101.jpg" alt="Same spreadsheet as in Figure 1-5; the AllSales column always contains the same value." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 1-6</strong> In Excel, you can reference an entire column by omitting the @ symbol before the column name.</figcaption>
</figure>
<p class="edition">The value of the <em class="calibre5">AllSales</em> column is the same in all the rows because it is the grand total of the <em class="calibre5">SalesAmount</em> column. In other words, there is a syntactical difference between the value of a column in the current row and the value of the column as a whole.</p>
<p class="edition">DAX is different. In DAX, this is how you write the <em class="calibre5">AllSales</em> expression of <a href="#calibre_link-362" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 1-6</a>:</p>
<p class="codelink"><a href="#calibre_link-363" id="calibre_link-2112" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AllSales := SUM ( Sales[SalesAmount] )</pre></div>
<p class="edition">There is no syntactical difference between retrieving the value of a column for a specific row and using the column as a whole. DAX understands that we want to sum all the values of the column because we use the column name inside an aggregator (in this case the <em class="calibre5">SUM</em> function), which requires a column name to be passed as a parameter. Thus, although Excel requires an explicit syntax to differentiate between the two types of data to retrieve, DAX does the disambiguation automatically. This distinction might be confusing&mdash;at least in the beginning.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-32" class="calibre13">Excel and DAX: Two functional languages</h4>
<p class="edition">One aspect where the two languages are similar is that both Excel and DAX are functional languages. A functional language is made up of expressions that are basically function calls. In Excel and DAX, the concepts of statements, loops, and jumps do not exist although they are common to many programming languages. In DAX, everything is an expression. This aspect of the language is often a challenge for programmers coming from different languages, but it should be no surprise at all for Excel users.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-33" class="calibre13"><span type="pagebreak" id="calibre_link-1962"></span>Iterators in DAX</h4>
<p class="edition">A concept that might be new to you is the concept of iterators. When working in Excel, you perform calculations one step at a time. The previous example showed that to compute the total of sales, we create one column containing the price multiplied by the quantity. Then as a second step, we sum it to compute the total sales. This number is then useful as a denominator to compute the percentage of sales of each product, for example.</p>
<p class="edition">Using DAX, you can perform the same operation in a single step by using iterators. An iterator does exactly what its name suggests: it iterates over a table and performs a calculation on each row of the table, aggregating the result to produce the single value requested.</p>
<p class="edition">Using the previous example, we can now compute the sum of all sales using the <em class="calibre5">SUMX</em> iterator:</p>
<p class="codelink"><a href="#calibre_link-364" id="calibre_link-2113" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AllSales :=
SUMX (
    Sales,
    Sales[ProductQuantity] * Sales[ProductPrice]
)</pre></div>
<p class="edition">This approach brings to light both an advantage and a disadvantage. The advantage is that we can perform many complex calculations in a single step without worrying about adding columns that would end up being useful only for specific formulas. The disadvantage is that programming with DAX is less visual than programming with Excel. Indeed, you do not see the column computing the price multiplied by the quantity; it exists only for the lifetime of the calculation.</p>
<p class="edition">As we will explain later, we can create a calculated column that computes the multiplication of price by quantity. Nevertheless, doing so is seldom a good practice because it uses memory and might slow down the calculations, unless you use DirectQuery and Aggregations, as we explain in <a href="#calibre_link-23" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 18</a>, “<a href="#calibre_link-23" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing VertiPaq</a>.”</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-34" class="calibre13">DAX requires theory</h4>
<p class="edition">Let us be clear: The fact that DAX requires one to study theory first is not a difference between programming languages. This is a difference in mindset. You are probably used to searching the web for complex formulas and solution patterns for the scenarios you are trying to solve. When you are using Excel, chances are you will find a formula that almost does what you need. You can copy the formula, customize it to fit your needs, and then use it without worrying too much about how it works.</p>
<p class="edition">This approach, which works in Excel, does not work with DAX, however. You need to study DAX theory and thoroughly understand how evaluation contexts work before you can write good DAX code. If you do not have a proper theoretical foundation, you will find that DAX either computes values like magic or it computes strange numbers that make no sense. The problem is not DAX but the fact that you do not yet understood exactly how DAX works.</p>
<p class="edition">Luckily, the theory behind DAX is limited to a couple of important concepts, which we explain in <a href="#calibre_link-9" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 4</a>, “<a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding evaluation contexts</a>.” When you reach that chapter, be prepared for some intense learning. After you master that content, DAX will have no secrets for you, and learning DAX will <span type="pagebreak" id="calibre_link-1927"></span>mainly be a matter of gaining experience. Remember: knowing is half the battle. So do not try to go further until you are somewhat proficient with evaluation contexts.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-35" class="h2a">DAX for SQL developers</h3>
<p class="edition">If you are accustomed to the SQL language, you have already worked with many tables and created joins between columns to set relationships. From this point of view, you will likely feel at home in the DAX world. Indeed, computing in DAX is a matter of querying a set of tables joined by relationships and aggregating values.</p>
<section class="calibre4">
<h4 id="calibre_link-36" class="calibre13">Relationship handling</h4>
<p class="edition">The first difference between SQL and DAX is in the way relationships work in the model. In SQL, we can set foreign keys between tables to declare relationships, but the engine never uses these foreign keys in queries unless we are explicit about them. For example, if we have a <em class="calibre5">Customers</em> table and a <em class="calibre5">Sales</em> table, where <em class="calibre5">CustomerKey</em> is a primary key in <em class="calibre5">Customers</em> and a foreign key in <em class="calibre5">Sales</em>, we can write the following query:</p>
<p class="codelink"><a href="#calibre_link-365" id="calibre_link-2114" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
   Customers.CustomerName,
   SUM ( Sales.SalesAmount ) AS SumOfSales
FROM
   Sales
   INNER JOIN Customers
    ON Sales.CustomerKey = Customers.CustomerKey
GROUP BY
   Customers.CustomerName</pre></div>
<p class="edition">Though we declare the relationship in the model using foreign keys, we still need to be explicit and state the join condition in the query. Although this approach makes queries more verbose, it is useful because you can use different join conditions in different queries, giving you a lot of freedom in the way you express queries.</p>
<p class="edition">In DAX, relationships are part of the model, and they are all <em class="calibre5">LEFT OUTER JOINs</em>. When they are defined in the model, you no longer need to specify the join type in the query: DAX uses an automatic <em class="calibre5">LEFT OUTER JOIN</em> in the query whenever you use columns related to the primary table. Thus, in DAX you would write the previous SQL query as follows:</p>
<p class="codelink"><a href="#calibre_link-366" id="calibre_link-2115" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    Customers[CustomerName],
    "SumOfSales", SUM ( Sales[SalesAmount] )
)</pre></div>
<p class="edition">Because DAX knows the existing relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Customers</em>, it does the join automatically following the model. Finally, the <em class="calibre5">SUMMARIZECOLUMNS</em> function needs to perform a group by <em class="calibre5">Customers[CustomerName]</em>, but we do not have a keyword for that: <em class="calibre5">SUMMARIZECOLUMNS</em> automatically groups data by selected columns.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-37" class="calibre13"><span type="pagebreak" id="calibre_link-1965"></span>DAX is a functional language</h4>
<p class="edition">SQL is a declarative language. You define what you need by declaring the set of data you want to retrieve using <em class="calibre5">SELECT</em> statements, without worrying about how the engine actually retrieves the information.</p>
<p class="edition">DAX, on the other hand, is a functional language. In DAX, every expression is a function call. Function parameters can, in turn, be other function calls. The evaluation of parameters might lead to complex query plans that DAX executes to compute the result.</p>
<p class="edition">For example, if we want to retrieve only customers who live in Europe, we can write this query in SQL:</p>
<p class="codelink"><a href="#calibre_link-367" id="calibre_link-2116" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
   Customers.CustomerName,
   SUM ( Sales.SalesAmount ) AS SumOfSales
FROM
   Sales
   INNER JOIN Customers
    ON Sales.CustomerKey = Customers.CustomerKey
WHERE
   Customers.Continent = 'Europe'
GROUP BY
   Customers.CustomerName</pre></div>
<p class="edition">Using DAX, we do not declare the <em class="calibre5">WHERE</em> condition in the query. Instead, we use a specific function (<em class="calibre5">FILTER</em>) to filter the result:</p>
<p class="codelink"><a href="#calibre_link-368" id="calibre_link-2117" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    Customers[CustomerName],
    FILTER (
        Customers,
        Customers[Continent] = "Europe"
    ),
    "SumOfSales", SUM ( Sales[SalesAmount] )
)</pre></div>
<p class="edition">You can see that <em class="calibre5">FILTER</em> is a function: it returns only the customers living in Europe, producing the expected result. The order in which we nest the functions and the kinds of functions we use have a strong impact on both the result and the performance of the engine. This happens in SQL too, although in SQL we trust the query optimizer to find the optimal query plan. In DAX, although the query optimizer does a great job, you, as programmer, bear more responsibility in writing good code.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-38" class="calibre13">DAX as a programming and querying language</h4>
<p class="edition">In SQL, a clear distinction exists between the query language and the programming language&mdash;that is, the set of instructions used to create stored procedures, views, and other pieces of code in the database. Each SQL dialect has its own statements to let programmers enrich the data model with <span type="pagebreak" id="calibre_link-1899"></span>code. However, DAX virtually makes no distinction between querying and programming. A rich set of functions manipulates tables and can, in turn, return tables. The <em class="calibre5">FILTER</em> function in the previous query is a good example of this.</p>
<p class="edition">In that respect, it appears that DAX is simpler than SQL. When you learn it as a programming language&mdash;its original use&mdash;you will know everything needed to also use it as a query language.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-39" class="calibre13">Subqueries and conditions in DAX and SQL</h4>
<p class="edition">One of the most powerful features of SQL as a query language is the option of using subqueries. DAX features similar concepts. In the case of DAX subqueries, however, they stem from the functional nature of the language.</p>
<p class="edition">For example, to retrieve customers and total sales specifically for the customers who bought more than US$100 worth, we can write this query in SQL:</p>
<p class="codelink"><a href="#calibre_link-369" id="calibre_link-2118" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
   CustomerName,
   SumOfSales
FROM (
   SELECT
    Customers.CustomerName,
    SUM ( Sales.SalesAmount ) AS SumOfSales
   FROM
    Sales
    INNER JOIN Customers
     ON Sales.CustomerKey = Customers.CustomerKey
   GROUP BY
    Customers.CustomerName
   ) AS SubQuery
WHERE
   SubQuery.SumOfSales &gt; 100</pre></div>
<p class="edition">We can obtain the same result in DAX by nesting function calls:</p>
<p class="codelink"><a href="#calibre_link-370" id="calibre_link-2119" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
FILTER (
    SUMMARIZECOLUMNS (
        Customers[CustomerName],
        "SumOfSales", SUM ( Sales[SalesAmount] )
    ),
    [SumOfSales] &gt; 100
)</pre></div>
<p class="edition">In this code, the subquery that retrieves <em class="calibre5">CustomerName</em> and <em class="calibre5">SumOfSales</em> is later fed into a <em class="calibre5">FILTER</em> function that retains only the rows where <em class="calibre5">SumOfSales</em> is greater than 100. Right now, this code might seem unreadable to you. However, as soon as you start learning DAX, you will discover that using subqueries is much easier than in SQL, and it flows naturally because DAX is a functional language.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-40" class="h2a"><span type="pagebreak" id="calibre_link-1967"></span>DAX for MDX developers</h3>
<p class="edition">Many Business Intelligence professionals start learning DAX because it is the new language of Tabular. In the past, they used the MDX language to build and query Analysis Services Multidimensional models. If you are among them, be prepared to learn a completely new language: DAX and MDX do not share much in common. Worse, some concepts in DAX will remind you of similar existing concepts in MDX though they are different.</p>
<p class="edition">In our experience, we have found that learning DAX after learning MDX is the most challenging option. To learn DAX, you need to free your mind from MDX. Try to forget everything you know about multidimensional spaces and be prepared to learn this new language with a clear mind.</p>
<section class="calibre4">
<h4 id="calibre_link-41" class="calibre13">Multidimensional versus Tabular</h4>
<p class="edition">MDX works in the multidimensional space defined by a model. The shape of the multidimensional space is based on the architecture of dimensions and hierarchies defined in the model, and this, in turn, defines the set of coordinates of the multidimensional space. Intersections of sets of members in different dimensions define points in the multidimensional space. You may have taken some time to realize that the <em class="calibre5">[All]</em> member of any attribute hierarchy is indeed a point in the multidimensional space.</p>
<p class="edition">DAX works in a much simpler way. There are no dimensions, no members, and no points in the multidimensional space. In other words, there is no multidimensional space at all. There are hierarchies, which we can define in the model, but they are different from hierarchies in MDX. The DAX space is built on top of tables, columns, and relationships. Each table in a Tabular model is neither a measure group nor a dimension: it is just a table, and to compute values, you scan it, filter it, or sum values inside it. Everything is based on the two simple concepts of tables and relationships.</p>
<p class="edition">You will soon discover that from the modeling point of view, Tabular offers fewer options than Multidimensional does. In this case, having fewer options does not mean being less powerful because you can use DAX as a programming language to enrich the model. The real modeling power of Tabular is the tremendous speed of DAX. In fact, you probably try to avoid overusing MDX in your model because optimizing MDX speed is often a challenge. DAX, on the other hand, is amazingly fast. Thus, most of the complexity of the calculations is not in the model but in the DAX formulas instead.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-42" class="calibre13">DAX as a programming and querying language</h4>
<p class="edition">DAX and MDX are both programming languages and query languages. In MDX, the difference is made clear by the presence of the MDX script. You use MDX in the MDX script, along with several special statements that can be used in the script only, such as <em class="calibre5">SCOPE</em> statements. You use MDX in queries when you write <em class="calibre5">SELECT</em> statements that retrieve data. In DAX, this is somewhat different. You use DAX as a programming language to define calculated columns, calculated tables, and measures. The concept of calculated columns and calculated tables is new to DAX and does not exist in MDX; measures are similar to calculated members in MDX. You can also use DAX as a query language&mdash;for example, to retrieve <span type="pagebreak" id="calibre_link-1968"></span>data from a Tabular model using Reporting Services. Nevertheless, DAX functions do not have a specific role and can be used in both queries and calculation expressions. Moreover, you can also query a Tabular model using MDX. Thus, the querying part of MDX works with Tabular models, whereas DAX is the only option when it comes to programming a Tabular model.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-43" class="calibre13">Hierarchies</h4>
<p class="edition">Using MDX, you rely on hierarchies to perform most of the calculations. If you wanted to compute the sales in the previous year, you would have to retrieve the <em class="calibre5">PrevMember</em> of the <em class="calibre5">CurrentMember</em> on the <em class="calibre5">Year</em> hierarchy and use it to override the MDX filter. For example, you can write the formula this way to define a previous year calculation in MDX:</p>
<p class="codelink"><a href="#calibre_link-371" id="calibre_link-2120" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CREATE MEMBER CURRENTCUBE.[Measures].[SamePeriodPreviousYearSales] AS
(
    [Measures].[Sales Amount],
    ParallelPeriod (
        [Date].[Calendar].[Calendar Year],
        1,
        [Date].[Calendar].CurrentMember
    )
);</pre></div>
<p class="edition">The measure uses the <em class="calibre5">ParallelPeriod</em> function, which returns the cousin of the <em class="calibre5">CurrentMember</em> on the <em class="calibre5">Calendar</em> hierarchy. Thus, it is based on the hierarchies defined in the model. We would write the same calculation in DAX using filter contexts and standard time-intelligence functions:</p>
<p class="codelink"><a href="#calibre_link-372" id="calibre_link-2121" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SamePeriodPreviousYearSales :=
CALCULATE (
    SUM ( Sales[Sales Amount] ),
    SAMEPERIODLASTYEAR ( 'Date'[Date] )
)</pre></div>
<p class="edition">We can write the same calculation in many other ways using <em class="calibre5">FILTER</em> and other DAX functions, but the idea remains the same: instead of using hierarchies, we filter tables. This difference is huge, and you will probably miss hierarchy calculations until you get used to DAX.</p>
<p class="edition">Another important difference is that in MDX you refer to <em class="calibre5">[Measures].[Sales Amount]</em>, and the aggregation function that you need to use is already defined in the model. In DAX, there is no predefined aggregation. In fact, as you might have noticed, the expression to compute is <em class="calibre5">SUM(Sales[Sales Amount])</em>. The predefined aggregation is no longer in the model. We need to define it whenever we want to use it. We can always create a measure that computes the sum of sales, but this would be beyond the scope of this section and is explained later in the book.</p>
<p class="edition">One more important difference between DAX and MDX is that MDX makes heavy use of the <em class="calibre5">SCOPE</em> statement to implement business logic (again, using hierarchies), whereas DAX needs a completely different approach. Indeed, hierarchy handling is missing in the language altogether.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1969"></span>For example, if we want to clear a measure at the <em class="calibre5">Year</em> level, in MDX we would write this statement:</p>
<p class="codelink"><a href="#calibre_link-373" id="calibre_link-2122" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SCOPE ( [Measures].[SamePeriodPreviousYearSales], [Date].[Month].[All] )
   THIS = NULL;
END SCOPE;</pre></div>
<p class="edition">DAX does not have something like a <em class="calibre5">SCOPE</em> statement. To obtain the same result, we need to check for the presence of filters in the filter context, and the scenario is much more complex:</p>
<p class="codelink"><a href="#calibre_link-374" id="calibre_link-2123" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SamePeriodPreviousYearSales :=
IF (
    ISINSCOPE ( 'Date'[Month] ),
    CALCULATE (
        SUM ( Sales[Sales Amount] ),
        SAMEPERIODLASTYEAR ( 'Date'[Date] )
    ),
    BLANK ()
)</pre></div>
<p class="edition">Intuitively, this formula returns a value only if the user is browsing the calendar hierarchy at the month level or below. Otherwise, it returns a <em class="calibre5">BLANK</em>. You will later learn what this formula computes in detail. It is much more error-prone than the equivalent MDX code. To be honest, hierarchy handling is one of the features that is really missing in DAX.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-44" class="calibre13">Leaf-level calculations</h4>
<p class="edition">Finally, when using MDX, you probably got used to avoiding leaf-level calculations. Performing leaf-level computation in MDX turns out to be so slow that you should always prefer to precompute values and leverage aggregations to return results. In DAX, leaf-level calculations work incredibly fast and aggregations serve a different purpose, being useful only for large datasets. This requires a shift in your mind when it is time to build the data models. In most cases, a data model that fits perfectly in SSAS Multidimensional is not the right fit for Tabular and vice versa.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-45" class="h2a">DAX for Power BI users</h3>
<p class="edition">If you skipped the previous sections and directly came here, welcome! DAX is the native language of Power BI, and if you do not have experience in Excel, SQL, or MDX, Power BI will be the first place where you learn DAX. If you do not have previous experience in building models with other tools, you will learn that Power BI is a powerful analytical and modeling tool, with DAX as the perfect companion.</p>
<p class="edition">You might have started using Power BI a while ago and now you want to get to the next level. If this is the case, be prepared for a wonderful journey with DAX.</p>
<p class="edition">Here is our advice to you: do not expect to be able to write complex DAX code in a matter of a few days. DAX requires your time and dedication, and mastering it requires some practice. Based on our experience, you will be excited at first when you are rewarded with a few simple calculations. <span type="pagebreak" id="calibre_link-1975"></span>The excitement fades away as soon as you start learning about evaluation contexts and <em class="calibre5">CALCULATE</em>, the most complex topics of the language. At that point, everything looks complex. Do not give up; most DAX developers had to move past that level. When you are there, you are so close to reaching a full understanding that it would be a real pity to stop. Read and practice again and again because a lightbulb will go off much sooner that you would expect. You will be able to finish the book quickly, reaching DAX guru status.</p>
<p class="edition">Evaluation contexts are at the core of the language. Mastering them takes time. We do not know anyone who was able to learn all about DAX in a couple of days. Besides, as with any complex topic, you will learn to appreciate a lot of the details over time. When you think you have learned everything, give the book a second read. You will discover many details that looked less important at first sight but, with a more trained mindset, really make a difference.</p>
<p class="edition">Enjoy the rest of this book!<span type="pagebreak" id="calibre_link-2962"></span></p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-375">
<div id="calibre_link-2963" class="calibre2">
<div id="calibre_link-2964" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-7"><span type="pagebreak" id="calibre_link-1849"></span><span class="pd_ash">Chapter 2</span><br class="calibre3" />Introducing DAX</h2>
<p class="edition">In this chapter, we start talking about the DAX language. Here you learn the syntax of the language, the difference between a calculated column and a measure (also called calculated field, in certain old Excel versions), and the most commonly used functions in DAX.</p>
<p class="edition">Because this is an introductory chapter, it does not cover many functions in depth. In later chapters, we explain them in more detail. For now, introducing the functions and starting to look at the DAX language in general are enough. When we reference features of the data model in Power BI, Power Pivot, or Analysis Services, we use the term <em class="calibre5">Tabular</em> even when the feature is not present in all the products. For example, “DirectQuery in Tabular” refers to the DirectQuery mode feature available in Power BI and Analysis Services but not in Excel.</p>
<section class="calibre4">
<h3 id="calibre_link-46" class="h2a">Understanding DAX calculations</h3>
<p class="edition">Before working on more complex formulas, you need to learn the basics of DAX. This includes DAX syntax, the different data types that DAX can handle, the basic operators, and how to refer to columns and tables. These concepts are discussed in the next few sections.</p>
<p class="edition">We use DAX to compute values over columns in tables. We can aggregate, calculate, and search for numbers, but in the end, all the calculations involve tables and columns. Thus, the first syntax to learn is how to reference a column in a table.</p>
<p class="edition">The general format is to write the table name enclosed in single quotation marks, followed by the column name enclosed in square brackets, as follows:</p>
<div class="program"><pre class="calibre14">'Sales'[Quantity]</pre></div>
<p class="edition">We can omit the single quotation marks if the table name does not start with a number, does not contain spaces, and is not a reserved word (like <em class="calibre5">Date</em> or <em class="calibre5">Sum</em>).</p>
<p class="edition">The table name is also optional in case we are referencing a column or a measure within the table where we define the formula. Thus, <em class="calibre5">[Quantity]</em> is a valid column reference, if written in a calculated column or in a measure defined in the <em class="calibre5">Sales</em> table. Although this option is available, we strongly discourage you from omitting the table name. At this point, we do not explain why this is so important, but the reason will become clear when you read <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>, “<a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding CALCULATE and CALCULATETABLE</a>.” Nevertheless, it is of paramount importance to be able to distinguish between <span type="pagebreak" id="calibre_link-1850"></span>measures (discussed later) and columns when you read DAX code. The de facto standard is to always use the table name in column references and always avoid it in measure references. The earlier you start adopting this standard, the easier your life with DAX will be. Therefore, you should get used to this way of referencing columns and measures:</p>
<p class="codelink"><a href="#calibre_link-376" id="calibre_link-2125" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Quantity] * 2            -- This is a column reference
[Sales Amount] * 2             -- This is a measure reference</pre></div>
<p class="edition">You will learn the rationale behind this standard after learning about context transition, which comes in <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>. For now, just trust us and adhere to this standard.</p>
<div class="sidebar">
<p class="edition">Comments in DAX</p>
<p class="edition">The preceding code example shows comments in DAX for the first time. DAX supports single-line comments and multiline comments. Single-line comments start with either --or //, and the remaining part of the line is considered a comment.</p>
<p class="codelink"><a href="#calibre_link-377" id="calibre_link-2126" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">= Sales[Quantity] * Sales[Net Price] -- Single-line comment
= Sales[Quantity] * Sales[Unit Cost] // Another example of single-line comment</pre></div>
<p class="edition">A multiline comment starts with /* and ends with */. The DAX parser ignores everything included between these markers and considers them a comment.</p>
<p class="codelink"><a href="#calibre_link-378" id="calibre_link-2127" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">= IF (
    Sales[Quantity] &gt; 1,
    /* First example of a multiline comment
       Anything can be written here and is ignored by DAX
    */
    "Multi",
    /* A common use case of multiline comments  is to comment-out a part of
       the existing code
       The next IF statement is ignored because it falls within a multiline comment
        IF (
            Sales[Quantity] = 1,
            "Single",
            "Special note"
        )
    */
    "Single"
)</pre></div>
<p class="edition">It is better to avoid comments at the end of a DAX expression in a measure, calculated column, or calculated table definition. These comments might be not visible at first, and they might not be supported by tools such as DAX Formatter, which is discussed later in this chapter.</p>
</div>
<section class="calibre4">
<h4 id="calibre_link-47" class="calibre13"><span type="pagebreak" id="calibre_link-1930"></span>DAX data types</h4>
<p class="edition">DAX can perform computations with different numeric types, of which there are seven. Over time, Microsoft introduced different names for the same data types, creating some sort of confusion. <a href="#calibre_link-379" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 2-1</a> provides the different names under which you might find each DAX data type.</p>
<p class="edition" id="calibre_link-379"><strong class="calibre7">Table 2-1</strong> Data Types</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">DAX Data Type</p></th>
<th class="th"><p class="tab-text">Power BI Data Type</p></th>
<th class="th"><p class="tab-text">Power Pivot and Analysis Services Data Type</p></th>
<th class="th"><p class="tab-text">Correspondent Conventional Data Type (e.g., SQL Server)</p></th>
<th class="th"><p class="tab-text">Tabular Object Model (TOM) Data Type</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">Integer</p></td>
<td class="th1"><p class="tab-text">Whole Number</p></td>
<td class="th1"><p class="tab-text">Whole Number</p></td>
<td class="th1"><p class="tab-text">Integer / INT</p></td>
<td class="th1"><p class="tab-text">int64</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Decimal</p></td>
<td class="th1"><p class="tab-text">Decimal Number</p></td>
<td class="th1"><p class="tab-text">Decimal Number</p></td>
<td class="th1"><p class="tab-text">Floating point / DOUBLE</p></td>
<td class="th1"><p class="tab-text">double</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Currency</p></td>
<td class="th1"><p class="tab-text">Fixed Decimal Number</p></td>
<td class="th1"><p class="tab-text">Currency</p></td>
<td class="th1"><p class="tab-text">Currency / MONEY</p></td>
<td class="th1"><p class="tab-text">decimal</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">DateTime</p></td>
<td class="th1"><p class="tab-text">DateTime, Date, Time</p></td>
<td class="th1"><p class="tab-text">Date</p></td>
<td class="th1"><p class="tab-text">Date / DATETIME</p></td>
<td class="th1"><p class="tab-text">dateTime</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Boolean</p></td>
<td class="th1"><p class="tab-text">True/False</p></td>
<td class="th1"><p class="tab-text">True/False</p></td>
<td class="th1"><p class="tab-text">Boolean / BIT</p></td>
<td class="th1"><p class="tab-text">boolean</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">String</p></td>
<td class="th1"><p class="tab-text">Text</p></td>
<td class="th1"><p class="tab-text">Text</p></td>
<td class="th1"><p class="tab-text">String / NVARCHAR(MAX)</p></td>
<td class="th1"><p class="tab-text">string</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Variant</p></td>
<td class="th1"><p class="tab-text">-</p></td>
<td class="th1"><p class="tab-text">-</p></td>
<td class="th1"><p class="tab-text">-</p></td>
<td class="th1"><p class="tab-text">variant</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Binary</p></td>
<td class="th1"><p class="tab-text">Binary</p></td>
<td class="th1"><p class="tab-text">Binary</p></td>
<td class="th1"><p class="tab-text">Blob / VARBINARY(MAX)</p></td>
<td class="th1"><p class="tab-text">binary</p></td>
</tr>
</tbody>
</table>
<p class="edition">In this book, we use the names in the first column of <a href="#calibre_link-379" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 2-1</a> adhering to the de facto standards in the database and Business Intelligence community. For example, in Power BI, a column containing either <em class="calibre5">TRUE</em> or <em class="calibre5">FALSE</em> would be called <em class="calibre5">TRUE/FALSE</em>, whereas in SQL Server, it would be called a <em class="calibre5">BIT</em>. Nevertheless, the historical and most common name for this type of value is Boolean.</p>
<p class="edition">DAX comes with a powerful type-handling system so that we do not have to worry about data types. In a DAX expression, the resulting type is based on the type of the term used in the expression. You need to be aware of this in case the type returned from a DAX expression is not the expected type; you would then have to investigate the data type of the terms used in the expression itself.</p>
<p class="edition">For example, if one of the terms of a sum is a date, the result also is a date; likewise, if the same operator is used with integers, the result is an integer. This behavior is known as <em class="calibre5">operator overloading</em>, and an example is shown in <a href="#calibre_link-380" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-1</a>, where the <em class="calibre5">OrderDatePlusOneWeek</em> column is calculated by adding 7 to the value of the <em class="calibre5">Order Date</em> column.</p>
<p class="codelink"><a href="#calibre_link-381" id="calibre_link-2128" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[OrderDatePlusOneWeek] = Sales[Order Date] + 7</pre></div>
<figure id="calibre_link-380" class="image-l">
<img src="images/000109.jpg" alt="The figure shows the Sales table with the Order Date and OrderDatePlusOneWeek columns. OrderDatePlusOneWeek always falls seven days later than Order Date." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1931"></span><strong class="calibre7">Figure 2-1</strong> Adding an integer to a date results in a date increased by the corresponding number of days.</figcaption>
</figure>
<p class="edition">The result is a date.</p>
<p class="edition">In addition to operator overloading, DAX automatically converts strings into numbers and numbers into strings whenever required by the operator. For example, if we use the <em class="calibre5">&amp;</em> operator, which concatenates strings, DAX converts its arguments into strings. The following formula returns “54” as a string:</p>
<div class="program"><pre class="calibre14">= 5 &amp; 4</pre></div>
<p class="edition">On the other hand, this formula returns an integer result with the value of 9:</p>
<div class="program"><pre class="calibre14">= "5" + "4"</pre></div>
<p class="edition">The resulting value depends on the operator and not on the source columns, which are converted following the requirements of the operator. Although this behavior looks convenient, later in this chapter you see what kinds of errors might happen during these automatic conversions. Moreover, not all the operators follow this behavior. For example, comparison operators cannot compare strings with numbers. Consequently, you can add one number with a string, but you cannot compare a number with a string. You can find a complete reference here: <a href="https://docs.microsoft.com/en-us/power-bi/desktop-data-types" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://docs.microsoft.com/en-us/power-bi/desktop-data-types</a>. Because the rules are so complex, we suggest you avoid automatic conversions altogether. If a conversion needs to happen, we recommend that you control it and make the conversion explicit. To be more explicit, the previous example should be written like this:</p>
<p class="codelink"><a href="#calibre_link-382" id="calibre_link-2129" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">= VALUE ( "5" ) + VALUE ( "4" )</pre></div>
<p class="edition">People accustomed to working with Excel or other languages might be familiar with DAX data types. Some details about data types depend on the engine, and they might be different for Power BI, Power <span type="pagebreak" id="calibre_link-1917"></span>Pivot, or Analysis Services. You can find more detailed information about Analysis Services DAX data types at <a href="http://msdn.microsoft.com/en-us/library/gg492146.aspx" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://msdn.microsoft.com/en-us/library/gg492146.aspx</a>, and Power BI information is available at <a href="https://docs.microsoft.com/en-us/power-bi/desktop-data-types" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://docs.microsoft.com/en-us/power-bi/desktop-data-types</a>. However, it is useful to share a few considerations about each of these data types.</p>
<section class="calibre4">
<h5 id="calibre_link-2965" class="calibre13">Integer</h5>
<p class="edition">DAX has only one <em class="calibre5">Integer</em> data type that can store a 64-bit value. All the internal calculations between integer values in DAX also use a 64-bit value.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-2966" class="calibre13">Decimal</h5>
<p class="edition">A <em class="calibre5">Decimal</em> number is always stored as a double-precision floating-point value. Do not confuse this DAX data type with the <em class="calibre5">decimal</em> and <em class="calibre5">numeric</em> data type of <em class="calibre5">Transact-SQL</em>. The corresponding data type of a DAX decimal number in SQL is <em class="calibre5">Float</em>.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-2967" class="calibre13">Currency</h5>
<p class="edition">The <em class="calibre5">Currency</em> data type, also known as <em class="calibre5">Fixed Decimal Number</em> in Power BI, stores a fixed decimal number. It can represent four decimal points and is internally stored as a 64-bit integer value divided by 10,000. Summing or subtracting <em class="calibre5">Currency</em> data types always ignores decimals beyond the fourth decimal point, whereas multiplication and division produce a floating-point value, thus increasing the precision of the result. In general, if we need more accuracy than the four digits provided, we must use a <em class="calibre5">Decimal</em> data type.</p>
<p class="edition">The default format of the <em class="calibre5">Currency</em> data type includes the currency symbol. We can also apply the currency formatting to <em class="calibre5">Integer</em> and decimal numbers, and we can use a format without the currency symbol for a <em class="calibre5">Currency</em> data type.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-2968" class="calibre13">DateTime</h5>
<p class="edition">DAX stores dates as a <em class="calibre5">DateTime</em> data type. This format uses a floating-point number internally, wherein the integer corresponds to the number of days since December 30, 1899, and the decimal part identifies the fraction of the day. Hours, minutes, and seconds are converted to decimal fractions of a day. Thus, the following expression returns the current date plus one day (exactly 24 hours):</p>
<div class="program"><pre class="calibre14">= TODAY () + 1</pre></div>
<p class="edition">The result is tomorrow’s date at the time of the evaluation. If you need to take only the date part of a <em class="calibre5">DateTime</em>, always remember to use <em class="calibre5">TRUNC</em> to get rid of the decimal part.</p>
<p class="edition">Power BI offers two additional data types: <em class="calibre5">Date</em> and <em class="calibre5">Time</em>. Internally, they are a simple variation of <em class="calibre5">DateTime</em>. Indeed, <em class="calibre5">Date</em> and <em class="calibre5">Time</em> store only the integer or the decimal part of the <em class="calibre5">DateTime</em>, respectively.</p>
<div class="sidebar">
<p class="edition"><span type="pagebreak" id="calibre_link-1766"></span>The leap year bug</p>
<p class="edition">Lotus 1-2-3, a popular spreadsheet released in 1983, presented a bug in the handling of the <em class="calibre5">DateTime</em> data type. It considered 1900 as a leap year, even though it was not. The final year in a century is a leap year only if the first two digits can be divided by 4 without a remainder. At that time, the development team of the first version of Excel deliberately replicated the bug, to maintain compatibility with Lotus 1-2-3. Since then, each new version of Excel has maintained the bug for compatibility.</p>
<p class="edition">At the time of printing in 2019, the bug is still there in DAX, introduced for backward compatibility with Excel. The presence of the bug (should we call it a feature?) might lead to errors on time periods prior to March 1, 1900. Thus, by design, the first date officially supported by DAX is March 1, 1900. Date calculations executed on time periods prior to that date might lead to errors and should be considered as inaccurate.</p>
</div>
</section>
<section class="calibre4">
<h5 id="calibre_link-2969" class="calibre13">Boolean</h5>
<p class="edition">The <em class="calibre5">Boolean</em> data type is used to express logical conditions. For example, a calculated column defined by the following expression is of <em class="calibre5">Boolean</em> type:</p>
<p class="codelink"><a href="#calibre_link-383" id="calibre_link-2130" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">= Sales[Unit Price] &gt; Sales[Unit Cost]</pre></div>
<p class="edition">You will also see <em class="calibre5">Boolean</em> data types as numbers where <em class="calibre5">TRUE</em> equals 1 and <em class="calibre5">FALSE</em> equals 0. This notation sometimes proves useful for sorting purposes because <em class="calibre5">TRUE</em> &gt; <em class="calibre5">FALSE</em>.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-2970" class="calibre13">String</h5>
<p class="edition">Every string in DAX is stored as a <em class="calibre5">Unicode</em> string, where each character is stored in 16 bits. By default, the comparison between strings is not case sensitive, so the two strings “Power BI” and “POWER BI” are considered equal.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-2971" class="calibre13">Variant</h5>
<p class="edition">The <em class="calibre5">Variant</em> data type is used for expressions that might return different data types, depending on the conditions. For example, the following statement can return either an integer or a string, so it returns a variant type:</p>
<p class="codelink"><a href="#calibre_link-384" id="calibre_link-2131" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">IF ( [measure] &gt; 0, 1, "N/A" )</pre></div>
<p class="edition">The <em class="calibre5">Variant</em> data type cannot be used as a data type for a column in a regular table. A DAX measure, and in general, a DAX expression can be <em class="calibre5">Variant</em>.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-2972" class="calibre13"><span type="pagebreak" id="calibre_link-1719"></span>Binary</h5>
<p class="edition">The <em class="calibre5">Binary</em> data type is used in the data model to store images or other nonstructured types of information. It is not available in DAX. It was mainly used by Power View, but it might not be available in other tools such as Power BI.</p>
</section>
</section>
<section class="calibre4">
<h4 id="calibre_link-48" class="calibre13">DAX operators</h4>
<p class="edition">Now that you have seen the importance of operators in determining the type of an expression, see <a href="#calibre_link-385" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 2-2</a>, which provides a list of the operators available in DAX.</p>
<p class="edition" id="calibre_link-385"><strong class="calibre7">Table 2-2</strong> Operators</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Operator Type</p></th>
<th class="th"><p class="tab-text">Symbol</p></th>
<th class="th"><p class="tab-text">Use</p></th>
<th class="th"><p class="tab-text">Example</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">Parenthesis</p></td>
<td class="th1"><p class="tab-text">( )</p></td>
<td class="th1"><p class="tab-text">Precedence order and grouping of arguments</p></td>
<td class="th1"><p class="tab-text">(5 + 2) * 3</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Arithmetic</p></td>
<td class="th1"><p class="tab-text">+</p>
<p class="tab-text">−</p>
<p class="tab-text">*</p>
<p class="tab-text">/</p></td>
<td class="th1"><p class="tab-text">Addition</p>
<p class="tab-text">Subtraction/negation</p>
<p class="tab-text">Multiplication</p>
<p class="tab-text">Division</p></td>
<td class="th1"><p class="tab-text">4 + 2</p>
<p class="tab-text">5 − 3</p>
<p class="tab-text">4 * 2</p>
<p class="tab-text">4 / 2</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Comparison</p></td>
<td class="th1"><p class="tab-text">=</p>
<p class="tab-text">&lt;&gt;</p>
<p class="tab-text">&gt;</p>
<p class="tab-text">&gt;=</p>
<p class="tab-text">&lt;</p>
<p class="tab-text">&lt;=</p></td>
<td class="th1"><p class="tab-text">Equal to</p>
<p class="tab-text">Not equal to</p>
<p class="tab-text">Greater than</p>
<p class="tab-text">Greater than or equal to</p>
<p class="tab-text">Less than</p>
<p class="tab-text">Less than or equal to</p></td>
<td class="th1"><p class="tab-text">[CountryRegion] = “USA”</p>
<p class="tab-text">[CountryRegion] &lt;&gt; “USA”</p>
<p class="tab-text">[Quantity] &gt; 0</p>
<p class="tab-text">[Quantity] &gt;= 100</p>
<p class="tab-text">[Quantity] &lt; 0</p>
<p class="tab-text">[Quantity] &lt;= 100</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Text concatenation</p></td>
<td class="th1"><p class="tab-text">&amp;</p></td>
<td class="th1"><p class="tab-text">Concatenation of strings</p></td>
<td class="th1"><p class="tab-text">“Value is” &amp; [Amount]</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Logical</p></td>
<td class="th1"><p class="tab-text">&amp;&amp;</p>
<p class="tab-text">||</p>
<p class="tab-text">IN</p>
<p class="tab-text">NOT</p></td>
<td class="th1"><p class="tab-text">AND condition between two Boolean expressions</p>
<p class="tab-text">OR condition between two Boolean expressions</p>
<p class="tab-text">Inclusion of an element in a list</p>
<p class="tab-text">Boolean negation</p></td>
<td class="th1"><p class="tab-text">[CountryRegion] = “USA” &amp;&amp; [Quantity]&gt;0</p>
<p class="tab-text">[CountryRegion] = “USA” || [Quantity] &gt; 0</p>
<p class="tab-text">[CountryRegion] IN {“USA”, “Canada”}</p>
<p class="tab-text">NOT [Quantity] &gt; 0</p></td>
</tr>
</tbody>
</table>
<p class="edition">Moreover, the logical operators are also available as DAX functions, with a syntax similar to Excel’s. For example, we can write expressions like these:</p>
<p class="codelink"><a href="#calibre_link-386" id="calibre_link-2132" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AND ( [CountryRegion] = "USA", [Quantity] &gt; 0 )
OR ( [CountryRegion] = "USA", [Quantity] &gt; 0 )</pre></div>
<p class="edition">These examples are equivalent, respectively, to the following:</p>
<p class="codelink"><a href="#calibre_link-387" id="calibre_link-2133" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">[CountryRegion] = "USA" &amp;&amp; [Quantity] &gt; 0
[CountryRegion] = "USA" || [Quantity] &gt; 0</pre></div>
<p class="edition">Using functions instead of operators for Boolean logic becomes helpful when writing complex conditions. In fact, when it comes to formatting large sections of code, functions are much easier to format and to read than operators are. However, a major drawback of functions is that we can pass in only two parameters at a time. Therefore, we must nest functions if we have more than two conditions to evaluate.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-49" class="calibre13"><span type="pagebreak" id="calibre_link-1896"></span>Table constructors</h4>
<p class="edition">In DAX we can define anonymous tables directly in the code. If the table has a single column, the syntax requires only a list of values&mdash;one for each row&mdash;delimited by curly braces. We can delimit multiple rows by parentheses, which are optional if the table is made of a single column. The two following definitions, for example, are equivalent:</p>
<p class="codelink"><a href="#calibre_link-388" id="calibre_link-2134" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">{ "Red", "Blue", "White" }
{ ( "Red" ), ( "Blue" ), ( "White" ) }</pre></div>
<p class="edition">If the table has multiple columns, parentheses are mandatory. Every column should have the same data type throughout all its rows; otherwise, DAX will automatically convert the column to a data type that can accommodate all the data types provided in different rows for the same column.</p>
<p class="codelink"><a href="#calibre_link-389" id="calibre_link-2135" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">{
    ( "A", 10, 1.5, DATE ( 2017, 1, 1 ), CURRENCY ( 199.99 ), TRUE ),
    ( "B", 20, 2.5, DATE ( 2017, 1, 2 ), CURRENCY ( 249.99 ), FALSE ),
    ( "C", 30, 3.5, DATE ( 2017, 1, 3 ), CURRENCY ( 299.99 ), FALSE )
}</pre></div>
<p class="edition">The table constructor is commonly used with the <em class="calibre5">IN</em> operator. For example, the following are possible, valid syntaxes in a DAX predicate:</p>
<p class="codelink"><a href="#calibre_link-390" id="calibre_link-2136" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[Color] IN { "Red", "Blue", "White" }

( 'Date'[Year], 'Date'[MonthNumber] ) IN { ( 2017, 12 ), ( 2018, 1 ) }</pre></div>
<p class="edition">This second example shows the syntax required to compare a set of columns (tuple) using the <em class="calibre5">IN</em> operator. Such syntax cannot be used with a comparison operator. In other words, the following syntax is not valid:</p>
<p class="codelink"><a href="#calibre_link-391" id="calibre_link-2137" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">( 'Date'[Year], 'Date'[MonthNumber] ) = ( 2007, 12 )</pre></div>
<p class="edition">However, we can rewrite it using the <em class="calibre5">IN</em> operator with a table constructor that has a single row, as in the following example:</p>
<p class="codelink"><a href="#calibre_link-392" id="calibre_link-2138" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">( 'Date'[Year], 'Date'[MonthNumber] ) IN { ( 2007, 12 ) }</pre></div>
</section>
<section class="calibre4">
<h4 id="calibre_link-50" class="calibre13">Conditional statements</h4>
<p class="edition">In DAX we can write a conditional expression using the <em class="calibre5">IF</em> function. For example, we can write an expression returning MULTI or SINGLE depending on the quantity value being greater than one or not, respectively.</p>
<div class="program"><pre class="calibre14">IF (
    Sales[Quantity] &gt; 1,
    "MULTI",
    "SINGLE"
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1817"></span>The <em class="calibre5">IF</em> function has three parameters, but only the first two are mandatory. The third is optional, and it defaults to <em class="calibre5">BLANK</em>. Consider the following code:</p>
<div class="program"><pre class="calibre14">IF (
    Sales[Quantity] &gt; 1,
    Sales[Quantity]
)</pre></div>
<p class="edition">It corresponds to the following explicit version:</p>
<div class="program"><pre class="calibre14">IF (
    Sales[Quantity] &gt; 1,
    Sales[Quantity],
    BLANK ()
)</pre></div>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-51" class="h2a">Understanding calculated columns and measures</h3>
<p class="edition">Now that you know the basics of DAX syntax, you need to learn one of the most important concepts in DAX: the difference between calculated columns and measures. Even though calculated columns and measures might appear similar at first sight because you can make certain calculations using either, they are, in reality, different. Understanding the difference is key to unlocking the power of DAX.</p>
<section class="calibre4">
<h4 id="calibre_link-52" class="calibre13">Calculated columns</h4>
<p class="edition">Depending on the tool you are using, you can create a calculated column in different ways. Indeed, the concept remains the same: a calculated column is a new column added to your model, but instead of being loaded from a data source, it is created by resorting to a DAX formula.</p>
<p class="edition">A calculated column is just like any other column in a table, and we can use it in rows, columns, filters, or values of a matrix or any other report. We can also use a calculated column to define a relationship, if needed. The DAX expression defined for a calculated column operates in the context of the current row of the table that the calculated column belongs to. Any reference to a column returns the value of that column for the current row. We cannot directly access the values of other rows.</p>
<p class="edition">If you are using the default <em class="calibre5">Import Mode</em> of Tabular and are not using DirectQuery, one important concept to remember about calculated columns is that these columns are computed during database processing and then stored in the model. This concept might seem strange if you are accustomed to SQL-computed columns (not persisted), which are evaluated at query time and do not use memory. In Tabular, however, all calculated columns occupy space in memory and are computed during table processing.</p>
<p class="edition">This behavior is helpful whenever we create complex calculated columns. The time required to compute complex calculated columns is always process time and not query time, resulting in a better user experience. Nevertheless, be mindful that a calculated column uses precious RAM. For example, <span type="pagebreak" id="calibre_link-1818"></span>if we have a complex formula for a calculated column, we might be tempted to separate the steps of computation into different intermediate columns. Although this technique is useful during project development, it is a bad habit in production because each intermediate calculation is stored in RAM and wastes valuable space.</p>
<p class="edition">If a model is based on DirectQuery instead, the behavior is hugely different. In DirectQuery mode, calculated columns are computed on the fly when the Tabular engine queries the data source. This might result in heavy queries executed by the data source, therefore producing slow models.</p>
<div class="sidebar">
<p class="edition">Computing the duration of an order</p>
<p class="edition">Imagine we have a <em class="calibre5">Sales</em> table containing both the order and the delivery dates. Using these two columns, we can compute the number of days involved in delivering the order. Because dates are stored as number of days after 12/30/1899, a simple subtraction computes the difference in days between two dates:</p>
<p class="codelink"><a href="#calibre_link-393" id="calibre_link-2139" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[DaysToDeliver] = Sales[Delivery Date] - Sales[Order Date]</pre></div>
<p class="edition">Nevertheless, because the two columns used for subtraction are dates, the result also is a date. To produce a numeric result, convert the result to an integer this way:</p>
<p class="codelink"><a href="#calibre_link-394" id="calibre_link-2140" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[DaysToDeliver] = INT ( Sales[Delivery Date] - Sales[Order Date] )</pre></div>
<p class="edition">The result is shown in <a href="#calibre_link-395" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-2</a>.</p>
</div>
<figure id="calibre_link-395" class="image-l">
<img src="images/000117.jpg" alt="The figure shows three columns: Order Date, Delivery Date, and DaysToDeliver, which shows the difference in days between the previous two dates." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 2-2</strong> By subtracting two dates and converting the result to an integer, DAX computes the number of days between the two dates.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-53" class="calibre13">Measures</h4>
<p class="edition">Calculated columns are useful, but you can define calculations in a DAX model in another way. Whenever you do not want to compute values for each row but rather want to aggregate values from many rows in a table, you will find these calculations useful; they are called <em class="calibre5">measures</em>.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2973"></span>For example, you can define a few calculated columns in the <em class="calibre5">Sales</em> table to compute the gross margin amount:</p>
<p class="codelink"><a href="#calibre_link-396" id="calibre_link-2141" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[SalesAmount] = Sales[Quantity] * Sales[Net Price]
Sales[TotalCost] = Sales[Quantity] * Sales[Unit Cost]
Sales[GrossMargin] = Sales[SalesAmount] &ndash; Sales[TotalCost]</pre></div>
<p class="edition">What happens if you want to show the gross margin as a percentage of the sales amount? You could create a calculated column with the following formula:</p>
<p class="codelink"><a href="#calibre_link-397" id="calibre_link-2142" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[GrossMarginPct] = Sales[GrossMargin] / Sales[SalesAmount]</pre></div>
<p class="edition">This formula computes the correct value at the row level&mdash;as you can see in <a href="#calibre_link-398" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-3</a>&mdash;but at the grand total level the result is clearly wrong.</p>
<figure id="calibre_link-398" class="image-l">
<img src="images/000125.jpg" alt="The figure shows the Sales table with the GrossMargin and GrossMarginPct columns, which identify the margin, respectively, as an absolute value and as a percentage. The grand total of the margin percentage is 551.46%." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 2-3</strong> The <em class="calibre5">GrossMarginPct</em> column shows a correct value on each row, but the grand total is incorrect.</figcaption>
</figure>
<p class="edition">The value shown at the grand total level is the sum of the individual percentages computed row by row within the calculated column. When we compute the aggregate value of a percentage, we cannot rely on calculated columns. Instead, we need to compute the percentage based on the sum of individual columns. We must compute the aggregated value as the sum of gross margin divided by the sum of sales amount. In this case, we need to compute the ratio on the aggregates; you cannot use an aggregation of calculated columns. In other words, we compute the ratio of the sums, not the sum of the ratios.</p>
<p class="edition">It would be equally wrong to simply change the aggregation of the <em class="calibre5">GrossMarginPct</em> column to an average and rely on the result because doing so would provide an incorrect evaluation of the percentage, not considering the differences between amounts. The result of this averaged value is visible in <a href="#calibre_link-399" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-4</a>, and you can easily check that (330.31 / 732.23) is not equal to the value displayed, 45.96%; it should be 45.11% instead.</p>
<figure id="calibre_link-399" class="image-l">
<img src="images/000133.jpg" alt="The figure shows the same data as Figure 2-3. This time, the grand total of gross margin percentage shows 45.96%." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2088"></span><strong class="calibre7">Figure 2-4</strong> Changing the aggregation method to <em class="calibre5">AVERAGE</em> does not provide the correct result.</figcaption>
</figure>
<p class="edition">The correct implementation for <em class="calibre5">GrossMarginPct</em> is with a measure:</p>
<p class="codelink"><a href="#calibre_link-400" id="calibre_link-2143" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">GrossMarginPct := SUM ( Sales[GrossMargin] ) / SUM (Sales[SalesAmount] )</pre></div>
<p class="edition">As we have already stated, the correct result cannot be achieved with a calculated column. If you need to operate on aggregated values instead of operating on a row-by-row basis, you must create measures. You might have noticed that we used := to define a measure instead of the equal sign (=). This is a standard we used throughout the book to make it easier to differentiate between measures and calculated columns in code.</p>
<p class="edition">After you define <em class="calibre5">GrossMarginPct</em> as a measure, the result is correct, as you can see in <a href="#calibre_link-401" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-5</a>.</p>
<figure id="calibre_link-401" class="image-l">
<img src="images/000157.jpg" alt="The figure shows the same data as Figure 2-4. This time, the grand total of gross margin percentage shows 45.11%, which is the correct value." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 2-5</strong> <em class="calibre5">GrossMarginPct</em> defined as a measure shows the correct grand total.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1820"></span>Measures and calculated columns both use DAX expressions; the difference is the context of evaluation. A measure is evaluated in the context of a visual element or in the context of a DAX query. However, a calculated column is computed at the row level of the table it belongs to. The context of the visual element (later in the book, you will learn that this is a filter context) depends on user selections in the report or on the format of the DAX query. Therefore, when using <em class="calibre5">SUM(Sales[SalesAmount])</em> in a measure, we mean the sum of all the rows that are aggregated under a visualization. However, when we use <em class="calibre5">Sales[SalesAmount]</em> in a calculated column, we mean the value of the <em class="calibre5">SalesAmount</em> column in the current row.</p>
<p class="edition">A measure needs to be defined in a table. This is one of the requirements of the DAX language. However, the measure does not really belong to the table. Indeed, we can move a measure from one table to another table without losing its functionality.</p>
<div class="sidebar">
<p class="edition">Differences between calculated columns and measures</p>
<p class="edition">Although they look similar, there is a big difference between calculated columns and measures. The value of a calculated column is computed during data refresh, and it uses the current row as a context. The result does not depend on user activity on the report. A measure operates on aggregations of data defined by the current context. In a matrix or in a pivot table, for example, source tables are filtered according to the coordinates of cells, and data is aggregated and calculated using these filters. In other words, a measure always operates on aggregations of data under the evaluation context. The evaluation context is explained further in <a href="#calibre_link-9" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 4</a>, “<a href="#calibre_link-9" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding evaluation contexts</a>.”</p>
</div>
<section class="calibre4">
<h5 id="calibre_link-2974" class="calibre13">Choosing between calculated columns and measures</h5>
<p class="edition">Now that you have seen the difference between calculated columns and measures, it is useful to discuss when to use one over the other. Sometimes either is an option, but in most situations, the computation requirements determine the choice.</p>
<p class="edition">As a developer, you must define a calculated column whenever you want to do the following:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Place the calculated results in a slicer or see results in rows or columns in a matrix or in a pivot table (as opposed to the Values area), or use the calculated column as a filter condition in a DAX query.</p></li>
<li class="calibre10"><p class="listp">Define an expression that is strictly bound to the current row. For example, <em class="calibre5">Price</em> * <em class="calibre5">Quantity</em> cannot work on an average or on a sum of those two columns.</p></li>
<li class="calibre10"><p class="listp">Categorize text or numbers. For example, a range of values for a measure, a range of ages of customers, such as 0&ndash;18, 18&ndash;25, and so on. These categories are often used as filters or to slice and dice values.</p></li>
</ul>
<p class="edition"><span type="pagebreak" id="calibre_link-1821"></span>However, it is mandatory to define a measure whenever one wants to display calculation values that reflect user selections, and the values need to be presented as aggregates in a report, for example:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">To calculate the profit percentage of a report selection</p></li>
<li class="calibre10"><p class="listp">To calculate ratios of a product compared to all products but keep the filter both by year and by region</p></li>
</ul>
<p class="edition">We can express many calculations both with calculated columns and with measures, although we need to use different DAX expressions for each. For example, one can define the <em class="calibre5">GrossMargin</em> as a calculated column:</p>
<p class="codelink"><a href="#calibre_link-402" id="calibre_link-2144" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[GrossMargin] = Sales[SalesAmount] - Sales[TotalProductCost]</pre></div>
<p class="edition">However, it can also be defined as a measure:</p>
<p class="codelink"><a href="#calibre_link-403" id="calibre_link-2145" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">GrossMargin := SUM ( Sales[SalesAmount] ) - SUM ( Sales[TotalProductCost] )</pre></div>
<p class="edition">We suggest you use a measure in this case because, being evaluated at query time, it does not consume memory and disk space. As a rule, whenever you can express a calculation both ways, measures are the preferred way to go. You should limit the use of calculated columns to the few cases where they are strictly needed. Users with Excel experience typically prefer calculated columns over measures because calculated columns closely resemble the way of performing calculations in Excel. Nevertheless, the best way to compute a value in DAX is through a measure.</p>
<div class="sidebar">
<p class="edition">Using measures in calculated columns</p>
<p class="edition">It is obvious that a measure can refer to one or more calculated columns. Although less intuitive, the opposite is also true. A calculated column can refer to a measure. This way, the calculated column forces the calculation of a measure for the context defined by the current row. This operation transforms and consolidates the result of a measure into a column, which will not be influenced by user actions. Obviously, only certain operations can produce meaningful results because a measure usually makes computations that strongly depend on the selection made by the user in the visualization. Moreover, whenever you, as the developer, use measures in a calculated column, you rely on a feature called <em class="calibre5">context transition</em>, which is an advanced calculation technique in DAX. Before you use a measure in a calculated column, we strongly suggest you read and understand <a href="#calibre_link-9" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 4</a>, which explains in detail evaluation contexts and context transitions.</p>
</div>
</section>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-54" class="h2a">Introducing variables</h3>
<p class="edition">When writing a DAX expression, one can avoid repeating the same expression and greatly enhance the code readability by using variables. For example, look at the following expression:</p>
<p class="codelink"><a href="#calibre_link-404" id="calibre_link-2146" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">VAR TotalSales = SUM ( Sales[SalesAmount] )
VAR TotalCosts = SUM ( Sales[TotalProductCost] )
<span type="pagebreak" id="calibre_link-1908"></span>VAR GrossMargin = TotalSales - TotalCosts
RETURN
    GrossMargin / TotalSales</pre></div>
<p class="edition">Variables are defined with the <em class="calibre5">VAR</em> keyword. After you define a variable, you need to provide a <em class="calibre5">RETURN</em> section that defines the result value of the expression. One can define many variables, and the variables are local to the expression in which they are defined.</p>
<p class="edition">A variable defined in an expression cannot be used outside the expression itself. There is no such thing as a global variable definition. This means that you cannot define variables used through the whole DAX code of the model.</p>
<p class="edition">Variables are computed using lazy evaluation. This means that if one defines a variable that, for any reason, is not used in the code, the variable itself will never be evaluated. If it needs to be computed, this happens only once. Later uses of the variable will read the value computed previously. Thus, variables are also useful as an optimization technique when used in a complex expression multiple times.</p>
<p class="edition">Variables are an important tool in DAX. As you will learn in <a href="#calibre_link-9" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 4</a>, variables are extremely useful because they use the definition evaluation context instead of the context where the variable is used. In <a href="#calibre_link-11" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 6</a>, “<a href="#calibre_link-11" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Variables</a>,” we will fully cover variables and how to use them. We will also use variables extensively throughout the book.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-55" class="h2a">Handling errors in DAX expressions</h3>
<p class="edition">Now that you have seen some of the basics of the syntax, it is time to learn how to handle invalid calculations gracefully. A DAX expression might contain invalid calculations because the data it references is not valid for the formula. For example, the formula might contain a division by zero or reference a column value that is not a number while being used in an arithmetic operation such as multiplication. It is good to learn how these errors are handled by default and how to intercept these conditions for special handling.</p>
<p class="edition">Before discussing how to handle errors, though, we describe the different kinds of errors that might appear during a DAX formula evaluation. They are</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Conversion errors</p></li>
<li class="calibre10"><p class="listp">Arithmetic operations errors</p></li>
<li class="calibre10"><p class="listp">Empty or missing values</p></li>
</ul>
<section class="calibre4">
<h4 id="calibre_link-56" class="calibre13">Conversion errors</h4>
<p class="edition">The first kind of error is the conversion error. As we showed previously in this chapter, DAX automatically converts values between strings and numbers whenever the operator requires it. All these examples are valid DAX expressions:</p>
<p class="codelink"><a href="#calibre_link-405" id="calibre_link-2147" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">"10" + 32 = 42
"10" &amp; 32 = "1032"
<span type="pagebreak" id="calibre_link-1720"></span>10 &amp; 32 = "1032"
DATE (2010,3,25) = 3/25/2010
DATE (2010,3,25) + 14 = 4/8/2010
DATE (2010,3,25) &amp; 14 = "3/25/201014"</pre></div>
<p class="edition">These formulas are always correct because they operate with constant values. However, what about the following formula if <em class="calibre5">VatCode</em> is a string?</p>
<div class="program"><pre class="calibre14">Sales[VatCode] + 100</pre></div>
<p class="edition">Because the first operand of this sum is a column that is of <em class="calibre5">Text</em> data type, you as a developer must be confident that DAX can convert all the values in that column into numbers. If DAX fails in converting some of the content to suit the operator needs, a conversion error will occur. Here are some typical situations:</p>
<p class="codelink"><a href="#calibre_link-406" id="calibre_link-2148" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">"1 + 1" + 0 = Cannot convert value '1 + 1' of type Text to type Number
DATEVALUE ("25/14/2010") = Type mismatch</pre></div>
<p class="edition">If you want to avoid these errors, it is important to add error detection logic in DAX expressions to intercept error conditions and return a result that makes sense. One can obtain the same result by intercepting the error after it has happened or by checking the operands for the error situation beforehand. Nevertheless, checking for the error situation proactively is better than letting the error happen and then catching it.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-57" class="calibre13">Arithmetic operations errors</h4>
<p class="edition">The second category of errors is arithmetic operations, such as the division by zero or the square root of a negative number. These are not conversion-related errors: DAX raises them whenever we try to call a function or use an operator with invalid values.</p>
<p class="edition">The division by zero requires special handling because its behavior is not intuitive (except, maybe, for mathematicians). When one divides a number by zero, DAX returns the special value <em class="calibre5">Infinity</em>. In the special cases of 0 divided by 0 or <em class="calibre5">Infinity</em> divided by <em class="calibre5">Infinity</em>, DAX returns the special <em class="calibre5">NaN</em> (not a number) value.</p>
<p class="edition">Because this is unusual behavior, it is summarized in <a href="#calibre_link-407" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 2-3</a>.</p>
<p class="edition" id="calibre_link-407"><strong class="calibre7">Table 2-3</strong> Special Result Values for Division by Zero</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Expression</p></th>
<th class="th"><p class="tab-text">Result</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">10 / 0</p></td>
<td class="th1"><p class="tab-text">Infinity</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">7 / 0</p></td>
<td class="th1"><p class="tab-text">Infinity</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">0 / 0</p></td>
<td class="th1"><p class="tab-text">NaN</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">(10 / 0) / (7 / 0)</p></td>
<td class="th1"><p class="tab-text">NaN</p></td>
</tr>
</tbody>
</table>
<p class="edition">It is important to note that <em class="calibre5">Infinity</em> and <em class="calibre5">NaN</em> are not errors but special values in DAX. In fact, if one divides a number by <em class="calibre5">Infinity</em>, the expression does not generate an error. Instead, it returns 0:</p>
<div class="program"><pre class="calibre14">9954 / ( 7 / 0 ) = 0</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1721"></span>Apart from this special situation, DAX can return arithmetic errors when calling a function with an incorrect parameter, such as the square root of a negative number:</p>
<p class="codelink"><a href="#calibre_link-408" id="calibre_link-2149" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SQRT ( -1 ) = An argument of function 'SQRT' has the wrong data type or the result is too
large or too small</pre></div>
<p class="edition">If DAX detects errors like this, it blocks any further computation of the expression and raises an error. One can use the <em class="calibre5">ISERROR</em> function to check if an expression leads to an error. We show this scenario later in this chapter.</p>
<p class="edition">Keep in mind that special values like <em class="calibre5">NaN</em> are displayed in the user interface of several tools such as Power BI as regular values. They can, however, be treated as errors when shown by other client tools such as an Excel pivot table. Finally, these special values are detected as errors by the error detection functions.</p>
<section class="calibre4">
<h5 id="calibre_link-2975" class="calibre13">Empty or missing values</h5>
<p class="edition">The third category that we examine is not a specific error condition but rather the presence of empty values. Empty values might result in unexpected results or calculation errors when combined with other elements in a calculation.</p>
<p class="edition">DAX handles missing values, blank values, or empty cells in the same way, using the value <em class="calibre5">BLANK</em>. <em class="calibre5">BLANK</em> is not a real value but instead is a special way to identify these conditions. We can obtain the value <em class="calibre5">BLANK</em> in a DAX expression by calling the <em class="calibre5">BLANK</em> function, which is different from an empty string. For example, the following expression always returns a blank value, which can be displayed as either an empty string or as “(blank)” in different client tools:</p>
<div class="program"><pre class="calibre14">= BLANK ()</pre></div>
<p class="edition">On its own, this expression is useless, but the <em class="calibre5">BLANK</em> function itself becomes useful every time there is the need to return an empty value. For example, one might want to display an empty result instead of 0. The following expression calculates the total discount for a sale transaction, leaving the blank value if the discount is 0:</p>
<p class="codelink"><a href="#calibre_link-409" id="calibre_link-2150" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">=IF (
    Sales[DiscountPerc] = 0,              -- Check if there is a discount
    BLANK (),                             -- Return a blank if no discount is present
    Sales[DiscountPerc] * Sales[Amount]   -- Compute the discount otherwise
)</pre></div>
<p class="edition"><em class="calibre5">BLANK</em>, by itself, is not an error; it is just an empty value. Therefore, an expression containing a <em class="calibre5">BLANK</em> might return a value or a blank, depending on the calculation required. For example, the following expression returns <em class="calibre5">BLANK</em> whenever <em class="calibre5">Sales[Amount]</em> is <em class="calibre5">BLANK</em>:</p>
<div class="program"><pre class="calibre14">= 10 * Sales[Amount]</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2976"></span>In other words, the result of an arithmetic product is <em class="calibre5">BLANK</em> whenever one or both terms are <em class="calibre5">BLANK</em>. This creates a challenge when it is necessary to check for a blank value. Because of the implicit conversions, it is impossible to distinguish whether an expression is 0 (or empty string) or <em class="calibre5">BLANK</em> using an equal operator. Indeed, the following logical conditions are always true:</p>
<p class="codelink"><a href="#calibre_link-410" id="calibre_link-2151" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">BLANK () = 0     -- Always returns TRUE
BLANK () = ""    -- Always returns TRUE</pre></div>
<p class="edition">Therefore, if the columns <em class="calibre5">Sales[DiscountPerc]</em> or <em class="calibre5">Sales[Clerk]</em> are blank, the following conditions return <em class="calibre5">TRUE</em> even if the test is against 0 and empty string, respectively:</p>
<p class="codelink"><a href="#calibre_link-411" id="calibre_link-2152" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[DiscountPerc] = 0  -- Returns TRUE if DiscountPerc is either BLANK or 0
Sales[Clerk] = ""        -- Returns TRUE if Clerk is either BLANK or ""</pre></div>
<p class="edition">In such cases, one can use the <em class="calibre5">ISBLANK</em> function to check whether a value is <em class="calibre5">BLANK</em> or not:</p>
<p class="codelink"><a href="#calibre_link-412" id="calibre_link-2153" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ISBLANK ( Sales[DiscountPerc] )  -- Returns TRUE only if DiscountPerc is BLANK
ISBLANK ( Sales[Clerk] )         -- Returns TRUE only if Clerk is BLANK</pre></div>
<p class="edition">The propagation of <em class="calibre5">BLANK</em> in a DAX expression happens in several other arithmetic and logical operations, as shown in the following examples:</p>
<p class="codelink"><a href="#calibre_link-413" id="calibre_link-2154" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">BLANK () + BLANK () = BLANK ()
10 * BLANK () = BLANK ()
BLANK () / 3 = BLANK ()
BLANK () / BLANK () = BLANK ()</pre></div>
<p class="edition">However, the propagation of <em class="calibre5">BLANK</em> in the result of an expression does not happen for all formulas. Some calculations do not propagate <em class="calibre5">BLANK</em>. Instead, they return a value depending on the other terms of the formula. Examples of these are addition, subtraction, division by <em class="calibre5">BLANK</em>, and a logical operation including a <em class="calibre5">BLANK</em>. The following expressions show some of these conditions along with their results:</p>
<p class="codelink"><a href="#calibre_link-414" id="calibre_link-2155" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">BLANK () − 10 = −10
18 + BLANK () = 18
4 / BLANK () = Infinity
0 / BLANK () = NaN
BLANK () || BLANK () = FALSE
BLANK () &amp;&amp; BLANK () = FALSE
( BLANK () = BLANK () ) = TRUE
( BLANK () = TRUE ) = FALSE
( BLANK () = FALSE ) = TRUE
( BLANK () = 0 ) = TRUE
( BLANK () = "" ) = TRUE
ISBLANK ( BLANK() ) = TRUE
FALSE || BLANK () = FALSE
FALSE &amp;&amp; BLANK () = FALSE
TRUE || BLANK () = TRUE
TRUE &amp;&amp; BLANK () = FALSE</pre></div>
<div class="sidebar">
<p class="edition"><span type="pagebreak" id="calibre_link-1722"></span>Empty values in Excel and SQL</p>
<p class="edition">Excel has a different way of handling empty values. In Excel, all empty values are considered 0 whenever they are used in a sum or in a multiplication, but they might return an error if they are part of a division or of a logical expression.</p>
<p class="edition">In SQL, null values are propagated in an expression differently from what happens with <em class="calibre5">BLANK</em> in DAX. As you can see in the previous examples, the presence of a <em class="calibre5">BLANK</em> in a DAX expression does not always result in a <em class="calibre5">BLANK</em> result, whereas the presence of <em class="calibre5">NULL</em> in SQL often evaluates to NULL for the entire expression. This difference is relevant whenever you use DirectQuery on top of a relational database because some calculations are executed in SQL and others are executed in DAX. The different semantics of <em class="calibre5">BLANK</em> in the two engines might result in unexpected behaviors.</p>
</div>
<p class="edition">Understanding the behavior of empty or missing values in a DAX expression and using <em class="calibre5">BLANK</em> to return an empty cell in a calculation are important skills to control the results of a DAX expression. One can often use <em class="calibre5">BLANK</em> as a result when detecting incorrect values or other errors, as we demonstrate in the next section.</p>
</section>
</section>
<section class="calibre4">
<h4 id="calibre_link-58" class="calibre13">Intercepting errors</h4>
<p class="edition">Now that we have detailed the various kinds of errors that can occur, we still need to show you the techniques to intercept errors and correct them or, at least, produce an error message containing meaningful information. The presence of errors in a DAX expression frequently depends on the value of columns used in the expression itself. Therefore, one might want to control the presence of these error conditions and return an error message. The standard technique is to check whether an expression returns an error and, if so, replace the error with a specific message or a default value. There are a few DAX functions for this task.</p>
<p class="edition">The first of them is the <em class="calibre5">IFERROR</em> function, which is similar to the <em class="calibre5">IF</em> function, but instead of evaluating a Boolean condition, it checks whether an expression returns an error. Two typical uses of the <em class="calibre5">IFERROR</em> function are as follows:</p>
<p class="codelink"><a href="#calibre_link-415" id="calibre_link-2156" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">= IFERROR ( Sales[Quantity] * Sales[Price], BLANK () )
= IFERROR ( SQRT ( Test[Omega] ), BLANK () )</pre></div>
<p class="edition">In the first expression, if either <em class="calibre5">Sales[Quantity]</em> or <em class="calibre5">Sales[Price]</em> is a string that cannot be converted into a number, the returned expression is an empty value. Otherwise, the product of <em class="calibre5">Quantity</em> and <em class="calibre5">Price</em> is returned.</p>
<p class="edition">In the second expression, the result is an empty cell every time the <em class="calibre5">Test[Omega]</em> column contains a negative number.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1757"></span>Using <em class="calibre5">IFERROR</em> this way corresponds to a more general pattern that requires using <em class="calibre5">ISERROR</em> and <em class="calibre5">IF</em>:</p>
<p class="codelink"><a href="#calibre_link-416" id="calibre_link-2157" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">= IF (
    ISERROR ( Sales[Quantity] * Sales[Price] ),
    BLANK (),
    Sales[Quantity] * Sales[Price]
)

= IF (
    ISERROR ( SQRT ( Test[Omega] ) ),
    BLANK (),
    SQRT ( Test[Omega] )
)</pre></div>
<p class="edition">In these cases, <em class="calibre5">IFERROR</em> is a better option. One can use <em class="calibre5">IFERROR</em> whenever the result is the same expression tested for an error; there is no need to duplicate the expression in two places, and the code is safer and more readable. However, a developer should use <em class="calibre5">IF</em> when they want to return the result of a different expression.</p>
<p class="edition">Besides, one can avoid raising the error altogether by testing parameters before using them. For example, one can detect whether the argument for <em class="calibre5">SQRT</em> is positive, returning <em class="calibre5">BLANK</em> for negative values:</p>
<div class="program"><pre class="calibre14">= IF (
    Test[Omega] &gt;= 0,
    SQRT ( Test[Omega] ),
    BLANK ()
)</pre></div>
<p class="edition">Considering that the third argument of an <em class="calibre5">IF</em> statement defaults to <em class="calibre5">BLANK</em>, one can also write the same expression more concisely:</p>
<div class="program"><pre class="calibre14">= IF (
    Test[Omega] &gt;= 0,
    SQRT ( Test[Omega] )
)</pre></div>
<p class="edition">A frequent scenario is to test against empty values. <em class="calibre5">ISBLANK</em> detects empty values, returning <em class="calibre5">TRUE</em> if its argument is <em class="calibre5">BLANK</em>. This capability is important especially when a value being unavailable does not imply that it is 0. The following example calculates the cost of shipping for a sale transaction, using a default shipping cost for the product if the transaction itself does not specify a weight:</p>
<p class="codelink"><a href="#calibre_link-417" id="calibre_link-2158" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">= IF (
   ISBLANK ( Sales[Weight] ),             -- If the weight is missing
   Sales[DefaultShippingCost],            -- then return the default cost
   Sales[Weight] * Sales[ShippingPrice]   -- otherwise multiply weight by shipping price
)</pre></div>
<p class="edition">If we simply multiply product weight by shipping price, we get an empty cost for all the sales transactions without weight data because of the propagation of <em class="calibre5">BLANK</em> in multiplications.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2012"></span>When using variables, errors must be checked at the time of variable definition rather than where we use them. In fact, the first formula in the following code returns zero, the second formula always throws an error, and the last one produces different results depending on the version of the product using DAX (the latest version throws an error also):</p>
<p class="codelink"><a href="#calibre_link-418" id="calibre_link-2159" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">IFERROR ( SQRT ( -1 ), 0 )                -- This returns 0

VAR WrongValue = SQRT ( -1 )              -- Error happens here, so the result is
RETURN                                    -- always an error
    IFERROR ( WrongValue, 0 )             -- This line is never executed

IFERROR (                                 -- Different results depending on versions
    VAR WrongValue = SQRT ( -1 )          -- IFERROR throws an error in 2017 versions
    RETURN                                -- IFERROR returns 0 in versions until 2016
        WrongValue,
    0
)</pre></div>
<p class="edition">The error happens when <em class="calibre5">WrongValue</em> is evaluated. Thus, the engine will never execute the <em class="calibre5">IFERROR</em> function in the second example, whereas the outcome of the third example depends on product versions. If you need to check for errors, take some extra precautions when using variables.</p>
<div class="sidebar">
<p class="edition">Avoid using error-handling functions</p>
<p class="edition">Although we will cover optimizations later in the book, you need to be aware that error-handling functions might create severe performance issues in your code. It is not that they are slow in and of themselves. The problem is that the DAX engine cannot use optimized paths in its code when errors happen. In most cases, checking operands for possible errors is more efficient than using the error-handling engine. For example, instead of writing this:</p>
<div class="program"><pre class="calibre14">IFERROR (
   SQRT ( Test[Omega] ),
   BLANK ()
)</pre></div>
<p class="edition">It is much better to write this:</p>
<div class="program"><pre class="calibre14">IF (
   Test[Omega] &gt;= 0,
   SQRT ( Test[Omega] ),
   BLANK ()
)</pre></div>
<p class="edition">This second expression does not need to detect the error and is faster than the previous expression. This, of course, is a general rule. For a detailed explanation, see <a href="#calibre_link-24" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 19</a>, “<a href="#calibre_link-24" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing DAX</a>.”</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2010"></span>Another reason to avoid <em class="calibre5">IFERROR</em> is that it cannot intercept errors happening at a deeper level of execution. For example, the following code intercepts any error happening in the conversion of the <em class="calibre5">Table[Amount]</em> column considering a blank value in case <em class="calibre5">Amount</em> does not contain a number. As discussed previously, this execution is expensive because it is evaluated for every row in <em class="calibre5">Table</em>.</p>
<p class="codelink"><a href="#calibre_link-419" id="calibre_link-2160" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SUMX (
    Table,
    IFERROR ( VALUE ( Table[Amount] ), BLANK () )
)</pre></div>
<p class="edition">Be mindful that, due to optimizations in the DAX engine, the following code does not intercept the same errors intercepted by the preceding example. If <em class="calibre5">Table[Amount]</em> contains a string that is not a number in just one row, the entire expression generates an error that is not intercepted by <em class="calibre5">IFERROR</em>.</p>
<p class="codelink"><a href="#calibre_link-420" id="calibre_link-2161" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">IFERROR (
    SUMX (
        Table,
        VALUE ( Table[Amount] )
    ),
    BLANK ()
)</pre></div>
<p class="edition"><em class="calibre5">ISERROR</em> has the same behavior as <em class="calibre5">IFERROR</em>. Be sure to use them carefully and only to intercept errors raised directly by the expression evaluated within <em class="calibre5">IFERROR/ISERROR</em> and not in nested calculations.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-59" class="calibre13">Generating errors</h4>
<p class="edition">Sometimes, an error is just an error, and the formula should not return a default value in case of an error. Indeed, returning a default value would end up producing an actual result that would be incorrect. For example, a configuration table that contains inconsistent data should produce an invalid report rather than numbers that are unreliable, and yet it might be considered correct.</p>
<p class="edition">Moreover, instead of a generic error, one might want to produce an error message that is more meaningful to the users. Such a message would help users find where the problem is.</p>
<p class="edition">Consider a scenario that requires the computation of the square root of the absolute temperature measured in Kelvin, to approximately adjust the speed of sound in a complex scientific calculation. Obviously, we do not expect that temperature to be a negative number. If that happens due to a problem in the measurement, we need to raise an error and stop the calculation.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2011"></span>In that case, this code is dangerous because it hides the problem:</p>
<p class="codelink"><a href="#calibre_link-421" id="calibre_link-2162" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">= IFERROR (
    SQRT ( Test[Temperature] ),
    0
)</pre></div>
<p class="edition">Instead, to protect the calculations, one should write the formula like this:</p>
<p class="codelink"><a href="#calibre_link-422" id="calibre_link-2163" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">= IF (
    Test[Temperature] &gt;= 0,
    SQRT ( Test[Temperature] ),
    ERROR ( "The temperature cannot be a negative number. Calculation aborted." )
)</pre></div>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-60" class="h2a">Formatting DAX code</h3>
<p class="edition">Before we continue explaining the DAX language, we would like to cover an important aspect of DAX&mdash;that is, formatting the code. DAX is a functional language, meaning that no matter how complex it is, a DAX expression is like a single function call. The complexity of the code translates into the complexity of the expressions that one uses as parameters for the outermost function.</p>
<p class="edition">For this reason, it is normal to see expressions that span over 10 lines or more. Seeing a 20-line DAX expression is common, so you will become acquainted with it. Nevertheless, as formulas start to grow in length and complexity, it is extremely important to format the code to make it human-readable.</p>
<p class="edition">There is no “official” standard to format DAX code, yet we believe it is important to describe the standard that we use in our code. It is likely not the perfect standard, and you might prefer something different. We have no problem with that: find your optimal standard and use it. The only thing you need to remember is: <em class="calibre5">format your code and never write everything on a single line; otherwise, you will be in trouble sooner than you expect</em>.</p>
<p class="edition">To understand why formatting is important, look at a formula that computes a time intelligence calculation. This somewhat complex formula is still not the most complex you will write. Here is how the expression looks if you do not format it in some way:</p>
<p class="codelink"><a href="#calibre_link-423" id="calibre_link-2164" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">IF(CALCULATE(NOT ISEMPTY(Balances), ALLEXCEPT (Balances, BalanceDate)),SUMX (ALL(Balances
[Account]), CALCULATE(SUM (Balances[Balance]),LASTNONBLANK(DATESBETWEEN(BalanceDate[Date],
BLANK(),MAX(BalanceDate[Date])),CALCULATE(COUNTROWS(Balances))))),BLANK())</pre></div>
<p class="edition">Trying to understand what this formula computes in its present form is nearly impossible. There is no clue which is the outermost function and how DAX evaluates the different parameters to create the complete flow of execution. We have seen too many examples of formulas written this way by students who, at some point, ask for help in understanding why the formula returns incorrect results. Guess what? The first thing we do is format the expression; only later do we start working on it.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2029"></span>The same expression, properly formatted, looks like this:</p>
<p class="codelink"><a href="#calibre_link-424" id="calibre_link-2165" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">IF (
    CALCULATE (
        NOT ISEMPTY ( Balances ),
        ALLEXCEPT (
            Balances,
            BalanceDate
        )
    ),
    SUMX (
        ALL ( Balances[Account] ),
        CALCULATE (
            SUM ( Balances[Balance] ),
            LASTNONBLANK (
                DATESBETWEEN (
                    BalanceDate[Date],
                    BLANK (),
                    MAX ( BalanceDate[Date] )
                ),
                CALCULATE (
                    COUNTROWS ( Balances )
                )
            )
        )
    ),
    BLANK ()
)</pre></div>
<p class="edition">The code is the same, but this time it is much easier to see the three parameters of <em class="calibre5">IF</em>. Most important, it is easier to follow the blocks that arise naturally from indenting lines and how they compose the complete flow of execution. The code is still hard to read, but now the problem is DAX, not poor formatting. A more verbose syntax using variables can help you read the code, but even in this case, the formatting is important in providing a correct understanding of the scope of each variable:</p>
<p class="codelink"><a href="#calibre_link-425" id="calibre_link-2166" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">IF (
    CALCULATE (
        NOT ISEMPTY ( Balances ),
        ALLEXCEPT (
            Balances,
            BalanceDate
        )
    ),
    SUMX (
        ALL ( Balances[Account] ),
        VAR PreviousDates =
            DATESBETWEEN (
                BalanceDate[Date],
                BLANK (),
                MAX ( BalanceDate[Date] )
            )
<span type="pagebreak" id="calibre_link-1997"></span>        VAR LastDateWithBalance =
            LASTNONBLANK (
                PreviousDates,
                CALCULATE (
                    COUNTROWS ( Balances )
                )
            )
        RETURN
            CALCULATE (
                SUM ( Balances[Balance] ),
                LastDateWithBalance
            )
    ),
    BLANK ()
)</pre></div>
<div class="sidebar">
<p class="edition">DAXFormatter.com</p>
<p class="edition">We created a website dedicated to formatting DAX code. We created this site for ourselves because formatting code is a time-consuming operation and we did not want to spend our time doing it for every formula we write. After the tool was working, we decided to donate it to the public domain so that users can format their own DAX code (by the way, we have been able to promote our formatting rules this way).</p>
</div>
<p class="edition">You can find the website at <a href="http://www.daxformatter.com" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">www.daxformatter.com</a>. The user interface is simple: just copy your DAX code, click FORMAT, and the page refreshes showing a nicely formatted version of your code, which you can then copy and paste in the original window.</p>
<p class="edition">This is the set of rules that we use to format DAX:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Always separate function names such as <em class="calibre5">IF</em>, <em class="calibre5">SUMX</em>, and <em class="calibre5">CALCULATE</em> from any other term using a space and always write them in uppercase.</p></li>
<li class="calibre10"><p class="listp">Write all column references in the form <em class="calibre5">TableName[ColumnName]</em>, with no space between the table name and the opening square bracket. Always include the table name.</p></li>
<li class="calibre10"><p class="listp">Write all measure references in the form <em class="calibre5">[MeasureName]</em>, without any table name.</p></li>
<li class="calibre10"><p class="listp">Always use a space following commas and never precede them with a space.</p></li>
<li class="calibre10"><p class="listp">If the formula fits one single line, do not apply any other rule.</p></li>
<li class="calibre10"><p class="listp">If the formula does not fit a single line, then</p>
<ul class="bull">
<li class="calibre10"><p class="listp">Place the function name on a line by itself, with the opening parenthesis.</p></li>
<li class="calibre10"><p class="listp">Keep all parameters on separate lines, indented with four spaces and with the comma at the end of the expression except for the last parameter.</p></li>
<li class="calibre10"><p class="listp">Align the closing parenthesis with the function call so that the closing parenthesis stands on its own line.</p></li>
</ul></li>
</ul>
<p class="edition"><span type="pagebreak" id="calibre_link-1670"></span>These are the basic rules we use. A more detailed list of these rules is available at <a href="http://sql.bi/daxrules" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://sql.bi/daxrules</a>.</p>
<p class="edition">If you find a way to express formulas that best fits your reading method, use it. The goal of formatting is to make the formula easier to read, so use the technique that works best for you. The most important point to remember when defining your personal set of formatting rules is that you always need to be able to see errors as soon as possible. If, in the unformatted code shown previously, DAX complained about a missing closing parenthesis, it would be hard to spot where the error is. In the formatted formula, it is much easier to see how each closing parenthesis matches the opening function call.</p>
<div class="sidebar">
<p class="edition">Help on formatting DAX</p>
<p class="edition">Formatting DAX is not an easy task because often we write it using a small font in a text box. Depending on the version, Power BI, Excel, and Visual Studio provide different text editors for DAX. Nevertheless, a few hints might help in writing DAX code:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">To increase the font size, hold down Ctrl while rotating the wheel button on the mouse, making it easier to look at the code.</p></li>
<li class="calibre10"><p class="listp">To add a new line to the formula, press Shift+Enter.</p></li>
<li class="calibre10"><p class="listp">If editing in the text box is not for you, copy the code into another editor, such as Notepad or DAX Studio, and then copy and paste the formula back into the text box.</p></li>
</ul>
<p class="edition">When you look at a DAX expression, at first glance it may be hard to understand whether it is a calculated column or a measure. Thus, in our books and articles we use an equal sign (=) whenever we define a calculated column and the assignment operator (:=) to define measures:</p>
<p class="codelink"><a href="#calibre_link-426" id="calibre_link-2167" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CalcCol = SUM  ( Sales[SalesAmount] )        -- is a calculated  column
Store[CalcCol] = SUM ( Sales[SalesAmount] )  -- is a calculated column in Store table
CalcMsr := SUM  ( Sales[SalesAmount]  )      -- is a measure</pre></div>
<p class="edition">Finally, when using columns and measures in code, we recommend to always put a table name before a column and never before a measure, as we do in every example.</p>
</div>
</section>
<section class="calibre4">
<h3 id="calibre_link-61" class="h2a">Introducing aggregators and iterators</h3>
<p class="edition">Almost every data model needs to operate on aggregated data. DAX offers a set of functions that aggregate the values of a column in a table and return a single value. We call this group of functions <em class="calibre5">aggregation functions</em>. For example, the following measure calculates the sum of all the numbers in the <em class="calibre5">SalesAmount</em> column of the <em class="calibre5">Sales</em> table:</p>
<p class="codelink"><a href="#calibre_link-427" id="calibre_link-2168" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales := SUM ( Sales[SalesAmount] )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1671"></span><em class="calibre5">SUM</em> aggregates all the rows of the table if it is used in a calculated column. Whenever it is used in a measure, it considers only the rows that are being filtered by slicers, rows, columns, and filter conditions in the report.</p>
<p class="edition">There are many aggregation functions (<em class="calibre5">SUM</em>, <em class="calibre5">AVERAGE</em>, <em class="calibre5">MIN</em>, <em class="calibre5">MAX</em>, and <em class="calibre5">STDEV</em>), and their behavior changes only in the way they aggregate values: <em class="calibre5">SUM</em> adds values, whereas <em class="calibre5">MIN</em> returns the minimum value. Nearly all these functions operate only on numeric values or on dates. Only <em class="calibre5">MIN</em> and <em class="calibre5">MAX</em> can operate on text values also. Moreover, DAX never considers empty cells when it performs the aggregation, and this behavior is different from their counterpart in Excel (more on this later in this chapter).</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition"><em class="calibre5">MIN</em> and <em class="calibre5">MAX</em> offer another behavior: if used with two parameters, they return the minimum or maximum of the two parameters. Thus, <em class="calibre5">MIN</em> (1, 2) returns 1 and <em class="calibre5">MAX</em> (1, 2) returns 2. This functionality is useful when one needs to compute the minimum or maximum of complex expressions because it saves having to write the same expression multiple times in <em class="calibre5">IF</em> statements.</p>
</div>
<p class="edition">All the aggregation functions we have described so far work on columns. Therefore, they aggregate values from a single column only. Some aggregation functions can aggregate an expression instead of a single column. Because of the way they work, they are known as <em class="calibre5">iterators</em>. This set of functions is useful, especially when you need to make calculations using columns of different related tables, or when you need to reduce the number of calculated columns.</p>
<p class="edition">Iterators always accept at least two parameters: the first is a table that they scan; the second is typically an expression that is evaluated for each row of the table. After they have completed scanning the table and evaluating the expression row by row, iterators aggregate the partial results according to their semantics.</p>
<p class="edition">For example, if we compute the number of days needed to deliver an order in a calculated column called <em class="calibre5">DaysToDeliver</em> and build a report on top of that, we obtain the report shown in <a href="#calibre_link-428" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-6</a>. Note that the grand total shows the sum of all the days, which is not useful for this metric:</p>
<p class="codelink"><a href="#calibre_link-429" id="calibre_link-2169" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[DaysToDeliver] = INT ( Sales[Delivery Date] - Sales[Order Date] )</pre></div>
<figure id="calibre_link-428" class="image-l">
<img src="images/000165.jpg" alt="The figure shows a table with order date, delivery date, and days to deliver. The grand total of the days to deliver shows the sum of days, which is not useful." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 2-6</strong> The grand total is shown as a sum, when you might want an average instead.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1672"></span>A grand total that we can actually use requires a measure called <em class="calibre5">AvgDelivery</em> showing the delivery time for each order and the average of all the durations at the grand total level:</p>
<p class="codelink"><a href="#calibre_link-430" id="calibre_link-2170" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AvgDelivery := AVERAGE ( Sales[DaysToDeliver] )</pre></div>
<p class="edition">The result of this new measure is visible in the report shown in <a href="#calibre_link-431" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-7</a>.</p>
<figure id="calibre_link-431" class="image-l">
<img src="images/000173.jpg" alt="The figure shows the same report as in Figure 2-6 with an additional column, AvgDelivery. AvgDelivery shows the average delivery days at the grand total level." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 2-7</strong> The measure aggregating by average shows the average delivery days at the grand total level.</figcaption>
</figure>
<p class="edition">The measure computes the average value by averaging a calculated column. One could remove the calculated column, thus saving space in the model, by leveraging an iterator. Indeed, although it is true that <em class="calibre5">AVERAGE</em> cannot average an expression, its counterpart <em class="calibre5">AVERAGEX</em> can iterate the <em class="calibre5">Sales</em> table and compute the delivery days row by row, averaging the results at the end. This code accomplishes the same result as the previous definition:</p>
<p class="codelink"><a href="#calibre_link-432" id="calibre_link-2171" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AvgDelivery :=
AVERAGEX (
    Sales,
    INT ( Sales[Delivery Date] - Sales[Order Date] )
)</pre></div>
<p class="edition">The biggest advantage of this last expression is that it does not rely on the presence of a calculated column. Thus, we can build the entire report without creating expensive calculated columns.</p>
<p class="edition">Most iterators have the same name as their noniterative counterpart. For example, <em class="calibre5">SUM</em> has a corresponding <em class="calibre5">SUMX</em>, and <em class="calibre5">MIN</em> has a corresponding <em class="calibre5">MINX</em>. Nevertheless, keep in mind that some iterators do not correspond to any aggregator. Later in this book, you will learn about <em class="calibre5">FILTER</em>, <em class="calibre5">ADDCOLUMNS</em>, <em class="calibre5">GENERATE</em>, and other functions that are iterators even if they do not aggregate their results.</p>
<p class="edition">When you first learn DAX, you might think that iterators are inherently slow. The concept of performing calculations row by row looks like a CPU-intensive operation. Actually, iterators are fast, and no performance penalty is caused by using iterators instead of standard aggregators. Aggregators are just a syntax-sugared version of iterators.</p>
<p class="edition">Indeed, the basic aggregation functions are a shortened version of the corresponding X-suffixed function. For example, consider the following expression:</p>
<div class="program"><pre class="calibre14">SUM ( Sales[Quantity] )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1673"></span>It is internally translated into this corresponding version of the same code:</p>
<p class="codelink"><a href="#calibre_link-433" id="calibre_link-2172" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SUMX ( Sales, Sales[Quantity] )</pre></div>
<p class="edition">The only advantage in using <em class="calibre5">SUM</em> is a shorter syntax. However, there are no differences in performance between <em class="calibre5">SUM</em> and <em class="calibre5">SUMX</em> aggregating a single column. They are in all respects the same function.</p>
<p class="edition">We will cover more details about this behavior in <a href="#calibre_link-9" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 4</a>. There we introduce the concept of evaluation contexts to describe properly how iterators work.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-62" class="h2a">Using common DAX functions</h3>
<p class="edition">Now that you have seen the fundamentals of DAX and how to handle error conditions, what follows is a brief tour through the most commonly used functions and expressions of DAX.</p>
<section class="calibre4">
<h4 id="calibre_link-63" class="calibre13">Aggregation functions</h4>
<p class="edition">In the previous sections, we described the basic aggregators like <em class="calibre5">SUM</em>, <em class="calibre5">AVERAGE</em>, <em class="calibre5">MIN</em>, and <em class="calibre5">MAX</em>. You learned that <em class="calibre5">SUM</em> and <em class="calibre5">AVERAGE</em>, for example, work only on numeric columns.</p>
<p class="edition">DAX also offers an alternative syntax for aggregation functions inherited from Excel, which adds the suffix A to the name of the function, just to get the same name and behavior as Excel. However, these functions are useful only for columns containing <em class="calibre5">Boolean</em> values because <em class="calibre5">TRUE</em> is evaluated as 1 and <em class="calibre5">FALSE</em> as 0. Text columns are always considered 0. Therefore, no matter what is in the content of a column, if one uses <em class="calibre5">MAXA</em> on a text column, the result will always be a 0. Moreover, DAX never considers empty cells when it performs the aggregation. Although these functions can be used on nonnumeric columns without retuning an error, their results are not useful because there is no automatic conversion to numbers for text columns. These functions are named <em class="calibre5">AVERAGEA</em>, <em class="calibre5">COUNTA</em>, <em class="calibre5">MINA</em>, and <em class="calibre5">MAXA</em>. We suggest that you do not use these functions, whose behavior will be kept unchanged in the future because of compatibility with existing code that might rely on current behavior.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Despite the names being identical to statistical functions, they are used differently in DAX and Excel because in DAX a column has a data type, and its data type determines the behavior of aggregation functions. Excel handles a different data type for each cell, whereas DAX handles a single data type for the entire column. DAX deals with data in tabular form with well-defined types for each column, whereas Excel formulas work on heterogeneous cell values without well-defined types. If a column in Power BI has a numeric data type, all the values can be only numbers or empty cells. If a column is of a text type, it is always 0 for these functions (except for <em class="calibre5">COUNTA</em>), even if the text can be converted into a number, whereas in Excel the value is considered a number on a cell-by-cell basis. For these reasons, these functions are not very useful for Text columns. Only <em class="calibre5">MIN</em> and <em class="calibre5">MAX</em> also support text values in DAX.</p>
</div>
<p class="edition"><span type="pagebreak" id="calibre_link-1674"></span>The functions you learned earlier are useful to perform the aggregation of values. Sometimes, you might not be interested in aggregating values but only in counting them. DAX offers a set of functions that are useful to count rows or values:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">COUNT</em> operates on any data type, apart from <em class="calibre5">Boolean</em>.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">COUNTA</em> operates on any type of column.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">COUNTBLANK</em> returns the number of empty cells (blanks or empty strings) in a column.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">COUNTROWS</em> returns the number of rows in a table.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">DISTINCTCOUNT</em> returns the number of distinct values of a column, blank value included if present.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">DISTINCTCOUNTNOBLANK</em> returns the number of distinct values of a column, no blank value included.</p></li>
</ul>
<p class="edition"><em class="calibre5">COUNT</em> and <em class="calibre5">COUNTA</em> are nearly identical functions in DAX. They return the number of values of the column that are not empty, regardless of their data type. They are inherited from Excel, where <em class="calibre5">COUNTA</em> accepts any data type including strings, whereas <em class="calibre5">COUNT</em> accepts only numeric columns. If we want to count all the values in a column that contain an empty value, you can use the <em class="calibre5">COUNTBLANK</em> function. Both blanks and empty values are considered empty values by <em class="calibre5">COUNTBLANK</em>. Finally, if we want to count the number of rows of a table, you can use the <em class="calibre5">COUNTROWS</em> function. Beware that <em class="calibre5">COUNTROWS</em> requires a table as a parameter, not a column.</p>
<p class="edition">The last two functions, <em class="calibre5">DISTINCTCOUNT</em> and <em class="calibre5">DISTINCTCOUNTNOBLANK</em>, are useful because they do exactly what their names suggest: count the distinct values of a column, which it takes as its only parameter. <em class="calibre5">DISTINCTCOUNT</em> counts the <em class="calibre5">BLANK</em> value as one of the possible values, whereas <em class="calibre5">DISTINCTCOUNTNOBLANK</em> ignores the <em class="calibre5">BLANK</em> value.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition"><em class="calibre5">DISTINCTCOUNT</em> is a function introduced in the 2012 version of DAX. The earlier versions of DAX did not include <em class="calibre5">DISTINCTCOUNT</em>; to compute the number of distinct values of a column, we had to use <em class="calibre5">COUNTROWS (DISTINCT (table[column]))</em>. The two patterns return the same result although <em class="calibre5">DISTINCTCOUNT</em> is easier to read, requiring only a single function call. <em class="calibre5">DISTINCTCOUNTNOBLANK</em> is a function introduced in 2019 and it provides the same semantic of a <em class="calibre5">COUNT DISTINCT</em> operation in SQL without having to write a longer expression in DAX.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-64" class="calibre13">Logical functions</h4>
<p class="edition">Sometimes we want to build a logical condition in an expression&mdash;for example, to implement different calculations depending on the value of a column or to intercept an error condition. In these cases, we can use one of the logical functions in DAX. The earlier section titled “<a href="#calibre_link-55" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Handling errors in DAX expressions</a>” described the two most important functions of this group: <em class="calibre5">IF</em> and <em class="calibre5">IFERROR</em>. We described the <em class="calibre5">IF</em> function in the “<a href="#calibre_link-50" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Conditional statements</a>” section, earlier in this chapter.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2054"></span>Logical functions are very simple and do what their names suggest. They are <em class="calibre5">AND</em>, <em class="calibre5">FALSE</em>, <em class="calibre5">IF</em>, <em class="calibre5">IFERROR</em>, <em class="calibre5">NOT</em>, <em class="calibre5">TRUE</em>, and <em class="calibre5">OR</em>. For example, if we want to compute the amount as quantity multiplied by price only when the <em class="calibre5">Price</em> column contains a numeric value, we can use the following pattern:</p>
<p class="codelink"><a href="#calibre_link-434" id="calibre_link-2173" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Amount] = IFERROR ( Sales[Quantity] * Sales[Price], BLANK ( ) )</pre></div>
<p class="edition">If we did not use <em class="calibre5">IFERROR</em> and if the <em class="calibre5">Price</em> column contained an invalid number, the result for the calculated column would be an error because if a single row generates a calculation error, the error propagates to the whole column. The use of <em class="calibre5">IFERROR</em>, however, intercepts the error and replaces it with a blank value.</p>
<p class="edition">Another interesting function in this category is <em class="calibre5">SWITCH</em>, which is useful when we have a column containing a low number of distinct values, and we want to get different behaviors depending on its value. For example, the column <em class="calibre5">Size</em> in the <em class="calibre5">Product</em> table contains S, M, L, XL, and we might want to decode this value in a more explicit column. We can obtain the result by using nested <em class="calibre5">IF</em> calls:</p>
<p class="codelink"><a href="#calibre_link-435" id="calibre_link-2174" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[SizeDesc] =
IF (
    'Product'[Size] = "S",
    "Small",
    IF (
        'Product'[Size] = "M",
        "Medium",
        IF (
            'Product'[Size] = "L",
            "Large",
            IF (
                'Product'[Size] = "XL",
                "Extra Large",
                "Other"
            )
        )
    )
)</pre></div>
<p class="edition">A more convenient way to express the same formula, using <em class="calibre5">SWITCH</em>, is like this:</p>
<p class="codelink"><a href="#calibre_link-436" id="calibre_link-2175" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[SizeDesc] =
SWITCH (
    'Product'[Size],
    "S", "Small",
    "M", "Medium",
    "L", "Large",
    "XL", "Extra Large",
    "Other"
)</pre></div>
<p class="edition">The code in this latter expression is more readable, though not faster, because internally DAX translates <em class="calibre5">SWITCH</em> statements into a set of nested <em class="calibre5">IF</em> functions.</p>
<span type="pagebreak" id="calibre_link-2050"></span><div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition"><em class="calibre5">SWITCH</em> is often used to check the value of a parameter and define the result of a measure. For example, one might create a parameter table containing <em class="calibre5">YTD, MTD, QTD</em> as three rows and let the user choose from the three available which aggregation to use in a measure. This was a common scenario before 2019. Now it is no longer needed thanks to the introduction of calculation groups, covered in <a href="#calibre_link-14" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 9</a>, “<a href="#calibre_link-14" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Calculation groups</a>.” Calculation groups are the preferred way of computing values that the user can parameterize.</p>
</div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000350.jpg" alt="Image" class="pcalibre6 calibre20" /></span> Tip</p>
<p class="edition">Here is an interesting way to use the <em class="calibre5">SWITCH</em> function to check for multiple conditions in the same expression. Because <em class="calibre5">SWITCH</em> is converted into a set of nested <em class="calibre5">IF</em> functions, where the first one that matches wins, you can test multiple conditions using this pattern:</p>
<p class="codelink"><a href="#calibre_link-437" id="calibre_link-2176" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SWITCH (
   TRUE (),
   Product[Size] = "XL" &amp;&amp; Product[Color] = "Red", "Red and XL",
   Product[Size] = "XL" &amp;&amp; Product[Color] = "Blue", "Blue and XL",
   Product[Size] = "L" &amp;&amp; Product[Color] = "Green", "Green and L"
)</pre></div>
<p class="edition">Using <em class="calibre5">TRUE</em> as the first parameter means, “Return the first result where the condition evaluates to <em class="calibre5">TRUE</em>.”</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-65" class="calibre13">Information functions</h4>
<p class="edition">Whenever there is the need to analyze the type of an expression, you can use one of the information functions. All these functions return a <em class="calibre5">Boolean</em> value and can be used in any logical expression. They are <em class="calibre5">ISBLANK</em>, <em class="calibre5">ISERROR</em>, <em class="calibre5">ISLOGICAL</em>, <em class="calibre5">ISNONTEXT</em>, <em class="calibre5">ISNUMBER</em>, and <em class="calibre5">ISTEXT</em>.</p>
<p class="edition">It is important to note that when a column is passed as a parameter instead of an expression, the functions <em class="calibre5">ISNUMBER</em>, <em class="calibre5">ISTEXT</em>, and <em class="calibre5">ISNONTEXT</em> always return <em class="calibre5">TRUE</em> or <em class="calibre5">FALSE</em> depending on the data type of the column and on the empty condition of each cell. This makes these functions nearly useless in DAX; they have been inherited from Excel in the first DAX version.</p>
<p class="edition">You might be wondering whether you can use <em class="calibre5">ISNUMBER</em> with a text column just to check whether a conversion to a number is possible. Unfortunately, this approach is not possible. If you want to test whether a text value is convertible to a number, you must try the conversion and handle the error if it fails. For example, to test whether the column <em class="calibre5">Price</em> (which is of type <em class="calibre5">string</em>) contains a valid number, one must write</p>
<p class="codelink"><a href="#calibre_link-438" id="calibre_link-2177" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[IsPriceCorrect] = NOT ISERROR ( VALUE ( Sales[Price] ) )</pre></div>
<p class="edition">DAX tries to convert from a string value to a number. If it succeeds, it returns <em class="calibre5">TRUE</em> (because <em class="calibre5">ISERROR</em> returns <em class="calibre5">FALSE</em>); otherwise, it returns <em class="calibre5">FALSE</em> (because <em class="calibre5">ISERROR</em> returns <em class="calibre5">TRUE</em>). For example, the conversion fails if some of the rows have an “N/A” string value for price.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2051"></span>However, if we try to use <em class="calibre5">ISNUMBER</em>, as in the following expression, we always receive <em class="calibre5">FALSE</em> as a result:</p>
<p class="codelink"><a href="#calibre_link-439" id="calibre_link-2178" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[IsPriceCorrect] = ISNUMBER ( Sales[Price] )</pre></div>
<p class="edition">In this case, <em class="calibre5">ISNUMBER</em> always returns <em class="calibre5">FALSE</em> because, based on the definition in the model, the <em class="calibre5">Price</em> column is not a number but a string, regardless of the content of each row.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-66" class="calibre13">Mathematical functions</h4>
<p class="edition">The set of mathematical functions available in DAX is similar to the set available in Excel, with the same syntax and behavior. The mathematical functions of common use are <em class="calibre5">ABS</em>, <em class="calibre5">EXP</em>, <em class="calibre5">FACT</em>, <em class="calibre5">LN</em>, <em class="calibre5">LOG</em>, <em class="calibre5">LOG10</em>, <em class="calibre5">MOD</em>, <em class="calibre5">PI</em>, <em class="calibre5">POWER</em>, <em class="calibre5">QUOTIENT</em>, <em class="calibre5">SIGN</em>, and <em class="calibre5">SQRT</em>. Random functions are <em class="calibre5">RAND</em> and <em class="calibre5">RANDBETWEEN</em>. By using <em class="calibre5">EVEN</em> and <em class="calibre5">ODD</em>, you can test numbers. <em class="calibre5">GCD</em> and <em class="calibre5">LCM</em> are useful to compute the greatest common denominator and least common multiple of two numbers. <em class="calibre5">QUOTIENT</em> returns the integer division of two numbers.</p>
<p class="edition">Finally, several rounding functions deserve an example; in fact, we might use several approaches to get the same result. Consider these calculated columns, along with their results in <a href="#calibre_link-440" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-8</a>:</p>
<p class="codelink"><a href="#calibre_link-441" id="calibre_link-2179" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">FLOOR = FLOOR ( Tests[Value], 0.01 )
TRUNC = TRUNC ( Tests[Value], 2 )
ROUNDDOWN = ROUNDDOWN ( Tests[Value], 2 )
MROUND = MROUND ( Tests[Value], 0.01 )
ROUND = ROUND ( Tests[Value], 2 )
CEILING = CEILING ( Tests[Value], 0.01 )
ISO.CEILING = ISO.CEILING ( Tests[Value], 0.01 )
ROUNDUP = ROUNDUP ( Tests[Value], 2 )
INT = INT ( Tests[Value] )
FIXED = FIXED ( Tests[Value], 2, TRUE )</pre></div>
<figure id="calibre_link-440" class="image-l">
<img src="images/000181.jpg" alt="The figure shows the values for each calculated column, per test value." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 2-8</strong> This summary shows the results of using different rounding functions.</figcaption>
</figure>
<p class="edition"><em class="calibre5">FLOOR</em>, <em class="calibre5">TRUNC</em>, and <em class="calibre5">ROUNDDOWN</em> are similar except in the way we can specify the number of digits to round. In the opposite direction, <em class="calibre5">CEILING</em> and <em class="calibre5">ROUNDUP</em> are similar in their results. You can see a few differences in the way the rounding is done between <em class="calibre5">MROUND</em> and <em class="calibre5">ROUND</em> function.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-67" class="calibre13"><span type="pagebreak" id="calibre_link-2066"></span>Trigonometric functions</h4>
<p class="edition">DAX offers a rich set of trigonometric functions that are useful for certain calculations: <em class="calibre5">COS</em>, <em class="calibre5">COSH</em>, <em class="calibre5">COT</em>, <em class="calibre5">COTH</em>, <em class="calibre5">SIN, SINH</em>, <em class="calibre5">TAN</em>, and <em class="calibre5">TANH</em>. Prefixing them with A computes the arc version (arcsine, arccosine, and so on). We do not go into the details of these functions because their use is straightforward.</p>
<p class="edition"><em class="calibre5">DEGREES</em> and <em class="calibre5">RADIANS</em> perform conversion to degrees and radians, respectively, and <em class="calibre5">SQRTPI</em> computes the square root of its parameter after multiplying it by pi.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-68" class="calibre13">Text functions</h4>
<p class="edition">Most of the text functions available in DAX are similar to those available in Excel, with only a few exceptions. The text functions are <em class="calibre5">CONCATENATE</em>, <em class="calibre5">CONCATENATEX, EXACT</em>, <em class="calibre5">FIND</em>, <em class="calibre5">FIXED</em>, <em class="calibre5">FORMAT</em>, <em class="calibre5">LEFT</em>, <em class="calibre5">LEN, LOWER</em>, <em class="calibre5">MID</em>, <em class="calibre5">REPLACE</em>, <em class="calibre5">REPT</em>, <em class="calibre5">RIGHT</em>, <em class="calibre5">SEARCH</em>, <em class="calibre5">SUBSTITUTE</em>, <em class="calibre5">TRIM</em>, <em class="calibre5">UPPER</em>, and <em class="calibre5">VALUE</em>. These functions are useful for manipulating text and extracting data from strings that contain multiple values. For example, <a href="#calibre_link-442" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-9</a> shows an example of the extraction of first and last names from a string that contains these values separated by commas, with the title in the middle that we want to remove.</p>
<figure id="calibre_link-442" class="image-l">
<img src="images/000189.jpg" alt="This figure shows the first and last names extracted from a string." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 2-9</strong> This example shows first and last names extracted using text functions.</figcaption>
</figure>
<p class="edition">To achieve this result, you start calculating the position of the two commas. Then we use these numbers to extract the right part of the text. The <em class="calibre5">SimpleConversion</em> column implements a formula that might return inaccurate values if there are fewer than two commas in the string, and it raises an error if there are no commas at all. The <em class="calibre5">FirstLastName</em> column implements a more complex expression that does not fail in case of missing commas:</p>
<p class="codelink"><a href="#calibre_link-443" id="calibre_link-2180" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">People[Comma1] = IFERROR ( FIND ( ",", People[Name] ), BLANK ( ) )
People[Comma2] = IFERROR ( FIND ( " ,", People[Name], People[Comma1] + 1 ), BLANK ( ) )
People[SimpleConversion] =
MID ( People[Name], People[Comma2] + 1, LEN ( People[Name] ) )
    &amp; " "
    &amp; LEFT ( People[Name], People[Comma1] - 1 )
People[FirstLastName] =
TRIM (
    MID (
        People[Name],
        IF ( ISNUMBER ( People[Comma2] ), People[Comma2], People[Comma1] ) + 1,
        LEN ( People[Name] )
    )
)
    &amp; IF (
<span type="pagebreak" id="calibre_link-1906"></span>        ISNUMBER ( People[Comma1] ),
        " " &amp; LEFT ( People[Name], People[Comma1] - 1 ),
        ""
    )</pre></div>
<p class="edition">As you can see, the <em class="calibre5">FirstLastName</em> column is defined by a long DAX expression, but you must use it to avoid possible errors that would propagate to the whole column if even a single value generates an error.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-69" class="calibre13">Conversion functions</h4>
<p class="edition">You learned previously that DAX performs automatic conversions of data types to adjust them to operator needs. Although the conversion happens automatically, a set of functions can still perform explicit data type conversions.</p>
<p class="edition"><em class="calibre5">CURRENCY</em> can transform an expression into a Currency type, whereas <em class="calibre5">INT</em> transforms an expression into an Integer. <em class="calibre5">DATE</em> and <em class="calibre5">TIME</em> take the date and time parts as parameters and return a correct <em class="calibre5">DateTime</em>. <em class="calibre5">VALUE</em> transforms a string into a numeric format, whereas <em class="calibre5">FORMAT</em> gets a numeric value as its first parameter and a string format as its second parameter, and it can transform numeric values into strings. <em class="calibre5">FORMAT</em> is commonly used with <em class="calibre5">DateTime</em>. For example, the following expression returns “2019 Jan 12”:</p>
<p class="codelink"><a href="#calibre_link-444" id="calibre_link-2181" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">= FORMAT ( DATE ( 2019, 01, 12 ), "yyyy mmm dd" )</pre></div>
<p class="edition">The opposite operation, that is, converting strings into <em class="calibre5">DateTime</em> values, is performed using the <em class="calibre5">DATEVALUE</em> function.</p>
<div class="sidebar">
<p class="edition">DATEVALUE with dates in different format</p>
<p class="edition"><em class="calibre5">DATEVALUE</em> displays a special behavior regarding dates in different formats. In the European standard, dates are written with the format “dd/mm/yy”, whereas Americans prefer to use “mm/dd/yy”. For example, the 28th of February has different string representations in the two cultures. If you provide to <em class="calibre5">DATEVALUE</em> a date that cannot be converted using the default regional setting, instead of immediately raising an error, it tries a second conversion switching months and days. <em class="calibre5">DATEVALUE</em> also supports the unambiguous format “yyyy-mm-dd”. As an example, the following three expressions evaluate to February 28, no matter which regional settings you have:</p>
<p class="codelink"><a href="#calibre_link-445" id="calibre_link-2182" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DATEVALUE ( "28/02/2018" ) -- This is February 28 in European format
DATEVALUE ( "02/28/2018" ) -- This is February 28 in American format
DATEVALUE ( "2018-02-28" ) -- This is February 28 (format is not ambiguous)</pre></div>
<p class="edition">Sometimes, <em class="calibre5">DATEVALUE</em> does not raise errors when you would expect them. However, this is the behavior of the function by design.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-70" class="calibre13"><span type="pagebreak" id="calibre_link-1907"></span>Date and time functions</h4>
<p class="edition">In almost every type of data analysis, handling time and dates is an important part of the job. Many DAX functions operate on date and time. Some of them correspond to similar functions in Excel and make simple transformations to and from a <em class="calibre5">DateTime</em> data type. The date and time functions are <em class="calibre5">DATE</em>, <em class="calibre5">DATEVALUE</em>, <em class="calibre5">DAY</em>, <em class="calibre5">EDATE</em>, <em class="calibre5">EOMONTH</em>, <em class="calibre5">HOUR</em>, <em class="calibre5">MINUTE</em>, <em class="calibre5">MONTH</em>, <em class="calibre5">NOW</em>, <em class="calibre5">SECOND</em>, <em class="calibre5">TIME</em>, <em class="calibre5">TIMEVALUE</em>, <em class="calibre5">TODAY</em>, <em class="calibre5">WEEKDAY</em>, <em class="calibre5">WEEKNUM</em>, <em class="calibre5">YEAR</em>, and <em class="calibre5">YEARFRAC</em>.</p>
<p class="edition">These functions are useful to compute values on top of dates, but they are not used to perform typical time intelligence calculations such as comparing aggregated values year over year or calculating the year-to-date value of a measure. To perform time intelligence calculations, you use another set of functions called time intelligence functions, which we describe in <a href="#calibre_link-13" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 8</a>, “<a href="#calibre_link-13" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Time intelligence calculations</a>.”</p>
<p class="edition">As we mentioned earlier in this chapter, a <em class="calibre5">DateTime</em> data type internally uses a floating-point number wherein the integer part corresponds to the number of days after December 30, 1899, and the decimal part indicates the fraction of the day in time. Hours, minutes, and seconds are converted into decimal fractions of the day. Thus, adding an integer number to a <em class="calibre5">DateTime</em> value increments the value by a corresponding number of days. However, you will probably find it more convenient to use the conversion functions to extract the day, month, and year from a date. The following expressions used in <a href="#calibre_link-446" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-10</a> show how to extract this information from a table containing a list of dates:</p>
<p class="codelink"><a href="#calibre_link-447" id="calibre_link-2183" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Date'[Day] = DAY ( Calendar[Date] )
'Date'[Month] = FORMAT ( Calendar[Date], "mmmm" )
'Date'[MonthNumber] = MONTH ( Calendar[Date] )
'Date'[Year] = YEAR ( Calendar[Date] )</pre></div>
<figure id="calibre_link-446" class="image-l">
<img src="images/000197.jpg" alt="The figure shows a few rows of the Calendar table with Date, Day, Month, and Year." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 2-10</strong> This example shows how to extract date information using date and time functions.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-71" class="calibre13"><span type="pagebreak" id="calibre_link-2056"></span>Relational functions</h4>
<p class="edition">Two useful functions that you can use to navigate through relationships inside a DAX formula are <em class="calibre5">RELATED</em> and <em class="calibre5">RELATEDTABLE</em>.</p>
<p class="edition">You already know that a calculated column can reference column values of the table in which it is defined. Thus, a calculated column defined in <em class="calibre5">Sales</em> can reference any column of <em class="calibre5">Sales</em>. However, what if one must refer to a column in another table? In general, one cannot use columns in other tables unless a relationship is defined in the model between the two tables. If the two tables share a relationship, you can use the <em class="calibre5">RELATED</em> function to access columns in the related table.</p>
<p class="edition">For example, one might want to compute a calculated column in the <em class="calibre5">Sales</em> table that checks whether the product that has been sold is in the “Cell phones” category and, in that case, apply a reduction factor to the standard cost. To compute such a column, one must use a condition that checks the value of the product category, which is not in the <em class="calibre5">Sales</em> table. Nevertheless, a chain of relationships starts from <em class="calibre5">Sales</em>, reaching <em class="calibre5">Product Category</em> through <em class="calibre5">Product</em> and <em class="calibre5">Product Subcategory</em>, as shown in <a href="#calibre_link-448" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-11</a>.</p>
<figure id="calibre_link-448" class="image-l">
<img src="images/000205.jpg" alt="The figure shows a simple data model with Sales, Product, Product Subcategory, and Product Category. Product has a relationship with Product Subcategory, which in turn has a relationship with Product Category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 2-11</strong> Sales has a chained relationship with <em class="calibre5">Product Category</em>.</figcaption>
</figure>
<p class="edition">Regardless of how many steps are necessary to travel from the original table to the related table, DAX follows the complete chain of relationships, and it returns the related column value. Thus, the formula for the <em class="calibre5">AdjustedCost</em> column can look like this:</p>
<p class="codelink"><a href="#calibre_link-449" id="calibre_link-2184" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[AdjustedCost] =
IF (
    RELATED ( 'Product Category'[Category] ) = "Cell Phone",
    Sales[Unit Cost] * 0.95,
    Sales[Unit Cost]
)</pre></div>
<p class="edition">In a one-to-many relationship, <em class="calibre5">RELATED</em> can access the one-side from the many-side because in that case, only one row in the related table exists, if any. If no such row exists, <em class="calibre5">RELATED</em> returns <em class="calibre5">BLANK</em>.</p>
<p class="edition">If an expression is on the one-side of the relationship and needs to access the many-side, <em class="calibre5">RELATED</em> is not helpful because many rows from the other side might be available for a single row. In that case, we can use <em class="calibre5">RELATEDTABLE</em>. <em class="calibre5">RELATEDTABLE</em> returns a table containing all the rows related to the current row. For example, if we want to know how many products are in each category, we can create a column in <em class="calibre5">Product Categor</em>y with this formula:</p>
<p class="codelink"><a href="#calibre_link-450" id="calibre_link-2185" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product Category'[NumOfProducts] = COUNTROWS ( RELATEDTABLE ( Product ) )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2057"></span>For each product category, this calculated column shows the number of products related, as shown in <a href="#calibre_link-451" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-12</a>.</p>
<figure id="calibre_link-451" class="image-l">
<img src="images/000213.jpg" alt="The figure shows the Category table with the NumOfProducts column that computes the number of products of each category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 2-12</strong> You can count the number of products by using <em class="calibre5">RELATEDTABLE</em>.</figcaption>
</figure>
<p class="edition">As is the case for <em class="calibre5">RELATED</em>, <em class="calibre5">RELATEDTABLE</em> can follow a chain of relationships always starting from the one-side and going toward the many-side. <em class="calibre5">RELATEDTABLE</em> is often used in conjunction with iterators. For example, if we want to compute the sum of quantity multiplied by net price for each category, we can write a new calculated column as follows:</p>
<p class="codelink"><a href="#calibre_link-452" id="calibre_link-2186" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product Category'[CategorySales] =
SUMX (
    RELATEDTABLE ( Sales ),
    Sales[Quantity] * Sales[Net Price]
)</pre></div>
<p class="edition">The result of this calculated column is shown in <a href="#calibre_link-453" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 2-13</a>.</p>
<figure id="calibre_link-453" class="image-l">
<img src="images/000222.jpg" alt="The figure shows the Category table with the CategorySales column that computes the sales amount of each category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 2-13</strong> Using <em class="calibre5">RELATEDTABLE</em> and iterators, we can compute the amount of sales per category.</figcaption>
</figure>
<p class="edition">Because the column is calculated, this result is consolidated in the table, and it does not change according to the user selection in the report, as it would if it were written in a measure.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-72" class="h2a"><span type="pagebreak" id="calibre_link-2977"></span>Conclusions</h3>
<p class="edition">In this chapter, you learned many new functions and started looking at some DAX code. You may not remember all the functions right away, but the more you use them, the more familiar they will become.</p>
<p class="edition">The more crucial topics you learned in this chapter are</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Calculated columns are columns in a table that are computed with a DAX expression. Calculated columns are computed at data refresh time and do not change their value depending on user selection.</p></li>
<li class="calibre10"><p class="listp">Measures are calculations expressed in DAX. Instead of being computed at refresh time like calculated columns are, measures are computed at query time. Consequently, the value of a measure depends on the user selection in the report.</p></li>
<li class="calibre10"><p class="listp">Errors might happen at any time in a DAX expression; it is preferable to detect the error condition beforehand rather than letting the error happen and intercepting it after the fact.</p></li>
<li class="calibre10"><p class="listp">Aggregators like SUM are useful to aggregate columns, whereas to aggregate expressions, you need to use iterators. Iterators work by scanning a table and evaluating an expression row by row. At the end of the iteration, iterators aggregate a result according to their semantics.</p></li>
</ul>
<p class="edition">In the next chapter, you will continue on your learning path by studying the most important table functions available in DAX.<span type="pagebreak" id="calibre_link-2978"></span></p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-454">
<div id="calibre_link-2979" class="calibre2">
<div id="calibre_link-2980" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-8"><span type="pagebreak" id="calibre_link-2030"></span><span class="pd_ash">Chapter 3</span><br class="calibre3" />Using basic table functions</h2>
<p class="edition">In this chapter, you learn the basic table functions available in DAX. Table functions are regular DAX functions that&mdash;instead of returning a single value&mdash;return a table. Table functions are useful when writing both DAX queries and many advanced calculations that require iterating over tables. The chapter includes several examples of such calculations.</p>
<p class="edition">The goal of this chapter is to introduce the notion of table functions, but not to provide a detailed explanation of all the table functions in DAX. A larger number of table functions is included in <a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 12</a>, “<a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with tables</a>,” and in <a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 13</a>, “<a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Authoring queries</a>.” Here, we explain the role of most common and important table functions in DAX, and how to use them in common scenarios, including in scalar DAX expressions.</p>
<section class="calibre4">
<h3 id="calibre_link-73" class="h2a">Introducing table functions</h3>
<p class="edition">Until now, you have seen that a DAX expression usually returns a single value, such as a string or a number. An expression that results in a single value is called a <em class="calibre5">scalar expression</em>. When defining a measure or a calculated column, you always write scalar expressions, as in the following examples:</p>
<p class="codelink"><a href="#calibre_link-455" id="calibre_link-2188" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">= 4 + 3
= "DAX is a beautiful language"
= SUM ( Sales[Quantity] )</pre></div>
<p class="edition">Indeed, the primary goal of a measure is to produce results that are rendered in a report, in a pivot table, or in a chart. At the end of the day, the source of all these reports is a number&mdash;in other words, a scalar expression. Nevertheless, as part of the calculation of a scalar value, you are likely to use tables. For example, a simple iteration like the following uses a table as part of the calculation of the sales amount:</p>
<p class="codelink"><a href="#calibre_link-456" id="calibre_link-2189" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount := SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )</pre></div>
<p class="edition">In this example, <em class="calibre5">SUMX</em> iterates over the <em class="calibre5">Sales</em> table. Thus, though the result of the full calculation is a scalar value, during the computation the formula scans the <em class="calibre5">Sales</em> table. The same code could iterate the <span type="pagebreak" id="calibre_link-2031"></span>result of a table function, like the following code. This code computes the sales amount only for rows greater than one:</p>
<p class="codelink"><a href="#calibre_link-457" id="calibre_link-2190" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount Multiple Items :=
SUMX (
    FILTER (
        Sales,
        Sales[Quantity] &gt; 1
    ),
    Sales[Quantity] * Sales[Net Price]
)</pre></div>
<p class="edition">In the example, we use a <em class="calibre5">FILTER</em> function in place of the reference to <em class="calibre5">Sales</em>. Intuitively, <em class="calibre5">FILTER</em> is a function that filters the content of a table based on a condition. We will describe <em class="calibre5">FILTER</em> in full later. For now, it is important to note that whenever you reference the content of a table, you can replace the reference with the result of a table function.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">In the previous code you see a filter applied to a sum aggregation. This is not
a best practice. In the next chapters, you will learn how to use <em class="calibre5">CALCULATE</em> to implement more flexible and efficient filters. The purpose of the examples in this chapter is not to provide best practices for DAX measures, but rather to explain how table functions work using simple expressions. We will apply these concepts later in more complex scenarios.</p>
</div>
<p class="edition">Moreover, in <a href="#calibre_link-7" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 2</a>, “<a href="#calibre_link-7" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing DAX</a>,” you learned that you can define variables as part of a DAX expression. There, we used variables to store scalar values. However, variables can store tables too. For example, the previous code could be written this way by using a variable:</p>
<p class="codelink"><a href="#calibre_link-458" id="calibre_link-2191" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount Multiple Items :=
VAR
    MultipleItemSales = FILTER ( Sales, Sales[Quantity] &gt; 1 )
RETURN
    SUMX (
        MultipleItemSales,
        Sales[Quantity] * Sales[Unit Price]
    )</pre></div>
<p class="edition"><em class="calibre5">MultipleItemSales</em> is a variable that stores a whole table because its expression is a table function. We strongly encourage using variables whenever possible because they make the code easier to read. By simply assigning a name to an expression, you already are documenting your code extremely well.</p>
<p class="edition">In a calculated column or inside an iteration, one can also use the <em class="calibre5">RELATEDTABLE</em> function to retrieve all the rows of a related table. For example, the following calculated column in the <em class="calibre5">Product</em> table computes the sales amount of the corresponding product:</p>
<p class="codelink"><a href="#calibre_link-459" id="calibre_link-2192" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[Product Sales Amount] =
SUMX (
    RELATEDTABLE ( Sales ),
    Sales[Quantity] * Sales[Unit Price]
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1824"></span>Table functions can be nested too. For example, the following calculated column in the <em class="calibre5">Product</em> table computes the product sales amount considering only sales with a quantity greater than one:</p>
<p class="codelink"><a href="#calibre_link-460" id="calibre_link-2193" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[Product Sales Amount Multiple Items] =
SUMX (
    FILTER (
        RELATEDTABLE ( Sales ),
        Sales[Quantity] &gt; 1
    ),
    Sales[Quantity] * Sales[Unit Price]
)</pre></div>
<p class="edition">In the sample code, <em class="calibre5">RELATEDTABLE</em> is nested inside <em class="calibre5">FILTER</em>. As a rule, when there are nested calls, DAX evaluates the innermost function first and then evaluates the others up to the outermost function.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">As you will see later, the execution order of nested calls can be a source of confusion because <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em> have a different order of evaluation from <em class="calibre5">FILTER</em>. In the next section, you learn the behavior of <em class="calibre5">FILTER</em>. You will find the description for <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em> in <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>, “<a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em></a>.”</p>
</div>
<p class="edition">In general, we cannot use the result of a table function as the value of a measure or of a calculated column. Both measures and calculated columns require the expression to be a scalar value. Instead, we can assign the result of a table expression to a <em class="calibre5">calculated table</em>. A calculated table is a table whose value is determined by a DAX expression rather than loaded from a data source.</p>
<p class="edition">For example, we can create a calculated table containing all the products with a unit price greater than 3,000 by using a table expression like the following:</p>
<p class="codelink"><a href="#calibre_link-461" id="calibre_link-2194" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ExpensiveProducts =
FILTER (
    'Product',
    'Product'[Unit Price] &gt; 3000
)</pre></div>
<p class="edition">Calculated tables are available in Power BI and Analysis Services, but not in Power Pivot for Excel (as of 2019). The more you use table functions, the more you will use them to create more complex data models by using calculated tables and/or complex table expressions inside your measures.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-74" class="h2a">Introducing <em class="calibre5">EVALUATE</em> syntax</h3>
<p class="edition">Query tools such as DAX Studio are useful to author complex table expressions. In that case, a common statement used to inspect the result of a table expression is <em class="calibre5">EVALUATE</em>:</p>
<p class="codelink"><a href="#calibre_link-462" id="calibre_link-2195" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
FILTER (
    'Product',
    'Product'[Unit Price] &gt; 3000
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2013"></span>One can execute the preceding DAX query in any tool that executes DAX queries (DAX Studio, Microsoft Excel, SQL Server Management Studio, Reporting Services, and so on). A DAX query is a DAX expression that returns a table, used with the <em class="calibre5">EVALUATE</em> statement. <em class="calibre5">EVALUATE</em> has a complex syntax, which we fully cover in <a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 13</a>. Here we only introduce the more commonly used <em class="calibre5">EVALUATE</em> syntax, which is as follows:</p>
<p class="codelink"><a href="#calibre_link-463" id="calibre_link-2196" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">[DEFINE { MEASURE &lt;tableName&gt;[&lt;name&gt;] = &lt;expression&gt; }]
EVALUATE &lt;table&gt;
[ORDER BY {&lt;expression&gt; [{ASC | DESC}]} [, ...]]</pre></div>
<p class="edition">The initial <em class="calibre5">DEFINE MEASURE</em> part can be useful to define measures that are local to the query. It becomes useful when we are debugging formulas because we can define a local measure, test it, and then deploy the code in the model once it behaves as expected. Most of the syntax is optional. Indeed, the simplest query one can author retrieves all the rows and columns from an existing table, as shown in <a href="#calibre_link-464" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-1</a>:</p>
<div class="program"><pre class="calibre14">EVALUATE 'Product'</pre></div>
<figure id="calibre_link-464" class="image-l">
<img src="images/000230.jpg" alt="In this screenshot we see the product code, name, description, manufacturer, brand, and such per product key." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-1</strong> The result of the query execution in DAX Studio.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">ORDER BY</em> clause controls the sort order:</p>
<p class="codelink"><a href="#calibre_link-465" id="calibre_link-2197" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
FILTER (
    'Product',
    'Product'[Unit Price] &gt; 3000
)
ORDER BY
    'Product'[Color],
    'Product'[Brand] ASC,
    'Product'[Class] DESC</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Please note that the Sort By Column property defined in a model does not affect the sort order in a DAX query. The sort order specified by <em class="calibre5">EVALUATE</em> can only use columns included in the result. Thus, a client that generates a dynamic DAX query should read the Sort By Column property in a model’s metadata, include the column for the sort order in the query, and then generate a corresponding <em class="calibre5">ORDER BY</em> condition.</p>
</div>
<p class="edition"><em class="calibre5">EVALUATE</em> is not a powerful statement by itself. The power of querying with DAX comes from the power of using the many DAX table functions that are available in the language. In the next sections, you learn how to create advanced calculations by using and combining different table functions.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-75" class="h2a"><span type="pagebreak" id="calibre_link-2047"></span>Understanding <em class="calibre5">FILTER</em></h3>
<p class="edition">Now that we have introduced what table functions are, it is time to describe in full the basic table functions. Indeed, by combining and nesting the basic functions, you can already compute many powerful expressions. The first function you learn is <em class="calibre5">FILTER</em>. The syntax of <em class="calibre5">FILTER</em> is the following:</p>
<p class="codelink"><a href="#calibre_link-466" id="calibre_link-2198" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">FILTER ( &lt;table&gt;, &lt;condition&gt; )</pre></div>
<p class="edition"><em class="calibre5">FILTER</em> receives a table and a logical condition as parameters. As a result, <em class="calibre5">FILTER</em> returns all the rows satisfying the condition. <em class="calibre5">FILTER</em> is both a table function and an iterator at the same time. In order to return a result, it scans the table evaluating the condition on a row-by-row basis. In other words, it iterates the table.</p>
<p class="edition">For example, the following calculated table returns the Fabrikam products (Fabrikam being a brand).</p>
<p class="codelink"><a href="#calibre_link-467" id="calibre_link-2199" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">FabrikamProducts =
FILTER (
    'Product',
    'Product'[Brand] = "Fabrikam"
)</pre></div>
<p class="edition"><em class="calibre5">FILTER</em> is often used to reduce the number of rows in iterations. For example, if a developer wants to compute the sales of red products, they can author a measure like the following one:</p>
<p class="codelink"><a href="#calibre_link-468" id="calibre_link-2200" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">RedSales :=
SUMX (
    FILTER (
        Sales,
        RELATED ( 'Product'[Color] ) = "Red"
    ),
    Sales[Quantity] * Sales[Net Price]
)</pre></div>
<p class="edition">You can see the result in <a href="#calibre_link-469" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-2</a>, along with the total sales.</p>
<figure id="calibre_link-469" class="image-l">
<img src="images/000238.jpg" alt="The figure shows sales amount and redsales per product category, with the totals." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-2</strong> <em class="calibre5">RedSales</em> shows the amount of sales of only red products.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1875"></span>The <em class="calibre5">RedSales</em> measure iterated over a subset of the <em class="calibre5">Sales</em> table&mdash;namely the set of sales that are related to a red product. <em class="calibre5">FILTER</em> adds a condition to the existing conditions. For example, <em class="calibre5">RedSales</em> in the Audio row shows the sales of products that are both of Audio category and of Red color.</p>
<p class="edition">It is possible to nest <em class="calibre5">FILTER</em> in another <em class="calibre5">FILTER</em> function. In general, nesting two filters produces the same result as combining the conditions of the two <em class="calibre5">FILTER</em> functions with an <em class="calibre5">AND</em> function. In other words, the following two queries produce the same result:</p>
<p class="codelink"><a href="#calibre_link-470" id="calibre_link-2201" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">FabrikamHighMarginProducts =
FILTER (
    FILTER (
        'Product',
        'Product'[Brand] = "Fabrikam"
    ),
    'Product'[Unit Price] &gt; 'Product'[Unit Cost] * 3
)

FabrikamHighMarginProducts =
FILTER (
    'Product',
    AND (
        'Product'[Brand] = "Fabrikam",
        'Product'[Unit Price] &gt; 'Product'[Unit Cost] * 3
    )
)</pre></div>
<p class="edition">However, performance might be different on large tables depending on the selectivity of the conditions. If one condition is more selective than the other, applying the most selective condition first by using a nested <em class="calibre5">FILTER</em> function is considered best practice.</p>
<p class="edition">For example, if there are many products with the Fabrikam brand, but few products priced at three times their cost, then the following query applies the filter over <em class="calibre5">Unit Price</em> and <em class="calibre5">Unit Cost</em> in the innermost <em class="calibre5">FILTER</em>. By doing so, the formula applies the most restrictive filter first, in order to reduce the number of iterations needed to check for the brand:</p>
<p class="codelink"><a href="#calibre_link-471" id="calibre_link-2202" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">FabrikamHighMarginProducts =
FILTER (
    FILTER (
        'Product',
        'Product'[Unit Price] &gt; 'Product'[Unit Cost] * 3
    ),
    'Product'[Brand] = "Fabrikam"
)</pre></div>
<p class="edition">Using <em class="calibre5">FILTER</em>, a developer can often produce code that is easier to read and to maintain over time. For example, imagine you need to compute the number of red products. Without using table functions, one possible implementation might be the following:</p>
<p class="codelink"><a href="#calibre_link-472" id="calibre_link-2203" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-1692"></span>NumOfRedProducts :=
SUMX (
    'Product',
    IF ( 'Product'[Color] = "Red", 1, 0 )
)</pre></div>
<p class="edition">The inner <em class="calibre5">IF</em> returns either 1 or 0 depending on the color of the product, and summing this expression returns the number of red products. Although it works, this code is somewhat tricky. A better implementation of the same measure is the following:</p>
<p class="codelink"><a href="#calibre_link-473" id="calibre_link-2204" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NumOfRedProducts :=
COUNTROWS (
    FILTER ( 'Product', 'Product'[Color] = "Red" )
)</pre></div>
<p class="edition">This latter expression better shows what the developer wanted to obtain. Moreover, not only is the code easier to read for a human being, but the DAX optimizer is also better able to understand the developer’s intention. Therefore, the optimizer produces a better query plan, leading in turn to better performance.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-76" class="h2a">Introducing <em class="calibre5">ALL</em> and <em class="calibre5">ALLEXCEPT</em></h3>
<p class="edition">In the previous section you learned <em class="calibre5">FILTER</em>, which is a useful function whenever we want to restrict the number of rows in a table. Sometimes we want to do the opposite; that is, we want to extend the number of rows to consider for a certain calculation. In that case, DAX offers a set of functions designed for that purpose: <em class="calibre5">ALL</em>, <em class="calibre5">ALLEXCEPT</em>, <em class="calibre5">ALLCROSSFILTERED</em>, <em class="calibre5">ALLNOBLANKROW</em>, and <em class="calibre5">ALLSELECTED</em>. In this section, you learn <em class="calibre5">ALL</em> and <em class="calibre5">ALLEXCEPT</em>, whereas the latter two are described later in this chapter and <em class="calibre5">ALLCROSSFILTERD</em> is introduced in <a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a>, “<a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Advanced DAX concepts</a>.”</p>
<p class="edition"><em class="calibre5">ALL</em> returns all the rows of a table or all the values of one or more columns, depending on the parameters used. For example, the following DAX expression returns a <em class="calibre5">ProductCopy</em> calculated table with a copy of all the rows in the Product table:</p>
<p class="codelink"><a href="#calibre_link-474" id="calibre_link-2205" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ProductCopy = ALL ( 'Product' )</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition"><em class="calibre5">ALL</em> is not necessary in a calculated table because there are no report filters influencing it. However, <em class="calibre5">ALL</em> is useful in measures, as shown in the next examples.</p>
</div>
<p class="edition"><em class="calibre5">ALL</em> is extremely useful whenever we need to compute percentages or ratios because it ignores the filters automatically introduced by a report. Imagine we need a report like the one in <a href="#calibre_link-475" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-3</a>, which shows on the same row both the sales amount and the percentage of the given amount against the grand total.</p>
<figure id="calibre_link-475" class="image-l">
<img src="images/000246.jpg" alt="This matrix shows Sales Amount and Sales Pct per Category, with the totals." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1685"></span><strong class="calibre7">Figure 3-3</strong> The report shows the sales amounts and each percentage against the grand total.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">Sales Amount</em> measure computes a value by iterating over the <em class="calibre5">Sales</em> table and performing the multiplication of <em class="calibre5">Sales[Quantity]</em> by <em class="calibre5">Sales[Net Price]</em>:</p>
<p class="codelink"><a href="#calibre_link-476" id="calibre_link-2206" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX (
    Sales,
    Sales[Quantity] * Sales[Net Price]
)</pre></div>
<p class="edition">To compute the percentage, we divide the sales amount by the grand total. Thus, the formula must compute the grand total of sales even when the report is deliberately filtering one given category. This can be obtained by using the <em class="calibre5">ALL</em> function. Indeed, the following measure produces the total of all sales, no matter what filter is being applied to the report:</p>
<p class="codelink"><a href="#calibre_link-477" id="calibre_link-2207" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">All Sales Amount :=
SUMX (
    <strong class="calibre7">ALL ( Sales )</strong>,
    Sales[Quantity] * Sales[Net Price]
)</pre></div>
<p class="edition">In the formula we replaced the reference to <em class="calibre5">Sales</em> with <em class="calibre5">ALL ( Sales )</em>, making good use of the <em class="calibre5">ALL</em> function. At this point, we can compute the percentage by performing a simple division:</p>
<p class="codelink"><a href="#calibre_link-478" id="calibre_link-2208" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Pct := DIVIDE ( [Sales Amount], [All Sales Amount] )</pre></div>
<p class="edition"><a href="#calibre_link-479" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-4</a> shows the result of the three measures together.</p>
<figure id="calibre_link-479" class="image-l">
<img src="images/000254.jpg" alt="In this matrix we see Sales Amount, All Sales Amount, and Sales Pct per Category." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1686"></span><strong class="calibre7">Figure 3-4</strong> The <em class="calibre5">All Sales Amount</em> measure always produces the grand total as a result.</figcaption>
</figure>
<p class="edition">The parameter of <em class="calibre5">ALL</em> cannot be a table expression. It needs to be either a table name or a list of column names. You have already learned what <em class="calibre5">ALL</em> does with a table. What is its result if we use a column instead? In that case, <em class="calibre5">ALL</em> returns all the distinct values of the column in the entire table. The <em class="calibre5">Categories</em> calculated table is obtained from the <em class="calibre5">Category</em> column of the <em class="calibre5">Product</em> table:</p>
<p class="codelink"><a href="#calibre_link-480" id="calibre_link-2209" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Categories = ALL ( 'Product'[Category] )</pre></div>
<p class="edition"><a href="#calibre_link-481" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-5</a> shows the result of the <em class="calibre5">Categories</em> calculated table.</p>
<figure id="calibre_link-481" class="image-l">
<img src="images/000263.jpg" alt="This report shows only categories." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-5</strong> Using <em class="calibre5">ALL</em> with a column produces the list of distinct values of that column.</figcaption>
</figure>
<p class="edition">We can specify multiple columns from the same table in the parameters of the <em class="calibre5">ALL</em> function. In that case, <em class="calibre5">ALL</em> returns all the existing combinations of values in those columns. For example, we can obtain the list of all categories and subcategories by adding the <em class="calibre5">Product[Subcategory]</em> column to the list of values, obtaining the result shown in <a href="#calibre_link-482" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-6</a>:</p>
<p class="codelink"><a href="#calibre_link-483" id="calibre_link-2210" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Categories =
ALL (
    'Product'[Category],
    'Product'[Subcategory]
)</pre></div>
<figure id="calibre_link-482" class="image-l">
<img src="images/000270.jpg" alt="This report displays subcategories for each category." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1695"></span><strong class="calibre7">Figure 3-6</strong> The list contains the distinct, existing values of category and subcategory.</figcaption>
</figure>
<p class="edition">Throughout all its variations, <em class="calibre5">ALL</em> ignores any existing filter in order to produce a result. We can use <em class="calibre5">ALL</em> as an argument of an iteration function, such as <em class="calibre5">SUMX</em> and <em class="calibre5">FILTER</em>, or as a filter argument in a <em class="calibre5">CALCULATE</em> function. You learn the <em class="calibre5">CALCULATE</em> function in <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>.</p>
<p class="edition">If we want to include most, but not all the columns of a table in an <em class="calibre5">ALL</em> function call, we can use <em class="calibre5">ALLEXCEPT</em> instead. The syntax of <em class="calibre5">ALLEXCEPT</em> requires a table followed by the columns we want to exclude. As a result, <em class="calibre5">ALLEXCEPT</em> returns a table with a unique list of existing combinations of values in the other columns of the table.</p>
<p class="edition"><em class="calibre5">ALLEXCEPT</em> is a way to write a DAX expression that will automatically include in the result any additional columns that could appear in the table in the future. For example, if we have a <em class="calibre5">Product</em> table with five columns (<em class="calibre5">ProductKey</em>, <em class="calibre5">Product Name</em>, <em class="calibre5">Brand</em>, <em class="calibre5">Class</em>, <em class="calibre5">Color</em>), the following two expressions produce the same result:</p>
<p class="codelink"><a href="#calibre_link-484" id="calibre_link-2211" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ALL ( 'Product'[Product Name], 'Product'[Brand], 'Product'[Class] )
ALLEXCEPT ( 'Product', 'Product'[ProductKey], 'Product'[Color] )</pre></div>
<p class="edition">However, if we later add the two columns <em class="calibre5">Product[Unit Cost]</em> and <em class="calibre5">Product[Unit Price]</em>, then the result of <em class="calibre5">ALL</em> will ignore them, whereas <em class="calibre5">ALLEXCEPT</em> will return the equivalent of:</p>
<div class="program"><pre class="calibre14">ALL (
    'Product'[Product Name],
    'Product'[Brand],
    'Product'[Class],
    <strong class="calibre7">'Product'[Unit Cost],</strong>
    <strong class="calibre7">'Product'[Unit Price]</strong>
)</pre></div>
<p class="edition">In other words, with <em class="calibre5">ALL</em> we declare the columns we want, whereas with <em class="calibre5">ALLEXCEPT</em> we declare the columns that we want to remove from the result. <em class="calibre5">ALLEXCEPT</em> is mainly useful as a parameter of <em class="calibre5">CALCULATE</em> in advanced calculations, and it is seldomly adopted with simpler formulas. Thus, even if we included its description here for completeness, it will become useful only later in the learning path.</p>
<div class="sidebar">
<p class="edition">Top categories and subcategories</p>
<p class="edition">As an example of using <em class="calibre5">ALL</em> as a table function, imagine we want to produce a dashboard that shows the category and subcategory of products that sold more than twice the average sales amount. To produce this report, we need to first compute the average sales per subcategory and then, once the value has been determined, retrieve from the list of subcategories the ones that have a sales amount larger than twice that average.</p>
<p class="edition">The following code produces that table, and it is worth examining deeper to get a feeling of the power of table functions and variables:</p>
<p class="codelink"><a href="#calibre_link-485" id="calibre_link-2212" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">BestCategories =
VAR Subcategories =
    ALL ( 'Product'[Category], 'Product'[Subcategory] )
VAR AverageSales =
    AVERAGEX (
        Subcategories,
        SUMX ( RELATEDTABLE ( Sales ), Sales[Quantity] * Sales[Net Price] )
    )
VAR TopCategories =
    FILTER (
        Subcategories,
        VAR SalesOfCategory =
            SUMX ( RELATEDTABLE ( Sales ), Sales[Quantity] * Sales[Net Price] )
        RETURN
            SalesOfCategory &gt;= AverageSales * 2
    )
RETURN
    TopCategories</pre></div>
<p class="edition">The first variable (<em class="calibre5">Subcategories</em>) stores the list of all categories and subcategories. Then, <em class="calibre5">AverageSales</em> computes the average of the sales amount for each subcategory. Finally, <em class="calibre5">Top-Categories</em> removes from <em class="calibre5">Subcategories</em> the subcategories that do not have a sales amount larger than twice the value of <em class="calibre5">AverageSales</em>.</p>
<p class="edition">The result of this table is visible in <a href="#calibre_link-486" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-7</a>.</p>
<figure id="calibre_link-486" class="image-l">
<img src="images/000278.jpg" alt="The report returns the relevant subcategories with their respective categories." class="calibre22 pcalibre6" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-7</strong> These are the top subcategories that sold more than twice the average.</figcaption>
</figure>
<p class="edition">Once you master <em class="calibre5">CALCULATE</em> and filter contexts, you will be able to author the same calculations with a shorter and more efficient syntax. Nevertheless, in this example you can already appreciate how combining table functions can produce powerful results, which are useful for dashboards and reports.</p>
</div>
<span type="pagebreak" id="calibre_link-1696"></span></section>
<section class="calibre4">
<h3 id="calibre_link-77" class="h2a"><span type="pagebreak" id="calibre_link-1758"></span>Understanding <em class="calibre5">VALUES</em>, <em class="calibre5">DISTINCT</em>, and the blank row</h3>
<p class="edition">In the previous section, you saw that <em class="calibre5">ALL</em> used with one column returns a table with all its unique values. DAX provides two other similar functions that return a list of unique values for a column: <em class="calibre5">VALUES</em> and <em class="calibre5">DISTINCT</em>. These two functions look almost identical, the only difference being in how they handle the blank row that might exist in a table. You will learn about the optional blank row later in this section; for now let us focus on what these two functions perform.</p>
<p class="edition"><em class="calibre5">ALL</em> always returns all the distinct values of a column. On the other hand, <em class="calibre5">VALUES</em> returns only the distinct visible values. You can appreciate the difference between the two behaviors by looking at the two following measures:</p>
<p class="codelink"><a href="#calibre_link-487" id="calibre_link-2213" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NumOfAllColors := COUNTROWS ( ALL ( 'Product'[Color] ) )
NumOfColors := COUNTROWS ( VALUES ( 'Product'[Color] ) )</pre></div>
<p class="edition"><em class="calibre5">NumOfAllColors</em> counts all the colors of the <em class="calibre5">Product</em> table, whereas <em class="calibre5">NumOfColors</em> counts only the ones that&mdash;given the filter in the report&mdash;are visible. The result of these two measures, sliced by category, is visible in <a href="#calibre_link-488" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-8</a>.</p>
<figure id="calibre_link-488" class="image-l">
<img src="images/000286.jpg" alt="The report displays NumOfColors and NumOfAllColors for each category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-8</strong> For a given category, only a subset of the colors is returned by <em class="calibre5">VALUES</em>.</figcaption>
</figure>
<p class="edition">Because the report slices by category, each given category contains products with some, but not all, the colors. <em class="calibre5">VALUES</em> returns the distinct values of a column evaluated in the current filter. If we use <em class="calibre5">VALUES</em> or <em class="calibre5">DISTINCT</em> in a calculated column or in a calculated table, then their behavior is identical to that of <em class="calibre5">ALL</em> because there is no active filter. On the other hand, when used in a measure, these two functions compute their result considering the existing filters, whereas <em class="calibre5">ALL</em> ignores any filter.</p>
<p class="edition">As you read earlier, the two functions are nearly identical. It is now important to understand why <em class="calibre5">VALUES</em> and <em class="calibre5">DISTINCT</em> are two variations of the same behavior. The difference is the way they consider the presence of a blank row in the table. First, we need to understand how come a blank row might appear in our table if we did not explicitly create a blank row.</p>
<p class="edition">The fact is that the engine automatically creates a blank row in any table that is on the one-side of a relationship in case the relationship is invalid. To demonstrate the behavior, we removed all the silver-colored products from the <em class="calibre5">Product</em> table. Since there were 16 distinct colors initially and we removed one <span type="pagebreak" id="calibre_link-2981"></span>color, one would expect the total number of colors to be 15. Instead, the report in <a href="#calibre_link-489" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-9</a> shows something unexpected: <em class="calibre5">NumOfAllColors</em> is still 16 and the report shows a new row at the top, with no name.</p>
<figure id="calibre_link-489" class="image-l">
<img src="images/000295.jpg" alt="In this matrix the first row is a blank category, with values for NumOfColors and NumOfAllColors." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-9</strong> The first rows shows a blank for the category, and the total number of colors is 16 instead of 15.</figcaption>
</figure>
<p class="edition">Because <em class="calibre5">Product</em> is on the one-side of a relationship with <em class="calibre5">Sales</em>, for each row in the <em class="calibre5">Sales</em> table there is a related row in the <em class="calibre5">Product</em> table. Nevertheless, because we deliberately removed all the products with one color, there are now many rows in <em class="calibre5">Sales</em> that no longer have a valid relationship with the <em class="calibre5">Product</em> table. Be mindful, we did not remove any row from <em class="calibre5">Sales</em>; we removed a color with the intent of breaking the relationship.</p>
<p class="edition">To guarantee that these rows are considered in all the calculations, the engine automatically added to the <em class="calibre5">Product</em> table a row containing blank in all its columns. All the orphaned rows in <em class="calibre5">Sales</em> are linked to this newly introduced blank row.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">Only one blank row is added to the <em class="calibre5">Product</em> table, despite the fact that multiple different products referenced in the <em class="calibre5">Sales</em> table no longer have a corresponding <em class="calibre5">ProductKey</em> in the <em class="calibre5">Product</em> table.</p>
</div>
<p class="edition">Indeed, in <a href="#calibre_link-489" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-9</a> you can see that the first row shows a blank for the <em class="calibre5">Category</em> and accounts for one color. The number comes from a row containing blank in the category, blank in the color, and blank in all the columns of the table. You will not see the row if you inspect the table because it is an automatic row created during the loading of the data model. If, at some point, the relationship becomes valid again&mdash;if you were to add the silver products back&mdash;then the blank row will disappear from the table.</p>
<p class="edition">Certain functions in DAX consider the blank row as part of their result, whereas others do not. Specifically, <em class="calibre5">VALUES</em> considers the blank row as a valid row, and it returns it. On the other hand, <em class="calibre5">DISTINCT</em> does not return it. You can appreciate the difference by looking at the following new measure, which counts the <em class="calibre5">DISTINCT</em> colors instead of <em class="calibre5">VALUES</em>:</p>
<p class="codelink"><a href="#calibre_link-490" id="calibre_link-2214" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NumOfDistinctColors := COUNTROWS ( <strong class="calibre7">DISTINCT</strong> ( 'Product'[Color] ) )</pre></div>
<p class="edition">The result is visible in <a href="#calibre_link-491" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-10</a>.</p>
<figure id="calibre_link-491" class="image-l">
<img src="images/000303.jpg" alt="For the blank category, the reports returns a blank value under NumOfDistinctColors." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2002"></span><strong class="calibre7">Figure 3-10</strong> <em class="calibre5">NumOfDistinctColors</em> shows a blank for the blank row, and its total shows 15 instead of 16.</figcaption>
</figure>
<p class="edition">A well-designed model should not present any invalid relationships. Thus, if your model is perfect, then the two functions always return the same values. Nevertheless, when dealing with invalid relationships, you need to be aware of this behavior because otherwise you might end up writing incorrect calculations. For example, imagine that we want to compute the average sales per product. A possible solution is to compute the total sales and divide that by the number of products, by using this code:</p>
<p class="codelink"><a href="#calibre_link-492" id="calibre_link-2215" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AvgSalesPerProduct :=
DIVIDE (
    SUMX (
        Sales,
        Sales[Quantity] * Sales[Net Price]
    ),
    COUNTROWS (
        VALUES ( 'Product'[Product Code] )
    )
)</pre></div>
<p class="edition">The result is visible in <a href="#calibre_link-493" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-11</a>. It is obviously wrong because the first row is a huge, meaningless number.</p>
<figure id="calibre_link-493" class="image-l">
<img src="images/000311.jpg" alt="In this figure, the blank category is assigned a seemingly inconsistent amount under AvgSalesPerProduct." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-11</strong> The first row shows a huge value accounted for a category with no name.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1759"></span>The number shown in the first row, where <em class="calibre5">Category</em> is blank, corresponds to the sales of all the silver products&mdash;which no longer exist in the <em class="calibre5">Product</em> table. This blank row associates all the products that were silver and are no longer in the <em class="calibre5">Product</em> table. The numerator of <em class="calibre5">DIVIDE</em> considers all the sales of silver products. The denominator of <em class="calibre5">DIVIDE</em> counts a single blank row returned by <em class="calibre5">VALUES</em>. Thus, a single non-existing product (the blank row) is cumulating the sales of many other products referenced in <em class="calibre5">Sales</em> and not available in the <em class="calibre5">Product</em> table, leading to a huge number. Here, the problem is the invalid relationship, not the formula by itself. Indeed, no matter what formula we create, there are many sales of products in the <em class="calibre5">Sales</em> table for which the database has no information. Nevertheless, it is useful to look at how different formulations of the same calculation return different results. Consider these two other variations:</p>
<p class="codelink"><a href="#calibre_link-494" id="calibre_link-2216" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AvgSalesPerDistinctProduct :=
DIVIDE (
    SUMX ( Sales, Sales[Quantity] * Sales[Net Price] ),
    COUNTROWS ( <strong class="calibre7">DISTINCT</strong> ( 'Product'[Product Code] ) )
)

AvgSalesPerDistinctKey :=
DIVIDE (
    SUMX ( Sales, Sales[Quantity] * Sales[Net Price] ),
    COUNTROWS ( <strong class="calibre7">VALUES</strong> ( Sales[ProductKey] ) )
)</pre></div>
<p class="edition">In the first variation, we used <em class="calibre5">DISTINCT</em> instead of <em class="calibre5">VALUES</em>. As a result, <em class="calibre5">COUNTROWS</em> returns a blank and the result will be a blank. In the second variation, we still used <em class="calibre5">VALUES</em>, but this time we are counting the number of <em class="calibre5">Sales[ProductKey]</em>. Keep in mind that there are many different <em class="calibre5">Sales[ProductKey]</em> values, all related to the same blank row. The result is visible in <a href="#calibre_link-495" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-12</a>.</p>
<figure id="calibre_link-495" class="image-l">
<img src="images/000319.jpg" alt="This figure displays AvgSalesPerProduct along with the latter two measures, and the blank category returns a blank under AvgSalesPerDistinctProduct." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-12</strong> In the presence of invalid relationships, the measures are most likely wrong&mdash;each in their own way.</figcaption>
</figure>
<p class="edition">It is interesting to note that <em class="calibre5">AvgSalesPerDistinctKey</em> is the only correct calculation. Since we sliced by <em class="calibre5">Category</em>, each category had a different number of invalid product keys&mdash;all of which collapsed to the single blank row.</p>
<p class="edition">However, the correct approach should be to fix the relationship so that no sale is orphaned of its product. The golden rule is to not have any invalid relationships in the model. If, for any reason, you <span type="pagebreak" id="calibre_link-2982"></span>have invalid relationships, then you need to be extremely cautious in how you handle the blank row, as well as how its presence might affect your calculations.</p>
<p class="edition">As a final note, consider that the <em class="calibre5">ALL</em> function always returns the blank row, if present. In case you need to remove the blank row from the result, then <em class="calibre5">ALLNOBLANKROW</em> is the function you will want to use.</p>
<div class="sidebar">
<p class="edition"><em class="calibre5">VALUES</em> of multiple columns</p>
<p class="edition">The functions <em class="calibre5">VALUES</em> and <em class="calibre5">DISTINCT</em> only accept a single column as a parameter. There is no corresponding version for two or more columns, as there is for <em class="calibre5">ALL</em> and <em class="calibre5">ALLNOBLANKROW</em>. In case we need to obtain the distinct, visible combinations of values from different columns, then <em class="calibre5">VALUES</em> is of no help. Later in <a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 12</a> you will learn that:</p>
<p class="codelink"><a href="#calibre_link-496" id="calibre_link-2217" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">VALUES ( 'Product'[Category], 'Product'[Subcategory] )</pre></div>
<p class="edition">can be obtained by writing:</p>
<p class="codelink"><a href="#calibre_link-497" id="calibre_link-2218" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SUMMARIZE ( 'Product', 'Product'[Category], 'Product'[Subcategory] )</pre></div></div>
<p class="edition">Later, you will see that <em class="calibre5">VALUES</em> and <em class="calibre5">DISTINCT</em> are often used as a parameter of iterator functions. There are no differences in their results whenever the relationships are valid. In such a case, when you iterate over the values of a column, you need to consider the blank row as a valid row, in order to make sure that you iterate all the possible values. As a rule of thumb, <em class="calibre5">VALUES</em> should be your default choice, only leaving <em class="calibre5">DISTINCT</em> to cases when you want to explicitly exclude the possible blank value. Later in this book, you will also learn how to leverage <em class="calibre5">DISTINCT</em> instead of <em class="calibre5">VALUES</em> to avoid circular dependencies. We will cover it in <a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 15</a>, “<a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Advanced relationships handling</a>.”</p>
<p class="edition"><em class="calibre5">VALUES</em> and <em class="calibre5">DISTINCT</em> also accept a table as an argument. In that case, they exhibit different behaviors:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">DISTINCT</em> returns the distinct values of the table, not considering the blank row. Thus, duplicated rows are removed from the result.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">VALUES</em> returns all the rows of the table, without removing duplicates, plus the additional blank row if present. Duplicated rows, in this case, are kept untouched.</p></li>
</ul>
</section>
<section class="calibre4">
<h3 id="calibre_link-78" class="h2a">Using tables as scalar values</h3>
<p class="edition">Although <em class="calibre5">VALUES</em> is a table function, we will often use it to compute scalar values because of a special feature in DAX: a table with a single row and a single column can be used as if it were a scalar value. Imagine we produce a report like the one in <a href="#calibre_link-498" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-13</a>, reporting the number of brands sliced by category and subcategory.</p>
<figure id="calibre_link-498" class="image-l">
<img src="images/000327.jpg" alt="The report shows NumOfBrands per Category." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1913"></span><strong class="calibre7">Figure 3-13</strong> The report shows the number of brands available for each category and subcategory.</figcaption>
</figure>
<p class="edition">One might also want to see the names of the brands beside their number. One possible solution is to use <em class="calibre5">VALUES</em> to retrieve the different brands and, instead of counting them, return their value. This is possible only in the special case when there is only one value for the brand. Indeed, in that case it is possible to return the result of <em class="calibre5">VALUES</em> and DAX automatically converts it into a scalar value. To make sure that there is only one brand, one needs to protect the code with an <em class="calibre5">IF</em> statement:</p>
<p class="codelink"><a href="#calibre_link-499" id="calibre_link-2219" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Brand Name :=
IF (
    COUNTROWS ( VALUES ( Product[Brand] ) ) = 1,
    VALUES ( Product[Brand] )
)</pre></div>
<p class="edition">The result is visible in <a href="#calibre_link-500" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-14</a>. When the <em class="calibre5">Brand Name</em> column contains a blank, it means that there are two or more different brands.</p>
<figure id="calibre_link-500" class="image-l">
<img src="images/000335.jpg" alt="In this report we see NumOfBrands and Brand Name per Category and subcategory." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-14</strong> When <em class="calibre5">VALUES</em> returns a single row, we can use it as a scalar value, as in the <em class="calibre5">Brand Name</em> measure.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">Brand Name</em> measure uses <em class="calibre5">COUNTROWS</em> to check whether the <em class="calibre5">Color</em> column of the <em class="calibre5">Products</em> table only has one value selected. Because this pattern is frequently used in DAX code, there is a <span type="pagebreak" id="calibre_link-1699"></span>simpler function that checks whether a column only has one visible value: <em class="calibre5">HASONEVALUE</em>. The following is a better implementation of the <em class="calibre5">Brand Name</em> measure, based on <em class="calibre5">HASONEVALUE</em>:</p>
<p class="codelink"><a href="#calibre_link-501" id="calibre_link-2220" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Brand Name :=
IF (
    HASONEVALUE ( 'Product'[Brand] ),
    VALUES ( 'Product'[Brand] )
)</pre></div>
<p class="edition">Moreover, to make the lives of developers easier, DAX also offers a function that automatically checks if a column contains a single value and, if so, it returns the value as a scalar. In case there are multiple values, it is also possible to define a default value to be returned. That function is <em class="calibre5">SELECTEDVALUE</em>. The previous measure can also be defined as</p>
<p class="codelink"><a href="#calibre_link-502" id="calibre_link-2221" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Brand Name := SELECTEDVALUE ( 'Product'[Brand] )</pre></div>
<p class="edition">By including the second optional argument, one can provide a message stating that the result contains multiple results:</p>
<p class="codelink"><a href="#calibre_link-503" id="calibre_link-2222" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Brand Name := SELECTEDVALUE ( 'Product'[Brand], "Multiple brands" )</pre></div>
<p class="edition">The result of this latest measure is visible in <a href="#calibre_link-504" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-15</a>.</p>
<figure id="calibre_link-504" class="image-l">
<img src="images/000343.jpg" alt="The report shows NumOfBrands and Brand Name per Category and Subcategory." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-15</strong> <em class="calibre5">SELECTEDVALUE</em> returns a default value in case there are multiple rows for the <em class="calibre5">Brand Name</em> column.</figcaption>
</figure>
<p class="edition">What if, instead of returning a message like “Multiple brands,” one wants to list all the brands? In that case, an option is to iterate over the <em class="calibre5">VALUES</em> of <em class="calibre5">Product[Brand]</em> and use the <em class="calibre5">CONCATENATEX</em> function, which produces a good result even if there are multiple values:</p>
<p class="codelink"><a href="#calibre_link-505" id="calibre_link-2223" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">[Brand Name] :=
CONCATENATEX (
    VALUES ( 'Product'[Brand] ),
    'Product'[Brand],
    ", "
)</pre></div>
<p class="edition">Now the result contains the different brands separated by a comma instead of the generic message, as shown in <a href="#calibre_link-506" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-16</a>.</p>
<figure id="calibre_link-506" class="image-l">
<img src="images/000351.jpg" alt="This figure returns NumOfBrands and Brand Name per Category and Subcategory." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1700"></span><strong class="calibre7">Figure 3-16</strong> <em class="calibre5">CONCATENATEX</em> builds strings out of tables, concatenating expressions.</figcaption>
</figure>
</section>
<section class="calibre4">
<h3 id="calibre_link-79" class="h2a">Introducing <em class="calibre5">ALLSELECTED</em></h3>
<p class="edition">The last table function that belongs to the set of basic table functions is <em class="calibre5">ALLSELECTED</em>. Actually, <em class="calibre5">ALLSELECTED</em> is a very complex table function&mdash;probably the most complex table function in DAX. In <a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a>, we will uncover all the secrets of <em class="calibre5">ALLSELECTED</em>. Nevertheless, <em class="calibre5">ALLSELECTED</em> is useful even in its basic implementation. For that reason, it is worth mentioning in this introductory chapter.</p>
<p class="edition"><em class="calibre5">ALLSELECTED</em> is useful when retrieving the list of values of a table, or a column, as visible in the current report and considering all and only the filters outside of the current visual. To see when <em class="calibre5">ALLSELECTED</em> becomes useful, look at the report in <a href="#calibre_link-507" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-17</a>.</p>
<figure id="calibre_link-507" class="image-l">
<img src="images/000359.jpg" alt="In this report, a slicer is available next to a matrix returning Sales Amount and Sales Pct per Category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-17</strong> The report contains a matrix and a slicer, on the same page.</figcaption>
</figure>
<p class="edition">The value of <em class="calibre5">Sales Pct</em> is computed by the following measure:</p>
<p class="codelink"><a href="#calibre_link-508" id="calibre_link-2224" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Pct :=
DIVIDE (
    SUMX ( Sales, Sales[Quantity] * Sales[Net Price] ),
    SUMX ( ALL ( Sales ), Sales[Quantity] * Sales[Net Price] )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1701"></span>Because the denominator uses the <em class="calibre5">ALL</em> function, it always computes the grand total of all sales, regardless of any filter. As such, if one uses the slicer to reduce the number of categories shown, the report still computes the percentage against all the sales. For example, <a href="#calibre_link-509" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-18</a> shows what happens if one selects some categories with the slicer.</p>
<figure id="calibre_link-509" class="image-l">
<img src="images/000366.jpg" alt="The slicer is being used in this report, which returns Sales Amount and Sales Pct per Category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-18</strong> Using <em class="calibre5">ALL</em>, the percentage is still computed against the grand total of all sales.</figcaption>
</figure>
<p class="edition">Some rows disappeared as expected, but the amounts reported in the remaining rows are unchanged. Moreover, the grand total of the matrix no longer accounts for 100%. If this is not the expected result, meaning that you want the percentage to be computed not against the grand total of sales but rather only on the selected values, then <em class="calibre5">ALLSELECTED</em> becomes useful.</p>
<p class="edition">Indeed, by writing the code of <em class="calibre5">Sales Pct</em> using <em class="calibre5">ALLSELECTED</em> instead of <em class="calibre5">ALL</em>, the denominator computes the sales of all categories considering all and only the filters outside of the matrix. In other words, it returns the sales of all categories except Audio, Music, and TV.</p>
<p class="codelink"><a href="#calibre_link-510" id="calibre_link-2225" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Pct :=
DIVIDE (
    SUMX ( Sales, Sales[Quantity] * Sales[Net Price] ),
    SUMX ( <strong class="calibre7">ALLSELECTED</strong> ( Sales ), Sales[Quantity] * Sales[Net Price] )
)</pre></div>
<p class="edition">The result of this latter version is visible in <a href="#calibre_link-511" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 3-19</a>.</p>
<figure id="calibre_link-511" class="image-l">
<img src="images/000373.jpg" alt="The report returns Sales Amount and Sales Pct for each category, again using the slicer." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 3-19</strong> Using <em class="calibre5">ALLSELECTED</em>, the percentage is computed against the sales only considering outer filters.</figcaption>
</figure>
<p class="edition">The total is now 100% and the numbers reported reflect the percentage against the visible total, not against the grand total of all sales. <em class="calibre5">ALLSELECTED</em> is a powerful and useful function. Unfortunately, to achieve this purpose, it ends up being an extraordinarily complex function too. Only much later in <span type="pagebreak" id="calibre_link-2983"></span>the book will we be able to explain it in full. Because of its complexity, <em class="calibre5">ALLSELECTED</em> sometimes returns unexpected results. By unexpected we do not mean wrong, but rather, ridiculously hard to understand even for seasoned DAX developers.</p>
<p class="edition">When used in simple formulas like the one we have shown here, <em class="calibre5">ALLSELECTED</em> proves to be particularly useful, anyway.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-80" class="h2a">Conclusions</h3>
<p class="edition">As you have seen in this chapter, basic table functions are already immensely powerful, and they allow you to start creating many useful calculations. <em class="calibre5">FILTER</em>, <em class="calibre5">ALL</em>, <em class="calibre5">VALUES</em> and <em class="calibre5">ALLSELECTED</em> are extremely common functions that appear in many DAX formulas.</p>
<p class="edition">Learning how to mix table functions to produce the result you want is particularly important because it will allow you to seamlessly achieve advanced calculations. Moreover, when mixed with the power of <em class="calibre5">CALCULATE</em> and of context transition, table functions produce compact, neat, and powerful calculations. In the next chapters, we introduce evaluation contexts and the <em class="calibre5">CALCULATE</em> function. After having learned <em class="calibre5">CALCULATE</em>, you will probably revisit this chapter to use table functions as parameters of <em class="calibre5">CALCULATE</em>, thus leveraging their full potential.<span type="pagebreak" id="calibre_link-2984"></span></p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-512">
<div id="calibre_link-2985" class="calibre2">
<div id="calibre_link-2986" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-9"><span type="pagebreak" id="calibre_link-1786"></span><span class="pd_ash">Chapter 4</span><br class="calibre3" />Understanding evaluation contexts</h2>
<p class="edition">At this point in the book, you have learned the basics of the DAX language. You know how to create calculated columns and measures, and you have a good understanding of common functions used in DAX. This is the chapter where you move to the next level in this language: After learning a solid theoretical background of the DAX language, you become a real DAX champion.</p>
<p class="edition">With the knowledge you have gained so far, you can already create many interesting reports, but you need to learn evaluation contexts in order to create more complex formulas. Indeed, evaluation contexts are the basis of all the advanced features of DAX.</p>
<p class="edition">We want to give a few words of warning to our readers. The concept of evaluation contexts is simple, and you will learn and understand it soon. Nevertheless, you need to thoroughly understand several subtle considerations and details. Otherwise, you will feel lost at a certain point on your DAX learning path. We have been teaching DAX to thousands of users in public and private classes, so we know that this is normal. At a certain point, you have the feeling that formulas work like magic because they work, but you do not understand why. Do not worry: you will be in good company. Most DAX students reach that point, and many others will reach it in the future. It simply means that evaluation contexts are not clear enough to them. The solution, at that point, is easy: Come back to this chapter, read it again, and you will probably find something new that you missed during your first read.</p>
<p class="edition">Moreover, evaluation contexts play an important role when using the <em class="calibre5">CALCULATE</em> function&mdash;which is probably the most powerful and hard-to-learn DAX function. We introduce <em class="calibre5">CALCULATE</em> in <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>, “<a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em></a>,” and then we use it throughout the rest of the book. Understanding <em class="calibre5">CALCULATE</em> without having a solid understanding of evaluation contexts is problematic. On the other hand, understanding the importance of evaluation contexts without having ever tried to use <em class="calibre5">CALCULATE</em> is nearly impossible. Thus, in our experience with previous books we have written, this chapter and the subsequent one are the two that are always marked up and have the corners of pages folded over.</p>
<p class="edition">In the rest of the book we will use these concepts. Then in <a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a>, “<a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Advanced DAX concepts</a>,” you will complete your learning of evaluation contexts with expanded tables. Beware that the content of this chapter is not the definitive description of evaluation contexts just yet. A more detailed description of evaluation contexts is the description based on expanded tables, but it would be too hard to learn about expanded tables before having a good understanding of the basics of evaluation contexts. Therefore, we introduce the whole theory in different steps.</p>
<section class="calibre4">
<h3 id="calibre_link-81" class="h2a"><span type="pagebreak" id="calibre_link-2016"></span>Introducing evaluation contexts</h3>
<p class="edition">There are two evaluation contexts: the filter context and the row context. In the next sections, you learn what they are and how to use them to write DAX code. Before learning what they are, it is important to state one point: They are different concepts, with different functionalities and a completely different usage.</p>
<p class="edition">The most common mistake of DAX newbies is that of confusing the two contexts as if the row context was a slight variation of a filter context. This is not the case. The filter context filters data, whereas the row context iterates tables. When DAX is iterating, it is not filtering; and when it is filtering, it is not iterating. Even though this is a simple concept, we know from experience that it is hard to imprint in the mind. Our brain seems to prefer a short path to learning&mdash;when it believes there are some similarities, it uses them by merging the two concepts into one. Do not be fooled. Whenever you have the feeling that the two evaluation contexts look the same, stop and repeat this sentence in your mind like a mantra: “The filter context filters, the row context iterates, they are not the same.”</p>
<p class="edition">An evaluation context is the context under which a DAX expression is evaluated. In fact, any DAX expression can provide different values in different contexts. This behavior is intuitive, and this is the reason why one can write DAX code without learning about evaluation contexts in advance. You probably reached this point in the book having authored DAX code without learning about evaluation contexts. Because you want more, it is now time to be more precise, to set up the foundations of DAX the right way, and to prepare yourself to unleash the full power of DAX.</p>
<section class="calibre4">
<h4 id="calibre_link-82" class="calibre13">Understanding filter contexts</h4>
<p class="edition">Let us begin by understanding what an evaluation context is. All DAX expressions are evaluated inside a context. The context is the “environment” within which the formula is evaluated. For example, consider a measure such as</p>
<p class="codelink"><a href="#calibre_link-513" id="calibre_link-2227" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount := SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )</pre></div>
<p class="edition">This formula computes the sum of quantity multiplied by price in the <em class="calibre5">Sales</em> table. We can use this measure in a report and look at the results, as shown in <a href="#calibre_link-514" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-1</a>.</p>
<figure id="calibre_link-514" class="image-l">
<img src="images/000382.jpg" alt="This figure shows one column and two rows: sales amount and the actual amount." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-1</strong> The measure <em class="calibre5">Sales Amount</em>, without a context, shows the grand total of sales.</figcaption>
</figure>
<p class="edition">This number alone does not look interesting. However, if you think carefully, the formula computes exactly what one would expect: the sum of all sales amounts. In a real report, one is likely to slice the value by a certain column. For example, we can select the product brand, use it on the rows, and the matrix report starts to reveal interesting business insights as shown in <a href="#calibre_link-515" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-2</a>.</p>
<figure id="calibre_link-515" class="image-l">
<img src="images/000389.jpg" alt="The report shows Sales Amount per Brand." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2987"></span><strong class="calibre7">Figure 4-2</strong> Sum of <em class="calibre5">Sales Amount</em>, sliced by brand, shows the sales of each brand in separate rows.</figcaption>
</figure>
<p class="edition">The grand total is still there, but now it is the sum of smaller values. Each value, together with all the others, provides more detailed insights. However, you should note that something weird is happening: The formula is not computing what we apparently asked. In fact, inside each cell of the report, the formula is no longer computing the sum of all sales. Instead, it computes the sales of a given brand. Finally, note that nowhere in the code does it say that it can (or should) work on subsets of data. This filtering happens outside of the formula.</p>
<p class="edition">Each cell computes a different value because of the <em class="calibre5">evaluation context</em> under which DAX executes the formula. You can think of the evaluation context of a formula as the surrounding area of the cell where DAX evaluates the formula.</p>
<blockquote class="calibre23">
<p class="noindent"><strong class="calibre7">DAX evaluates all formulas within a respective context. Even though the formula is the same, the result is different because DAX executes the same code against different subsets of data.</strong></p>
</blockquote>
<p class="edition">This context is named <em class="calibre5">Filter Context</em> and, as the name suggests, it is a context that filters tables. Any formula ever authored will have a different value depending on the filter context used to perform its evaluation. This behavior, although intuitive, needs to be well understood because it hides many complexities.</p>
<p class="edition">Every cell of the report has a different filter context. You should consider that every cell has a different evaluation&mdash;as if it were a different query, independent from the other cells in the same report. The engine might perform some level of internal optimization to improve computation speed, but you should assume that every cell has an independent and autonomous evaluation of the underlying DAX expression. Therefore, the computation of the Total row in <a href="#calibre_link-515" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-2</a> is not computed by summing the other rows of the report. It is computed by aggregating all the rows of the <em class="calibre5">Sales</em> table, although this means other iterations were already computed for the other rows in the same report. Consequently, <span type="pagebreak" id="calibre_link-2988"></span>depending on the DAX expression, the result in the Total row might display a different result, unrelated to the other rows in the same report.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">In these examples, we are using a matrix for the sake of simplicity. We can define an evaluation context with queries too, and you will learn more about it in future chapters. For now, it is better to keep it simple and only think of reports, to have a simplified and visual understanding of the concepts.</p>
</div>
<p class="edition">When <em class="calibre5">Brand</em> is on the rows, the filter context filters one brand for each cell. If we increase the complexity of the matrix by adding the year on the columns, we obtain the report in <a href="#calibre_link-516" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-3</a>.</p>
<figure id="calibre_link-516" class="image-l">
<img src="images/000396.jpg" alt="The report displays CY 2007 to 2009 and the total for each brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-3</strong> <em class="calibre5">Sales amount</em> is sliced by brand and year.</figcaption>
</figure>
<p class="edition">Now each cell shows a subset of data pertinent to one brand and one year. The reason for this is that the filter context of each cell now filters both the brand and the year. In the Total row, the filter is only on the brand, whereas in the Total column the filter is only on the year. The grand total is the only cell that computes the sum of all sales because&mdash;there&mdash;the filter context does not apply any filter to the model.</p>
<p class="edition">The rules of the game should be clear at this point: The more columns we use to slice and dice, the more columns are being filtered by the filter context in each cell of the matrix. If one adds the <em class="calibre5">Store[Continent]</em> column to the rows, the result is&mdash;again&mdash;different, as shown in <a href="#calibre_link-517" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-4</a>.</p>
<figure id="calibre_link-517" class="image-l">
<img src="images/000404.jpg" alt="This report displays CY 2007 to 2009 and the total, per brand." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2989"></span><strong class="calibre7">Figure 4-4</strong> The context is defined by the set of fields on rows and on columns.</figcaption>
</figure>
<p class="edition">Now the filter context of each cell is filtering brand, country, and year. In other words, the filter context contains the complete set of fields that one uses on rows and columns of the report.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Whether a field is on the rows or on the columns of the visual, or on the slicer and/or page/report/visual filter, or in any other kind of filter we can create with a report&mdash;all this is irrelevant. All these filters contribute to define a single filter context, which DAX uses to evaluate the formula. Displaying a field on rows or columns is useful for aesthetic purposes, but nothing changes in the way DAX computes values.</p>
</div>
<p class="edition">Visual interactions in Power BI compose a filter context by combining different elements from a graphical interface. Indeed, the filter context of a cell is computed by merging together all the filters coming from rows, columns, slicers, and any other visual used for filtering. For example, look at <a href="#calibre_link-518" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-5</a>.</p>
<figure id="calibre_link-518" class="image-l">
<img src="images/000411.jpg" alt="In this report we see CY 2007 to 2009 as well as totals per brand, along with a slicer by continent and another visual filtering by occupation." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2098"></span><strong class="calibre7">Figure 4-5</strong> In a typical report, the context is defined in many ways, including slicers, filters, and other visuals.</figcaption>
</figure>
<p class="edition">The filter context of the top-left cell (A.Datum, CY 2007, 57,276.00) not only filters the row and the column of the visual, but it also filters the occupation (Professional) and the continent (Europe), which are coming from different visuals. All these filters contribute to the definition of a single filter context valid for one cell, which DAX applies to the whole data model prior to evaluating the formula.</p>
<p class="edition">A more formal definition of a filter context is to say that a filter context is a set of filters. A filter, in turn, is a list of tuples, and a tuple is a set of values for some defined columns. <a href="#calibre_link-519" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-6</a> shows a visual representation of the filter context under which the highlighted cell is evaluated. Each element of the report contributes to creating the filter context, and every cell in the report has a different filter context.</p>
<figure id="calibre_link-519" class="image-l">
<img src="images/000419.jpg" alt="The figure uses symbols, reports, and arrows to describe the filter context." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-6</strong> The figure shows a visual representation of a filter context in a Power BI report.</figcaption>
</figure>
<p class="edition">The filter context of <a href="#calibre_link-519" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-6</a> contains three filters. The first filter contains a tuple for <em class="calibre5">Calendar Year</em> with the value CY 2007. The second filter contains two tuples for <em class="calibre5">Education</em> with the values High School and Partial College. The third filter contains a single tuple for <em class="calibre5">Brand</em>, with the value Contoso. You might <span type="pagebreak" id="calibre_link-2018"></span>notice that each filter contains tuples for one column only. You will learn how to create tuples with multiple columns later. Multi-column tuples are both powerful and complex tools in the hand of a DAX developer.</p>
<p class="edition">Before leaving this introduction, let us recall the measure used at the beginning of this section:</p>
<p class="codelink"><a href="#calibre_link-520" id="calibre_link-2228" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount := SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )</pre></div>
<p class="edition">Here is the correct way of reading the previous measure: <em class="calibre5">The measure computes the sum of Quantity multiplied by Net Price for all the rows in Sales which are visible in the current filter context</em>.</p>
<p class="edition">The same applies to simpler aggregations. For example, consider this measure:</p>
<p class="codelink"><a href="#calibre_link-521" id="calibre_link-2229" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Total Quantity := SUM ( Sales[Quantity] )</pre></div>
<p class="edition">It sums the <em class="calibre5">Quantity</em> column of all the rows in <em class="calibre5">Sales</em> that are visible in the current filter context. You can better understand its working by considering the corresponding <em class="calibre5">SUMX</em> version:</p>
<p class="codelink"><a href="#calibre_link-522" id="calibre_link-2230" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Total Quantity := SUMX ( Sales, Sales[Quantity] )</pre></div>
<p class="edition">Looking at the <em class="calibre5">SUMX</em> definition, we might consider that the filter context affects the evaluation of the <em class="calibre5">Sales</em> expression, which only returns the rows of the <em class="calibre5">Sales</em> table that are visible in the current filter context. This is true, but you should consider that the filter context also applies to the following measures, which do not have a corresponding iterator:</p>
<p class="codelink"><a href="#calibre_link-523" id="calibre_link-2231" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Customers := DISTINCTCOUNT ( Sales[CustomerKey] )  -- Count customers in filter context

Colors :=
VAR ListColors = DISTINCT ( 'Product'[Color] )     -- Unique colors in filter context
RETURN COUNTROWS ( ListColors )                    -- Count unique colors</pre></div>
<p class="edition">It might look pedantic, at this point, to spend so much time stressing the concept that a filter context is always active, and that it affects the formula result. Nevertheless, keep in mind that DAX requires you to be extremely precise. Most of the complexity of DAX is not in learning new functions. Instead, the complexity comes from the presence of many subtle concepts. When these concepts are mixed together, what emerges is a complex scenario. Right now, the filter context is defined by the report. As soon as you learn how to create filter contexts by yourself (a critical skill described in the next chapter), being able to understand which filter context is active in each part of your formula will be of paramount importance.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-83" class="calibre13">Understanding the row context</h4>
<p class="edition">In the previous section, you learned about the filter context. In this section, you now learn the second type of evaluation context: the <em class="calibre5">row context</em>. Remember, although both the row context and the filter context are evaluation contexts, <em class="calibre5">they are not the same concept</em>. As you learned in the previous section, the purpose of the filter context is, as its name implies, to filter tables. On the other hand, the row context is not a tool to filter tables. Instead, it is used to iterate over tables and evaluate column values.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2025"></span>This time we use a different formula for our considerations, defining a calculated column to compute the gross margin:</p>
<p class="codelink"><a href="#calibre_link-524" id="calibre_link-2232" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Gross Margin] = Sales[Quantity] * ( Sales[Net Price] - Sales[Unit Cost] )</pre></div>
<p class="edition">There is a different value for each row in the resulting calculated column, as shown in <a href="#calibre_link-525" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-7</a>.</p>
<figure id="calibre_link-525" class="image-l">
<img src="images/000429.jpg" alt="Here we see several rows with quantity, unit cost, net price, and gross margin on each row." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-7</strong> There is a different value in each row of <em class="calibre5">Gross Margin</em>, depending on the value of other columns.</figcaption>
</figure>
<p class="edition">As expected, for each row of the table there is a different value in the calculated column. Indeed, because there are given values in each row for the three columns used in the expression, it comes as a natural consequence that the final expression computes different values. As it happened with the filter context, the reason is the presence of an evaluation context. This time, the context does not filter a table. Instead, it identifies the row for which the calculation happens.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The row context references a row in the result of a DAX table expression. It should not be confused with a row in the report. DAX does not have a way to directly reference a row or a column in the report. The values displayed in a matrix in Power BI and in a Pivot- Table in Excel are the result of DAX measures computed in a filter context, or are values stored in the table as native or calculated columns.</p>
</div>
<p class="edition">In other words, we know that a calculated column is computed row by row, but how does DAX know which row it is currently iterating? It knows the row because there is another evaluation context providing the row&mdash;it is the <em class="calibre5">row context</em>. When we create a calculated column over a table with one million rows, DAX creates a row context that evaluates the expression iterating over the table row by row, using the row context as the cursor.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1882"></span>When we create a calculated column, DAX creates a row context by default. In that case, there is no need to manually create a row context: A calculated column is always executed in a row context. You have already learned how to create a row context manually&mdash;by starting an iteration. In fact, one can write the gross margin as a measure, like in the following code:</p>
<p class="codelink"><a href="#calibre_link-526" id="calibre_link-2233" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Gross Margin :=
SUMX (
    Sales,
    Sales[Quantity] * ( Sales[Net Price] - Sales[Unit Cost] )
)</pre></div>
<p class="edition">In this case, because the code is for a measure, there is no automatic row context. <em class="calibre5">SUMX</em>, being an iterator, creates a row context that starts iterating over the <em class="calibre5">Sales</em> table, row by row. During the iteration, it executes the second expression of <em class="calibre5">SUMX</em> inside the row context. Thus, during each step of the iteration, DAX knows which value to use for the three column names used in the expression.</p>
<p class="edition">The row context exists when we create a calculated column or when we are computing an expression inside an iteration. There is no other way of creating a row context. Moreover, it helps to think that a row context is needed whenever we want to obtain the value of a column for a certain row. For example, the following measure definition is invalid. Indeed, it tries to compute the value of <em class="calibre5">Sales[Net Price]</em> and there is no row context providing the row for which the calculation needs to be executed:</p>
<p class="codelink"><a href="#calibre_link-527" id="calibre_link-2234" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Gross Margin := Sales[Quantity] * ( Sales[Net Price] - Sales[Unit Cost] )</pre></div>
<p class="edition">This same expression is valid when executed for a calculated column, and it is invalid if used in a measure. The reason is not that measures and calculated columns have different ways of using DAX. The reason is that a calculated column has an automatic row context, whereas a measure does not. If one wants to evaluate an expression row by row inside a measure, one needs to start an iteration to create a row context.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">A column reference requires a row context to return the value of the column from a table. A column reference can be also used as an argument for several DAX functions without a row context. For example, <em class="calibre5">DISTINCT</em> and <em class="calibre5">DISTINCTCOUNT</em> can have a column reference as a parameter, without defining a row context. Nonetheless, a column reference in a DAX expression requires a row context to be evaluated.</p>
</div>
<p class="edition">At this point, we need to repeat one important concept: A row context is not a special kind of filter context that filters one row. The row context is not filtering the model in any way; the row context only indicates to DAX which row to use out of a table. If one wants to apply a filter to the model, the tool to use is the filter context. On the other hand, if the user wants to evaluate an expression row by row, then the row context will do the job.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-84" class="h2a"><span type="pagebreak" id="calibre_link-1822"></span>Testing your understanding of evaluation contexts</h3>
<p class="edition">Before moving on to more complex descriptions about evaluation contexts, it is useful to test your understanding of contexts with a couple of examples. Please do not look at the explanation immediately; stop after the question and try to answer it. Then read the explanation to make sense of it. As a hint, try to remember, while thinking, “<em class="calibre5">The filter context filters</em>; <em class="calibre5">the row context iterates. This means that the row context does not filter, and the filter context does not iterate</em>.”</p>
<section class="calibre4">
<h4 id="calibre_link-85" class="calibre13">Using <em class="calibre5">SUM</em> in a calculated column</h4>
<p class="edition">The first test uses an aggregator inside a calculated column. What is the result of the following expression, used in a calculated column, in <em class="calibre5">Sales</em>?</p>
<p class="codelink"><a href="#calibre_link-528" id="calibre_link-2235" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[SumOfSalesQuantity] = SUM ( Sales[Quantity] )</pre></div>
<p class="edition">Remember, this internally corresponds to this equivalent syntax:</p>
<p class="codelink"><a href="#calibre_link-529" id="calibre_link-2236" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[SumOfSalesQuantity] = SUMX ( Sales, Sales[Quantity] )</pre></div>
<p class="edition">Because it is a calculated column, it is computed row by row in a row context. What number do you expect to see? Choose from these three answers:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The value of <em class="calibre5">Quantity</em> for that row, that is, a different value for each row.</p></li>
<li class="calibre10"><p class="listp">The total of <em class="calibre5">Quantity</em> for all the rows, that is, the same value for all the rows.</p></li>
<li class="calibre10"><p class="listp">An error; we cannot use <em class="calibre5">SUM</em> inside a calculated column.</p></li>
</ul>
<p class="edition">Stop reading, please, while we wait for your educated guess before moving on.</p>
<p class="edition">Here is the correct reasoning. You have learned that the formula means, “<em class="calibre5">the sum of quantity for all the rows visible in the current filter context</em>.” Moreover, because the code is executed for a calculated column, DAX evaluates the formula row by row, in a row context. Nevertheless, the row context is not filtering the table. The only context that can filter the table is the filter context. This turns the question into a different one: What is the filter context, when the formula is evaluated? The answer is straightforward: The filter context is empty. Indeed, the filter context is created by visuals or by queries, and a calculated column is computed at data refresh time when no filtering is happening. Thus, <em class="calibre5">SUM</em> works on the whole <em class="calibre5">Sales</em> table, aggregating the value of <em class="calibre5">Sales[Quantity]</em> for all the rows of <em class="calibre5">Sales</em>.</p>
<p class="edition">The correct answer is the second answer. This calculated column computes the same value for each row, that is, the grand total of <em class="calibre5">Sales[Quantity]</em> repeated for all the rows. <a href="#calibre_link-530" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-8</a> shows the result of the <em class="calibre5">SumOfSalesQuantity</em> calculated column.</p>
<figure id="calibre_link-530" class="image-l">
<img src="images/000437.jpg" alt="This figure shows quantity, unit cost, net price, and SumOfSalesQuantity over many rows." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1823"></span><strong class="calibre7">Figure 4-8</strong> <em class="calibre5">SUM ( Sales[Quantity] )</em>, in a calculated column, is computed against the entire database.</figcaption>
</figure>
<p class="edition">This example shows that the two evaluation contexts exist at the same time, but they do not interact. The evaluation contexts both work on the result of a formula, but they do so in different ways. Aggregators like <em class="calibre5">SUM</em>, <em class="calibre5">MIN</em>, and <em class="calibre5">MAX</em> only use the filter context, and they ignore the row context. If you have chosen the first answer, as many students typically do, it is perfectly normal. The thing is that you are still confusing the filter context and the row context. Remember, the filter context filters; the row context iterates. The first answer is the most common, when using intuitive logic, but it is wrong&mdash;now you know why. However, if you chose the correct answer ... then we are glad this section helped you in learning the important difference between the two contexts.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-86" class="calibre13">Using columns in a measure</h4>
<p class="edition">The second test is slightly different. Imagine we define the formula for the gross margin in a measure instead of in a calculated column. We have a column with the net price, another column for the product cost, and we write the following expression:</p>
<p class="codelink"><a href="#calibre_link-531" id="calibre_link-2237" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">GrossMargin% := ( Sales[Net Price] - Sales[Unit Cost] ) / Sales[Unit Cost]</pre></div>
<p class="edition">What will the result be? As it happened earlier, choose among the three possible answers:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The expression works correctly, time to test the result in a report.</p></li>
<li class="calibre10"><p class="listp">An error, we should not even write this formula.</p></li>
<li class="calibre10"><p class="listp">We can define the formula, but it will return an error when used in a report.</p></li>
</ul>
<p class="edition">As in the previous test, stop reading, think about the answer, and then read the following explanation.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1881"></span>The code references <em class="calibre5">Sales[Net Price]</em> and <em class="calibre5">Sales[Unit Cost]</em> without any aggregator. As such, DAX needs to retrieve the value of the columns for a certain row. DAX has no way of detecting which row the formula needs to be computed for because there is no iteration happening and the code is not in a calculated column. In other words, DAX is missing a row context that would make it possible to retrieve a value for the columns that are part of the expression. Remember that a measure does not have an automatic row context; only calculated columns do. If we need a row context in a measure, we should start an iteration.</p>
<p class="edition">Thus, the second answer is the correct one. We cannot write the formula because it is syntactically wrong, and we get an error when trying to enter the code.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-87" class="h2a">Using the row context with iterators</h3>
<p class="edition">You learned that DAX creates a row context whenever we define a calculated column or when we start an iteration with an X-function. When we use a calculated column, the presence of the row context is simple to use and understand. In fact, we can create simple calculated columns without even knowing about the presence of the row context. The reason is that the row context is created automatically by the engine. Therefore, we do not need to worry about the presence of the row context. On the other hand, when using iterators we are responsible for the creation and the handling of the row context. Moreover, by using iterators we can create multiple nested row contexts; this increases the complexity of the code. Therefore, it is important to understand more precisely the behavior of row contexts with iterators.</p>
<p class="edition">For example, look at the following DAX measure:</p>
<p class="codelink"><a href="#calibre_link-532" id="calibre_link-2238" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">IncreasedSales := SUMX ( Sales, Sales[Net Price] * 1.1 )</pre></div>
<p class="edition">Because <em class="calibre5">SUMX</em> is an iterator, <em class="calibre5">SUMX</em> creates a row context on the <em class="calibre5">Sales</em> table and uses it during the iteration. The row context iterates the <em class="calibre5">Sales</em> table (first parameter) and provides the current row to the second parameter during the iteration. In other words, DAX evaluates the inner expression (the second parameter of <em class="calibre5">SUMX</em>) in a row context containing the currently iterated row on the first parameter.</p>
<p class="edition">Please note that the two parameters of <em class="calibre5">SUMX</em> use different contexts. In fact, any piece of DAX code works in the context where it is called. Thus, when the expression is executed, there might already be a filter context and one or many row contexts active. Look at the same expression with comments:</p>
<p class="codelink"><a href="#calibre_link-533" id="calibre_link-2239" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SUMX (
    Sales,                     -- External filter and row contexts
    Sales[Net Price] * 1.1     -- External filter and row contexts + new row context
)</pre></div>
<p class="edition">The first parameter, <em class="calibre5">Sales</em>, is evaluated using the contexts coming from the caller. The second parameter (the expression) is evaluated using both the external contexts plus the newly created row context.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2024"></span>All iterators behave the same way:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">Evaluate the first parameter in the existing contexts to determine the rows to scan.</p></li>
<li class="calibre25"><p class="listp">Create a new row context for each row of the table evaluated in the previous step.</p></li>
<li class="calibre25"><p class="listp">Iterate the table and evaluate the second parameter in the existing evaluation context, including the newly created row context.</p></li>
<li class="calibre25"><p class="listp">Aggregate the values computed during the previous step.</p></li>
</ol>
<p class="edition">Be mindful that the original contexts are still valid inside the expression. Iterators add a new row context; they do not modify existing filter contexts. For example, if the outer filter context contains a filter for the color Red, that filter is still active during the whole iteration. Besides, remember that the row context iterates; it does not filter. Therefore, no matter what, we cannot override the outer filter context using an iterator.</p>
<p class="edition">This rule is always valid, but there is an important detail that is not trivial. If the previous contexts already contained a row context for the same table, then the newly created row context hides the previous existing row context on the same table. For DAX newbies, this is a possible source of mistakes. Therefore, we discuss row context hiding in more detail in the next two sections.</p>
<section class="calibre4">
<h4 id="calibre_link-88" class="calibre13">Nested row contexts on different tables</h4>
<p class="edition">The expression evaluated by an iterator can be very complex. Moreover, the expression can, on its own, contain further iterations. At first sight, starting an iteration inside another iteration might look strange. Still, it is a common DAX practice because nesting iterators produce powerful expressions.</p>
<p class="edition">For example, the following code contains three nested iterators, and it scans three tables: <em class="calibre5">Categories, Products</em>, and <em class="calibre5">Sales</em>.</p>
<p class="codelink"><a href="#calibre_link-534" id="calibre_link-2240" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SUMX (
    'Product Category',                   -- Scans the Product Category table
    SUMX (                                -- For each category
        RELATEDTABLE ( 'Product' ),       -- Scans the category products
        SUMX (                            -- For each product
            RELATEDTABLE ( Sales )        -- Scans the sales of that product
            Sales[Quantity]               --
                * 'Product'[Unit Price]   -- Computes the sales amount of that sale
                * 'Product Category'[Discount]
        )
    )
)</pre></div>
<p class="edition">The innermost expression&mdash;the multiplication of three factors&mdash;references three tables. In fact, three row contexts are opened during that expression evaluation: one for each of the three tables that are currently being iterated. It is also worth noting that the two <em class="calibre5">RELATEDTABLE</em> functions return the rows of a related table starting from the current row context. Thus, <em class="calibre5">RELATEDTABLE ( Product)</em>, being <span type="pagebreak" id="calibre_link-1911"></span>executed in a row context from the Categories table, returns the products of the given category. The same reasoning applies to <em class="calibre5">RELATEDTABLE ( Sales )</em>, which returns the sales of the given product.</p>
<p class="edition">The previous code is suboptimal in terms of both performance and readability. As a rule, it is fine to nest iterators provided that the number of rows to scan is not too large: hundreds is good, thousands is fine, millions is bad. Otherwise, we may easily hit performance issues. We used the previous code to demonstrate that it is possible to create multiple nested row contexts; we will see more useful examples of nested iterators later in the book. One can express the same calculation in a much faster and readable way by using the following code, which relies on one individual row context and the <em class="calibre5">RELATED</em> function:</p>
<p class="codelink"><a href="#calibre_link-535" id="calibre_link-2241" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SUMX (
    Sales,
    Sales[Quantity]
        * RELATED ( 'Product'[Unit Price] )
        * RELATED ( 'Product Category'[Discount] )
)</pre></div>
<p class="edition">Whenever there are multiple row contexts on different tables, one can use them to reference the iterated tables in a single DAX expression. There is one scenario, however, which proves to be challenging. This happens when we nest multiple row contexts on the same table, which is the topic covered in the following section.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-89" class="calibre13">Nested row contexts on the same table</h4>
<p class="edition">The scenario of having nested row contexts on the same table might seem rare. However, it does happen quite often, and more frequently in calculated columns. Imagine we want to rank products based on the list price. The most expensive product should be ranked 1, the second most expensive product should be ranked 2, and so on. We could solve the scenario using the <em class="calibre5">RANKX</em> function. But for educational purposes, we show how to solve it using simpler DAX functions.</p>
<p class="edition">To compute the ranking, for each product we can count the number of products whose price is higher than the current product’s. If there is no product with a higher price than the current product price, then the current product is the most expensive and its ranking is 1. If there is only one product with a higher price, then the ranking is 2. In fact, what we are doing is computing the ranking of a product by counting the number of products with a higher price and adding 1 to the result.</p>
<p class="edition">Therefore, one can author a calculated column using this code, where we used <strong class="calibre7">PriceOfCurrentProduct</strong> as a placeholder to indicate the price of the current product.</p>
<p class="codelink"><a href="#calibre_link-536" id="calibre_link-2242" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">1.  'Product'[UnitPriceRank] =
2.  COUNTROWS (
3.      FILTER (
4.          'Product',
5.          'Product'[Unit Price] &gt; <strong class="calibre7">PriceOfCurrentProduct</strong>
6.      )
7.  ) + 1</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2019"></span><em class="calibre5">FILTER</em> returns the products with a price higher than the current products’ price, and <em class="calibre5">COUNTROWS</em> counts the rows of the result of <em class="calibre5">FILTER</em>. The only remaining issue is finding a way to express the price of the current product, replacing <strong class="calibre7">PriceOfCurrentProduct</strong> with a valid DAX syntax. By “current,” we mean the value of the column in the current row when DAX computes the column. It is harder than you might expect.</p>
<p class="edition">Focus your attention on line 5 of the previous code. There, the reference to <em class="calibre5">Product[Unit Price]</em> refers to the value of <em class="calibre5">Unit Price</em> in the current row context. What is the active row context when DAX executes row number 5? There are two row contexts. Because the code is written in a calculated column, there is a default row context automatically created by the engine that scans the <em class="calibre5">Product</em> table. Moreover, <em class="calibre5">FILTER</em> being an iterator, there is the row context generated by <em class="calibre5">FILTER</em> that scans the product table again. This is shown graphically in <a href="#calibre_link-537" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-9</a>.</p>
<figure id="calibre_link-537" class="image-l">
<img src="images/000444.jpg" alt="The figure helps the reader identify each row context." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-9</strong> During the evaluation of the innermost expression, there are two row contexts on the same table.</figcaption>
</figure>
<p class="edition">The outer box includes the row context of the calculated column, which is iterating over <em class="calibre5">Product</em>. However, the inner box shows the row context of the <em class="calibre5">FILTER</em> function, which is iterating over <em class="calibre5">Product</em> too. The expression <em class="calibre5">Product[Unit Price]</em> depends on the context. Therefore, a reference to <em class="calibre5">Product[Unit Price]</em> in the inner box can only refer to the currently iterated row by <em class="calibre5">FILTER</em>. The problem is that, in that box, we need to evaluate the value of <em class="calibre5">Unit Price</em> that is referenced by the row context of the calculated column, which is now hidden.</p>
<p class="edition">Indeed, when one does not create a new row context using an iterator, the value of <em class="calibre5">Product[Unit Price]</em> is the desired value, which is the value in the current row context of the calculated column, as in this simple piece of code:</p>
<p class="codelink"><a href="#calibre_link-538" id="calibre_link-2243" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Product[Test] = Product[Unit Price]</pre></div>
<p class="edition">To further demonstrate this, let us evaluate <em class="calibre5">Product[Unit Price]</em> in the two boxes, with some dummy code. What comes out are different results as shown in <a href="#calibre_link-539" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-10</a>, where we added the evaluation of <em class="calibre5">Product[Unit Price]</em> right before <em class="calibre5">COUNTROWS</em>, only for educational purposes.</p>
<figure id="calibre_link-539" class="image-l">
<img src="images/000451.jpg" alt="The figure breaks down the different parts of the measure." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2020"></span><strong class="calibre7">Figure 4-10</strong> Outside of the iteration, <em class="calibre5">Product[Unit Price]</em> refers to the row context of the calculated column.</figcaption>
</figure>
<p class="edition">Here is a recap of the scenario so far:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The inner row context, generated by <em class="calibre5">FILTER</em>, hides the outer row context.</p></li>
<li class="calibre10"><p class="listp">We need to compare the inner <em class="calibre5">Product[Unit Price]</em> with the value of the outer <em class="calibre5">Product[Unit Price]</em>.</p></li>
<li class="calibre10"><p class="listp">If we write the comparison in the inner expression, we are unable to access the outer <em class="calibre5">Product[Unit Price]</em>.</p></li>
</ul>
<p class="edition">Because we can retrieve the current unit price, if we evaluate it outside of the row context of <em class="calibre5">FILTER</em>, the best approach to this problem is saving the value of the <em class="calibre5">Product[Unit Price]</em> inside a variable. Indeed, one can evaluate the variable in the row context of the calculated column using this code:</p>
<p class="codelink"><a href="#calibre_link-540" id="calibre_link-2244" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[UnitPriceRank] =
VAR
    PriceOfCurrentProduct = 'Product'[Unit Price]
RETURN
    COUNTROWS (
        FILTER (
           'Product',
           'Product'[Unit Price] &gt; PriceOfCurrentProduct
        )
    ) + 1</pre></div>
<p class="edition">Moreover, it is even better to write the code in a more descriptive way by using more variables to separate the different steps of the calculation. This way, the code is also easier to follow:</p>
<p class="codelink"><a href="#calibre_link-541" id="calibre_link-2245" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[UnitPriceRank] =
VAR PriceOfCurrentProduct = 'Product'[Unit Price]
VAR MoreExpensiveProducts =
    FILTER (
        'Product',
        'Product'[Unit Price] &gt; PriceOfCurrentProduct
    )
RETURN
    COUNTROWS ( MoreExpensiveProducts ) + 1</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1912"></span><a href="#calibre_link-542" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-11</a> shows a graphical representation of the row contexts of this latter formulation of the code, which makes it easier to understand which row context DAX computes each part of the formula in.</p>
<figure id="calibre_link-542" class="image-l">
<img src="images/000458.jpg" alt="The figure shows the row contexts." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-11</strong> The value of <em class="calibre5">PriceOfCurrentProduct</em> is evaluated in the outer row context.</figcaption>
</figure>
<p class="edition"><a href="#calibre_link-543" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-12</a> shows the result of this calculated column.</p>
<figure id="calibre_link-543" class="image-l">
<img src="images/000465.jpg" alt="Here we see unit price and UnitPriceRank per Product Name." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-12</strong> <em class="calibre5">UnitPriceRank</em> is a useful example of how to use variables to navigate within nested row contexts.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-2990"></span>Because there are 14 products with the same unit price, their rank is always 1; the fifteenth product has a rank of 15, shared with other products with the same price. It would be great if we could rank 1, 2, 3 instead of 1, 15, 19 as is the case in the figure. We will fix this soon but, before that, it is important to make a small digression.</p>
<p class="edition">To solve a scenario like the one proposed, it is necessary to have a solid understanding of what a row context is, to be able to detect which row context is active in different parts of the formula and, most importantly, to conceive how the row context affects the value returned by a DAX expression. It is worth stressing that the same expression <em class="calibre5">Product[Unit Price]</em>, evaluated in two different parts of the formula, returns different values because of the different contexts under which it is evaluated. When one does not have a solid understanding of evaluation contexts, it is extremely hard to work on such complex code.</p>
<p class="edition">As you have seen, a simple ranking expression with two row contexts proves to be a challenge. Later in <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a> you learn how to create multiple filter contexts. At that point, the complexity of the code increases a lot. However, if you understand evaluation contexts, these scenarios are simple. Before moving to the next level in DAX, you need to understand evaluation contexts well. This is the reason why we urge you to read this whole section again&mdash;and maybe the whole chapter so far&mdash;until these concepts are crystal clear. It will make reading the next chapters much easier and your learning experience much smoother.</p>
<p class="edition">Before leaving this example, we need to solve the last detail&mdash;that is, ranking using a sequence of 1, 2, 3 instead of the sequence obtained so far. The solution is easier than expected. In fact, in the previous code we focused on counting the products with a higher price. By doing that, the formula counted 14 products ranked 1 and assigned 15 to the second ranking level. However, counting products is not very useful. If the formula counted the prices higher than the current price, rather than the products, then all 14 products would be collapsed into a single price.</p>
<p class="codelink"><a href="#calibre_link-544" id="calibre_link-2246" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[UnitPriceRankDense] =
VAR PriceOfCurrentProduct = 'Product'[Unit Price]
VAR HigherPrices =
    FILTER (
        VALUES ( 'Product'[Unit Price] ),
        'Product'[Unit Price] &gt; PriceOfCurrentProduct
    )
RETURN
    COUNTROWS ( HigherPrices ) + 1</pre></div>
<p class="edition"><a href="#calibre_link-545" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-13</a> shows the new calculated column, along with <em class="calibre5">UnitPriceRank</em>.</p>
<figure id="calibre_link-545" class="image-l">
<img src="images/000473.jpg" alt="The figure shows Unit Price, UnitPriceRank, and UnitPriceRankDense per Product Name." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2008"></span><strong class="calibre7">Figure 4-13</strong> <em class="calibre5">UnitPriceRankDense</em> returns a more useful ranking because it counts prices, not products.</figcaption>
</figure>
<p class="edition">This final small step is counting prices instead of counting products, and it might seem harder than expected. The more you work with DAX, the easier it will become to start thinking in terms of ad hoc temporary tables created for the purpose of a calculation.</p>
<p class="edition">In this example you learned that the best technique to handle multiple row contexts on the same table is by using variables. Keep in mind that variables were introduced in the DAX language as late as 2015. You might find existing DAX code&mdash;written before the age of variables&mdash;that uses another technique to access outer row contexts: the <em class="calibre5">EARLIER</em> function, which we describe in the next section.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-90" class="calibre13">Using the <em class="calibre5">EARLIER</em> function</h4>
<p class="edition">DAX provides a function that accesses the outer row contexts: <em class="calibre5">EARLIER</em>. <em class="calibre5">EARLIER</em> retrieves the value of a column by using the previous row context instead of the last one. Therefore, we can express the value of <strong class="calibre7">PriceOfCurrentProduct</strong> using <em class="calibre5">EARLIER ( Product[UnitPrice] )</em>.</p>
<p class="edition">Many DAX newbies feel intimidated by <em class="calibre5">EARLIER</em> because they do not understand row contexts well enough and they do not realize that they can nest row contexts by creating multiple iterations over the <span type="pagebreak" id="calibre_link-2009"></span>same table. <em class="calibre5">EARLIER</em> is a simple function, once you understand the concept of row context and nesting. For example, the following code solves the previous scenario without using variables:</p>
<p class="codelink"><a href="#calibre_link-546" id="calibre_link-2247" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[UnitPriceRankDense] =
COUNTROWS (
    FILTER (
        VALUES ( 'Product'[Unit Price] ),
        'Product'[UnitPrice] &gt; EARLIER ( 'Product'[UnitPrice] )
    )
) + 1</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition"><em class="calibre5">EARLIER</em> accepts a second parameter, which is the number of steps to skip, so that one can skip two or more row contexts. Moreover, there is also a function named <em class="calibre5">EARLIEST</em> that lets a developer access the outermost row context defined for a table. In the real world, neither <em class="calibre5">EARLIEST</em> nor the second parameter of <em class="calibre5">EARLIER</em> is used often. Though having two nested row contexts is a common scenario in calculated columns, having three or more of them is something that rarely happens. Besides, since the advent of variables, <em class="calibre5">EARLIER</em> has virtually become useless because variable usage superseded <em class="calibre5">EARLIER</em>.</p>
</div>
<p class="edition">The only reason to learn <em class="calibre5">EARLIER</em> is to be able to read existing DAX code. There are no further reasons to use <em class="calibre5">EARLIER</em> in newer DAX code because variables are a better way to save the required value when the right row context is accessible. Using variables for this purpose is a best practice and results in more readable code.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-91" class="h2a">Understanding <em class="calibre5">FILTER</em>, <em class="calibre5">ALL</em>, and context interactions</h3>
<p class="edition">In the preceding examples, we used <em class="calibre5">FILTER</em> as a convenient way of filtering a table. <em class="calibre5">FILTER</em> is a common function to use whenever one wants to apply a filter that further restricts the existing filter context.</p>
<p class="edition">Imagine that we want to create a measure that counts the number of red products. With the knowledge gained so far, the formula is easy:</p>
<p class="codelink"><a href="#calibre_link-547" id="calibre_link-2248" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NumOfRedProducts :=
VAR RedProducts =
    FILTER (
        'Product',
        'Product'[Color] = "Red"
    )
RETURN
    COUNTROWS ( RedProducts )</pre></div>
<p class="edition">We can use this formula inside a report. For example, put the product brand on the rows to produce the report shown in <a href="#calibre_link-548" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-14</a>.</p>
<figure id="calibre_link-548" class="image-l">
<img src="images/000480.jpg" alt="This report displays NumOfRedProducts per Brand." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2991"></span><strong class="calibre7">Figure 4-14</strong> We can count the number of red products using the <em class="calibre5">FILTER</em> function.</figcaption>
</figure>
<p class="edition">Before moving on with this example, stop for a moment and think carefully about how DAX computed these values. <em class="calibre5">Brand</em> is a column of the <em class="calibre5">Product</em> table. Inside each cell of the report, the filter context filters one given brand. Therefore, each cell shows the number of products of the given brand that are also red. The reason for this is that <em class="calibre5">FILTER</em> iterates the <em class="calibre5">Product</em> table as it is visible in the current filter context, which only contains products with that specific brand. It might seem trivial, but it is better to repeat this a few times than there being a chance of forgetting it.</p>
<p class="edition">This is more evident if we add a slicer to the report filtering the color. In <a href="#calibre_link-549" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-15</a> there are two identical reports with two slicers filtering color, where each slicer only filters the report on its immediate right. The report on the left filters Red and the numbers are the same as in <a href="#calibre_link-548" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-14</a>, whereas the report on the right is empty because the slicer is filtering Azure.</p>
<figure id="calibre_link-549" class="image-l">
<img src="images/000488.jpg" alt="There are two reports. On the left side, we see values for NumOfRedProducts for each product and the slicer focuses on Red. On the right side, the slicer focuses on Azure and the report is empty." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-15</strong> DAX evaluates <em class="calibre5">NumOfRedProducts</em> taking into account the outer context defined by the slicer.</figcaption>
</figure>
<p class="edition">In the report on the right, the <em class="calibre5">Product</em> table iterated by <em class="calibre5">FILTER</em> only contains Azure products, and, because <em class="calibre5">FILTER</em> can only return Red products, there are no products to return. As a result, the <em class="calibre5">NumOfRedProducts</em> measure always evaluates to blank.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1688"></span>The important part of this example is the fact that in the same formula, there are both a filter context coming from the outside&mdash;the cell in the report, which is affected by the slicer selection&mdash;and a row context introduced in the formula by the <em class="calibre5">FILTER</em> function. Both contexts work at the same time and modify the result. DAX uses the filter context to evaluate the <em class="calibre5">Product</em> table, and the row context to evaluate the filter condition row by row during the iteration made by <em class="calibre5">FILTER</em>.</p>
<p class="edition">We want to repeat this concept again: <em class="calibre5">FILTER</em> does not change the filter context. <em class="calibre5">FILTER</em> is an iterator that scans a table (already filtered by the filter context) and it returns a subset of that table, according to the filtering condition. In <a href="#calibre_link-548" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-14</a>, the filter context is filtering the brand and, after <em class="calibre5">FILTER</em> returned the result, it still only filtered the brand. Once we added the slicer on the color in <a href="#calibre_link-549" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-15</a>, the filter context contained both the brand and the color. For this reason, in the left-hand side report <em class="calibre5">FILTER</em> returned all the products iterated, and in the right-hand side report it did not return any product. In both reports, <em class="calibre5">FILTER</em> did not change the filter context. <em class="calibre5">FILTER</em> only scanned a table and returned a filtered result.</p>
<p class="edition">At this point, one might want to define another formula that returns the number of red products regardless of the selection done on the slicer. In other words, the code needs to ignore the selection made on the slicer and must always return the number of all the red products.</p>
<p class="edition">To accomplish this, the <em class="calibre5">ALL</em> function comes in handy. <em class="calibre5">ALL</em> returns the content of a table <em class="calibre5">ignoring the filter context</em>. We can define a new measure, named <em class="calibre5">NumOfAllRedProducts</em>, by using this expression:</p>
<p class="codelink"><a href="#calibre_link-550" id="calibre_link-2249" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NumOfAllRedProducts :=
VAR AllRedProducts =
    FILTER (
        <strong class="calibre7">ALL ( 'Product' ),</strong>
        'Product'[Color] = "Red"
    )
RETURN
    COUNTROWS ( AllRedProducts )</pre></div>
<p class="edition">This time, <em class="calibre5">FILTER</em> does not iterate <em class="calibre5">Product</em>. Instead, it iterates <em class="calibre5">ALL ( Product )</em>.</p>
<p class="edition"><em class="calibre5">ALL</em> ignores the filter context and always returns all the rows of the table, so that <em class="calibre5">FILTER</em> returns the red products even if products were previously filtered by another brand or color.</p>
<p class="edition">The result shown in <a href="#calibre_link-551" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-16</a>&mdash;although correct&mdash;might be surprising.</p>
<figure id="calibre_link-551" class="image-l">
<img src="images/000495.jpg" alt="Similarly, the report on the left focuses on red, and the report on the right focuses on azure. This time there is a value under NumOfAllRedProducts on the right side." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-16</strong> <em class="calibre5">NumOfAllRedProducts</em> returns strange results.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1689"></span>There are a couple of interesting things to note here, and we want to describe both in more detail:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The result is always 99, regardless of the brand selected on the rows.</p></li>
<li class="calibre10"><p class="listp">The brands in the left matrix are different from the brands in the right matrix.</p></li>
</ul>
<p class="edition">First, 99 is the total number of red products, not the number of red products of any given brand. <em class="calibre5">ALL</em>&mdash;as expected&mdash;ignores the filters on the <em class="calibre5">Product</em> table. It not only ignores the filter on the color, but it also ignores the filter on the brand. This might be an undesired effect. Nonetheless, <em class="calibre5">ALL</em> is easy and powerful, but it is an all-or-nothing function. If used, <em class="calibre5">ALL</em> ignores all the filters applied to the table specified as its argument. With the knowledge you have gained so far, you cannot yet choose to only ignore part of the filter. In the example, it would have been better to only ignore the filter on the color. Only after the next chapter, with the introduction of <em class="calibre5">CALCULATE</em>, will you have better options to achieve the selective ignoring of filters.</p>
<p class="edition">Let us now describe the second point: The brands on the two reports are different. Because the slicer is filtering one color, the full matrix is computed with the filter on the color. On the left the color is Red, whereas on the right the color is Azure. This determines two different sets of products, and consequently, of brands. The list of brands used to populate the axis of the report is computed in the original filter context, which contains a filter on color. Once the axes have been computed, then DAX computes values for the measure, always returning 99 as a result regardless of the brand and color. Thus, the report on the left shows the brands of red products, whereas the report on the right shows the brands of azure products, although in both reports the measure shows the total of all the red products, regardless of their brand.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The behavior of the report is not specific to DAX, but rather to the <em class="calibre5">SUMMARIZECOLUMNS</em> function used by Power BI. We cover <em class="calibre5">SUMMARIZECOLUMNS</em> in <a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 13</a>, “<a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Authoring queries</a>.”</p>
</div>
<p class="edition">We do not want to further explore this scenario right now. The solution comes later when you learn <em class="calibre5">CALCULATE</em>, which offers a lot more power (and complexity) for the handling of filter contexts. As of now, we used this example to show that you might find unexpected results from relatively simple formulas because of context interactions and the coexistence, in the same expression, of filter and row contexts.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-92" class="h2a">Working with several tables</h3>
<p class="edition">Now that you have learned the basics of evaluation contexts, we can describe how the context behaves when it comes to relationships. In fact, few data models contain just one single table. There would most likely be several tables, linked by relationships. If there is a relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em>, does a filter context on <em class="calibre5">Product</em> filter <em class="calibre5">Sales</em>, too? And what about a filter on <em class="calibre5">Sales</em>, is it filtering <em class="calibre5">Product</em>? Because there are two types of evaluation contexts (the row context and the filter context) and relationships have two sides (a one-side and a many-side), there are four different scenarios to analyze.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2021"></span>The answer to these questions is already found in the mantra you are learning in this chapter, “<em class="calibre5">The filter context filters; the row context iterates”</em> and in its consequence, “<em class="calibre5">The filter context does not iterate; the row context does not filter</em>.”</p>
<p class="edition">To examine the scenario, we use a data model containing six tables, as shown in <a href="#calibre_link-552" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-17</a>.</p>
<figure id="calibre_link-552" class="image-l">
<img src="images/000502.jpg" alt="The figure shows a data model with relationships." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-17</strong> Data model used to learn the interaction between contexts and relationships.</figcaption>
</figure>
<p class="edition">The model presents a couple of noteworthy details:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">There is a chain of relationships starting from <em class="calibre5">Sales</em> and reaching <em class="calibre5">Product Category</em>, through <em class="calibre5">Product</em> and <em class="calibre5">Product Subcategory</em>.</p></li>
<li class="calibre10"><p class="listp">The only bidirectional relationship is between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em>. All remaining relationships are set to be single cross-filter direction.</p></li>
</ul>
<p class="edition">This model is going to be useful when looking at the details of evaluation contexts and relationships in the next sections.</p>
<section class="calibre4">
<h4 id="calibre_link-93" class="calibre13">Row contexts and relationships</h4>
<p class="edition"><em class="calibre5">The row context iterates; it does not filter</em>. Iteration is the process of scanning a table row by row and of performing an operation in the meantime. Usually, one wants some kind of aggregation like sum or average. During an iteration, the row context is iterating an individual table, and it provides a value to <span type="pagebreak" id="calibre_link-2023"></span>all the columns of the table, and only that table. Other tables, although related to the iterated table, do not have a row context on them. In other words, the row context does not interact automatically with relationships.</p>
<p class="edition">Consider as an example a calculated column in the <em class="calibre5">Sales</em> table containing the difference between the unit price stored in the fact table and the unit price stored in the <em class="calibre5">Product</em> table. The following DAX code does not work because it uses the <em class="calibre5">Product[UnitPrice]</em> column and there is no row context on <em class="calibre5">Product</em>:</p>
<p class="codelink"><a href="#calibre_link-553" id="calibre_link-2250" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[UnitPriceVariance] = Sales[Unit Price] - 'Product'[Unit Price]</pre></div>
<p class="edition">This being a calculated column, DAX automatically generates a row context on the table containing the column, which is the <em class="calibre5">Sales</em> table. The row context on <em class="calibre5">Sales</em> provides a row-by-row evaluation of expressions using the columns in <em class="calibre5">Sales</em>. Even though <em class="calibre5">Product</em> is on the one-side of a one-to-many relationship with <em class="calibre5">Sales</em>, the iteration is happening on the <em class="calibre5">Sales</em> table only.</p>
<p class="edition">When we are iterating on the many-side of a relationship, we can access columns on the one-side of the relationship, but we must use the <em class="calibre5">RELATED</em> function. <em class="calibre5">RELATED</em> accepts a column reference as the parameter and retrieves the value of the column in the corresponding row in the target table. <em class="calibre5">RELATED</em> can only reference one column and multiple <em class="calibre5">RELATED</em> functions are required to access more than one column on the one-side of the relationship. The correct version of the previous code is the following:</p>
<p class="codelink"><a href="#calibre_link-554" id="calibre_link-2251" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[UnitPriceVariance] = Sales[Unit Price] - <strong class="calibre7">RELATED</strong> ( 'Product'[Unit Price] )</pre></div>
<p class="edition"><em class="calibre5">RELATED</em> requires a row context (that is, an iteration) on the table on the many-side of a relationship. If the row context were active on the one-side of a relationship, then <em class="calibre5">RELATED</em> would no longer be useful because <em class="calibre5">RELATED</em> would find multiple rows by following the relationship. In this case, that is, when iterating the one-side of a relationship, the function to use is <em class="calibre5">RELATEDTABLE</em>. <em class="calibre5">RELATEDTABLE</em> returns all the rows of the table on the many-side that are related with the currently iterated table. For example, if one wants to compute the number of sales of each product, the following formula defined as a calculated column on Product solves the problem:</p>
<p class="codelink"><a href="#calibre_link-555" id="calibre_link-2252" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Product[NumberOfSales] =
VAR SalesOfCurrentProduct = RELATEDTABLE ( Sales )
RETURN
    COUNTROWS ( SalesOfCurrentProduct )</pre></div>
<p class="edition">This expression counts the number of rows in the <em class="calibre5">Sales</em> table that corresponds to the current product. The result is visible in <a href="#calibre_link-556" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-18</a>.</p>
<figure id="calibre_link-556" class="image-l">
<img src="images/000509.jpg" alt="This report shows NumberOfSales per Product Name." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2992"></span><strong class="calibre7">Figure 4-18</strong> <em class="calibre5">RELATEDTABLE</em> is useful in a row context on the one-side of the relationship.</figcaption>
</figure>
<p class="edition">Both <em class="calibre5">RELATED</em> and <em class="calibre5">RELATEDTABLE</em> can traverse a chain of relationships; they are not limited to a single hop. For example, one can create a column with the same code as before but, this time, in the <em class="calibre5">Product Category</em> table:</p>
<p class="codelink"><a href="#calibre_link-557" id="calibre_link-2253" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product Category'[NumberOfSales] =
VAR SalesOfCurrentProductCategory = RELATEDTABLE ( Sales )
RETURN
    COUNTROWS ( SalesOfCurrentProductCategory )</pre></div>
<p class="edition">The result is the number of sales for the category, which traverses the chain of relationships from <em class="calibre5">Product Category</em> to <em class="calibre5">Product Subcategory</em>, then to <em class="calibre5">Product</em> to finally reach the <em class="calibre5">Sales</em> table.</p>
<p class="edition">In a similar way, one can create a calculated column in the <em class="calibre5">Product</em> table that copies the category name from the <em class="calibre5">Product Category</em> table.</p>
<p class="codelink"><a href="#calibre_link-558" id="calibre_link-2254" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[Category] = RELATED ( 'Product Category'[Category] )</pre></div>
<p class="edition">In this case, a single <em class="calibre5">RELATED</em> function traverses the chain of relationships from <em class="calibre5">Product</em> to <em class="calibre5">Product Subcategory</em> to <em class="calibre5">Product Category</em>.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The only exception to the general rule of <em class="calibre5">RELATED</em> and <em class="calibre5">RELATEDTABLE</em> is for oneto- one relationships. If two tables share a one-to-one relationship, then both <em class="calibre5">RELATED</em> and <em class="calibre5">RELATEDTABLE</em> work in both tables and they result either in a column value or in a table with a single row, depending on the function used.</p>
</div>
<p class="edition">Regarding chains of relationships, all the relationships need to be of the same type&mdash;that is, one-to-many or many-to-one. If the chain links two tables through a one-to-many relationship to a bridge table, followed by a many-to-one relationship to the second table, then neither <em class="calibre5">RELATED</em> nor <em class="calibre5">RELATEDTABLE</em> works with single-direction filter propagation. Only <em class="calibre5">RELATEDTABLE</em> can work using bidirectional <span type="pagebreak" id="calibre_link-2022"></span>filter propagation, as explained later. On the other hand, a one-to-one relationship behaves as a one-to-many and as a many-to-one relationship at the same time. Thus, there can be a one-to-one relationship in a chain of one-to-many (or many-to-one) without interrupting the chain.</p>
<p class="edition">For example, in the model we chose as a reference, <em class="calibre5">Customer</em> is related to <em class="calibre5">Sales</em> and <em class="calibre5">Sales</em> is related to <em class="calibre5">Produc</em>t. There is a one-to-many relationship between <em class="calibre5">Customer</em> and <em class="calibre5">Sales</em>, and then a many-to-one relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em>. Thus, a chain of relationships links <em class="calibre5">Customer</em> to <em class="calibre5">Product</em>. However, the two relationships are not in the same direction. This scenario is known as a many-to-many relationship. A customer is related to many products bought and a product is in turn related to many customers who bought that product. We cover many-to-many relationships later in <a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 15</a>, “<a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Advanced relationships</a>”; let us focus on row context, for the moment. If one uses <em class="calibre5">RELATEDTABLE</em> through a many-to-many relationship, the result would be wrong. Consider a calculated column in <em class="calibre5">Product</em> with this formula:</p>
<p class="codelink"><a href="#calibre_link-559" id="calibre_link-2255" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Product[NumOfBuyingCustomers] =
VAR CustomersOfCurrentProduct = RELATEDTABLE ( Customer )
RETURN
    COUNTROWS ( CustomersOfCurrentProduct )</pre></div>
<p class="edition">The result of the previous code is not the number of customers who bought that product. Instead, the result is the total number of customers, as shown in <a href="#calibre_link-560" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-19</a>.</p>
<figure id="calibre_link-560" class="image-l">
<img src="images/000516.jpg" alt="This figure shows NumOfBuyingCustomers per Product Name." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-19</strong> <em class="calibre5">RELATEDTABLE</em> does not work over a many-to-many relationship.</figcaption>
</figure>
<p class="edition"><em class="calibre5">RELATEDTABLE</em> cannot follow the chain of relationships because they are not going in the same direction. The row context from <em class="calibre5">Product</em> does not reach <em class="calibre5">Customers</em>. It is worth noting that if we try the formula in the opposite direction, that is, if we count the number of products bought for each customer, the result is correct: a different number for each row representing the number of products bought by the customer. The reason for this behavior is not the propagation of a row context but, rather, the context transition generated by <em class="calibre5">RELATEDTABLE</em>. We added this final note for full disclosure. It is not time to elaborate on this just yet. You will have a better understanding of this after reading <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-94" class="calibre13"><span type="pagebreak" id="calibre_link-1755"></span>Filter context and relationships</h4>
<p class="edition">In the previous section, you learned that the row context iterates and, as such, that it does not use relationships. The filter context, on the other hand, filters. A filter context is not applied to an individual table. Instead, it always works on the whole model. At this point, you can update the evaluation context mantra to its complete formulation:</p>
<p class="edition"><em class="calibre5">The filter context filters the model; the row context iterates one table</em>.</p>
<p class="edition">Because a filter context filters the model, it uses relationships. The filter context interacts with relationships automatically, and it behaves differently depending on how the cross-filter direction of the relationship is set. The cross-filter direction is represented with a small arrow in the middle of a relationship, as shown in <a href="#calibre_link-561" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-20</a>.</p>
<figure id="calibre_link-561" class="image-l">
<img src="images/000523.jpg" alt="This figure displays the data model and explains the relationships." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-20</strong> Behavior of filter context and relationships.</figcaption>
</figure>
<p class="edition">The filter context uses a relationship by going in the direction allowed by the arrow. In all relationships the arrow allows propagation from the one-side to the many-side, whereas when the cross-filter direction is <em class="calibre5">BOTH</em>, propagation is allowed from the many-side to the one-side too.</p>
<p class="edition">A relationship with a single cross-filter is a <em class="calibre5">unidirectional relationship</em>, whereas a relationship with <em class="calibre5">BOTH</em> cross-filter directions is a <em class="calibre5">bidirectional relationship</em>.</p>
<p class="edition">This behavior is intuitive. Although we have not explained this sooner, all the reports we have used so far relied on this behavior. Indeed, in a typical report filtering by <em class="calibre5">Product[Color]</em> and aggregating the <em class="calibre5">Sales[Quantity]</em>, one would expect the filter from <em class="calibre5">Product</em> to propagate to <em class="calibre5">Sales</em>. This is exactly what happens: <em class="calibre5">Product</em> is on the one-side of a relationship; thus a filter on <em class="calibre5">Product</em> propagates to <em class="calibre5">Sales</em>, regardless of the cross-filter direction.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2014"></span>Because our sample data model contains both a bidirectional relationship and many unidirectional relationships, we can demonstrate the filtering behavior by using three different measures that count the number of rows in the three tables: <em class="calibre5">Sales</em>, <em class="calibre5">Product</em>, and <em class="calibre5">Customer</em>.</p>
<p class="codelink"><a href="#calibre_link-562" id="calibre_link-2256" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">[NumOfSales]     := COUNTROWS ( Sales )
[NumOfProducts]  := COUNTROWS ( Product )
[NumOfCustomers] := COUNTROWS ( Customer )</pre></div>
<p class="edition">The report contains the <em class="calibre5">Product[Color]</em> on the rows. Therefore, each cell is evaluated in a filter context that filters the product color. <a href="#calibre_link-563" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-21</a> shows the result.</p>
<figure id="calibre_link-563" class="image-l">
<img src="images/000530.jpg" alt="This matrix returns NumOfSales, NumOfProducts, and NumOfCustomers per Color." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-21</strong> This shows the behavior of filter context and relationships.</figcaption>
</figure>
<p class="edition">In this first example, the filter is always propagating from the one-side to the many-side of relationships. The filter starts from <em class="calibre5">Product[Color]</em>. From there, it reaches <em class="calibre5">Sales</em>, which is on the many-side of the relationship with <em class="calibre5">Product</em>, and <em class="calibre5">Product</em>, because it is the very same table. On the other hand, <em class="calibre5">NumOfCustomers</em> always shows the same value&mdash;the total number of customers. This is because the relationship between <em class="calibre5">Customer</em> and <em class="calibre5">Sales</em> does not allow propagation from <em class="calibre5">Sales</em> to <em class="calibre5">Customer</em>. The filter is moved from <em class="calibre5">Product</em> to <em class="calibre5">Sales</em>, but from there it does not reach <em class="calibre5">Customer</em>.</p>
<p class="edition">You might have noticed that the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em> is a bidirectional relationship. Thus, a filter context on <em class="calibre5">Customer</em> also filters <em class="calibre5">Sales</em> and <em class="calibre5">Product</em>. We can prove it by changing the report, slicing by <em class="calibre5">Customer[Education]</em> instead of <em class="calibre5">Product[Color]</em>. The result is visible in <a href="#calibre_link-564" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-22</a>.</p>
<figure id="calibre_link-564" class="image-l">
<img src="images/000537.jpg" alt="This time NumOfSales, NumOfProducts, and NumOfCustomers are returned by Education." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2015"></span><strong class="calibre7">Figure 4-22</strong> Filtering by customer education, the <em class="calibre5">Product</em> table is filtered too.</figcaption>
</figure>
<p class="edition">This time the filter starts from <em class="calibre5">Customer</em>. It can reach the <em class="calibre5">Sales</em> table because <em class="calibre5">Sales</em> is on the many-side of the relationship. Furthermore, it propagates from <em class="calibre5">Sales</em> to <em class="calibre5">Product</em> because the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em> is bidirectional&mdash;its cross-filter direction is <em class="calibre5">BOTH</em>.</p>
<p class="edition">Beware that a single bidirectional relationship in a chain does not make the whole chain bidirectional. In fact, a similar measure that counts the number of subcategories, such as the following one, demonstrates that the filter context starting from <em class="calibre5">Customer</em> does not reach <em class="calibre5">Product Subcategory</em>:</p>
<p class="codelink"><a href="#calibre_link-565" id="calibre_link-2257" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NumOfSubcategories := COUNTROWS ( 'Product Subcategory' )</pre></div>
<p class="edition">Adding the measure to the previous report produces the results shown in <a href="#calibre_link-566" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-23</a>, where the number of subcategories is the same for all the rows.</p>
<figure id="calibre_link-566" class="image-l">
<img src="images/000544.jpg" alt="The figure shows NumOfSales, NumOfProducts, NumOfCustomers, and NumOfSubcategories per Education." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-23</strong> If the relationship is unidirectional, customers cannot filter subcategories.</figcaption>
</figure>
<p class="edition">Because the relationship between <em class="calibre5">Product</em> and <em class="calibre5">Product Subcategory</em> is unidirectional, the filter does not propagate to <em class="calibre5">Product Subcategory</em>. If we update the relationship, setting the cross-filter direction to <em class="calibre5">BOTH</em>, the result is different as shown in <a href="#calibre_link-567" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-24</a>.</p>
<figure id="calibre_link-567" class="image-l">
<img src="images/000552.jpg" alt="The report shows NumOfSales, NumOfProducts, NumOfCustomers, and NumOfSubcategories per Education." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-24</strong> If the relationship is bidirectional, customers can filter subcategories too.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1756"></span>With the row context, we use <em class="calibre5">RELATED</em> and <em class="calibre5">RELATEDTABLE</em> to propagate the row context through relationships. On the other hand, with the filter context, no functions are needed to propagate the filter. The filter context filters the model, not a table. As such, once one applies a filter context, the entire model is subject to the filter according to the relationships.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">From the examples, it may look like enabling bidirectional filtering on all the relationships is a good option to let the filter context propagate to the whole model. <strong class="calibre7">This is definitely not the case.</strong> We will cover advanced relationships in depth later, in <a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 15</a>. Bidirectional filters come with a lot more complexity than what we can share with this introductory chapter, and you should not use them unless you have a clear idea of the consequences. As a rule, you should enable bidirectional filters in specific measures by using the <em class="calibre5">CROSSFILTER</em> function, and only when strictly required.</p>
</div>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-95" class="h2a">Using <em class="calibre5">DISTINCT</em> and <em class="calibre5">SUMMARIZE</em> in filter contexts</h3>
<p class="edition">Now that you have a solid understanding of evaluation contexts, we can use this knowledge to solve a scenario step-by-step. In the meantime, we provide the analysis of a few details that&mdash;hopefully&mdash;will shed more light on the fundamental concepts of row context and filter context. Besides, in this example we also further describe the <em class="calibre5">SUMMARIZE</em> function, briefly introduced in <a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 3</a>, “<a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using basic table functions</a>.”</p>
<p class="edition">Before going into more details, please note that this example shows several inaccurate calculations before reaching the correct solution. The purpose is educational because we want to teach the process of writing DAX code rather than give a solution. In the process of authoring a measure, it is likely you will make several initial errors. In this guided example, we describe the correct way of reasoning, which helps you solve similar errors by yourself.</p>
<p class="edition">The requirement is to compute the average age of customers of Contoso. Even though this looks like a legitimate requirement, it is not complete. Are we speaking about their current age or their age at the time of the sale? If a customer buys three times, should it count as one event or as three events in the average? What if they buy three times at different ages? We need to be more precise. Here is the more complete requirement: “<em class="calibre5">Compute the average age of customers at the time of sale, counting each customer only once if they made multiple purchases at the same age.”</em></p>
<p class="edition">The solution can be split into two steps:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Computing the age of the customer when the sale happened</p></li>
<li class="calibre10"><p class="listp">Averaging it</p></li>
</ul>
<p class="edition"><span type="pagebreak" id="calibre_link-2017"></span>The age of the customer changes for every sale. Thus, the age needs to be stored in the <em class="calibre5">Sales</em> table. For each row in <em class="calibre5">Sales</em>, one can compute the age of the customer at the time when the sale happened. A calculated column perfectly fits this need:</p>
<p class="codelink"><a href="#calibre_link-568" id="calibre_link-2258" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Customer Age] =
DATEDIFF (                            -- Compute the difference between
    RELATED ( Customer[Birth Date] ), -- the customer's birth date
    Sales[Order Date],                -- and the date of the sale
    YEAR                              -- in years
)</pre></div>
<p class="edition">Because <em class="calibre5">Customer Age</em> is a calculated column, it is evaluated in a row context that iterates <em class="calibre5">Sales</em>. The formula needs to access <em class="calibre5">Customer[Birth Date]</em>, which is a column in <em class="calibre5">Customer</em>, on the one-side of a relationship with <em class="calibre5">Sales</em>. In this case, <em class="calibre5">RELATED</em> is needed to let DAX access the target table. In the sample database Contoso, there are many customers for whom the birth date is blank. <em class="calibre5">DATEDIFF</em> returns blank if the first parameter is blank.</p>
<p class="edition">Because the requirement is to provide the average, a first&mdash;and inaccurate&mdash;solution might be a measure that averages this column:</p>
<p class="codelink"><a href="#calibre_link-569" id="calibre_link-2259" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Avg Customer Age Wrong := AVERAGE ( Sales[Customer Age] )</pre></div>
<p class="edition">The result is incorrect because <em class="calibre5">Sales[Customer Age]</em> contains multiple rows with the same age if a customer made multiple purchases at a certain age. The requirement is to compute each customer only once, and this formula is not following such a requirement. <a href="#calibre_link-570" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-25</a> shows the result of this last measure side-by-side with the expected result.</p>
<figure id="calibre_link-570" class="image-l">
<img src="images/000559.jpg" alt="The figure displays Avg Customer Age Wrong and Correct Average per Color." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-25</strong> A simple average computes the wrong result for the customer’s age.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1745"></span>Here is the problem: The age of each customer must be counted only once. A possible solution&mdash;still inaccurate&mdash;would be to perform a <em class="calibre5">DISTINCT</em> of the customer ages and then average it, with the following measure:</p>
<p class="codelink"><a href="#calibre_link-571" id="calibre_link-2260" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Avg Customer Age Wrong Distinct :=
AVERAGEX (                             -- Iterate on the distinct values of
    DISTINCT ( Sales[Customer Age] ),  -- Sales[Customer Age] and compute the
    Sales[Customer Age]                -- average of the customer's age
)</pre></div>
<p class="edition">This solution is not the correct one yet. In fact, <em class="calibre5">DISTINCT</em> returns the distinct values of the customer age. Two customers with the same age would be counted only once by this formula. The requirement is to count each customer once, whereas this formula is counting each age once. In fact, <a href="#calibre_link-572" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 4-26</a> shows the report with the new formulation of <em class="calibre5">Avg Customer Age</em>. You see that this solution is still inaccurate.</p>
<figure id="calibre_link-572" class="image-l">
<img src="images/000566.jpg" alt="The figure displays Avg Customer Age Wrong Distinct and Correct Average per Color." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 4-26</strong> The average of the distinct customer ages still provides a wrong result.</figcaption>
</figure>
<p class="edition">In the last formula, one might try to replace <em class="calibre5">Customer Age</em> with <em class="calibre5">CustomerKey</em> as the parameter of <em class="calibre5">DISTINCT</em>, as in the following code:</p>
<p class="codelink"><a href="#calibre_link-573" id="calibre_link-2261" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Avg Customer Age Invalid Syntax :=
AVERAGEX (                             -- Iterate on the distinct values of
    DISTINCT ( Sales[CustomerKey] ),   -- Sales[CustomerKey] and compute the
    Sales[Customer Age]                -- average of the customer's age
)</pre></div>
<p class="edition">This code contains an error and DAX will not accept it. Can you spot the reason, without reading the solution we provide in the next paragraph?</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1746"></span><em class="calibre5">AVERAGEX</em> generates a row context that iterates a table. The table provided as the first parameter to <em class="calibre5">AVERAGEX</em> is <em class="calibre5">DISTINCT ( Sales[CustomerKey] )</em>. <em class="calibre5">DISTINCT</em> returns a table with one column only, and all the unique values of the customer key. Therefore, the row context generated by <em class="calibre5">AVERAGEX</em> only contains one column, namely <em class="calibre5">Sales[CustomerKey]</em>. DAX cannot evaluate <em class="calibre5">Sales[Customer Age]</em> in a row context that only contains <em class="calibre5">Sales[CustomerKey]</em>.</p>
<p class="edition">What is needed is a row context that has the granularity of <em class="calibre5">Sales[CustomerKey]</em> but that also contains <em class="calibre5">Sales[Customer Age]</em>. <em class="calibre5">SUMMARIZE</em>, introduced in <a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 3</a>, can generate the existing unique combinations of two columns. Now we can finally show a version of this code that implements all the requirements:</p>
<p class="codelink"><a href="#calibre_link-574" id="calibre_link-2262" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Correct Average :=
AVERAGEX (                     -- Iterate on
    SUMMARIZE (                -- all the existing combinations
        Sales,                 -- that exist in Sales
        Sales[CustomerKey],    -- of the customer key and
        Sales[Customer Age]    -- the customer age
    ),                         --
    Sales[Customer Age]        -- and average the customer's age
)</pre></div>
<p class="edition">As usual, it is possible to use a variable to split the calculation in multiple steps. Note that the access to the <em class="calibre5">Customer Age</em> column still requires a reference to the <em class="calibre5">Sales</em> table name in the second argument of the <em class="calibre5">AVERAGEX</em> function. A variable can contain a table, but it cannot be used as a table reference.</p>
<p class="codelink"><a href="#calibre_link-575" id="calibre_link-2263" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Correct Average :=
VAR CustomersAge =
    SUMMARIZE (                -- Existing combinations
        Sales,                 -- that exist in Sales
        Sales[CustomerKey],    -- of the customer key and
        Sales[Customer Age]    -- the customer age
    )
RETURN
AVERAGEX (                     -- Iterate on list of
    CustomersAge,              -- Customers/age in Sales
    Sales[Customer Age]        -- and average the customer's age
)</pre></div>
<p class="edition"><em class="calibre5">SUMMARIZE</em> generates all the combinations of customer and age available in the current filter context. Thus, multiple customers with the same age will duplicate the age, once per customer. <em class="calibre5">AVERAGEX</em> ignores the presence of <em class="calibre5">CustomerKey</em> in the table; it only uses the customer age. <em class="calibre5">CustomerKey</em> is only needed to count the correct number of occurrences of each age.</p>
<p class="edition">It is worth stressing that the full measure is executed in the filter context generated by the report. Thus, only the customers who bought something are evaluated and returned by <em class="calibre5">SUMMARIZE</em>. Every cell of the report has a different filter context, only considering the customers who purchased at least one product of the color displayed in the report.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-96" class="h2a"><span type="pagebreak" id="calibre_link-2993"></span>Conclusions</h3>
<p class="edition">It is time to recap the most relevant topics you learned in this chapter about evaluation contexts.</p>
<ul class="sq">
<li class="calibre10"><p class="listp">There are two evaluation contexts: the filter context and the row context. The two evaluation contexts are not variations of the same concept: <em class="calibre5">the filter context filters the model</em>; <em class="calibre5">the row context iterates one table</em>.</p></li>
<li class="calibre10"><p class="listp">To understand a formula’s behavior, you always need to consider both evaluation contexts because they operate at the same time.</p></li>
<li class="calibre10"><p class="listp">DAX creates a row context automatically for a calculated column. One can also create a row context programmatically by using an iterator. Every iterator defines a row context.</p></li>
<li class="calibre10"><p class="listp">You can nest row contexts and, in case they are on the same table, the innermost row context hides the previous row contexts on the same table. Variables are useful to store values retrieved when the required row context is accessible. In earlier versions of DAX where variables were not available, the <em class="calibre5">EARLIER</em> function was used to get access to the previous row context. As of today, using <em class="calibre5">EARLIER</em> is discouraged.</p></li>
<li class="calibre10"><p class="listp">When iterating over a table that is the result of a table expression, the row context only contains the columns returned by the table expression.</p></li>
<li class="calibre10"><p class="listp">Client tools like Power BI create a filter context when you use fields on rows, columns, slicers, and filters. A filter context can also be created programmatically by using <em class="calibre5">CALCULATE</em>, which we introduce in the next chapter.</p></li>
<li class="calibre10"><p class="listp">The row context does not propagate through relationships automatically. One needs to force the propagation by using <em class="calibre5">RELATED</em> and <em class="calibre5">RELATEDTABLE</em>. You need to use these functions in a row context on the correct side of a one-to-many relationship: <em class="calibre5">RELATED</em> on the many-side, <em class="calibre5">RELATEDTABLE</em> on the one-side.</p></li>
<li class="calibre10"><p class="listp">The filter context filters the model, and it uses relationships according to their cross-filter direction. It always propagates from the one-side to the many-side. In addition, if you use the cross-filtering direction <em class="calibre5">BOTH</em>, then the propagation also happens from the many-side to the one-side.</p></li>
</ul>
<p class="edition">At this point, you have learned the most complex conceptual topics of the DAX language. These points rule all the evaluation flows of your formulas, and they are the pillars of the DAX language. Whenever you encounter an expression that does not compute what you want, there is a huge chance that was because you have not fully understood these rules.</p>
<p class="edition">As we said in the introduction, at first glance all these topics look simple. In fact, they are. What makes them complex is the fact that in a DAX expression you might have several evaluation contexts active in different parts of the formula. Mastering evaluation contexts is a skill that you will gain with experience, and we will try to help you on this by showing many examples in the next chapters. After writing some DAX formulas of your own, you will intuitively know which contexts are used and which functions they require, and you will finally master the DAX language.<span type="pagebreak" id="calibre_link-2994"></span></p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-576">
<div id="calibre_link-2995" class="calibre2">
<div id="calibre_link-2996" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-10"><span type="pagebreak" id="calibre_link-1773"></span><span class="pd_ash">Chapter 5</span><br class="calibre3" />Understanding <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em></h2>
<p class="edition">In this chapter we continue our journey in discovering the power of the DAX language with a detailed explanation of a single function: <em class="calibre5">CALCULATE</em>. The same considerations apply for <em class="calibre5">CALCULATETABLE</em>, which evaluates and returns a table instead of a scalar value. For simplicity’s sake, we will refer to <em class="calibre5">CALCULATE</em> in the examples, but remember that <em class="calibre5">CALCULATETABLE</em> displays the same behavior.</p>
<p class="edition"><em class="calibre5">CALCULATE</em> is the most important, useful, and complex function in DAX, so it deserves a full chapter. The function itself is simple to learn; it only performs a few tasks. Complexity comes from the fact that <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em> are the only functions in DAX that can create new filter contexts. Thus, although they are simple functions, using <em class="calibre5">CALCULATE</em> or <em class="calibre5">CALCULATETABLE</em> in a formula instantly increases its complexity.</p>
<p class="edition">This chapter is as tough as the previous chapter was. We suggest you carefully read it once, get a general feeling for <em class="calibre5">CALCULATE</em>, and move on to the remaining part of the book. Then, as soon as you feel lost in a specific formula, come back to this chapter and read it again from the beginning. You will probably discover new information each time you read it.</p>
<section class="calibre4">
<h3 id="calibre_link-97" class="h2a">Introducing <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em></h3>
<p class="edition">The previous chapter described the two evaluation contexts: the row context and the filter context. The row context automatically exists for a calculated column, and one can create a row context programmatically by using an iterator. The filter context, on the other hand, is created by the report, and we have not described yet how to programmatically create a filter context. <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em> are the only functions required to operate on the filter context. Indeed, <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em> are the only functions that can create a new filter context by manipulating the existing one. From here onwards, we will show examples based on <em class="calibre5">CALCULATE</em> only, but remember that <em class="calibre5">CALCULATETABLE</em> performs the same operation for DAX expressions returning a table. Later in the book there are more examples using <em class="calibre5">CALCULATETABLE</em>, as in <a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 12</a>, “<a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with tables</a>,” and in <a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 13</a>, “<a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Authoring queries</a>.”</p>
<section class="calibre4">
<h4 id="calibre_link-98" class="calibre13">Creating filter contexts</h4>
<p class="edition">Here we will introduce the reason why one would want to create new filter contexts with a practical example. As described in the next sections, writing code without being able to create new filter <span type="pagebreak" id="calibre_link-2997"></span>contexts results in verbose and unreadable code. What follows is an example of how creating a new filter context can drastically improve code that, at first, looked rather complex.</p>
<p class="edition">Contoso is a company that sells electronic products all around the world. Some products are branded Contoso, whereas others have different brands. One of the reports requires a comparison of the gross margins, both as an amount and as a percentage, of Contoso-branded products against their competitors. The first part of the report requires the following calculations:</p>
<p class="codelink"><a href="#calibre_link-577" id="calibre_link-2265" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount := SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
Gross Margin := SUMX ( Sales, Sales[Quantity] * ( Sales[Net Price] - Sales[Unit Cost] ) )
GM % := DIVIDE ( [Gross Margin], [Sales Amount] )</pre></div>
<p class="edition">One beautiful aspect of DAX is that you can build more complex calculations on top of existing measures. In fact, you can appreciate this in the definition of <em class="calibre5">GM %</em>, the measure that computes the percentage of the gross margin against the sales. <em class="calibre5">GM %</em> simply invokes the two original measures as it divides them. If you already have a measure that computes a value, you can call the measure instead of rewriting the full code.</p>
<p class="edition">Using the three measures defined above, one can build the first report, as shown in <a href="#calibre_link-578" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-1</a>.</p>
<figure id="calibre_link-578" class="image-l">
<img src="images/000573.jpg" alt="The report shows Sales Amount, the Gross Margin amount, and the Gross Margin Percentage for each Category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-1</strong> The three measures provide quick insights in the margin of different categories.</figcaption>
</figure>
<p class="edition">The next step in building the report is more intricate. In fact, the final report we want is the one in <a href="#calibre_link-579" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-2</a> that shows two additional columns: the gross margin for Contoso-branded products, both as amount and as percentage.</p>
<figure id="calibre_link-579" class="image-l">
<img src="images/000580.jpg" alt="The report looks similar to the prior report. However, the last two columns are new, showing gross margin amount and gross margin percentage for Contoso-branded products." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-2</strong> The last two columns of the report show gross margin amount and gross margin percentage for Contoso-branded products.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-2998"></span>With the knowledge acquired so far, you are already capable of authoring the code for these two measures. Indeed, because the requirement is to restrict the calculation to only one brand, a solution is to use <em class="calibre5">FILTER</em> to restrict the calculation of the gross margin to Contoso products only:</p>
<p class="codelink"><a href="#calibre_link-580" id="calibre_link-2266" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Contoso GM :=
VAR ContosoSales =             -- Saves the rows of Sales which are related
    FILTER (                   -- to Contoso-branded products into a variable
        Sales,
        RELATED ( 'Product'[Brand] ) = "Contoso"
    )
VAR ContosoMargin =            -- Iterates over ContosoSales
    SUMX (                     -- to only compute the margin for Contoso
        ContosoSales,
        Sales[Quantity] * ( Sales[Net Price] - Sales[Unit Cost] )
    )
RETURN
    ContosoMargin</pre></div>
<p class="edition">The <em class="calibre5">ContosoSales</em> variable contains the rows of <em class="calibre5">Sales</em> related to all the Contoso-branded products. Once the variable is computed, <em class="calibre5">SUMX</em> iterates on <em class="calibre5">ContosoSales</em> to compute the margin. Because the iteration is on the <em class="calibre5">Sales</em> table and the filter is on the <em class="calibre5">Product</em> table, one needs to use <em class="calibre5">RELATED</em> to retrieve the related product for each row in <em class="calibre5">Sales</em>. In a similar way, one can compute the gross margin of Contoso by iterating the <em class="calibre5">ContosoSales</em> variable twice:</p>
<p class="codelink"><a href="#calibre_link-581" id="calibre_link-2267" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Contoso GM % :=
VAR ContosoSales =             -- Saves the rows of Sales which are related
    FILTER (                   -- to Contoso-branded products into a variable
        Sales,
        RELATED ( 'Product'[Brand] ) = "Contoso"
    )
VAR ContosoMargin =            -- Iterates over ContosoSales
    SUMX (                     -- to only compute the margin for Contoso
        ContosoSales,
        Sales[Quantity] * ( Sales[Net Price] - Sales[Unit Cost] )
    )
<strong class="calibre7">VAR ContosoSalesAmount =       -- Iterates over ContosoSales</strong>
    <strong class="calibre7">SUMX (                     -- to only compute the sales amount for Contoso</strong>
        <strong class="calibre7">ContosoSales,</strong>
        <strong class="calibre7">Sales[Quantity] * Sales[Net Price]</strong>
    <strong class="calibre7">)</strong>
<strong class="calibre7">VAR Ratio =</strong>
    <strong class="calibre7">DIVIDE ( ContosoMargin, ContosoSalesAmount )</strong>
<strong class="calibre7">RETURN</strong>
    <strong class="calibre7">Ratio</strong></pre></div>
<p class="edition">The code for <em class="calibre5">Contoso GM %</em> is a bit longer but, from a logical point of view, it follows the same pattern as <em class="calibre5">Contoso GM</em>. Although these measures work, it is easy to note that the initial elegance of DAX is lost. Indeed, the model already contains one measure to compute the gross margin and another measure to compute the gross margin percentage. However, because the new measures needed to be filtered, we had to rewrite the expression to add the condition.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1788"></span>It is worth stressing that the basic measures <em class="calibre5">Gross Margin</em> and <em class="calibre5">GM %</em> can already compute the values for Contoso. In fact, from <a href="#calibre_link-579" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-2</a> you can note that the gross margin for Contoso is equal to 3,877,070.65 and the percentage is equal to 52.73%. One can obtain the very same numbers by slicing the base measures <em class="calibre5">Gross Margin</em> and <em class="calibre5">GM %</em> by <em class="calibre5">Brand</em>, as shown in <a href="#calibre_link-582" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-3</a>.</p>
<figure id="calibre_link-582" class="image-l">
<img src="images/000587.jpg" alt="The report shows Sales Amount, Gross Margin, and GM %, this time by brand. The numbers previously obtained are on the Contoso row." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-3</strong> When sliced by brand, the base measures compute the value of <em class="calibre5">Gross Margin</em> and <em class="calibre5">GM %</em> for Contoso.</figcaption>
</figure>
<p class="edition">In the highlighted cells, the filter context created by the report is filtering the Contoso brand. The filter context filters the model. Therefore, a filter context placed on the <em class="calibre5">Product[Brand]</em> column filters the <em class="calibre5">Sales</em> table because of the relationship linking <em class="calibre5">Sales</em> to <em class="calibre5">Product</em>. Using the filter context, one can filter a table indirectly because the filter context operates on the whole model.</p>
<p class="edition">Thus, if we could make DAX compute the <em class="calibre5">Gross Margin</em> measure by creating a filter context programmatically, which only filters the Contoso-branded products, then our implementation of the last two measures would be much easier. This is possible by using <em class="calibre5">CALCULATE</em>.</p>
<p class="edition">The complete description of <em class="calibre5">CALCULATE</em> comes later in this chapter. First, we examine the syntax of <em class="calibre5">CALCULATE</em>:</p>
<p class="codelink"><a href="#calibre_link-583" id="calibre_link-2268" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE ( Expression, Condition1, ... ConditionN )</pre></div>
<p class="edition"><em class="calibre5">CALCULATE</em> can accept any number of parameters. The only mandatory parameter is the first one, that is, the expression to evaluate. The conditions following the first parameter are called <em class="calibre5">filter arguments</em>. <em class="calibre5">CALCULATE</em> creates a new filter context based on the set of filter arguments. Once the new filter context is computed, CALCULATE applies it to the model, and it proceeds with the evaluation of the expression. Thus, by leveraging <em class="calibre5">CALCULATE</em>, the code for <em class="calibre5">Contoso Margin</em> and <em class="calibre5">Contoso GM %</em> becomes much simpler:</p>
<p class="codelink"><a href="#calibre_link-584" id="calibre_link-2269" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Contoso GM :=
CALCULATE (
    [Gross Margin],                 -- Computes the gross margin
<span type="pagebreak" id="calibre_link-1762"></span>    'Product'[Brand] = "Contoso"    -- In a filter context where brand = Contoso
)

Contoso GM % :=
CALCULATE (
    [GM %],                         -- Computes the gross margin percentage
    'Product'[Brand] = "Contoso"    -- In a filter context where brand = Contoso
)</pre></div>
<p class="edition">Welcome back, simplicity and elegance! By creating a filter context that forces the brand to be Contoso, one can rely on existing measures and change their behavior without having to rewrite the code of the measures.</p>
<p class="edition"><em class="calibre5">CALCULATE</em> lets you create new filter contexts by manipulating the filters in the current context. As you have seen, this leads to simple and elegant code. In the next sections we provide a complete and more formal definition of the behavior of <em class="calibre5">CALCULATE</em>, describing in detail what <em class="calibre5">CALCULATE</em> does and how to take advantage of its features. Indeed, so far we have kept the example rather high-level when, in fact, the initial definition of the Contoso measures is not semantically equivalent to the final definition. There are some differences that one needs to understand well.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-99" class="calibre13">Introducing <em class="calibre5">CALCULATE</em></h4>
<p class="edition">Now that you have had an initial exposure to <em class="calibre5">CALCULATE</em>, it is time to start learning the details of this function. As introduced earlier, <em class="calibre5">CALCULATE</em> is the only DAX function that can modify the filter context; and remember, when we mention <em class="calibre5">CALCULATE</em>, we also include <em class="calibre5">CALCULATETABLE</em>. <em class="calibre5">CALCULATE</em> does not modify a filter context: It creates a new filter context by merging its filter parameters with the existing filter context. Once <em class="calibre5">CALCULATE</em> ends, its filter context is discarded and the previous filter context becomes effective again.</p>
<p class="edition">We have introduced the syntax of <em class="calibre5">CALCULATE</em> as</p>
<p class="codelink"><a href="#calibre_link-585" id="calibre_link-2270" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE ( Expression, Condition1, ... ConditionN )</pre></div>
<p class="edition">The first parameter is the expression that <em class="calibre5">CALCULATE</em> will evaluate. Before evaluating the expression, <em class="calibre5">CALCULATE</em> computes the filter arguments and uses them to manipulate the filter context.</p>
<p class="edition">The first important thing to note about <em class="calibre5">CALCULATE</em> is that the filter arguments are not Boolean conditions: The filter arguments are tables. Whenever you use a Boolean condition as a filter argument of <em class="calibre5">CALCULATE</em>, DAX translates it into a table of values.</p>
<p class="edition">In the previous section we used this code:</p>
<p class="codelink"><a href="#calibre_link-586" id="calibre_link-2271" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Contoso GM :=
CALCULATE (
    [Gross Margin],                 -- Computes the gross margin
    <strong class="calibre7">'Product'[Brand] = "Contoso"</strong>    -- In a filter context where brand = Contoso
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1763"></span>Using a Boolean condition is only a shortcut for the complete <em class="calibre5">CALCULATE</em> syntax. This is known as syntax sugar. It reads this way:</p>
<p class="codelink"><a href="#calibre_link-587" id="calibre_link-2272" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Contoso GM :=
CALCULATE (
    [Gross Margin],                     -- Computes the gross margin
    <strong class="calibre7">FILTER (                            -- Using as valid values for Product[Brand]</strong>
        <strong class="calibre7">ALL ( 'Product'[Brand] ),       -- any value for Product[Brand]</strong>
        <strong class="calibre7">'Product'[Brand] = "Contoso"    -- which is equal to "Contoso"</strong>
    <strong class="calibre7">)</strong>
)</pre></div>
<p class="edition">The two syntaxes are equivalent, and there are no performance or semantic differences between them. That being said, particularly when you are learning <em class="calibre5">CALCULATE</em> for the first time, it is useful to always read filter arguments as tables. This makes the behavior of <em class="calibre5">CALCULATE</em> more apparent. Once you get used to <em class="calibre5">CALCULATE</em> semantics, the compact version of the syntax is more convenient. It is shorter and easier to read.</p>
<p class="edition">A filter argument is a table, that is, a list of values. The table provided as a filter argument defines the list of values that will be visible&mdash;for the column&mdash;during the evaluation of the expression. In the previous example, <em class="calibre5">FILTER</em> returns a table with one row only, containing a value for <em class="calibre5">Product[Brand]</em> that equals “Contoso”. In other words, “Contoso” is the only value that <em class="calibre5">CALCULATE</em> will make visible for the <em class="calibre5">Product[Brand]</em> column. Therefore, <em class="calibre5">CALCULATE</em> filters the model including only products of the Contoso brand. Consider these two definitions:</p>
<p class="codelink"><a href="#calibre_link-588" id="calibre_link-2273" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
    SUMX (
        Sales,
        Sales[Quantity] * Sales[Net Price]
    )

Contoso Sales :=
CALCULATE (
    [Sales Amount],
    FILTER (
        ALL ( 'Product'[Brand] ),
        'Product'[Brand] = "Contoso"
    )
)</pre></div>
<p class="edition">The filter parameter of <em class="calibre5">FILTER</em> in the <em class="calibre5">CALCULATE</em> of <em class="calibre5">Contoso Sales</em> scans <em class="calibre5">ALL(Product[Brand]);</em> therefore, any previously existing filter on the product brand is overwritten by the new filter. This is more evident when you use the measures in a report that slices by brand. You can see in <a href="#calibre_link-589" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-4</a> that <em class="calibre5">Contoso Sales</em> reports on all the rows/brands the same value as <em class="calibre5">Sales Amount</em> did for Contoso specifically.</p>
<figure id="calibre_link-589" class="image-l">
<img src="images/000594.jpg" alt="The report shows a Sales Amount and a Contoso Sales column, for all the brands. The amount in Sales Amount for Contoso is the amount repeated all over the Contoso Sales column of the report." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2999"></span><strong class="calibre7">Figure 5-4</strong> <em class="calibre5">Contoso Sales</em> overwrites the existing filter with the new filter for Contoso.</figcaption>
</figure>
<p class="edition">In every row, the report creates a filter context containing the relevant brand. For example, in the row for Litware the original filter context created by the report contains a filter that only shows Litware products. Then, <em class="calibre5">CALCULATE</em> evaluates its filter argument, which returns a table containing only Contoso. The newly created filter overwrites the previously existing filter on the same column. You can see a graphic representation of the process in <a href="#calibre_link-590" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-5</a>.</p>
<figure id="calibre_link-590" class="image-l">
<img src="images/000601.jpg" alt="The figure uses symbols to clarify how the Contoso filter overwrites the Litware filter. It links back to the initial code." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-5</strong> The filter with Litware is overwritten by the filter with Contoso evaluated by <em class="calibre5">CALCULATE</em>.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1789"></span><em class="calibre5">CALCULATE</em> does not overwrite the whole original filter context. It only replaces previously existing filters on the columns contained in the filter argument. In fact, if one changes the report to now slice by <em class="calibre5">Product[Category]</em>, the result is different, as shown in <a href="#calibre_link-591" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-6</a>.</p>
<figure id="calibre_link-591" class="image-l">
<img src="images/000607.jpg" alt="The report shows Sales Amount and Contoso Sales by Category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-6</strong> If the report filters by Category, the filter on Brand will be merged and no overwrite happens.</figcaption>
</figure>
<p class="edition">Now the report is filtering <em class="calibre5">Product[Category]</em>, whereas <em class="calibre5">CALCULATE</em> applies a filter on <em class="calibre5">Product[Brand]</em> to evaluate the <em class="calibre5">Contoso Sales</em> measure. The two filters do not work on the same column of the <em class="calibre5">Product</em> table. Therefore, no overwriting happens, and the two filters work together as a new filter context. As a result, each cell is showing the sales of Contoso for the given category. The scenario is depicted in <a href="#calibre_link-592" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-7</a>.</p>
<figure id="calibre_link-592" class="image-l">
<img src="images/000615.jpg" alt="The figure uses symbols to better depict how CALCULATE merges filters." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-7</strong> <em class="calibre5">CALCULATE</em> overwrites filters on the same column. It merges filters if they are on different columns.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1764"></span>Now that you have seen the basics of <em class="calibre5">CALCULATE</em>, we can summarize its semantics:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">CALCULATE</em> makes a copy of the current filter context.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">CALCULATE</em> evaluates each filter argument and produces, for each condition, the list of valid values for the specified columns.</p></li>
<li class="calibre10"><p class="listp">If two or more filter arguments affect the same column, they are merged together using an <em class="calibre5">AND</em> operator (or using the set intersection in mathematical terms).</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">CALCULATE</em> uses the new condition to replace existing filters on the columns in the model. If a column already has a filter, then the new filter replaces the existing one. On the other hand, if the column does not have a filter, then <em class="calibre5">CALCULATE</em> adds the new filter to the filter context.</p></li>
<li class="calibre10"><p class="listp">Once the new filter context is ready, <em class="calibre5">CALCULATE</em> applies the filter context to the model, and it computes the first argument: the expression. In the end, <em class="calibre5">CALCULATE</em> restores the original filter context, returning the computed result.</p></li>
</ul>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition"><em class="calibre5">CALCULATE</em> does another very important task: It transforms any existing row context into an equivalent filter context. You find a more detailed discussion on this topic later in this chapter, under “<a href="#calibre_link-105" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding context transition</a>.” Should you do a second reading of this section, do remember: <em class="calibre5">CALCULATE</em> creates a filter context out of the existing row contexts.</p>
</div>
<p class="edition"><em class="calibre5">CALCULATE</em> accepts filters of two types:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Lists of values</strong>, in the form of a table expression. In that case, you provide the exact list of values you want to make visible in the new filter context. The filter can be a table with any number of columns. Only the existing combinations of values in different columns will be considered in the filter.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Boolean conditions</strong>, such as <em class="calibre5">Product[Color] = “White”</em>. These filters need to work on a single column because the result needs to be a list of values for a single column. This type of filter argument is also known as <em class="calibre5">predicate</em>.</p></li>
</ul>
<p class="edition">If you use the syntax with a Boolean condition, DAX transforms it into a list of values. Thus, whenever you write this code:</p>
<p class="codelink"><a href="#calibre_link-593" id="calibre_link-2274" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount Red Products :=
CALCULATE (
    [Sales Amount],
    'Product'[Color] = "Red"
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1765"></span>DAX transforms the expression into this:</p>
<p class="codelink"><a href="#calibre_link-594" id="calibre_link-2275" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount Red Products :=
CALCULATE (
    [Sales Amount],
    FILTER (
        ALL ( 'Product'[Color] ),
        'Product'[Color] = "Red"
    )
)</pre></div>
<p class="edition">For this reason, you can only reference one column in a filter argument with a Boolean condition. DAX needs to detect the column to iterate in the <em class="calibre5">FILTER</em> function, which is generated in the background automatically. If the Boolean expression references two or more columns, then you must explicitly write the <em class="calibre5">FILTER</em> iteration, as you learn later in this chapter.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-100" class="calibre13">Using <em class="calibre5">CALCULATE</em> to compute percentages</h4>
<p class="edition">Now that we have introduced <em class="calibre5">CALCULATE</em>, we can use it to define several calculations. The goal of this section is to bring your attention to some details about <em class="calibre5">CALCULATE</em> that are not obvious at first sight. Later in this chapter, we will cover more advanced aspects of <em class="calibre5">CALCULATE</em>. For now, we focus on some of the issues you might encounter when you start using <em class="calibre5">CALCULATE</em>.</p>
<p class="edition">A pattern that appears often is that of percentages. When working with percentages, it is very important to define exactly the calculation required. In this set of examples, you learn how different uses of <em class="calibre5">CALCULATE</em> and <em class="calibre5">ALL</em> functions provide different results.</p>
<p class="edition">We can start with a simple percentage calculation. We want to build the following report showing the sales amount along with the percentage over the grand total. You can see in <a href="#calibre_link-595" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-8</a> the result we want to obtain.</p>
<figure id="calibre_link-595" class="image-l">
<img src="images/000622.jpg" alt="The figure shows Sales Amount and Sales Percentage for each Category. It gives the percentage of the current category against the grand total." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-8</strong> <em class="calibre5">Sales Pct</em> shows the percentage of the current category against the grand total.</figcaption>
</figure>
<p class="edition">To compute the percentage, one needs to divide the value of <em class="calibre5">Sales Amount</em> in the current filter context by the value of <em class="calibre5">Sales Amount</em> in a filter context that ignores the existing filter on Category. In fact, the value of 1.26% for Audio is computed as 384,518.16 divided by 30,591,343.98.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1679"></span>In each row of the report, the filter context already contains the current category. Thus, for <em class="calibre5">Sales Amount</em>, the result is automatically filtered by the given category. The denominator of the ratio needs to ignore the current filter context, so that it evaluates the grand total. Because the filter arguments of <em class="calibre5">CALCULATE</em> are tables, it is enough to provide a table function that ignores the current filter context on the category and always returns all the categories&mdash;regardless of any filter. You previously learned that this function is <em class="calibre5">ALL</em>. Look at the following measure definition:</p>
<p class="codelink"><a href="#calibre_link-596" id="calibre_link-2276" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">All Category Sales :=
CALCULATE (                         -- Changes the filter context of
    [Sales Amount],                 -- the sales amount
    ALL ( 'Product'[Category] )     -- making ALL categories visible
)</pre></div>
<p class="edition"><em class="calibre5">ALL</em> removes the filter on the <em class="calibre5">Product[Category]</em> column from the filter context. Thus, in any cell of the report, it ignores any filter existing on the categories. The effect is that the filter on the category applied by the row of the report is removed. Look at the result in <a href="#calibre_link-597" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-9</a>. You can see that each row of the report for the <em class="calibre5">All Category Sales</em> measure returns the same value all the way through&mdash;the grand total of <em class="calibre5">Sales Amount</em>.</p>
<figure id="calibre_link-597" class="image-l">
<img src="images/000629.jpg" alt="The figure shows the report for Sales Amount and All Category Sales, per Category. We notice that the number is always the same for All Category Sales, and that is the total of Sales Amount. The figure points at the code that generated the report, and it clarifies that ALL has removed the filter on Category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-9</strong> <em class="calibre5">ALL</em> removes the filter on <em class="calibre5">Category</em>, so <em class="calibre5">CALCULATE</em> defines a filter context without any filter on <em class="calibre5">Category</em>.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">All Category Sales</em> measure is not useful by itself. It is unlikely a user would want to create a report that shows the same value on all the rows. However, that value is perfect as the denominator of the percentage we are looking to compute. In fact, the formula computing the percentage can be written this way:</p>
<p class="codelink"><a href="#calibre_link-598" id="calibre_link-2277" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-3000"></span>Sales Pct :=
VAR CurrentCategorySales =                    -- CurrentCategorySales contains
    [Sales Amount]                            -- the sales in the current context
VAR AllCategoriesSales =                      -- AllCategoriesSales contains
    CALCULATE (                               -- the sales amount in a filter context
        [Sales Amount],                       -- where all the product categories
        ALL ( 'Product'[Category] )           -- are visible
    )
VAR Ratio =
    DIVIDE (
        CurrentCategorySales,
        AllCategoriesSales
    )
RETURN
    Ratio</pre></div>
<p class="edition">As you have seen in this example, mixing table functions and <em class="calibre5">CALCULATE</em> makes it possible to author useful measures easily. We use this technique a lot in the book because it is the primary calculation tool in DAX.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition"><em class="calibre5">ALL</em> has specific semantics when used as a filter argument of <em class="calibre5">CALCULATE</em>. In fact, it does not replace the filter context with all the values. Instead, <em class="calibre5">CALCULATE</em> uses <em class="calibre5">ALL</em> to remove the filter on the category column from the filter context. The side effects of this behavior are somewhat complex to follow and do not belong in this introductory section. We will cover them in more detail later in this chapter.</p>
</div>
<p class="edition">As we said in the introduction of this section, it is important to pay attention to small details when authoring percentages like the one we are currently writing. In fact, the percentage works fine if the report is slicing by category. The code removes the filter from the category, but it does not touch any other existing filter. Therefore, if the report adds other filters, the result might not be exactly what one wants to achieve. For example, look at the report in <a href="#calibre_link-599" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-10</a> where we added the <em class="calibre5">Product[Color]</em> column as a second level of detail in the rows of the report.</p>
<figure id="calibre_link-599" class="image-l">
<img src="images/000636.jpg" alt="The report shows Sales Amount and Sales Pct for each color of each category. The percentages are inaccurate." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-10</strong> Adding the color to the report produces unexpected results at the color level.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3001"></span>Looking at percentages, the value at the category level is correct, whereas the value at the color level looks wrong. In fact, the color percentages do not add up&mdash;neither to the category level nor to 100%. To understand the meaning of these values and how they are evaluated, it is always of great help to focus on one cell and understand exactly what happened to the filter context. Focus on <a href="#calibre_link-600" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-11</a>.</p>
<figure id="calibre_link-600" class="image-l">
<img src="images/000642.jpg" alt="The figure brings together the code, the report, and symbols to clarify that ALL on Product[Category] removes the filter on Category but leaves the filter on Color intact." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-11</strong> <em class="calibre5">ALL</em> on <em class="calibre5">Product[Category]</em> removes the filter on category, but it leaves the filter on color intact.</figcaption>
</figure>
<p class="edition">The original filter context created by the report contained both a filter on category and a filter on color. The filter on <em class="calibre5">Product[Color]</em> is not overwritten by <em class="calibre5">CALCULATE</em>, which only removes the filter from <em class="calibre5">Product[Category]</em>. As a result, the final filter context only contains the color. Therefore, the denominator of the ratio contains the sales of all the products of the given color&mdash;Black&mdash;and of any category.</p>
<p class="edition">The calculation being wrong is not an unexpected behavior of <em class="calibre5">CALCULATE</em>. The problem here is that the formula has been designed to specifically work with a filter on a category, leaving any other filter untouched. The same formula makes perfect sense in a different report. Look at what happens if one switches the order of the columns, building a report that slices by color first and category second, as in <a href="#calibre_link-601" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-12</a>.</p>
<figure id="calibre_link-601" class="image-l">
<img src="images/000649.jpg" alt="The figure shows Sales Amount and Sales Pct for each category of each color. The percentages add up to 100% per color, and they make sense relative to one another." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3002"></span><strong class="calibre7">Figure 5-12</strong> The result looks more reasonable once color and category are interchanged.</figcaption>
</figure>
<p class="edition">The report in <a href="#calibre_link-601" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-12</a> makes a lot more sense. The measure computes the same result, but it is more intuitive thanks to the layout of the report. The percentage shown is the percentage of the category inside the given color. Color by color, the percentage always adds up to 100%.</p>
<p class="edition">In other words, when the user is required to compute a percentage, they should pay special attention in determining the denominator of the percentage. <em class="calibre5">CALCULATE</em> and <em class="calibre5">ALL</em> are the primary tools to use, but the specification of the formula depends on the business requirements.</p>
<p class="edition">Back to the example: The goal is to fix the calculation so that it computes the percentage against a filter on either the category or the color. There are multiple ways of performing the operation, all leading to slightly different results that are worth examining deeper.</p>
<p class="edition">One possible solution is to let <em class="calibre5">CALCULATE</em> remove the filter from both the category and the color. Adding multiple filter arguments to <em class="calibre5">CALCULATE</em> accomplishes this goal:</p>
<p class="codelink"><a href="#calibre_link-602" id="calibre_link-2278" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Pct :=
VAR CurrentCategorySales =
    [Sales Amount]
VAR AllCategoriesAndColorSales =
    CALCULATE (
        [Sales Amount],
        ALL ( 'Product'[Category] ), -- The two ALL conditions could also be replaced
        ALL ( 'Product'[Color] )     -- by ALL ( 'Product'[Category], 'Product'[Color] )
    )
<span type="pagebreak" id="calibre_link-3003"></span>VAR Ratio =
    DIVIDE (
        CurrentCategorySales,
        AllCategoriesAndColorSales
    )
RETURN
    Ratio</pre></div>
<p class="edition">This latter version of <em class="calibre5">Sales Pct</em> works fine with the report containing the color and the category, but it still suffers from limitations similar to the previous versions. In fact, it produces the right percentage with color and category&mdash;as you can see in <a href="#calibre_link-603" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-13</a>&mdash;but it will fail as soon as one adds other columns to the report.</p>
<figure id="calibre_link-603" class="image-l">
<img src="images/000656.jpg" alt="The report shows Sales Amount and Sales Pct for each color of the Audio category. We see that the percentages add up nicely to the grand total for that category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-13</strong> With <em class="calibre5">ALL</em> on product category and color, the percentages now sum up correctly.</figcaption>
</figure>
<p class="edition">Adding another column to the report would create the same inconsistency noticed so far. If the user wants to create a percentage that removes all the filters on the <em class="calibre5">Product</em> table, they could still use the <em class="calibre5">ALL</em> function passing a whole table as an argument:</p>
<p class="codelink"><a href="#calibre_link-604" id="calibre_link-2279" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Pct All Products :=
VAR CurrentCategorySales =
    [Sales Amount]
VAR AllProductSales =
    CALCULATE (
        [Sales Amount],
        ALL ( 'Product' )
    )
VAR Ratio =
    DIVIDE (
        CurrentCategorySales,
        AllProductSales
    )
RETURN
    Ratio</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3004"></span><em class="calibre5">ALL</em> on the <em class="calibre5">Product</em> table removes any filter on any column of the <em class="calibre5">Product</em> table. In <a href="#calibre_link-605" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-14</a> you can see the result of that calculation.</p>
<figure id="calibre_link-605" class="image-l">
<img src="images/000662.jpg" alt="ALL removes all filters. In spite of a slight rounding effect, the numbers are making sense." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-14</strong> <em class="calibre5">ALL</em> used on the product table removes the filters from all the columns of the <em class="calibre5">Product</em> table.</figcaption>
</figure>
<p class="edition">So far, you have seen that by using <em class="calibre5">CALCULATE</em> and <em class="calibre5">ALL</em> together, you can remove filters&mdash;from a column, from multiple columns, or from a whole table. The real power of <em class="calibre5">CALCULATE</em> is that it offers many options to manipulate a filter context, and its capabilities do not end there. In fact, one might want to analyze the percentages by also slicing columns from different tables. For example, if the report is sliced by product category and customer continent, the last measure we created is not perfect yet, as you can see in <a href="#calibre_link-606" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-15</a>.</p>
<figure id="calibre_link-606" class="image-l">
<img src="images/000668.jpg" alt="We see that for each continent under each category, Sales Amount makes sense and Sales Percentage All Products does not." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-15</strong> Slicing with columns of multiple tables still shows unexpected results.</figcaption>
</figure>
<p class="edition">At this point, the problem might be evident to you. The measure at the denominator removes any filter from the <em class="calibre5">Product</em> table, but it leaves the filter on <em class="calibre5">Customer[Continent]</em> intact. Therefore, the denominator computes the total sales of all products in the given continent.</p>
<p class="edition">As in the previous scenario, the filter can be removed from multiple tables by putting several filters as arguments of <em class="calibre5">CALCULATE:</em></p>
<p class="codelink"><a href="#calibre_link-607" id="calibre_link-2280" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-3005"></span>Sales Pct All Products and Customers :=
VAR CurrentCategorySales =
    [Sales Amount]
VAR AllProductAndCustomersSales =
    CALCULATE (
        [Sales Amount],
        ALL ( 'Product' ),
        ALL ( Customer )
    )
VAR Ratio =
    DIVIDE (
        CurrentCategorySales,
        AllProductAndCustomersSales
    )
RETURN
    Ratio</pre></div>
<p class="edition">By using <em class="calibre5">ALL</em> on two tables, now <em class="calibre5">CALCULATE</em> removes the filters from both tables. The result, as expected, is a percentage that adds up correctly, as you can appreciate in <a href="#calibre_link-608" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-16</a>.</p>
<figure id="calibre_link-608" class="image-l">
<img src="images/000674.jpg" alt="The report shows Sales Amount and Sales Percentage All Products and Customers, for each continent under each category. We see that the percentages add up properly." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-16</strong> Using <em class="calibre5">ALL</em> on two tables removes the filter context on both tables at the same time.</figcaption>
</figure>
<p class="edition">As with two columns, the same challenge comes up with two tables. If a user adds another column from a third table to the context, the measure will not remove the filter from the third table. One possible solution when they want to remove the filter from any table that might affect the calculation is to remove any filter from the fact table itself. In our model the fact table is <em class="calibre5">Sales</em>. Here is a measure that computes an additive percentage no matter what filter is interacting with the <em class="calibre5">Sales</em> table:</p>
<p class="codelink"><a href="#calibre_link-609" id="calibre_link-2281" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Pct All Sales :=
VAR CurrentCategorySales =
    [Sales Amount]
VAR AllSales =
    CALCULATE (
        [Sales Amount],
        ALL ( Sales )
    )
<span type="pagebreak" id="calibre_link-1680"></span>VAR Ratio =
    DIVIDE (
        CurrentCategorySales,
        AllSales
    )
RETURN
    Ratio</pre></div>
<p class="edition">This measure leverages relationships to remove the filter from any table that might filter <em class="calibre5">Sales</em>. At this stage, we cannot explain the details of how it works because it leverages expanded tables, which we introduce in <a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a>, “<a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Advanced DAX concepts</a>.” You can appreciate its behavior by inspecting <a href="#calibre_link-610" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-17</a>, where we removed the amount from the report and added the calendar year on the columns. Please note that the <em class="calibre5">Calendar Year</em> belongs to the <em class="calibre5">Date</em> table, which is not used in the measure. Nevertheless, the filter on <em class="calibre5">Date</em> is removed as part of the removal of filters from <em class="calibre5">Sales</em>.</p>
<figure id="calibre_link-610" class="image-l">
<img src="images/000681.jpg" alt="The report shows sales percentages for a few Calendar Years per Category. Total sales for each year is a percentage of the total sales over all three years. Total sales per category is a percentage of all sales over all categories." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-17</strong> <em class="calibre5">ALL</em> on the fact table removes any filter from related tables as well.</figcaption>
</figure>
<p class="edition">Before leaving this long exercise with percentages, we want to show another final example of filter context manipulation. As you can see in <a href="#calibre_link-610" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-17</a>, the percentage is always against the grand total, exactly as expected. What if the goal is to compute a percentage over the grand total of only the current year? In that case, the new filter context created by <em class="calibre5">CALCULATE</em> needs to be prepared carefully. Indeed, the denominator needs to compute the total of sales regardless of any filter apart from the current year. This requires two actions:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Removing all filters from the fact table</p></li>
<li class="calibre10"><p class="listp">Restoring the filter for the year</p></li>
</ul>
<p class="edition">Beware that the two conditions are applied at the same time, although it might look like the two steps come one after the other. You have already learned how to remove all the filters from the fact table. The last step is learning how to restore an existing filter.</p>
<span type="pagebreak" id="calibre_link-1778"></span><div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The goal of this section is to explain basic techniques for manipulating the filter context. Later in this chapter you see another easier approach to solve this specific requirement&mdash;percentage over the visible grand total&mdash;by using <em class="calibre5">ALLSELECTED</em>.</p>
</div>
<p class="edition">In <a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 3</a>, “<a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using basic table functions</a>,” you learned the <em class="calibre5">VALUES</em> function. <em class="calibre5">VALUES</em> returns the list of values of a column in the current filter context. Because the result of <em class="calibre5">VALUES</em> is a table, it can be used as a filter argument for <em class="calibre5">CALCULATE</em>. As a result, <em class="calibre5">CALCULATE</em> applies a filter on the given column, restricting its values to those returned by <em class="calibre5">VALUES</em>. Look at the following code:</p>
<p class="codelink"><a href="#calibre_link-611" id="calibre_link-2282" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Pct All Sales CY :=
VAR CurrentCategorySales =
    [Sales Amount]
VAR AllSalesInCurrentYear =
    CALCULATE (
        [Sales Amount],
        ALL ( Sales ),
        <strong class="calibre7">VALUES ( 'Date'[Calendar Year] )</strong>
    )
VAR Ratio =
    DIVIDE (
        CurrentCategorySales,
        AllSalesInCurrentYear
    )
RETURN
    Ratio</pre></div>
<p class="edition">Once used in the report the measure accounts for 100% for every year, still computing the percentage against any other filter apart from the year. You see this in <a href="#calibre_link-612" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-18</a>.</p>
<figure id="calibre_link-612" class="image-l">
<img src="images/000688.jpg" alt="The report shows sales percentages over a few Calendar Years, per Category. This time the totals per year add up to 100%, showing that the sales percentages are considered at the year level for each category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-18</strong> By using <em class="calibre5">VALUES</em>, you can restore part of the filter context, reading it from the original filter context.</figcaption>
</figure>
<p class="edition"><a href="#calibre_link-613" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-19</a> depicts the full behavior of this complex formula.</p>
<figure id="calibre_link-613" class="image-l">
<img src="images/000695.jpg" alt="The report shows the previous figure counting sales percentages at the year level, alongside the code and symbols clarifying its behavior. A review of the diagram follows." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1779"></span><strong class="calibre7">Figure 5-19</strong> The key of this diagram is that <em class="calibre5">VALUES</em> is still evaluated in the original filter context.</figcaption>
</figure>
<p class="edition">Here is a review of the diagram:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The cell containing 4.22% (sales of Cell Phones for Calendar Year 2007) has a filter context that filters Cell phones for CY 2007.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">CALCULATE</em> has two filter arguments: <em class="calibre5">ALL ( Sales )</em> and <em class="calibre5">VALUES ( Date[Calendar Year] )</em>.</p>
<ul class="bull">
<li class="calibre10"><p class="listp"><em class="calibre5">ALL ( Sales )</em> removes the filter from the <em class="calibre5">Sales</em> table.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">VALUES ( Date[Calendar Year] )</em> evaluates the <em class="calibre5">VALUES</em> function in the original filter context, still affected by the presence of CY 2007 on the columns. As such, it returns the only year visible in the current filter context&mdash;that is, CY 2007.</p></li>
</ul></li>
</ul>
<p class="edition">The two filter arguments of <em class="calibre5">CALCULATE</em> are applied to the current filter context, resulting in a filter context that only contains a filter on <em class="calibre5">Calendar Year</em>. The denominator computes the total sales in a filter context with CY 2007 only.</p>
<p class="edition">It is of paramount importance to understand clearly that the filter arguments of <em class="calibre5">CALCULATE</em> are evaluated in the original filter context where <em class="calibre5">CALCULATE</em> is called. In fact, <em class="calibre5">CALCULATE</em> changes the filter context, but this only happens after the filter arguments are evaluated.</p>
<p class="edition">Using <em class="calibre5">ALL</em> over a table followed by <em class="calibre5">VALUES</em> over a column is a technique used to replace the filter context with a filter over that same column.</p>
<span type="pagebreak" id="calibre_link-1698"></span><div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The previous example could also have been obtained by using <em class="calibre5">ALLEXCEPT</em>. The semantics of <em class="calibre5">ALL/VALUES</em> is different from <em class="calibre5">ALLEXCEPT</em>. In <a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10</a>, “<a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with the filter context</a>,” you will see a complete description of the differences between the <em class="calibre5">ALLEXCEPT</em> and the <em class="calibre5">ALL/VALUES</em> techniques.</p>
</div>
<p class="edition">As you have seen in these examples, <em class="calibre5">CALCULATE</em>, in itself, is not a complex function. Its behavior is simple to describe. At the same time, as soon as you start using <em class="calibre5">CALCULATE</em>, the complexity of the code becomes much higher. Indeed, you need to focus on the filter context and understand exactly how <em class="calibre5">CALCULATE</em> generates the new filter context. A simple percentage hides a lot of complexity, and that complexity is all in the details. Before one really masters the handling of evaluation contexts, DAX is a bit of a mystery. The key to unlocking the full power of the language is all in mastering evaluation contexts. Moreover, in all these examples we only had to manage one <em class="calibre5">CALCULATE</em>. In a complex formula, having four or five different contexts in the same code is not unusual because of the presence of many instances of <em class="calibre5">CALCULATE</em>.</p>
<p class="edition">It is a good idea to read this whole section about percentages at least twice. In our experience, a second read is much easier and lets you focus on the important aspects of the code. We wanted to show this example to stress the importance of theory, when it comes to <em class="calibre5">CALCULATE</em>. A small change in the code has an important effect on the numbers computed by the formula. After your second read, proceed with the next sections where we focus more on theory than on practical examples.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-101" class="calibre13">Introducing <em class="calibre5">KEEPFILTERS</em></h4>
<p class="edition">You learned in the previous sections that the filter arguments of <em class="calibre5">CALCULATE</em> overwrite any previously existing filter on the same column. Thus, the following measure returns the sales of Audio regardless of any previously existing filter on <em class="calibre5">Product[Category]</em>:</p>
<p class="codelink"><a href="#calibre_link-614" id="calibre_link-2283" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Audio Sales :=
CALCULATE (
    [Sales Amount],
    'Product'[Category] = "Audio"
)</pre></div>
<p class="edition">As you can see in <a href="#calibre_link-615" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-20</a>, the value of Audio is repeated on all the rows of the report.</p>
<figure id="calibre_link-615" class="image-l">
<img src="images/000702.jpg" alt="The report shows Sales Amount and Audio Sales per Category. The Audio Sales column shows the same number on every row, which is the Sales Amount for Audio." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-20</strong> <em class="calibre5">Audio Sales</em> always shows the sales of Audio products, regardless of the current filter context.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1800"></span><em class="calibre5">CALCULATE</em> overwrites the existing filters on the columns where a new filter is applied. All the remaining columns of the filter context are left intact. In case you do not want to overwrite existing filters, you can wrap the filter argument with <em class="calibre5">KEEPFILTERS</em>. For example, if you want to show the amount of Audio sales when Audio is present in the filter context and a blank value if Audio is not present in the filter context, you can write the following measure:</p>
<p class="codelink"><a href="#calibre_link-616" id="calibre_link-2284" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Audio Sales KeepFilters :=
CALCULATE (
    [Sales Amount],
    KEEPFILTERS ( 'Product'[Category] = "Audio" )
)</pre></div>
<p class="edition"><em class="calibre5">KEEPFILTERS</em> is the second <em class="calibre5">CALCULATE</em> modifier that you learn&mdash;the first one was <em class="calibre5">ALL</em>. We further cover <em class="calibre5">CALCULATE</em> modifiers later in this chapter. <em class="calibre5">KEEPFILTERS</em> alters the way <em class="calibre5">CALCULATE</em> applies a filter to the new filter context. Instead of overwriting an existing filter over the same column, it adds the new filter to the existing ones. Therefore, only the cells where the filtered category was already included in the filter context will produce a visible result. You see this in <a href="#calibre_link-617" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-21</a>.</p>
<figure id="calibre_link-617" class="image-l">
<img src="images/000716.jpg" alt="The report shows Sales Amount, Audio Sales, and a new column—Audio Sales Keep Filters per Category. The last column only gives us the amount for the Audio Category. All other rows are blank." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-21</strong> <em class="calibre5">Audio Sales KeepFilters</em> shows the sales of Audio products only for the Audio row and for the Grand Total.</figcaption>
</figure>
<p class="edition"><em class="calibre5">KEEPFILTERS</em> does exactly what its name implies. Instead of overwriting the existing filter, it keeps the existing filter and adds the new filter to the filter context. We can depict the behavior with <a href="#calibre_link-618" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-22</a>.</p>
<figure id="calibre_link-618" class="image-l">
<img src="images/000723.jpg" alt="The figure shows the report, the code that generated it, and symbols clarifying that with KEEPFILTERS, the filter context adds the filter on Audio to the existing filter on Cell phones, for example." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3006"></span><strong class="calibre7">Figure 5-22</strong> The filter context generated with <em class="calibre5">KEEPFILTERS</em> filters at the same time as both Cell phones and Audio.</figcaption>
</figure>
<p class="edition">Because <em class="calibre5">KEEPFILTERS</em> avoids overwriting, the new filter generated by the filter argument of <em class="calibre5">CALCULATE</em> is added to the context. If we look at the cell for the <em class="calibre5">Audio Sales KeepFilters</em> measure in the Cell Phones row, there the resulting filter context contains two filters: one filters Cell Phones; the other filters Audio. The intersection of the two conditions results in an empty set, which produces a blank result.</p>
<p class="edition">The behavior of <em class="calibre5">KEEPFILTERS</em> is clearer when there are multiple elements selected in a column. For example, consider the following measures; they filter Audio and Computers with and without <em class="calibre5">KEEPFILTERS</em>:</p>
<p class="codelink"><a href="#calibre_link-619" id="calibre_link-2285" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Always Audio-Computers :=
CALCULATE (
    [Sales Amount],
    'Product'[Category] IN { "Audio", "Computers" }
)

KeepFilters Audio-Computers :=
CALCULATE (
    [Sales Amount],
    KEEPFILTERS ( 'Product'[Category] IN { "Audio", "Computers" } )
)</pre></div>
<p class="edition">The report in <a href="#calibre_link-620" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-23</a> shows that the version with <em class="calibre5">KEEPFILTERS</em> only computes the sales amount values for Audio and for Computers, leaving all other categories blank. The Total row only takes Audio and Computers into account.</p>
<figure id="calibre_link-620" class="image-l">
<img src="images/000730.jpg" alt="The report shows Sales Amount, Always Audio-Computers and KeepFilters Audio-Computers, for each Category. On each and every row of Always Audio-Computers we see the number found as the total of Audio and Computers only. However, KeepFilters Audio-Computers only shows the sales for Audio on the Audio row, and for Computers on the Computers row. Everything else is blank in that column." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1794"></span><strong class="calibre7">Figure 5-23</strong> Using <em class="calibre5">KEEPFILTERS</em>, the original and the new filter contexts are merged together.</figcaption>
</figure>
<p class="edition"><em class="calibre5">KEEPFILTERS</em> can be used either with a predicate or with a table. Indeed, the previous code could also be written in a more verbose way:</p>
<p class="codelink"><a href="#calibre_link-621" id="calibre_link-2286" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">KeepFilters Audio-Computers :=
CALCULATE (
    [Sales Amount],
    KEEPFILTERS (
        FILTER (
            ALL ( 'Product'[Category] ),
            'Product'[Category] IN { "Audio", "Computers" }
        )
    )
)</pre></div>
<p class="edition">This is just an example for educational purposes. You should use the simplest predicate syntax available for a filter argument. When filtering a single column, you can avoid writing the <em class="calibre5">FILTER</em> explicitly. Later however, you will see that more complex filter conditions require an explicit <em class="calibre5">FILTER</em>. In those cases, the <em class="calibre5">KEEPFILTERS</em> modifier can be used around the explicit <em class="calibre5">FILTER</em> function, as you see in the next section.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-102" class="calibre13">Filtering a single column</h4>
<p class="edition">In the previous section, we introduced filter arguments referencing a single column in <em class="calibre5">CALCULATE</em>. It is important to note that you can have multiple references to the same column in one expression. For example, the following is a valid syntax because it references the same column (<em class="calibre5">Sales[Net Price]</em>) twice.</p>
<p class="codelink"><a href="#calibre_link-622" id="calibre_link-2287" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales 10-100 :=
CALCULATE (
    [Sales Amount],
    Sales[Net Price] &gt;= 10 &amp;&amp; Sales[Net Price] &lt;= 100
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1795"></span>In fact, this is converted into the following syntax:</p>
<p class="codelink"><a href="#calibre_link-623" id="calibre_link-2288" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales 10-100 :=
CALCULATE (
    [Sales Amount],
    FILTER (
        ALL ( Sales[Net Price] ),
        Sales[Net Price] &gt;= 10 &amp;&amp; Sales[Net Price] &lt;= 100
    )
)</pre></div>
<p class="edition">The resulting filter context produced by <em class="calibre5">CALCULATE</em> only adds one filter over the <em class="calibre5">Sales[Net Price]</em> column. One important note about predicates as filter arguments in <em class="calibre5">CALCULATE</em> is that although they look like conditions, they are tables. If you read the first of the last two code snippets, it looks as though <em class="calibre5">CALCULATE</em> evaluates a condition. Instead, <em class="calibre5">CALCULATE</em> evaluates the list of all the values of <em class="calibre5">Sales[Net Price]</em> that satisfy the condition. Then, <em class="calibre5">CALCULATE</em> uses this table of values to apply a filter to the model.</p>
<p class="edition">When two conditions are in a logical <em class="calibre5">AND</em>, they can be represented as two separate filters. Indeed, the previous expression is equivalent to the following one:</p>
<div class="program"><pre class="calibre14">Sales 10-100 :=
CALCULATE (
    [Sales Amount],
    Sales[Net Price] &gt;= 10,
    Sales[Net Price] &lt;= 100
)</pre></div>
<p class="edition">However, keep in mind that the multiple filter arguments of <em class="calibre5">CALCULATE</em> are always merged with a logical <em class="calibre5">AND</em>. Thus, you must use a single filter in case of a logical <em class="calibre5">OR</em> statement, such as in the following measure:</p>
<p class="codelink"><a href="#calibre_link-624" id="calibre_link-2289" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Blue+Red :=
CALCULATE (
    [Sales Amount],
    'Product'[Color] = "Red" || 'Product'[Color] = "Blue"
)</pre></div>
<p class="edition">By writing multiple filters, you would combine two independent filters in a single filter context. The following measure always produces a blank result because there are no products that are both Blue and Red at the same time:</p>
<div class="program"><pre class="calibre14">Sales Blue and Red :=
CALCULATE (
    [Sales Amount],
    'Product'[Color] = "Red",
    'Product'[Color] = "Blue"
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1792"></span>In fact, the previous measure corresponds to the following measure with a single filter:</p>
<p class="codelink"><a href="#calibre_link-625" id="calibre_link-2290" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Blue and Red :=
CALCULATE (
    [Sales Amount],
    'Product'[Color] = "Red" &amp;&amp; 'Product'[Color] = "Blue"
)</pre></div>
<p class="edition">The filter argument always returns an empty list of colors allowed in the filter context. Therefore, the measure always returns a blank value.</p>
<p class="edition">Whenever a filter argument refers to a single column, you can use a predicate. We suggest you do so because the resulting code is much easier to read. You should do so for logical <em class="calibre5">AND</em> conditions too. Nevertheless, never forget that you are relying on syntax-sugaring only. <em class="calibre5">CALCULATE</em> always works with tables, although the compact syntax might suggest otherwise.</p>
<p class="edition">On the other hand, whenever there are two or more different column references in a filter argument, it is necessary to write the <em class="calibre5">FILTER</em> condition as a table expression. You learn this in the following section.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-103" class="calibre13">Filtering with complex conditions</h4>
<p class="edition">A filter argument referencing multiple columns requires an explicit table expression. It is important to understand the different techniques available to write such filters. Remember that creating a filter with the minimum number of columns required by the predicate is usually a best practice.</p>
<p class="edition">Consider a measure that sums the sales for only the transactions with an amount greater than or equal to 1,000. Getting the amount of each transaction requires the multiplication of the <em class="calibre5">Quantity</em> and <em class="calibre5">Net Price</em> columns. This is because you do not have a column that stores that amount for each row of the <em class="calibre5">Sales</em> table in the sample Contoso database. You might be tempted to write something like the following expression, which unfortunately will not work:</p>
<p class="codelink"><a href="#calibre_link-626" id="calibre_link-2291" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Large Amount :=
CALCULATE (
    [Sales Amount],
    Sales[Quantity] * Sales[Net Price] &gt;= 1000
)</pre></div>
<p class="edition">This code is not valid because the filter argument references two different columns in the same expression. As such, it cannot be converted automatically by DAX into a suitable <em class="calibre5">FILTER</em> condition. The best way to write the required filter is by using a table that only has the existing combinations of the columns referenced in the predicate:</p>
<p class="codelink"><a href="#calibre_link-627" id="calibre_link-2292" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Large Amount :=
CALCULATE (
    [Sales Amount],
    FILTER (
        ALL ( Sales[Quantity], Sales[Net Price] ),
        Sales[Quantity] * Sales[Net Price] &gt;= 1000
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3007"></span>This results in a filter context that has a filter with two columns and a number of rows that correspond to the unique combinations of <em class="calibre5">Quantity</em> and <em class="calibre5">Net Price</em> that satisfy the filter condition. This is shown in <a href="#calibre_link-628" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-24</a>.</p>
<figure id="calibre_link-628" class="image-l">
<img src="images/000737.jpg" alt="The figure shows two columns, Quantity and Net Price. Through filtering, all that are displayed are combinations of Quantity and Net Price that multiply to be greater than or equal to 1,000." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-24</strong> The multi-column filter only includes combinations of <em class="calibre5">Quantity</em> and <em class="calibre5">Net Price</em> producing a result greater than or equal to 1,000.</figcaption>
</figure>
<p class="edition">This filter produces the result in <a href="#calibre_link-629" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-25</a>.</p>
<figure id="calibre_link-629" class="image-l">
<img src="images/000744.jpg" alt="The figure shows a slicer on the left for Net Price, as well as a report with Sales Amount and Sales Large Amount, per Category. Sales Large Amount only reports on transactions greater than 1,000. Games and Toys returns a blank under Sales Large Amount." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-25</strong> <em class="calibre5">Sales Large Amount</em> only shows sales of transactions with a large amount.</figcaption>
</figure>
<p class="edition">Be mindful that the slicer in <a href="#calibre_link-629" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-25</a> is not filtering any value: The two displayed values are the minimum and the maximum values of <em class="calibre5">Net Price</em>. The next step is showing how the measure is interacting with the slicer. In a measure like <em class="calibre5">Sales Large Amount</em>, you need to pay attention when you overwrite existing filters over <em class="calibre5">Quantity</em> or <em class="calibre5">Net Price</em>. Indeed, because the filter argument uses <em class="calibre5">ALL</em> on the two columns, it ignores any previously existing filter on the same columns including, in this example, the filter of the slicer. The report in <a href="#calibre_link-630" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-26</a> is the same as <a href="#calibre_link-629" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-25</a> but, this time, the slicer filters for net prices between 500 and 3,000. The result is surprising.</p>
<figure id="calibre_link-630" class="image-l">
<img src="images/000751.jpg" alt="This time the slicer is being used, filtering between 500 and 3,000. The report shows surprising data. Some amounts in the Sales Large Amount column are higher than their counterparts in Sales Amount, and some rows in Sales Amount are blank. Games and Toys is nowhere to be found." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1797"></span><strong class="calibre7">Figure 5-26</strong> There are no sales for Audio in the current price range; still <em class="calibre5">Sales Large Amount</em> is showing a result.</figcaption>
</figure>
<p class="edition">The presence of value of <em class="calibre5">Sales Large Amount</em> for Audio and Music, Movies and Audio Books is unexpected. Indeed, for these two categories there are no sales in the net price range between 500 and 3,000, which is the filter context generated by the slicer. Still, the <em class="calibre5">Sales Large Amount</em> measure is showing a result.</p>
<p class="edition">The reason is that the filter context of <em class="calibre5">Net Price</em> created by the slicer is ignored by the <em class="calibre5">Sales Large Amount</em> measure, which overwrites the existing filter over both <em class="calibre5">Quantity</em> and <em class="calibre5">Net Price</em>. If you carefully compare <a href="#calibre_link-629" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">figures 5-25</a> and 5-26, you will notice that the value of <em class="calibre5">Sales Large Amount</em> is identical, as if the slicer was not added to the report. Indeed, <em class="calibre5">Sales Large Amount</em> is completely ignoring the slicer.</p>
<p class="edition">If you focus on a cell, like the value of <em class="calibre5">Sales Large Amount</em> for Audio, the code executed to compute its value is the following:</p>
<p class="codelink"><a href="#calibre_link-631" id="calibre_link-2293" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Large Amount :=
CALCULATE (
    CALCULATE (
        [Sales Amount],
        FILTER (
            ALL ( Sales[Quantity], Sales[Net Price] ),
            Sales[Quantity] * Sales[Net Price] &gt;= 1000
        )
    ),
    'Product'[Category] = "Audio",
    Sales[Net Price] &gt;= 500
)</pre></div>
<p class="edition">From the code, you can see that the innermost <em class="calibre5">ALL</em> ignores the filter on <em class="calibre5">Sales[Net Price]</em> set by the outer <em class="calibre5">CALCULATE</em>. In that scenario, you can use <em class="calibre5">KEEPFILTERS</em> to avoid the overwrite of existing filters:</p>
<p class="codelink"><a href="#calibre_link-632" id="calibre_link-2294" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Large Amount KeepFilter :=
CALCULATE (
    [Sales Amount],
    KEEPFILTERS (
        FILTER (
            ALL ( Sales[Quantity], Sales[Net Price] ),
            Sales[Quantity] * Sales[Net Price] &gt;= 1000
        )
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1793"></span>The new <em class="calibre5">Sales Large Amount KeepFilter</em> measure produces the result shown in <a href="#calibre_link-633" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-27</a>.</p>
<figure id="calibre_link-633" class="image-l">
<img src="images/000758.jpg" alt="The figure shows the Net Price slicer filtering between $500 and $3,000, as well as the report with Sales Large Amount KeepFilter added to the columns from before. The numbers are making sense." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-27</strong> Using <em class="calibre5">KEEPFILTERS</em>, the calculation takes into account the outer slicer too.</figcaption>
</figure>
<p class="edition">Another way of specifying a complex filter is by using a table filter instead of a column filter. This is one of the preferred techniques of DAX newbies, although it is very dangerous to use. In fact, the previous measure can be written using a table filter:</p>
<p class="codelink"><a href="#calibre_link-634" id="calibre_link-2295" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Large Amount Table :=
CALCULATE (
    [Sales Amount],
    FILTER (
        Sales,
        Sales[Quantity] * Sales[Net Price] &gt;= 1000
    )
)</pre></div>
<p class="edition">As you may remember, all the filter arguments of <em class="calibre5">CALCULATE</em> are evaluated in the filter context that exists outside of the <em class="calibre5">CALCULATE</em> itself. Thus, the iteration over <em class="calibre5">Sales</em> only considers the rows filtered in the existing filter context, which contains a filter on <em class="calibre5">Net Price</em>. Therefore, the semantic of the <em class="calibre5">Sales Large Amount Table</em> measure corresponds to the <em class="calibre5">Sales Large Amount KeepFilter</em> measure.</p>
<p class="edition">Although this technique looks easy, you should be careful in using it because it could have serious consequences on performance and on result accuracy. We will cover the details of these issues in <a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a>. For now, just remember that the best practice is to always use a filter with the smallest possible number of columns.</p>
<p class="edition">Moreover, you should avoid table filters because they usually are more expensive. The <em class="calibre5">Sales</em> table might be very large, and scanning it row by row to evaluate a predicate can be a time-consuming operation. The filter in <em class="calibre5">Sales Large Amount KeepFilter</em>, on the other hand, only iterates the number of unique combinations of <em class="calibre5">Quantity</em> and <em class="calibre5">Net Price</em>. That number is usually much smaller than the number of rows of the entire <em class="calibre5">Sales</em> table.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-104" class="calibre13"><span type="pagebreak" id="calibre_link-1787"></span>Evaluation order in <em class="calibre5">CALCULATE</em></h4>
<p class="edition">Whenever you look at DAX code, the natural order of evaluation is innermost first. For example, look at the following expression:</p>
<p class="codelink"><a href="#calibre_link-635" id="calibre_link-2296" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount Large :=
SUMX (
    FILTER ( Sales, Sales[Quantity] &gt;= 100 ),
    Sales[Quantity] * Sales[Net Price]
)</pre></div>
<p class="edition">DAX needs to evaluate the result of <em class="calibre5">FILTER</em> before starting the evaluation of <em class="calibre5">SUMX</em>. In fact, <em class="calibre5">SUMX</em> iterates a table. Because that table is the result of <em class="calibre5">FILTER</em>, <em class="calibre5">SUMX</em> cannot start executing before <em class="calibre5">FILTER</em> has finished its job. This rule is true for all DAX functions, except for <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em>. Indeed, <em class="calibre5">CALCULATE</em> evaluates its filter arguments first and only at the end does it evaluate the first parameter, which is the expression to evaluate to provide the <em class="calibre5">CALCULATE</em> result.</p>
<p class="edition">Moreover, things are a bit more intricate because <em class="calibre5">CALCULATE</em> changes the filter context. All the filter arguments are executed in the filter context outside of <em class="calibre5">CALCULATE</em>, and each filter is evaluated independently. The order of filters within the same <em class="calibre5">CALCULATE</em> does not matter. Consequently, all the following measures are completely equivalent:</p>
<p class="codelink"><a href="#calibre_link-636" id="calibre_link-2297" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Red Contoso :=
CALCULATE (
    [Sales Amount],
    'Product'[Color] = "Red",
    KEEPFILTERS ( 'Product'[Brand] = "Contoso" )
)

Sales Red Contoso :=
CALCULATE (
    [Sales Amount],
    KEEPFILTERS ( 'Product'[Brand] = "Contoso" ),
    'Product'[Color] = "Red"
)

Sales Red Contoso :=
VAR ColorRed =
        FILTER (
            ALL ( 'Product'[Color] ),
            'Product'[Color] = "Red"
        )
VAR BrandContoso =
        FILTER (
            ALL ( 'Product'[Brand] ),
            'Product'[Brand] = "Contoso"
        )
<span type="pagebreak" id="calibre_link-3008"></span>VAR SalesRedContoso =
    CALCULATE (
        [Sales Amount],
        ColorRed,
        KEEPFILTERS ( BrandContoso )
    )
RETURN
    SalesRedContoso</pre></div>
<p class="edition">The version of <em class="calibre5">Sales Red Contoso</em> defined using variables is more verbose than the other versions, but you might want to use it in case the filters are complex expressions with explicit filters. This way, it is easier to understand that the filter is evaluated “before” <em class="calibre5">CALCULATE</em>.</p>
<p class="edition">This rule becomes more important in case of nested <em class="calibre5">CALCULATE</em> statements. In fact, the outermost filters are applied first, and the innermost are applied later. Understanding the behavior of nested <em class="calibre5">CALCULATE</em> statements is important, because you encounter this situation every time you nest measures calls. For example, consider the following measures, where <em class="calibre5">Sales Green</em> calls <em class="calibre5">Sales Red</em>:</p>
<p class="codelink"><a href="#calibre_link-637" id="calibre_link-2298" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Red :=
CALCULATE (
    [Sales Amount],
    'Product'[Color] = "Red"
)

Green calling Red :=
CALCULATE (
    [Sales Red],
    'Product'[Color] = "Green"
)</pre></div>
<p class="edition">To make the nested measure call more evident, we can expand <em class="calibre5">Sales Green</em> this way:</p>
<p class="codelink"><a href="#calibre_link-638" id="calibre_link-2299" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Green calling Red Exp :=
CALCULATE (
    CALCULATE (
        [Sales Amount],
        'Product'[Color] = "Red"
    ),
    'Product'[Color] = "Green"
)</pre></div>
<p class="edition">The order of evaluation is the following:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">First, the outer <em class="calibre5">CALCULATE</em> applies the filter, <em class="calibre5">Product[Color] = “Green”</em>.</p></li>
<li class="calibre25"><p class="listp">Second, the inner <em class="calibre5">CALCULATE</em> applies the filter, <em class="calibre5">Product[Color] = “Red”</em>. This filter overwrites the previous filter.</p></li>
<li class="calibre25"><p class="listp">Last, DAX computes <em class="calibre5">[Sales Amount]</em> with a filter for <em class="calibre5">Product[Color] = “Red”</em>.</p></li>
</ol>
<p class="edition">Therefore, the result of both <em class="calibre5">Red</em> and <em class="calibre5">Green calling Red</em> is still Red, as shown in <a href="#calibre_link-639" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-28</a>.</p>
<figure id="calibre_link-639" class="image-l">
<img src="images/000765.jpg" alt="The report shows Sales Amount, Red, Green calling Red and Green calling Red Exp, per Category. We notice that the last three measures return the same result, which is the sales of red products Category by Category." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1796"></span><strong class="calibre7">Figure 5-28</strong> The last three measures return the same result, which is always the sales of red products.</figcaption>
</figure>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The description we provided is for educational purposes only. In reality the engine uses lazy evaluation for the filter context. So, in the presence of filter argument overwrites such as the previous code, the outer filter might never be evaluated because it would have been useless. Nevertheless, this behavior is for optimization only. It does not change the semantics of <em class="calibre5">CALCULATE</em> in any way.</p>
</div>
<p class="edition">We can review the order of the evaluation and how the filter context is evaluated with another example. Consider the following measure:</p>
<p class="codelink"><a href="#calibre_link-640" id="calibre_link-2300" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales YB :=
CALCULATE (
    CALCULATE (
        [Sales Amount],
        'Product'[Color] IN { "Yellow", "Black" }
    ),
    'Product'[Color] IN { "Black", "Blue" }
)</pre></div>
<p class="edition">The evaluation of the filter context produced by <em class="calibre5">Sales YB</em> is visible in <a href="#calibre_link-641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-29</a>.</p>
<p class="edition">As seen before, the innermost filter over <em class="calibre5">Product[Color]</em> overwrites the outermost filters. Therefore, the result of the measure shows the sum of products that are Yellow or Black. By using <em class="calibre5">KEEPFILTERS</em> in the innermost <em class="calibre5">CALCULATE</em>, the filter context is built by keeping the two filters instead of overwriting the existing filter:</p>
<p class="codelink"><a href="#calibre_link-642" id="calibre_link-2301" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales YB KeepFilters :=
CALCULATE (
    CALCULATE (
        [Sales Amount],
        KEEPFILTERS ( 'Product'[Color] IN { "Yellow", "Black" } )
    ),
    'Product'[Color] IN { "Black", "Blue" }
)</pre></div>
<figure id="calibre_link-641" class="image-l">
<img src="images/000772.jpg" alt="The figure shows the overwrite happening from the inner filter to the outer filter. The snippet of code points to which filter overwrites the other." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3009"></span><strong class="calibre7">Figure 5-29</strong> The innermost filter overwrites the outer filter.</figcaption>
</figure>
<p class="edition">The evaluation of the filter context produced by <em class="calibre5">Sales YB KeepFilters</em> is visible in <a href="#calibre_link-643" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-30</a>.</p>
<figure id="calibre_link-643" class="image-l">
<img src="images/000779.jpg" alt="The figure shows the snippet of code, pointing to the fact that KEEPFILTER merges both filter contexts." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-30</strong> By using <em class="calibre5">KEEPFILTERS</em>, <em class="calibre5">CALCULATE</em> does not overwrite the previous filter context.</figcaption>
</figure>
<p class="edition">Because the two filters are kept together, they are intersected. Therefore, in the new filter context the only visible color is Black because it is the only value present in both filters.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1780"></span>However, the order of the filter arguments within the same <em class="calibre5">CALCULATE</em> is irrelevant because they are applied to the filter context independently.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-105" class="h2a">Understanding context transition</h3>
<p class="edition">In <a href="#calibre_link-9" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 4</a>, “<a href="#calibre_link-9" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding evaluation contexts</a>,” we evoked multiple times that the row context and the filter context are different concepts. This still holds true. However, there is one operation performed by <em class="calibre5">CALCULATE</em> that can transform a row context into a filter context. It is the operation of <em class="calibre5">context transition</em>, defined as follows:</p>
<blockquote class="calibre23">
<p class="noindent"><em class="calibre5">CALCULATE invalidates any row context. It automatically adds as filter arguments all the columns that are currently being iterated in any row context&mdash;filtering their actual value in the row being iterated</em>.</p>
</blockquote>
<p class="edition">Context transition is hard to understand at the beginning, and even seasoned DAX coders find it complex to follow all the implications of context transition. We are more than confident that the previous definition does not suffice to fully understand context transition.</p>
<p class="edition">Therefore, we are going to describe context transition through several examples of increasing complexity. But before discussing such a delicate concept, let us make sure we thoroughly understand row context and filter context.</p>
<section class="calibre4">
<h4 id="calibre_link-106" class="calibre13">Row context and filter context recap</h4>
<p class="edition">We can recap some important facts about row context and filter context with the aid of <a href="#calibre_link-644" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-31</a>, which shows a report with the <em class="calibre5">Brand</em> on the rows and a diagram describing the evaluation process. <em class="calibre5">Products</em> and <em class="calibre5">Sales</em> in the diagram are not displaying real data. They only contain a few rows to make the points clearer.</p>
<figure id="calibre_link-644" class="image-l">
<img src="images/000786.jpg" alt="The diagram shows the report, the code that generated it, as well as how filter context and row context work together in the evaluation process." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-31</strong> The diagram depicts the full flow of execution of a simple iteration with <em class="calibre5">SUMX</em>.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3010"></span>The following comments on <a href="#calibre_link-644" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-31</a> are helpful to monitor your understanding of the whole process for evaluating the <em class="calibre5">Sales Amount</em> measure for the Contoso row:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The report creates a filter context containing a filter for <em class="calibre5">Product[Brand] = “Contoso”</em>.</p></li>
<li class="calibre10"><p class="listp">The filter works on the entire model, filtering both the <em class="calibre5">Product</em> and the <em class="calibre5">Sales</em> tables.</p></li>
<li class="calibre10"><p class="listp">The filter context reduces the number of rows iterated by <em class="calibre5">SUMX</em> while scanning <em class="calibre5">Sales</em>. <em class="calibre5">SUMX</em> only iterates the <em class="calibre5">Sales</em> rows that are related to a Contoso product.</p></li>
<li class="calibre10"><p class="listp">In the figure there are two rows in <em class="calibre5">Sales</em> with product A, which is branded Contoso.</p></li>
<li class="calibre10"><p class="listp">Consequently, <em class="calibre5">SUMX</em> iterates two rows. In the first row it computes 1*11.00 with a partial result of 11.00. In the second row it computes 2*10.99 with a partial result of 21.98.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">SUMX</em> returns the sum of the partial results gathered during the iteration.</p></li>
<li class="calibre10"><p class="listp">During the iteration of <em class="calibre5">Sales</em>, <em class="calibre5">SUMX</em> only scans the visible portion of the <em class="calibre5">Sales</em> table, generating a row context for each visible row.</p></li>
<li class="calibre10"><p class="listp">When <em class="calibre5">SUMX</em> iterates the first row, <em class="calibre5">Sales[Quantity]</em> equals 1, whereas <em class="calibre5">Sales[Net Price]</em> equals 11. On the second row, the values are different. Columns have a current value that depends on the iterated row. Potentially, each row iterated has a different value for all the columns.</p></li>
<li class="calibre10"><p class="listp">During the iteration, there is a row context and a filter context. The filter context is still the same that filters Contoso because no <em class="calibre5">CALCULATE</em> has been executed to modify it.</p></li>
</ul>
<p class="edition">Speaking about context transition, the last statement is the most important. During the iteration the filter context is still active, and it filters Contoso. The row context, on the other hand, is currently iterating the <em class="calibre5">Sales</em> table. Each column of <em class="calibre5">Sales</em> has a given value. The row context is providing the value via the current row. Remember that the row context iterates; the filter context does not.</p>
<p class="edition">This is an important detail. We invite you to double-check your understanding in the following scenario. Imagine you create a measure that simply counts the number of rows in the <em class="calibre5">Sales</em> table, with the following code:</p>
<p class="codelink"><a href="#calibre_link-645" id="calibre_link-2302" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NumOfSales := COUNTROWS ( Sales )</pre></div>
<p class="edition">Once used in the report, the measure counts the number of <em class="calibre5">Sales</em> rows that are visible in the current filter context. The result shown in <a href="#calibre_link-646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-32</a> is as expected: a different number for each brand.</p>
<figure id="calibre_link-646" class="image-l">
<img src="images/000793.jpg" alt="The report shows NumOfSales per Brand. The numbers make sense." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3011"></span><strong class="calibre7">Figure 5-32</strong> <em class="calibre5">NumOfSales</em> counts the number of rows visible in the current filter context in the <em class="calibre5">Sales</em> table.</figcaption>
</figure>
<p class="edition">Because there are 37,984 rows in <em class="calibre5">Sales</em> for the Contoso brand, this means that an iteration over <em class="calibre5">Sales</em> for Contoso will iterate exactly 37,984 rows. The <em class="calibre5">Sales Amount</em> measure we used so far would complete its execution after 37,984 multiplications.</p>
<p class="edition">With the understanding you have obtained so far, can you guess the result of the following measure on the Contoso row?</p>
<p class="codelink"><a href="#calibre_link-647" id="calibre_link-2303" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sum Num Of Sales := SUMX ( Sales, COUNTROWS ( Sales ) )</pre></div>
<p class="edition">Do not rush in deciding your answer. Take your time, study this simple code carefully, and make an educated guess. In the following paragraph we provide the correct answer.</p>
<p class="edition">The filter context is filtering Contoso. From the previous examples, it is understood that <em class="calibre5">SUMX</em> iterates 37,984 times. For each of these 37,984 rows, <em class="calibre5">SUMX</em> computes the number of rows visible in <em class="calibre5">Sales</em> in the current filter context. The filter context is still the same, so for each row the result of <em class="calibre5">COUNTROWS</em> is always 37,984. Consequently, <em class="calibre5">SUMX</em> sums the value of 37,984 for 37,984 times. The result is 37,984 squared. You can confirm this by looking at <a href="#calibre_link-648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-33</a>, where the measure is displayed in the report.</p>
<figure id="calibre_link-648" class="image-l">
<img src="images/000801.jpg" alt="The report shows NumOfSales and Sum Num Of Sales, per Brand. The values for Sum Num Of Sales are the square values of NumOfSales." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1781"></span><strong class="calibre7">Figure 5-33</strong> <em class="calibre5">Sum Num Of Sales</em> computes <em class="calibre5">NumOfSales</em> squared because it counts all the rows for each iteration.</figcaption>
</figure>
<p class="edition">Now that we have refreshed the main ideas about row context and filter context, we can further discuss the impact of context transition.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-107" class="calibre13">Introducing context transition</h4>
<p class="edition">A row context exists whenever an iteration is happening on a table. Inside an iteration are expressions that depend on the row context itself. The following expression, which you have studied multiple times by now, comes in handy:</p>
<p class="codelink"><a href="#calibre_link-649" id="calibre_link-2304" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX (
    Sales,
    Sales[Quantity] * Sales[Unit Price]
)</pre></div>
<p class="edition">The two columns <em class="calibre5">Quantity</em> and <em class="calibre5">Unit Price</em> have a value in the current row context. In the previous section we showed that if the expression used inside an iteration is not strictly bound to the row context, then it is evaluated in the filter context. As such the results are surprising, at least for beginners. Nevertheless, one is completely free to use any function inside a row context. Among the many functions available, one appears to be more special: <em class="calibre5">CALCULATE</em>.</p>
<p class="edition">If executed in a row context, <em class="calibre5">CALCULATE</em> invalidates the row context before evaluating its expression. Inside the expression evaluated by <em class="calibre5">CALCULATE</em>, all the previous row contexts will no longer be valid. Thus, the following code produces a syntax error:</p>
<p class="codelink"><a href="#calibre_link-650" id="calibre_link-2305" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX (
    Sales,
    CALCULATE ( Sales[Quantity] )   -- No row context inside CALCULATE, ERROR !
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3012"></span>The reason is that the value of the <em class="calibre5">Sales[Quantity]</em> column cannot be retrieved inside <em class="calibre5">CALCULATE</em> because <em class="calibre5">CALCULATE</em> invalidates the row context that exists outside of <em class="calibre5">CALCULATE</em> itself. Nevertheless, this is only part of what context transition performs. The second&mdash;and most relevant&mdash;operation is that <em class="calibre5">CALCULATE</em> adds as filter arguments all the columns of the current row context with their current value. For example, look at the following code:</p>
<p class="codelink"><a href="#calibre_link-651" id="calibre_link-2306" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX (
    Sales,
    CALCULATE ( SUM ( Sales[Quantity] ) ) -- SUM does not require a row context
)</pre></div>
<p class="edition">There are no filter arguments in <em class="calibre5">CALCULATE</em>. The only <em class="calibre5">CALCULATE</em> argument is the expression to evaluate. Thus, it looks like <em class="calibre5">CALCULATE</em> will not overwrite the existing filter context. The point is that <em class="calibre5">CALCULATE</em>, because of context transition, is silently creating many filter arguments. It creates a filter for each column in the iterated table. You can use <a href="#calibre_link-652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-34</a> to obtain a first look at the behavior of context transition. We used a reduced set of columns for visual purposes.</p>
<figure id="calibre_link-652" class="image-l">
<img src="images/000808.jpg" alt="The figure explains context transition. The code is used to point out row and filter contexts. The result of SUMX is 5." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-34</strong> When <em class="calibre5">CALCULATE</em> is executed in a row context, it creates a filter context with a filter for each of the columns in the currently iterated table.</figcaption>
</figure>
<p class="edition">During the iteration <em class="calibre5">CALCULATE</em> starts on the first row, and it computes <em class="calibre5">SUM ( Sales[Quantity] )</em>. Even though there are no filter arguments, <em class="calibre5">CALCULATE</em> adds one filter argument for each of the columns of the iterated table. Namely, there are three columns in the example: <em class="calibre5">Product</em>, <em class="calibre5">Quantity</em>, and <em class="calibre5">Net Price</em>. As a result, the filter context generated by the context transition contains the current value (A, 1, 11.00) for each of the columns (<em class="calibre5">Product</em>, <em class="calibre5">Quantity</em>, <em class="calibre5">Net Price</em>). The process, of course, continues for each one of the three rows during the iteration made by <em class="calibre5">SUMX</em>.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3013"></span>In other words, the execution of the previous <em class="calibre5">SUMX</em> results in these three <em class="calibre5">CALCULATE</em> executions:</p>
<p class="codelink"><a href="#calibre_link-653" id="calibre_link-2307" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    SUM ( Sales[Quantity] ),
    Sales[Product] = "A",
    Sales[Quantity] = 1,
    Sales[Net Price] = 11
) +
CALCULATE (
    SUM ( Sales[Quantity] ),
    Sales[Product] = "B",
    Sales[Quantity] = 2,
    Sales[Net Price] = 25
) +
CALCULATE (
    SUM ( Sales[Quantity] ),
    Sales[Product] = "A",
    Sales[Quantity] = 2,
    Sales[Net Price] = 10.99
)</pre></div>
<p class="edition">These filter arguments are hidden. They are added by the engine automatically, and there is no way to avoid them. In the beginning, context transition seems very strange. Nevertheless, once one gets used to context transition, it is an extremely powerful feature. Hard to master, but extremely powerful.</p>
<p class="edition">We summarize the considerations presented earlier, before we further discuss a few of them specifically:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Context transition is expensive.</strong> If context transition is used during an iteration on a table with 10 columns and one million rows, then <em class="calibre5">CALCULATE</em> needs to apply 10 filters, one million times. No matter what, it will be a slow operation. This is not to say that relying on context transition should be avoided. However, it does make <em class="calibre5">CALCULATE</em> a feature that needs to be used carefully.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Context transition does not only filter one row.</strong> The original row context existing outside of <em class="calibre5">CALCULATE</em> always only points to one row. The row context iterates on a row-by-row basis. When the row context is moved to a filter context through context transition, the newly created filter context filters all the rows with the same set of values. Thus, you should not assume that the context transition creates a filter context with one row only. This is very important, and we will return to this topic in the next sections.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Context transition uses columns that are not present in the formula.</strong> Although the columns used in the filter are hidden, they are part of the expression. This makes any formula with <em class="calibre5">CALCULATE</em> much more complex than it first seems. If a context transition is used, then all the columns of the table are part of the expression as hidden filter arguments. This behavior might create unexpected dependencies. This topic is also described later in this section.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-1782"></span><strong class="calibre7">Context transition creates a filter context out of a row context.</strong> You might remember the evaluation context mantra, “the row context iterates a table, whereas the filter context filters the model.” Once context transition transforms a row context into a filter context, it changes the nature of the filter. Instead of iterating a single row, DAX filters the whole model; relationships become part of the equation. In other words, context transition happening on one table might propagate its filtering effects far from the table the row context originated from.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Context transition is invoked whenever there is a row context.</strong> For example, if one uses <em class="calibre5">CALCULATE</em> in a calculated column, context transition occurs. There is an automatic row context inside a calculated column, and this is enough for context transition to occur.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Context transition transforms all the row contexts.</strong> When nested iterations are being performed on multiple tables, context transition considers all the row contexts. It invalidates all of them and adds filter arguments for all the columns that are currently being iterated by all the active row contexts.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Context transition invalidates the row contexts.</strong> Though we have repeated this concept multiple times, it is worth bringing to your attention again. None of the outer row contexts are valid inside the expression evaluated by <em class="calibre5">CALCULATE</em>. All the outer row contexts are transformed into equivalent filter contexts.</p></li>
</ul>
<p class="edition">As anticipated earlier in this section, most of these considerations require further explanation. In the remaining part of this section about context transition, we provide a deeper analysis of these main points. Although all these considerations are shown as warnings, in reality they are important features. Being ignorant of certain behaviors can ensure surprising results. Nevertheless, once you master the behavior, you start leveraging it as you see fit. The only difference between a strange behavior and a useful feature&mdash;at least in DAX&mdash;is your level of knowledge.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-108" class="calibre13">Context transition in calculated columns</h4>
<p class="edition">A calculated column is evaluated in a row context. Therefore, using <em class="calibre5">CALCULATE</em> in a calculated column triggers a context transition. We use this feature to create a calculated column in <em class="calibre5">Product</em> that marks as “High Performance” all the products that&mdash;alone&mdash;sold more than 1% of the total sales of all the products.</p>
<p class="edition">To produce this calculated column, we need two values: the sales of the current product and the total sales of all the products. The former requires filtering the <em class="calibre5">Sales</em> table so that it only computes sales amount for the current product, whereas the latter requires scanning the <em class="calibre5">Sales</em> table with no active filters. Here is the code:</p>
<p class="codelink"><a href="#calibre_link-654" id="calibre_link-2308" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[Performance] =
VAR TotalSales =                               -- Sales of all the products
    SUMX (
        Sales,                                 -- Sales is not filtered
        Sales[Quantity] * Sales[Net Price]     -- thus here we compute all sales
    )
<span type="pagebreak" id="calibre_link-3014"></span>VAR CurrentSales =
    CALCULATE (                                -- Performs context transition
        SUMX (
            Sales,                             -- Sales of the current product only
            Sales[Quantity] * Sales[Net Price] -- thus here we compute sales of the
        )                                      -- current product only
    )
VAR Ratio = 0.01                               -- 1% expressed as a real number
VAR Result =
    IF (
        CurrentSales &gt;= TotalSales * Ratio,
        "High Performance product",
        "Regular product"
    )
RETURN
    Result</pre></div>
<p class="edition">You note that there is only one difference between the two variables: <em class="calibre5">TotalSales</em> is executed as a regular iteration, whereas <em class="calibre5">CurrentSales</em> computes the same DAX code within a <em class="calibre5">CALCULATE</em> function. Because this is a calculated column, the row context is transformed into a filter context. The filter context propagates through the model and it reaches <em class="calibre5">Sales</em>, only filtering the sales of the current product.</p>
<p class="edition">Thus, even though the two variables look similar, their content is completely different. <em class="calibre5">TotalSales</em> computes the sales of all the products because the filter context in a calculated column is empty and does not filter anything. <em class="calibre5">CurrentSales</em> computes the sales of the current product only thanks to the context transition performed by <em class="calibre5">CALCULATE</em>.</p>
<p class="edition">The remaining part of the code is a simple <em class="calibre5">IF</em> statement that checks whether the condition is met and marks the product appropriately. One can use the resulting calculated column in a report like the one visible in <a href="#calibre_link-655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-35</a>.</p>
<figure id="calibre_link-655" class="image-l">
<img src="images/000815.jpg" alt="The report shows Sales Amount and NumOfProducts, per Performance level. Four products are considered High Performance products, and they are counted one by one under NumOfProducts." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-35</strong> Only four products are marked High Performance.</figcaption>
</figure>
<p class="edition">In the code of the <em class="calibre5">Performance</em> calculated column, we used <em class="calibre5">CALCULATE</em> and context transition as a feature. Before moving on, we must check that we considered all the implications. The <em class="calibre5">Product</em> table is <span type="pagebreak" id="calibre_link-3015"></span>small, containing just a few thousand rows. Thus, performance is not an issue. The filter context generated by <em class="calibre5">CALCULATE</em> filters all the columns. Do we have a guarantee that <em class="calibre5">CurrentSales</em> only contains the sales of the current product? In this special case, the answer is yes. The reason is that each row of <em class="calibre5">Product</em> is unique because <em class="calibre5">Product</em> contains a column with a different value for each row&mdash;<em class="calibre5">ProductKey</em>. Consequently, the filter context generated by the context transition is guaranteed to only filter one product.</p>
<p class="edition">In this case, we could rely on context transition because each row of the iterated table is unique. Beware that this is not always true. We want to demonstrate that with an example that is purposely wrong. We create a calculated column, in <em class="calibre5">Sales</em>, containing this code:</p>
<p class="codelink"><a href="#calibre_link-656" id="calibre_link-2309" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Wrong Amt] =
CALCULATE (
    SUMX (
        Sales,
        Sales[Quantity] * Sales[Net Price]
    )
)</pre></div>
<p class="edition">Being a calculated column, it runs in a row context. <em class="calibre5">CALCULATE</em> performs the context transition, so <em class="calibre5">SUMX</em> iterates all the rows in <em class="calibre5">Sales</em> with an identical set of values corresponding to the current row in <em class="calibre5">Sales</em>. The problem is that the <em class="calibre5">Sales</em> table does not have any column with unique values. Therefore, there is a chance that multiple identical rows exist and, if they exist, they will be filtered together. In other words, there is no guarantee that <em class="calibre5">SUMX</em> always iterates only one row in the <em class="calibre5">Wrong Amt</em> column.</p>
<p class="edition">If you are lucky, there are many duplicated rows, and the value computed by this calculated column is totally wrong. This way, the problem would be clearly visible and immediately recognized. In many real-world scenarios, the number of duplicated rows in tables is tiny, making these inaccurate calculations hard to spot and debug. The sample database we use in this book is no exception. Look at the report in <a href="#calibre_link-657" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-36</a> showing the correct value for <em class="calibre5">Sales Amount</em> and the wrong value computed by summing the <em class="calibre5">Wrong Amt</em> calculated column.</p>
<figure id="calibre_link-657" class="image-l">
<img src="images/000822.jpg" alt="The report shows Sales Amount and Wrong Amount, per Brand. We notice that most numbers are the same for each Brand. However, for Fabrikam, Wrong Amount is higher than Sales Amount. Thus, the totals differ at the bottom of the report." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-36</strong> Most results are correct; only two rows have different values.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1783"></span>You can see that the difference only exists at the total level and for the Fabrikam brand. There are some duplicates in the <em class="calibre5">Sales</em> table&mdash;related to some Fabrikam product&mdash;that perform the calculation twice. The presence of these rows might be legitimate: The same customer bought the same product in the same store on the same day in the morning and in the afternoon, but the <em class="calibre5">Sales</em> table only stores the date and not the time of the transaction. Because the number of duplicates is small, most numbers look correct. However, the calculation is wrong because it depends on the content of the table. Inaccurate numbers might appear at any time because of duplicated rows. The more duplicates there are, the worse the result turns out.</p>
<p class="edition">In this case, relying on context transition is the wrong choice. Because the table is not guaranteed to only have unique rows, context transition is not safe to use. An expert DAX coder should know this in advance. Besides, the <em class="calibre5">Sales</em> table might contain millions of rows; thus, this calculated column is not only wrong, it is also very slow.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-109" class="calibre13">Context transition with measures</h4>
<p class="edition">Understanding context transition is very important because of another important aspect of DAX.</p>
<blockquote class="calibre23">
<p class="noindent"><strong class="calibre7"><em class="calibre5">Every measure reference always has an implicit CALCULATE surrounding it</em>.</strong></p>
</blockquote>
<p class="edition">Because of <em class="calibre5">CALCULATE</em>, a measure reference generates an implicit context transition if executed in the presence of any row context. This is why in DAX, it is important to use the correct naming convention when writing column references (always including the table name) and measure references (always without the table name). You want to be aware of any implicit context transition writing and reading a DAX expression.</p>
<p class="edition">This simple initial definition deserves a longer explanation with several examples. The first one is that translating a measure reference always requires wrapping the expression of the measure within a <em class="calibre5">CALCULATE</em> function. For example, consider the following definition of the <em class="calibre5">Sales Amount</em> measure and of the <em class="calibre5">Product Sales</em> calculated column in the <em class="calibre5">Product</em> table:</p>
<p class="codelink"><a href="#calibre_link-658" id="calibre_link-2310" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX (
    Sales,
    Sales[Quantity] * Sales[Net Price]
)

'Product'[Product Sales] = [Sales Amount]</pre></div>
<p class="edition">The <em class="calibre5">Product Sales</em> column correctly computes the sum of <em class="calibre5">Sales Amount</em> only for the current product in the <em class="calibre5">Product</em> table. Indeed, expanding the <em class="calibre5">Sales Amount</em> measure in the definition of <em class="calibre5">Product Sales</em> requires the <em class="calibre5">CALCULATE</em> function that wraps the definition of <em class="calibre5">Sales Amount</em>:</p>
<p class="codelink"><a href="#calibre_link-659" id="calibre_link-2311" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[Product Sales] =
CALCULATE
    SUMX (
        Sales,
        Sales[Quantity] * Sales[Net Price]
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3016"></span>Without <em class="calibre5">CALCULATE</em>, the result of the calculated column would produce the same value for all the products. This would correspond to the sales amount of all the rows in <em class="calibre5">Sales</em> without any filtering by product. The presence of <em class="calibre5">CALCULATE</em> means that context transition occurs, producing in this case the desired result. A measure reference always calls <em class="calibre5">CALCULATE</em>. This is very important and can be used to write short and powerful DAX expressions. However, it could also lead to big mistakes if you forget that the context transition takes place every time the measure is called in a row context.</p>
<p class="edition">As a rule of thumb, you can always replace a measure reference with the expression that defines the measure wrapped inside <em class="calibre5">CALCULATE</em>. Consider the following definition of a measure called <em class="calibre5">Max Daily Sales</em>, which computes the maximum value of <em class="calibre5">Sales Amount</em> computed day by day:</p>
<div class="program"><pre class="calibre14">Max Daily Sales :=
MAXX (
    'Date',
    [Sales Amount]
)</pre></div>
<p class="edition">This formula is intuitive to read. However, <em class="calibre5">Sales Amount</em> must be computed for each date, only filtering the sales of that day. This is exactly what context transition performs. Internally, DAX replaced the <em class="calibre5">Sales Amount</em> measure reference with its definition wrapped by <em class="calibre5">CALCULATE</em>, as in the following example:</p>
<p class="codelink"><a href="#calibre_link-660" id="calibre_link-2312" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Max Daily Sales :=
MAXX (
    'Date',
    CALCULATE (
        SUMX (
            Sales,
            Sales[Quantity] * Sales[Net Price]
        )
    )
)</pre></div>
<p class="edition">We will use this feature extensively in <a href="#calibre_link-12" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 7</a>, “<a href="#calibre_link-12" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with iterators and <em class="calibre5">CALCULATE</em></a>,” when we start writing complex DAX code to solve specific scenarios. This initial description just completes the explanation of context transition, which happens in these cases:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">When a <em class="calibre5">CALCULATE</em> or <em class="calibre5">CALCULATETABLE</em> function is called in the presence of any row context.</p></li>
<li class="calibre10"><p class="listp">When there is a measure reference in the presence of any row context because the measure reference internally executes its DAX code within a <em class="calibre5">CALCULATE</em> function.</p></li>
</ul>
<p class="edition">This powerful behavior might lead to mistakes, mainly due to the incorrect assumption that you can replace a measure reference with the DAX code of its definition. You cannot. This could work when there are no row contexts, like in a measure, but this is not possible when the measure reference appears within a row context. It is easy to forget this rule, so we provide an example of what could happen by making an incorrect assumption.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3017"></span>You may have noticed that in the previous example, we wrote the code for a calculated column repeating the iteration over <em class="calibre5">Sales</em> twice. Here is the code we already presented in the previous example:</p>
<p class="codelink"><a href="#calibre_link-661" id="calibre_link-2313" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[Performance] =
VAR TotalSales =                               -- Sales of all the products
    SUMX (
        Sales,                                 -- Sales is not filtered
        Sales[Quantity] * Sales[Net Price]     -- thus here we compute all sales
    )
VAR CurrentSales =
    CALCULATE (                                -- Performs the context transition
        SUMX (
            Sales,                             -- Sales of the current product only
            Sales[Quantity] * Sales[Net Price] -- thus here we compute sales of the
        )                                      -- current product only
    )
VAR Ratio = 0.01                               -- 1% expressed as a real number
VAR Result =
    IF (
        CurrentSales &gt;= TotalSales * Ratio,
        "High Performance product",
        "Regular product"
    )
RETURN
    Result</pre></div>
<p class="edition">The iteration executed by <em class="calibre5">SUMX</em> is the same code for the two variables: One is surrounded by <em class="calibre5">CALCULATE</em>, whereas the other is not. It might seem like a good idea to rewrite the code and use a measure to host the code of the iteration. This could be even more relevant in case the expression is not a simple <em class="calibre5">SUMX</em> but, rather, some more complex code. Unfortunately, this approach will not work because the measure reference will always include a <em class="calibre5">CALCULATE</em> around the expression that the measure replaced.</p>
<p class="edition">Imagine creating a measure, <em class="calibre5">Sales Amount</em>, and then a calculated column that calls the measure surrounding it&mdash;once with <em class="calibre5">CALCULATE</em> and once without <em class="calibre5">CALCULATE</em>.</p>
<p class="codelink"><a href="#calibre_link-662" id="calibre_link-2314" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX (
    Sales,
    Sales[Quantity] * Sales[Net Price]
)

'Product'[Performance] =
VAR TotalSales = [Sales Amount]
VAR CurrentSales = CALCULATE ( [Sales Amount] )
VAR Ratio = 0.01
VAR Result =
    IF (
        CurrentSales &gt;= TotalSales * Ratio,
        "High Performance product",
        "Regular product"
    )
RETURN
    Result</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1784"></span>Though it looked like a good idea, this calculated column does not compute the expected result. The reason is that both measure references will have their own implicit <em class="calibre5">CALCULATE</em> around them. Thus, <em class="calibre5">TotalSales</em> does not compute the sales of all the products. Instead, it only computes the sales of the current product because the hidden <em class="calibre5">CALCULATE</em> performs a context transition. <em class="calibre5">CurrentSales</em> computes the same value. In <em class="calibre5">CurrentSales</em>, the extra <em class="calibre5">CALCULATE</em> is redundant. Indeed, <em class="calibre5">CALCULATE</em> is already there, only because it is referencing a measure. This is more evident by looking at the code resulting by expanding the <em class="calibre5">Sales Amount</em> measure:</p>
<p class="codelink"><a href="#calibre_link-663" id="calibre_link-2315" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[Performance] =
VAR TotalSales =
CALCULATE (
    SUMX (
        Sales,
        Sales[Quantity] * Sales[Net Price]
    )
)
VAR CurrentSales =
CALCULATE (
    CALCULATE (
        SUMX (
             Sales,
            Sales[Quantity] * Sales[Net Price]
        )
    )
)
VAR Ratio = 0.01
VAR Result =
    IF (
        CurrentSales &gt;= TotalSales * Ratio,
        "High Performance product",
        "Regular product"
    )
RETURN
    Result</pre></div>
<p class="edition">Whenever you read a measure call in DAX, you should always read it as if <em class="calibre5">CALCULATE</em> were there. Because it is there. We introduced a rule in <a href="#calibre_link-7" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 2</a>, “<a href="#calibre_link-7" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Introducing DAX</a>,” where we said that it is a best practice to always use the table name in front of columns, and never use the table name in front of measures. The reason is what we are discussing now.</p>
<p class="edition">When reading DAX code, it is of paramount importance that the user be immediately able to understand whether the code is referencing a measure or a column. The de facto standard that nearly every DAX coder adopts is to omit the table name in front of measures.</p>
<p class="edition">The automatic <em class="calibre5">CALCULATE</em> makes it easy to author formulas that perform complex calculations with iterations. We will use this feature extensively in <a href="#calibre_link-12" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 7</a> when we start writing complex DAX code to solve specific scenarios.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-110" class="h2a"><span type="pagebreak" id="calibre_link-1777"></span>Understanding circular dependencies</h3>
<p class="edition">When you design a data model, you should pay attention to the complex topic of circular dependencies in formulas. In this section, you learn what circular dependencies are and how to avoid them in your model. Before introducing circular dependencies, it is worth discussing simple, linear dependencies with the aid of an example. Look at the following calculated column:</p>
<p class="codelink"><a href="#calibre_link-664" id="calibre_link-2316" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Margin] = Sales[Net Price] - Sales[Unit Cost]</pre></div>
<p class="edition">The new calculated column depends on two columns: <em class="calibre5">Net Price</em> and <em class="calibre5">Unit Cost</em>. This means that to compute the value of <em class="calibre5">Margin</em>, DAX needs to know in advance the values of the two other columns. Dependencies are an important part of the DAX model because they drive the order in which calculated columns and calculated tables are processed. In the example, <em class="calibre5">Margin</em> can only be computed after <em class="calibre5">Net Price</em> and <em class="calibre5">Unit Cost</em> already have a value. The coder does not need to worry about dependencies. Indeed, DAX handles them gracefully, building a complex graph that drives the order of evaluation of all its internal objects. However, it is possible to write code in such a way that circular dependencies appear in the graph. Circular dependencies happen when DAX cannot determine the order of evaluation of an expression because there is a loop in the chain of dependencies.</p>
<p class="edition">For example, consider two calculated columns with the following formulas:</p>
<p class="codelink"><a href="#calibre_link-665" id="calibre_link-2317" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[MarginPct] = DIVIDE ( Sales[Margin], Sales[Unit Cost] )
Sales[Margin] = Sales[MarginPct] * Sales[Unit Cost]</pre></div>
<p class="edition">In this code, <em class="calibre5">MarginPct</em> depends on <em class="calibre5">Margin</em> and, at the same time, <em class="calibre5">Margin</em> depends on <em class="calibre5">MarginPct</em>. There is a loop in the chain of dependencies. In that scenario, DAX refuses to accept the last formula and raises the error, “A circular dependency was detected.”</p>
<p class="edition">Circular dependencies do not happen frequently because as humans we understand the problem well. B cannot depend on A if, at the same time, A depends on B. Nevertheless, there is a scenario where circular dependency occurs&mdash;not because it is one’s intention to do so, but only because one does not consider certain implications by reading DAX code. This scenario includes the use of <em class="calibre5">CALCULATE</em>.</p>
<p class="edition">Imagine a calculated column in <em class="calibre5">Sales</em> with the following code:</p>
<p class="codelink"><a href="#calibre_link-666" id="calibre_link-2318" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[AllSalesQty] = CALCULATE ( SUM ( Sales[Quantity] ) )</pre></div>
<p class="edition">The interesting question is, which columns does <em class="calibre5">AllSalesQty</em> depend on? Intuitively, one would answer that the new column depends solely on <em class="calibre5">Sales[Quantity]</em> because it is the only column used in the expression. However, it is all too easy to forget the real semantics of <em class="calibre5">CALCULATE</em> and context transition. Because <em class="calibre5">CALCULATE</em> runs in a row context, all current values of all the columns of the <span type="pagebreak" id="calibre_link-3018"></span>table are included in the expression, though hidden. Thus, the real expression evaluated by DAX is the following:</p>
<p class="codelink"><a href="#calibre_link-667" id="calibre_link-2319" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[AllSalesQty] =
CALCULATE (
    SUM ( Sales[Quantity] ),
    Sales[ProductKey] = &lt;CurrentValueOfProductKey&gt;,
    Sales[StoreKey] = &lt;CurrentValueOfStoreKey&gt;,
    ...,
    Sales[Margin] = &lt;CurrentValueOfMargin&gt;
)</pre></div>
<p class="edition">As you see, the list of columns <em class="calibre5">AllSalesQty</em> depends on is actually the full set of columns of the table. Once <em class="calibre5">CALCULATE</em> is being used in a row context, the calculation suddenly depends on all the columns of the iterated table. This is much more evident in calculated columns, where the row context is present by default.</p>
<p class="edition">If one authors a single calculated column using <em class="calibre5">CALCULATE</em>, everything still works fine. The problem appears if one tries to author two separate calculated columns in a table, with both columns using <em class="calibre5">CALCULATE</em>, thus firing context transition in both cases. In fact, the following new calculated column will fail:</p>
<p class="codelink"><a href="#calibre_link-668" id="calibre_link-2320" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[NewAllSalesQty] = CALCULATE ( SUM ( Sales[Quantity] ) )</pre></div>
<p class="edition">The reason for this is that <em class="calibre5">CALCULATE</em> adds all the columns of the table as filter arguments. Adding a new column to a table changes the definition of existing columns too. If one were able to create <em class="calibre5">NewAllSalesQty</em>, the code of the two calculated columns would look like this:</p>
<p class="codelink"><a href="#calibre_link-669" id="calibre_link-2321" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[AllSalesQty] =
CALCULATE (
    SUM ( Sales[Quantity] ),
    Sales[ProductKey] = &lt;CurrentValueOfProductKey&gt;,
    ...,
    Sales[Margin] = &lt;CurrentValueOfMargin&gt;,
    <strong class="calibre7">Sales[NewAllSalesQty] = &lt;CurrentValueOfNewAllSalesQty&gt;</strong>
)

Sales[NewAllSalesQty] =
CALCULATE (
    SUM ( Sales[Quantity] ),
    Sales[ProductKey] = &lt;CurrentValueOfProductKey&gt;,
    ...,
    Sales[Margin] = &lt;CurrentValueOfMargin&gt;,
    <strong class="calibre7">Sales[AllSalesQty] = &lt;CurrentValueOfAllSalesQty&gt;</strong>
)</pre></div>
<p class="edition">You can see that the two highlighted rows reference each other. <em class="calibre5">AllSalesQty</em> depends on the value of <em class="calibre5">NewAllSalesQty</em> and, at the same time, <em class="calibre5">NewAllSalesQty</em> depends on the value of <em class="calibre5">AllSalesQty</em>. Although very well hidden, a circular dependency does exist. DAX detects the circular dependency, preventing the code from being accepted.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3019"></span>The problem, although somewhat complex to detect, has a simple solution. If the table on which <em class="calibre5">CALCULATE</em> performs the context transition contains one column with unique values and DAX is aware of that, then the context transition only filters that column from a dependency point of view.</p>
<p class="edition">For example, consider a calculated column in the <em class="calibre5">Product</em> table with the following code:</p>
<p class="codelink"><a href="#calibre_link-670" id="calibre_link-2322" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[ProductSales] = CALCULATE ( SUM ( Sales[Quantity] ) )</pre></div>
<p class="edition">In this case, there is no need to add all the columns as filter arguments. In fact, <em class="calibre5">Product</em> contains one column that has a unique value for each row of the <em class="calibre5">Product</em> table&mdash;that is <em class="calibre5">ProductKey</em>. This is well-known by the DAX engine because that column is on the one-side of a one-to-many relationship. Consequently, when the context transition occurs, the engine knows that it would be pointless to add a filter to each column. The code would be translated into the following:</p>
<p class="codelink"><a href="#calibre_link-671" id="calibre_link-2323" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[ProductSales] =
CALCULATE (
    SUM ( Sales[Quantity] ),
    'Product'[ProductKey] = &lt;CurrentValueOfProductKey&gt;
)</pre></div>
<p class="edition">As you can see, the <em class="calibre5">ProductSales</em> calculated column in the <em class="calibre5">Product</em> table depends solely on <em class="calibre5">ProductKey</em>. Therefore, one could create many calculated columns using <em class="calibre5">CALCULATE</em> because all of them would only depend on the column with unique values.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The last <em class="calibre5">CALCULATE</em> equivalent statement for the context transition is not totally accurate. We used it for educational purposes only. <em class="calibre5">CALCULATE</em> adds all the columns of the table as filter arguments, even if a row identifier is present. Nevertheless, the internal dependency is only created on the unique column. The presence of the unique column lets DAX evaluate multiple columns with <em class="calibre5">CALCULATE</em>. Still, the semantics of <em class="calibre5">CALCULATE</em> is the same with or without the unique column: All the columns of the iterated table are added as filter arguments.</p>
</div>
<p class="edition">We already discussed the fact that relying on context transition on a table that contains duplicates is a serious problem. The presence of circular dependencies is another very good reason why one should avoid using <em class="calibre5">CALCULATE</em> and context transition whenever the uniqueness of rows is not guaranteed.</p>
<p class="edition">Resorting to a column with unique values for each row is not enough to ensure that <em class="calibre5">CALCULATE</em> only depends on it for the context transition. The data model must be aware of that. How does DAX know that a column contains unique values? There are multiple ways to provide this information to the engine:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">When a table is the target (one-side) of a relationship, then the column used to build the relationship is marked as unique. This technique works in any tool.</p></li>
<li class="calibre10"><p class="listp">When a column is selected in the <em class="calibre5">Mark As Date Table</em> setting, then the column is implicitly unique&mdash;more on this in <a href="#calibre_link-13" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 8</a>, “<a href="#calibre_link-13" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Time intelligence calculations</a>.”</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-1681"></span>You can manually set the property of a row identifier for the unique column by using the Table Behavior properties. This technique only works in Power Pivot for Excel and Analysis Services Tabular; it is not available in Power BI at the time of writing.</p></li>
</ul>
<p class="edition">Any one of these operations informs the DAX engine that the table has a row identifier, stopping the process of a table that does not respect that constraint. When a table has a row identifier, you can use <em class="calibre5">CALCULATE</em> without worrying about circular dependencies. The reason is that the context transition depends on the key column only.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Though described as a feature, this behavior is actually a side effect of an optimization. The semantics of DAX require the dependency from all the columns. A specific optimization introduced very early in the engine only creates the dependency on the primary key of the table. Because many users rely on this behavior today, it has become part of the language. Still, it remains an optimization. In borderline scenarios&mdash;for example when using <em class="calibre5">USERELATIONSHIP</em> as part of the formula&mdash;the optimization does not kick in, thus recreating the circular dependency error.</p>
</div>
</section>
<section class="calibre4">
<h3 id="calibre_link-111" class="h2a"><em class="calibre5">CALCULATE</em> modifiers</h3>
<p class="edition">As you have learned in this chapter, <em class="calibre5">CALCULATE</em> is extremely powerful and produces complex DAX code. So far, we have only covered filter arguments and context transition. There is still one concept required to provide the set of rules to fully understand <em class="calibre5">CALCULATE</em>. It is the concept of <em class="calibre5">CALCULATE modifier</em>.</p>
<p class="edition">We introduced two modifiers earlier, when we talked about <em class="calibre5">ALL</em> and <em class="calibre5">KEEPFILTERS</em>. While <em class="calibre5">ALL</em> can be both a modifier and a table function, <em class="calibre5">KEEPFILTERS</em> is always a filter argument modifier&mdash;meaning that it changes the way one filter is merged with the original filter context. <em class="calibre5">CALCULATE</em> accepts several different modifiers that change how the new filter context is prepared. However, the most important of all these modifiers is a function that you already know very well: <em class="calibre5">ALL</em>. When <em class="calibre5">ALL</em> is directly used in a <em class="calibre5">CALCULATE</em> filter argument, it acts as a <em class="calibre5">CALCULATE</em> modifier instead of being a table function. Other important modifiers include <em class="calibre5">USERELATIONSHIP</em>, <em class="calibre5">CROSSFILTER</em>, and <em class="calibre5">ALLSELECTED</em>, which have separate descriptions. The <em class="calibre5">ALLEXCEPT</em>, <em class="calibre5">ALLSELECTED</em>, <em class="calibre5">ALLCROSSFILTERED</em> and <em class="calibre5">ALLNOBLANKROW</em> modifiers have the same precedence rules of <em class="calibre5">ALL</em>.</p>
<p class="edition">In this section we introduce these modifiers; then we will discuss the order of precedence of the different <em class="calibre5">CALCULATE</em> modifiers and filter arguments. At the end, we will present the final schema of <em class="calibre5">CALCULATE</em> rules.</p>
<section class="calibre4">
<h4 id="calibre_link-112" class="calibre13">Understanding <em class="calibre5">USERELATIONSHIP</em></h4>
<p class="edition">The first <em class="calibre5">CALCULATE</em> modifier you learn is <em class="calibre5">USERELATIONSHIP</em>. <em class="calibre5">CALCULATE</em> can activate a relationship during the evaluation of its expression by using this modifier. A data model might contain both active <span type="pagebreak" id="calibre_link-3020"></span>and inactive relationships. One might have inactive relationships in the model because there are several relationships between two tables, and only one of them can be active.</p>
<p class="edition">As an example, one might have order date and delivery date stored in the <em class="calibre5">Sales</em> table for each order. Typically, the requirement is to perform sales analysis based on the order date, but one might need to consider the delivery date for some specific measures. In that scenario, an option is to create two relationships between <em class="calibre5">Sales</em> and <em class="calibre5">Date</em>: one based on <em class="calibre5">Order Date</em> and another one based on <em class="calibre5">Delivery Date</em>. The model looks like the one in <a href="#calibre_link-672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-37</a>.</p>
<figure id="calibre_link-672" class="image-l">
<img src="images/000829.jpg" alt="The figure shows the model with various tables. We see two relationships between Sales and Date." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-37</strong> <em class="calibre5">Sales</em> and <em class="calibre5">Date</em> are linked through two relationships, although only one can be active.</figcaption>
</figure>
<p class="edition">Only one of the two relationships can be active at a time. For example, in this demo model the relationship with <em class="calibre5">Order Date</em> is active, whereas the one linked to <em class="calibre5">Delivery Date</em> is kept inactive. To author a measure that shows the delivered value in a given time period, the relationship with <em class="calibre5">Delivery Date</em> needs to be activated for the duration of the calculation. In this scenario, <em class="calibre5">USERELATIONSHIP</em> is of great help as in the following code:</p>
<p class="codelink"><a href="#calibre_link-673" id="calibre_link-2324" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Delivered Amount:=
CALCULATE (
    [Sales Amount],
    USERELATIONSHIP ( Sales[Delivery Date], 'Date'[Date] )
)</pre></div>
<p class="edition">The relationship between <em class="calibre5">Delivery Date</em> and <em class="calibre5">Date</em> is activated during the evaluation of <em class="calibre5">Sales Amount</em>. In the meantime, the relationship with <em class="calibre5">Order Date</em> is deactivated. Keep in mind that at a given <span type="pagebreak" id="calibre_link-3021"></span>point in time, only one relationship can be active between any two tables. Thus, <em class="calibre5">USERELATIONSHIP</em> temporarily activates one relationship, deactivating the one active outside of <em class="calibre5">CALCULATE</em>.</p>
<p class="edition"><a href="#calibre_link-674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-38</a> shows the difference between <em class="calibre5">Sales Amount</em> based on the <em class="calibre5">Order Date</em>, and the new <em class="calibre5">Delivered Amount</em> measure.</p>
<figure id="calibre_link-674" class="image-l">
<img src="images/000836.jpg" alt="The report shows Sales Amount and Delivered Amount, per month within a Calendar Year. We notice that for each month, the amount sold is not the same as the amount delivered." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-38</strong> The figure illustrates the difference between ordered and delivered sales.</figcaption>
</figure>
<p class="edition">When using <em class="calibre5">USERELATIONSHIP</em> to activate a relationship, you need to be aware of an important aspect: Relationships are defined when a table reference is used, not when <em class="calibre5">RELATED</em> or other relational functions are invoked. We will cover the details of this in <a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a> by using expanded tables. For now, an example should suffice. To compute all amounts delivered in 2007, the following formula will not work:</p>
<p class="codelink"><a href="#calibre_link-675" id="calibre_link-2325" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Delivered Amount 2007 v1 :=
CALCULATE (
    [Sales Amount],
    FILTER (
        Sales,
        CALCULATE (
            <strong class="calibre7">RELATED ( 'Date'[Calendar Year] ),</strong>
            USERELATIONSHIP ( Sales[Delivery Date], 'Date'[Date] )
        ) = "CY 2007"
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3022"></span>In fact, <em class="calibre5">CALCULATE</em> would inactivate the row context generated by the <em class="calibre5">FILTER</em> iteration. Thus, inside the <em class="calibre5">CALCULATE</em> expression, one cannot use the <em class="calibre5">RELATED</em> function at all. One option to author the code would be the following:</p>
<p class="codelink"><a href="#calibre_link-676" id="calibre_link-2326" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Delivered Amount 2007 v2 :=
CALCULATE (
    [Sales Amount],
    CALCULATETABLE (
        FILTER (
            Sales,
            RELATED ( 'Date'[Calendar Year] ) = "CY 2007"
        ),
        USERELATIONSHIP (
            Sales[Delivery Date],
            'Date'[Date]
        )
    )
)</pre></div>
<p class="edition">In this latter formulation, <em class="calibre5">Sales</em> is referenced after <em class="calibre5">CALCULATE</em> has activated the required relationship. Therefore, the use of <em class="calibre5">RELATED</em> inside <em class="calibre5">FILTER</em> happens with the relationship with <em class="calibre5">Delivery Date</em> active. The <em class="calibre5">Delivered Amount 2007 v2</em> measure works, but a much better formulation of the same measure relies on default filter context propagation rather than relying on <em class="calibre5">RELATED</em>:</p>
<p class="codelink"><a href="#calibre_link-677" id="calibre_link-2327" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Delivered Amount 2007 v3 :=
CALCULATE (
    [Sales Amount],
    'Date'[Calendar Year] = "CY 2007",
    USERELATIONSHIP (
        Sales[Delivery Date],
        'Date'[Date]
    )
)</pre></div>
<p class="edition">When you use <em class="calibre5">USERELATIONSHIP</em> in a <em class="calibre5">CALCULATE</em> statement, all the filter arguments are evaluated using the relationship modifiers that appear in the same <em class="calibre5">CALCULATE</em> statement&mdash;regardless of their order. For example, in the <em class="calibre5">Delivered Amount 2007 v3</em> measure, the <em class="calibre5">USERELATIONSHIP</em> modifier affects the predicate filtering <em class="calibre5">Calendar Year</em>, although it is the previous parameter within the same <em class="calibre5">CALCULATE</em> function call.</p>
<p class="edition">This behavior makes the use of nondefault relationships a complex operation in calculated column expressions. The invocation of the table is implicit in a calculated column definition. Therefore, you do not have control over it, and you cannot change that behavior by using <em class="calibre5">CALCULATE</em> and <em class="calibre5">USERELATIONSHIP</em>.</p>
<p class="edition">One important note is the fact that <em class="calibre5">USERELATIONSHIP</em> does not introduce any filter by itself. Indeed, <em class="calibre5">USERELATIONSHIP</em> is not a filter argument. It is a <em class="calibre5">CALCULATE</em> modifier. It only changes the way other filters are applied to the model. If you carefully look at the definition of <em class="calibre5">Delivered Amount in 2007 v3</em>, you might notice that the filter argument applies a filter on the year 2007, but it does not indicate <span type="pagebreak" id="calibre_link-1785"></span>which relationship to use. Is it using <em class="calibre5">Order Date</em> or <em class="calibre5">Delivery Date</em>? The relationship to use is defined by <em class="calibre5">USERELATIONSHIP</em>.</p>
<p class="edition">Thus, <em class="calibre5">CALCULATE</em> first modifies the structure of the model by activating the relationship, and only later does it apply the filter argument. If that were not the case&mdash;that is, if the filter argument were always evaluated on the current relationship architecture&mdash;then the calculation would not work.</p>
<p class="edition">There are precedence rules in the application of filter arguments and of <em class="calibre5">CALCULATE</em> modifiers. The first rule is that <em class="calibre5">CALCULATE</em> modifiers are always applied before any filter argument, so that the effect of filter arguments is applied on the modified version of the model. We discuss precedence of <em class="calibre5">CALCULATE</em> arguments in more detail later.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-113" class="calibre13">Understanding <em class="calibre5">CROSSFILTER</em></h4>
<p class="edition">The next <em class="calibre5">CALCULATE</em> modifier you learn is <em class="calibre5">CROSSFILTER</em>. <em class="calibre5">CROSSFILTER</em> is somewhat similar to <em class="calibre5">USERELATIONSHIP</em> because it manipulates the architecture of the relationships in the model. Nevertheless, <em class="calibre5">CROSSFILTER</em> can perform two different operations:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">It can change the cross-filter direction of a relationship.</p></li>
<li class="calibre10"><p class="listp">It can disable a relationship.</p></li>
</ul>
<p class="edition"><em class="calibre5">USERELATIONSHIP</em> lets you activate a relationship while disabling the active relationship, but it cannot disable a relationship without activating another one between the same tables. <em class="calibre5">CROSSFILTER</em> works in a different way. <em class="calibre5">CROSSFILTER</em> accepts two parameters, which are the columns involved in the relationship, and a third parameter that can be either <em class="calibre5">NONE</em>, <em class="calibre5">ONEWAY</em>, or <em class="calibre5">BOTH</em>. For example, the following measure computes the distinct count of product colors after activating the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em> as a bidirectional one:</p>
<p class="codelink"><a href="#calibre_link-678" id="calibre_link-2328" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NumOfColors :=
CALCULATE (
    DISTINCTCOUNT ( 'Product'[Color] ),
    CROSSFILTER ( Sales[ProductKey], 'Product'[ProductKey], BOTH )
)</pre></div>
<p class="edition">As is the case with <em class="calibre5">USERELATIONSHIP</em>, <em class="calibre5">CROSSFILTER</em> does not introduce filters by itself. It only changes the structure of the relationships, leaving to other filter arguments the task of applying filters. In the previous example, the effect of the relationship only affects the <em class="calibre5">DISTINCTCOUNT</em> function because <em class="calibre5">CALCULATE</em> has no further filter arguments.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-114" class="calibre13">Understanding <em class="calibre5">KEEPFILTERS</em></h4>
<p class="edition">We introduced <em class="calibre5">KEEPFILTERS</em> earlier in this chapter as a <em class="calibre5">CALCULATE</em> modifier. Technically, <em class="calibre5">KEEPFILTERS</em> is not a <em class="calibre5">CALCULATE</em> modifier, it is a filter argument modifier. Indeed, it does not change the entire evaluation of <em class="calibre5">CALCULATE</em>. Instead, it changes the way one individual filter argument is applied to the final filter context generated by <em class="calibre5">CALCULATE</em>.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1682"></span>We already discussed in depth the behavior of <em class="calibre5">CALCULATE</em> in the presence of calculations like the following one:</p>
<p class="codelink"><a href="#calibre_link-679" id="calibre_link-2329" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Contoso Sales :=
CALCULATE (
    [Sales Amount],
    KEEPFILTERS ( 'Product'[Brand] = "Contoso" )
)</pre></div>
<p class="edition">The presence of <em class="calibre5">KEEPFILTERS</em> means that the filter on <em class="calibre5">Brand</em> does not overwrite a previously existing filter on the same column. Instead, the new filter is added to the filter context, leaving the previous one intact. <em class="calibre5">KEEPFILTERS</em> is applied to the individual filter argument where it is used, and it does not change the semantic of the whole <em class="calibre5">CALCULATE</em> function.</p>
<p class="edition">There is another way to use <em class="calibre5">KEEPFILTERS</em> that is less obvious. One can use <em class="calibre5">KEEPFILTERS</em> as a modifier for the table used for an iteration, like in the following code:</p>
<p class="codelink"><a href="#calibre_link-680" id="calibre_link-2330" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ColorBrandSales :=
SUMX (
    KEEPFILTERS ( ALL ( 'Product'[Color], 'Product'[Brand] ) ),
    [Sales Amount]
)</pre></div>
<p class="edition">The presence of <em class="calibre5">KEEPFILTERS</em> as the top-level function used in an iteration forces DAX to use <em class="calibre5">KEEPFILTERS</em> on the implicit filter arguments added by <em class="calibre5">CALCULATE</em> during a context transition. In fact, during the iteration over the values of <em class="calibre5">Product[Color]</em> and <em class="calibre5">Product[Brand]</em>, <em class="calibre5">SUMX</em> invokes <em class="calibre5">CALCULATE</em> as part of the evaluation of the <em class="calibre5">Sales Amount</em> measure. At that point, the context transition occurs, and the row context becomes a filter context by adding a filter argument for <em class="calibre5">Color</em> and <em class="calibre5">Brand</em>.</p>
<p class="edition">Because the iteration started with <em class="calibre5">KEEPFILTERS</em>, context transition will not overwrite existing filters. It will intersect the existing filters instead. It is uncommon to use <em class="calibre5">KEEPFILTERS</em> as the top-level function in an iteration. We will cover some examples of this advanced use later in <a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10</a>.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-115" class="calibre13">Understanding <em class="calibre5">ALL</em> in <em class="calibre5">CALCULATE</em></h4>
<p class="edition"><em class="calibre5">ALL</em> is a table function, as you learned in <a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 3</a>. Nevertheless, <em class="calibre5">ALL</em> acts as a <em class="calibre5">CALCULATE</em> modifier when used as a filter argument in <em class="calibre5">CALCULATE</em>. The function name is the same, but the semantics of <em class="calibre5">ALL</em> as a <em class="calibre5">CALCULATE</em> modifier is slightly different than what one would expect.</p>
<p class="edition">Looking at the following code, one might think that <em class="calibre5">ALL</em> returns all the years, and that it changes the filter context making all years visible:</p>
<p class="codelink"><a href="#calibre_link-681" id="calibre_link-2331" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">All Years Sales :=
CALCULATE (
    [Sales Amount],
    ALL ( 'Date'[Year] )
)</pre></div>
<p class="edition">However, this is not true. When used as a top-level function in a filter argument of <em class="calibre5">CALCULATE</em>, <em class="calibre5">ALL</em> removes an existing filter instead of creating a new one. A proper name for <em class="calibre5">ALL</em> would have been <span type="pagebreak" id="calibre_link-3023"></span><em class="calibre5">REMOVEFILTER</em>. For historical reasons, the name remained <em class="calibre5">ALL</em> and it is a good idea to know exactly how the function behaves.</p>
<p class="edition">If one considers <em class="calibre5">ALL</em> as a table function, they would interpret the <em class="calibre5">CALCULATE</em> behavior like in <a href="#calibre_link-682" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-39</a>.</p>
<figure id="calibre_link-682" class="image-l">
<img src="images/000843.jpg" alt="The figure shows how ALL overwrites the filter context, thus returning all the years in the list." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-39</strong> It looks like <em class="calibre5">ALL</em> returns all the years and uses the list to overwrite the previous filter context.</figcaption>
</figure>
<p class="edition">The innermost <em class="calibre5">ALL</em> over <em class="calibre5">Date[Year]</em> is a top-level <em class="calibre5">ALL</em> function call in <em class="calibre5">CALCULATE</em>. As such, it does not behave as a table function. It should really be read as <em class="calibre5">REMOVEFILTER</em>. In fact, instead of returning all the years, in that case <em class="calibre5">ALL</em> acts as a <em class="calibre5">CALCULATE</em> modifier that removes any filter from its argument. What really happens inside <em class="calibre5">CALCULATE</em> is the diagram of <a href="#calibre_link-683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 5-40</a>.</p>
<figure id="calibre_link-683" class="image-l">
<img src="images/000850.jpg" alt="Considering ALL as a REMOVEFILTER, we see that ALL returns an empty filter." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 5-40</strong> <em class="calibre5">ALL</em> removes a previously existing filter from the context, when used as <em class="calibre5">REMOVEFILTER</em>.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1704"></span>The difference between the two behaviors is subtle. In most calculations, the slight difference in semantics will go unnoticed. Nevertheless, when we start authoring more advanced code, this small difference will make a big impact. For now, the important detail is that when <em class="calibre5">ALL</em> is used as <em class="calibre5">REMOVEFILTER</em>, it acts as a <em class="calibre5">CALCULATE</em> modifier instead of acting as a table function.</p>
<p class="edition">This is important because of the order of precedence of filters in <em class="calibre5">CALCULATE</em>. The <em class="calibre5">CALCULATE</em> modifiers are applied to the final filter context before explicit filter arguments. Thus, consider the presence of <em class="calibre5">ALL</em> on a column where <em class="calibre5">KEEPFILTERS</em> is being used on another explicit filter over that column; it produces the same result as a filter applied to that same column without <em class="calibre5">KEEPFILTERS</em>. In other words, the following definitions of the <em class="calibre5">Sales Red</em> measure produce the same result:</p>
<p class="codelink"><a href="#calibre_link-684" id="calibre_link-2332" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Red :=
CALCULATE (
    [Sales Amount],
    'Product'[Color] = "Red"
)

Sales Red :=
CALCULATE (
    [Sales Amount],
    KEEPFILTERS ( 'Product'[Color] = "Red" ),
    ALL ( 'Product'[Color] )
)</pre></div>
<p class="edition">The reason is that <em class="calibre5">ALL</em> is a <em class="calibre5">CALCULATE</em> modifier. Therefore, <em class="calibre5">ALL</em> is applied before <em class="calibre5">KEEPFILTERS</em>. Moreover, the same precedence rule of <em class="calibre5">ALL</em> is shared by other functions with the same <em class="calibre5">ALL</em> prefix: These are <em class="calibre5">ALL</em>, <em class="calibre5">ALLSELECTED</em>, <em class="calibre5">ALLNOBLANKROW</em>, <em class="calibre5">ALLCROSSFILTERED</em>, and <em class="calibre5">ALLEXCEPT</em>. We generally refer to these functions as the <em class="calibre5">ALL*</em> functions. As a rule, <em class="calibre5">ALL*</em> functions are <em class="calibre5">CALCULATE</em> modifiers when used as top-level functions in <em class="calibre5">CALCULATE</em> filter arguments.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-116" class="calibre13">Introducing <em class="calibre5">ALL</em> and <em class="calibre5">ALLSELECTED</em> with no parameters</h4>
<p class="edition">We introduced <em class="calibre5">ALLSELECTED</em> in <a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 3</a>. We introduced it early on, mainly because of how useful it is. Like all the <em class="calibre5">ALL*</em> functions, <em class="calibre5">ALLSELECTED</em> acts as a <em class="calibre5">CALCULATE</em> modifier when used as a top-level function in <em class="calibre5">CALCULATE</em>. Moreover, when introducing <em class="calibre5">ALLSELECTED</em>, we described it as a table function that can return the values of either a column or a table.</p>
<p class="edition">The following code computes a percentage over the total number of colors selected outside of the current visual. The reason is that <em class="calibre5">ALLSELECTED</em> restores the filter context outside of the current visual on the <em class="calibre5">Product[Color]</em> column.</p>
<p class="codelink"><a href="#calibre_link-685" id="calibre_link-2333" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SalesPct :=
DIVIDE (
    [Sales],
    CALCULATE (
        [Sales],
        ALLSELECTED ( 'Product'[Color] )
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1683"></span>One achieves a similar result using <em class="calibre5">ALLSELECTED ( Product )</em>, which executes <em class="calibre5">ALLSELECTED</em> on top of a whole table. Nevertheless, when used as a <em class="calibre5">CALCULATE</em> modifier, both <em class="calibre5">ALL</em> and <em class="calibre5">ALLSELECTED</em> can also work without any parameter.</p>
<p class="edition">Thus, the following is a valid syntax:</p>
<p class="codelink"><a href="#calibre_link-686" id="calibre_link-2334" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SalesPct :=
DIVIDE (
    [Sales],
    CALCULATE (
        [Sales],
        <strong class="calibre7">ALLSELECTED ( )</strong>
    )
)</pre></div>
<p class="edition">As you can easily notice, in this case <em class="calibre5">ALLSELECTED</em> cannot be a table function. It is a <em class="calibre5">CALCULATE</em> modifier that instructs <em class="calibre5">CALCULATE</em> to restore the filter context that was active outside of the current visual. The way this whole calculation works is rather complex. We will take the behavior of <em class="calibre5">ALL-SELECTED</em> to the next level in <a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a>. Similarly, <em class="calibre5">ALL</em> with no parameters clears the filter context from all the tables in the model, restoring a filter context with no filters active.</p>
<p class="edition">Now that we have completed the overall structure of <em class="calibre5">CALCULATE</em>, we can finally discuss in detail the order of evaluation of all the elements involving <em class="calibre5">CALCULATE</em>.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-117" class="h2a"><em class="calibre5">CALCULATE</em> rules</h3>
<p class="edition">In this final section of a long and difficult chapter, we are now able to provide the definitive guide to <em class="calibre5">CALCULATE</em>. You might want to reference this section multiple times, while reading the remaining part of the book. Whenever you need to recall the complex behavior of <em class="calibre5">CALCULATE</em>, you will find the answer in this section.</p>
<p class="edition">Do not fear coming back here multiple times. We started working with DAX many years ago, and we must still remind ourselves of these rules for complex formulas. DAX is a clean and powerful language, but it is easy to forget small details here and there that are actually crucial in determining the calculation outcome of particular scenarios.</p>
<p class="edition">To recap, this is the overall picture of <em class="calibre5">CALCULATE</em>:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">CALCULATE</em> is executed in an evaluation context, which contains a filter context and might contain one or more row contexts. This is the <em class="calibre5">original context</em>.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">CALCULATE</em> creates a new filter context, in which it evaluates its first argument. This is the <em class="calibre5">new filter context</em>. The new filter context only contains a filter context. All the row contexts disappear in the new filter context because of the context transition.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-1806"></span><em class="calibre5">CALCULATE</em> accepts three kinds of parameters:</p>
<ul class="bull">
<li class="calibre10"><p class="listp">One expression that will be evaluated in the new filter context. This is always the first argument.</p></li>
<li class="calibre10"><p class="listp">A set of explicit filter arguments that manipulate the original filter context. Each filter argument might have a modifier, such as <em class="calibre5">KEEPFILTERS</em>.</p></li>
<li class="calibre10"><p class="listp">A set of <em class="calibre5">CALCULATE</em> modifiers that can change the model and/or the structure of the original filter context, by removing some filters or by altering the relationships architecture.</p></li>
</ul></li>
<li class="calibre10"><p class="listp">When the original context includes one or more row contexts, <em class="calibre5">CALCULATE</em> performs a context transition adding implicit and hidden filter arguments. The implicit filter arguments obtained by row contexts iterating table expressions marked as <em class="calibre5">KEEPFILTERS</em> are also modified by <em class="calibre5">KEEPFILTERS</em>.</p></li>
</ul>
<p class="edition">When using all these parameters, <em class="calibre5">CALCULATE</em> follows a very precise algorithm. It needs to be well understood if the developer hopes to be able to make sense of certain complex calculations.</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp"><em class="calibre5">CALCULATE</em> evaluates all the explicit filter arguments in the original evaluation context. This includes both the original row contexts (if any) and the original filter context. All explicit filter arguments are evaluated independently in the original evaluation context. Once this evaluation is finished, <em class="calibre5">CALCULATE</em> starts building the new filter context.</p></li>
<li class="calibre25"><p class="listp"><em class="calibre5">CALCULATE</em> makes a copy of the original filter context to prepare the new filter context. It discards the original row contexts because the new evaluation context will not contain any row context.</p></li>
<li class="calibre25"><p class="listp"><em class="calibre5">CALCULATE</em> performs the context transition. It uses the current value of columns in the original row contexts to provide a filter with a unique value for all the columns currently being iterated in the original row contexts. This filter may or may not contain one individual row. There is no guarantee that the new filter context contains a single row at this point. If there are no row contexts active, this step is skipped. Once all implicit filters created by the context transition are applied to the new filter context, <em class="calibre5">CALCULATE</em> moves on to the next step.</p></li>
<li class="calibre25"><p class="listp"><em class="calibre5">CALCULATE</em> evaluates the <em class="calibre5">CALCULATE</em> modifiers <em class="calibre5">USERELATIONSHIP</em>, <em class="calibre5">CROSSFILTER</em>, and <em class="calibre5">ALL*</em>. This step happens after step 3. This is very important because it means that one can remove the effects of the context transition by using <em class="calibre5">ALL</em>, as described in <a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10</a>. The <em class="calibre5">CALCULATE</em> modifiers are applied after the context transition, so they can alter the effects of the context transition.</p></li>
<li class="calibre25"><p class="listp"><em class="calibre5">CALCULATE</em> evaluates all the explicit filter arguments in the original filter context. It applies their result to the new filter context generated after step 4. These filter arguments are applied to the new filter context once the context transition has happened so they can overwrite it, after filter removal&mdash;their filter is not removed by any <em class="calibre5">ALL*</em> modifier&mdash;and after the relationship architecture has been updated. However, the evaluation of filter arguments happens in the original filter context, and it is not affected by any other modifier or filter within the same <em class="calibre5">CALCULATE</em> function.</p></li>
</ol>
<p class="edition">The filter context generated after point (5) is the new filter context used by <em class="calibre5">CALCULATE</em> in the evaluation of its expression.<span type="pagebreak" id="calibre_link-3024"></span></p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-687">
<div id="calibre_link-3025" class="calibre2">
<div id="calibre_link-3026" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-11"><span type="pagebreak" id="calibre_link-2106"></span><span class="pd_ash">Chapter 6</span><br class="calibre3" />Variables</h2>
<p class="edition">Variables are important for at least two reasons: code readability and performance. In this chapter, we provide detailed information about variables and their usage, whereas considerations about performance and readability are found all around the book. Indeed, we use variables in almost all the code examples, sometimes showing the version with and without variables to let you appreciate how using variables improves readability.</p>
<p class="edition">Later in <a href="#calibre_link-25" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 20</a>, “<a href="#calibre_link-25" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing DAX</a>,” we will also show how the use of variables can dramatically improve the performance of your code. In this chapter, we are mainly interested in providing all the useful information about variables in a single place.</p>
<section class="calibre4">
<h3 id="calibre_link-118" class="h2a">Introducing <em class="calibre5">VAR</em> syntax</h3>
<p class="edition">What introduces variables in an expression is first the keyword <em class="calibre5">VAR</em>, which defines the variable, followed by the <em class="calibre5">RETURN</em> part, which defines the result. You can see a typical expression containing a variable in the following code:</p>
<p class="codelink"><a href="#calibre_link-688" id="calibre_link-2336" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">VAR SalesAmt =
    SUMX (
        Sales,
        Sales[Quantity] * Sales[Net Price]
    )
RETURN
    IF (
        SalesAmt &gt; 100000,
        SalesAmt,
        SalesAmt * 1.2
    )</pre></div>
<p class="edition">Adding more <em class="calibre5">VAR</em> definitions within the same block allows for the definition of multiple variables, whereas the <em class="calibre5">RETURN</em> block needs to be unique. It is important to note that the <em class="calibre5">VAR/RETURN</em> block is, indeed, an expression. As such, a variable definition makes sense wherever an expression can be used. This makes it possible to define variables during an iteration, or as part of more complex expressions, like in the following example:</p>
<p class="codelink"><a href="#calibre_link-689" id="calibre_link-2337" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">VAR SalesAmt =
    SUMX (
        Sales,
<span type="pagebreak" id="calibre_link-2104"></span>        VAR Quantity = Sales[Quantity]
        VAR Price = Sales[Price]
        RETURN
            Quantity * Price
    )
RETURN
    ...</pre></div>
<p class="edition">Variables are commonly defined at the beginning of a measure definition and then used throughout the measure code. Nevertheless, this is only a writing habit. In complex expressions, defining local variables deeply nested inside other function calls is common practice. In the previous code example, the <em class="calibre5">Quantity</em> and <em class="calibre5">Price</em> variables are assigned for every row of the <em class="calibre5">Sales</em> table iterated by <em class="calibre5">SUMX</em>. These variables are not available outside of the expression executed by <em class="calibre5">SUMX</em> for each row.</p>
<p class="edition">A variable can store either a scalar value or a table. The variables can be&mdash;and often are&mdash;of a different type than the expression returned after <em class="calibre5">RETURN</em>. Multiple variables in the same <em class="calibre5">VAR/RETURN</em> block can be of different types too&mdash;scalar values or tables.</p>
<p class="edition">A very frequent usage of variables is to divide the calculation of a complex formula into logical steps, by assigning the result of each step to a variable. For example, in the following code variables are used to store partial results of the calculation:</p>
<p class="codelink"><a href="#calibre_link-690" id="calibre_link-2338" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Margin% :=
VAR SalesAmount =
    SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
VAR TotalCost =
    SUMX ( Sales, Sales[Quantity] * Sales[Unit Cost] )
VAR Margin =
    SalesAmount - TotalCost
VAR MarginPerc =
    DIVIDE ( Margin, TotalCost )
RETURN
    MarginPerc</pre></div>
<p class="edition">The same expression without variables takes a lot more attention to read:</p>
<p class="codelink"><a href="#calibre_link-691" id="calibre_link-2339" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Margin% :=
DIVIDE (
    SUMX (
        Sales,
        Sales[Quantity] * Sales[Net Price]
    ) - SUMX (
            Sales,
            Sales[Quantity] * Sales[Unit Cost]
        ),
    SUMX (
        Sales,
        Sales[Quantity] * Sales[Unit Cost]
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2105"></span>Moreover, the version with variables has the advantage that each variable is only evaluated once. For example, <em class="calibre5">TotalCost</em> is used in two different parts of the code but, because it is defined as a variable, DAX guarantees that its evaluation only happens once.</p>
<p class="edition">You can write any expression after <em class="calibre5">RETURN</em>. However, using a single variable for the <em class="calibre5">RETURN</em> part is considered best practice. For example, in the previous code, it would be possible to remove the <em class="calibre5">MarginPerc</em> variable definition by writing <em class="calibre5">DIVIDE</em> right after <em class="calibre5">RETURN</em>. However, using <em class="calibre5">RETURN</em> followed by a single variable (like in the example) allows for an easy change of the value returned by the measure. This is useful when inspecting the value of intermediate steps. In our example, if the total is not correct, it would be a good idea to check the value returned in each step, by using a report that includes the measure. This means replacing <em class="calibre5">MarginPerc</em> with <em class="calibre5">Margin</em>, then with <em class="calibre5">TotalCost</em>, and then with <em class="calibre5">SalesAmount</em> in the final <em class="calibre5">RETURN</em>. You would execute the report each time to see the result produced in the intermediate steps.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-119" class="h2a">Understanding that variables are constant</h3>
<p class="edition">Despite its name, a DAX variable is a constant. Once assigned a value, the variable cannot be modified. For example, if a variable is assigned within an iterator, it is created and assigned for every row iterated. Moreover, the value of the variable is only available within the expression of the iterator it is defined in.</p>
<p class="codelink"><a href="#calibre_link-692" id="calibre_link-2340" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Amount at Current Price :=
SUMX (
    Sales,
    VAR Quantity = Sales[Quantity]
    VAR CurrentPrice = RELATED ( 'Product'[Unit Price] )
    VAR AmountAtCurrentPrice = Quantity * CurrentPrice
    RETURN
        AmountAtCurrentPrice
)
<strong class="calibre7">-- Any reference to Quantity, CurrentPrice, or AmountAtCurrentPrice</strong>
<strong class="calibre7">-- would be invalid outside of SUMX</strong></pre></div>
<p class="edition">Variables are evaluated once in the scope of the definition (<em class="calibre5">VAR</em>) and not when their value is used. For example, the following measure always returns 100% because the <em class="calibre5">SalesAmount</em> variable is not affected by <em class="calibre5">CALCULATE</em>. Its value is only computed once. Any reference to the variable name returns the same value regardless of the filter context where the variable value is used.</p>
<p class="codelink"><a href="#calibre_link-693" id="calibre_link-2341" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">% of Product :=
VAR SalesAmount = SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
RETURN
    DIVIDE (
        SalesAmount,
        CALCULATE (
            SalesAmount,
            ALL ( 'Product' )
        )
    )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2107"></span>In this latter example, we used a variable where we should have used a measure. Indeed, if the goal is to avoid the duplication of the code of <em class="calibre5">SalesAmount</em> in two parts of the expression, the right solution requires using a measure instead of a variable to obtain the expected result. In the following code, the correct percentage is obtained by defining two measures:</p>
<p class="codelink"><a href="#calibre_link-694" id="calibre_link-2342" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )

% of Product :=
DIVIDE (
    [Sales Amount],
    CALCULATE (
        [Sales Amount],
        ALL ( 'Product' )
    )
)</pre></div>
<p class="edition">In this case the <em class="calibre5">Sales Amount</em> measure is evaluated twice, in two different filter contexts&mdash;leading as expected to two different results.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-120" class="h2a">Understanding the scope of variables</h3>
<p class="edition">Each variable definition can reference the variables previously defined within the same <em class="calibre5">VAR</em>/<em class="calibre5">RETURN</em> statement. All the variables already defined in outer <em class="calibre5">VAR</em> statements are also available.</p>
<p class="edition">A variable definition can access the variables defined in previous <em class="calibre5">VAR</em> statements, but not the variables defined in following statements. Thus, this code works fine:</p>
<p class="codelink"><a href="#calibre_link-695" id="calibre_link-2343" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Margin :=
VAR SalesAmount =
    SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
VAR TotalCost =
    SUMX ( Sales, Sales[Quantity] * Sales[Unit Cost] )
VAR Margin = SalesAmount - TotalCost
RETURN
    Margin</pre></div>
<p class="edition">Whereas if one moves the definition of <em class="calibre5">Margin</em> at the beginning of the list, as in the following example, DAX will not accept the syntax. Indeed, <em class="calibre5">Margin</em> references two variables that are not yet defined&mdash;<em class="calibre5">SalesAmount</em> and <em class="calibre5">TotalCost</em>:</p>
<p class="codelink"><a href="#calibre_link-696" id="calibre_link-2344" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Margin :=
VAR Margin = SalesAmount - TotalCost <strong class="calibre7">-- Error: SalesAmount and TotalCost are not defined</strong>
VAR SalesAmount =
    SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
VAR TotalCost =
    SUMX ( Sales, Sales[Quantity] * Sales[Unit Cost] )
RETURN
    Margin</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2094"></span>Because it is not possible to reference a variable before its definition, it is also impossible to create either a circular dependency between variables, or any sort of recursive definition.</p>
<p class="edition">It is possible to nest <em class="calibre5">VAR</em>/<em class="calibre5">RETURN</em> statements inside each other, or to have multiple <em class="calibre5">VAR/RETURN</em> blocks in the same expression. The scope of variables differs in the two scenarios. For example, in the following measure the two variables <em class="calibre5">LineAmount</em> and <em class="calibre5">LineCost</em> are defined in two different scopes that are not nested. Thus, at no point in the code can <em class="calibre5">LineAmount</em> and <em class="calibre5">LineCost</em> both be accessed within the same expression:</p>
<p class="codelink"><a href="#calibre_link-697" id="calibre_link-2345" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Margin :=
SUMX (
    Sales,
    (
        VAR LineAmount = Sales[Quantity] * Sales[Net Price]
        RETURN
            LineAmount
    ) <strong class="calibre7">-- The parenthesis closes the scope of LineAmount</strong>
      <strong class="calibre7">-- The LineAmount variable is not accessible from here on in</strong>
    -
    (
        VAR LineCost = Sales[Quantity] * Sales[Unit Cost]
        RETURN
            LineCost
    )
)</pre></div>
<p class="edition">Clearly, this example is only for educational purposes. A better way of defining the two variables and of using them is the following definition of <em class="calibre5">Margin</em>:</p>
<p class="codelink"><a href="#calibre_link-698" id="calibre_link-2346" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Margin :=
SUMX (
    Sales,
    VAR LineAmount = Sales[Quantity] * Sales[Net Price]
    VAR LineCost = Sales[Quantity] * Sales[Unit Cost]
    RETURN
        LineAmount - LineCost
)</pre></div>
<p class="edition">As a further educational example, it is interesting to consider the real scope where a variable is accessible when the parentheses are not used and an expression defines and reads several variables in separate <em class="calibre5">VAR</em>/<em class="calibre5">RETURN</em> statements. For example, consider the following code:</p>
<p class="codelink"><a href="#calibre_link-699" id="calibre_link-2347" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Margin :=
SUMX (
    Sales,
    VAR LineAmount = Sales[Quantity] * Sales[Net Price]
    RETURN LineAmount
        -
          VAR LineCost = Sales[Quantity] * Sales[Unit Cost]
          RETURN LineCost -- Here LineAmount is still accessible
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2095"></span>The entire expression after the first <em class="calibre5">RETURN</em> is part of a single expression. Thus, the <em class="calibre5">LineCost</em> definition is nested within the <em class="calibre5">LineAmount</em> definition. Using the parentheses to delimit each <em class="calibre5">RETURN</em> expression and indenting the code appropriately makes this concept more visible:</p>
<p class="codelink"><a href="#calibre_link-700" id="calibre_link-2348" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Margin :=
SUMX (
    Sales,
    VAR LineAmount = Sales[Quantity] * Sales[Net Price]
    RETURN (
        LineAmount
        - VAR LineCost = Sales[Quantity] * Sales[Unit Cost]
          RETURN (
              LineCost
              <strong class="calibre7">-- Here LineAmount is still accessible</strong>
          )
    )
)</pre></div>
<p class="edition">As shown in the previous example, because a variable can be defined for any expression, a variable can also be defined within the expression assigned to another variable. In other words, it is possible to define nested variables. Consider the following example:</p>
<p class="codelink"><a href="#calibre_link-701" id="calibre_link-2349" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Amount at Current Price :=
SUMX (
    'Product',
    VAR CurrentPrice = 'Product'[Unit Price]
    RETURN -- CurrentPrice is available within the inner SUMX
        SUMX (
            RELATEDTABLE ( Sales ),
            VAR Quantity = Sales[Quantity]
            VAR AmountAtCurrentPrice = Quantity * CurrentPrice
            RETURN
                AmountAtCurrentPrice
        )
        <strong class="calibre7">-- Any reference to Quantity, or AmountAtCurrentPrice</strong>
        <strong class="calibre7">-- would be invalid outside of the innermost SUMX</strong>
)
<strong class="calibre7">-- Any reference to CurrentPrice</strong>
<strong class="calibre7">-- would be invalid outside of the outermost SUMX</strong></pre></div>
<p class="edition">The rules pertaining to the scope of variables are the following:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">A variable is available in the <em class="calibre5">RETURN</em> part of its <em class="calibre5">VAR/RETURN</em> block. It is also available in all the variables defined after the variable itself, within that <em class="calibre5">VAR/RETURN</em> block. The <em class="calibre5">VAR/RETURN</em> block replaces any DAX expression, and in such expression the variable can be read. In other words, the variable is accessible from its declaration point until the end of the expression following the <em class="calibre5">RETURN</em> statement that is part of the same <em class="calibre5">VAR/RETURN</em> block.</p></li>
<li class="calibre10"><p class="listp">A variable is never available outside of its own <em class="calibre5">VAR/RETURN</em> block definition. After the expression following the <em class="calibre5">RETURN</em> statement, the variables declared within the <em class="calibre5">VAR/RETURN</em> block are no longer visible. Referencing them generates a syntax error.</p></li>
</ul>
</section>
<section class="calibre4">
<h3 id="calibre_link-121" class="h2a"><span type="pagebreak" id="calibre_link-2083"></span>Using table variables</h3>
<p class="edition">A variable can store either a table or a scalar value. The type of the variable depends on its definition; for instance, if the expression used to define the variable is a table expression, then the variable contains a table. Consider the following code:</p>
<p class="codelink"><a href="#calibre_link-702" id="calibre_link-2350" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Amount :=
IF (
    HASONEVALUE ( Slicer[Factor] ),
    VAR
        Factor = VALUES ( Slicer[Factor] )
    RETURN
        DIVIDE (
            [Sales Amount],
            Factor
        )
)</pre></div>
<p class="edition">If <em class="calibre5">Slicer[Factor]</em> is a column with a single value in the current filter context, then it can be used as a scalar expression. The <em class="calibre5">Factor</em> variable stores a table because it contains the result of <em class="calibre5">VALUES</em>, which is a table function. If the user does not check for the presence of a single row with <em class="calibre5">HASONEVALUE</em>, the variable assignment works fine; the line raising an error is the second parameter of <em class="calibre5">DIVIDE</em>, where the variable is used, and conversion fails.</p>
<p class="edition">When a variable contains a table, it is likely because one wants to iterate on it. It is important to note that, during such iteration, one should access the columns of a table variable by using their original names. In other words, a variable name is not an alias of the underlying table in column references:</p>
<p class="codelink"><a href="#calibre_link-703" id="calibre_link-2351" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Filtered Amount :=
VAR
    MultiSales = FILTER ( Sales, Sales[Quantity] &gt; 1 )
RETURN
    SUMX (
        MultiSales,
        -- MultiSales is not a table name for column references
        -- Trying to access MultiSales[Quantity] would generate an error
        Sales[Quantity] * Sales[Net Price]
    )</pre></div>
<p class="edition">Although <em class="calibre5">SUMX</em> iterates over <em class="calibre5">MultiSales</em>, you must use the <em class="calibre5">Sales</em> table name to access the <em class="calibre5">Quantity</em> and <em class="calibre5">Net Price</em> columns. A column reference such <em class="calibre5">as MultiSales[Quantity]</em> is invalid.</p>
<p class="edition">One current DAX limitation is that a variable cannot have the same name as any table in the data model. This prevents the possible confusion between a table reference and a variable reference. Consider the following code:</p>
<p class="codelink"><a href="#calibre_link-704" id="calibre_link-2352" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SUMX (
    LargeSales,
    Sales[Quantity] * Sales[NetPrice]
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2092"></span>A human reader immediately understands that <em class="calibre5">LargeSales</em> should be a variable because the column references in the iterator reference another table name: <em class="calibre5">Sales</em>. However, DAX disambiguates at the language level through the distinctiveness of the name. A certain name can be either a table or a variable, but not both at the same time.</p>
<p class="edition">Although this looks like a convenient limitation because it reduces confusion, it might be problematic in the long run. Indeed, whenever you define the name of a variable, you should use a name that will never be used as a table name in the future. Otherwise, if at some point you create a new table whose name conflicts with variables used in any measure, you will obtain an error. Any syntax limitation that requires you to predict what will happen in the future&mdash;like choosing the name of a table&mdash;is an issue to say the least.</p>
<p class="edition">For this reason, when Power BI generates DAX queries, it uses variable names adopting a prefix with two underscores (__). The rationale is that a user is unlikely to use the same name in a data model.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">This behavior could change in the future, thus enabling a variable name to override the name of an existing table. When this change is implemented, there will no longer be a risk of breaking an existing DAX expression by giving a new table the name of a variable. When a variable name overrides a table name, the disambiguation will be possible by using the single quote to delimit the table identifier using the following syntax:</p>
<div class="program"><pre class="calibre14">variableName
'tableName'</pre></div>
<p class="edition">Should a developer design a DAX code generator to be injected in existing expressions, they can use the single quote to disambiguate table identifiers. This is not required in regular DAX code, if the code does not include ambiguous names between variables and tables.</p>
</div>
</section>
<section class="calibre4">
<h3 id="calibre_link-122" class="h2a">Understanding lazy evaluation</h3>
<p class="edition">As you have learned, DAX evaluates the variable within the evaluation context where it is defined, and not where it is being used. Still, the evaluation of the variable itself is delayed until its first use. This technique is known as <em class="calibre5">lazy evaluation</em>. Lazy evaluation is important for performance reasons: a variable that is never used in an expression will never be evaluated. Moreover, once a variable is computed for the first time, it will never be computed again in the same scope.</p>
<p class="edition">For example, consider the following code:</p>
<p class="codelink"><a href="#calibre_link-705" id="calibre_link-2353" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
VAR SalesAmount =
    SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
VAR DummyError =
    ERROR ( "This error will never be displayed" )
RETURN
    SalesAmount</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1873"></span>The variable <em class="calibre5">DummyError</em> is never used, so its expression is never executed. Therefore, the error never happens and the measure works correctly.</p>
<p class="edition">Obviously, nobody would ever write code like this. The goal of the example is to show that DAX does not spend precious CPU time evaluating a variable if it is not useful to do so, and you can rely on this behavior when writing code.</p>
<p class="edition">If a sub-expression is used multiple times in a complex expression, then creating a variable to store its value is always a best practice. This guarantees that evaluation only happens once. Performance-wise, this is more important than you might think. We will discuss this in more detail in <a href="#calibre_link-25" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 20</a>, but we cover the general idea here.</p>
<p class="edition">The DAX optimizer features a process called sub-formula detection. In a complex piece of code, sub-formula detection checks for repeating sub-expressions that should only be computed once. For example, look at the following code:</p>
<p class="codelink"><a href="#calibre_link-706" id="calibre_link-2354" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SalesAmount := SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
TotalCost   := SUMX ( Sales, Sales[Quantity] * Sales[Unit Cost] )
Margin      := [SalesAmount] &ndash; [TotalCost]
Margin%     := DIVIDE ( [Margin], [TotalCost] )</pre></div>
<p class="edition">The <em class="calibre5">TotalCost</em> measure is called twice&mdash;once in <em class="calibre5">Margin</em> and once in <em class="calibre5">Margin%</em>. Depending on the quality of the optimizer, it might be able to detect that both measure calls refer to the same value, so it might be able to compute <em class="calibre5">TotalCost</em> only once. Nevertheless, the optimizer is not always able to detect that a sub-formula exists and that it can be evaluated only once. As a human, and being the author of your own code, you always have a much better understanding of when part of the code can be used in multiple parts of your formula.</p>
<p class="edition">If you get used to using variables whenever you can, defining sub-formulas as variables will come naturally. When you use their value multiple times, you will greatly help the optimizer in finding the best execution path for your code.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-123" class="h2a">Common patterns using variables</h3>
<p class="edition">In this section, you find practical uses of variables. It is not an exhaustive list of scenarios where variables become useful, and although there are many other situations where a variable would be a good fit, these are relevant and frequent uses.</p>
<p class="edition">The first and most relevant reason to use variables is to provide documentation in your code. A good example is when you need to use complex filters in a <em class="calibre5">CALCULATE</em> function. Using variables as <em class="calibre5">CALCULATE</em> filters only improves readability. It does not change semantics or performance. Filters would be executed outside of the context transition triggered by <em class="calibre5">CALCULATE</em> in any case, and DAX also <span type="pagebreak" id="calibre_link-1874"></span>uses lazy evaluation for filter contexts. Nevertheless, improving readability is an important task for any DAX developer. For example, consider the following measure definition:</p>
<p class="codelink"><a href="#calibre_link-707" id="calibre_link-2355" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Large Customers :=
VAR LargeCustomers =
    FILTER (
        Customer,
        [Sales Amount] &gt; 10000
    )
VAR WorkingDaysIn2008 =
    CALCULATETABLE (
        ALL ( 'Date'[IsWorkingDay], 'Date'[Calendar Year] ),
        'Date'[IsWorkingDay] = TRUE (),
        'Date'[Calendar Year] = "CY 2008"
    )
RETURN
    CALCULATE (
        [Sales Amount],
        LargeCustomers,
        WorkingDaysIn2008
    )</pre></div>
<p class="edition">Using the two variables for the filtered customers and the filtered dates splits the full execution flow into three distinct parts: the definition of what a large customer is, the definition of the period one wants to consider, and the actual calculation of the measure with the two filters applied.</p>
<p class="edition">Although it might look like we are only talking about style, you should never forget that a more elegant and simple formula is more likely to also be an accurate formula. Writing a simpler formula, the author is more likely to have understood the code and fixed any possible flaws. Whenever an expression takes more than 10 lines of code, it is time to split its execution path with multiple variables. This allows the author to focus on smaller fragments of the full formula.</p>
<p class="edition">Another scenario where variables are important is when nesting multiple row contexts on the same table. In this scenario, variables let you save data from hidden row contexts and avoid the use of the <em class="calibre5">EARLIER</em> function:</p>
<p class="codelink"><a href="#calibre_link-708" id="calibre_link-2356" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[RankPrice] =
VAR CurrentProductPrice = 'Product'[Unit Price]
VAR MoreExpensiveProducts =
    FILTER (
        'Product',
        'Product'[Unit Price] &gt; CurrentProductPrice
    )
RETURN
    COUNTROWS ( MoreExpensiveProducts ) + 1</pre></div>
<p class="edition">Filter contexts can be nested too. Nesting multiple filter contexts does not create syntax problems as it does with multiple row contexts. One frequent scenario with nested filter contexts is needing to save the result of a calculation to use it later in the code when the filter context changes.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2045"></span>For example, if one needs to search for the customers who bought more than the average customer, this code is not going to work:</p>
<p class="codelink"><a href="#calibre_link-709" id="calibre_link-2357" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AverageSalesPerCustomer :=
AVERAGEX ( Customer, [Sales Amount] )

CustomersBuyingMoreThanAverage :=
COUNTROWS (
    FILTER (
        Customer,
        [Sales Amount] &gt; [AverageSalesPerCustomer]
    )
)</pre></div>
<p class="edition">The reason is that the <em class="calibre5">AverageSalesPerCustomer</em> measure is evaluated inside an iteration over <em class="calibre5">Customer</em>. As such, there is a hidden <em class="calibre5">CALCULATE</em> around the measure that performs a context transition. Thus, <em class="calibre5">AverageSalesPerCustomer</em> evaluates the sales of the current customer inside the iteration every time, instead of the average over all the customers in the filter context. There is no customer whose sales amount is strictly greater than the sales amount itself. The measure always returns blank.</p>
<p class="edition">To obtain the correct behavior, one needs to evaluate <em class="calibre5">AverageSalesPerCustomer</em> outside of the iteration. A variable fits this requirement perfectly:</p>
<p class="codelink"><a href="#calibre_link-710" id="calibre_link-2358" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AverageSalesPerCustomer :=
AVERAGEX ( Customer, [Sales Amount] )

CustomersBuyingMoreThanAverage :=
VAR AverageSales = [AverageSalesPerCustomer]
RETURN
    COUNTROWS (
        FILTER (
            Customer,
            [Sales Amount] &gt; AverageSales
        )
    )</pre></div>
<p class="edition">In this example DAX evaluates the variable outside of the iteration, computing the correct average sales for all the selected customers. Moreover, the optimizer knows that the variable can (and must) be evaluated only once, outside of the iteration. Thus, the code is likely to be faster than any other possible implementation.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-124" class="h2a">Conclusions</h3>
<p class="edition">Variables are useful for multiple reasons: readability, performance, and elegance of the code. Whenever you need to write a complex formula, split it into multiple variables. You will appreciate having done so the next time you review your code.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3027"></span>It is true that expressions using variables tend to be longer than the same expressions without variables. A longer expression is not a bad thing if it means that each part is easier to understand. Unfortunately, in several tools the user interface to author DAX code makes it hard to write expressions over 10 lines long. You might think that a shorter formulation of the same code without variables is preferable because it is easier to author in a specific tool&mdash;for example Power BI. That is incorrect.</p>
<p class="edition">We certainly need better tools to author longer DAX code that includes comments and many variables. These tools will come eventually. In the meantime, rather than authoring shorter and confusing code directly into a small text box, it is wiser to use external tools like DAX Studio to author longer DAX code. You would then copy and paste the resulting code into Power BI or Visual Studio.</p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-711">
<div id="calibre_link-3028" class="calibre2">
<div id="calibre_link-3029" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-12"><span type="pagebreak" id="calibre_link-2082"></span><span class="pd_ash">Chapter 7</span><br class="calibre3" />Working with iterators and with <em class="calibre5">CALCULATE</em></h2>
<p class="edition">In previous chapters we provided the theoretical foundations of DAX: row context, filter context, and context transition. These are the pillars any DAX expression is built on. We already introduced iterators, and we used them in many different formulas. However, the real power of iterators starts to show when they are being used in conjunction with evaluation contexts and context transition.</p>
<p class="edition">In this chapter we take iterators to the next level, by describing the most common uses of iterators and by introducing many new iterators. Learning how to leverage iterators in your code is an important skill to acquire. Indeed, using iterators and context transition together is a feature that is unique to the DAX language. In our teaching experience, students usually struggle with learning the power of iterators. But that does not mean that the use of iterators is difficult to understand. The concept of iteration is simple, as is the usage of iterators in conjunction with context transition. What is hard is realizing that the solution to a complex calculation is resorting to an iteration. For this reason, we provide several examples of calculations that are simple to create with the help of iterators.</p>
<section class="calibre4">
<h3 id="calibre_link-125" class="h2a">Using iterators</h3>
<p class="edition">Most iterators accept at least two parameters: the table to iterate and an expression that the iterator evaluates on a row-by-row basis, in the row context generated during the iteration. A simple expression using <em class="calibre5">SUMX</em> will support our explanation:</p>
<p class="codelink"><a href="#calibre_link-712" id="calibre_link-2360" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX (
    Sales,                               -- Table to iterate
    Sales[Quantity] * Sales[Net Price]   -- Expression to evaluate row by row
)</pre></div>
<p class="edition"><em class="calibre5">SUMX</em> iterates the <em class="calibre5">Sales</em> table, and for each row it computes the expression by multiplying quantity by net price. Iterators differ from one another in the use they make of the partial results gathered during the iteration. <em class="calibre5">SUMX</em> is a simple iterator that aggregates these results using sum.</p>
<p class="edition">It is important to understand the difference between the two parameters. The first argument is the value resulting from a table expression to iterate. Being a value parameter, it is evaluated before the iteration starts. The second parameter, on the other hand, is an expression that is not evaluated before <span type="pagebreak" id="calibre_link-1747"></span>the execution of <em class="calibre5">SUMX</em>. Instead, the iterator evaluates the expression in the row context of the iteration. The official Microsoft documentation does not provide an accurate classification of the iterator functions. More specifically, it does not indicate which parameters represent a value and which parameters represent an expression evaluated during the iteration. On <a href="https://dax.guide" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://dax.guide</a> all the functions that evaluate an expression in a row context have a special marker (ROW CONTEXT) to identify the argument executed in a row context. Any function that has an argument marked with ROW CONTEXT is an iterator.</p>
<p class="edition">Several iterators accept additional arguments after the first two. For example, <em class="calibre5">RANKX</em> is an iterator that accepts many arguments, whereas <em class="calibre5">SUMX</em>, <em class="calibre5">AVERAGEX</em> and simple iterators only use two arguments. In this chapter we describe many iterators individually. But first, we go deeper on a few important aspects of iterators.</p>
<section class="calibre4">
<h4 id="calibre_link-126" class="calibre13">Understanding iterator cardinality</h4>
<p class="edition">The first important concept to understand about iterators is the <em class="calibre5">iterator cardinality</em>. The cardinality of an iterator is the number of rows being iterated. For example, in the following iteration if <em class="calibre5">Sales</em> has one million rows, then the cardinality is one million:</p>
<p class="codelink"><a href="#calibre_link-713" id="calibre_link-2361" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX (
    Sales,                              -- Sales has 1M rows, as a consequence
    Sales[Quantity] * Sales[Net Price]  -- the expression is evaluated one million times
)</pre></div>
<p class="edition">When speaking about cardinality, we seldom use numbers. In fact, the cardinality of the previous example depends on the number of rows of the <em class="calibre5">Sales</em> table. Thus, we prefer to say that the cardinality of the iterator is the same as the cardinality of <em class="calibre5">Sales</em>. The more rows in <em class="calibre5">Sales</em>, the higher the number of iterated rows.</p>
<p class="edition">In the presence of nested iterators, the resulting cardinality is a combination of the cardinality of the two iterators&mdash;up to the product of the two original tables. For example, consider the following formula:</p>
<p class="codelink"><a href="#calibre_link-714" id="calibre_link-2362" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales at List Price 1 :=
SUMX (
    'Product',
    SUMX (
        RELATEDTABLE ( Sales ),
        'Product'[Unit Price] * Sales[Quantity]
    )
)</pre></div>
<p class="edition">In this example there are two iterators. The outer iterates <em class="calibre5">Product</em>. As such, its cardinality is the cardinality of <em class="calibre5">Product</em>. Then for each product the inner iteration scans the <em class="calibre5">Sales</em> table, limiting its iteration to the rows in <em class="calibre5">Sales</em> that have a relationship with the given product. In this case, because each row in <em class="calibre5">Sales</em> is pertinent to only one product, the full cardinality is the cardinality of <em class="calibre5">Sales</em>. If the inner table expression is not related to the outer table expression, then the cardinality becomes much higher. <span type="pagebreak" id="calibre_link-3030"></span>For example, consider the following code. It computes the same value as the previous code, but instead of relying on relationships, it uses an <em class="calibre5">IF</em> function to filter the sales of the current product:</p>
<p class="codelink"><a href="#calibre_link-715" id="calibre_link-2363" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales at List Price High Cardinality :=
SUMX (
    VALUES ( 'Product' ),
    SUMX (
        Sales,
        IF (
             Sales[ProductKey] = 'Product'[ProductKey],
             'Product'[Unit Price] * Sales[Quantity],
             0
        )
    )
)</pre></div>
<p class="edition">In this example the inner <em class="calibre5">SUMX</em> always iterates over the whole <em class="calibre5">Sales</em> table, relying on the internal IF statement to check whether the product should be considered or not for the calculation. In this case, the outer <em class="calibre5">SUMX</em> has the cardinality of <em class="calibre5">Product</em>, whereas the inner <em class="calibre5">SUMX</em> has the cardinality of <em class="calibre5">Sales</em>. The cardinality of the whole expression is <em class="calibre5">Product</em> times <em class="calibre5">Sales</em>; much higher than the first example. Be mindful that this example is for educational purposes only. It would result in bad performance if one ever used such a pattern in a DAX expression.</p>
<p class="edition">A better way to express this code is the following:</p>
<p class="codelink"><a href="#calibre_link-716" id="calibre_link-2364" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales at List Price 2 :=
SUMX (
    Sales,
    RELATED ( 'Product'[Unit Price] ) * Sales[Quantity]
)</pre></div>
<p class="edition">The cardinality of the entire expression is the same as in the <em class="calibre5">Sales at List Price 1</em> measure, but the latter has a better execution plan. Indeed, it avoids nested iterators. Nested iterations mostly happen because of context transition. In fact, by looking at the following code, one might think that there are no nested iterators:</p>
<p class="codelink"><a href="#calibre_link-717" id="calibre_link-2365" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales at List Price 3 :=
SUMX (
    'Product',
    'Product'[Unit Price] * [Total Quantity]
)</pre></div>
<p class="edition">However, inside the iteration there is a reference to a measure (<em class="calibre5">Total Quantity</em>) which we need to consider. In fact, here is the expanded definition of <em class="calibre5">Total Quantity</em>:</p>
<p class="codelink"><a href="#calibre_link-718" id="calibre_link-2366" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Total Quantity :=
SUM ( Sales[Quantity] )    -- Internally translated into SUMX ( Sales, Sales[Quantity] )

Sales at List Price 4 :=
SUMX (
    'Product',
<span type="pagebreak" id="calibre_link-1866"></span>    'Product'[Unit Price] *
        CALCULATE (
            SUMX (
                Sales,
                Sales[Quantity]
            )
        )
)</pre></div>
<p class="edition">You can now see that there is a nested iteration&mdash;that is, a <em class="calibre5">SUMX</em> inside another <em class="calibre5">SUMX</em>. Moreover, the presence of <em class="calibre5">CALCULATE</em>, which performs a context transition, is also made visible.</p>
<p class="edition">From a performance point of view, when there are nested iterators, only the innermost iterator can be optimized with the more efficient query plan. The presence of outer iterators requires the creation of temporary tables in memory. These temporary tables store the intermediate result produced by the innermost iterator. This results in slower performance and higher memory consumption. As a consequence, nested iterators should be avoided if the cardinality of the outer iterators is very large&mdash;in the order of several million rows.</p>
<p class="edition">Please note that in the presence of context transition, unfolding nested iterations is not as easy as it might seem. In fact, a typical mistake is to obtain nested iterators by writing a measure that is supposed to reuse an existing measure. This could be dangerous when the existing logic of a measure is reused within an iterator. For example, consider the following calculation:</p>
<p class="codelink"><a href="#calibre_link-719" id="calibre_link-2367" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales at List Price 5 :=
SUMX (
    'Sales',
    RELATED ( 'Product'[Unit Price] ) * [Total Quantity]
)</pre></div>
<p class="edition">The <em class="calibre5">Sales at List Price 5</em> measure seems identical to <em class="calibre5">Sales at List Price 3</em>. Unfortunately, <em class="calibre5">Sales at List Price 5</em> violates several of the rules of context transition outlined in <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>, “<a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em></a>”: It performs context transition on a large table (<em class="calibre5">Sales</em>), and worse, it performs context transition on a table where the rows are not guaranteed to be unique. Consequently, the formula is slow and likely to produce incorrect results.</p>
<p class="edition">This is not to say that nested iterations are always bad. There are various scenarios where the use of nested iterations is convenient. In fact, in the rest of this chapter we show many examples where nested iterators are a powerful tool to use.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-127" class="calibre13">Leveraging context transition in iterators</h4>
<p class="edition">A calculation might require nested iterators, usually when it needs to compute a measure in different contexts. These are the scenarios where using context transition is powerful and allows for the concise, efficient writing of complex calculations.</p>
<p class="edition">For example, consider a measure that computes the maximum daily sales in a time period. The definition of the measure is important because it defines the granularity right away. Indeed, one needs to first compute the daily sales in the given period, then find the maximum value in the list of computed <span type="pagebreak" id="calibre_link-3031"></span>values. Even though it would seem intuitive to create a table containing daily sales and then use <em class="calibre5">MAX</em> on it, in DAX you are not required to build such a table. Instead, iterators are a convenient way of obtaining the desired result without any additional table.</p>
<p class="edition">The idea of the algorithm is the following:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Iterate over the <em class="calibre5">Date</em> table.</p></li>
<li class="calibre10"><p class="listp">Compute the sales amount for each day.</p></li>
<li class="calibre10"><p class="listp">Find the maximum of all the values computed in the previous step.</p></li>
</ul>
<p class="edition">You can write this measure by using the following approach:</p>
<p class="codelink"><a href="#calibre_link-720" id="calibre_link-2368" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Max Daily Sales 1 :=
MAXX (
    'Date',
    VAR DailyTransactions =
        RELATEDTABLE ( Sales )
    VAR DailySales =
        SUMX (
            DailyTransactions,
            Sales[Quantity] * Sales[Net Price]
        )
    RETURN
        DailySales
)</pre></div>
<p class="edition">However, a simpler approach is the following, which leverages the implicit context transition of the measure <em class="calibre5">Sales Amount</em>:</p>
<p class="codelink"><a href="#calibre_link-721" id="calibre_link-2369" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX (
    Sales,
    Sales[Quantity] * Sales[Net Price]
)

Max Daily Sales 2 :=
MAXX (
    'Date',
    [Sales Amount]
)</pre></div>
<p class="edition">In both cases there are two nested iterators. The outer iteration happens on the <em class="calibre5">Date</em> table, which is expected to contain a few hundred rows. Moreover, each row in <em class="calibre5">Date</em> is unique. Thus, both calculations are safe and quick. The former version is more complete, as it outlines the full algorithm. On the other hand, the second version of <em class="calibre5">Max Daily Sales</em> hides many details and makes the code more readable, leveraging context transition to move the filter from <em class="calibre5">Date</em> over to <em class="calibre5">Sales</em>.</p>
<p class="edition">You can view the result of this measure in <a href="#calibre_link-722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-1</a> that shows the maximum daily sales for each month.</p>
<figure id="calibre_link-722" class="image-l">
<img src="images/000873.jpg" alt="The figure shows a report with Sales Amount and Max Daily Sales measures on the columns and the Calendar Year and Month on the rows." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3032"></span><strong class="calibre7">Figure 7-1</strong> The report shows the <em class="calibre5">Max Daily Sales</em> measure computed by month and year.</figcaption>
</figure>
<p class="edition">By leveraging context transition and an iteration, the code is usually more elegant and intuitive to write. The only issue you should be aware of is the cost involved in context transition: it is a good idea to avoid measure references in large iterators.</p>
<p class="edition">By looking at the report in <a href="#calibre_link-722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-1</a>, a logical question is: When did sales hit their maximum? For example, the report is indicating that in one certain day in January 2007, Contoso sold 92,244.07 USD. But in which day did it happen? Iterators and context transition are powerful tools to answer this question. Look at the following code:</p>
<p class="codelink"><a href="#calibre_link-723" id="calibre_link-2370" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Date of Max =
VAR MaxDailySales = [Max Daily Sales]
VAR DatesWithMax =
    FILTER (
        VALUES ( 'Date'[Date] ),
        [Sales Amount] = MaxDailySales
    )
VAR Result =
    IF (
        COUNTROWS ( DatesWithMax ) = 1,
        DatesWithMax,
        BLANK ()
    )
RETURN
    Result</pre></div>
<p class="edition">The formula first stores the value of the <em class="calibre5">Max Daily Sales</em> measure into a variable. Then, it creates a temporary table containing the dates where sales equals <em class="calibre5">MaxDailySales</em>. If there is only one date when <span type="pagebreak" id="calibre_link-3033"></span>this happened, then the result is the only row which passed the filter. If there are multiple dates, then the formula blanks its result, showing that a single date cannot be determined. You can look at the result of this code in <a href="#calibre_link-724" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-2</a>.</p>
<figure id="calibre_link-724" class="image-l">
<img src="images/000881.jpg" alt="The image shows a report with Sales Amount, Max Daily Sales, and Date of Max measures on the columns and the Calendar Year and Month on the rows." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-2</strong> The <em class="calibre5">Date of Max</em> measures make it clear which unique date generated the maximum sales.</figcaption>
</figure>
<p class="edition">The use of iterators in DAX requires you to always define, in this order:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The granularity at which you want the calculation to happen,</p></li>
<li class="calibre10"><p class="listp">The expression to evaluate at the given granularity,</p></li>
<li class="calibre10"><p class="listp">The kind of aggregation to use.</p></li>
</ul>
<p class="edition">In the previous example (<em class="calibre5">Max Daily Sales 2</em>) the granularity is the date, the expression is the amount of sales, and the aggregation to use is <em class="calibre5">MAX</em>. The result is the maximum daily sales.</p>
<p class="edition">There are several scenarios where the same pattern can be useful. Another example could be displaying the average customer sales. If you think about it in terms of iterators using the pattern described above, you obtain the following: Granularity is the individual customer, the expression to use is sales amount, and the aggregation is <em class="calibre5">AVERAGE</em>.</p>
<p class="edition">Once you follow this mental process, the formula is short and easy:</p>
<p class="codelink"><a href="#calibre_link-725" id="calibre_link-2371" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Avg Sales by Customer :=
AVERAGEX ( Customer, [Sales Amount] )</pre></div>
<p class="edition">With this simple formula, one can easily build powerful reports like the one in <a href="#calibre_link-726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-3</a> that shows the average sales per customer by continent and year.</p>
<figure id="calibre_link-726" class="image-l">
<img src="images/000889.jpg" alt="The image shows a matrix with three continents on the rows and three years (from 2007 to 2009) on the columns, plus total by row and column." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1895"></span><strong class="calibre7">Figure 7-3</strong> The <em class="calibre5">Avg Sales by Customer</em> measure computed by year and by continent.</figcaption>
</figure>
<p class="edition">Context transition in iterators is a powerful tool. It can also be expensive, so always checking the cardinality of the outer iterator is a good practice. This will result in more efficient DAX code.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-128" class="calibre13">Using <em class="calibre5">CONCATENATEX</em></h4>
<p class="edition">In this section, we show a convenient usage of <em class="calibre5">CONCATENATEX</em> to display the filters applied to a report in a user-friendly way. Suppose you build a simple visual that shows sales sliced by year and continent, and you put it in a more complex report where the user has the option of filtering colors using a slicer. The slicer might be near the visual or it might be in a different page.</p>
<p class="edition">If the slicer is in a different page, then looking at the visual, it is not clear whether the numbers displayed are a subset of the whole dataset or not. In that case it would be useful to add a label to the report, showing the selection made by the user in textual form as in <a href="#calibre_link-727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-4</a>.</p>
<figure id="calibre_link-727" class="image-l">
<img src="images/000897.jpg" alt="The image shows a matrix with continents on the rows and years on the columns. A line describes the filters applied, saying “Showing Black, Blue, Brown, Green colors.”" class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-4</strong> The label at the bottom of the visual indicates which filters are being applied.</figcaption>
</figure>
<p class="edition">One can inspect the values of the selected colors by querying the <em class="calibre5">VALUES</em> function. Nevertheless, <em class="calibre5">CONCATENATEX</em> is required to convert the resulting table into a string. Look at the definition of the <em class="calibre5">Selected Colors</em> measure, which we used to show the colors in <a href="#calibre_link-727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-4</a>:</p>
<p class="codelink"><a href="#calibre_link-728" id="calibre_link-2372" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Selected Colors :=
"Showing " &amp;
CONCATENATEX (
    VALUES ( 'Product'[Color] ),
    'Product'[Color],
    ", ",
<span type="pagebreak" id="calibre_link-3034"></span>    'Product'[Color],
    ASC
) &amp; " colors."</pre></div>
<p class="edition"><em class="calibre5">CONCATENATEX</em> iterates over the values of product color and creates a string containing the list of these colors separated by a comma. As you can see, <em class="calibre5">CONCATENATEX</em> accepts multiple parameters. As usual, the first two are the table to scan and the expression to evaluate. The third parameter is the string to use as the separator between expressions. The fourth and the fifth parameters indicate the sort order and its direction (<em class="calibre5">ASC</em> or <em class="calibre5">DESC</em>).</p>
<p class="edition">The only drawback of this measure is that if there is no selection on the color, it produces a long list with all the colors. Moreover, in the case where there are more than five colors, the list would be too long anyway and the user experience sub-optimal. Nevertheless, it is easy to fix both problems by making the code slightly more complex to detect these situations:</p>
<p class="codelink"><a href="#calibre_link-729" id="calibre_link-2373" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Selected Colors :=
VAR Colors =
    VALUES ( 'Product'[Color] )
VAR NumOfColors =
    COUNTROWS ( Colors )
VAR NumOfAllColors =
    COUNTROWS (
        ALL ( 'Product'[Color] )
    )
VAR AllColorsSelected = NumOfColors = NumOfAllColors
VAR SelectedColors =
    CONCATENATEX (
        Colors,
        'Product'[Color],
        ", ",
        'Product'[Color], ASC
    )
VAR Result =
    IF (
        AllColorsSelected,
        "Showing all colors.",
        IF (
            NumOfColors &gt; 5,
            "More than 5 colors selected, see slicer page for details.",
            "Showing " &amp; SelectedColors &amp; " colors."
        )
    )
RETURN
    Result</pre></div>
<p class="edition">In <a href="#calibre_link-730" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-5</a> you can see two results for the same visual, with different selections for the colors. With this latter version, it is much clearer whether the user needs to look at more details or not about the color selection.</p>
<figure id="calibre_link-730" class="image-l">
<img src="images/000904.jpg" alt="The figure shows two matrixes with continents on the rows and years on the columns. A line describes the filters for each matrix. The first displays “More than 5 colors selected, see slicer page for details.” The second displays “Showing all colors.”" class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1653"></span><strong class="calibre7">Figure 7-5</strong> Depending on the filters, the label now shows user-friendly descriptions of the filtering.</figcaption>
</figure>
<p class="edition">This latter version of the measure is not perfect yet. In the case where the user selects five colors, but only four are present in the current selection because other filters hide some colors, then the measure does not report the complete list of colors. It only reports the existing list. In <a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10</a>, “<a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with the filter context</a>,” we describe a different version of this measure that addresses this last detail. In fact, to author the final version, we first need to describe a set of new functions that aim at investigating the content of the current filter context.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-129" class="calibre13">Iterators returning tables</h4>
<p class="edition">So far, we have described iterators that aggregate an expression. There are also iterators that return a table produced by merging a source table with one or more expressions evaluated in the row context of the iteration. <em class="calibre5">ADDCOLUMNS</em> and <em class="calibre5">SELECTCOLUMNS</em> are the most interesting and useful. They are the topic of this section.</p>
<p class="edition">As its name implies, <em class="calibre5">ADDCOLUMNS</em> adds new columns to the table expression provided as the first parameter. For each added column, <em class="calibre5">ADDCOLUMNS</em> requires knowing the column name and the expression that defines it.</p>
<p class="edition">For example, you can add two columns to the list of colors, including for each color the number of products and the value of <em class="calibre5">Sales Amount</em> in two new columns:</p>
<p class="codelink"><a href="#calibre_link-731" id="calibre_link-2374" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Colors =
ADDCOLUMNS (
    VALUES ( 'Product'[Color] ),
    "Products", CALCULATE ( COUNTROWS ( 'Product' ) ),
    "Sales Amount", [Sales Amount]
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1885"></span>The result of this code is a table with three columns: the product color, which is coming from the values of <em class="calibre5">Product[Color]</em>, and the two new columns added by <em class="calibre5">ADDCOLUMNS</em> as you can see in <a href="#calibre_link-732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-6</a>.</p>
<figure id="calibre_link-732" class="image-l">
<img src="images/000912.jpg" alt="The image shows a table with colors on the rows and the measures Sales Amount and Products on the columns." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-6</strong> The <em class="calibre5">Sales Amount</em> and <em class="calibre5">Products</em> columns are computed by <em class="calibre5">ADDCOLUMNS</em>.</figcaption>
</figure>
<p class="edition"><em class="calibre5">ADDCOLUMNS</em> returns all the columns of the table expression it iterates, adding the requested columns. To keep only a subset of the columns of the original table expression, an option is to use <em class="calibre5">SELECTCOLUMNS</em>, which only returns the requested columns. For instance, you can rewrite the previous example of <em class="calibre5">ADDCOLUMNS</em> by using the following query:</p>
<p class="codelink"><a href="#calibre_link-733" id="calibre_link-2375" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Colors =
SELECTCOLUMNS (
    VALUES ( 'Product'[Color] ),
    "Color", 'Product'[Color],
    "Products", CALCULATE ( COUNTROWS ( 'Product' ) ),
    "Sales Amount", [Sales Amount]
)</pre></div>
<p class="edition">The result is the same, but you need to explicitly include the <em class="calibre5">Color</em> column of the original table to obtain the same result. <em class="calibre5">SELECTCOLUMNS</em> is useful whenever you need to reduce the number of columns of a table, oftentimes resulting from some partial calculations.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3035"></span><em class="calibre5">ADDCOLUMNS</em> and <em class="calibre5">SELECTCOLUMNS</em> are useful to create new tables, as you have seen in this first example. These functions are also often used when authoring measures to make the code easier and faster. As an example, look at the measure, defined earlier in this chapter, that aims at finding the date with the maximum daily sales:</p>
<p class="codelink"><a href="#calibre_link-734" id="calibre_link-2376" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Max Daily Sales :=
MAXX (
    'Date',
    [Sales Amount]
)

Date of Max :=
VAR MaxDailySales = [Max Daily Sales]
VAR DatesWithMax =
    FILTER (
        VALUES ( 'Date'[Date] ),
        [Sales Amount] = MaxDailySales
    )
VAR Result =
    IF (
        COUNTROWS ( DatesWithMax ) = 1,
        DatesWithMax,
        BLANK ()
    )
RETURN
    Result</pre></div>
<p class="edition">If you look carefully at the code, you will notice that it is not optimal in terms of performance. In fact, as part of the calculation of the variable <em class="calibre5">MaxDailySales</em>, the engine needs to compute the daily sales to find the maximum value. Then, as part of the second variable evaluation, it needs to compute the daily sales again to find the dates when the maximum sales happened. Thus, the engine performs two iterations on the <em class="calibre5">Date</em> table, and each time it computes the sales amount for each date. The DAX optimizer might be smart enough to understand that it can compute the daily sales only once, and then use the previous result the second time you need it, but this is not guaranteed to happen. Nevertheless, by refactoring the code leveraging <em class="calibre5">ADDCOLUMNS</em>, one can write a faster version of the same measure. This is achieved by first preparing a table with the daily sales and storing it into a variable, then using this first&mdash;partial&mdash;result to compute both the maximum daily sales and the date with the maximum sales:</p>
<p class="codelink"><a href="#calibre_link-735" id="calibre_link-2377" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Date of Max :=
VAR DailySales =
    ADDCOLUMNS (
        VALUES ( 'Date'[Date] ),
        "Daily Sales", [Sales Amount]
    )
VAR MaxDailySales = MAXX ( DailySales, [Daily Sales] )
VAR DatesWithMax =
    SELECTCOLUMNS (
        FILTER (
            DailySales,
            [Daily Sales] = MaxDailySales
<span type="pagebreak" id="calibre_link-1654"></span>        ),
        "Date", 'Date'[Date]
    )
VAR Result =
IF (
    COUNTROWS ( DatesWithMax ) = 1,
    DatesWithMax,
    BLANK ()
)
RETURN
    Result</pre></div>
<p class="edition">The algorithm is close to the previous one, with some noticeable differences:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The <em class="calibre5">DailySales</em> variable contains a table with date, and sales amount on each given date. This table is created by using <em class="calibre5">ADDCOLUMNS</em>.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">MaxDailySales</em> no longer computes the daily sales. It scans the precomputed <em class="calibre5">DailySales</em> variable, resulting in faster execution time.</p></li>
<li class="calibre10"><p class="listp">The same happens with <em class="calibre5">DatesWithMax</em>, which scans the <em class="calibre5">DailySales</em> variable. Because after that point the code only needs the date and no longer the daily sales, we used <em class="calibre5">SELECTCOLUMNS</em> to remove the daily sales from the result.</p></li>
</ul>
<p class="edition">This latter version of the code is more complex than the original version. This is often the price to pay when optimizing code: Worrying about performance means having to write more complex code.</p>
<p class="edition">You will see <em class="calibre5">ADDCOLUMNS</em> and <em class="calibre5">SELECTCOLUMNS</em> in more detail in <a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 12</a>, “<a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with tables</a>,” and in <a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 13</a>, “<a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Authoring queries</a>.” There are many details that are important there, especially if you want to use the result of <em class="calibre5">SELECTCOLUMNS</em> in other iterators that perform context transition.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-130" class="h2a">Solving common scenarios with iterators</h3>
<p class="edition">In this section we continue to show examples of known iterators and we also introduce a common and useful one: <em class="calibre5">RANKX</em>. You start learning how to compute moving averages and the difference between using an iterator or a straight calculation for the average. Later in this section, we provide a complete description of the <em class="calibre5">RANKX</em> function, which is extremely useful to compute ranking based on expressions.</p>
<section class="calibre4">
<h4 id="calibre_link-131" class="calibre13">Computing averages and moving averages</h4>
<p class="edition">You can calculate the mean (arithmetic average) of a set of values by using one of the following DAX functions:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7"><em class="calibre5">AVERAGE</em></strong>: returns the average of all the numbers in a numeric column.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7"><em class="calibre5">AVERAGEX</em></strong>: calculates the average on an expression evaluated over a table.</p></li>
</ul>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">DAX also provides the <em class="calibre5">AVERAGEA</em> function, which returns the average of all the numbers in a text column. However, you should not use it. <em class="calibre5">AVERAGEA</em> only exists in DAX for Excel compatibility. The main issue of <em class="calibre5">AVERAGEA</em> is that when you use a text column as an argument, it does not try to convert each text row to a number as Excel does. Instead, if you pass a string column as an argument, you always obtain 0 as a result. That is quite useless. On the other hand, <em class="calibre5">AVERAGE</em> would return an error, clearly indicating that it cannot average strings.</p>
</div>
<p class="edition"><span type="pagebreak" id="calibre_link-3036"></span>We discussed how to compute regular averages over a table earlier in this chapter. Here we want to show a more advanced usage, that is a moving average. For example, imagine that you want to analyze the daily sales of Contoso. If you just build a report that plots the sales amount sliced by day, the result is hard to analyze. As you can see in <a href="#calibre_link-736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-7</a>, the value obtained has strong daily variations.</p>
<figure id="calibre_link-736" class="image-l">
<img src="images/000918.jpg" alt="The image shows a line chart plotting the Sales Amount by day in 2008." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-7</strong> Plotting the sales amount on a daily basis is a hard report to read.</figcaption>
</figure>
<p class="edition">To smooth out the chart, a common technique is to compute the average over a certain period greater than just the day level. In our example, we decided to use 30 days as our period. Thus, on each day the chart shows the average over the last 30 days. This technique helps in removing peaks from the chart, making it easier to detect a trend.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1743"></span>The following calculation provides the average at the date cardinality, over the last 30 days:</p>
<p class="codelink"><a href="#calibre_link-737" id="calibre_link-2378" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AvgXSales30 :=
VAR LastVisibleDate = MAX ( 'Date'[Date] )
VAR NumberOfDays = 30
VAR PeriodToUse =
    FILTER (
        ALL ( 'Date' ),
        AND (
            'Date'[Date] &gt; LastVisibleDate - NumberOfDays,
            'Date'[Date] &lt;= LastVisibleDate
        )
    )
VAR Result =
    CALCULATE (
        AVERAGEX ( 'Date', [Sales Amount] ) ,
        PeriodToUse
    )
RETURN
    Result</pre></div>
<p class="edition">The formula first determines the last visible date; in the chart, because the filter context set by the visual is at the date level, it returns the selected date. The formula then creates a set of all the dates between the last date and the last date minus 30 days. Finally, the last step is to use this period as a filter in <em class="calibre5">CALCULATE</em> so that the final <em class="calibre5">AVERAGEX</em> iterates over the 30-day period, computing the average of the daily sales.</p>
<p class="edition">The result of this calculation is visible in <a href="#calibre_link-738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-8</a>. As you can see, the line is much smoother than the daily sales, making it possible to analyze trends.</p>
<figure id="calibre_link-738" class="image-l">
<img src="images/000925.jpg" alt="The image shows a line chart plotting the Sales Amount by day in 2008, plus an additional line showing the moving average over 30 days." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-8</strong> The moving average over 30 days results in a much smoother chart.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1744"></span>When the user relies on average functions like <em class="calibre5">AVERAGEX</em>, they need to pay special attention to the desired result. In fact, when computing an average, DAX ignores blank values. If on a given day there are no sales, then that day will not be considered as part of the average. Beware that this is a correct behavior. <em class="calibre5">AVERAGEX</em> cannot assume that if there are no sales in a day then we might want to use zero instead. This behavior might not be desirable when averaging over dates.</p>
<p class="edition">If the requirement is to compute the average over dates counting days with no sales as zeroes, then the formula to use is almost always a simple division instead of <em class="calibre5">AVERAGEX</em>. A simple division is also faster because the context transition within <em class="calibre5">AVERAGEX</em> requires more memory and increased execution time. Look at the following variation of the moving average, where the only difference from the previous formula is the expression inside <em class="calibre5">CALCULATE</em>:</p>
<p class="codelink"><a href="#calibre_link-739" id="calibre_link-2379" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AvgSales30 :=
VAR LastVisibleDate = MAX ( 'Date'[Date] )
VAR NumberOfDays = 30
VAR PeriodToUse =
    FILTER (
        ALL ( 'Date' ),
        'Date'[Date] &gt; LastVisibleDate - NumberOfDays &amp;&amp;
        'Date'[Date] &lt;= LastVisibleDate
    )
VAR Result =
CALCULATE (
    <strong class="calibre7">DIVIDE ( [Sales Amount], COUNTROWS ( 'Date' ) ),</strong>
    PeriodToUse
)
RETURN
    Result</pre></div>
<p class="edition">Not leveraging <em class="calibre5">AVERAGEX</em>, this latter version of the code considers a day with no sales as a zero. This is reflected in the resulting value whose behavior is similar to the previous one, though slightly different. Moreover, the result of this latter calculation is always a bit smaller than the previous one because the denominator is nearly always a higher value, as you can appreciate in <a href="#calibre_link-740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-9</a>.</p>
<figure id="calibre_link-740" class="image-l">
<img src="images/000932.jpg" alt="The image shows a line chart plotting the Sales Amount by day in 2008, plus two additional lines showing the moving average over 30 days calculated using different techniques." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3037"></span><strong class="calibre7">Figure 7-9</strong> Different moving average calculations lead to slightly different results.</figcaption>
</figure>
<p class="edition">As is often the case with business calculations, it is not that one is better than the other. It all depends on your specific requirements. DAX offers different ways of obtaining the result. It is up to you to choose the right one. For example, by using <em class="calibre5">COUNTROWS</em> the formula now accounts for days with no sales considering them as zeroes, but it also counts holidays and weekends as days with no sales. Whether this is correct or not depends on the specific requirements and the formula needs to be updated in order to reflect the correct average.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-132" class="calibre13">Using <em class="calibre5">RANKX</em></h4>
<p class="edition">The <em class="calibre5">RANKX</em> function is used to show the ranking value of an element according to a specific sort order. For example, a typical use of <em class="calibre5">RANKX</em> is to provide a ranking of products or customers based on their sales volumes. <em class="calibre5">RANKX</em> accepts several parameters, though most frequently only the first two are used. All the others are optional and seldom used.</p>
<p class="edition">For example, imagine wanting to build the report in <a href="#calibre_link-741" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-10</a> that shows the ranking of a category against all others based on respective sales amounts.</p>
<figure id="calibre_link-741" class="image-l">
<img src="images/000939.jpg" alt="The image shows a table with Product Category on the rows and the measures Sales Amount and Rank Cat on Sales on the columns." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-10</strong> <em class="calibre5">Rank Cat on Sales</em> provides the ranking of the category based on the sales amount.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3038"></span>In this scenario, <em class="calibre5">RANKX</em> is the function to use. <em class="calibre5">RANKX</em> is an iterator and it is a simple function. Nevertheless, its use hides some complexities that are worth a deeper explanation.</p>
<p class="edition">The code of <em class="calibre5">Rank Cat on Sales</em> is the following:</p>
<p class="codelink"><a href="#calibre_link-742" id="calibre_link-2380" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Rank Cat on Sales :=
RANKX (
    ALL ( 'Product'[Category] ),
    [Sales Amount]
)</pre></div>
<p class="edition"><em class="calibre5">RANKX</em> operates in three steps:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp"><em class="calibre5">RANKX</em> builds a lookup table by iterating over the table provided as the first parameter. During the iteration it evaluates its second parameter in the row context of the iteration. At the end, it sorts the lookup table.</p></li>
<li class="calibre25"><p class="listp"><em class="calibre5">RANKX</em> evaluates its second parameter in the original evaluation context.</p></li>
<li class="calibre25"><p class="listp"><em class="calibre5">RANKX</em> returns the position of the value computed in the second step by searching its place in the sorted lookup table.</p></li>
</ol>
<p class="edition">The algorithm is outlined in <a href="#calibre_link-743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-11</a>, where we show the steps needed to compute the value of 2, the ranking of Cameras and camcorders according to <em class="calibre5">Sales Amount</em>.</p>
<figure id="calibre_link-743" class="image-l">
<img src="images/000946.jpg" alt="The diagram shows different steps of calculation for the report displayed in the initial screenshot showing a table with Product Category on the rows and the measures Sales Amount and Rank Cat on Sales on the columns. The first step shows a lookup table with the Sales Amount values sorted in a descending order, the second step shows the value computed for Cameras and camcorders category that is found in the third step in the position 2 of the lookup table." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-11</strong> <em class="calibre5">RANKX</em> requires three steps to determine the ranking of Cameras and camcorders.</figcaption>
</figure>
<p class="edition">Here is a more detailed description of the behavior of <em class="calibre5">RANKX</em> in our example:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The lookup table is built during the iteration. In the code, we had to use <em class="calibre5">ALL</em> on the product category to ignore the current filter context that would otherwise filter the only category visible, producing a lookup table with only one row.</p></li>
<li class="calibre10"><p class="listp">The value of <em class="calibre5">Sales Amount</em> is a different one for each category because of context transition. Indeed, during the iteration there is a row context. Because the expression to evaluate is a measure that contains a hidden <em class="calibre5">CALCULATE</em>, context transition makes DAX compute the value of <em class="calibre5">Sales Amount</em> only for the given category.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-3039"></span>The lookup table only contains values. Any reference to the category is lost: Ranking takes place only on values, once they are sorted correctly.</p></li>
<li class="calibre10"><p class="listp">The value determined in step 2 comes from the evaluation of the <em class="calibre5">Sales Amount</em> measure outside of the iteration, in the original evaluation context. The original filter context is filtering Cameras and camcorders. Therefore, the result is the amount of sales of cameras and camcorders.</p></li>
<li class="calibre10"><p class="listp">The value of 2 is the result of finding the place of <em class="calibre5">Sales Amount</em> of cameras and camcorders in the sorted lookup table.</p></li>
</ul>
<p class="edition">You might have noticed that at the grand total, <em class="calibre5">RANKX</em> shows 1. This value does not make any sense from a human point of view because a ranking should not have any total at all. Nevertheless, this value is the result of the same process of evaluation, which at the grand total always shows a meaningless value. In <a href="#calibre_link-744" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-12</a> you can see the evaluation process at the grand total.</p>
<figure id="calibre_link-744" class="image-l">
<img src="images/000953.jpg" alt="The diagram shows different steps of calculation for the report displayed in the initial screenshot showing a table with Product Category on the rows and the measures Sales Amount and Rank Cat on Sales on the columns. The first step shows a lookup table with the Sales Amount values sorted in a descending order. The second step shows the value computed for the Total that is not found in the lookup, so the position 1 is returned in the third step." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-12</strong> The grand total always shows 1 if sorting of the lookup table is descending.</figcaption>
</figure>
<p class="edition">The value computed during step 2 is the grand total of sales, which is always greater than the sum of individual categories. Thus, the value shown at the grand total is not a bug or a defect; it is the standard <em class="calibre5">RANKX</em> behavior that loses its intended meaning at the grand total level. The correct way of handling the total is to hide it by using DAX code. Indeed, the ranking of a category against all other categories has meaning if (and only if) the current filter context only filters one category. Consequently, a better formulation of the measure relies on <em class="calibre5">HASONEVALUE</em> in order to avoid computing the ranking in a filter context that produces a meaningless result:</p>
<p class="codelink"><a href="#calibre_link-745" id="calibre_link-2381" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Rank Cat on Sales :=
IF (
    <strong class="calibre7">HASONEVALUE ( 'Product'[Category] ),</strong>
    RANKX (
        ALL ( 'Product'[Category] ),
        [Sales Amount]
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3040"></span>This code produces a blank whenever there are multiple categories in the current filter context, removing the total row. Whenever one uses <em class="calibre5">RANKX</em> or, in more general terms, whenever the measure computed depends on specific characteristics of the filter context, one should protect the measure with a conditional expression that ensures that the calculation only happens when it should, providing a blank or an error message in any other case. This is exactly what the previous measure does.</p>
<p class="edition">As we mentioned earlier <em class="calibre5">RANKX</em> accepts many arguments, not only the first two. There are three remaining arguments, which we introduce here. We describe them later in this section.</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The third parameter is the value expression, which might be useful when different expressions are being used to evaluate respectively the lookup table and the value to use for the ranking.</p></li>
<li class="calibre10"><p class="listp">The fourth parameter is the sort order of the lookup table. It can be <em class="calibre5">ASC</em> or <em class="calibre5">DESC</em>. The default is <em class="calibre5">DESC</em>, with the highest values on top&mdash;that is, higher value results in lower ranking.</p></li>
<li class="calibre10"><p class="listp">The fifth parameter defines how to compute values in case of ties. It can be <em class="calibre5">DENSE</em> or <em class="calibre5">SKIP</em>. If it is <em class="calibre5">DENSE</em>, then ties are removed from the lookup table; otherwise they are kept.</p></li>
</ul>
<p class="edition">Let us describe the remaining parameters with some examples.</p>
<p class="edition">The third parameter is useful whenever one needs to use a different expression respectively to build the lookup table and to compute the value to rank. For example, consider the requirement of a custom table for the ranking, like the one depicted in <a href="#calibre_link-746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-13</a>.</p>
<figure id="calibre_link-746" class="image-l">
<img src="images/000960.jpg" alt="The table has a column Sales with numbers 0, 100,000, 500,000, 1,000,000, 2,000,000, 5,000,000, and 10,000,000." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-13</strong> Instead of building a dynamic lookup table, one might need to use a fixed lookup table.</figcaption>
</figure>
<p class="edition">If one wants to use this table to compute the lookup table, then the expression used to build it should be different from the <em class="calibre5">Sales Amount</em> measure. In such a case, the third parameter becomes useful. To rank the sales amount against this specific lookup table&mdash;which is named <em class="calibre5">Sales Ranking</em>&mdash;the code is the following:</p>
<p class="codelink"><a href="#calibre_link-747" id="calibre_link-2382" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Rank On Fixed Table :=
RANKX (
    'Sales Ranking',
    'Sales Ranking'[Sales],
    [Sales Amount]
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3041"></span>In this case, the lookup table is built by getting the value of <em class="calibre5">{'Sales Ranking{'[Sale]</em> in the row context of <em class="calibre5">Sales Ranking</em>. Once the lookup table is built, <em class="calibre5">RANKX</em> evaluates <em class="calibre5">[Sales Amount]</em> in the original evaluation context.</p>
<p class="edition">The result of this calculation is visible in <a href="#calibre_link-748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-14</a>.</p>
<figure id="calibre_link-748" class="image-l">
<img src="images/000967.jpg" alt="The image shows a table with Product Category on the rows and the measures Sales Amount and Rank On Fixed Table on the columns." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-14</strong> <em class="calibre5">Rank On Fixed Table</em> ranks <em class="calibre5">Sales Amount</em> against the fixed <em class="calibre5">Sales Ranking</em> table.</figcaption>
</figure>
<p class="edition">The full process is depicted in <a href="#calibre_link-749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-15</a>, where you can also appreciate that the lookup table is sorted before being used.</p>
<figure id="calibre_link-749" class="image-l">
<img src="images/000974.jpg" alt="The diagram shows different steps of calculation for the report displayed in the initial screenshot showing a table with Product Category on the rows and the measures Sales Amount and Rank On Fixed Table on Sales on the columns. The first step shows a lookup table with the fixed values sorted in a descending order. The second step shows the value computed for Cameras and camcorders category that is found in the third step in the position 2 of the lookup table." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-15</strong> When using a fixed lookup table, the expression used to build the lookup table is different from the expression used for step 2.</figcaption>
</figure>
<p class="edition">The fourth parameter can be <em class="calibre5">ASC</em> or <em class="calibre5">DESC</em>. It changes the sort order of the lookup table. By default it is <em class="calibre5">DESC</em>, meaning that a lower ranking is assigned to the highest value. If one uses <em class="calibre5">ASC</em>, then the lower value will be assigned the lower ranking because the lookup table is sorted the opposite way.</p>
<p class="edition">The fifth parameter, on the other hand, is useful in the presence of ties. To introduce ties in the calculation, we use a different measure&mdash;<em class="calibre5">Rounded Sales</em>. <em class="calibre5">Rounded Sales</em> rounds values to the nearest multiple of one million, and we will slice it by brand:</p>
<p class="codelink"><a href="#calibre_link-750" id="calibre_link-2383" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Rounded Sales := MROUND ( [Sales Amount], 1000000 )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3042"></span>Then, we define two different rankings: One uses the default ranking (which is <em class="calibre5">SKIP</em>), whereas the other one uses <em class="calibre5">DENSE</em> for the ranking:</p>
<p class="codelink"><a href="#calibre_link-751" id="calibre_link-2384" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Rank On Rounded Sales :=
RANKX (
    ALL ( 'Product'[Brand] ),
    [Rounded Sales]
)

Rank On Rounded Sales Dense :=
RANKX (
    ALL ( 'Product'[Brand] ),
    [Rounded Sales],
    ,
    ,
    DENSE
)</pre></div>
<p class="edition">The result of the two measures is different. In fact, the default behavior considers the number of ties and it increases the ranking accordingly. When using <em class="calibre5">DENSE</em>, the ranking increases by one regardless of ties. You can appreciate the different result in <a href="#calibre_link-752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-16</a>.</p>
<figure id="calibre_link-752" class="image-l">
<img src="images/000981.jpg" alt="The image shows a table with product Brand on the rows and the measures Rounded Sales, Rank On Rounded Sales, and Rank On Rounded Sales Dense on the columns." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-16</strong> Using <em class="calibre5">DENSE</em> or <em class="calibre5">SKIP</em> produces different ranking values in the presence of ties in the lookup table.</figcaption>
</figure>
<p class="edition">Basically, <em class="calibre5">DENSE</em> performs a <em class="calibre5">DISTINCT</em> on the lookup table before using it. <em class="calibre5">SKIP</em> does not, and it uses the lookup table as it is generated during the iteration.</p>
<p class="edition">When using <em class="calibre5">RANKX</em>, it is important to consider which table to use as the first parameter to obtain the desired result. In the previous queries, it was necessary to specify <em class="calibre5">ALL ( Product[Brand] )</em> because we wanted to obtain the ranking of each brand. For brevity, we omitted the usual test with <em class="calibre5">HASONEVALUE</em>. In practice you should never skip it; otherwise the measure is at risk of computing unexpected results. For example, a measure like the following one produces an error if not used in a report that slices by Brand:</p>
<p class="codelink"><a href="#calibre_link-753" id="calibre_link-2385" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-2080"></span>Rank On Sales :=
RANKX (
    ALL ( 'Product'[Brand] ),
    [Sales Amount]
)</pre></div>
<p class="edition">In <a href="#calibre_link-754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-17</a> we slice the measure by product color and the result is always 1.</p>
<figure id="calibre_link-754" class="image-l">
<img src="images/000988.jpg" alt="The image shows a table with product Color on the rows and the measures Sales Amount and Rank On Sales on the columns. The Rank On Sales measure displays 1 for every row." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-17</strong> A ranking by brand produces unexpected results if sliced by <em class="calibre5">Color</em>.</figcaption>
</figure>
<p class="edition">The reason is that the lookup table contains the sales amount sliced by brand and by color, whereas the values to search in the lookup table contain the total only by color. As such, the total by color will always be larger than any of its subsets by brand, resulting in a ranking of 1. Adding the protection code with <em class="calibre5">IF HASONEVALUE</em> ensures that&mdash;if the evaluation context does not filter a single brand&mdash;the result will be blank.</p>
<p class="edition">Finally, <em class="calibre5">ALLSELECTED</em> is oftentimes used with <em class="calibre5">RANKX</em>. If a user performs a selection of some brands out of the entire set of brands, ranking over <em class="calibre5">ALL</em> might produce gaps in the ranking. This is because <em class="calibre5">ALL</em> returns all the brands, regardless of the filter coming from the slicer. For example, consider the following measures:</p>
<p class="codelink"><a href="#calibre_link-755" id="calibre_link-2386" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Rank On Selected Brands :=
RANKX (
    <strong class="calibre7">ALLSELECTED ( 'Product'[Brand] ),</strong>
    [Sales Amount]
)

Rank On All Brands :=
RANKX (
    <strong class="calibre7">ALL ( 'Product'[Brand] ),</strong>
    [Sales Amount]
)</pre></div>
<p class="edition">In <a href="#calibre_link-756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-18</a>, you can see the comparison between the two measures in the presence of a slicer filtering certain brands.</p>
<figure id="calibre_link-756" class="image-l">
<img src="images/000995.jpg" alt="The image shows a slicer on Product Brand on the left and a table with product Brand on the rows and the measures Sales Amount, Rank On All Brands, and Rank On Selected Brands on the columns." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2055"></span><strong class="calibre7">Figure 7-18</strong> Using <em class="calibre5">ALLSELECTED</em> removes gaps in the ranking generated by using <em class="calibre5">ALL</em>.</figcaption>
</figure>
<div class="sidebar">
<p class="edition">Using RANK.EQ</p>
<p class="edition">The <em class="calibre5">RANK.EQ</em> function in DAX is like the Excel function of the same name. It returns the ranking of a number within a list of numbers, offering a subset of the features available with <em class="calibre5">RANKX</em>. You rarely use it in DAX unless you are migrating an Excel formula. It has the following syntax:</p>
<p class="codelink"><a href="#calibre_link-757" id="calibre_link-2387" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">RANK.EQ ( &lt;value&gt;, &lt;column&gt; [, &lt;order&gt;] )</pre></div>
<p class="edition">The &lt;value&gt; argument can be a DAX expression that has to be evaluated, and &lt;column&gt; is the name of an existing column against which rank will be determined. The order is optional and can be 0 for descending order and 1 for ascending order. In Excel, the same function can accept a range of cells as a column argument. However, in DAX, often the same column is used for value expression, meaning that you want to calculate the ranking of a column over itself. One scenario in which you might want to use a different column is when you have two tables: one table with elements that you want to rank, for example a specific group of products; and another table with the entire set of elements to use for ranking, for example the list of all the products. However, because of the limitations applied to the column parameter (it cannot be an expression or a column created by using <em class="calibre5">ADDCOLUMNS, SELECTCOLUMNS</em>, or other table functions), <em class="calibre5">RANK.EQ</em> is commonly used by passing the same column for value and column parameters in a calculated column expression, referring to columns of the same table as in the following example:</p>
<p class="codelink"><a href="#calibre_link-758" id="calibre_link-2388" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Product[Price Rank] =
RANK.EQ ( Product[Unit Price], Product[Unit Price] )</pre></div>
<p class="edition"><em class="calibre5">RANKX</em> is much more powerful than <em class="calibre5">RANK.EQ</em>. Thus, once you learn RANKX, it is likely you will not spend too much time learning a less powerful version of the same function.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-133" class="calibre13"><span type="pagebreak" id="calibre_link-1834"></span>Changing calculation granularity</h4>
<p class="edition">There are several scenarios where a formula cannot be easily computed at the total level. Instead, the same calculation could be performed at a higher granularity and then aggregated later.</p>
<p class="edition">Imagine needing to compute the sales amount per working day. The number of working days in every month is different because of the number of Saturdays and Sundays or because of the holidays in a month. For the sake of simplicity, in this example we only consider Saturdays and Sundays, but our readers can easily extend the concept to also considering holidays.</p>
<p class="edition">The <em class="calibre5">Date</em> table contains an <em class="calibre5">IsWorkingDay</em> column that contains 1 or 0 depending on whether that day is a working day or not. It is useful to store the information as an integer because it makes the calculation of days and working days very simple. Indeed, the two following measures compute the number of days in the current filter context and the corresponding number of working days:</p>
<p class="codelink"><a href="#calibre_link-759" id="calibre_link-2389" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NumOfDays := COUNTROWS ( 'Date' )
NumOfWorkingDays := SUM ( 'Date'[IsWorkingDay] )</pre></div>
<p class="edition">In <a href="#calibre_link-760" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-19</a> you can see a report with the two measures.</p>
<figure id="calibre_link-760" class="image-l">
<img src="images/001003.jpg" alt="The image shows a matrix with Calendar Year and Month on the rows and the measures Sales Amount, NumOfDays, and NumOfWorkingDays on the columns." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-19</strong> The number of working days is different in each month, depending on weekends.</figcaption>
</figure>
<p class="edition">Based on these measures, we might want to compute the sales per working day. That is a simple division of the sales amount by the number of working days. This calculation is useful to produce a performance indicator for each month, considering both the gross amount of sales and the number of days in which sales were possible. Though the calculation looks simple, it hides some complexity that we solve by leveraging iterators. As we sometimes do in this book, we show this solution step-by-step, <span type="pagebreak" id="calibre_link-3043"></span>highlighting possible errors in the writing process. The goal of this demo is not to show a pattern. Instead, it is a showcase of different mistakes that a developer might make when authoring a DAX expression.</p>
<p class="edition">As anticipated, a simple division of <em class="calibre5">Sales Amount</em> by the number of working days produces correct results only at the month level. At the grand total, the result is surprisingly lower than any other month:</p>
<p class="codelink"><a href="#calibre_link-761" id="calibre_link-2390" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SalesPerWorkingDay := DIVIDE ( [Sales Amount], [NumOfWorkingDays] )</pre></div>
<p class="edition">In <a href="#calibre_link-762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-20</a> you can look at the result.</p>
<figure id="calibre_link-762" class="image-l">
<img src="images/001011.jpg" alt="The image shows a matrix with Calendar Year and Month on the rows and the measures Sales Amount, NumOfDays, NumOfWorkingDays, and SalesPerWorkingDay on the columns. The rows between January 2007 and July 2007 have blank values for SalesAmount and SalesPerWorkingDay measures. The value of SalesPerWorkingDay for year 2007 is smaller than any other month in the same year." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-20</strong> Although monthly values look fine, the annual subtotal is definitely wrong.</figcaption>
</figure>
<p class="edition">If you focus your attention to the total of 2007, it shows 17,985.16. It is surprisingly low considering that all monthly values are above 37,000.00. The reason is that the number of working days at the year level is 261, including the months where there are no sales at all. In this model, sales started in August 2007 so it would be wrong to consider previous months where there cannot be other sales. The same issue also happens in the period containing the last day with data. For example, the total of the working days in the current year will likely consider future months as working days.</p>
<p class="edition">There are multiple ways of fixing the formula. We choose a simple one: if there are no sales in a month, then the formula should not consider the days in that month. This formula assumes that all the months between the oldest transaction and the last transaction available have transactions associated.</p>
<p class="edition">Because the calculation must work on a month-by-month basis, it needs to iterate over months and check if there are sales in each month. If there are sales, then it adds the number of working days. If there are no sales in the given month, then it skips it. <em class="calibre5">SUMX</em> can implement this algorithm:</p>
<p class="codelink"><a href="#calibre_link-763" id="calibre_link-2391" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-3044"></span>SalesPerWorkingDay :=
VAR WorkingDays =
    SUMX (
        VALUES ( 'Date'[Month] ),
        IF (
            [Sales Amount] &gt; 0,
            [NumOfWorkingDays]
        )
    )
VAR Result =
    DIVIDE (
        [Sales Amount],
        WorkingDays
    )
RETURN
    Result</pre></div>
<p class="edition">This new version of the code provides an accurate result at the year level, as shown in <a href="#calibre_link-764" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-21</a>, though it is still not perfect.</p>
<figure id="calibre_link-764" class="image-l">
<img src="images/001020.jpg" alt="The image shows a matrix with Calendar Year and Month on the rows and the measures Sales Amount, NumOfDays, NumOfWorkingDays, and SalesPerWorkingDay on the columns. The rows between January 2007 and July 2007 have blank values for SalesAmount and SalesPerWorkingDay measures. The value of SalesPerWorkingDay for year 2007 is the correct average of the months that have data for the Sales Amount measure." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-21</strong> Using an iterator the total at the year level is now accurate.</figcaption>
</figure>
<p class="edition">When performing the calculation at a different granularity, one needs to ensure the correct level of granularity. The iteration started by <em class="calibre5">SUMX</em> iterates the values of the month column, which are January through December. At the year level everything is working correctly, but the value is still incorrect at the grand total. You can observe this behavior in <a href="#calibre_link-765" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-22</a>.</p>
<figure id="calibre_link-765" class="image-l">
<img src="images/001027.jpg" alt="The image shows a matrix with Calendar Year on the rows and the measures Sales Amount, NumOfDays, NumOfWorkingDays, and SalesPerWorkingDay on the columns. The value of SalesPerWorkingDay for the Total row is incorrect, because it is less than the value of any year." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1835"></span><strong class="calibre7">Figure 7-22</strong> Every yearly total is above 35,000 and the grand total is&mdash;again&mdash;surprisingly low.</figcaption>
</figure>
<p class="edition">When the filter context contains the year, an iteration of months works fine because&mdash;after the context transition&mdash;the new filter context contains both a year and a month. However, at the grand total level, the year is no longer part of the filter context. Consequently, the filter context only contains the currently iterated month, and the formula does not check if there are sales in that year and month. Instead, it checks if there are sales in that month for any year.</p>
<p class="edition">The problem of this formula is the iteration over the month column. The correct granularity of the iteration is not the month; it is the pair of year and month together. The best solution is to iterate over a column containing a different value for each year and month. It turns out that we have such a column in the data model: the <em class="calibre5">Calendar Year Month</em> column. To fix the code, it is enough to iterate over the <em class="calibre5">Calendar Year Month</em> column instead of over <em class="calibre5">Month</em>:</p>
<p class="codelink"><a href="#calibre_link-766" id="calibre_link-2392" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SalesPerWorkingDay :=
VAR WorkingDays =
    SUMX (
        <strong class="calibre7">VALUES ( 'Date'[Calendar Year Month] ),</strong>
        IF (
            [Sales Amount] &gt; 0,
            [NumOfWorkingDays]
        )
    )
VAR Result =
    DIVIDE (
        [Sales Amount],
        WorkingDays
    )
RETURN
    Result</pre></div>
<p class="edition">This final version of the code works fine because it computes the total using an iteration at the correct level of granularity. You can see the result in <a href="#calibre_link-767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 7-23</a>.</p>
<figure id="calibre_link-767" class="image-l">
<img src="images/001035.jpg" alt="The image shows a matrix with Calendar Year on the rows and the measures Sales Amount, NumOfDays, NumOfWorkingDays, and SalesPerWorkingDay on the columns. The value of SalesPerWorkingDay for the Total row is now correct." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 7-23</strong> Applying the calculation at the correct level of granularity returns accurate values also at the Total level.</figcaption>
</figure>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-134" class="h2a"><span type="pagebreak" id="calibre_link-2081"></span>Conclusions</h3>
<p class="edition">As usual, let us conclude this chapter with a recap of the important concepts you learned here:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Iterators are an important part of DAX, and you will find yourself using them more, the more you use DAX.</p></li>
<li class="calibre10"><p class="listp">There are mainly two kinds of iterations in DAX: iterations to perform simple calculations on a row-by-row basis and iterations that leverage context transition. The definition of <em class="calibre5">Sales Amount</em> we used so far in the book uses an iteration to compute the quantity multiplied by the net price, on a row-by-row basis. In this chapter, we introduced iterators with a context transition, a powerful tool to compute more complex expressions.</p></li>
<li class="calibre10"><p class="listp">Whenever using an iterator with context transition, you must check the cardinality the iteration should happen at&mdash;it should be quite small. You also need to check that the rows in the table are guaranteed to be unique. Otherwise, the code is at risk of being slow or of computing bad results.</p></li>
<li class="calibre10"><p class="listp">When computing averages over time, you always should check whether an iterator is the correct solution or not. <em class="calibre5">AVERAGEX</em> does not consider blanks as part of its calculation and, when using time, this could be wrong. Nevertheless, always double-check the formula requirements; each scenario is unique.</p></li>
<li class="calibre10"><p class="listp">Iterators are useful to compute values at a different granularity, as you learned in the last example. When dealing with calculations at different granularities, it is of paramount importance to check the correct granularity to avoid errors in the code.</p></li>
</ul>
<p class="edition">You will see many more examples of iterators in the remaining part of the book. Starting from the next chapter, when dealing with time intelligence calculations, you will see different calculations, most of which rely on iterations.<span type="pagebreak" id="calibre_link-3045"></span></p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-768">
<div id="calibre_link-3046" class="calibre2">
<div id="calibre_link-3047" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-13"><span type="pagebreak" id="calibre_link-1941"></span><span class="pd_ash">Chapter 8</span><br class="calibre3" />Time intelligence calculations</h2>
<p class="edition">Almost any data model includes some sort of calculation related to dates. DAX offers several functions to simplify these calculations, which are useful if the underlying data model follows certain specific requirements. On the other hand, if the model contains peculiarities in the handling of time that would prevent the use of standard time intelligence functions, then writing custom calculations is always an option.</p>
<p class="edition">In this chapter, you learn how to implement common date-related calculations such as year-to-date, year-over-year, and other calculations over time including nonadditive and semi-additive measures. You learn both how to use specific time intelligence functions and how to rely on custom DAX code for nonstandard calendars and week-based calculations.</p>
<section class="calibre4">
<h3 id="calibre_link-135" class="h2a">Introducing time intelligence</h3>
<p class="edition">Typically, a data model contains a date table. In fact, when slicing data by year and month, it is preferable to use the columns of a table specifically designed to slice dates. Extracting the date parts from a single column of type <em class="calibre5">Date</em> or <em class="calibre5">DateTime</em> in calculated columns is a less desirable approach.</p>
<p class="edition">There are several reasons for this choice. By using a date table, the model becomes easier to browse, and you can use specific DAX functions that perform time intelligence calculations. In fact, in order to work properly, most of the time intelligence functions in DAX require a separate date table.</p>
<p class="edition">If a model contains multiple dates, like the order date and the delivery date, then one can either create multiple relationships with a single date table or duplicate the date table. The resulting models are different, and so are the calculations. Later in this chapter, we will discuss these two alternatives in more detail.</p>
<p class="edition">In any case, one should always create at least one date table whenever there are one or more date columns in the data. Power BI and Power Pivot for Excel offer embedded features to automatically create tables or columns to manage dates in the model, whereas Analysis Services has no specific feature for the handling of time intelligence. However, the implementation of these features does not always follow the best practice of keeping a single date table in the data model. Also, because these features come with several restrictions, it is usually better to use your own date table. The next sections expand on this last statement.</p>
<section class="calibre4">
<h4 id="calibre_link-136" class="calibre13"><span type="pagebreak" id="calibre_link-1741"></span>Automatic Date/Time in Power BI</h4>
<p class="edition">Power BI has a feature called Auto Date/Time, which can be configured through the options in the Data Load section (see <a href="#calibre_link-769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-1</a>).</p>
<figure id="calibre_link-769" class="image-l">
<img src="images/001051.jpg" alt="The figure shows the option panel, where Auto Date/Time can be ticked on or off under Time intelligence." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-1</strong> The Auto Date/Time setting is enabled by default in a new model.</figcaption>
</figure>
<p class="edition">When the setting is enabled&mdash;it is by default&mdash;Power BI automatically creates a date table for each <em class="calibre5">Date</em> or <em class="calibre5">DateTime</em> column in the model. We will call it a “date column” from here on. This makes it possible to slice each date by year, quarter, month, and day. These automatically created tables are hidden to the user and cannot be modified. Connecting to the Power BI Desktop file with DAX Studio makes them visible to any developers curious about their structure.</p>
<p class="edition">The Auto Date/Time feature comes with two major drawbacks:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Power BI Desktop generates one table per date column. This creates an unnecessarily high number of date tables in the model, unrelated to one another. Building a simple report presenting the amount ordered and the amount sold in the same matrix proves to be a real challenge.</p></li>
<li class="calibre10"><p class="listp">The tables are hidden and cannot be modified by the developer. Consequently, if one needs to add a column for the weekday, they cannot.</p></li>
</ul>
<p class="edition"><span type="pagebreak" id="calibre_link-1742"></span>Building a proper date table for complete freedom is a skill that you learn in the next few pages, and it only requires a few lines of DAX code. Forcing your model to follow bad practices in data modeling just to save a couple of minutes when building the model for the first time is definitely a bad choice.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-137" class="calibre13">Automatic date columns in Power Pivot for Excel</h4>
<p class="edition">Power Pivot for Excel also has a feature to handle the automatic creation of data structures, making it easier to browse dates. However, it uses a different technique that is even worse than that of Power BI. In fact, when one uses a date column in a pivot table, Power Pivot automatically creates a set of calculated columns in the same table that contains the date column. Thus, it creates one calculated column for the year, one for the month name, one for the quarter, and one for the month number&mdash;required for sorting. In total, it adds four columns to your table.</p>
<p class="edition">As a bad practice, it shares all the bad features of Power BI and it adds a new one. In fact, if there are multiple date columns in a single table, then the number of these calculated columns will start to increase. There is no way to use the same set of columns to slice different dates, as is the case with Power BI. Finally, if the date column is in a table with millions of rows&mdash;as is often the case&mdash;these calculated columns increase the file size and the memory footprint of the model.</p>
<p class="edition">This feature can be disabled in the Excel options, as you can see in <a href="#calibre_link-770" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-2</a>.</p>
<figure id="calibre_link-770" class="image-l">
<img src="images/001058.jpg" alt="Under Excel options, in the Data tab, the developer can disable automatic grouping." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-2</strong> The Excel options contain a setting to disable automatic grouping of <em class="calibre5">DateTime</em> columns.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-138" class="calibre13"><span type="pagebreak" id="calibre_link-1936"></span>Date table template in Power Pivot for Excel</h4>
<p class="edition">Excel offers another feature that works much better than the previous feature. Indeed, since 2017 there is an option in Power Pivot for Excel to create a date table, which can be activated through the Power Pivot window, as shown in <a href="#calibre_link-771" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-3</a>.</p>
<figure id="calibre_link-771" class="image-l">
<img src="images/001065.jpg" alt="The figure shows how to create a new date table." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-3</strong> Power Pivot for Excel lets you create a new date table through a menu option.</figcaption>
</figure>
<p class="edition">In Power Pivot, clicking on New creates a new table in the model with a set of calculated columns that include year, month, and weekday. It is up to the developer to create the correct set of relationships in the model. Also, if needed, one has the option to modify the names and the formulas of the calculated columns, as well as adding new ones.</p>
<p class="edition">There is also the option of saving the current table as a new template, which will be used in the future for newly created date tables. Overall, this technique works well. The table generated by Power Pivot is a regular date table that fulfills all the requirements of a good date table. This, in conjunction with the fact that Power Pivot for Excel does not support calculated tables, makes the feature useful.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-139" class="h2a">Building a date table</h3>
<p class="edition">As you have learned, the first step for handling date calculations in DAX is to create a date table. Because of its relevance, one should pay attention to some details when creating the date table. In this section, we provide the best practices regarding the creation of a date table. There are two different aspects to consider: a technical aspect and a data modeling aspect.</p>
<p class="edition">From a technical point of view, the date table must follow these guidelines:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The date table contains all dates included in the period to analyze. For example, if the minimum and maximum dates contained in <em class="calibre5">Sales</em> are July 3, 2016, and July 27, 2019, respectively, the range of dates of the table is between January 1, 2016, and December 31, 2019. In other words, the date <span type="pagebreak" id="calibre_link-1937"></span>table needs to contain all the days for all the years containing sales data. There can be no gaps in the sequence of dates. All dates need to be present, regardless of whether there are transactions or not on each date.</p></li>
<li class="calibre10"><p class="listp">The date table contains one column of <em class="calibre5">DateTime</em> type, with unique values. The <em class="calibre5">Date</em> data type is a better choice because it guarantees that the time part is empty. If the <em class="calibre5">DateTime</em> column also contains a time part, then all the times of the day need to be identical throughout the table.</p></li>
<li class="calibre10"><p class="listp">It is not necessary that the relationship between <em class="calibre5">Sales</em> and the date table be based on the <em class="calibre5">Date-Time</em> column. One can use an integer to relate the two tables, yet the <em class="calibre5">DateTime</em> column needs to be present.</p></li>
<li class="calibre10"><p class="listp">The table should be marked as a <em class="calibre5">Date</em> table. Though this is not a strictly mandatory step, it greatly helps in writing correct code. We will cover the details of this feature later in this chapter.</p></li>
</ul>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">It is common for newbies to create a huge date table with many more years than needed. That is a mistake. For example, one might create a date table with two hundred years ranging from 1900 to 2100, just in case. Technically the date table works fine, but there will be serious performance issues whenever it is used in calculations. Using a table with only the relevant years is a best practice.</p>
</div>
<p class="edition">From the technical point of view, a table containing a single date column with all the required dates is enough. Nevertheless, a user typically wants to analyze information slicing by year, month, quarter, weekday, and many other attributes. Consequently, a good date table should include a rich set of columns that&mdash;although not used by the engine&mdash;greatly improve the user experience.</p>
<p class="edition">If you are loading the date table from an existing data source, then it is likely that all the columns describing a date are already present in the source date table. If necessary, additional columns can be created as calculated columns or by changing the source query. Performing simple calculations in the data source is preferable whenever possible&mdash;reducing the use of calculated columns to when they are strictly required. Alternatively, you can create the date table by using a DAX calculated table. We describe the calculated table technique along with the <em class="calibre5">CALENDAR</em> and <em class="calibre5">CALENDARAUTO</em> functions in the next sections.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The term “Date” is a reserved keyword in DAX; it corresponds to the <em class="calibre5">DATE</em> function. Therefore, you should embed the <em class="calibre5">Date</em> name in quotes when referring to the table name, despite the fact that there are no spaces or special characters in that name. You might prefer using <em class="calibre5">Dates</em> instead of <em class="calibre5">Date</em> as the name of the table to avoid this requirement. However, it is better to be consistent in table names, so if you use the singular form for all the other table names, it is better to keep it singular for the date table too.</p>
</div>
<section class="calibre4">
<h4 id="calibre_link-140" class="calibre13"><span type="pagebreak" id="calibre_link-1852"></span>Using <em class="calibre5">CALENDAR</em> and <em class="calibre5">CALENDARAUTO</em></h4>
<p class="edition">If you do not have a date table in your data source, you can create the date table by using either <em class="calibre5">CALENDAR</em> or <em class="calibre5">CALENDARAUTO</em>. These functions return a table of one column, of <em class="calibre5">DateTime</em> data type. <em class="calibre5">CALENDAR</em> requires you to provide the upper and lower boundaries of the set of dates. <em class="calibre5">CALENDAR-AUTO</em> scans all the date columns across the entire data model, finds the minimum and maximum years referenced, and finally generates the set of dates between these years.</p>
<p class="edition">For example, a simple calendar table containing all the dates in the <em class="calibre5">Sales</em> table can be created using the following code:</p>
<p class="codelink"><a href="#calibre_link-772" id="calibre_link-2394" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Date =
CALENDAR (
    DATE ( YEAR ( MIN ( Sales[Order Date] ) ), 1, 1 ),
    DATE ( YEAR ( MAX ( Sales[Order Date] ) ), 12, 31 )
)</pre></div>
<p class="edition">In order to force all dates from the first of January up to the end of December, the code only extracts the minimum and maximum years, forcing day and month to be the first and last of the year. A similar result can be obtained by using the simpler <em class="calibre5">CALENDARAUTO</em>:</p>
<div class="program"><pre class="calibre14">Date = CALENDARAUTO ( )</pre></div>
<p class="edition"><em class="calibre5">CALENDARAUTO</em> scans all the date columns, except for calculated columns. For example, if one uses <em class="calibre5">CALENDARAUTO</em> to create a <em class="calibre5">Date</em> table in a model that contains sales between 2007 and 2011 and has an <em class="calibre5">AvailableForSaleDate</em> column in the <em class="calibre5">Product</em> table starting in 2004, the result is the set of all the days between January 1, 2004, and December 31, 2011. However, if the data model contains other date columns, they affect the date range considered by <em class="calibre5">CALENDARAUTO</em>. Storing dates that are not useful to slice and dice is very common. For example, if among the many dates a model also contains the customers’ birthdates, then the result of <em class="calibre5">CALENDARAUTO</em> starts from the oldest year of birth of any customer. This produces a large date table, which in turn negatively affects performance.</p>
<p class="edition"><em class="calibre5">CALENDARAUTO</em> accepts an optional parameter that represents the final month number of a fiscal year. If provided, <em class="calibre5">CALENDARAUTO</em> generates dates from the first day of the following month to the last day of the month indicated as an argument. This is useful when you have a fiscal year that ends in a month other than December. For example, the following expression generates a <em class="calibre5">Date</em> table for fiscal years starting on July 1 and ending on June 30:</p>
<div class="program"><pre class="calibre14">Date = CALENDARAUTO ( 6 )</pre></div>
<p class="edition"><em class="calibre5">CALENDARAUTO</em> is slightly easier to use than <em class="calibre5">CALENDAR</em> because it automatically determines the boundaries of the set of dates. However, it might extend this set by considering unwanted columns. One can obtain the best of both worlds by restricting the result of <em class="calibre5">CALENDARAUTO</em> to only the desired set of dates, as follows:</p>
<p class="codelink"><a href="#calibre_link-773" id="calibre_link-2395" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Date =
VAR MinYear = YEAR ( MIN ( Sales[Order Date] ) )
VAR MaxYear = YEAR ( MAX ( Sales[Order Date] ) )
RETURN
<span type="pagebreak" id="calibre_link-1647"></span>FILTER (
    CALENDARAUTO ( ),
    YEAR ( [Date] ) &gt;= MinYear &amp;&amp;
    YEAR ( [Date] ) &lt;= MaxYear
)</pre></div>
<p class="edition">The resulting table only contains the useful dates. Finding the first and last day of the year is not that important because <em class="calibre5">CALENDARAUTO</em> handles this internally.</p>
<p class="edition">Once the developer has obtained the correct list of dates, they still must create additional columns using DAX expressions. Following is a list of commonly used expressions for this scope, with an example of their results in <a href="#calibre_link-774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-4</a>:</p>
<p class="codelink"><a href="#calibre_link-775" id="calibre_link-2396" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Date =
VAR MinYear = YEAR ( MIN ( Sales[Order Date] ) )
VAR MaxYear = YEAR ( MAX ( Sales[Order Date] ) )
RETURN
ADDCOLUMNS (
     FILTER (
         CALENDARAUTO ( ),
         YEAR ( [Date] ) &gt;= MinYear &amp;&amp;
         YEAR ( [Date] ) &lt;= MaxYear
     ),
     "Year", YEAR ( [Date] ),
     "Quarter Number", INT ( FORMAT ( [Date], "q" ) ),
     "Quarter", "Q" &amp; INT ( FORMAT ( [Date], "q" ) ),
     "Month Number", MONTH ( [Date] ),
     "Month", FORMAT ( [Date], "mmmm" ),
     "Week Day Number", WEEKDAY ( [Date] ),
     "Week Day", FORMAT ( [Date], "dddd" ),
     "Year Month Number", YEAR ( [Date] ) * 100 + MONTH ( [Date] ),
     "Year Month", FORMAT ( [Date], "mmmm" ) &amp; " " &amp; YEAR ( [Date] ),
     "Year Quarter Number", YEAR ( [Date] ) * 100 + INT ( FORMAT ( [Date], "q" ) ),
     "Year Quarter", "Q" &amp; FORMAT ( [Date], "q" ) &amp; "-" &amp; YEAR ( [Date] )
)</pre></div>
<figure id="calibre_link-774" class="image-l">
<img src="images/001072.jpg" alt="The figure shows a complete date table with all details pertaining to each date." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-4</strong> Using <em class="calibre5">ADDCOLUMNS</em> allows for the creation of a complete date table with a single expression.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1648"></span>Instead of using a single <em class="calibre5">ADDCOLUMNS</em> function, one could achieve the same result by creating several calculated columns through the user interface. The main advantage of using <em class="calibre5">ADDCOLUMNS</em> is the ability to reuse the same DAX expression to create a date table in other projects.</p>
<div class="sidebar">
<p class="edition">Using DAX Date Template</p>
<p class="edition">The code provided is an example for educational purposes, where we limited the number of columns in the date table to make the code fit the book. There are several examples of date templates available on the web. For example, we created a date table template as a Power BI template file, available at <a href="https://www.sqlbi.com/tools/dax-date-template/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.sqlbi.com/tools/dax-date-template/</a>. You can also extract the same DAX code and implement it in an Analysis Services project.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-141" class="calibre13">Working with multiple dates</h4>
<p class="edition">When there are multiple date columns in the model, you should consider two design options: creating multiple relationships to the same date table or creating multiple date tables. Choosing between the two options is an important decision because it affects the required DAX code and also the kind of analysis that is possible later on.</p>
<p class="edition">Consider a <em class="calibre5">Sales</em> table with the following three dates for every sales transaction:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">Order Date</em>: the date when an order was received.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Due Date</em>: the date when the order is expected to be delivered.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Delivery Date</em>: the actual delivery date.</p></li>
</ul>
<p class="edition">The developer can relate the three dates to the same date table, knowing that only one of the three relationships can be active. Or, they can create three date tables in order to be able to slice by any of the three freely. Besides, it is likely that other tables contain other dates. For example, a <em class="calibre5">Purchase</em> table might contain other dates about the purchase process, a <em class="calibre5">Budget</em> table contains other dates in turn, and so on. In the end, every data model typically contains several dates, and one needs to understand the best way to handle all these dates.</p>
<p class="edition">In the next sections, we show two design options to handle this scenario and how this affects the DAX code.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-142" class="calibre13">Handling multiple relationships to the <em class="calibre5">Date</em> table</h4>
<p class="edition">One can create multiple relationships between two tables. Nevertheless, only one relationship can be active. The other relationships need to be kept inactive. Inactive relationships can be activated in <em class="calibre5">CALCULATE</em> through the <em class="calibre5">USERELATIONSHIP</em> modifier introduced in <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>, “<a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em></a>.”</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3048"></span>For example, consider the data model shown in <a href="#calibre_link-776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-5</a>. There are two different relationships between <em class="calibre5">Sales</em> and <em class="calibre5">Date</em>, but only one can be active. In the example, the active relationship is the one between <em class="calibre5">Sales[Order Date]</em> and <em class="calibre5">Date[Date]</em>.</p>
<figure id="calibre_link-776" class="image-l">
<img src="images/001079.jpg" alt="The model shows two relationships between Sales and Date. Only the one between Sales[Order Date] and Date[Date] is active." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-5</strong> The active relationship connects <em class="calibre5">Sales[Order Date]</em> to <em class="calibre5">Date[Date]</em>.</figcaption>
</figure>
<p class="edition">You can create two measures for the sales amount based on a different relationship to the <em class="calibre5">Date</em> table:</p>
<p class="codelink"><a href="#calibre_link-777" id="calibre_link-2397" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Ordered Amount :=
SUMX ( Sales, Sales[Net Price] * Sales[Quantity] )

Delivered Amount :=
CALCULATE (
    SUMX ( Sales, Sales[Net Price] * Sales[Quantity] ),
    USERELATIONSHIP ( Sales[Delivery Date], 'Date'[Date] )
)</pre></div>
<p class="edition">The first measure, <em class="calibre5">Ordered Amount</em>, uses the active relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Date</em>, based on <em class="calibre5">Sales[Order Date]</em>. The second measure, <em class="calibre5">Delivered Amount</em>, executes the same DAX expression using the relationship based on <em class="calibre5">Sales[Delivery Date]</em>. <em class="calibre5">USERELATIONSHIP</em> changes the active relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Date</em> in the filter context defined by <em class="calibre5">CALCULATE</em>. You can see in <a href="#calibre_link-778" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-6</a> an example of a report using these measures.</p>
<figure id="calibre_link-778" class="image-l">
<img src="images/001086.jpg" alt="The report shows the discrepancy between Ordered Amount and Delivered Amount, for each month." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1940"></span><strong class="calibre7">Figure 8-6</strong> The <em class="calibre5">Ordered Amount</em> and <em class="calibre5">Delivered Amount</em> measures are different for each month because the date of delivery might be in the following month.</figcaption>
</figure>
<p class="edition">Using multiple relationships with a single date table increases the number of measures in the data model. Generally, one only defines the measures that are meaningful with certain dates. If you do not want to handle a large number of measures, or if you want complete freedom of using any measure with any date, then you might consider implementing calculation groups as explained in the following chapter.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-143" class="calibre13">Handling multiple date tables</h4>
<p class="edition">Instead of duplicating every measure, an alternative approach is to create different date tables&mdash;one for each date in the model&mdash;so that every measure aggregates data according to the date selected in the report. From a maintenance point of view, this might seem like a better solution because it lowers the number of measures, and it allows for the selecting of sales that intersect between two months, but it produces a model that is harder to use. For example, one can easily produce a report with the total number of orders received in January and delivered in February of the same year&mdash;but it is harder to show in the same chart the amounts ordered and delivered by month.</p>
<p class="edition">This approach is also known as the role-playing dimension approach. The date table is a dimension that you duplicate once for each relationship&mdash;that is, once for each of its roles. These two options (using inactive relationships and duplicating the date table) are complementary to each other.</p>
<p class="edition">To create a <em class="calibre5">Delivery Date</em> table and an <em class="calibre5">Order Date</em> table, you add the same table twice in the data model. You must at least modify the table name when doing so. You can see in <a href="#calibre_link-779" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-7</a> the data model containing two different date tables related to <em class="calibre5">Sales</em>.</p>
<figure id="calibre_link-779" class="image-l">
<img src="images/001093.jpg" alt="The data model shows two different date tables related to Sales." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1938"></span><strong class="calibre7">Figure 8-7</strong> Each date column in <em class="calibre5">Sales</em> has a relationship with a different date table.</figcaption>
</figure>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">You must physically duplicate the <em class="calibre5">Date</em> table. Therefore, it is a best practice to create different views in the data source, one for each role dimension, so that each date table has different column names and different content. For example, instead of having the same <em class="calibre5">Year</em> column in all the date tables, it is better if you use <em class="calibre5">Order Year</em> and <em class="calibre5">Delivery Year</em>. Navigating the report will be easier this way. This is also visible in <a href="#calibre_link-779" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-7</a>. Furthermore, it is also a good practice to change the content of columns; for instance, by placing a prefix for the year depending on the role of the date. As an example, one might use the <em class="calibre5">CY</em> prefix for the content of the <em class="calibre5">Order Year</em> column and the <em class="calibre5">DY</em> prefix for the content of the <em class="calibre5">Delivery Year</em> column.</p>
</div>
<p class="edition"><a href="#calibre_link-780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-8</a> shows an example of a matrix using multiple date tables. Such a report cannot be created using multiple relationships with a single <em class="calibre5">Date</em> table. You can see that renaming column names and content is important to produce a readable result. In order to avoid confusion between order and delivery dates, we used <em class="calibre5">CY</em> as a prefix for order years and <em class="calibre5">DY</em> as a prefix for delivery years.</p>
<figure id="calibre_link-780" class="image-l">
<img src="images/001101.jpg" alt="The report shows the different prefixes for delivery years and order years." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-8</strong> The different prefixes for Year help the user see which is the order year (<em class="calibre5">CY</em>) and which is the delivery year (<em class="calibre5">DY</em>).</figcaption>
</figure>
<p class="edition">Using multiple date tables, the same measure displays different results depending on the columns used to slice and dice. However, it would be wrong to choose multiple date tables just to reduce the number of measures because this makes it impossible to create a report with the same measures grouped by two dates. For example, consider a single line chart showing <em class="calibre5">Sales Amount</em> by <em class="calibre5">Order Date</em> and <em class="calibre5">Delivery Date</em>. One needs a single <em class="calibre5">Date</em> table in the date axis of the chart, and this would be extremely complex to achieve with the multiple date tables pattern.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1809"></span>If your first priority is to reduce the number of measures in a model, enabling the user to browse any measure by any date, you should consider using the calculation groups described in <a href="#calibre_link-14" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 9</a>, “<a href="#calibre_link-14" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Calculation groups</a>,” implementing a single date table in the model. The main scenario where multiple date tables are useful is to intersect the same measure by different dates in the same visualization, as demonstrated in <a href="#calibre_link-780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-8</a>. In most other scenarios, a single date table with multiple relationships is a better choice.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-144" class="h2a">Understanding basic time intelligence calculations</h3>
<p class="edition">In the previous sections you learned how to correctly build a date table. The date table is useful to perform any time intelligence calculation. DAX provides several time intelligence functions that simplify such calculations. It is easy to use those functions and build useful calculations. Nevertheless, it is all too easy to start using those functions without a good understanding of their inner details. For educational purposes, in this section we demonstrate how to author any time intelligence calculation by using standard DAX functions such as <em class="calibre5">CALCULATE</em>, <em class="calibre5">CALCULATETABLE</em>, <em class="calibre5">FILTER</em>, and <em class="calibre5">VALUES</em>. Then, later in this chapter, you learn how the time intelligence functions in DAX help you shorten your code and make it more readable.</p>
<p class="edition">There are multiple reasons why we decided to use this approach. The main driver is that, when it comes to time intelligence, there are many different calculations that cannot be expressed by simply using standard DAX functions. At some point in your DAX career, you will need to author a measure more complex than a simple year-to-date (YTD) discovering that DAX has no predefined functions for your requirements. If you learned to code time intelligence the hard way, this will not be a problem. You will roll up your sleeves and write the correct filter function without the help of DAX predefined calculations. If, on the other hand, you simply leverage standard DAX functions, then complex time intelligence will be problematic to solve.</p>
<p class="edition">Here is a general explanation of how time intelligence calculations work. Consider a simple measure; its evaluation happens in the current filter context:</p>
<p class="codelink"><a href="#calibre_link-781" id="calibre_link-2398" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX ( Sales, Sales[Net Price] * Sales[Quantity] )</pre></div>
<p class="edition">Because <em class="calibre5">Sales</em> has a relationship with <em class="calibre5">Date</em>, the current selection on <em class="calibre5">Date</em> determines the filter over <em class="calibre5">Sales</em>. To perform the calculation over <em class="calibre5">Sales</em> in a different period, the programmer needs to modify the existing filter on <em class="calibre5">Date</em>. For example, to compute a YTD when the filter context is filtering February 2007, they would need to change the filter context to include January and February 2007, before performing the iteration over <em class="calibre5">Sales</em>.</p>
<p class="edition">A solution for this is to use a filter argument in a <em class="calibre5">CALCULATE</em> function, which returns the year-to-date up to February 2007:</p>
<p class="codelink"><a href="#calibre_link-782" id="calibre_link-2399" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount Jan-Feb 2007 :=
CALCULATE (
    SUMX ( Sales, Sales[Net Price]  * Sales[Quantity] ),
    FILTER (
        ALL ( 'Date' ),
        AND (
            'Date'[Date] &gt;= DATE ( 2007, 1, 1 ),
            'Date'[Date] &lt;= DATE ( 2007, 2, 28 )
        )
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3049"></span>The result is visible in <a href="#calibre_link-783" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-9</a>.</p>
<figure id="calibre_link-783" class="image-l">
<img src="images/001107.jpg" alt="In the report, Sales Amount Jan-Feb 2007 is always the sum of January and February 2007." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-9</strong> The result is the sum of January and February 2007, regardless of the date range selection on rows.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">FILTER</em> function used as a filter argument of <em class="calibre5">CALCULATE</em> returns a set of dates that replaces the selection of the <em class="calibre5">Date</em> table. In other words, even though the original filter context coming from the rows of the matrix filters an individual month, the measure computes the value on a different set of dates.</p>
<p class="edition">Obviously, a measure that returns the sum of two months is not useful. Nevertheless, once you understand the basic mechanism, you can use it to write a different calculation that computes the year-to-date such as the following code:</p>
<p class="codelink"><a href="#calibre_link-784" id="calibre_link-2400" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount YTD :=
VAR LastVisibleDate = MAX ( 'Date'[Date] )
VAR CurrentYear = YEAR ( LastVisibleDate )
VAR SetOfDatesYtd =
    FILTER (
        ALL ( 'Date' ),
        AND (
            'Date'[Date] &lt;= LastVisibleDate,
            YEAR ( 'Date'[Date] ) = CurrentYear
        )
    )
VAR Result =
    CALCULATE (
        SUMX ( Sales, Sales[Net Price]  * Sales[Quantity] ),
        SetOfDatesYtd
    )
RETURN
    Result</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3050"></span>Though this code is a bit more complex than the previous code, the pattern is the same. In fact, this measure first retrieves in <em class="calibre5">LastVisibleDate</em> the last date selected in the current filter context. Once the date is known, it extracts its year and saves it in the <em class="calibre5">CurrentYear</em> variable. The third variable <em class="calibre5">SetOfDatesYtd</em> contains all the dates in the current year, before the end of the current period. This set is used to replace the filter context on the date to compute the year-to-date, as you can see in <a href="#calibre_link-785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-10</a>.</p>
<figure id="calibre_link-785" class="image-l">
<img src="images/001115.jpg" alt="The report displays the Sales Amount and Sales Amount YTD per month." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-10</strong> <em class="calibre5">Sales Amount YTD</em> computes the year-to-date with a simple <em class="calibre5">FILTER</em> function.</figcaption>
</figure>
<p class="edition">As explained earlier, one could write a time intelligence calculation without using time intelligence functions. The important concept here is that time intelligence calculations are not different from any other calculation involving filter context manipulation. Because the measure needs to aggregate values from a different set of dates, the calculation happens in two steps. First, it determines the new filter for the date. Second, it applies the new filter context before computing the actual measure. All time intelligence calculations behave the same way. Once you understand the basic concept, then time intelligence calculations will have no secrets for you.</p>
<p class="edition">Before moving further with more time intelligence calculations, it is important to describe a special behavior of DAX when handling relationships that are based on a date. Look at this slightly <span type="pagebreak" id="calibre_link-3051"></span>different formulation of the same code, where instead of filtering the entire date table, we only filter the <em class="calibre5">Date[Date]</em> column:</p>
<p class="codelink"><a href="#calibre_link-786" id="calibre_link-2401" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount YTD :=
VAR LastVisibleDate = MAX ( 'Date'[Date] )
VAR CurrentYear = YEAR ( LastVisibleDate )
VAR SetOfDatesYtd =
    FILTER (
        <strong class="calibre7">ALL ( 'Date'[Date] ),</strong>
        AND (
            'Date'[Date] &lt;= LastVisibleDate,
            YEAR ( 'Date'[Date] ) = CurrentYear
        )
    )
VAR Result
    CALCULATE (
        SUMX ( Sales, Sales[Net Price]  * Sales[Quantity] ),
        SetOfDatesYtd
    )
RETURN
    Result</pre></div>
<p class="edition">If someone uses this measure in a report instead of the previous measure, they will see no changes. In fact, the two versions of this measure compute exactly the same value, but they should not. Let us examine in detail one specific cell&mdash;for example, April 2007.</p>
<p class="edition">The filter context of the cell is Year 2007, Month April. As a consequence, <em class="calibre5">LastVisibleDate</em> contains the 30th of April 2007, whereas <em class="calibre5">CurrentYear</em> contains 2007. Then because of its formulation, <em class="calibre5">SetOfDatesYtd</em> contains all the dates between January 1, 2007, up to April 30, 2007. In other words, in the cell of April 2007, the code executed is equivalent to this:</p>
<p class="codelink"><a href="#calibre_link-787" id="calibre_link-2402" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    CALCULATE (
        [Sales Amount],
        AND (                                       -- This filter is equivalent
            'Date'[Date] &gt;= DATE ( 2007, 1, 1),     -- to the result of the FILTER
            'Date'[Date] &lt;= DATE ( 2007, 04, 30 )   -- function
        )
    ),
    'Date'[Year] = 2007,                            -- These are coming from the rows
    'Date'[Month] = "April"                         -- of the matrix in April 2007
)</pre></div>
<p class="edition">If you recall what you learned about filter contexts and the <em class="calibre5">CALCULATE</em> behavior, you should verify that this code should not compute a correct year-to-date. Indeed, the inner <em class="calibre5">CALCULATE</em> filter argument returns a table containing the <em class="calibre5">Date[Date]</em> column. As such, it should overwrite any existing filter on <em class="calibre5">Date[Date]</em>, keeping other filters on other columns untouched. Because the outer <em class="calibre5">CALCULATE</em> applies a filter to <em class="calibre5">Date[Year]</em> and to <em class="calibre5">Date[Month]</em>, the final filter context where <em class="calibre5">[Sales Amount]</em> is computed should only contain April 2007. Nevertheless, the measure actually computes a correct result including the other months since January 2007.</p>
<p class="edition">The reason is a special behavior of DAX when the relationship between two tables is based on a date column, as it happens for the relationship with <em class="calibre5">Date</em> in the demo model we are using here. Whenever a <span type="pagebreak" id="calibre_link-1810"></span>filter is applied to a column of type <em class="calibre5">Date</em> or <em class="calibre5">DateTime</em> that is used in a relationship between two tables, DAX automatically adds an <em class="calibre5">ALL</em> to the entire <em class="calibre5">Date</em> table as an additional filter argument to <em class="calibre5">CALCULATE</em>. In other words, the previous code should read this way:</p>
<p class="codelink"><a href="#calibre_link-788" id="calibre_link-2403" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    CALCULATE (
        [Sales Amount],
        AND (                                       -- This filter is equivalent
            'Date'[Date] &gt;= DATE ( 2007, 1, 1),     -- to the result of the FILTER
            'Date'[Date] &lt;= DATE ( 2007, 04, 30 )   -- function
        ),
        <strong class="calibre7">ALL ( 'Date' )    -- This is automatically added by the engine</strong>
    ),
    'Date'[Year] = 2007,                            -- These are coming from the rows
    'Date'[Month] = "April"                         -- of the matrix in April 2007
)</pre></div>
<p class="edition">Every time a filter is applied on the column that defines a one-to-many relationship with another table, and the column has a <em class="calibre5">Date</em> or <em class="calibre5">DateTime</em> data type, DAX automatically propagates the filter to the other table and overrides any other filter on other columns of the same lookup table.</p>
<p class="edition">The reason for this behavior is to make time intelligence calculations work more simply in the case where the relationship between the date table and the sales table is based on a date column. In the next section, we describe the behavior of the Mark as Date Table feature, which introduces a similar behavior for relationships not based on a date column.</p>
<section class="calibre4">
<h4 id="calibre_link-145" class="calibre13">Using Mark as Date Table</h4>
<p class="edition">Applying a filter on the date column of a calendar table works fine if the date column also defines the relationship. However, one might have a relationship based on another column. Many existing date tables use an integer column&mdash;typically in the format YYYYMMDD&mdash;to create the relationship with other tables.</p>
<p class="edition">In order to demonstrate the behavior, we created the <em class="calibre5">DateKey</em> column in both the <em class="calibre5">Date</em> and <em class="calibre5">Sales</em> tables. We then linked the two using the <em class="calibre5">DateKey</em> column instead of the date column. The resulting model is visible in <a href="#calibre_link-789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-11</a>.</p>
<figure id="calibre_link-789" class="image-l">
<img src="images/001121.jpg" alt="The data model shows Sales and Date linked by a relationship that uses DateKey." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-11</strong> The relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Date</em> uses the <em class="calibre5">DateKey</em> column, with an <em class="calibre5">Integer</em> data type.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1939"></span>Using the same code that worked in previous examples to compute the YTD in <a href="#calibre_link-789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-11</a> would result in an incorrect calculation. You see this in <a href="#calibre_link-790" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-12</a>.</p>
<figure id="calibre_link-790" class="image-l">
<img src="images/001128.jpg" alt="The report returns incorrect numbers for Sales Amount YTD." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-12</strong> Using an integer for the relationship makes the previous code stop working.</figcaption>
</figure>
<p class="edition">As you can see, now the report shows the same value for <em class="calibre5">Sales Amount</em> and for <em class="calibre5">Sales Amount YTD</em>. Indeed, since the relationship is no longer based on a <em class="calibre5">DateTime</em> column, DAX does not add the automatic <em class="calibre5">ALL</em> function to the date table. As such, the filter with the date is intersecting with the previous filter, vanishing the effect of the measure.</p>
<p class="edition">In such cases there are two possible solutions: one is to manually add <em class="calibre5">ALL</em> to all the time intelligence calculations. This solution is somewhat cumbersome because it requires the DAX coder to always remember to add <em class="calibre5">ALL</em> to all of the calculations. The other possible solution is much more convenient: mark the <em class="calibre5">Date</em> table as a date table.</p>
<p class="edition">If the date table is marked as such, then DAX will automatically add <em class="calibre5">ALL</em> to the table even if the relationship was not based on a date column. Be mindful that once the table is marked as a date table, the automatic <em class="calibre5">ALL</em> on the table is always added whenever one modifies the filter context on the date column. There are scenarios where this effect is undesirable, and in such cases, one would need to write complex code to build the correct filter. We cover this later in this chapter.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-146" class="h2a">Introducing basic time intelligence functions</h3>
<p class="edition">Now that you have learned the basic mechanism that runs time intelligence calculations, it is time to simplify the code. Indeed, if DAX developers had to write complex <em class="calibre5">FILTER</em> expressions every time they need a simple year-to-date calculation, their life would be troublesome.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3052"></span>To simplify the authoring of time intelligence calculations, DAX offers a rich set of functions that automatically perform the same filtering we wrote manually in the previous examples. For example, this is the version of <em class="calibre5">Sales Amount YTD</em> measure we wrote earlier:</p>
<p class="codelink"><a href="#calibre_link-791" id="calibre_link-2404" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount YTD :=
VAR LastVisibleDate = MAX ( 'Date'[Date] )
VAR CurrentYear = YEAR ( LastVisibleDate )
VAR SetOfDatesYTD =
    FILTER (
        ALL ( 'Date'[Date] ),
        AND (
            'Date'[Date] &lt;= LastVisibleDate,
            YEAR ( 'Date'[Date] ) = CurrentYear
        )
    )
VAR Result =
    CALCULATE (
        SUMX ( Sales, Sales[Net Price]  * Sales[Quantity] ),
        SetOfDatesYTD
    )
RETURN
    Result</pre></div>
<p class="edition">The same behavior can be expressed by a much simpler code using the <em class="calibre5">DATESYTD</em> function:</p>
<p class="codelink"><a href="#calibre_link-792" id="calibre_link-2405" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount YTD :=
CALCULATE (
    SUMX ( Sales, Sales[Net Price]  * Sales[Quantity] ),
    DATESYTD ( 'Date'[Date] )
)</pre></div>
<p class="edition">Be mindful that <em class="calibre5">DATESYTD</em> does exactly what the more complex code performs. The gain is neither in performance nor in behavior of the code. However, because it is so much easier to write, you see that learning the many time intelligence functions in DAX is worth your time.</p>
<p class="edition">Simple calculations like year-to-date, quarter-to-date, month-to-date, or the comparison of sales in the current year versus the previous year can be authored with simpler code as they all rely on basic time intelligence functions. More complex calculations can oftentimes be expressed by mixing standard time intelligence functions. The only scenario where the developer will really need to author complex code is when they need nonstandard calendars, like a weekly calendar, or for complex time intelligence calculations when the standard functions will not meet the requirements.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">All time intelligence functions in DAX apply a filter condition on the date column of a <em class="calibre5">Date</em> table. You can find some examples of how to write these calculations in DAX later in this book and a complete list of all the time intelligence features rewritten in plain DAX at <a href="http://www.daxpatterns.com/time-patterns/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://www.daxpatterns.com/time-patterns/</a>.</p>
</div>
<p class="edition"><span type="pagebreak" id="calibre_link-1942"></span>In the next sections, we introduce the basic time intelligence calculations authored with the standard time intelligence functions in DAX. Later in this chapter, we will cover more advanced calculations.</p>
<section class="calibre4">
<h4 id="calibre_link-147" class="calibre13">Using year-to-date, quarter-to-date, and month-to-date</h4>
<p class="edition">The calculations of year-to-date (YTD), quarter-to-date (QTD), and month-to-date (MTD) are all very similar. Month-to-date is meaningful only when you are looking at data at the day level, whereas year-to-date and quarter-to-date calculations are often used to look at data at the month level.</p>
<p class="edition">You can calculate the year-to-date value of sales for each month by modifying the filter context on dates for a range that starts on January 1 and ends on the month corresponding to the calculated cell. You see this in the following DAX formula:</p>
<p class="codelink"><a href="#calibre_link-793" id="calibre_link-2406" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount YTD :=
CALCULATE (
    [Sales Amount],
    DATESYTD ( 'Date'[Date] )
)</pre></div>
<p class="edition"><em class="calibre5">DATESYTD</em> is a function that returns a table with all the dates from the beginning of the year until the last date included in the current filter context. This table is used as a filter argument in <em class="calibre5">CALCULATE</em> to set the new filter for the <em class="calibre5">Sales Amount</em> calculation. Similar to <em class="calibre5">DATESYTD</em>, there are another two functions that return the month-to-date (<em class="calibre5">DATESMTD</em>) and quarter-to-date (<em class="calibre5">DATESQTD</em>) sets. For example, you can see measures based on <em class="calibre5">DATESYTD</em> and <em class="calibre5">DATESQTD</em> in <a href="#calibre_link-794" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-13</a>.</p>
<figure id="calibre_link-794" class="image-l">
<img src="images/001135.jpg" alt="In this report the Sales Amount YTD and Sales Amount QTD measures are side by side with the regular Sales Amount measure." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-13</strong> The <em class="calibre5">Sales Amount YTD</em> and <em class="calibre5">Sales Amount QTD</em> measures are side by side with the regular <em class="calibre5">Sales Amount</em> measure.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1958"></span>This approach requires the use of <em class="calibre5">CALCULATE</em>. DAX also offers a set of functions to simplify the syntax of to-date calculations: <em class="calibre5">TOTALYTD, TOTALQTD</em>, and <em class="calibre5">TOTALMTD</em>. In the following code, you can see the year-to-date calculation expressed using <em class="calibre5">TOTALYTD</em>:</p>
<div class="program"><pre class="calibre14">YTD Sales :=
TOTALYTD (
    [Sales Amount],
    'Date'[Date]
)</pre></div>
<p class="edition">The syntax is somewhat different, as <em class="calibre5">TOTALYTD</em> requires the expression to aggregate as its first parameter and the date column as its second parameter. Nevertheless, the behavior is identical to the original measure. The name <em class="calibre5">TOTALYTD</em> hides the underlying <em class="calibre5">CALCULATE</em> function, which is a good reason to limit its use. In fact, whenever <em class="calibre5">CALCULATE</em> is present in the code, making it evident is always a good practice&mdash;for example, for the context transition it implies.</p>
<p class="edition">Similar to year-to-date, you can also define quarter-to-date and month-to-date with built-in functions, as in these measures:</p>
<p class="codelink"><a href="#calibre_link-795" id="calibre_link-2407" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">QTD Sales := TOTALQTD ( [Sales Amount], 'Date'[Date] )
QTD Sales := CALCULATE ( [Sales Amount], DATESQTD ( 'Date'[Date] ) )
MTD Sales := TOTALMTD ( [Sales Amount], 'Date'[Date] )
MTD Sales := CALCULATE ( [Sales Amount], DATESMTD ( 'Date'[Date] ) )</pre></div>
<p class="edition">Calculating a year-to-date measure over a fiscal year that does not end on December 31 requires an optional third parameter that specifies the end day of the fiscal year. For example, both the following measures calculate the fiscal year-to-date for <em class="calibre5">Sales</em>:</p>
<p class="codelink"><a href="#calibre_link-796" id="calibre_link-2408" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Fiscal YTD Sales := TOTALYTD ( [Sales Amount], 'Date'[Date], "06-30" )
Fiscal YTD Sales := CALCULATE ( [Sales Amount], DATESYTD ( 'Date'Date], "06-30" ) )</pre></div>
<p class="edition">The last parameter corresponds to June 30&mdash;that is, the end of the fiscal year. There are several time intelligence functions that have a last, optional year-end date parameter for this purpose: <em class="calibre5">STARTOFYEAR</em>, <em class="calibre5">ENDOFYEAR</em>, <em class="calibre5">PREVIOUSYEAR</em>, <em class="calibre5">NEXTYEAR</em>, <em class="calibre5">DATESYTD</em>, <em class="calibre5">TOTALYTD</em>, <em class="calibre5">OPENINGBALANCEYEAR</em>, and <em class="calibre5">CLOSINGBALANCEYEAR</em>.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">Depending on the culture settings, you might have to use the day number first. You can also consider using a string with the format YYYY-MM-DD to avoid any ambiguity caused by culture settings; in that case, the year does not matter for the purpose of determining the last day of the year to use for year-to-date calculation:</p>
<p class="codelink"><a href="#calibre_link-797" id="calibre_link-2409" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Fiscal   YTD Sales := TOTALYTD ( [Sales Amount], 'Date'[Date], "30-06"  )
Fiscal  YTD Sales := CALCULATE ( [Sales Amount], DATESYTD ( 'Date'[Date], "30-06" ) )
Fiscal YTD Sales := CALCULATE ( [Sales Amount], DATESYTD ('Date'[Date],"2018-06-30" ) )</pre></div>
<p class="edition">However, consider that as of June 2018 there is a bug in case the fiscal year starts in March and ends in February. More details and a workaround are described later in the “Advanced time intelligence” section of this chapter.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-148" class="calibre13"><span type="pagebreak" id="calibre_link-1943"></span>Computing time periods from prior periods</h4>
<p class="edition">Several calculations are required to get a value from the same period in the prior year (PY). This can be useful for making comparisons of trends during a time period this year to the same time period last year. In that case <em class="calibre5">SAMEPERIODLASTYEAR</em> comes in handy:</p>
<p class="codelink"><a href="#calibre_link-798" id="calibre_link-2410" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PY Sales := CALCULATE ( [Sales Amount], SAMEPERIODLASTYEAR ( 'Date'[Date] ) )</pre></div>
<p class="edition"><em class="calibre5">SAMEPERIODLASTYEAR</em> returns a set of dates shifted one year back in time. <em class="calibre5">SAMEPERIODLASTYEAR</em> is a specialized version of the more generic <em class="calibre5">DATEADD</em> function, which accepts the number and type of period to shift. The types of periods supported are <em class="calibre5">YEAR</em>, <em class="calibre5">QUARTER</em>, <em class="calibre5">MONTH</em>, and <em class="calibre5">DAY</em>. For example, you can define the same <em class="calibre5">PY Sales</em> measure using this equivalent expression, which uses <em class="calibre5">DATEADD</em> to shift the current filter context one year back in time:</p>
<p class="codelink"><a href="#calibre_link-799" id="calibre_link-2411" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PY Sales := CALCULATE( [Sales Amount], DATEADD ( 'Date'[Date], -1, YEAR ) )</pre></div>
<p class="edition"><em class="calibre5">DATEADD</em> is more powerful than <em class="calibre5">SAMEPERIODLASTYEAR</em> because, in a similar way, DATEADD can compute the value from a previous quarter (PQ), month (PM), or day (PD):</p>
<p class="codelink"><a href="#calibre_link-800" id="calibre_link-2412" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PQ Sales := CALCULATE ( [Sales Amount], DATEADD ( 'Date'[Date], -1, QUARTER ) )
PM Sales := CALCULATE ( [Sales Amount], DATEADD ( 'Date'[Date], -1, MONTH ) )
PD Sales := CALCULATE ( [Sales Amount], DATEADD ( 'Date'[Date], -1, DAY ) )</pre></div>
<p class="edition">In <a href="#calibre_link-801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-14</a> you can see the result of some of these measures.</p>
<figure id="calibre_link-801" class="image-l">
<img src="images/001142.jpg" alt="The report makes that shift apparent." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-14</strong> <em class="calibre5">DATEADD</em> lets you shift the current filter context to different periods.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1944"></span>Another useful function is <em class="calibre5">PARALLELPERIOD</em>, which is similar to <em class="calibre5">DATEADD</em>, but returns the full period specified in the third parameter instead of the partial period returned by <em class="calibre5">DATEADD</em>. Thus, although a single month is selected in the current filter context, the following measure using <em class="calibre5">PARALLEPERIOD</em> calculates the amount of sales for the whole previous year:</p>
<p class="codelink"><a href="#calibre_link-802" id="calibre_link-2413" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PY Total Sales :=
CALCULATE ( [Sales Amount], PARALLELPERIOD ( 'Date'[Date], -1, YEAR ) )</pre></div>
<p class="edition">In a similar way, using different parameters, one can obtain different periods:</p>
<p class="codelink"><a href="#calibre_link-803" id="calibre_link-2414" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PQ Total Sales :=
CALCULATE ( [Sales Amount], PARALLELPERIOD ( 'Date'[Date], -1, QUARTER ) )</pre></div>
<p class="edition">In <a href="#calibre_link-804" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-15</a> you can see <em class="calibre5">PARALLELPERIOD</em> used to compute the previous year and quarter.</p>
<figure id="calibre_link-804" class="image-l">
<img src="images/001149.jpg" alt="The report shows PY Total Sales and PQ Total Sales alongside Sales Amount." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-15</strong> <em class="calibre5">PARALLELPERIOD</em> returns the full period instead of the current period shifted in time.</figcaption>
</figure>
<p class="edition">There are functions similar but not identical to <em class="calibre5">PARALLELPERIOD</em>, which are <em class="calibre5">PREVIOUSYEAR</em>, <em class="calibre5">PREVIOUSQUARTER</em>, <em class="calibre5">PREVIOUSMONTH</em>, <em class="calibre5">PREVIOUSDAY</em>, <em class="calibre5">NEXTYEAR</em>, <em class="calibre5">NEXTQUARTER</em>, <em class="calibre5">NEXTMONTH</em>, and <em class="calibre5">NEXTDAY</em>. These functions behave like <em class="calibre5">PARALLELPERIOD</em> when the selection has a single element selected corresponding to the function name&mdash;year, quarter, month, and day. If multiple periods are selected, then <em class="calibre5">PARALLELPERIOD</em> returns a shifted result of all of them. On the other hand, the specific <span type="pagebreak" id="calibre_link-1957"></span>functions (year, quarter, month, and day, respectively) return a single element that is contiguous to the selected period regardless of length. For example, the following code returns March, April, and May 2008 in case the second quarter of 2008 (April, May, and June) is selected:</p>
<p class="codelink"><a href="#calibre_link-805" id="calibre_link-2415" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PM Total Sales :=
CALCULATE ( [Sales Amount], PARALLELPERIOD ( 'Date'[Date], -1, MONTH ) )</pre></div>
<p class="edition">Conversely, the following code only returns March 2008 in case the second quarter of 2008 (April, May, and June) is selected.</p>
<p class="codelink"><a href="#calibre_link-806" id="calibre_link-2416" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Last PM Sales :=
CALCULATE ( [Sales Amount], PREVIOUSMONTH( 'Date'[Date] ) )</pre></div>
<p class="edition">The difference between the two measures is visible in <a href="#calibre_link-807" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-16</a>. The <em class="calibre5">Last PM Sales</em> measure returns the value of December 2007 for both 2008 and Q1 2008, whereas <em class="calibre5">PM Total Sales</em> always returns the value for the number of months of the selection&mdash;three for a quarter and twelve for a year. This occurs even though the initial selection is shifted back one month.</p>
<figure id="calibre_link-807" class="image-l">
<img src="images/001158.jpg" alt="The report shows Last PM Sales and PM Total Sales. PREVIOUSMONTH always returns a single month." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-16</strong> <em class="calibre5">PREVIOUSMONTH</em> returns a single month even when the selection includes a quarter or a year.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-149" class="calibre13">Mixing time intelligence functions</h4>
<p class="edition">One useful feature of time intelligence functions is the capability of composing more complex formulas by using time intelligence functions together. The first parameter of most time intelligence functions is the date column in the date table. However, this is just syntax sugar for the complete syntax. In fact, the full syntax of time intelligence functions requires a table as its first parameter, as you can see in the following two equivalent versions of the same measure. When used, the date column referenced is <span type="pagebreak" id="calibre_link-3053"></span>translated into a table with the unique values active in the filter context after a context transition, if a row context exists:</p>
<p class="codelink"><a href="#calibre_link-808" id="calibre_link-2417" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PY Sales :=
CALCULATE (
    [Sales Amount],
    DATESYTD ( 'Date'[Date] )
)

-- is equivalent to

PY Sales :=
CALCULATE (
    [Sales Amount],
    <strong class="calibre7">DATESYTD ( CALCULATETABLE ( DISTINCT ( 'Date'[Date] ) ) )</strong>
)</pre></div>
<p class="edition">Time intelligence functions accept a table as their first parameter, and they act as time shifters. These functions take the content of the table, and they shift it back and forth over time by any number of years, quarters, months, or days. Because time intelligence functions accept a table, any table expression can be used in place of the table&mdash;including another time intelligence function. This makes it possible to combine multiple time intelligence functions, by cascading their results one into the other.</p>
<p class="edition">For example, the following code compares the year-to-date with the corresponding value in the previous year. It does so by combining <em class="calibre5">SAMEPERIODLASTYEAR</em> and <em class="calibre5">DATESYTD</em>. It is interesting to note that exchanging the order of the function calls does not change the result:</p>
<p class="codelink"><a href="#calibre_link-809" id="calibre_link-2418" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PY YTD Sales :=
CALCULATE (
    [Sales Amount],
    SAMEPERIODLASTYEAR ( DATESYTD ( 'Date'[Date] ) )
)

-- is equivalent to

PY YTD Sales :=
CALCULATE (
    [Sales Amount],
    DATESYTD ( SAMEPERIODLASTYEAR ( 'Date'[Date] ) )
)</pre></div>
<p class="edition">It is also possible to use <em class="calibre5">CALCULATE</em> to move the current filter context to a different time period and then invoke a function that, in turn, analyzes the filter context and moves it to a different time period. The following two definitions of <em class="calibre5">PY YTD Sales</em> are equivalent to the previous two; <em class="calibre5">YTD Sales</em> and <em class="calibre5">PY Sales</em> measures are defined earlier in this chapter:</p>
<p class="codelink"><a href="#calibre_link-810" id="calibre_link-2419" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PY YTD Sales :=
CALCULATE (
    [YTD Sales],
    SAMEPERIODLASTYEAR ( 'Date'[Date] )
)
-- is equivalent to

PY YTD Sales :=
CALCULATE (
    [PY Sales],
    DATESYTD ( 'Date'[Date] )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1947"></span>You can see the results of <em class="calibre5">PY YTD Sales</em> in <a href="#calibre_link-811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-17</a>. The values of <em class="calibre5">YTD Sales</em> are reported for <em class="calibre5">PY YTD Sales</em>, shifted one year ahead.</p>
<figure id="calibre_link-811" class="image-l">
<img src="images/001164.jpg" alt="The report shows accurate YTD Sales and PY YTD Sales calculations." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-17</strong> The prior year year-to-date calculation can be computed by composing time intelligence functions.</figcaption>
</figure>
<p class="edition">All the examples seen in this section can operate at the year, quarter, month, and day levels, but not at the week level. Time intelligence functions are not available for week-based calculations because there are too many variations of years/quarters/months based on weeks. For this reason, you must implement DAX expressions to handle week-based calculations. You can find more details and an example of this approach in the “<a href="#calibre_link-161" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with custom calendars</a>” section, later in this chapter.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-150" class="calibre13">Computing a difference over previous periods</h4>
<p class="edition">A common operation is calculating the difference between a measure and its value in the prior year. You can express that difference as an absolute value or as a percentage. You have already seen how to obtain the value for the prior year with the <em class="calibre5">PY Sales</em> measure:</p>
<p class="codelink"><a href="#calibre_link-812" id="calibre_link-2420" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PY Sales := CALCULATE ( [Sales Amount], SAMEPERIODLASTYEAR ( 'Date'[Date] ) )</pre></div>
<p class="edition">For <em class="calibre5">Sales Amount</em>, the absolute difference over the previous year (year-over-year or YOY) is a simple subtraction. However, you need to add a failsafe if you want to only show the difference when both <span type="pagebreak" id="calibre_link-3054"></span>values are available. In that case, variables are important to avoid calculating the same measure twice. You can define a <em class="calibre5">YOY Sales</em> measure with the following expression:</p>
<p class="codelink"><a href="#calibre_link-813" id="calibre_link-2421" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">YOY Sales :=
VAR CySales = [Sales Amount]
VAR PySales = [PY Sales]
VAR YoySales =
    IF (
        NOT ISBLANK ( CySales ) &amp;&amp; NOT ISBLANK ( PySales ),
        CySales - PySales
    )
RETURN
    YoySales</pre></div>
<p class="edition">The equivalent calculation for comparing the year-to-date measure with a corresponding value in the prior year is a simple subtraction of two measures, <em class="calibre5">YTD Sales</em> and <em class="calibre5">PY YTD Sales</em>. You learned those in the previous section:</p>
<p class="codelink"><a href="#calibre_link-814" id="calibre_link-2422" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">YTD Sales := TOTALYTD ( [Sales Amount], 'Date'[Date] )

PY YTD Sales :=
CALCULATE (
    [Sales Amount],
    DATESYTD ( SAMEPERIODLASTYEAR ( 'Date'[Date] ) )
)

YOY YTD Sales :=
VAR CyYtdSales = [YTD Sales]
VAR PyYtdSales = [PY YTD Sales]
VAR YoyYtdSales =
    IF (
        NOT ISBLANK ( CyYtdSales ) &amp;&amp; NOT ISBLANK ( PyYtdSales ),
        CyYtdSales - PyYtdSales
    )
RETURN
    YoyYtdSales</pre></div>
<p class="edition">Often, the year-over-year difference is better expressed as a percentage in a report. You can define this calculation by dividing <em class="calibre5">YOY Sales</em> by <em class="calibre5">PY Sales</em>; this way, the difference uses the previous year value as a reference for the percentage difference (100 percent corresponds to a value that is doubled in one year). In the following expressions that define the <em class="calibre5">YOY Sales%</em> measure, the <em class="calibre5">DIVIDE</em> function avoids a divide-by-zero error if there is no corresponding data in the prior year:</p>
<p class="codelink"><a href="#calibre_link-815" id="calibre_link-2423" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">YOY Sales% := DIVIDE ( [YOY Sales], [PY Sales] )</pre></div>
<p class="edition">A similar calculation displays the percentage difference of a year-over-year comparison for the year-to-date aggregation. The following definition of <em class="calibre5">YOY YTD Sales%</em> implements this calculation:</p>
<p class="codelink"><a href="#calibre_link-816" id="calibre_link-2424" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">YOY YTD Sales% := DIVIDE ( [YOY YTD Sales], [PY YTD Sales] )</pre></div>
<p class="edition">In <a href="#calibre_link-817" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-18</a>, you can see the results of these measures in a report.</p>
<figure id="calibre_link-817" class="image-l">
<img src="images/001172.jpg" alt="The report shows a series of calculations: Sales Amount, PY Sales, YOY Sales, YTD Sales, PY YTD Sales, and percentage differences." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1713"></span><strong class="calibre7">Figure 8-18</strong> The report shows all the year-over-year (YOY) measures used in the same matrix.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-151" class="calibre13">Computing a moving annual total</h4>
<p class="edition">Another common calculation that eliminates seasonal changes in sales is the moving annual total (MAT), which considers the sales aggregation over the past 12 months. You learned a technique to compute a moving average in <a href="#calibre_link-12" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 7</a>, “<a href="#calibre_link-12" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with iterators and with <em class="calibre5">CALCULATE</em></a>.” Here we want to describe a formula to compute a similar average by using time intelligence functions.</p>
<p class="edition">For example, summing the range of dates from April 2007 to March 2008 calculates the value of <em class="calibre5">MAT Sales</em> for March 2008. The easiest approach is to use the <em class="calibre5">DATESINPERIOD</em> function. <em class="calibre5">DATESINPERIOD</em> returns all the dates included within a period that can be a number of years, quarters, months, or days.</p>
<p class="codelink"><a href="#calibre_link-818" id="calibre_link-2425" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">MAT Sales :=
CALCULATE (                           -- Compute the sales amount in a new filter
    [Sales Amount],                   -- context modified by the next argument.
    DATESINPERIOD (                   -- Returns a table containing
        'Date'[Date],                 -- Date[Date] values,
        MAX ( 'Date'[Date] ),         -- starting from the last visible date
       -1,                            -- and going back 1
       YEAR                           -- year.
    )
)</pre></div>
<p class="edition">Using <em class="calibre5">DATESINPERIOD</em> is usually the best option for the moving annual total calculation. For educational purposes, it is useful to see other techniques to obtain the same filter. Consider this alternative <em class="calibre5">MAT Sales</em> definition, which calculates the moving annual total for sales:</p>
<p class="codelink"><a href="#calibre_link-819" id="calibre_link-2426" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">MAT Sales :=
CALCULATE (
    [Sales Amount],
    DATESBETWEEN (
        'Date'[Date],
        NEXTDAY ( SAMEPERIODLASTYEAR ( LASTDATE ( 'Date'[Date] ) ) ),
        LASTDATE ( 'Date'[Date] )
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1714"></span>The implementation of this measure requires some attention. The formula uses the <em class="calibre5">DATESBETWEEN</em> function, which returns the dates from a column included between two specified dates. Because <em class="calibre5">DATESBETWEEN</em> works at the day level, even if the report is querying data at the month level, the code must calculate the first day and the last day of the required interval. A way to obtain the last day is by using the <em class="calibre5">LASTDATE</em> function. <em class="calibre5">LASTDATE</em> is like <em class="calibre5">MAX</em>, but instead of returning a value, it returns a table. Being a table, it can be used as a parameter to other time intelligence functions. Starting from that date, the first day of the interval is computed by requesting the following day (by calling <em class="calibre5">NEXTDAY</em>) of the corresponding date one year before (by using <em class="calibre5">SAMEPERIODLASTYEAR</em>).</p>
<p class="edition">One problem with moving annual totals is that they compute the aggregated value&mdash;the sum. Dividing this value by the number of months included in the period averages it over the time frame. This gives you a moving annual average (MAA):</p>
<p class="codelink"><a href="#calibre_link-820" id="calibre_link-2427" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">MAA Sales :=
CALCULATE (
    <strong class="calibre7">DIVIDE ( [Sales Amount], DISTINCTCOUNT ( 'Date'[Year Month] ) ),</strong>
    DATESINPERIOD (
        'Date'[Date],
        MAX ( 'Date'[Date] ),
       -1,
       YEAR
    )
)</pre></div>
<p class="edition">As you have seen, using time intelligence functions results in powerful measures. In <a href="#calibre_link-821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-19</a>, you can see a report that includes the moving annual total and average calculations.</p>
<figure id="calibre_link-821" class="image-l">
<img src="images/001179.jpg" alt="The report shows Sales Amount, MAT Sales, and MAA Sales per month." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-19</strong> The <em class="calibre5">MAT Sales</em> and <em class="calibre5">MAA Sales</em> measures are simple to author by using time intelligence functions.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-152" class="calibre13"><span type="pagebreak" id="calibre_link-1959"></span>Using the right call order for nested time intelligence functions</h4>
<p class="edition">When nesting time intelligence functions, it is important to pay attention to the order used in the nesting. In the previous example, we used the following DAX expression to retrieve the first day of the moving annual total:</p>
<p class="codelink"><a href="#calibre_link-822" id="calibre_link-2428" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NEXTDAY ( SAMEPERIODLASTYEAR ( LASTDATE ( 'Date'[Date] ) ) )</pre></div>
<p class="edition">You would obtain the same behavior by inverting the call order between <em class="calibre5">NEXTDAY</em> and <em class="calibre5">SAMEPERIODLASTYEAR</em>, as in the following code:</p>
<p class="codelink"><a href="#calibre_link-823" id="calibre_link-2429" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SAMEPERIODLASTYEAR ( NEXTDAY ( LASTDATE ( 'Date'[Date] ) ) )</pre></div>
<p class="edition">The result is almost always the same, but this order of evaluation presents a risk of producing incorrect results at the end of the period. In fact, authoring the MAT code using this order would result in this version, which is wrong:</p>
<p class="codelink"><a href="#calibre_link-824" id="calibre_link-2430" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">MAT Sales Wrong :=
CALCULATE (
    [Sales Amount],
    DATESBETWEEN (
        'Date'[Date],
        SAMEPERIODLASTYEAR ( NEXTDAY ( LASTDATE ( 'Date'[Date] ) ) ),
        LASTDATE ( 'Date'[Date] )
    )
)</pre></div>
<p class="edition">This version of the formula computes the wrong result at the upper boundary of the date range. You can see this happening in a report like the one in <a href="#calibre_link-825" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-20</a>.</p>
<figure id="calibre_link-825" class="image-l">
<img src="images/001186.jpg" alt="The report shows an inaccurate result for December 31." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-20</strong> The <em class="calibre5">MAT Sales Wrong</em> measure shows an incorrect result at the end of 2009.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1960"></span>The measure computes the correct value up to December 30, 2009. Then, on December 31 the result is surprisingly high. The reason for this is that on December 31, 2009 <em class="calibre5">NEXTDAY</em> should return a table containing January 1, 2010. Unfortunately, the date table does not contain a row with January 1, 2010; thus, <em class="calibre5">NEXTDAY</em> cannot build its result. Consequently, not being able to return a valid result, <em class="calibre5">NEXTDAY</em> returns an empty table. A similar behavior happens with the following function: <em class="calibre5">SAMEPERIODLASTYEAR</em>. It receives an empty table, and as the result, it returns an empty table too. Because <em class="calibre5">DATESBETWEEN</em> requires a scalar value, the empty result of <em class="calibre5">SAMEPERIODLASTYEAR</em> is considered as a blank value. Blank&mdash;as a <em class="calibre5">DateTime</em> value&mdash;equals zero, which is December 30, 1899. Thus, on December 31, 2009, <em class="calibre5">DATESBETWEEN</em> returns the whole set of dates in the <em class="calibre5">Date</em> table; indeed, the blank as a starting date defines no boundaries for the initial date, and this results in an incorrect result.</p>
<p class="edition">The solution is straightforward. It simply involves using the correct order of evaluation. If <em class="calibre5">SAMEPERIODLASTYEAR</em> is the first function called, then on December 31, 2009, it will return a valid date, which is December 31, 2008. Then, <em class="calibre5">NEXTDAY</em> returns January 1, 2009, that this time does exist in the <em class="calibre5">Date</em> table.</p>
<p class="edition">In general, all time intelligence functions return sets of existing dates. If a date does not belong to the <em class="calibre5">Date</em> table, then these functions return an empty table that corresponds to a blank scalar value. In some scenarios this behavior might produce unexpected results, as explained in this section. For the specific example of the moving annual total, using <em class="calibre5">DATESINPERIOD</em> is simpler and safer, but this concept is important in case time intelligence functions are combined for other custom calculations.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-153" class="h2a">Understanding semi-additive calculations</h3>
<p class="edition">The techniques you have learned so far to aggregate values from different time periods work fine with regular additive measures. An additive measure is a calculation that aggregates values using a regular sum when sliced by any attribute. As an example, think about the sales amount. The sales amount of all the customers is the sum of the sales amount of each individual customer. At the same time, the sales amount of a full year is the sum of the sales amount of all the days in the year. There is nothing special about additive measures; they are intuitive and easy to use and to understand.</p>
<p class="edition">However, not all calculations are additive. Some measures are non-additive. An example would be a distinct count of the gender of the customers. For each individual customer, the result is 1. But when computed over a set of customers including different genders, the result will never be greater than the number of genders (three in case of Contoso&mdash;blank, M, and F). Thus, the result over a set of customers, dates, or any other column cannot be computed by summing individual values. Nonadditive measures are frequent in reports, oftentimes associated with distinct counts calculations. Nonadditive measures are more difficult to use and to understand than regular additive measures. However, regarding additivity, they are not the hardest ones. Indeed, there is a third kind of measure, the semi-additive measure, that proves to be challenging.</p>
<p class="edition">A semi-additive measure uses one kind of aggregation (typically a sum) when sliced by certain columns and a different kind of aggregation (usually the last date) when sliced by other columns. A great example is the balance of a bank account. The balance of all the customers is the sum of each individual balance. However, the balance over a full year is not the sum of monthly balances. Instead it <span type="pagebreak" id="calibre_link-3055"></span>is the balance on the last date of the year. Slicing the balance by customer results in a regular calculation, whereas slicing by date means the calculation follows a different path. As an example, look at the data in <a href="#calibre_link-826" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-21</a>.</p>
<figure id="calibre_link-826" class="image-l">
<img src="images/001194.jpg" alt="The figure shows the sample data used for our example. There are customer names, dates, and account balances." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-21</strong> The figure shows an excerpt of the sample data used for semi-additive calculations.</figcaption>
</figure>
<p class="edition">The sample data shows that the balance of Katie Jordan at the end of January was 1,687.00, whereas at the end of February the balance was 2,812.00. When we look at January and February together, her balance is not the sum of the two values. Instead, it is the last balance available. On the other hand, the overall balance of all customers in January is the sum of the three customers together.</p>
<p class="edition">If one uses a simple sum to aggregate values, the result of the calculation would be a sum over all the attributes as you can see in <a href="#calibre_link-827" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-22</a>.</p>
<figure id="calibre_link-827" class="image-l">
<img src="images/001202.jpg" alt="The report shows totals calculated with simple sums. Totals over time make no sense." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-22</strong> The figure shows two types of totals; totals over time for each customer and totals over all customers for different time periods.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1952"></span>As you can note, the individual month values are correct. But at the aggregated levels&mdash;both at the quarter level and at the year level&mdash;the result is still a sum, making no sense. The correct result is visible in <a href="#calibre_link-828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-23</a>, where&mdash;at each aggregate level&mdash;the report shows the last known value.</p>
<figure id="calibre_link-828" class="image-l">
<img src="images/001209.jpg" alt="The report shows the last known value at each aggregate level instead of summing all balances throughout the time period." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-23</strong> The figure shows the numbers one would expect to see.</figcaption>
</figure>
<p class="edition">The handling of semi-additive measures is a complex topic, both because of the different possible calculations and because of the need to pay attention to several details. In the next sections we describe the basic techniques to handle semi-additive calculations.</p>
<section class="calibre4">
<h4 id="calibre_link-154" class="calibre13">Using <em class="calibre5">LASTDATE</em> and <em class="calibre5">LASTNONBLANK</em></h4>
<p class="edition">DAX offers several functions to handle semi-additive calculations. However, writing the correct code to handle semi-additive calculations is not just a matter of finding the correct function to use. Many subtle details might break a calculation if the author is not paying attention. In this section, we demonstrate different versions of the same code, which will or will not work depending on the data. The purpose of showing “wrong” solutions is educational because the “right” solution depends on the data present in the data model. Also, the solution of more complex scenarios requires some step-by-step reasoning.</p>
<p class="edition">The first function we describe is <em class="calibre5">LASTDATE</em>. We used the <em class="calibre5">LASTDATE</em> function earlier, when describing how to compute the moving annual total. <em class="calibre5">LASTDATE</em> returns a table only containing one row, which <span type="pagebreak" id="calibre_link-1953"></span>represents the last date visible in the current filter context. When used as a filter argument of <em class="calibre5">CALCULATE</em>, <em class="calibre5">LASTDATE</em> overrides the filter context on the date table so that only the last day of the selected period remains visible. The following code computes the last balance by using <em class="calibre5">LASTDATE</em> to overwrite the filter context on <em class="calibre5">Date</em>:</p>
<p class="codelink"><a href="#calibre_link-829" id="calibre_link-2431" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">LastBalance :=
CALCULATE (
    SUM ( Balances[Balance] ),
    LASTDATE ( 'Date'[Date] )
)</pre></div>
<p class="edition"><em class="calibre5">LASTDATE</em> is simple to use; unfortunately, <em class="calibre5">LASTDATE</em> is not the correct solution for many semi-additive calculations. In fact, <em class="calibre5">LASTDATE</em> scans the date table always returning the last date in the date table. For example, at the month level it always returns the last day of the month, and at the quarter level it returns the last date of the quarter. If the data is not available on the specific date returned by <em class="calibre5">LASTDATE</em>, the result of the calculation is blank. You see this in <a href="#calibre_link-830" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-24</a> where the total of Q3 and the grand total are not visible. Because the total of Q3 is empty, the report does not even show Q3, resulting in a confusing result.</p>
<figure id="calibre_link-830" class="image-l">
<img src="images/001217.jpg" alt="The report only shows data for Q1 and Q2. Q3 is nowhere to be found." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-24</strong> The result, with <em class="calibre5">LASTDATE</em>, is confusing if data is not available on the last date of the month.</figcaption>
</figure>
<p class="edition">If, instead of using the month to slice data at the lowest level, we use the date, then the problem of <em class="calibre5">LASTDATE</em> becomes even more evident, as you can see in <a href="#calibre_link-831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-25</a>. The Q3 row now is visible, even though its result is still blank.</p>
<figure id="calibre_link-831" class="image-l">
<img src="images/001225.jpg" alt="The report displays blanks for Q3, for the grand total and for the last few dates." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1956"></span><strong class="calibre7">Figure 8-25</strong> Slicing by date, you can appreciate that data is available at the day level but not at the aggregate level.</figcaption>
</figure>
<p class="edition">If there are values on dates prior to the last day of the <em class="calibre5">Date</em> table, and that last day has no data available, then a better solution is to use the <em class="calibre5">LASTNONBLANK</em> function. <em class="calibre5">LASTNONBLANK</em> is an iterator that scans a table and returns the last value of the table for which the second parameter does not evaluate to <em class="calibre5">BLANK</em>. In our example, we use <em class="calibre5">LASTNONBLANK</em> to scan the <em class="calibre5">Date</em> table searching for the last date for which there are rows in the <em class="calibre5">Balances</em> table:</p>
<p class="codelink"><a href="#calibre_link-832" id="calibre_link-2432" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">LastBalanceNonBlank :=
CALCULATE (
    SUM ( Balances[Balance] ),
    <strong class="calibre7">LASTNONBLANK (</strong>
        <strong class="calibre7">'Date'[Date],</strong>
        <strong class="calibre7">COUNTROWS ( RELATEDTABLE ( Balances ) )</strong>
    <strong class="calibre7">)</strong>
)</pre></div>
<p class="edition">When used at the month level, <em class="calibre5">LASTNONBLANK</em> iterates over each date in the month, and for each date it checks whether the related table with the balances is empty. The innermost <em class="calibre5">RELATEDTABLE</em> function is executed in the row context of the <em class="calibre5">LASTNONBLANK</em> iterator, so that <em class="calibre5">RELATEDTABLE</em> only returns the balances of the given date. If there is no data, then <em class="calibre5">RELATEDTABLE</em> returns an empty table and <em class="calibre5">COUNTROWS</em> returns a blank. At the end of the iteration, <em class="calibre5">LASTNONBLANK</em> returns the last date that computed a nonblank result.</p>
<p class="edition">If all customer balances are gathered on the same date, then <em class="calibre5">LASTNONBLANK</em> solves the problem. In our example, we have different dates for different customers within the same month and this creates another issue. As we anticipated at the beginning of this section, with semi-additive calculations the devil is in the details. With our sample data <em class="calibre5">LASTNONBLANK</em> works much better than <em class="calibre5">LASTDATE</em> because it actively searches for the last date. However, it fails in computing correct totals, as you can see in <a href="#calibre_link-833" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-26</a>.</p>
<figure id="calibre_link-833" class="image-l">
<img src="images/001234.jpg" alt="The report returns inaccurate amounts for Q3 and for the year total." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3056"></span><strong class="calibre7">Figure 8-26</strong> This report is almost correct. The only unexpected results are at the year level and at the quarter level for Q3.</figcaption>
</figure>
<p class="edition">The result for each individual customer looks correct. Indeed, the last known balance for Katie Jordan is 2,531.00, which the formula correctly reports as her total. The same behavior produces correct results for Luis Bonifaz and Maurizio Macagno. Nevertheless, the grand total seems wrong. Indeed, the grand total is 1,950.00, which is the value of Maurizio Macagno only. It is confusing for a report to show a total composed in theory of three values (2,531.00, 2,205.00, 1,950.00) that only sums up the last value.</p>
<p class="edition">The reason is not hard to explain. When the filter context filters Katie Jordan, the last date with some values is July 15. When the filter context filters Maurizio Macagno, the last date becomes July 18. Nevertheless, when the filter context no longer filters the customer name, then the last date is Maurizio Macagno’s, which is July 18. Neither Katie Jordan nor Luis Bonifaz have any data on July 18. Therefore, for the month of July the formula only reports the value of Maurizio Macagno.</p>
<p class="edition">As it often happens, there is nothing wrong with the behavior of DAX. The problem is that our code is not complete yet because it does not consider the fact that different customers might have different last dates in our data model.</p>
<p class="edition">Depending on the requirements, the formula can be corrected in different ways. Indeed, one needs to define exactly what to show at the total level. Given the fact that there is some data on July 18, the idea is to either</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Consider July 18 the last date to use for all the customers, regardless of their individual last date. Therefore, the customers not reported at a certain date have a zero balance at that date.</p></li>
<li class="calibre10"><p class="listp">Consider each customer’s own last date, then aggregate the grand total using as the last date, the last date of each customer. Thus, the balance account of a customer is always the last balance available for that customer.</p></li>
</ul>
<p class="edition"><span type="pagebreak" id="calibre_link-3057"></span>Both these definitions are correct, and it all depends on the requirements of the report. Because both are interesting to learn, we demonstrate how to write the code for both. The easier of the two is considering the last date for which there is some data regardless of the customer. The correct formula only requires changing the way <em class="calibre5">LASTNONBLANK</em> computes its result:</p>
<p class="codelink"><a href="#calibre_link-834" id="calibre_link-2433" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">LastBalanceAllCustomers :=
VAR LastDateAllCustomers =
    CALCULATETABLE (
        LASTNONBLANK (
            'Date'[Date],
            COUNTROWS ( RELATEDTABLE ( Balances ) )
        ),
        ALL ( Balances[Name] )
    )
VAR Result =
    CALCULATE (
        SUM( Balances[Balance] ),
        LastDateAllCustomers
    )
RETURN
    Result</pre></div>
<p class="edition">In this code we used <em class="calibre5">CALCULATETABLE</em> to remove the filter from the customer name during the evaluation of <em class="calibre5">LASTNONBLANK</em>. In this case, at the grand total <em class="calibre5">LASTNONBLANK</em> always returns July 18 regardless of the customer in the filter context. As a result, now the grand total adds up correctly, and the end balance of Katie Jordan and Luis Bonifaz is blank, as you can see in <a href="#calibre_link-835" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-27</a>.</p>
<figure id="calibre_link-835" class="image-l">
<img src="images/001241.jpg" alt="The report shows that totals add up properly." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-27</strong> Using the last date for all the customers provides a different column total result.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3058"></span>The second option requires more complex reasoning. When using a different date for each customer, the grand total cannot be computed by simply using the filter context at the grand total. The formula needs to compute the subtotal of each customer and then aggregate the results. This is one of the scenarios where iterators are a simple and effective solution. Indeed, the following measure uses an outer <em class="calibre5">SUMX</em> to produce the total by summing the individual values of each customer:</p>
<p class="codelink"><a href="#calibre_link-836" id="calibre_link-2434" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">LastBalanceIndividualCustomer :=
SUMX (
    VALUES ( Balances[Name] ),
    CALCULATE (
        SUM ( Balances[Balance] ),
        LASTNONBLANK (
            'Date'[Date],
            COUNTROWS ( RELATEDTABLE ( Balances ) )
        )
    )
)</pre></div>
<p class="edition">The result of this latter measure computes for each customer the value on their own last date. It then aggregates the grand total by summing individual values. You see the result in <a href="#calibre_link-837" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-28</a>.</p>
<figure id="calibre_link-837" class="image-l">
<img src="images/001250.jpg" alt="Each customer subtotal falls on their respective last date." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-28</strong> The matrix now shows the subtotal of each customer on their own last date.</figcaption>
</figure>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">With a large number of customers, the <em class="calibre5">LastBalanceIndividualCustomer</em> measure might have performance issues. The reason is that the formula includes two nested iterators, and the outer iterator has a large granularity. A faster approach to this same requirement is included in <a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10</a>, “<a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with the filter context</a>,” leveraging functions like <em class="calibre5">TREATAS</em> that will be discussed in later chapters.</p>
</div>
<p class="edition"><span type="pagebreak" id="calibre_link-1954"></span>As you have learned, the complexity of semi-additive calculations is not in the code, but rather in the definition of its desired behavior. Once the behavior is clear, the choice between one pattern and the other is simple.</p>
<p class="edition">In this section we showed the most commonly used <em class="calibre5">LASTDATE</em> and <em class="calibre5">LASTNONBLANK</em> functions. There are two similar functions available to obtain the first date instead of the last date within a time period. These functions are <em class="calibre5">FIRSTDATE</em> and <em class="calibre5">FIRSTNONBLANK</em>. Moreover, there are further functions whose goal is to simplify calculations like the one demonstrated so far. We discuss them in the next section.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-155" class="calibre13">Working with opening and closing balances</h4>
<p class="edition">DAX offers many functions like <em class="calibre5">LASTDATE</em> that simplify calculations retrieving the value of a measure at the opening or closing date of a time period. Although useful, these additional functions suffer from the same limitations as <em class="calibre5">LASTDATE</em>. That is, they work well if and only if the dataset contains values for all the dates.</p>
<p class="edition">These functions are <em class="calibre5">STARTOFYEAR</em>, <em class="calibre5">STARTOFQUARTER</em>, <em class="calibre5">STARTOFMONTH</em>, and the corresponding closing functions: <em class="calibre5">ENDOFYEAR</em>, <em class="calibre5">ENDOFQUARTER</em>, <em class="calibre5">ENDOFMONTH</em>. Intuitively, <em class="calibre5">STARTOFYEAR</em> always returns January 1 of the currently selected year in the filter context. In a similar way <em class="calibre5">STARTOFQUARTER</em> and <em class="calibre5">STARTOFMONTH</em> return the beginning of the quarter or of the month, respectively.</p>
<p class="edition">As an example, we prepared a different dataset that is aimed at resolving a different scenario where semi-additive calculations are useful. The demo file contains the prices of the Microsoft stock between 2013 and 2018. The value is well known at the day level. But what should a report show at an aggregated level&mdash;for example, at the quarter level? In this case, the most commonly used value is the last value of the stock price. In other words, stock prices are another example where the semi-additive pattern becomes useful.</p>
<p class="edition">A simple implementation of the last value of a stock works well for simple reports. The following formula computes the last value of the Microsoft stock, considering an average of the prices in case there are multiple rows for the same day:</p>
<div class="program"><pre class="calibre14">Last Value :=
CALCULATE (
    AVERAGE ( MSFT[Value] ),
    LASTDATE ( 'Date'[Date] )
)</pre></div>
<p class="edition">The result is correct when used in a daily chart like <a href="#calibre_link-838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-29</a>.</p>
<figure id="calibre_link-838" class="image-l">
<img src="images/001258.jpg" alt="The report is a line chart showing the price of the Microsoft stock over four years." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1955"></span><strong class="calibre7">Figure 8-29</strong> A line chart showing the price by day looks perfectly fine.</figcaption>
</figure>
<p class="edition">However, this nice result is not due to the DAX code working well. The chart looks correct because we used the date level in the x axis, and the client tool&mdash;Power BI in this example&mdash;works hard to ignore all the empty values in our dataset. This results in a continuous line. But using the same measure in a matrix sliced by year and month would make the gaps in the calculation become much more evident. This shows in <a href="#calibre_link-839" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-30</a>.</p>
<figure id="calibre_link-839" class="image-l">
<img src="images/000000.jpg" alt="The report shows the stock price over months of different years. There are blanks." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-30</strong> The matrix showing years and months contains several blank values.</figcaption>
</figure>
<p class="edition">Using <em class="calibre5">LASTDATE</em> means you can expect empty values whenever there is no value on the exact last day of the month. That day might be either a weekend or a holiday. The correct version of <em class="calibre5">Last Value</em> is the following:</p>
<p class="codelink"><a href="#calibre_link-840" id="calibre_link-2435" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Last Value :=
CALCULATE (
    AVERAGE ( MSFT[Value] ),
    LASTNONBLANK (
        'Date'[Date],
        COUNTROWS ( RELATEDTABLE ( MSFT ) )
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1950"></span>Being mindful with these functions can prevent unexpected results. For example, imagine computing the Microsoft stock increase from the beginning of the quarter. One option, which again proves to be wrong, is the following code:</p>
<p class="codelink"><a href="#calibre_link-841" id="calibre_link-2436" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SOQ :=
CALCULATE (
    AVERAGE ( MSFT[Value] ),
    STARTOFQUARTER ( 'Date'[Date] )
)

SOQ% :=
DIVIDE (
    [Last Value] - [SOQ],
    [SOQ]
)</pre></div>
<p class="edition"><em class="calibre5">STARTOFQUARTER</em> returns the date when the current quarter started, regardless the presence of data on that specific date. For example, January 1, which is the start of the first quarter, is also New Year’s Day. Consequently, there is never a price for a stock on that date, and the previous measures produce the result visible in <a href="#calibre_link-842" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-31</a>.</p>
<figure id="calibre_link-842" class="image-l">
<img src="images/000007.jpg" alt="The report shows Last Value, SOQ, and SOQ%. There are values for SOQ and SOQ% only in Q2 and Q3." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-31</strong> <em class="calibre5">STARTOFQUARTER</em> returns a date whether it is a holiday or not.</figcaption>
</figure>
<p class="edition">You can note that there are no values for <em class="calibre5">SOQ</em> in the first quarter. Besides, the issue is present for any quarter that starts on a day for which there is no data. To compute the start or the end of a time period, <span type="pagebreak" id="calibre_link-1951"></span>only taking into account dates with data available, the functions to use are <em class="calibre5">FIRSTNONBLANK</em> and <em class="calibre5">LASTNONBLANK</em> mixed with other time intelligence functions like, for example, <em class="calibre5">DATESINPERIOD</em>.</p>
<p class="edition">A much better implementation of the <em class="calibre5">SOQ</em> calculation is the following:</p>
<p class="codelink"><a href="#calibre_link-843" id="calibre_link-2437" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SOQ :=
VAR FirstDateInQuarter =
    CALCULATETABLE (
        FIRSTNONBLANK (
            'Date'[Date],
            COUNTROWS ( RELATEDTABLE( MSFT ) )
        ),
        PARALLELPERIOD ( 'Date'[Date], 0, QUARTER )
    )
VAR Result =
    CALCULATE (
        AVERAGE ( MSFT[Value] ),
        FirstDateInQuarter
    )
RETURN
    Result</pre></div>
<p class="edition">This latter version is much more complex both to author and to understand. However, it works in any scenario by only considering dates with data available. You can see the result of the matrix with the new implementation of <em class="calibre5">SOQ</em> in <a href="#calibre_link-844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-32</a>.</p>
<figure id="calibre_link-844" class="image-l">
<img src="images/000014.jpg" alt="The report shows accurate numbers across all four quarters." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-32</strong> The new version of <em class="calibre5">SOQ</em> reports correct numbers regardless of weekends and holidays.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1961"></span>At the risk of seeming pedantic, it is worth repeating the same concept used when introducing the topic of semi-additive measures. The devil is in the details. DAX offers several functions that work for models with data for all the dates. Unfortunately, not all models contain data for all the dates. In those latter scenarios, it is always extremely important to consider all the possible implications of using these simple functions. One should consider time intelligence functions as building blocks for more complex calculations. Combining different time intelligence functions enables the accurate computing of different time periods, although there is no predefined function solving the problem in a single step.</p>
<p class="edition">This is why instead of just showing you a smooth example for each time intelligence function, we preferred walking them through different trial-and-error scenarios. The goal of this section&mdash;and of the whole book&mdash;is not to just show you how to use functions. The goal is to empower you to think in DAX, to identify which details you should take care of, and to build your own calculations whenever the basic functionalities of the language are not enough for your needs.</p>
<p class="edition">In the next section we move one step forward in that same direction, by showing how most time intelligence calculations can be computed without the aid of any time intelligence functions. The goal is not purely educational. When working with custom calendars, such as weekly calendars, time intelligence functions are not useful. You need to be prepared to author some complex DAX code to obtain the desired result.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-156" class="h2a">Understanding advanced time intelligence calculations</h3>
<p class="edition">This section describes many important details about time intelligence functions. To showcase these details, we write time intelligence calculations by using simpler DAX functions such as <em class="calibre5">FILTER</em>, <em class="calibre5">ALL</em>, <em class="calibre5">VALUES</em>, <em class="calibre5">MIN</em>, and <em class="calibre5">MAX</em>. The goal of this section is not to suggest you avoid standard time intelligence functions in favor of simpler functions. Instead, the goal is to help you understand the exact behavior of time intelligence functions even in particular side cases. This knowledge enables you to then write custom calculations whenever the available functions do not provide the exact calculation you need. You will also notice that the translation to simpler DAX sometimes requires more code than expected because of certain hidden functionalities in time intelligence calculations.</p>
<p class="edition">Your reason for rewriting a time intelligence calculation in DAX could be that you are dealing with a nonstandard calendar, where the first day of the year is not always the same for all the years. This is the case, for example, for ISO calendars based on weeks. Here the assumption made by the time intelligence function that year, month, and quarter can always be extracted from the date value is no longer true. You can write a different logic by changing the DAX code in the filter conditions; or you can simply take advantage of other columns in the date table, so you do not have a complex DAX expression to maintain. You will find more examples of this latter approach under “<a href="#calibre_link-161" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with custom calendars</a>” later in this chapter.</p>
<section class="calibre4">
<h4 id="calibre_link-157" class="calibre13"><span type="pagebreak" id="calibre_link-1831"></span>Understanding periods to date</h4>
<p class="edition">Earlier, we described the DAX functions that calculate month-to-date, quarter-to-date, and year-to-date: they are <em class="calibre5">DATESMTD</em>, <em class="calibre5">DATESQTD</em>, and <em class="calibre5">DATESYTD</em>. Each of these filter functions is like the result of a <em class="calibre5">FILTER</em> statement that can be written in DAX. For example, consider the following <em class="calibre5">DATESYTD</em> function:</p>
<div class="program"><pre class="calibre14">DATESYTD ( 'Date'[Date] )</pre></div>
<p class="edition">It corresponds to a filter over the date column using <em class="calibre5">FILTER</em> called by <em class="calibre5">CALCULATETABLE</em>, as in the following code:</p>
<p class="codelink"><a href="#calibre_link-845" id="calibre_link-2438" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATETABLE (
    VAR LastDateInSelection = MAX ( 'Date'[Date] )
    RETURN
        FILTER (
            ALL ( 'Date'[Date] ),
            'Date'[Date] &lt;= LastDateInSelection
                &amp;&amp; YEAR ( 'Date'[Date] ) = YEAR ( LastDateInSelection )
        )
)</pre></div>
<p class="edition">In a similar way, the <em class="calibre5">DATESMTD</em> function:</p>
<div class="program"><pre class="calibre14">DATESMTD ( 'Date'[Date] )</pre></div>
<p class="edition">corresponds to the following code:</p>
<p class="codelink"><a href="#calibre_link-846" id="calibre_link-2439" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATETABLE (
    VAR LastDateInSelection = MAX ( 'Date'[Date] )
    RETURN
        FILTER (
            ALL ( 'Date'[Date] ),
            'Date'[Date] &lt;= LastDateInSelection
                &amp;&amp; YEAR ( 'Date'[Date] ) = YEAR ( LastDateInSelection )
                &amp;&amp; <strong class="calibre7">MONTH ( 'Date'[Date] ) = MONTH ( LastDateInSelection )</strong>
        )
)</pre></div>
<p class="edition">The <em class="calibre5">DATESQTD</em> function follows the same pattern. All these alternative implementations have a common characteristic: They extract the information about year, month, and quarter from the last day available in the current selection. Then, they use this date to create a suitable filter.</p>
<div class="sidebar">
<p class="edition"><span type="pagebreak" id="calibre_link-1832"></span>Context transition in time intelligence functions</p>
<p class="edition">You might have noticed that in the previous expressions we always use an outer <em class="calibre5">CALCULATETABLE</em> surrounding the whole code. The reason for the presence of <em class="calibre5">CALCULATETABLE</em> is to perform a context transition, which is required when a date column is specified as a column reference. Previously in this chapter you saw that a column reference in the first argument of a time intelligence function is translated into a table obtained by calling <em class="calibre5">CALCULATETABLE</em> and <em class="calibre5">DISTINCT</em>:</p>
<p class="codelink"><a href="#calibre_link-847" id="calibre_link-2440" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DATESYTD ( 'Date'[Date] )

-- corresponds to

DATESYTD ( <strong class="calibre7">CALCULATETABLE ( DISTINCT (</strong> 'Date'[Date] ) ) )</pre></div>
<p class="edition">Thus, the context transition only takes place to translate the column reference into a table. It does not happen when a table is used as an argument of a time intelligence function instead of a date column reference. A more accurate translation of <em class="calibre5">DATESYTD</em> is the following:</p>
<p class="codelink"><a href="#calibre_link-848" id="calibre_link-2441" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DATESYTD ( 'Date'[Date] )

-- corresponds to

VAR LastDateInSelection =
    MAXX ( <strong class="calibre7">CALCULATETABLE ( DISTINCT (</strong> 'Date'[Date] ) ), [Date] )
RETURN
    FILTER (
        ALL ( 'Date'[Date] ),
        'Date'[Date] &lt;= LastDateInSelection
            &amp;&amp; YEAR ( 'Date'[Date] ) = YEAR ( LastDateInSelection )
    )</pre></div>
<p class="edition">The context transition does not happen when the argument of a time intelligence function is a table.</p>
</div>
<p class="edition">The <em class="calibre5">CALCULATETABLE</em> generated for the column reference used in time intelligence functions is important when you have a row context. Look at the following two calculated columns, both created in the <em class="calibre5">Date</em> table:</p>
<p class="codelink"><a href="#calibre_link-849" id="calibre_link-2442" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Date'[CountDatesYTD] = COUNTROWS ( DATESYTD ( 'Date'[Date] ) )

'Date'[CountFilter] =
COUNTROWS (
    VAR LastDateInSelection =
        MAX ( 'Date'[Date] )
    RETURN
        FILTER (
            ALL ( 'Date'[Date] ),
            'Date'[Date] &lt;= LastDateInSelection
                &amp;&amp; YEAR ( 'Date'[Date] ) = YEAR ( LastDateInSelection )
        )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1833"></span>Though they look similar, they are not. Indeed, you can see the result in <a href="#calibre_link-850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-33</a>.</p>
<figure id="calibre_link-850" class="image-l">
<img src="images/000021.jpg" alt="The report shows the CountDatesYTD and CountFilter measures for each date. The former returns counts from 1; the latter always returns 365." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-33</strong> <em class="calibre5">CountFilter</em> does not perform context transition, whereas <em class="calibre5">CountDatesYTD</em> does.</figcaption>
</figure>
<p class="edition"><em class="calibre5">CountDatesYTD</em> returns the number of days from the beginning of the year, up to the date in the current row. To achieve this result, <em class="calibre5">DATESYTD</em> should inspect the current filter context and extract the selected period from the filter context. However, being computed in a calculated column, there is no filter context. The behavior of <em class="calibre5">CountFilter</em> is simpler to explain: When <em class="calibre5">CountFilter</em> computes the maximum date, it always retrieves the last date of the entire date table because there are no filters in the filter context. <em class="calibre5">CountDatesYTD</em> behaves differently because <em class="calibre5">DATESYTD</em> performs a context transition being called with a date column reference. Thus, it creates a filter context that only contains the currently iterated date.</p>
<p class="edition">If you rewrite <em class="calibre5">DATESYTD</em> and you know that the code will not be executed inside a row context, you can remove the outer <em class="calibre5">CALCULATETABLE</em>, which would otherwise be a useless operation. This is usually the case for a filter argument in a <em class="calibre5">CALCULATE</em> call not called within an iterator&mdash;a place where <em class="calibre5">DATESYTD</em> is often used. In these cases, instead of <em class="calibre5">DATESYTD</em>, you can write:</p>
<p class="codelink"><a href="#calibre_link-851" id="calibre_link-2443" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">VAR LastDateInSelection = MAX ( 'Date'[Date] )</strong>
RETURN
    FILTER (
        ALL ( 'Date'[Date] ),
        'Date'[Date] &lt;= LastDateInSelection
            &amp;&amp; YEAR ( 'Date'[Date] ) = YEAR ( LastDateInSelection )
    )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1945"></span>On the other hand, to retrieve the date from the row context&mdash;for example, in a calculated column&mdash;it is easier to retrieve the date value of the current row in a variable instead of using <em class="calibre5">MAX</em>:</p>
<p class="codelink"><a href="#calibre_link-852" id="calibre_link-2444" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">VAR CurrentDate = 'Date'[Date]</strong>
RETURN
    FILTER (
        ALL ( 'Date'[Date] ),
        'Date'[Date] &lt;= CurrentDate
            &amp;&amp; YEAR ( 'Date'[Date] ) = YEAR ( CurrentDate )
    )</pre></div>
<p class="edition"><em class="calibre5">DATESYTD</em> allows the specifying of a year-end date, which is useful to compute YTD on fiscal years. For example, for a fiscal year starting on July 1, June 30 needs to be specified in the second argument by using one of the following versions:</p>
<p class="codelink"><a href="#calibre_link-853" id="calibre_link-2445" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DATESYTD ( 'Date'[Date], "06-30" )
DATESYTD ( 'Date'[Date], "30-06" )</pre></div>
<p class="edition">Regardless of the local culture, let us assume that the programmer has specified the <em class="calibre5">&lt;month&gt;</em> and <em class="calibre5">&lt;day&gt;</em>. The corresponding <em class="calibre5">FILTER</em> of <em class="calibre5">DATESYTD</em> using these placeholders is the following:</p>
<p class="codelink"><a href="#calibre_link-854" id="calibre_link-2446" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">VAR LastDateInSelection = MAX ( 'Date'[Date] )
RETURN
    FILTER (
        ALL ( 'Date'[Date] ),
        'Date'[Date] &gt; DATE ( YEAR ( LastDateInSelection ) - 1, &lt;month&gt;, &lt;day&gt; )
            &amp;&amp; 'Date'[Date] &lt;= LastDateInSelection
    )</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">It is important to note that <em class="calibre5">DATESYTD</em> always starts from the day after the specified end of the fiscal year. This causes a problem in the special case where a company has a fiscal year starting on March 1. In fact, the end of the fiscal year can be either February 28 or 29, depending on whether the calculation is happening in a leap year or not. As of April 2019, this special scenario is not supported by <em class="calibre5">DATESYTD</em>. Thus, if one needs to author code and they have to start the fiscal calendar on March 1, then <em class="calibre5">DATESYTD</em> cannot be used. A workaround is available at <a href="http://sql.bi/fymarch" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://sql.bi/fymarch</a>.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-158" class="calibre13">Understanding <em class="calibre5">DATEADD</em></h4>
<p class="edition"><em class="calibre5">DATEADD</em> retrieves a set of dates shifted in time by a certain offset. When <em class="calibre5">DATEADD</em> analyzes the current filter context, it includes special handling to detect whether the current selection is one month or a special period, like the beginning or the end of a month. For example, when <em class="calibre5">DATEADD</em> retrieves an entire month shifted back one quarter, it oftentimes returns a different number of days than the current selection. This happens because <em class="calibre5">DATEADD</em> understands that the current selection is a month, and it retrieves a full corresponding month regardless of the number of days.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3059"></span>These special behaviors are expressed in three rules that we describe in this section. These rules make it hard to rewrite <em class="calibre5">DATEADD</em> on a generic date table. The code would be painfully difficult to write and nearly impossible to manage over time. <em class="calibre5">DATEADD</em> only uses the values of the date column, extracting the information needed&mdash;such as year, quarter, and month&mdash;from the available date value. The same logic would be hard to reproduce in plain DAX. On the other hand, by using additional columns in the <em class="calibre5">Date</em> table, one can author an alternative version of <em class="calibre5">DATEADD</em>. We will elaborate on this technique later in this chapter, in the section about custom calendars.</p>
<p class="edition">Consider the following formula:</p>
<p class="codelink"><a href="#calibre_link-855" id="calibre_link-2447" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DATEADD ( 'Date'[Date], -1, MONTH )</pre></div>
<p class="edition">The closest&mdash;but not totally equivalent&mdash;DAX formula is the following:</p>
<p class="codelink"><a href="#calibre_link-856" id="calibre_link-2448" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">VAR OffsetMonth = -1
RETURN TREATAS (
    SELECTCOLUMNS (
        CALCULATETABLE ( DISTINCT ( 'Date'[Date] ) ),
        "Date", DATE (
            YEAR ( 'Date'[Date] ),
            MONTH ( 'Date'[Date] ) + OffsetMonth,
            DAY ( 'Date'[Date] )
        )
    ),
    'Date'[Date]
)</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">In the previous example and in other formulas in this chapter, we use the <em class="calibre5">TREATAS</em> function, which applies a table expression to the filter context on the columns specified by the second and following arguments. You can read a more complete description of this function in <a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10</a>.</p>
</div>
<p class="edition">The formula also works in January because a value lower than 1 for the month parameter is considered an offset to go into a previous year. However, this implementation only works properly if the destination month has the same number of days as the current month. If you move from February to January, the formula misses two or three days, depending on the year. In a similar way, if you move from March to February, the result might include days in March.</p>
<p class="edition">On the other hand, <em class="calibre5">DATEADD</em> does not have a similar problem and returns the entire month with the offset applied, in case an entire month was selected before the offset was applied. In order to achieve this, <em class="calibre5">DATEADD</em> uses three rules:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp"><em class="calibre5">DATEADD</em> only returns days that exist in the date column. If some expected dates are missing, then <em class="calibre5">DATEADD</em> returns only those dates that are not missing in the date column.</p></li>
<li class="calibre25"><p class="listp">If a day does not exist in the corresponding month after the shifting operation, then the result of <em class="calibre5">DATEADD</em> includes the last day of the corresponding month.</p></li>
<li class="calibre25"><p class="listp"><span type="pagebreak" id="calibre_link-3060"></span>If the selection includes the last two days of a month, then the result of <em class="calibre5">DATEADD</em> includes all the days between the corresponding days in the shifted month and the end of the shifted month.</p></li>
</ol>
<p class="edition">A few examples are helpful to understand the effects of these behaviors. Consider the following measures: <em class="calibre5">Day count</em> counts the number of selected days; <em class="calibre5">PM Day count</em> counts the number of days shifted back in the previous month; <em class="calibre5">PM Range</em> returns the date range selected by <em class="calibre5">DATEADD</em>.</p>
<p class="codelink"><a href="#calibre_link-857" id="calibre_link-2449" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Day count :=
COUNTROWS ( 'Date' )

PM Day count :=
CALCULATE ( [Day count], DATEADD ( 'Date'[Date], -1, MONTH ) )

PM Range :=
CALCULATE (
    VAR MinDate = MIN ( 'Date'[Date] )
    VAR MaxDate = MAX ( 'Date'[Date] )
    VAR Result =
        FORMAT ( MinDate, "MM/DD/YYYY - " ) &amp; FORMAT ( MaxDate, "MM/DD/YYYY" )
    RETURN
        Result,
    DATEADD ( 'Date'[Date], -1, MONTH )
)</pre></div>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Rule 1</strong> is in effect when the selection is near the boundaries of the range of dates included in the date column. For example, <a href="#calibre_link-858" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-34</a> shows the <em class="calibre5">PM Day count</em> and <em class="calibre5">PM Range</em> measures returning valid values in February 2007 because dates in January 2007 exist in the date column, whereas the same measures return blanks in January 2007 because dates in December 2006 are not present in the date column.</p>
<figure id="calibre_link-858" class="image-l">
<img src="images/000029.jpg" alt="The report shows dates being shifted back one month." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-34</strong> The dates selected are shifted back one month.</figcaption>
</figure>
<p class="listp"><span type="pagebreak" id="calibre_link-3061"></span>The main reason why the <em class="calibre5">Date</em> table should include all the days within one year is because of the behavior <em class="calibre5">of DATEADD</em>. Be mindful that several time intelligence functions in DAX internally use <em class="calibre5">DATEADD</em>. Therefore, having a complete date table is of paramount importance for DAX time intelligence functions to behave as expected.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Rule 2</strong> is relevant because months have different numbers of days. The 31<sup class="calibre26">st</sup> day does not exist for all months. If it is selected, it is moved to the last day of the month in the shifted period. For example, in <a href="#calibre_link-859" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-35</a> the last days of March are all moved to the last day of February because February 29 to 31 do not exist in 2007.</p>
<figure id="calibre_link-859" class="image-l">
<img src="images/000036.jpg" alt="The last four days of March are moved to February 28." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-35</strong> A date that does not exist in the destination month is replaced by the last day of the destination month.</figcaption>
</figure>
<p class="listp">The consequence of this rule is that you might obtain a lower number of days than the initial selection. This is intuitive when the selection of 31 days in March should result in a corresponding selection of 28 or 29 days in February. However, when the selection includes a reduced number of days, the result might not be what is expected. For example, in <a href="#calibre_link-860" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-36</a> you can see that a selection of 5 days in March 2007 results in only 2 days in February 2007.</p>
<figure id="calibre_link-860" class="image-l">
<img src="images/000043.jpg" alt="In the report, the March 27 to 31 range results in February 27 followed by four occurrences of February 28." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-36</strong> Several days in the starting selection might result in the same day in the <em class="calibre5">DATEADD</em> result.</figcaption>
</figure>
</li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-3062"></span><strong class="calibre7">Rule 3</strong> generates a special handling type when the last day of a month is included within a range of dates. For example, consider the initial selection of three days from June 29, 2007, to July 1, 2007. The selection only includes three days, but among those is the last day of June, which is June 30. When <em class="calibre5">DATEADD</em> shifts the dates back, it includes the last day of May (May 31). <a href="#calibre_link-861" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-37</a> shows this behavior and it is worth a deeper look. Indeed, you can note that June 30 is moved to May 30. Only if the selection contains both June 29 and 30 does the result then include the last day of the previous month (May 31). In this case, the number of days in the previous month is greater than the number of days originally selected: 2 days selected in June 2017 return 3 days in the previous month (May 2007).</p>
<figure id="calibre_link-861" class="image-l">
<img src="images/000050.jpg" alt="In the report, for the month of June we see that May 31 was included in the range." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-37</strong> The result of <em class="calibre5">DATEADD</em> includes all days between the first and the last day of the selection after the shift operation.</figcaption>
</figure></li>
</ul>
<p class="edition">The reason for these rules is to provide an intuitive behavior when a formula operates at the month level. As you can see in <a href="#calibre_link-862" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-38</a>, when you compare the selections at the month level, the result is intuitive and expected. It shows the complete range of days of the previous month.</p>
<figure id="calibre_link-862" class="image-l">
<img src="images/000057.jpg" alt="The PM Day Count measure works well, returning for each month the number of days in the month prior." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-38</strong> The <em class="calibre5">PM Day count measure</em> shows the number of days in the previous month.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3063"></span>Understanding the rules described in this section is important to handle side conditions that might happen with partial selections of days in months. For example, consider a filter over weekdays in a report. That filter might not include the last days of a month, which would guarantee that the entire previous month is selected. Moreover, the shift of dates performed by <em class="calibre5">DATEADD</em> only considers the number of days within the month and not the week days. The application of a filter to the date column of the <em class="calibre5">Date</em> table also generates an implicit <em class="calibre5">ALL</em> over the <em class="calibre5">Date</em> table itself, removing any existing filter over other columns of the <em class="calibre5">Date</em> table including weekdays. Thus, a slicer that filters weekdays is not compatible with the use of <em class="calibre5">DATEADD</em> because it does not produce the expected result.</p>
<p class="edition">For example, consider the following definition of <em class="calibre5">PM Sales DateAdd</em> displaying the <em class="calibre5">Sales Amount</em> of the previous month, as shown in <a href="#calibre_link-863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-39</a>:</p>
<p class="codelink"><a href="#calibre_link-864" id="calibre_link-2450" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PM Sales DateAdd :=
CALCULATE (
    [Sales Amount],
    DATEADD ( 'Date'[Date], -1, MONTH )
)</pre></div>
<figure id="calibre_link-863" class="image-l">
<img src="images/000065.jpg" alt="Unexpectedly, PM Sales DateAdd does not return the sales amount of the prior month." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-39</strong> The <em class="calibre5">PM Sales DateAdd</em> measure does not correspond to <em class="calibre5">Sales Amount</em> of the previous month.</figcaption>
</figure>
<p class="edition"><em class="calibre5">PM Sales DateAdd</em> creates a filter of days that does not correspond to the full month. It translates the days of the month selected, including additional days at the end of the month according to Rule 3. This filter overrides and ignores the <em class="calibre5">Day of Week</em> selection for the value of the previous month. The result produces different values, even bigger than <em class="calibre5">Sales Amount</em> as in March and May 2007, for example.</p>
<p class="edition">In this case, computing correctly requires a custom calculation like the one implemented in the <em class="calibre5">PM Sales Weekday</em> measure. It applies a filter over the <em class="calibre5">YearMonthNumber</em> column keeping the filter on <em class="calibre5">Day of Week</em>, and removing the filter from all the other columns of the <em class="calibre5">Date</em> table using <em class="calibre5">ALLEXCEPT</em>. The <em class="calibre5">YearMonthNumber</em> calculated column is a sequential number over months and years:</p>
<p class="codelink"><a href="#calibre_link-865" id="calibre_link-2451" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-2052"></span>Date[YearMonthNumber] =
'Date'[Year] * 12 + 'Date'[Month Number] - 1

PM Sales Weekday :=
VAR CurrentMonths = DISTINCT ( 'Date'[YearMonthNumber] )
VAR PreviousMonths =
    TREATAS (
        SELECTCOLUMNS (
            CurrentMonths,
            "YearMonthNumber", 'Date'[YearMonthNumber] - 1
        ),
        'Date'[YearMonthNumber]
    )
VAR Result =
    CALCULATE (
        [Sales Amount],
        ALLEXCEPT ( 'Date', 'Date'[Week Day] ),
        PreviousMonths
    )
RETURN
    Result</pre></div>
<p class="edition">The result is visible in <a href="#calibre_link-866" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-40</a>.</p>
<figure id="calibre_link-866" class="image-l">
<img src="images/000073.jpg" alt="PM Sales Weekday returns the sales amount of the previous month, for each month." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-40</strong> The <em class="calibre5">PM Sales Weekday</em> measure corresponds to <em class="calibre5">Sales Amount</em> of the previous month.</figcaption>
</figure>
<p class="edition">However, this solution works specifically for this report. If the selection of days were made based on other criteria like the first 6 days of the month, then the result produced by <em class="calibre5">PM Sales Weekday</em> <span type="pagebreak" id="calibre_link-1946"></span>would get the entire month, whereas the result produced by <em class="calibre5">PM Sales DateAdd</em> would work in this case. Depending on the columns visible to the user, one might implement different calculations based on the selection made. For example, the following <em class="calibre5">PM Sales</em> measure uses the <em class="calibre5">ISFILTERED</em> function to check whether a filter is active on the <em class="calibre5">Day of Week</em> column. A more detailed explanation of <em class="calibre5">ISFILTERED</em> is included in <a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10</a>.</p>
<p class="codelink"><a href="#calibre_link-867" id="calibre_link-2452" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PM Sales :=
IF (
    ISFILTERED ( 'Date'[Day of Week] ),
    [PM Sales Weekday],
    [PM Sales DateAdd]
)</pre></div>
</section>
<section class="calibre4">
<h4 id="calibre_link-159" class="calibre13">Understanding <em class="calibre5">FIRSTDATE, LASTDATE, FIRSTNONBLANK</em>, and <em class="calibre5">LASTNONBLANK</em></h4>
<p class="edition">In the “<a href="#calibre_link-153" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding semi-additive calculations</a>” section earlier in this chapter, you learned two functions that seem alike: <em class="calibre5">LASTDATE</em> and <em class="calibre5">LASTNONBLANK</em>. In fact, these functions exhibit distinctive behaviors, and so do the two companions <em class="calibre5">FIRSTDATE</em> and <em class="calibre5">FIRSTNONBLANK</em>.</p>
<p class="edition"><em class="calibre5">FIRSTDATE</em> and <em class="calibre5">LASTDATE</em> only operate on a date column. They return, respectively, the first and the last date in the active filter context, ignoring any data existing in other related tables:</p>
<div class="program"><pre class="calibre14">FIRSTDATE ( 'Date'[Date] )
LASTDATE ( 'Date'[Date] )</pre></div>
<p class="edition"><em class="calibre5">FIRSTDATE</em> returns the minimum value of the column received in the current filter context, whereas <em class="calibre5">LASTDATE</em> returns the maximum value. <em class="calibre5">FIRSTDATE</em> and <em class="calibre5">LASTDATE</em> behave somewhat like <em class="calibre5">MIN</em> and <em class="calibre5">MAX</em>, with one important difference: <em class="calibre5">FIRSTDATE</em> and <em class="calibre5">LASTDATE</em> return a table and perform a context transition, whereas <em class="calibre5">MIN</em> and <em class="calibre5">MAX</em> return a scalar value without doing any context transition.</p>
<p class="edition">For example, consider the following expression:</p>
<p class="codelink"><a href="#calibre_link-868" id="calibre_link-2453" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    SUM ( Inventory[Quantity] ),
    LASTDATE ( 'Date'[Date] )
)</pre></div>
<p class="edition">You can rewrite the formula using <em class="calibre5">MAX</em> instead of <em class="calibre5">LASTDATE</em>, but this would result in unnecessary longer code:</p>
<p class="codelink"><a href="#calibre_link-869" id="calibre_link-2454" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    SUM ( Inventory[Quantity] ),
    FILTER (
        ALL ( 'Date'[Date] ),
        'Date'[Date] = MAX ( 'Date'[Date] )
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1949"></span>Besides, <em class="calibre5">LASTDATE</em> also performs a context transition. Consequently, the exact equivalent of <em class="calibre5">LASTDATE</em> in plain DAX is as follows:</p>
<p class="codelink"><a href="#calibre_link-870" id="calibre_link-2455" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    SUM ( Inventory[Quantity] ),
    VAR LastDateInSelection =
        MAXX ( CALCULATETABLE ( DISTINCT ( 'Date'[Date] ) ), 'Date'[Date] )
    RETURN
        FILTER (
            ALL ( 'Date'[Date] ),
            'Date'[Date] = LastDateInSelection
        )
)</pre></div>
<p class="edition">The context transition is relevant when you execute <em class="calibre5">FIRSTDATE/LASTDATE</em> in a row context. The best practice is to use <em class="calibre5">FIRSTDATE/LASTDATE</em> when you write a filter expression because a table expression is expected, whereas <em class="calibre5">MIN/MAX</em> functions are better when you are writing a logical expression in a row context that usually requires a scalar value. Indeed, <em class="calibre5">LASTDATE</em> with a column reference implies a context transition that hides the external filter context.</p>
<p class="edition">For example, you will favor <em class="calibre5">FIRSTDATE/LASTDATE</em> over <em class="calibre5">MIN/MAX</em> in a filter argument of <em class="calibre5">CALCULATE/CALCULATETABLE</em> functions because the syntax is simpler. However, you should use <em class="calibre5">MIN/MAX</em> when the context transition implied by <em class="calibre5">FIRSTDATE/LASTDATE</em> would modify the result. This is the case of the condition in a <em class="calibre5">FILTER</em> function. The following expression filters the dates for computing a running total:</p>
<p class="codelink"><a href="#calibre_link-871" id="calibre_link-2456" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">FILTER (
    ALL ( 'Date'[Date] ),
    'Date'[Date] &lt;= MAX ( 'Date'[Date] )
)</pre></div>
<p class="edition"><em class="calibre5">MAX</em> is the right function to use. In fact, the result of using <em class="calibre5">LASTDATE</em> instead of <em class="calibre5">MAX</em> would always contain all the dates, regardless of the current selection because of the unwanted context transition. Thus, the following expression returns all dates, no matter what. The reason is that <em class="calibre5">LASTDATE</em>&mdash;because of context transition&mdash;returns the value of <em class="calibre5">Date[Date]</em> in each row of the <em class="calibre5">FILTER</em> iteration:</p>
<p class="codelink"><a href="#calibre_link-872" id="calibre_link-2457" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">FILTER (
    ALL ( 'Date'[Date] ),
    'Date'[Date] &lt;= LASTDATE ( 'Date'[Date] ) -- this condition is always true
)</pre></div>
<p class="edition"><em class="calibre5">LASTNONBLANK</em> and <em class="calibre5">FIRSTNONBLANK</em> are different from <em class="calibre5">FIRSTDATE</em> and <em class="calibre5">LASTDATE</em>. In fact, <em class="calibre5">LASTNONBLANK</em> and <em class="calibre5">FIRSTNONBLANK</em> are iterators, meaning that they scan a table row by row in a row context and that they return the last (or first) of the values for which the second parameter is not a blank. Usually, the second parameter of these functions is either a measure or an expression including <em class="calibre5">CALCULATE</em>, so to rely on context transition.</p>
<p class="edition">To obtain the right value for the last non-blank date for a given measure/table, you use an expression like this:</p>
<p class="codelink"><a href="#calibre_link-873" id="calibre_link-2458" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">LASTNONBLANK ( 'Date'[Date], CALCULATE ( COUNTROWS ( Inventory ) ) )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1948"></span>It returns the last date (in the current filter context) for which there are rows in the <em class="calibre5">Inventory</em> table. You can also use an equivalent formula:</p>
<p class="codelink"><a href="#calibre_link-874" id="calibre_link-2459" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">LASTNONBLANK ( 'Date'[Date], COUNTROWS ( RELATEDTABLE ( Inventory ) ) )</pre></div>
<p class="edition">That last expression returns the last date (in the current filter context) for which there is a related row in the <em class="calibre5">Inventory</em> table.</p>
<p class="edition">It is worth noting that <em class="calibre5">FIRSTNONBLANK/LASTNONBLANK</em> functions accept any data type as their first argument, whereas the <em class="calibre5">FIRSTDATE/LASTDATE</em> functions require a column of <em class="calibre5">DateTime</em> or <em class="calibre5">Date</em> data type. Thus, and though it is not a commonly used practice, <em class="calibre5">FIRSTNONBLANK</em> and <em class="calibre5">LASTNONBLANK</em> can also be used with different tables like customers, products, or any other table.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-160" class="calibre13">Using drillthrough with time intelligence</h4>
<p class="edition">A <em class="calibre5">drillthrough</em> operation is a request for the data source rows corresponding to the filter context used in a certain calculation. Every time you use a time intelligence function, you change the filter context on the <em class="calibre5">Date</em> table. This produces a different result for the measure from the result obtained with the initial filter context. When you use a client that performs a drillthrough action over a report, such as a pivot table in Excel, you could observe a behavior that is not what you might expect. In fact, the drillthrough operation made in MDX does not consider the changes in the filter context defined by the measure itself. Instead, it only considers the filter context defined by the rows, columns, filters, and slicers of the pivot table.</p>
<p class="edition">For example, by default the drillthrough on March 2007 always returns the same rows, regardless of the time intelligence function applied in the measure. By using <em class="calibre5">TOTALYTD</em>, one would expect all the days from January to March 2007; by using <em class="calibre5">SAMEPERIODLASTYEAR</em>, one would expect March 2006; and by using <em class="calibre5">LASTDATE</em>, one would only expect the rows for March 31, 2007. Indeed, in the default drillthrough any of these filters always returns all the rows for March 2007. This behavior can be controlled by the <em class="calibre5">Detail Rows</em> property in the Tabular model. At the time of writing (April 2019), the <em class="calibre5">Detail Rows</em> property can be set in an Analysis Services 2017 or Azure Analysis Services data model, but it is not available either in Power BI or in Power Pivot for Excel.</p>
<p class="edition">The <em class="calibre5">Detail Rows</em> property must apply the same filter used for the corresponding time intelligence measure. For example, consider the following year-to-date measure:</p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    DATESYTD ( 'Date'[Date] )
)</pre></div>
<p class="edition">Its <em class="calibre5">Detail Rows</em> property should be set to</p>
<p class="codelink"><a href="#calibre_link-875" id="calibre_link-2460" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATETABLE (
    Sales,                       -- This expression also controls the columns returned
    DATESYTD ( 'Date'[Date] )
)</pre></div>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-161" class="h2a"><span type="pagebreak" id="calibre_link-1853"></span>Working with custom calendars</h3>
<p class="edition">As you have seen so far, the standard time intelligence functions in DAX only support standard Gregorian calendars. These are based on a solar calendar divided into 12 months, each one with a different number of days. These functions work well to analyze data by year, quarter, month, and day. However, there are models that have a different definition of time periods, like week-based calendars such as the ISO week date system. If someone needs a custom calendar, they need to rewrite the time intelligence logic in DAX because the standard time intelligence calculation would be of no use.</p>
<p class="edition">When it comes to nonstandard calendars, there are so many variations that it would be impossible to cover them all. Therefore, we show examples of how to implement time intelligence calculations in DAX when you cannot use standard functions.</p>
<p class="edition">In order to simplify the formulas, a common technique is to move part of the business logic in the date table through the use of dedicated columns. The standard DAX time intelligence functions do not use any information from the date table other than the date column. This is a design choice of DAX because this way the behavior of the language does not depend on the presence of additional metadata to identify columns to determine year, quarter, and month of a date&mdash;as was the case with MDX and Analysis Services Multidimensional. Being the owner of your model and of your DAX code, you can make more assumptions, and this helps in simplifying the code to handle custom time-related calculations.</p>
<p class="edition">This final section shows a few examples of the formulas for custom calendars. If needed, you can find more information, examples, and ready-to-use DAX formulas in the following articles:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Time Patterns: <a href="http://www.daxpatterns.com/time-patterns/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://www.daxpatterns.com/time-patterns/</a></p></li>
<li class="calibre10"><p class="listp">Week-Based Time Intelligence in DAX: <a href="http://sql.bi/isoweeks/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://sql.bi/isoweeks/</a></p></li>
</ul>
<section class="calibre4">
<h4 id="calibre_link-162" class="calibre13">Working with weeks</h4>
<p class="edition">DAX does not provide any time intelligence functions that handle weeks. The reason is that there are many different standards and techniques to define weeks within a year, and to define the notion of calculation over weeks. Oftentimes a single week crosses the boundaries of years, quarters, and months. You need to write the code to handle your own definition of a week-based calendar. For example, in ISO a week-date system of January 1 and January 2 in 2011 belongs to week 52 of year 2010, and the first week of 2011 starts on January 3.</p>
<p class="edition">Although there are different standards, you can learn a generic approach that should work in most cases. The approach involves the creation of additional columns in the <em class="calibre5">Date</em> table to store the relationship between weeks and their month/quarter/year. Changing the association rules will just require changing the content of the <em class="calibre5">Date</em> table, without modifying the DAX code of the measures.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3064"></span>For example, you can extend a <em class="calibre5">Date</em> table to support ISO weeks by using the following calculated columns:</p>
<p class="codelink"><a href="#calibre_link-876" id="calibre_link-2461" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Date'[Calendar Week Number] = WEEKNUM ( 'Date'[Date], 1 )

'Date'[ISO Week Number] = WEEKNUM ( 'Date'[Date], 21 )

'Date'[ISO Year Number] = YEAR ( 'Date'[Date] + ( 3 - WEEKDAY ( 'Date'[Date], 3 ) ) )

'Date'[ISO Week] = "W" &amp; 'Date'[ISO Week Number] &amp; "-" &amp; 'Date'[ISO Year Number]

'Date'[ISO Week Sequential] = INT ( ( 'Date'[Date] - 2 ) / 7 )

'Date'[ISO Year Day Number] =
VAR CurrentIsoYearNumber = 'Date'[ISO Year Number]
VAR CurrentDate = 'Date'[Date]
VAR DateFirstJanuary = DATE ( CurrentIsoYearNumber, 1, 1 )
VAR DayOfFirstJanuary = WEEKDAY ( DateFirstJanuary, 3 )
VAR OffsetStartIsoYear = - DayOfFirstJanuary + ( 7 * ( DayOfFirstJanuary &gt; 3 ) )
VAR StartOfIsoYear = DateFirstJanuary + OffsetStartIsoYear
VAR Result = CurrentDate - StartOfIsoYear
RETURN
    Result</pre></div>
<p class="edition">You can see in <a href="#calibre_link-877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-41</a> the result of these columns. The <em class="calibre5">ISO Week</em> column will be visible to users, whereas the <em class="calibre5">ISO Week Sequential Number</em> is for internal use only. <em class="calibre5">ISO Year Day Number</em> is the number of days since the beginning of the ISO year. These additional columns make it easy to compare different periods.</p>
<figure id="calibre_link-877" class="image-l">
<img src="images/000081.jpg" alt="The report shows that ISO weeks are fully supported." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-41</strong> The calculated columns extend the <em class="calibre5">Date</em> table to support ISO weeks.</figcaption>
</figure>
<p class="edition">Using the new columns, a developer can write year-to-date aggregation by using the <em class="calibre5">ISO Year Number</em> column instead of extracting the year number from the date. This technique is the same as the one <span type="pagebreak" id="calibre_link-3065"></span>you learned in the “<a href="#calibre_link-157" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding periods to date</a>” section earlier in this chapter. We just added an additional check to make sure that only one <em class="calibre5">ISO Year</em> is selected, prior to invoking the <em class="calibre5">VALUES</em> function:</p>
<p class="codelink"><a href="#calibre_link-878" id="calibre_link-2462" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ISO YTD Sales :=
IF (
    HASONEVALUE ( 'Date'[ISO Year Number] ),
    VAR LastDateInSelection = MAX ( 'Date'[Date] )
    VAR YearSelected = VALUES ( 'Date'[ISO Year Number] )
    VAR Result =
        CALCULATE (
            [Sales Amount],
            'Date'[Date] &lt;= LastDateInSelection,
            'Date'[ISO Year Number] = YearSelected,
            ALL ( 'Date' )
        )
    RETURN
        Result
)</pre></div>
<p class="edition"><a href="#calibre_link-879" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-42</a> shows the result of the <em class="calibre5">ISO YTD Sales</em> measure at the beginning of 2008, compared with a standard YTD computed through <em class="calibre5">DATESYTD</em>. The ISO version accurately includes December 31, 2007, which belongs to ISO Year 2008.</p>
<figure id="calibre_link-879" class="image-l">
<img src="images/000089.jpg" alt="The report shows that December 31, 2007, is included in the ISO year 2008." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-42</strong> <em class="calibre5">ISO YTD Sales</em> accurately includes December 31, 2007, in the first week of 2008.</figcaption>
</figure>
<p class="edition">The comparison with the prior year should compare the relative weeks of the year with the same weeks in the previous year. Since the dates might be different, it is simpler to use other columns in the date table to implement the comparison logic. The distribution of weeks within each year is regular because each week always has seven days, whereas calendar months have different lengths and cannot benefit from the same assumption. In week-based calendars, you can simplify the calculation by looking in the previous year for the same relative days that were selected in the current filter context.</p>
<p class="edition">The following <em class="calibre5">ISO PY Sales</em> measure filters the same selection of days in the previous year. This technique also works when the selection includes complete weeks because the days are selected using the <em class="calibre5">ISO Year Day Number</em> value and not the effective date.</p>
<p class="codelink"><a href="#calibre_link-880" id="calibre_link-2463" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-1856"></span>ISO PY Sales :=
IF (
    HASONEVALUE ( 'Date'[ISO Year Number] ),
    VAR DatesInSelection = VALUES ( 'Date'[ISO Year Day Number] )
    VAR YearSelected = VALUES ( 'Date'[ISO Year Number] )
    VAR PrevYear = YearSelected - 1
    VAR Result =
        CALCULATE (
            [Sales Amount],
            DatesInSelection,
            'Date'[ISO Year Number] = PrevYear,
            ALL ( 'Date' )
        )
    RETURN
        Result
)</pre></div>
<p class="edition"><a href="#calibre_link-881" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 8-43</a> shows the result produced by the <em class="calibre5">ISO PY Sales</em> measure. On the right we added the sales amount of 2007, to make it easier to understand the source of <em class="calibre5">ISO PY Sales</em>.</p>
<figure id="calibre_link-881" class="image-l">
<img src="images/000097.jpg" alt="The figure brings together CAP PY Sales, ISO PY Sales with Sales Amount per ISO Year Number." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 8-43</strong> The <em class="calibre5">ISO PY Sales</em> shows the value of the same weeks one year earlier.</figcaption>
</figure>
<p class="edition">Week-based calendars are simple to manage because of the assumption you can make about the symmetry between days in different years. This is usually not compatible with the calendar month, so if you want to use both hierarchies (months and weeks), you should create different time intelligence calculations for each hierarchy.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-163" class="calibre13"><span type="pagebreak" id="calibre_link-1854"></span>Custom year-to-date, quarter-to-date, and month-to-date</h4>
<p class="edition">Earlier in this chapter, you learned how to rewrite <em class="calibre5">DATESYTD</em> and similar functions in the “<a href="#calibre_link-157" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding periods to date</a>” section. There, we could still extract date attributes&mdash;like the year&mdash;from the date column. With ISO calendars, this logic is no longer in the date column. Instead, we created additional columns just for this calculation. In this section we now demonstrate how to replace the logic that extracts information from the date value by using other columns of the <em class="calibre5">Date</em> table.</p>
<p class="edition">For example, consider the following <em class="calibre5">YTD Sales</em> measure:</p>
<div class="program"><pre class="calibre14">YTD Sales :=
CALCULATE (
    [Sales Amount],
    DATESYTD ( 'Date'[Date] )
)</pre></div>
<p class="edition">The corresponding syntax in DAX without time intelligence is the following:</p>
<p class="codelink"><a href="#calibre_link-882" id="calibre_link-2464" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">YTD Sales :=
VAR LastDateInSelection = MAX ( 'Date'[Date] )
VAR Result =
    CALCULATE (
        [Sales Amount],
        'Date'[Date] &lt;= LastDateInSelection
           &amp;&amp; YEAR ( 'Date'[Date] ) = YEAR ( LastDateInSelection )
    )
RETURN
    Result</pre></div>
<p class="edition">If you use a custom calendar, you must replace the <em class="calibre5">YEAR</em> function call with an access to the <em class="calibre5">Year</em> column, such as in the following <em class="calibre5">YTD Sales Custom</em> measure:</p>
<p class="codelink"><a href="#calibre_link-883" id="calibre_link-2465" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">YTD Sales Custom :=
VAR LastDateInSelection = MAX ( 'Date'[Date] )
VAR LastYearInSelection = MAX ( 'Date'[Calendar Year Number] )
VAR Result =
    CALCULATE (
        [Sales Amount],
        'Date'[Date] &lt;= LastDateInSelection,
        <strong class="calibre7">'Date'[Calendar Year Number] = LastYearInSelection,</strong>
        ALL ( 'Date' )
    )
RETURN
    Result</pre></div>
<p class="edition">You can use the same template to implement quarter-to-date and month-to-date calculations. The only difference is the column used instead of <em class="calibre5">Calendar Year Number</em>:</p>
<p class="codelink"><a href="#calibre_link-884" id="calibre_link-2466" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-1855"></span>QTD Sales Custom :=
VAR LastDateInSelection = MAX ( 'Date'[Date] )
VAR LastYearQuarterInSelection = MAX ( 'Date'[Calendar Year Quarter Number] )
VAR Result =
    CALCULATE (
        [Sales Amount],
        'Date'[Date] &lt;= LastDateInSelection,
        <strong class="calibre7">'Date'[Calendar Year Quarter Number] = LastYearQuarterInSelection,</strong>
        ALL ( 'Date' )
    )
RETURN
    Result

MTD Sales Custom :=
VAR LastDateInSelection = MAX ( 'Date'[Date] )
VAR LastYearMonthInSelection = MAX ( 'Date'[Calendar Year Month Number] )
VAR Result =
    CALCULATE (
        [Sales Amount],
        'Date'[Date] &lt;= LastDateInSelection,
        <strong class="calibre7">'Date'[Calendar Year Month Number] = LastYearMonthInSelection,</strong>
        ALL ( 'Date' )
    )
RETURN
    Result</pre></div>
<p class="edition">You can use these formulas to implement calculations for both standard calendars (in case you want to improve performance using <em class="calibre5">DirectQuery</em>) and custom calendars (in case the time periods are not standard periods).</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-164" class="h2a">Conclusions</h3>
<p class="edition">In this long chapter, you learned the basics of time intelligence calculations in DAX. These are the important points we covered:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Both Power Pivot and Power BI have mechanisms to automate the creation of a date table. They are not worth using, unless your requirements are really simple. Having control over your date table is important and the existing tools do not let you modify the tables to follow your needs.</p></li>
<li class="calibre10"><p class="listp">Building a date table is easy by leveraging <em class="calibre5">CALENDARAUTO</em> and some simple DAX code. It is worth investing some time to build your own date table, as you will reuse the code in many different projects. You can also download DAX templates for a date table on the web.</p></li>
<li class="calibre10"><p class="listp">A data table should be marked as a date table to simplify the use of time intelligence calculations.</p></li>
<li class="calibre10"><p class="listp">There are several time intelligence functions. Most of them simply return a table that can be used as a filter argument of <em class="calibre5">CALCULATE</em>.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-3066"></span>You should learn to treat time intelligence functions as building blocks for more complex calculations. By mixing time intelligence functions, one can create several different and complex calculations.</p></li>
<li class="calibre10"><p class="listp">When the requirements are such that standard time intelligence calculations no longer work, it is time to roll up your sleeves and learn to author time intelligence calculations with simpler DAX functions.</p></li>
<li class="calibre10"><p class="listp">There are several examples of time intelligence calculations in this book. However, you can find many more at <a href="https://www.daxpatterns.com/time-patterns/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.daxpatterns.com/time-patterns/</a>.</p></li>
</ul>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-885">
<div id="calibre_link-3067" class="calibre2">
<div id="calibre_link-3068" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-14"><span type="pagebreak" id="calibre_link-1836"></span><span class="pd_ash">Chapter 9</span><br class="calibre3" />Calculation groups</h2>
<p class="edition">In 2019, DAX received a major update with the introduction of calculation groups. Calculation groups are a utility feature inspired from a similar feature available in MDX, known as calculated members. If you already know what calculated members in MDX are, then learning calculation groups should be somewhat easier. However, the DAX implementation differs from the MDX implementation. Therefore, regardless of your previous knowledge, in this chapter you will learn what calculation groups are, what they were designed for, and how they can help build awesome calculations.</p>
<p class="edition">Calculation groups are easy to use; however, designing a model with calculation groups correctly can be challenging when you create multiple calculation groups or when you use calculation items in measures. For this reason, we provide best practices to help you avoid any issues. Deviating from these best practices requires a deep understanding of how calculation groups are designed, if one wants to obtain a sound model.</p>
<p class="edition">Calculation groups are a new feature in DAX, which, as of April 2019, has not been completed and released. Along this chapter we highlight the parts that may change in the final version of this feature. Therefore, it is important to visit the web page <a href="https://www.sqlbi.com/calculation-groups" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.sqlbi.com/calculation-groups</a>, where you will find updated material and examples about calculation groups in DAX.</p>
<section class="calibre4">
<h3 id="calibre_link-165" class="h2a">Introducing calculation groups</h3>
<p class="edition">Before we provide a description of calculation groups, it is useful to spend some time analyzing the business requirement that led to the introduction of this feature. Because you just finished digesting the chapter about time intelligence, an example involving time-related calculations fits perfectly well.</p>
<p class="edition">In our sample model we defined calculations to compute the sales amount, the total cost, the margin, and the total quantity sold by using the following DAX code:</p>
<p class="codelink"><a href="#calibre_link-886" id="calibre_link-2468" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount := SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
Total Cost := SUMX ( Sales, Sales[Quantity] * Sales[Unit Cost] )
Margin := [Sales Amount] - [Total Cost]
Sales Quantity := SUM ( Sales[Quantity] )</pre></div>
<p class="edition">All four measures are useful, and they provide different insights into the business. Moreover, all four measures are good candidates for time intelligence calculations. A year-to-date over sales quantity can be as interesting as a year-to-date over sales amount and over margin. The same consideration is true for many other time intelligence calculations: same period last year, growth in percentage against the previous year, and many others.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3069"></span>Nevertheless, if one wants to build all the different time intelligence calculations for all the measures, the number of measures in the data model may grow very quickly. In the real world, managing a data model with hundreds of measures is intimidating for both users and developers. Finally, consider that all the different measures for time intelligence calculations are simple variations of a common pattern. For example, the year-to-date versions of the previous list of four measures would look like the following:</p>
<p class="codelink"><a href="#calibre_link-887" id="calibre_link-2469" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">YTD Sales Amount :=
CALCULATE (
    [Sales Amount],
    DATESYTD ( 'Date'[Date] )
)

YTD Total Cost :=
CALCULATE (
    [Total Cost],
    DATESYTD ( 'Date'[Date] )
)

YTD Margin :=
CALCULATE (
    [Margin],
    DATESYTD ( 'Date'[Date] )
)

YTD Sales Quantity :=
CALCULATE (
    [Sales Quantity],
    DATESYTD ( 'Date'[Date] )
)</pre></div>
<p class="edition">All the previous measures only differ in their base measure; they all apply the same <em class="calibre5">DATESYTD</em> filter context to different base measures. It would be great if a developer were given the opportunity to define a more generic calculation, using a placeholder for the measure:</p>
<p class="codelink"><a href="#calibre_link-888" id="calibre_link-2470" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">YTD <strong class="calibre7">&lt;Measure&gt;</strong> :=
CALCULATE (
    <strong class="calibre7">&lt;Measure&gt;</strong>,
    DATESYTD ( 'Date'[Date] )
)</pre></div>
<p class="edition">The previous code is not a valid DAX syntax, but it provides a very good description of what calculation items are. You can read the previous code as: <em class="calibre5">When you need to apply the YTD calculation to a measure, call the measure after applying DATESYTD to the Date[Date] column</em>. This is what a calculation item is: A calculation item is a DAX expression containing a special placeholder. The placeholder is replaced with a measure by the engine just before evaluating the result. In other words, a calculation item is a variation of an expression that can be applied to any measure.</p>
<p class="edition">Moreover, a developer will likely find themselves needing several time intelligence calculations. As we noted at the beginning of the section, year-to-date, quarter-to-date, and same period last year are all calculations that somehow belong to the same group of calculations. Therefore, DAX offers calculation items and calculation groups. A calculation group is a set of calculation items that are conveniently grouped together because they are variations on the same topic.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1837"></span>Let us continue with DAX pseudo-code:</p>
<p class="codelink"><a href="#calibre_link-889" id="calibre_link-2471" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATION GROUP "Time Intelligence"
    CALCULATION ITEM CY := &lt;Measure&gt;
    CALCULATION ITEM PY := CALCULATE ( &lt;Measure&gt;, SAMPEPERIODLASTYEAR ( 'Date'[Date] ) )
    CALCULATION ITEM QTD := CALCULATE ( &lt;Measure&gt;, DATESQTD ( 'Date'[Date] ) )
    CALCULATION ITEM YTD := CALCULATE ( &lt;Measure&gt;, DATESYTD ( 'Date'[Date] ) )</pre></div>
<p class="edition">As you can see, we grouped four time-related calculations in a group named <em class="calibre5">Time Intelligence</em>. In only four lines, the code defines dozens of different measures because the calculation items apply their variation to any measure in the model. Thus, as soon as a developer creates a new measure, the CY, PY, QTD, and YTD variations will be available at no cost.</p>
<p class="edition">There are still several details missing in our understanding of calculation groups, but only one is required to start taking advantage of them and to define the first calculation group: How does the user choose one variation? As we said, a calculation item is not a measure; it is a variation of a measure. Therefore, a user needs a way to put in a report a specific measure with one or more variations of the measure itself. Because users have the habit of selecting columns from tables, calculation groups are implemented as if they were columns in tables, whereas calculation items are like values of the given columns. This way, the user can use the calculation group in the columns of a matrix to display different variations of a measure in the report. For example, the calculation items previously described are applied to the columns of the matrix in <a href="#calibre_link-890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-1</a>, showing different variations of the <em class="calibre5">Sales Amount</em> measure.</p>
<figure id="calibre_link-890" class="image-l">
<img src="images/000113.jpg" alt="The figure shows a matrix with CY, PY, QTD, and YTD per month, in 2008." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-1</strong> The user can use a calculation group as if it were a column of the model, applying it to matrix columns.</figcaption>
</figure>
</section>
<section class="calibre4">
<h3 id="calibre_link-166" class="h2a">Creating calculation groups</h3>
<p class="edition">The implementation of calculation groups in a Tabular model depends on the user interface of the editor tool. At the time of writing (April 2019), neither Power BI nor SQL Server Data Tools (SSDT) for Analysis Services have a user interface for this feature, which is only available at the API level of Tabular Object Model (TOM). The first tool providing an editor for this feature is Tabular Editor, an open source tool available for free at <a href="https://tabulareditor.github.io/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://tabulareditor.github.io/</a>.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3070"></span>In Tabular Editor, the Model / New Calculation Group menu item creates a new calculation group, which appears as a table in the model with a special icon. This is shown in <a href="#calibre_link-891" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-2</a> where the calculation group has been renamed <em class="calibre5">Time Intelligence</em>.</p>
<figure id="calibre_link-891" class="image-l">
<img src="images/000121.jpg" alt="The figure shows a screenshot in Tabular Editor, specifically the time intelligence calculation group." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-2</strong> Tabular Editor displays the <em class="calibre5">Time Intelligence</em> calculation group as a special table.</figcaption>
</figure>
<p class="edition">A calculation group is a special table with a single column, named <em class="calibre5">Attribute</em> by default in Tabular Editor. In our sample model we renamed this column <em class="calibre5">Time calc</em>; then we added three items (<strong class="calibre7">YTD</strong>, <strong class="calibre7">QTD</strong>, and <strong class="calibre7">SPLY</strong> for same period last year) by using the New Calculation Item context menu item available by right-clicking on the <em class="calibre5">Time calc</em> column. Each calculation item has a DAX expression, as shown in <a href="#calibre_link-892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-3</a>.</p>
<figure id="calibre_link-892" class="image-l">
<img src="images/000129.jpg" alt="The figure shows that a calculation item has a DAX expression." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3071"></span><strong class="calibre7">Figure 9-3</strong> Every calculation item has a DAX expression that can be modified in Tabular Editor.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">SELECTEDMEASURE</em> function is the DAX implementation of the <em class="calibre5">&lt;Measure&gt;</em> placeholder we used in the previous DAX pseudo-code. The DAX code for each calculation item is described in the following code. The comment preceding each DAX expression identifies the corresponding calculation item:</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">It is best practice to always expose the business logic through measures in the model. When the model includes calculation groups, the Power BI client does not allow developers to aggregate columns because calculation groups can only be applied to measures, and they do not produce any effect on aggregation functions; they only operate on measures.</p>
</div>
<p class="codelink"><a href="#calibre_link-893" id="calibre_link-2472" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: YTD</strong>
<strong class="calibre7">--</strong>
    CALCULATE (
        SELECTEDMEASURE (),
        DATESYTD ( 'Date'[Date] )
    )

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: QTD</strong>
<strong class="calibre7">--</strong>
    CALCULATE (
        SELECTEDMEASURE (),
        DATESQTD ( 'Date'[Date] )
    )

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: SPLY</strong>
<strong class="calibre7">--</strong>
    CALCULATE (
        SELECTEDMEASURE (),
        SAMEPERIODLASTYEAR ( 'Date'[Date] )
    )</pre></div>
<p class="edition">With this definition, the user will see a new table named <em class="calibre5">Time Intelligence</em>, with a column named <em class="calibre5">Time calc</em> containing three values: <strong class="calibre7">YTD</strong>, <strong class="calibre7">QTD</strong>, and <strong class="calibre7">SPLY</strong>. The user can create a slicer on that column, or use it on the rows and columns of visuals, as if it were a real column in the model. For example, when the user selects <strong class="calibre7">YTD</strong>, the engine applies the <strong class="calibre7">YTD</strong> calculation item to whatever measure is in the report. In <a href="#calibre_link-894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-4</a> you can see a matrix containing the <em class="calibre5">Sales Amount</em> measure. Because the slicer selects the <strong class="calibre7">YTD</strong> variation of the measure, the numbers shown are year-to-date values.</p>
<figure id="calibre_link-894" class="image-l">
<img src="images/000137.jpg" alt="The figure shows a matrix with a slicer. The user selected YTD, revealing the year-to-date variation of the measure." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3072"></span><strong class="calibre7">Figure 9-4</strong> When the user selects <strong class="calibre7">YTD</strong>, the values in the matrix represent the <strong class="calibre7">YTD</strong> variation of the <em class="calibre5">Sales Amount</em> measure.</figcaption>
</figure>
<p class="edition">If on the same report the user selects <strong class="calibre7">SPLY</strong>, the result will be very different, as you can appreciate in <a href="#calibre_link-895" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-5</a>.</p>
<figure id="calibre_link-895" class="image-l">
<img src="images/000145.jpg" alt="In this figure the user selected SPLY, which reveals the values of sales amount shifted back one year." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-5</strong> Selecting <strong class="calibre7">SPLY</strong> changes the results of the <em class="calibre5">Sales Amount</em> measure because it now uses a different variation. The values are the original <em class="calibre5">Sales Amount</em> values, shifted back one year.</figcaption>
</figure>
<p class="edition">If the user does not select one value or if the user selects multiple values together, then the engine does not apply any variation to the original measure. You can see this in <a href="#calibre_link-896" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-6</a>.</p>
<figure id="calibre_link-896" class="image-l">
<img src="images/000153.jpg" alt="The user has not selected a calculation item. The values are the values of the original measure." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3073"></span><strong class="calibre7">Figure 9-6</strong> When no calculation item is selected, the report shows the original measure.</figcaption>
</figure>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The behavior of calculation groups with no selection or with multiple items selected may change in the future. As of April 2019, when multiple calculation items are selected, the behavior is the same as if there were no selection on a calculation group. Nevertheless, this condition might return different results in future versions&mdash;for example, raising an error in case of a multiple selection.</p>
</div>
<p class="edition">Calculation groups can go further than that. At the beginning of this section we introduced four different measures: <em class="calibre5">Sales Amount</em>, <em class="calibre5">Total Cost</em>, <em class="calibre5">Margin</em>, and <em class="calibre5">Sales Quantity</em>. It would be extremely nice if the user could use a slicer in order to select the metric to show and not only the time intelligence calculation to apply. We would like to present a generic report that slices any of the four metrics by month and year, letting the user choose the desired metric. In other words, we want to obtain the report in <a href="#calibre_link-897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-7</a>.</p>
<figure id="calibre_link-897" class="image-l">
<img src="images/000161.jpg" alt="The report comes with two slicers: one for the time calculation and one for the metric." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-7</strong> The report shows the <strong class="calibre7">YTD</strong> time intelligence calculation applied to <em class="calibre5">Margin</em>, but the user can choose any other combination through the slicers.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3074"></span>In the example shown in <a href="#calibre_link-897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-7</a>, the user is browsing the margin amount using a year-to-date variation. Nevertheless, the user can choose any combination of the slicers linked to the two calculation groups, <em class="calibre5">Metric</em> and <em class="calibre5">Time calc</em>.</p>
<p class="edition">In order to obtain this report, we created an additional calculation group named <em class="calibre5">Metric</em>, which includes the <strong class="calibre7">Sales Amount</strong>, <strong class="calibre7">Total Cost</strong>, <strong class="calibre7">Margin</strong>, and <strong class="calibre7">Sales Quantity</strong> calculation items. The expression for each calculation item just evaluates the corresponding measure, as shown in <a href="#calibre_link-898" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-8</a> for the <strong class="calibre7">Sales Amount</strong> calculation item.</p>
<figure id="calibre_link-898" class="image-l">
<img src="images/000169.jpg" alt="The figure shows a screenshot where the Sales Amount calculation item and its expression are displayed." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-8</strong> The <em class="calibre5">Metric</em> calculation group contains four calculation items; each one simply evaluates a corresponding measure.</figcaption>
</figure>
<p class="edition">When there are multiple calculation groups in the same data model, it is important to define in which order they should be applied by the DAX engine. The <em class="calibre5">Precedence</em> property of the calculation group defines the order of application: the first calculation group applied is the one with the larger value. In order to obtain the desired result, we increased the <em class="calibre5">Precedence</em> property of the <em class="calibre5">Time Intelligence</em> calculation group to 10, as shown in <a href="#calibre_link-899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-9</a>. As a consequence, the engine applies the <em class="calibre5">Time Intelligence</em> calculation group before the <em class="calibre5">Metric</em> calculation group, which keeps the <em class="calibre5">Precedence</em> property at the default value of zero. We discuss the precedence of calculation groups in more detail later in this chapter.</p>
<figure id="calibre_link-899" class="image-l">
<img src="images/000177.jpg" alt="In this screenshot we see the Precedence property in a calculation group." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3075"></span><strong class="calibre7">Figure 9-9</strong> The <em class="calibre5">Precedence</em> property defines the order in which each calculation group is applied to a measure.</figcaption>
</figure>
<p class="edition">The following DAX code includes the definition of each calculation item in the <em class="calibre5">Metric</em> calculation group:</p>
<p class="codelink"><a href="#calibre_link-900" id="calibre_link-2473" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: Margin</strong>
<strong class="calibre7">--</strong>
    [Margin]

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: Sales Amount</strong>
<strong class="calibre7">--</strong>
    [Sales Amount]

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: Sales Quantity</strong>
<strong class="calibre7">--</strong>
    [Sales Quantity]

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: Total Cost</strong>
<strong class="calibre7">--</strong>
    [Total Cost]</pre></div>
<p class="edition">These calculation items are not modifiers of the original measure. Instead, they completely replace the original measure with a new one. To obtain this behavior, we omitted a reference to <em class="calibre5">SELECTEDMEASURE</em> in the expression. <em class="calibre5">SELECTEDMEASURE</em> is used very often in calculation items, but it is not mandatory.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1838"></span>This last example is useful to introduce the first of the many complexities that we will need to address with calculation groups. If the user selects <strong class="calibre7">Quantity</strong>, then the report shows the quantity, but it still uses the same format strings (with two decimals) as the other measures. Because the <em class="calibre5">Quantity</em> measure is an integer, it would be useful to remove the decimal places or, in general, to adopt a different format string. We discussed earlier the fact that the presence of multiple calculation groups in a calculation requires the definition of a precedence order, as was the case in the previous example. These are the first of several details to consider in order to create useful calculation groups.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">If you are using Analysis Services, be mindful that adding a calculation group to a model is an operation that requires a refresh of the table corresponding to the calculation group in order to make the calculation items visible to the client. This may prove to be counterintuitive because deploying measures does not require such an update&mdash;measures are visible to the clients just after the deployment. However, because calculation groups and items are presented to the client in tables and columns, after the deployment it is necessary to run a refresh operation to populate the internal structures of the tables and columns. In Power BI this operation will likely be handled automatically by the user interface&mdash;though this is pure speculation because calculation groups are not present in Power BI at the time of printing.</p>
</div>
</section>
<section class="calibre4">
<h3 id="calibre_link-167" class="h2a">Understanding calculation groups</h3>
<p class="edition">In the previous sections we focused on the use of calculation groups and how to implement them with Tabular Editor. In this section, we describe in more detail the properties and behavior of calculation groups and calculation items.</p>
<p class="edition">There are two entities: calculation groups and calculation items. A calculation group is a collection of calculation items, grouped together based on a user-defined criterion. For both calculation groups and calculation items, there are properties that the developer must set correctly. We introduce these entities and their properties here, providing more examples and details in the remaining part of this chapter.</p>
<p class="edition">A calculation group is a simple entity, defined by</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The calculation group <strong class="calibre7">Name</strong>. This is the name of the table that represents the calculation group on the client side.</p></li>
<li class="calibre10"><p class="listp">The calculation group <strong class="calibre7">Precedence</strong>. When there are multiple active calculation groups, a number that defines the precedence used to apply each calculation group to a measure reference.</p></li>
<li class="calibre10"><p class="listp">The calculation group attribute <strong class="calibre7">Name</strong>. This is the name of the column that includes the calculation items, displayed to the client as unique items available in the column.</p></li>
</ul>
<p class="edition">A calculation item is a much more sophisticated entity, and here is the list of its properties:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The calculation item <strong class="calibre7">Name</strong>. This becomes one value of the calculation group column. Indeed, a calculation item is like one row in the calculation group table.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-1843"></span>The calculation item <strong class="calibre7">Expression</strong>. A DAX expression that might contain special functions like <em class="calibre5">SELECTEDMEASURE</em>. This is the expression that defines how to apply the calculation item.</p></li>
<li class="calibre10"><p class="listp">The sort order of the calculation item is defined by the <strong class="calibre7">Ordinal</strong> value. This property defines how the different calculation items are sorted when presented to the user. It is very similar to the sort-by-column feature of the data model. <em class="calibre5">This feature is not available as of April 2019 but should be implemented before calculation groups are released</em>.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Format String</strong>. If not specified, a calculation item inherits the format string of its base measure. Nevertheless, if the modifier changes the calculation, then it is possible to override the measure format string with the format of the calculation item.</p></li>
</ul>
<p class="edition">The <em class="calibre5">Format String</em> property is important in order to obtain a consistent behavior of the measures in the model according to the calculation item being applied to them. For example, consider the following calculation group containing two calculation items for time intelligence: year-over-year (<strong class="calibre7">YOY</strong>) is the difference between a selected period and the same period in the previous year; year-over-year percentage (<strong class="calibre7">YOY%</strong>) is the percentage of <strong class="calibre7">YOY</strong> over the amount in the same period in the previous year:</p>
<p class="codelink"><a href="#calibre_link-901" id="calibre_link-2474" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: YOY</strong>
<strong class="calibre7">--</strong>
    VAR CurrYear =
        SELECTEDMEASURE ()
    VAR PrevYear =
        CALCULATE (
            SELECTEDMEASURE (),
            SAMEPERIODLASTYEAR ( 'Date'[Date] )
        )
    VAR Result =
        CurrYear - PrevYear
    RETURN Result

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: YOY%</strong>
<strong class="calibre7">--</strong>
    VAR CurrYear =
        SELECTEDMEASURE ()
    VAR PrevYear =
        CALCULATE (
            SELECTEDMEASURE (),
            SAMEPERIODLASTYEAR ( 'Date'[Date] )
        )
    VAR Result =
        DIVIDE (
            CurrYear - PrevYear,
            PrevYear
        )
    RETURN Result</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1845"></span>The result produced by these two calculation items in a report is correct, but if the <em class="calibre5">Format String</em> property does not override the default format string, then <strong class="calibre7">YOY%</strong> is displayed as a decimal number instead of as a percentage, as shown in <a href="#calibre_link-902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-10</a>.</p>
<figure id="calibre_link-902" class="image-l">
<img src="images/000185.jpg" alt="The figure shows YOY and YOY% per month, for CY 2009." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-10</strong> The two calculation items <strong class="calibre7">YOY</strong> and <strong class="calibre7">YOY%</strong> share the same format as the <em class="calibre5">Sales Amount</em> measure.</figcaption>
</figure>
<p class="edition">The example shown in <a href="#calibre_link-902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-10</a> displays the <strong class="calibre7">YOY</strong> evaluation of the <em class="calibre5">Sales Amount</em> measure using the same format string as the original <em class="calibre5">Sales Amount</em> measure. This is the correct behavior to display a difference. However, the <strong class="calibre7">YOY%</strong> calculation item displays the same amount as a percentage of the value of the previous year. The number shown is correct, but for January one would expect to see −12% instead of −0.12. In this case the expected format string should be a percentage, regardless of the format of the original measure. To obtain the desired behavior, set the <em class="calibre5">Format String</em> property of the <strong class="calibre7">YOY%</strong> calculation item to percentage, overriding the behavior of the underlying measure. You can see the result in <a href="#calibre_link-903" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-11</a>. If the <em class="calibre5">Format String</em> property is not assigned to a calculation item, the existing format string is used.</p>
<figure id="calibre_link-903" class="image-l">
<img src="images/000193.jpg" alt="The figure shows YOY and YOY% per month, for CY 2009. Values in YOY% are displayed as percentages." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-11</strong> The <strong class="calibre7">YOY%</strong> calculation item overrides the format of the <em class="calibre5">Sales Amount</em> measure displaying the value as a percentage.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1775"></span>The format string can be defined using a fixed format string or&mdash;in more complex scenarios&mdash;by using a DAX expression that returns the format string. When one is writing a DAX expression, it becomes possible to refer to the format string of the current measure using the <em class="calibre5">SELECTEDMEASUREFORMATSTRING</em> function, which returns the format string currently defined for the measure. For example, if the model contains a measure that returns the currently selected currency and you want to include the currency symbol as part of the format string, you can use this code to append the currency symbol to the current format string:</p>
<p class="codelink"><a href="#calibre_link-904" id="calibre_link-2475" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECTEDMEASUREFORMATSTRING () &amp; " " &amp; [Selected Currency]</pre></div>
<p class="edition">Customizing the format string of a calculation item is useful to preserve user experience consistency when browsing the model. However, a careful developer should consider that the format string operates on any measure used with the calculation item. When there are multiple calculation groups in a report, the result produced by these properties also depends on the calculation group precedence, as explained in a later section of this chapter.</p>
<section class="calibre4">
<h4 id="calibre_link-168" class="calibre13">Understanding calculation item application</h4>
<p class="edition">So far, the description we gave of how a calculation item works has never been extremely precise. The reason is mainly educational: we wanted to introduce the concept of calculation items, without diving too deep into details that might be distracting. Indeed, we said that calculation items can be applied by the user using, for example, a slicer. A calculation item is applied by replacing measure references invoked when there is a calculation item active in the filter context. In this scenario, the calculation item rewrites the measure reference by applying the expression defined in the calculation item itself.</p>
<p class="edition">For example, consider the following calculation item:</p>
<p class="codelink"><a href="#calibre_link-905" id="calibre_link-2476" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: YTD</strong>
<strong class="calibre7">--</strong>
    CALCULATE (
        SELECTEDMEASURE (),
        DATESYTD ( 'Date'[Date] )
    )</pre></div>
<p class="edition">In order to apply the calculation item in an expression, you need to filter the calculation group. You can create this filter using <em class="calibre5">CALCULATE</em>, like in the following example; this is the same technique used by the client tool when using slicers and visuals:</p>
<p class="codelink"><a href="#calibre_link-906" id="calibre_link-2477" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    'Time Intelligence'[Time calc] = "YTD"
)</pre></div>
<p class="edition">There is nothing magical about calculation groups: They are tables, and as such they can be filtered by <em class="calibre5">CALCULATE</em> like any other table. When <em class="calibre5">CALCULATE</em> applies a filter to a calculation item, DAX uses the definition of the calculation item to rewrite the expression before evaluating it.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3076"></span>Therefore, based on the definition of the calculation item, the previous code is interpreted as follows:</p>
<p class="codelink"><a href="#calibre_link-907" id="calibre_link-2478" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    CALCULATE (
        [Sales Amount],
        DATESYTD ( 'Date'[Date] )
    )
)</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Inside the inner <em class="calibre5">CALCULATE</em>, one can check with <em class="calibre5">ISFILTERED</em> whether the calculation item is filtered or not. In the example, we removed the outer filter on the calculation item for the sake of simplicity, to show that the calculation item has already been applied. Nevertheless, a calculation item retains its filters, and further sub-expressions might still perform the replacement of measures.</p>
</div>
<p class="edition">Despite being very intuitive in simple examples, this behavior hides some level of complexity. The application of a calculation item replaces a measure reference with the expression of the calculation item. Focus your attention on this last sentence: <em class="calibre5">A measure reference is replaced</em>. Without a measure reference, a calculation item does not apply any modification. For example, the following code is not affected by any calculation item because it does not contain any measure reference:</p>
<p class="codelink"><a href="#calibre_link-908" id="calibre_link-2479" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    SUMX ( Sales, Sales[Quantity] * Sales[Net Price] ),
    'Time Intelligence'[Time calc] = "YTD"
)</pre></div>
<p class="edition">In this example, the calculation item does not perform any transformation because the code inside <em class="calibre5">CALCULATE</em> does not use any measure. The following code is the one executed after the application of the calculation item:</p>
<p class="codelink"><a href="#calibre_link-909" id="calibre_link-2480" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
)</pre></div>
<p class="edition">If the expression inside <em class="calibre5">CALCULATE</em> contains multiple measure references, all of them are replaced with the calculation item definition. For example, the expression in the following <em class="calibre5">Cost Ratio YTD</em> measure contains two measure references, <em class="calibre5">Total Cost</em> and <em class="calibre5">Sales Amount</em>:</p>
<p class="codelink"><a href="#calibre_link-910" id="calibre_link-2481" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CR YTD :=
CALCULATE (
    DIVIDE (
        [Total Cost],
        [Sales Amount]
    ),
    'Time Intelligence'[Time calc] = "YTD"
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1839"></span>To obtain the actual code executed, replace the measure references with the expansion of the calculation item definition, as in the following <em class="calibre5">CR YTD Actual Code</em> measure:</p>
<p class="codelink"><a href="#calibre_link-911" id="calibre_link-2482" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CR YTD Actual Code :=
CALCULATE (
    DIVIDE (
        CALCULATE (
            [Total Cost],
            DATESYTD ( 'Date'[Date] )
        ),
        CALCULATE (
            [Sales Amount],
            DATESYTD ( 'Date'[Date] )
        )
    )
)</pre></div>
<p class="edition">In this example, the code generated produces the same result as the next version in the <em class="calibre5">CR YTD Simplified</em> measure, which is more intuitive:</p>
<p class="codelink"><a href="#calibre_link-912" id="calibre_link-2483" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CR YTD Simplified :=
CALCULATE (
    CALCULATE (
        DIVIDE (
            [Total Cost],
            [Sales Amount]
        ),
        DATESYTD ( 'Date'[Date] )
    )
)</pre></div>
<p class="edition">These three measures return the same result, as shown in <a href="#calibre_link-913" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-12</a>.</p>
<figure id="calibre_link-913" class="image-l">
<img src="images/000201.jpg" alt="The report displays the three measures, which return the same results." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-12</strong> The <em class="calibre5">CR YTD</em>, <em class="calibre5">CR YTD Actual Code</em>, and <em class="calibre5">CR YTD Simplified</em> measures produce the same result.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1841"></span>Nevertheless, you must be very careful because the <em class="calibre5">CR YTD Simplified</em> measure does not correspond to the actual code generated by the calculation item, which is the code in <em class="calibre5">CR YTD Actual Code</em>. In this very special case, the two versions are equivalent. However, in more complex scenarios the difference is significant, and such a large difference can lead to unintended results that are extremely hard to follow and understand. Let us analyze a couple of examples. In the first example the <em class="calibre5">Sales YTD 2008 2009</em> measure has two nested <em class="calibre5">CALCULATE</em> functions: the outer <em class="calibre5">CALCULATE</em> sets a filter on the year 2008, whereas the inner <em class="calibre5">CALCULATE</em> sets a filter on the year 2009:</p>
<p class="codelink"><a href="#calibre_link-914" id="calibre_link-2484" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales YTD 2008 2009 :=
CALCULATE (
    CALCULATE (
        [Sales Amount],
        'Date'[Calendar Year] = "CY 2009"
    ),
    'Time Intelligence'[Time calc] = "YTD",
    'Date'[Calendar Year] = "CY 2008"
)</pre></div>
<p class="edition">The outer <em class="calibre5">CALCULATE</em> filters the calculation item to the <strong class="calibre7">YTD</strong> value. Nevertheless, the application of the calculation item does not change the expression because the expression does not directly contain any measure. <em class="calibre5">CALCULATE</em> filters the calculation item, but its application does not lead to any modifications to the code.</p>
<p class="edition">Pay attention to the fact that the <em class="calibre5">Sales Amount</em> measure is within the scope of the inner <em class="calibre5">CALCULATE</em>. The application of a calculation item modifies the measures in the current scope of the filter context; it does not affect nested filter context scopes. Those are handled by their own <em class="calibre5">CALCULATE</em>&mdash;or equivalent code, such as <em class="calibre5">CALCULATETABLE</em> or context transitions&mdash;which may or may not retain the same filter on the calculation item.</p>
<p class="edition">When the inner <em class="calibre5">CALCULATE</em> applies its filter context, it does not change the filter status of the calculation item. Therefore, the engine finds that the calculation item is still filtered, and it remains filtered if no other <em class="calibre5">CALCULATE</em> changes it. Same as if it were a regular column. The inner <em class="calibre5">CALCULATE</em> contains a measure reference, and DAX performs the application of the calculation item. The resulting code corresponds to the definition of the <em class="calibre5">Sales YTD 2008 2009 Actual Code</em> measure:</p>
<p class="codelink"><a href="#calibre_link-915" id="calibre_link-2485" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales YTD 2008 2009 Actual Code :=
CALCULATE (
    CALCULATE (
        CALCULATE (
            [Sales Amount],
            DATESYTD ( 'Date'[Date] )
        ),
        'Date'[Calendar Year] = "CY 2009"
    ),
    'Date'[Calendar Year] = "CY 2008"
)</pre></div>
<p class="edition">The result of these two measures is visible in <a href="#calibre_link-916" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-13</a>. The selection made by the slicer on the left applies to the matrix in the middle of the figure, which includes the <em class="calibre5">Sales YTD 2008 2009</em> and <em class="calibre5">Sales YTD</em> <span type="pagebreak" id="calibre_link-3077"></span><em class="calibre5">2008 2009 Actual Code</em> measures. However, the selection of the year CY 2008 is overridden by CY 2009. This can be verified by looking at the matrix on the right-hand side, which shows the <em class="calibre5">Sales Amount</em> measure transformed with the <strong class="calibre7">YTD</strong> calculation item for the CY 2008 and CY 2009 years. The numbers in the center matrix correspond to the <em class="calibre5">CY 2009</em> column of the matrix on the right.</p>
<figure id="calibre_link-916" class="image-l">
<img src="images/000209.jpg" alt="The report shows Sales YTD 2008 2009 and Sales YTD 2008 2009 Actual Code measures." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-13</strong> The <em class="calibre5">Sales YTD 2008 2009</em> and <em class="calibre5">Sales YTD 2008 2009 Actual Code</em> measures produce the same result.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">DATESYTD</em> function is applied when the filter context is filtering the year 2009, not 2008. Despite the calculation item being filtered along with the filter for the year 2008, its actual application took place in a different filter context, namely the inner filter context. The behavior is counterintuitive to say the least. The more complex the expression used inside <em class="calibre5">CALCULATE</em>, the harder it becomes to understand how the application works.</p>
<p class="edition">The behavior of calculation items leads to one very important best practice: You need to use calculation items to modify an expression if and only if this expression is a single measure. The previous example was only useful to introduce the rule; let us now analyze the best practice with a more complex expression. The next expression computes the number of working days only for the months where there are sales:</p>
<p class="codelink"><a href="#calibre_link-917" id="calibre_link-2486" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SUMX (
    VALUES ( 'Date'[Calendar Year month] ),
    IF (
        [Sales Amount] &gt; 0, -- Measure reference
        [# Working Days]    -- Measure reference
    )
)</pre></div>
<p class="edition">This calculation is useful to compute <em class="calibre5">Sales Amount</em> per working day considering only the months with sales. The following example uses this calculation in a more complex expression:</p>
<p class="codelink"><a href="#calibre_link-918" id="calibre_link-2487" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DIVIDE (
    [Sales Amount],  -- Measure reference
    SUMX (
        VALUES ( 'Date'[Calendar Year month] ),
        IF (
<span type="pagebreak" id="calibre_link-1840"></span>            [Sales Amount] &gt; 0, -- Measure reference
            [# Working Days]    -- Measure reference
        )
    )
)</pre></div>
<p class="edition">If this expression is executed within an outer <em class="calibre5">CALCULATE</em> that changes the calculation to a <strong class="calibre7">YTD</strong>, the result is the following new formula that produces an unexpected result:</p>
<p class="codelink"><a href="#calibre_link-919" id="calibre_link-2488" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales WD YTD 2008 :=
CALCULATE (
    DIVIDE (
        [Sales Amount],  -- Measure reference
        SUMX (
            VALUES ( 'Date'[Calendar Year month] ),
            IF (
                [Sales Amount] &gt; 0, -- Measure reference
                [# Working Days]    -- Measure reference
            )
        )
    ),
    'Time Intelligence'[Time calc] = "YTD",
    'Date'[Calendar Year] = "CY 2008"
)</pre></div>
<p class="edition">Intuitively, one would expect the previous expression to compute the <em class="calibre5">Sales Amount</em> measure per working days considering all the months before the current one. In other words, one would expect this code to be executed:</p>
<p class="codelink"><a href="#calibre_link-920" id="calibre_link-2489" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales WD YTD 2008 Expected Code :=
CALCULATE (
    CALCULATE (
        DIVIDE (
            [Sales Amount],  -- Measure reference
            SUMX (
                VALUES ( 'Date'[Calendar Year month] ),
                IF (
                    [Sales Amount] &gt; 0, -- Measure reference
                    [# Working Days]    -- Measure reference
                )
            )
        ) ,
        DATESYTD ( 'Date'[Date] )
    ),
    'Date'[Calendar Year] = "CY 2008"
)</pre></div>
<p class="edition">Nevertheless, you might have noticed that we have highlighted the three measure references with a few comments. This was not by chance. The application of a calculation item happens on the measure <span type="pagebreak" id="calibre_link-3078"></span>references, not on the entire expression. Therefore, the code executed by replacing the measure references with the calculation items active in the filter context is very different:</p>
<p class="codelink"><a href="#calibre_link-921" id="calibre_link-2490" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales WD YTD 2008 Actual Code :=
CALCULATE (
    DIVIDE (
        CALCULATE (
            [Sales Amount],
            DATESYTD ( 'Date'[Date] )
        ),
        SUMX (
            VALUES ( 'Date'[Calendar Year month] ),
            IF (
                CALCULATE (
                    [Sales Amount],
                    DATESYTD ( 'Date'[Date] )
                ) &gt; 0,
                CALCULATE (
                    [# Working Days],
                    DATESYTD ( 'Date'[Date] )
                )
            )
        )
    ),
    'Date'[Calendar Year] = "CY 2008"
)</pre></div>
<p class="edition">This latter version of the code produces an abnormal value for the number of working days because it sums the year-to-date of the number of working days for all the months visible in the current context. The chances of producing an inaccurate result are extremely high. When an individual month is selected, the result (by pure luck) is the right one, whereas at the quarter and at the year levels it is hilariously wrong. This is shown in <a href="#calibre_link-922" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-14</a>.</p>
<figure id="calibre_link-922" class="image-l">
<img src="images/000217.jpg" alt="The report shows the different versions of Sales WD per quarter." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-14</strong> Different versions of the <em class="calibre5">Sales WD</em> calculation computed for the all the quarters of 2008.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">Sales WD YTD 2008 Expected Code</em> measure returns the correct number for every quarter, whereas the <em class="calibre5">Sales WD YTD 2008</em> and <em class="calibre5">Sales WD YTD 2008 Actual Code</em> measures return a smaller value. Indeed, the number of working days in the denominator of the ratio is computed as the sum of the year-to-date number of working days for each month in the period.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3079"></span>You can easily avoid this complexity by obeying the best practice: Use <em class="calibre5">CALCULATE</em> with calculation items only to invoke an individual measure. When one authors the <em class="calibre5">Sales WD YTD 2008 Fixed</em> measure that includes the full expression and uses the <em class="calibre5">Sales WD YTD 2008 Fixed</em> measure in a single <em class="calibre5">CALCULATE</em> function, the code is very different and easier to use:</p>
<p class="codelink"><a href="#calibre_link-923" id="calibre_link-2491" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">--</strong>
<strong class="calibre7">-- Measure Sales WD</strong>
<strong class="calibre7">--</strong>
Sales WD :=
DIVIDE (
    [Sales Amount],
    SUMX (
        VALUES ( 'Date'[Calendar Year month] ),
        IF (
            [Sales Amount] &gt; 0,
            [# Working Days]
        )
    )
)

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Measure Sales WD YTD 2008 Fixed</strong>
<strong class="calibre7">-- New version of the Sales WD YTD 2008 measure that applies the YTD calculation item</strong>
<strong class="calibre7">--</strong>
Sales WD YTD 2008 Fixed :=
CALCULATE (
    [Sales WD],                             -- Measure reference
    'Time Intelligence'[Time calc] = "YTD",
    'Date'[Calendar Year] = "CY 2008"
)</pre></div>
<p class="edition">In this case, the code generated by the application of the calculation item is much more intuitive:</p>
<p class="codelink"><a href="#calibre_link-924" id="calibre_link-2492" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales WD YTD 2008 Fixed Actual Code :=
CALCULATE (
    CALCULATE (
        [Sales WD],
        DATESYTD ( 'Date'[Date] )
    ),
    'Date'[Calendar Year] = "CY 2008"
)</pre></div>
<p class="edition">In this latter example the filter provided by <em class="calibre5">DATESYTD</em> surrounds the entire expression, leading to the code that one intuitively expects from the application of the calculation item. The result of the <em class="calibre5">Sales WD YTD 2008 Fixed</em> and <em class="calibre5">Sales WD YTD 2008 Fixed Actual Code</em> measures is visible in <a href="#calibre_link-922" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-14</a>.</p>
<p class="edition">For very simple calculations containing simple expressions, it is possible to deviate from this best practice. However, when doing so, the developer must always think twice before creating any measure, because as soon as the complexity of the expression is no longer trivial, the chances of producing wrong calculations become very high.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1776"></span>When using client tools like Power BI, you never have to worry about these details. Indeed, these tools make sure that calculation items get applied the right way because they always invoke single measures as part of the query they execute. Nevertheless, as a DAX developer, you will end up using calculation items as filters in <em class="calibre5">CALCULATE</em>. When you do that, pay attention to the expression used in <em class="calibre5">CALCULATE</em>. If you want to stay on the safe side, use calculation items in <em class="calibre5">CALCULATE</em> to modify a single measure. Never apply calculation items to an expression.</p>
<p class="edition">Finally, we suggest you learn calculation items by rewriting the expression manually, applying the calculation item, and writing down the complete code that will be executed. It is a mental exercise that proves very useful in understanding exactly what is happening inside the engine.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-169" class="calibre13">Understanding calculation group precedence</h4>
<p class="edition">In the previous section we described how to use <em class="calibre5">CALCULATE</em> to apply a calculation item to a measure. It is possible to apply multiple calculation items to the same measure. Even though each calculation group can only have one active calculation item, the presence of multiple calculation groups can activate multiple calculation items at the same time. This happens when a user uses multiple slicers over different calculation groups, or when a <em class="calibre5">CALCULATE</em> function filters calculation items in different calculation groups. For example, at the beginning of this chapter we defined two calculation groups: one to define the base measure and the other to define the time intelligence calculation to apply to the base measure.</p>
<p class="edition">If there are multiple calculation items active in the current filter context, it is important to define which calculation item is applied first, by defining a set of precedence rules. DAX enforces this by making it mandatory to set the <em class="calibre5">Precedence</em> property in a calculation group, in models that have more than one calculation group. This section describes how to correctly set the <em class="calibre5">Precedence</em> property of a calculation group through examples where the definition of the precedence changes the result of the calculations.</p>
<p class="edition">To prepare the demonstration, we created two different calculation groups, each one containing only one calculation item:</p>
<p class="codelink"><a href="#calibre_link-925" id="calibre_link-2493" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">-------------------------------------------------------</strong>
<strong class="calibre7">-- Calculation Group: 'Time Intelligence'[Time calc]</strong>
<strong class="calibre7">-------------------------------------------------------</strong>

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: YTD</strong>
<strong class="calibre7">--</strong>
    CALCULATE (
        SELECTEDMEASURE (),
        DATESYTD ( 'Date'[Date] )
    )
<span type="pagebreak" id="calibre_link-3080"></span><strong class="calibre7">-------------------------------------------------------</strong>
<strong class="calibre7">-- Calculation Group: 'Averages'[Averages]</strong>
<strong class="calibre7">-------------------------------------------------------</strong>

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: Daily AVG</strong>
<strong class="calibre7">--</strong>
    DIVIDE (
        SELECTEDMEASURE (),
        COUNTROWS ( 'Date' )
    )</pre></div>
<p class="edition"><strong class="calibre7">YTD</strong> is a regular year-to-date calculation, whereas <strong class="calibre7">Daily AVG</strong> computes the daily average by dividing the selected measure by the number of days in the filter context. Both calculation items work just fine, as shown in <a href="#calibre_link-926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-15</a>, where we use two measures to invoke the two calculation items individually:</p>
<p class="codelink"><a href="#calibre_link-927" id="calibre_link-2494" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">YTD :=
CALCULATE (
    [Sales Amount],
    'Time Aggregation'[Aggregation] = "YTD"
)

Daily AVG :=
CALCULATE (
    [Sales Amount],
    'Averages'[Averages] = "Daily AVG"
)</pre></div>
<figure id="calibre_link-926" class="image-l">
<img src="images/000226.jpg" alt="The report shows Sales Amount, Daily AVG, and YTD per month." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-15</strong> Both <em class="calibre5">Daily AVG</em> and <em class="calibre5">YTD</em> calculation items work just fine when invoked individually in separate measures.</figcaption>
</figure>
<p class="edition">The scenario suddenly becomes more complex when both calculation items are used at the same time. Look at the following <em class="calibre5">Daily YTD AVG</em> measure definition:</p>
<p class="codelink"><a href="#calibre_link-928" id="calibre_link-2495" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-3081"></span>Daily YTD AVG :=
CALCULATE (
    [Sales Amount],
    'Time Intelligence'[Time calc] = "YTD",
    'Averages'[Averages] = "Daily AVG"
)</pre></div>
<p class="edition">The measure invokes both calculation items at the same time, but this raises the issue of precedence. Should the engine apply <strong class="calibre7">YTD</strong> first and <strong class="calibre7">Daily AVG</strong> later, or the other way around? In other words, which of these two expressions should be evaluated?</p>
<p class="codelink"><a href="#calibre_link-929" id="calibre_link-2496" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">--
--  YTD is applied first, and then DIVIDE
--
DIVIDE (
    CALCULATE (
        [Sales Amount],
        DATESYTD ( 'Date'[Date] )
    ),
    COUNTROWS ( 'Date' )
)

--
--  DIVIDE is applied first, and then YTD
--
CALCULATE (
    DIVIDE (
        [Sales Amount],
        COUNTROWS ( 'Date' )
    ),
    DATESYTD ( 'Date'[Date] )
)</pre></div>
<p class="edition">It is likely that the second expression is the correct one. Nevertheless, without further information, DAX cannot choose between the two. Therefore, the developer must define the correct order of application of the calculation groups.</p>
<p class="edition">The order of application depends on the <em class="calibre5">Precedence</em> property in the two calculation groups: The calculation group with the highest value is applied first; then the other calculation groups are applied according to their <em class="calibre5">Precedence</em> value in a descending order. <a href="#calibre_link-930" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-16</a> shows the wrong result produced with the following settings:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">Time Intelligence</em> calculation group&mdash;<em class="calibre5">Precedence</em>: 0</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Averages</em> calculation group&mdash;<em class="calibre5">Precedence</em>: 10</p>
<figure id="calibre_link-930" class="image-l">
<img src="images/000234.jpg" alt="The Daily YTD AVG measure looks incorrect." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3082"></span><strong class="calibre7">Figure 9-16</strong> The <em class="calibre5">Daily YTD AVG</em> measure does not produce an accurate result.</figcaption>
</figure></li>
</ul>
<p class="edition">The value of the <em class="calibre5">Daily YTD AVG</em> is clearly wrong in all the months displayed but January. Let us analyze what happened in more depth. <em class="calibre5">Averages</em> has a precedence of 10; therefore, it is applied first. The application of the <strong class="calibre7">Daily AVG</strong> calculation item leads to this expression corresponding to the <em class="calibre5">Daily YTD AVG</em> measure reference:</p>
<p class="codelink"><a href="#calibre_link-931" id="calibre_link-2497" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    DIVIDE (
        [Sales Amount],
        COUNTROWS ( 'Date' )
    ),
   'Time Intelligence'[Time calc] = "YTD"
)</pre></div>
<p class="edition">At this point, DAX activates the <strong class="calibre7">YTD</strong> calculation item from the <em class="calibre5">Time Intelligence</em> calculation group. The application of <strong class="calibre7">YTD</strong> rewrites the only measure reference in the formula, which is <em class="calibre5">Sales Amount</em>. Therefore, the final code corresponding to the <em class="calibre5">Daily YTD AVG</em> measure becomes the following:</p>
<p class="codelink"><a href="#calibre_link-932" id="calibre_link-2498" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DIVIDE (
    CALCULATE (
        [Sales Amount],
        DATESYTD ( 'Date'[Date] )
    ),
    COUNTROWS ( 'Date' )
)</pre></div>
<p class="edition">Consequently, the number shown is obtained by dividing the <em class="calibre5">Sales Amount</em> measure computed using the <strong class="calibre7">YTD</strong> calculation item, by the number of days in the displayed month. For example, the value shown in December is obtained by dividing 9,353,814,87 (<strong class="calibre7">YTD</strong> of <em class="calibre5">Sales Amount</em>) by 31 (the number of days in December). The number should be much lower because the <strong class="calibre7">YTD</strong> variation should be applied to both the numerator and the denominator of the <em class="calibre5">DIVIDE</em> function used in the <strong class="calibre7">Daily AVG</strong> calculation item.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1921"></span>To solve the issue, the <strong class="calibre7">YTD</strong> calculation item must be applied before <strong class="calibre7">Daily AVG</strong>. This way, the transformation of the filter context for the <em class="calibre5">Date</em> column occurs before the evaluation of <em class="calibre5">COUNTROWS</em> over the <em class="calibre5">Date</em> table. In order to obtain this, we modify the <em class="calibre5">Precedence</em> property of the <em class="calibre5">Time Intelligence</em> calculation group to 20, obtaining the following settings:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">Time Intelligence</em> calculation group&mdash;<em class="calibre5">Precedence</em>: 20</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Averages</em> calculation group&mdash;<em class="calibre5">Precedence</em>: 10</p></li>
</ul>
<p class="edition">Using these settings, the <em class="calibre5">Daily YTD AVG</em> measure returns the correct values, as shown in <a href="#calibre_link-933" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-17</a>.</p>
<figure id="calibre_link-933" class="image-l">
<img src="images/000242.jpg" alt="The report shows values that are correct." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-17</strong> The <em class="calibre5">Daily YTD AVG</em> measure produces the right result.</figcaption>
</figure>
<p class="edition">This time, the two application steps are the following: DAX first applies the <strong class="calibre7">YTD</strong> calculation from the <em class="calibre5">Time Intelligence</em> calculation group, changing the expression to the following:</p>
<p class="codelink"><a href="#calibre_link-934" id="calibre_link-2499" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    CALCULATE (
        [Sales Amount],
        DATESYTD ( 'Date'[Date] )
    ),
    'Averages'[Averages] = "Daily AVG"
)</pre></div>
<p class="edition">Then, DAX applies the <strong class="calibre7">Daily AVG</strong> calculation item from the <em class="calibre5">Averages</em> calculation group, replacing the measure reference with the <em class="calibre5">DIVIDE</em> function and obtaining the following expression:</p>
<p class="codelink"><a href="#calibre_link-935" id="calibre_link-2500" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    DIVIDE (
        [Sales Amount],
        COUNTROWS ( 'Date' )
    ),
    DATESYTD ( 'Date'[Date] )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1801"></span>The value displayed in December now considers 365 days in the denominator of <em class="calibre5">DIVIDE</em>, thus obtaining the correct number. Before moving further, please consider that, in this example, we followed the best practice of using calculation items with a single measure. Indeed, the first call comes from the visual of Power BI. However, one of the two calculation items rewrote the <em class="calibre5">Sales Amount</em> measure in such a way that the problem arose. In this scenario, following the best practices is not enough. It is mandatory that a developer understand and define the precedence of application of calculation groups very well.</p>
<p class="edition">All calculation items in a calculation group share the same precedence. It is impossible to define different precedence values for different calculation items within the same group.</p>
<p class="edition">The <em class="calibre5">Precedence</em> property is an integer value assigned to a calculation group. A higher value means a higher precedence of application; the calculation group with the higher precedence is applied first. In other words, DAX applies the calculation groups according to their <em class="calibre5">Precedence</em> value sorted in a descending order. The absolute value assigned to <em class="calibre5">Precedence</em> does not mean anything. What matters is how it compares with the <em class="calibre5">Precedence</em> of other calculation groups. There cannot be two calculation groups in a model with the same <em class="calibre5">Precedence</em>.</p>
<p class="edition">Because assigning different <em class="calibre5">Precedence</em> values to multiple calculation groups is mandatory, you must pay attention making this choice when you design a model. Choosing the right <em class="calibre5">Precedence</em> upfront is important because changing the <em class="calibre5">Precedence</em> of a calculation group might affect the existing reports of a model already deployed in production. When you have multiple calculation groups in a model, you should always spend time verifying that the results of the calculations are the results expected with any combination of calculation items. The chances of making mistakes in the definition of the precedence values is quite high without proper testing and validation.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-170" class="calibre13">Including and excluding measures from calculation items</h4>
<p class="edition">There are scenarios where a calculation item implements a variation that does not make sense on all the measures. By default, a calculation item applies its effects on all the measures. Nevertheless, the developer might want to restrict which measures are affected by a calculation item.</p>
<p class="edition">One can write conditions in DAX that analyze the current measure evaluated in the model by using either <em class="calibre5">ISSELECTEDMEASURE</em> or <em class="calibre5">SELECTEDMEASURENAME</em>. For example, consider the requirement of restricting the measures affected by the <strong class="calibre7">Daily AVG</strong> calculation item so that a measure computing a percentage is not transformed into a daily average. The <em class="calibre5">ISSELECTEDMEASURE</em> function returns <em class="calibre5">True</em> if the measure evaluated by <em class="calibre5">SELECTEDMEASURE</em> is included in the list of measures specified in the arguments:</p>
<p class="codelink"><a href="#calibre_link-936" id="calibre_link-2501" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">-------------------------------------------------------</strong>
<strong class="calibre7">-- Calculation Group: 'Averages'[Averages]</strong>
<strong class="calibre7">-------------------------------------------------------</strong>

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: Daily AVG</strong>
<strong class="calibre7">--</strong>
<span type="pagebreak" id="calibre_link-3083"></span>IF (
    ISSELECTEDMEASURE (
        [Sales Amount],
        [Gross Amount],
        [Discount Amount],
        [Sales Quantity],
        [Total Cost],
        [Margin]
    ),
    DIVIDE (
        SELECTEDMEASURE (),
        COUNTROWS ( 'Date' )
    )
)</pre></div>
<p class="edition">As you can see, the code specifies the measure on which to compute the daily average, returning blank when the <strong class="calibre7">Daily AVG</strong> calculation item is applied to any other measure. Now if the requirement is just to exclude specific measures, including any other measure by default, the code can be written this way:</p>
<p class="codelink"><a href="#calibre_link-937" id="calibre_link-2502" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">-------------------------------------------------------</strong>
<strong class="calibre7">-- Calculation Group: 'Averages'[Averages]</strong>
<strong class="calibre7">-------------------------------------------------------</strong>

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: Daily AVG</strong>
<strong class="calibre7">--</strong>
IF (
    NOT ISSELECTEDMEASURE ( [Margin %] ),
    DIVIDE (
        SELECTEDMEASURE (),
        COUNTROWS ( 'Date' )
    )
)</pre></div>
<p class="edition">In both cases the <strong class="calibre7">Daily AVG</strong> calculation item excludes the calculation for the <em class="calibre5">Margin %</em> measure, as shown in <a href="#calibre_link-938" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 9-18</a>.</p>
<figure id="calibre_link-938" class="image-l">
<img src="images/000250.jpg" alt="The report shows that the Daily AVG calculation item is not applied to Margin%." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 9-18</strong> The <strong class="calibre7">Daily AVG</strong> calculation item is not applied to <em class="calibre5">Margin %</em>.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1844"></span>Another function that can be used to analyze the selected measure in a calculation item expression is <em class="calibre5">SELECTEDMEASURENAME</em>, which returns a string instead of a <em class="calibre5">Boolean</em> value. This function may be used instead of <em class="calibre5">ISSELECTEDMEASURE</em>, as in the following example:</p>
<p class="codelink"><a href="#calibre_link-939" id="calibre_link-2503" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">-------------------------------------------------------</strong>
<strong class="calibre7">-- Calculation Group: 'Averages'[Averages]</strong>
<strong class="calibre7">-------------------------------------------------------</strong>

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: Daily AVG</strong>
<strong class="calibre7">--</strong>
IF (
    NOT ( SELECTEDMEASURENAME () = "Margin %" ),
    DIVIDE (
        SELECTEDMEASURE (),
        COUNTROWS ( 'Date' )
    )
)</pre></div>
<p class="edition">The result would be the same, but the <em class="calibre5">ISSELECTEDMEASURE</em> solution is preferable for several reasons:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">If the measure name is misspelled using a comparison with <em class="calibre5">SELECTEDMEASURENAME</em>, the DAX code simply return <em class="calibre5">False</em> without raising an error.</p></li>
<li class="calibre10"><p class="listp">If the measure name is misspelled using <em class="calibre5">ISSELECTEDMEASURE</em>, the expression fails with the error <em class="calibre5">Invalid input arguments for ISSELECTEDMEASURE</em>.</p></li>
<li class="calibre10"><p class="listp">If a measure is renamed in the model, all the expressions using <em class="calibre5">ISSELECTEDMEASURE</em> are automatically renamed in the model editor (formula fixup), whereas the strings compared to <em class="calibre5">SELECTEDMEASURENAME</em> must be updated manually.</p></li>
</ul>
<p class="edition">The <em class="calibre5">SELECTEDMEASURENAME</em> function should be considered when the business logic of a calculation item must apply a transformation based on an external configuration. For example, the function might be useful when there is a table with a list of measures that should enable a behavior in a calculation item so that the model has an external configuration that can be modified without requiring an update of the DAX code.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-171" class="h2a">Understanding sideways recursion</h3>
<p class="edition">DAX calculation items do not provide full recursion. However, there is a limited form of recursion available, which is called sideways recursion. We describe this complex topic through examples. Let us start by understanding what recursion is and why it is important to discuss it. Recursion might occur when a calculation item refers to itself, leading to an infinite loop in the application of calculation items. Let us elaborate on this.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2100"></span>Consider a <em class="calibre5">Time Intelligence</em> calculation group with two calculation items defined as follows:</p>
<p class="codelink"><a href="#calibre_link-940" id="calibre_link-2504" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">-------------------------------------------------------</strong>
<strong class="calibre7">-- Calculation Group: 'Time Intelligence'[Time calc]</strong>
<strong class="calibre7">-------------------------------------------------------</strong>

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: YTD</strong>
<strong class="calibre7">--</strong>
    CALCULATE (
        SELECTEDMEASURE (),
        DATESYTD ( 'Date'[Date] )
    )

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: SPLY</strong>
<strong class="calibre7">--</strong>
    CALCULATE (
        SELECTEDMEASURE (),
        SAMEPERIODLASTYEAR ( 'Date'[Date] )
    )</pre></div>
<p class="edition">The requirement is to add a third calculation item that computes the year-to-date in the previous year (<strong class="calibre7">PYTD</strong>). As you learned in <a href="#calibre_link-13" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 8</a>, “<a href="#calibre_link-13" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Time intelligence calculations</a>,” this can be obtained by mixing two time intelligence functions: <em class="calibre5">DATESYTD</em> and <em class="calibre5">SAMEPERIODLASTYEAR</em>. The following calculation item solves the scenario:</p>
<p class="codelink"><a href="#calibre_link-941" id="calibre_link-2505" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: PYTD</strong>
<strong class="calibre7">--</strong>
    CALCULATE (
        SELECTEDMEASURE (),
        DATESYTD ( SAMEPERIODLASTYEAR ( 'Date'[Date] ) )
    )</pre></div>
<p class="edition">Given the simplicity of the calculation, this solution is already optimal. Nevertheless, as a mind challenge we can try to author the same code in a different way. Indeed, there already is a <strong class="calibre7">YTD</strong> calculation item that computes the year-to-date in place; therefore, one could think of using the calculation item instead of mixing time intelligence calculations within the same formula. Look at the following definition of the same <strong class="calibre7">PYTD</strong> calculation item:</p>
<p class="codelink"><a href="#calibre_link-942" id="calibre_link-2506" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: PYTD</strong>
<strong class="calibre7">--</strong>
    CALCULATE (
        SELECTEDMEASURE (),
        SAMEPERIODLASTYEAR ( 'Date'[Date] ),
        <strong class="calibre7">'Time Intelligence'[Time calc] = "YTD"</strong>
    )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2101"></span>The calculation item achieves the same result as the previous definition, but using a different technique. <em class="calibre5">SAMEPERIODLASTYEAR</em> moves the filter context back to the previous year, while the year-to-date calculation is obtained by applying an existing calculation item in the <em class="calibre5">Time calc</em> calculation group: <strong class="calibre7">YTD</strong>. As previously noted, in this example the code is less readable and needlessly more complex. That said, you can easily imagine that in a more complex scenario the ability to invoke previously defined calculation items might come very handy&mdash;to avoid repeating the same code multiple times in your measures.</p>
<p class="edition">This is a powerful mechanism to define complex calculations. It comes with some level of complexity that needs to be well understood: <em class="calibre5">recursion</em>. As you have seen in the <strong class="calibre7">PYTD</strong> calculation item, it is possible to define a calculation item based on another calculation item from the same calculation group. In other words, inside a calculation group certain items can be defined in terms of other items of the same calculation group. If the feature were available without any restriction, this would lead to extremely complex situations where calculation item A depends on B, which depends on C, which in turn can depend on A. The following fictitious example demonstrates the issue:</p>
<p class="codelink"><a href="#calibre_link-943" id="calibre_link-2507" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">-------------------------------------------------------</strong>
<strong class="calibre7">-- Calculation Group: Infinite[Loop]</strong>
<strong class="calibre7">-------------------------------------------------------</strong>

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: Loop A</strong>
<strong class="calibre7">--</strong>
    CALCULATE (
        SELECTEDMEASURE (),
        Infinite[Loop] = "Loop B"
    )

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: Loop B</strong>
<strong class="calibre7">--</strong>
    CALCULATE (
        SELECTEDMEASURE (),
        Infinite[Loop] = "Loop A"
    )</pre></div>
<p class="edition">If used in an expression like in the following example, DAX would not be able to apply the calculation items, because A requires the application of B, which in turn requires A, and so on:</p>
<p class="codelink"><a href="#calibre_link-944" id="calibre_link-2508" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    Infinite[Loop] = "Loop A"
)</pre></div>
<p class="edition">Some programming languages allow similar circular dependencies to be used in the definition of expressions&mdash;typically in functions&mdash;leading to <em class="calibre5">recursive definitions</em>. A recursive function definition is a definition where the function is defined in terms of itself. Recursion is extremely powerful, but it is also extremely complex for developers writing code and for the optimizer looking for the best execution path.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3084"></span>For these reasons, DAX does not allow the definition of recursive calculation items. In DAX, a developer can reference another calculation item of the same calculation group, but without referencing the same calculation item twice. In other words, it is possible to use <em class="calibre5">CALCULATE</em> to invoke a calculation item, but the calculation item invoked cannot directly or indirectly invoke the original calculation item. This feature is called sideways recursion. Its goal is not to implement full recursion; Instead, it aims at reusing complex calculation items without providing the full power (and complexity) of recursion.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">If you are familiar with the MDX language, you should be aware that MDX supports both sideways recursion and full recursion. These capabilities are part of the reasons MDX is more complex a language than DAX. Moreover, full recursion oftentimes leads to bad performance. For these reasons, DAX does not support full recursion by design.</p>
</div>
<p class="edition">Be mindful that recursion might also occur because a measure sets a filter on a calculation item, not only between calculation items. For example, consider the following definitions of measures (<em class="calibre5">Sales Amount</em>, <em class="calibre5">MA</em>, <em class="calibre5">MB</em>) and calculation items (<strong class="calibre7">A</strong> and <strong class="calibre7">B</strong>):</p>
<p class="codelink"><a href="#calibre_link-945" id="calibre_link-2509" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">--
-- Measures definition
--
Sales Amount := SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
MA := CALCULATE ( [Sales Amount], Infinite[Loop] = "A" )
MB := CALCULATE ( [Sales Amount], Infinite[Loop] = "B" )

<strong class="calibre7">-------------------------------------------------------</strong>
<strong class="calibre7">-- Calculation Group: Infinite[Loop]</strong>
<strong class="calibre7">-------------------------------------------------------</strong>

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: A</strong>
<strong class="calibre7">--</strong>
    [MB]

<strong class="calibre7">--</strong>
<strong class="calibre7">-- Calculation Item: B</strong>
<strong class="calibre7">--</strong>
    [MA]</pre></div>
<p class="edition">The calculation items do not reference each other. Instead, they reference a measure that, in turn, references the calculation items, generating an infinite loop. We can see this happening by following the calculation item application step by step. Consider the following expression:</p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    Infinite[Loop] = "A"
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3085"></span>The application of calculation item <strong class="calibre7">A</strong> produces the following result:</p>
<div class="program"><pre class="calibre14">CALCULATE (
    CALCULATE ( [MB] )
)</pre></div>
<p class="edition">However, the <em class="calibre5">MB</em> measure internally references both <em class="calibre5">Sales Amount</em> and calculation item <strong class="calibre7">B</strong>; it corresponds to the following code:</p>
<p class="codelink"><a href="#calibre_link-946" id="calibre_link-2510" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    CALCULATE (
        CALCULATE (
            [Sales Amount],
            Infinite[Loop] = "B"
        )
    )
)</pre></div>
<p class="edition">At this point, the application of calculation item <strong class="calibre7">B</strong> produces the following result:</p>
<p class="codelink"><a href="#calibre_link-947" id="calibre_link-2511" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    CALCULATE (
        CALCULATE (
            CALCULATE ( [MA] )
        )
    )
)</pre></div>
<p class="edition">Again, the <em class="calibre5">MA</em> measure internally references <em class="calibre5">Sales Amount</em> and calculation item <strong class="calibre7">A</strong>, and corresponds to the following code:</p>
<p class="codelink"><a href="#calibre_link-948" id="calibre_link-2512" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    CALCULATE (
        CALCULATE (
            CALCULATE (
                CALCULATE (
                    [Sales Amount],
                    Infinite[Loop] = "A"
                )
            )
        )
    )
)</pre></div>
<p class="edition">Now we are back to the initial expression and we potentially enter into an infinite loop of calculation items applied to the expression&mdash;although the calculation items do not reference each other. Instead, they reference a measure that, in turn, references the calculation items. The engine is smart enough to detect that, in this case, an infinite loop is present. Therefore, DAX throws an error.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1842"></span>Sideways recursion can lead to very complex expressions that are hard to read and likely to produce unexpected results. Most of the complexity of calculation items with sideways recursion is seen when there are measures that internally apply calculation items with <em class="calibre5">CALCULATE</em>&mdash;all the while users change the calculation item through the user interface of the tool, like using a slicer in Power BI.</p>
<p class="edition">Our suggestion is to limit the use of sideways recursion in your code as much as you can, though this might mean repeating the same code in multiple places. Only in hidden calculation groups can you safely rely on sideways recursion, so that they can be managed by code but not by users. Keep in mind that Power BI users can define their own measures in a report, and, unaware of a complex topic like recursion, they might generate errors without properly understanding the reason.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-172" class="h2a">Using the best practices</h3>
<p class="edition">As we said in the introduction, there are only two best practices to follow to avoid encountering issues with calculation items:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Use calculation items to modify the behavior of expressions consisting of one measure only. Never use calculation items to change the behavior of more complex expressions.</p>
<p class="codelink1"><a href="#calibre_link-949" id="calibre_link-2513" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><strong class="calibre7">--</strong>
<strong class="calibre7">--   This is a BEST PRACTICE</strong>
<strong class="calibre7">--</strong>
SalesPerWd :=
CALCULATE (
    [Sales Amount],                         -- Single measure. This is good
    'Time Intelligence'[Time calc] = "YTD"
)

<strong class="calibre7">--</strong>
<strong class="calibre7">--   This is BAD PRACTICE - do not do this!</strong>
<strong class="calibre7">--</strong>
SalesPerWd :=
CALCULATE (
    SUMX ( Customer, [Sales Amount] ),      -- Complex expression, it is not a single
    'Time Intelligence'[Time calc] = "YTD"  -- measure reference
)</pre></div></li>
<li class="calibre10"><p class="listp">Avoid using sideways recursion in any calculation group that remains public and available to users. You can safely use sideways recursion in hidden calculation groups. Still, if you use sideways recursion, pay attention not to introduce full recursion, which would produce an error as a result.</p></li>
</ul>
</section>
<section class="calibre4">
<h3 id="calibre_link-173" class="h2a">Conclusions</h3>
<p class="edition">Calculation groups are an extremely powerful tool to simplify the building of complex models. By letting the developer define variations of measures, calculation groups provide a very compact way of generating hundreds of measures without duplicating code. Moreover, users love calculation groups because they have the option of creating their own combination of calculations.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3086"></span>As a DAX developer, you should understand their power and their limitations. These are the lessons included in this chapter:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Calculation groups are sets of calculation items.</p></li>
<li class="calibre10"><p class="listp">Calculation items are variations of a measure. By using the <em class="calibre5">SELECTEDMEASURE</em> function, calculation items have the option of changing the way a calculation goes.</p></li>
<li class="calibre10"><p class="listp">A calculation item can override the expression and the format string of the current measure.</p></li>
<li class="calibre10"><p class="listp">If multiple calculation groups are being used in a model, the developer must define the order of application of the calculation items to disambiguate their behavior.</p></li>
<li class="calibre10"><p class="listp">Calculation items are applied to measure references, not to expressions. Using a calculation item to change the behavior of an expression not consisting of a single measure reference is likely to produce unexpected results. Therefore, it is a best practice to only apply calculation items to expressions made up of a single measure reference.</p></li>
<li class="calibre10"><p class="listp">A developer can use sideways recursion in the definition of a calculation item, but this suddenly increases the complexity of the whole expression. The developer should limit the use of sideways recursion to hidden calculation groups and avoid sideways recursion in calculation groups that are visible to users.</p></li>
<li class="calibre10"><p class="listp">Following the best practices is the easiest way to avoid the complexity involved in calculation groups.</p></li>
</ul>
<p class="edition">Finally, keep in mind that calculation groups are a very recent addition to the DAX language. This is a very powerful feature, and we just started discovering the many uses of calculation groups. We will update the web page mentioned in the introduction of this chapter with references to new articles and blog posts where you can continue to learn about calculation groups.</p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-950">
<div id="calibre_link-3087" class="calibre2">
<div id="calibre_link-3088" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-15"><span type="pagebreak" id="calibre_link-2038"></span><span class="pd_ash">Chapter 10</span><br class="calibre3" />Working with the filter context</h2>
<p class="edition">In the previous chapters you learned how to create filter contexts to perform advanced calculations. For example, in the time intelligence chapter, you learned how to mix time intelligence calculations to provide a comparison of different periods. In <a href="#calibre_link-14" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 9</a>, “<a href="#calibre_link-14" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Calculation groups</a>,” you learned how to simplify the user experience and the DAX code using calculation groups. In this chapter, you learn many functions that read the state of the current filter context, in order to change the behavior of your formulas according to existing selections and filters. These functions, though powerful, are not frequently used. Nevertheless, a correct understanding of these functions is needed to create measures that work well in different reports rather than just in the report where they were used the first time.</p>
<p class="edition">A formula might work or not depending on how the filter context is set. For example, you might write a formula that works correctly at the month level but returns an inaccurate result at the year level. Another example would be the ranking of a customer against all other customers. That formula works if a single customer is selected in the filter context, but it would return an incorrect result if multiple customers were visible. Therefore, a measure designed to work in any report should inspect the filter context prior to returning a value. If the filter context satisfies the requirements of the formula, then it can return a meaningful value. Otherwise, if the filter context contains filters that are not compatible with the code, then returning a blank is a better choice.</p>
<p class="edition">Be mindful that no formula should ever return an incorrect value. It is always better to return no value than to compute an incorrect value. Users are expected to be able to browse your model without any previous knowledge of the internals of the code. As a DAX author, you are responsible for making sure your code works in any situation.</p>
<p class="edition">For each function introduced in this chapter, we show several scenarios where it might be useful and logical to use the function itself. But your scenario is surely different from any of our examples. Thus, when reading about these functions, try to figure out how they could improve the features of your model.</p>
<p class="edition">Besides, in this chapter we also introduce two important concepts: data lineage and the <em class="calibre5">TREATAS</em> function. Data lineage is an intuitive concept you have been using so far without a complete explanation. In this chapter we go deeper, describing its behavior and several scenarios where it is useful to consider it.</p>
<section class="calibre4">
<h3 id="calibre_link-174" class="h2a"><span type="pagebreak" id="calibre_link-2041"></span>Using <em class="calibre5">HASONEVALUE</em> and <em class="calibre5">SELECTEDVALUE</em></h3>
<p class="edition">As outlined in the introduction, many calculations provide meaningful values based on the current selection. Nevertheless, the same calculation on a different selection provides incorrect figures. As an example, look at the following formula computing a simple quarter-to-date (QTD) of the sales amount:</p>
<p class="codelink"><a href="#calibre_link-951" id="calibre_link-2515" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">QTD Sales :=
CALCULATE (
    [Sales Amount],
    DATESQTD ( 'Date'[Date] )
)</pre></div>
<p class="edition">As you can see in <a href="#calibre_link-952" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-1</a>, the code works well for months and quarters, but at the year level (CY 2007) it produces a result stating that the QTD value of <em class="calibre5">Sales Amount</em> for 2017 is 2,731,424.16.</p>
<figure id="calibre_link-952" class="image-l">
<img src="images/000347.jpg" alt="In the report, the QTD value at the year level is not a sum over the whole year." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-1</strong> <em class="calibre5">QTD Sales</em> reports values at the year level too, but the numbers might confuse some users.</figcaption>
</figure>
<p class="edition">Actually, the value reported by <em class="calibre5">QTD Sales</em> at the year level is the value of the last quarter of the year, which corresponds to the <em class="calibre5">QTD Sales</em> value of December. One might argue that&mdash;at the year level&mdash;the value of QTD does not make sense. To be correct, the value should not appear at the quarter level. Indeed, a QTD aggregation makes sense at the month level and below, but not starting at the quarter level and above. In other words, the formula should report the value of QTD at the month level and blank the value otherwise.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3089"></span>In such a scenario, the function <em class="calibre5">HASONEVALUE</em> becomes useful. For example, to remove the total at the quarter level and above, it is enough to detect multiple months selected. This is the case at the year and quarter levels, whereas at the month level there is only one month selected. Thus, protecting the code with an <em class="calibre5">IF</em> statement provides the desired behavior. The following code does the job:</p>
<p class="codelink"><a href="#calibre_link-953" id="calibre_link-2516" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">QTD Sales :=
IF (
    HASONEVALUE ( 'Date'[Month] ),
    CALCULATE (
        [Sales Amount],
        DATESQTD ( 'Date'[Date] )
    )
)</pre></div>
<p class="edition">The result of this new formula is visible in <a href="#calibre_link-954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-2</a>.</p>
<figure id="calibre_link-954" class="image-l">
<img src="images/000355.jpg" alt="In the report, QTD Sales only shows values at the month level. Quarter and year level values are blank." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-2</strong> Protecting <em class="calibre5">QTD Sales</em> with <em class="calibre5">HASONEVALUE</em> lets you blank undesired values.</figcaption>
</figure>
<p class="edition">This first example is already an important one. Instead of just leaving the calculation “as is,” we decided to go one step further and question exactly “when” the calculation produces a value that makes sense. If it turns out that a certain formula does not produce accurate results in a filter context, it is better to verify whether the filter context satisfies the minimum requirements and operate accordingly.</p>
<p class="edition">In <a href="#calibre_link-12" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 7</a>, “<a href="#calibre_link-12" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with iterators and with <em class="calibre5">CALCULATE</em></a>,” you saw a similar scenario when you learned about the <em class="calibre5">RANKX</em> function. There, we had to produce a ranking of the current customer against all other customers, and we used <em class="calibre5">HASONEVALUE</em> to guarantee that such ranking is only produced when a single customer is selected in the current filter context.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3090"></span>Time intelligence is a scenario where <em class="calibre5">HASONEVALUE</em> is frequently used because many aggregations&mdash;like YTD, for example&mdash;only make sense when the filter context is filtering one quarter, one month, or one specific time period. In all other cases, the formula should avoid returning a value and should return <em class="calibre5">BLANK</em> instead.</p>
<p class="edition">Another common scenario where <em class="calibre5">HASONEVALUE</em> is useful is to extract one selected value from the filter context. There used to be many scenarios where this could be useful, but with the advent of calculation groups, their number is much lower. We will describe a scenario performing some sort of what-if analysis. In such a case, the developer typically builds a parameter table that lets the user select one value through a slicer; then, the code uses this parameter to adjust the calculation.</p>
<p class="edition">For example, consider evaluating the sales amount by adjusting the values of previous years based on the inflation rate. In order to perform the analysis, the report lets the user select a yearly inflation rate that should be used from each transaction date up to today. The inflation rate is a parameter of the algorithm. A solution to this scenario is to build a table with all the values that a user can select. In our example, we created a table with all the values from 0% to 20% with a step of 0.5%, obtaining the table you can partially see in <a href="#calibre_link-955" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-3</a>.</p>
<figure id="calibre_link-955" class="image-l">
<img src="images/000363.jpg" alt="The table contains the values for inflation." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-3</strong> <em class="calibre5">Inflation</em> contains all the values between 0% and 20% with a step of 0.5%.</figcaption>
</figure>
<p class="edition">The user selects the desired value with a slicer; then the formula needs to apply the selected inflation rate for all the years from the transaction date up to the current date. If the user does not perform a selection or if they select multiple values, then the formula should use a default inflation rate of 0% to report the actual sales amount.</p>
<p class="edition">The final report looks like the one in <a href="#calibre_link-956" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-4</a>.</p>
<figure id="calibre_link-956" class="image-l">
<img src="images/000370.jpg" alt="The figure shows Sales Amount and Inflation Adjusted Sales, with the slicer at the top for inflation rate. At the top is the year of the report." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3091"></span><strong class="calibre7">Figure 10-4</strong> The <em class="calibre5">Inflation</em> parameter controls the multiplier of previous years.</figcaption>
</figure>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The What-If parameter feature in Power BI generates a table and a slicer using the same technique described here.</p>
</div>
<p class="edition">There are several interesting notes about this report:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">A user can select the inflation rate to apply through the top-left slicer.</p></li>
<li class="calibre10"><p class="listp">The report shows the year used to perform the adjustment, reporting the year of the last sale in the data model in the top-right label.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Inflation Adjusted Sales</em> multiplies the sales amount of the given year by a factor that depends on the user-selected inflation.</p></li>
<li class="calibre10"><p class="listp">At the grand total level, the calculation needs to apply a different multiplier to each year.</p></li>
</ul>
<p class="edition">The code for the reporting year label is the simplest calculation in the report; it only needs to retrieve the year of the maximum order date from the <em class="calibre5">Sales</em> table:</p>
<p class="codelink"><a href="#calibre_link-957" id="calibre_link-2517" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Reporting year := "Reporting year: " &amp; YEAR ( MAX ( Sales[Order Date] ) )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2042"></span>Similarly, one could retrieve the selected user inflation by using <em class="calibre5">MIN</em> or <em class="calibre5">MAX</em>, because when the user filters one value with the slicer, both <em class="calibre5">MIN</em> and <em class="calibre5">MAX</em> return the same value&mdash;that is, the only value selected. Nevertheless, a user might make an invalid selection by filtering multiple values or by applying no filter at all. In that case, the formula needs to behave correctly and still provide a default value.</p>
<p class="edition">Thus, a better option is to check with <em class="calibre5">HASONEVALUE</em> whether the user has actively filtered a single value with the slicer, and have the code behave accordingly to the <em class="calibre5">HASONEVALUE</em> result:</p>
<p class="codelink"><a href="#calibre_link-958" id="calibre_link-2518" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">User Selected Inflation :=
IF (
    HASONEVALUE ( 'Inflation Rate'[Inflation] ),
    VALUES ( 'Inflation Rate'[Inflation] ),
    0
)</pre></div>
<p class="edition">Because this pattern is very common, DAX also offers an additional choice. The <em class="calibre5">SELECTEDVALUE</em> function provides the behavior of the previous code in a single function call:</p>
<p class="codelink"><a href="#calibre_link-959" id="calibre_link-2519" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">User Selected Inflation := SELECTEDVALUE ( 'Inflation Rate'[Inflation], 0 )</pre></div>
<p class="edition"><em class="calibre5">SELECTEDVALUE</em> has two arguments. The second argument is the default returned in case there is more than one element selected in the column passed as the first argument.</p>
<p class="edition">Once the <em class="calibre5">User Selected Inflation</em> measure is in the model, one needs to compute the multiplier for the selected year. If the last year in the model is considered the year to use for the adjustment, then the multiplier needs to iterate over all the years between the last year and the selected year performing the multiplication of <em class="calibre5">1+Inflation</em> for each year:</p>
<p class="codelink"><a href="#calibre_link-960" id="calibre_link-2520" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Inflation Multiplier :=
VAR ReportingYear =
    YEAR ( CALCULATE ( MAX ( Sales[Order Date] ), ALL ( Sales ) ) )
VAR CurrentYear =
    SELECTEDVALUE ( 'Date'[Calendar Year Number] )
VAR Inflation = [User Selected Inflation]
VAR Years =
    FILTER (
        ALL ( 'Date'[Calendar Year Number] ),
        AND (
            'Date'[Calendar Year Number] &gt;= CurrentYear,
            'Date'[Calendar Year Number] &lt; ReportingYear
        )
    )
VAR Multiplier =
    MAX ( PRODUCTX ( Years, 1 + Inflation ), 1 )
RETURN
    Multiplier</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2043"></span>The last step is to use the multiplier on a year-by-year basis. Here is the code of <em class="calibre5">Inflation Adjusted Sales</em>:</p>
<p class="codelink"><a href="#calibre_link-961" id="calibre_link-2521" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Inflation Adjusted Sales :=
SUMX (
    VALUES ( 'Date'[Calendar Year] ),
    [Sales Amount] * [Inflation Multiplier]
)</pre></div>
</section>
<section class="calibre4">
<h3 id="calibre_link-175" class="h2a">Introducing <em class="calibre5">ISFILTERED</em> and <em class="calibre5">ISCROSSFILTERED</em></h3>
<p class="edition">Sometimes the goal is not to gather a single value from the filter context; instead, the goal is to check whether a column or a table has an active filter on it. The reason one might want to check for the presence of a filter is usually to verify that all the values of a column are currently visible. In the presence of a filter, some values might be hidden and the number&mdash;at that point&mdash;might be inaccurate.</p>
<p class="edition">A column might be filtered because there is a filter applied to it or because some other column is being filtered, and therefore there is an indirect filter on the column. We can elaborate on this with a simple example:</p>
<p class="codelink"><a href="#calibre_link-962" id="calibre_link-2522" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">RedColors :=
CALCULATE (
    [Sales Amount],
    'Product'[Color] = "Red"
)</pre></div>
<p class="edition">During the evaluation of <em class="calibre5">Sales Amount</em>, the outer <em class="calibre5">CALCULATE</em> applies a filter on the <em class="calibre5">Product[Color]</em> column. Consequently, <em class="calibre5">Product[Color]</em> is filtered. There is a specific function in DAX that checks whether a column is filtered or not: <em class="calibre5">ISFILTERED</em>. <em class="calibre5">ISFILTERED</em> returns <em class="calibre5">TRUE</em> or <em class="calibre5">FALSE</em>, depending on whether the column passed as an argument has a direct filter on it or not. When <em class="calibre5">ISFILTERED</em> receives a table as an argument, it returns <em class="calibre5">TRUE</em> if any columns of the table are being filtered directly; otherwise, it returns <em class="calibre5">FALSE</em>.</p>
<p class="edition">Although the filter is on <em class="calibre5">Product[Color]</em>, all the columns of the <em class="calibre5">Product</em> table are indirectly filtered. For example, the <em class="calibre5">Brand</em> column only shows the brands that have at least one red product. Any brand with no red products will not be visible because of the filter on the color column. Apart from <em class="calibre5">Product[Color]</em>, all the other columns of the <em class="calibre5">Product</em> table have no direct filter. Nevertheless, their visible values are limited. Indeed, all the columns of <em class="calibre5">Product</em> are cross-filtered. A column is cross-filtered if there is a filter that may reduce its set of visible values, either a direct or an indirect filter. The function to use to check whether a column is cross-filtered or not is <em class="calibre5">ISCROSSFILTERED</em>.</p>
<p class="edition">It is important to note that if a column is filtered, it is also cross-filtered. The opposite does not hold true: A column can be cross-filtered even though it is not filtered. Moreover, <em class="calibre5">ISCROSSFILTERED</em> works <span type="pagebreak" id="calibre_link-2044"></span>either with a column or with a table. Indeed, whenever any column of a table is cross-filtered, all the remaining columns of the table are cross-filtered too. Therefore, <em class="calibre5">ISCROSSFILTERED</em> should be used with a table rather than with a column. You might still find <em class="calibre5">ISCROSSFILTERED</em> used with a column because&mdash;originally&mdash;<em class="calibre5">ISCROSSFILTERED</em> used to only work with columns. Only later was <em class="calibre5">ISCROSSFILTERED</em> introduced for tables. Thus, some old code might still only use <em class="calibre5">ISCROSSFILTERED</em> with a column.</p>
<p class="edition">Because filters work over the entire data model, a filter on the <em class="calibre5">Product</em> table also affects the related tables. Thus, the filter on <em class="calibre5">Product[Color]</em> applies its effect to the <em class="calibre5">Sales</em> table too. Therefore, any column in the <em class="calibre5">Sales</em> table is cross-filtered by the filter on <em class="calibre5">Product[Color]</em>.</p>
<p class="edition">To demonstrate the behavior of these functions, we used a slightly different model than the usual model used in the rest of the book. We removed some tables, and we upgraded the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em> using bidirectional cross-filtering. You can see the resulting model in <a href="#calibre_link-963" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-5</a>.</p>
<figure id="calibre_link-963" class="image-l">
<img src="images/000378.jpg" alt="The figure shows the data model, with a bidirectional relationship between Product and Sales." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-5</strong> In this model the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em> is bidirectional.</figcaption>
</figure>
<p class="edition">In this model, we authored this set of measures:</p>
<p class="codelink"><a href="#calibre_link-964" id="calibre_link-2523" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Filter Gender := ISFILTERED ( Customer[Gender] )
Cross Filter Customer := ISCROSSFILTERED ( Customer )
Cross Filter Sales := ISCROSSFILTERED ( Sales )
Cross Filter Product := ISCROSSFILTERED ( 'Product' )
Cross Filter Store := ISCROSSFILTERED ( Store )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3092"></span>Finally, we projected all the measures in a matrix with <em class="calibre5">Customer[Continent]</em> and <em class="calibre5">Customer[Gender]</em> on the rows. You can see the result in <a href="#calibre_link-965" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-6</a>.</p>
<figure id="calibre_link-965" class="image-l">
<img src="images/000386.jpg" alt="The report shows each of the measures, per continent and per gender. The results are either True or False." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-6</strong> The matrix shows the behavior of <em class="calibre5">ISFILTERED</em> and <em class="calibre5">ISCROSSFILTERED</em>.</figcaption>
</figure>
<p class="edition">Here are a few considerations about the results:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">Customer[Gender]</em> is only filtered on the rows where there is an active filter on <em class="calibre5">Customer[Gender]</em>. At the subtotal level&mdash;where the filter is only on <em class="calibre5">Customer[Continent]</em>&mdash;the column is not filtered.</p></li>
<li class="calibre10"><p class="listp">The entire <em class="calibre5">Customer</em> table is cross-filtered when there is a filter on either <em class="calibre5">Customer[Continent]</em> or <em class="calibre5">Customer[Gender]</em>.</p></li>
<li class="calibre10"><p class="listp">The same applies to the <em class="calibre5">Sales</em> table. The presence of a filter on any column of the <em class="calibre5">Customer</em> table applies a cross-filter on the <em class="calibre5">Sales</em> table because <em class="calibre5">Sales</em> is on the many-side of a many-to-one relationship with <em class="calibre5">Customer</em>.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Store</em> is not cross-filtered because the filter on <em class="calibre5">Sales</em> does not propagate to <em class="calibre5">Customer</em>. Indeed, the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Store</em> is unidirectional, so the filter does not propagate from <em class="calibre5">Sales</em> to <em class="calibre5">Store</em>.</p></li>
<li class="calibre10"><p class="listp">Because the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em> is bidirectional, then the filter on <em class="calibre5">Sales</em> propagates to <em class="calibre5">Product</em>. Therefore, <em class="calibre5">Product</em> is cross-filtered by any filter in other tables of this data model.</p></li>
</ul>
<p class="edition"><em class="calibre5">ISFILTERED</em> and <em class="calibre5">ISCROSSFILTERED</em> are not frequently used in DAX expressions. They are used when performing advanced optimization by checking the set of filters on a column&mdash;to make the code follow different paths depending on the filters. Another common scenario is when working with hierarchies, as we will show in <a href="#calibre_link-16" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 11</a>, “<a href="#calibre_link-16" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Handling hierarchies</a>.”</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2040"></span>Beware that one cannot rely on the presence of a filter to determine whether all the values of a column are visible. In fact, a column can be both filtered and cross-filtered but still show all the values. A simple measure demonstrates this:</p>
<p class="codelink"><a href="#calibre_link-966" id="calibre_link-2524" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Test :=
CALCULATE (
    ISFILTERED ( Customer[City] ),
    Customer[City] &lt;&gt; "DAX"
)</pre></div>
<p class="edition">There is no city named DAX in the <em class="calibre5">Customer</em> table. Thus, the filter does not have any effect on the <em class="calibre5">Customer</em> table because it shows all the rows. Therefore, <em class="calibre5">Customer[City]</em> shows all the possible values of the column, even though a filter is active on the same column and the <em class="calibre5">Test</em> measure returns <em class="calibre5">TRUE</em>.</p>
<p class="edition">To check whether all the possible values are visible in a column or in a table, the best option is to count the rows under different contexts. In this case, there are some important details to learn, which we discuss in the following sections.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-176" class="h2a">Understanding differences between <em class="calibre5">VALUES</em> and <em class="calibre5">FILTERS</em></h3>
<p class="edition"><em class="calibre5">FILTERS</em> is a function like <em class="calibre5">VALUES</em>, with one important difference. <em class="calibre5">VALUES</em> returns the values visible in the filter context; <em class="calibre5">FILTERS</em> returns the values that are currently being filtered by the filter context.</p>
<p class="edition">Although the two descriptions look the same, they are not. Indeed, one might filter four product colors with a slicer, say Black, Brown, Azure, and Blue. Imagine that because of other filters in the filter context, only two of them are visible in the data if the other two are not used in any product. In that scenario, <em class="calibre5">VALUES</em> returns two colors, whereas <em class="calibre5">FILTER</em> returns all the filtered four. An example is useful to clarify this concept.</p>
<p class="edition">For this example, we use an Excel file connected to a Power BI model. The reason is that&mdash;at the time of writing&mdash;<em class="calibre5">FILTERS</em> does not work as expected when used by <em class="calibre5">SUMMARIZECOLUMNS</em>, which is the function used by Power BI to query the model. Thus, the example would not work in Power BI.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Microsoft is aware of the issue of using <em class="calibre5">FILTERS</em> in Power BI, and it is possible that this problem will be solved in the future. However, for illustrating the concept in this book, we had to use Excel as a client because Excel does not leverage <em class="calibre5">SUMMARIZECOLUMNS</em>.</p>
</div>
<p class="edition">In <a href="#calibre_link-12" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 7</a> we demonstrated how to use <em class="calibre5">CONCATENATEX</em> to show a label in a report indicating the colors selected through a slicer. There, we ended up with a complex formula useful to demonstrate the usage of iterators and variables. Here, we recall the simpler version of that code for your convenience:</p>
<p class="codelink"><a href="#calibre_link-967" id="calibre_link-2525" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-3093"></span>Selected Colors :=
"Showing " &amp;
CONCATENATEX (
    VALUES ( 'Product'[Color] ),
    'Product'[Color],
    ", ",
    'Product'[Color],
    ASC
) &amp; " colors."</pre></div>
<p class="edition">Consider a report with two slicers: one slicer filters only one category, and the other slicer filters several colors, as shown in <a href="#calibre_link-968" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-7</a>.</p>
<figure id="calibre_link-968" class="image-l">
<img src="images/000401.jpg" alt="In this report one slicer filters TV and Video; the other filters black, brown, azure, and blue. The figure indicates that it is only showing black and brown colors." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-7</strong> Although there are four colors selected, the <em class="calibre5">Selected Colors</em> measure only shows two of them.</figcaption>
</figure>
<p class="edition">Though there are four colors selected in the slicer, the <em class="calibre5">Selected Colors</em> measure only returns two of them. The reason is that <em class="calibre5">VALUES</em> returns the values of a column under the current filter context. There are no TV and Video products which are either blue or azure. Thus, even though the filter context is filtering four colors, <em class="calibre5">VALUES</em> only returns two of them.</p>
<p class="edition">If the measure is changed to use <em class="calibre5">FILTERS</em> instead of <em class="calibre5">VALUES</em>, then <em class="calibre5">FILTERS</em> returns the filtered values, regardless of whether there is any product in the current filter context representing those values:</p>
<p class="codelink"><a href="#calibre_link-969" id="calibre_link-2526" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Selected Colors :=
"Showing " &amp;
CONCATENATEX (
    <strong class="calibre7">FILTERS ( 'Product'[Color] ),</strong>
    'Product'[Color],
    ", ",
    'Product'[Color],
    ASC
) &amp; " colors."</pre></div>
<p class="edition">With this new version of <em class="calibre5">Selected Colors</em>, now the report shows all four colors as the selected ones, as you can see in <a href="#calibre_link-970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-8</a>.</p>
<figure id="calibre_link-970" class="image-l">
<img src="images/000004.jpg" alt="In this figure, the report indicates that it shows azure, black, blue, and brown." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1690"></span><strong class="calibre7">Figure 10-8</strong> Using <em class="calibre5">FILTERS</em>, the <em class="calibre5">Selected Colors</em> measure now returns all four selected colors.</figcaption>
</figure>
<p class="edition">Similar to <em class="calibre5">HASONEVALUE</em>, DAX also offers a function to check whether a column only has one active filter: <em class="calibre5">HASONEFILTER</em>. Its use and syntax are similar to that of <em class="calibre5">HASONEVALUE</em>. The only difference is that <em class="calibre5">HASONEFILTER</em> might return <em class="calibre5">TRUE</em> when there is a single filter active, and at the same time <em class="calibre5">HASONEVALUE</em> returns <em class="calibre5">FALSE</em> because the value, although filtered, is not part of the visible values.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-177" class="h2a">Understanding the difference between <em class="calibre5">ALLEXCEPT</em> and <em class="calibre5">ALL</em>/<em class="calibre5">VALUES</em></h3>
<p class="edition">In a previous section we introduced <em class="calibre5">ISFILTERED</em> and <em class="calibre5">ISCROSSFILTERED</em> to check for the presence of a filter. The presence of a filter is not enough to verify that all the values of a column&mdash;or of a table&mdash;are visible. A better option is to count the number of rows in the current filter context and check it against the count of all the rows without any filter.</p>
<p class="edition">As an example, look at <a href="#calibre_link-971" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-9</a>. The <em class="calibre5">Filtered Gender</em> measure checks for <em class="calibre5">ISFILTERED</em> on the <em class="calibre5">Customer[Gender]</em> column, whereas <em class="calibre5">NumOfCustomers</em> simply counts the number of rows in the <em class="calibre5">Customer</em> table:</p>
<p class="codelink"><a href="#calibre_link-972" id="calibre_link-2527" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NumOfCustomers := COUNTROWS ( Customer )</pre></div>
<figure id="calibre_link-971" class="image-l">
<img src="images/000424.jpg" alt="This report shows Filtered Gender and NumOfCustomers per customer type: companies and people." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-9</strong> Even though <em class="calibre5">Customer[Gender]</em> is filtered, all the customers are visible.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3094"></span>You can observe that whenever a customer is a company, as expected the gender is always a blank value. In the second row of the matrix, the filter on <em class="calibre5">Gender</em> is active; indeed, <em class="calibre5">Filtered Gender</em> returns <em class="calibre5">TRUE</em>. At the same time, the filter does not really filter anything because there is only one possible <em class="calibre5">Gender</em> value, and it is visible.</p>
<p class="edition">The presence of a filter does not imply that the table is actually filtered. It only states that a filter is active. To check whether all the customers are visible or not, it is better to rely on a simple count. Checking that the number of customers with and without the filter on <em class="calibre5">Gender</em> is the same helps identify that, although active, the filter is not effective.</p>
<p class="edition">When performing such calculations, one should pay attention to the details of the filter context and of the behavior of <em class="calibre5">CALCULATE</em>. There are two possible ways of checking the same condition:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Counting the customers of <em class="calibre5">ALL</em> genders.</p></li>
<li class="calibre10"><p class="listp">Counting the customers with the same customer type (<em class="calibre5">Company</em> or <em class="calibre5">Person</em>).</p></li>
</ul>
<p class="edition">Even though in the report of <a href="#calibre_link-971" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-9</a> the two calculations return the same value, if one changes the columns used in the matrix, they compute different results. Besides, both calculations have pros and cons; these are worth learning because they might be useful in several scenarios. We start from the first and easiest one:</p>
<p class="codelink"><a href="#calibre_link-973" id="calibre_link-2528" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">All Gender :=
CALCULATE (
    [NumOfCustomers],
    ALL ( Customer[Gender] )
)</pre></div>
<p class="edition"><em class="calibre5">ALL</em> removes the filter on the <em class="calibre5">Gender</em> column, leaving all the remaining filters in place. As a result, it computes the number of customers in the current filter, regardless of the gender. In <a href="#calibre_link-974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-10</a> you can see the result, along with the <em class="calibre5">All customers visible</em> measure that compares the two counts.</p>
<figure id="calibre_link-974" class="image-l">
<img src="images/000433.jpg" alt="The report shows Filtered Gender, NumOfCustomers, All Gender, and All customers visible for each customer type." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-10</strong> On the second row, <em class="calibre5">All customers visible</em> returns <em class="calibre5">True</em>, even though <em class="calibre5">Gender</em> is filtered.</figcaption>
</figure>
<p class="edition"><em class="calibre5">All Gender</em> is a measure that works well. However, it has the disadvantage of hardcoding in the measure the fact that it only removes the filter from <em class="calibre5">Gender</em>. For example, using the same measure on a matrix that slices by <em class="calibre5">Continent</em>, the result is not the desired one. You see this in <a href="#calibre_link-975" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-11</a> where the <em class="calibre5">All customers visible</em> measure is always <em class="calibre5">TRUE</em>.</p>
<figure id="calibre_link-975" class="image-l">
<img src="images/000441.jpg" alt="In this report, All customers visible is always True." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1677"></span><strong class="calibre7">Figure 10-11</strong> Filtering by continent, <em class="calibre5">All customers visible</em> returns incorrect results.</figcaption>
</figure>
<p class="edition">Beware that the measure is not incorrect. It computes the value correctly, but it only works if the report is slicing by gender. To obtain a measure that is independent from the <em class="calibre5">Gender</em>, then the path to follow is the other one: removing all the filters from the <em class="calibre5">Customer</em> table except for the <em class="calibre5">Customer Type</em> column.</p>
<p class="edition">Removing all the filters but one looks like a simple operation. However, it hides a trap that you should be aware of. As a matter of fact, the first function that comes to a student’s mind is <em class="calibre5">ALLEXCEPT</em>. Unfortunately, <em class="calibre5">ALLEXCEPT</em> might return unexpected results in this scenario. Consider the following formula:</p>
<p class="codelink"><a href="#calibre_link-976" id="calibre_link-2529" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AllExcept Type :=
CALCULATE (
    [NumOfCustomers],
    ALLEXCEPT ( Customer, Customer[Customer Type] )
)</pre></div>
<p class="edition"><em class="calibre5">ALLEXCEPT</em> removes all the existing filters from the <em class="calibre5">Customer</em> table except for the <em class="calibre5">Customer Type</em> column. When used in the previous report, it computes a correct result, as shown in <a href="#calibre_link-977" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-12</a>.</p>
<figure id="calibre_link-977" class="image-l">
<img src="images/000448.jpg" alt="In this report, NumOfCustomers, AllExcept Type, and All customers visible reported per continent per customer type are all accurate." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-12</strong> <em class="calibre5">ALLEXCEPT</em> removes the dependency from the gender; it works with any column.</figcaption>
</figure>
<p class="edition">The measure does not only work with the <em class="calibre5">Continent</em>. By replacing the continent with the gender in the report, it still produces a correct result, as shown in <a href="#calibre_link-978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-13</a>.</p>
<figure id="calibre_link-978" class="image-l">
<img src="images/000455.jpg" alt="This time, the measures are reported per gender per customer type. The results are accurate." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1691"></span><strong class="calibre7">Figure 10-13</strong> <em class="calibre5">ALLEXCEPT</em> works with the gender too.</figcaption>
</figure>
<p class="edition">Despite the report being accurate, there is a hidden trap in the formula. The <em class="calibre5">ALL*</em> functions, when used as filter arguments in <em class="calibre5">CALCULATE</em>, act as <em class="calibre5">CALCULATE</em> modifiers. This is explained in <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>, “<a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em></a>.” These modifiers do not return a table that is used as a filter. Instead, they only remove filters from the filter context.</p>
<p class="edition">Focus your attention on the row with a blank gender. There are 385 customers in this group: All of them are companies. If one removes the <em class="calibre5">Customer Type</em> column from the report, the only remaining column in the filter context is the gender. When the gender shows the blank row, we know that only companies are visible in the filter context. Nevertheless, <a href="#calibre_link-979" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-14</a> is surprising because it shows the same value for all the rows in the report; this value is the total number of customers.</p>
<figure id="calibre_link-979" class="image-l">
<img src="images/000463.jpg" alt="In this report, AllExcept Type always displays the total number of customers." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-14</strong> <em class="calibre5">ALLEXCEPT</em> produces unexpected values if the customer type is not part of the report.</figcaption>
</figure>
<p class="edition">Here is a caveat: <em class="calibre5">ALLEXCEPT</em> removed all the filters from the <em class="calibre5">Customer</em> table apart from the filter on the customer type. However, there is no filter on the customer type to retain. Indeed, the only filter in the filter context is the filter on the <em class="calibre5">Gender</em>, which <em class="calibre5">ALLEXCEPT</em> removes.</p>
<p class="edition"><em class="calibre5">Customer Type</em> is cross-filtered, but it is not filtered. As a result, <em class="calibre5">ALLEXCEPT</em> has no filter to retain and its net effect is the same as an <em class="calibre5">ALL</em> on the customer table. The correct way of expressing this condition is by using a pair of <em class="calibre5">ALL</em> and <em class="calibre5">VALUES</em> instead of <em class="calibre5">ALLEXCEPT</em>. Look at the following formula:</p>
<p class="codelink"><a href="#calibre_link-980" id="calibre_link-2530" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">All Values Type :=
CALCULATE (
    [NumOfCustomers],
    ALL ( Customer ),
    VALUES ( Customer[Customer Type] )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1678"></span>Though similar to the previous definition, its semantics are different. <em class="calibre5">ALL</em> removes any filter from the <em class="calibre5">Customer</em> table. <em class="calibre5">VALUES</em> evaluates the values of <em class="calibre5">Customer[Customer Type]</em> in the current filter context. There is no filter on the customer type, but customer type is cross-filtered. Therefore, <em class="calibre5">VALUES</em> only returns the values visible in the current filter context, regardless of which column is generating the filter that is cross-filtering the customer type. You can see the result in <a href="#calibre_link-981" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-15</a>.</p>
<figure id="calibre_link-981" class="image-l">
<img src="images/000470.jpg" alt="In this report, All Values Type returns the anticipated result." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-15</strong> Using <em class="calibre5">ALL</em> and <em class="calibre5">VALUES</em> together produces the desired result.</figcaption>
</figure>
<p class="edition">The important lesson here is that there is a big difference between using <em class="calibre5">ALLEXCEPT</em> and using <em class="calibre5">ALL</em> and <em class="calibre5">VALUES</em> together as filter arguments in <em class="calibre5">CALCULATE</em>. The reason is that the semantic of an <em class="calibre5">ALL*</em> function is always that of removing filters. <em class="calibre5">ALL*</em> functions never add filters to the context; they can only remove them.</p>
<p class="edition">The difference between the two behaviors, adding filters or removing filters, is not relevant in many scenarios. Nevertheless, there are situations where this difference has a strong impact, like in the previous example.</p>
<p class="edition">This, along with many other examples in this book, shows that DAX requires you to be very precise in the definition of your code. Using a function like <em class="calibre5">ALLEXCEPT</em> without thinking carefully about all the implications might result in your code producing unexpected values. DAX hides a lot of its complexity by providing intuitive behaviors in most situations. Nevertheless, the complexity, although hidden, is still there. One should understand the behaviors of filter contexts and <em class="calibre5">CALCULATE</em> well in order to master DAX.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-178" class="h2a">Using <em class="calibre5">ALL</em> to avoid context transition</h3>
<p class="edition">By now, at this point in the book our readers have a solid understanding of context transition. It is an extremely powerful feature, and we have leveraged it many times to compute useful values. Nevertheless, sometimes it is useful to avoid it or at least to mitigate its effects. To avoid the effects of the context transition, the <em class="calibre5">ALL*</em> functions are the tools to use.</p>
<p class="edition">It is important to remember that when <em class="calibre5">CALCULATE</em> performs its operations, it executes each step in a precise order: The filter arguments are evaluated first, then the context transition happens if there are row contexts, then the <em class="calibre5">CALCULATE</em> modifiers are applied, and finally <em class="calibre5">CALCULATE</em> applies the result of the filter arguments to the filter context. You can leverage this order of execution noting that <span type="pagebreak" id="calibre_link-3095"></span><em class="calibre5">CALCULATE</em> modifiers&mdash;among which we count the <em class="calibre5">ALL*</em> functions&mdash;are applied after the context transition. Because of this, a filter modifier has the option of overriding the effect of the context transition.</p>
<p class="edition">For example, consider the following piece of code:</p>
<p class="codelink"><a href="#calibre_link-982" id="calibre_link-2531" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SUMX (
    Sales,
    CALCULATE (
        ...,
        ALL ( Sales )
    )
)</pre></div>
<p class="edition"><em class="calibre5">CALCULATE</em> runs in the row context generated by <em class="calibre5">SUMX</em>, which is iterating over <em class="calibre5">Sales</em>. As such, it should perform a context transition. Because <em class="calibre5">CALCULATE</em> is invoked with a modifier&mdash;that is <em class="calibre5">ALL ( Sales )</em>&mdash;the DAX engine knows that any filter on the <em class="calibre5">Sales</em> table should be removed.</p>
<p class="edition">When we described the behavior of <em class="calibre5">CALCULATE</em>, we said that <em class="calibre5">CALCULATE</em> first performs context transition (that is, it filters all the columns in <em class="calibre5">Sales</em>) and then uses <em class="calibre5">ALL</em> to remove those filters. Nevertheless, the DAX optimizer is smarter than that. Because it knows that <em class="calibre5">ALL</em> removes any filter from <em class="calibre5">Sales</em>, it also knows that it would be totally useless to apply a filter and then remove it straight after. Thus, the net effect is that <strong class="calibre7">in this case <em class="calibre5">CALCULATE</em> does not perform any context transition</strong>, even though it removes all the existing row contexts.</p>
<p class="edition">This behavior is important in many scenarios. It becomes particularly useful in calculated columns. In a calculated column there is always a row context. Therefore, whenever the code in a calculated column invokes a measure, it is always executed in a filter context only for the current row.</p>
<p class="edition">For example, imagine computing the percentage of sales of the current product against all products in a calculated column. Inside a calculated column one can easily compute the value of sales of the current product by just invoking the <em class="calibre5">Sales Amount</em> measure. The context transition makes sure that the value returned only represents the sales of the current product. Nevertheless, the denominator should compute the sales of all the products, but the context transition is a problem. So, one can avoid the context transition by using <em class="calibre5">ALL</em>, like in the following code:</p>
<p class="codelink"><a href="#calibre_link-983" id="calibre_link-2532" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[GlobalPct] =
VAR SalesProduct = [Sales Amount]
VAR SalesAllProducts =
    CALCULATE (
        [Sales Amount],
        ALL ( 'Product' )
    )
VAR Result =
    DIVIDE ( SalesProduct, SalesAllProducts )
RETURN
    Result</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1687"></span>Remember: the reason why <em class="calibre5">ALL</em> is removing the effect of the context transition is because <em class="calibre5">ALL</em>&mdash;being a <em class="calibre5">CALCULATE</em> modifier&mdash;is executed after the context transition. For this reason, <em class="calibre5">ALL</em> can override the effects of the context transition.</p>
<p class="edition">Similarly, the percentage against all the products in the same category is a slight variation of the previous code:</p>
<p class="codelink"><a href="#calibre_link-984" id="calibre_link-2533" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[CategoryPct] =
VAR SalesProduct = [Sales Amount]
VAR SalesCategory =
    CALCULATE (
        [Sales Amount],
        ALLEXCEPT ( 'Product', 'Product'[Category] )
    )
VAR Result
    DIVIDE ( SalesProduct, SalesCategory )
RETURN
    Result</pre></div>
<p class="edition">You can look at the result of these two calculated columns in <a href="#calibre_link-985" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-16</a>.</p>
<figure id="calibre_link-985" class="image-l">
<img src="images/000478.jpg" alt="The report shows the results of GlobalPct and CategoryPct, per product name." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-16</strong> <em class="calibre5">GlocalPct</em> and <em class="calibre5">CategoryPct</em> use <em class="calibre5">ALL</em> and <em class="calibre5">ALLEXCEPT</em> to avoid the effect of the context transition.</figcaption>
</figure>
</section>
<section class="calibre4">
<h3 id="calibre_link-179" class="h2a">Using <em class="calibre5">ISEMPTY</em></h3>
<p class="edition"><em class="calibre5">ISEMPTY</em> is a function used to test whether a table is empty, meaning that it has no values visible in the current filter context. Without <em class="calibre5">ISEMPTY</em>, the following expression would test that a table expression returns zero rows:</p>
<p class="codelink"><a href="#calibre_link-986" id="calibre_link-2534" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">COUNTROWS ( VALUES ( 'Product'[Color] ) ) = 0</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3096"></span>Using <em class="calibre5">ISEMPTY</em> makes the code easier:</p>
<p class="codelink"><a href="#calibre_link-987" id="calibre_link-2535" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ISEMPTY ( VALUES ( 'Product'[Color] ) )</pre></div>
<p class="edition">From a performance point of view, using <em class="calibre5">ISEMPTY</em> is always a better choice because it informs the engine exactly what to check. <em class="calibre5">COUNTROWS</em> requires DAX to count the number of rows in the table, whereas <em class="calibre5">ISEMPTY</em> is more efficient and usually does not require a complete scan of the visible values of the target table.</p>
<p class="edition">For example, imagine computing the number of customers who never bought certain products. A solution to this requirement is the following measure, <em class="calibre5">NonBuyingCustomers</em>:</p>
<p class="codelink"><a href="#calibre_link-988" id="calibre_link-2536" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NonBuyingCustomers :=
VAR SelectedCustomers =
    CALCULATETABLE (
        DISTINCT ( Sales[CustomerKey] ),
        ALLSELECTED ()
    )
VAR CustomersWithoutSales =
    FILTER (
        SelectedCustomers,
        ISEMPTY ( RELATEDTABLE ( Sales ) )
    )
VAR Result =
    COUNTROWS ( CustomersWithoutSales )
RETURN
    Result</pre></div>
<p class="edition">You can see in <a href="#calibre_link-989" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-17</a> a report showing the number of customers and the number of nonbuying customers side-by-side.</p>
<figure id="calibre_link-989" class="image-l">
<img src="images/000485.jpg" alt="The report shows buying and nonbuying customers for each brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-17</strong> <em class="calibre5">NonBuyingCustomers</em> counts the customers who never bought any of the selected products.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1922"></span><em class="calibre5">ISEMPTY</em> is a simple function. Here we use it as an example to point the reader’s attention to one detail. The previous code saved a list of customer keys in a variable, and later it iterated this list with <em class="calibre5">FILTER</em> to check whether the <em class="calibre5">RELATEDTABLE</em> result was empty or not.</p>
<p class="edition">If the content of the table in the <em class="calibre5">SelectedCustomer</em> variable were the list of customer keys, how could DAX know that those values have a relationship with <em class="calibre5">Sales</em>? A customer key, as a value, is not different from a product quantity. A number is a number. The difference is in the meaning of the number. As a customer key, 120 represents the customer with key 120, whereas as a quantity, it indicates the number of products sold.</p>
<p class="edition">Thus, a list of numbers has no clear meaning as a filter, unless one knows where these numbers come from. DAX maintains the knowledge about the source of column values through data lineage, which we explain in the next section.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-180" class="h2a">Introducing data lineage and <em class="calibre5">TREATAS</em></h3>
<p class="edition">As we anticipated in the previous section, “<a href="#calibre_link-179" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using <em class="calibre5">ISEMPTY</em></a>,” a list of values is meaningless unless one knows what those values represent. For example, imagine a table of strings containing “Red” and “Blue” like the following anonymous table:</p>
<div class="program"><pre class="calibre14">{ "Red", "Blue" }</pre></div>
<p class="edition">As humans, we know these are colors. More likely, at this point in the book all our readers know that we are referencing product colors. But to DAX, this only represents a table containing two strings. Therefore, the following measure always produces the grand total of sales because the table containing two values cannot filter anything:</p>
<div class="program"><pre class="calibre14">Test :=
CALCULATE (
    [Sales Amount],
    { "Red", "Blue" }
)</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The previous measure does not raise any error. The filter argument is applied to an anonymous table, without any effect on physical tables of the data model.</p>
</div>
<p class="edition">In <a href="#calibre_link-990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-18</a> you can see that the result is the same as <em class="calibre5">Sales Amount</em> because <em class="calibre5">CALCULATE</em> does not apply any further filtering.</p>
<figure id="calibre_link-990" class="image-l">
<img src="images/000492.jpg" alt="The report shows that Test and Sales Amount return the exact same numbers." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3097"></span><strong class="calibre7">Figure 10-18</strong> Filtering with an anonymous table does not produce any filter.</figcaption>
</figure>
<p class="edition">For a value to filter the model, DAX needs to know the <em class="calibre5">data lineage</em> of the value itself. A value that represents a column in the data model holds the data lineage of that column. On the other hand, a value that is not linked to any column in the data model is an anonymous value. In the previous example, the <em class="calibre5">Test</em> measure used an anonymous table to filter the model and, as such, it did not filter any column of the data model.</p>
<p class="edition">The following is a correct way of applying a filter. Be mindful that we use the full syntax of the <em class="calibre5">CALCULATE</em> filter argument for educational purposes; a predicate to filter <em class="calibre5">Product[Color]</em> would be enough:</p>
<p class="codelink"><a href="#calibre_link-991" id="calibre_link-2537" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Test :=
CALCULATE (
    [Sales Amount],
    FILTER (
        ALL ( 'Product'[Color] ),
        'Product'[Color] IN { "Red", "Blue" }
    )
)</pre></div>
<p class="edition">Data lineage flows this way: <em class="calibre5">ALL</em> returns a table that contains all product colors. The result contains the values from the original column, so DAX knows the meaning of each value. <em class="calibre5">FILTER</em> scans the table containing all the colors and checks whether each color is included in the anonymous table containing Red and Blue. As a result, <em class="calibre5">FILTER</em> returns a table containing the values of <em class="calibre5">Product[Color]</em>, so <em class="calibre5">CALCULATE</em> knows that the filter is applied to the <em class="calibre5">Product[Color]</em> column.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2046"></span>One can imagine data lineage as a special tag added to each column, identifying its position in the data model.</p>
<p class="edition">You typically do not have to worry about data lineage because DAX handles the complexity of data lineage by itself in a natural and intuitive way. For example, when a table value is assigned to a variable, the table contains data lineage information that is maintained through the whole DAX evaluation process using that variable.</p>
<p class="edition">The reason why it is important to learn data lineage is because one has the option of either maintaining or changing data lineage at will. In some scenarios it is important to keep the data lineage, whereas in other scenarios one might want to change the lineage of a column.</p>
<p class="edition">The function that can change the lineage of a column is <em class="calibre5">TREATAS</em>. <em class="calibre5">TREATAS</em> accepts a table as its first argument and then a set of column references. <em class="calibre5">TREATAS</em> updates the data lineage of the table tagging each column with the appropriate target column. For example, the previous <em class="calibre5">Test</em> measure can be rewritten this way:</p>
<p class="codelink"><a href="#calibre_link-992" id="calibre_link-2538" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Test :=
CALCULATE (
    [Sales Amount],
    TREATAS ( { "Red", "Blue" }, 'Product'[Color] )
)</pre></div>
<p class="edition"><em class="calibre5">TREATAS</em> returns a table containing values tagged with the <em class="calibre5">Product[Color]</em> column. As such, this new version of the <em class="calibre5">Test</em> measure only filters the red and blue colors, as shown in <a href="#calibre_link-993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-19</a>.</p>
<figure id="calibre_link-993" class="image-l">
<img src="images/000499.jpg" alt="In the report, Test returns the sum of Blue and Red all the way through." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-19</strong> <em class="calibre5">TREATAS</em> updates the lineage of the anonymous table, so that filtering now works as expected.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3098"></span>The rules for data lineage are simple. A simple column reference maintains its data lineage, whereas an expression is always anonymous. Indeed, an expression generates a reference to an anonymous column. For example, the following expression returns a table with two columns that have the same content. The difference between the two columns is that the first one retains the data lineage information, whereas the second one does not because it is a new column:</p>
<p class="codelink"><a href="#calibre_link-994" id="calibre_link-2539" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ADDCOLUMNS (
    VALUES ( 'Product'[Color] ),
    "Color without lineage", 'Product'[Color] &amp; ""
)</pre></div>
<p class="edition"><em class="calibre5">TREATAS</em> is useful to update the data lineage of one or more columns in a table expression. The example shown so far was only for educational purposes. Now we show a better example related to time intelligence calculations. In <a href="#calibre_link-13" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 8</a>, “<a href="#calibre_link-13" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Time intelligence calculations</a>,” we showed the following formula to compute the <em class="calibre5">LASTNONBLANK</em> date for semi-additive calculations:</p>
<p class="codelink"><a href="#calibre_link-995" id="calibre_link-2540" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">LastBalanceIndividualCustomer :=
SUMX (
    VALUES ( Balances[Name] ),
    CALCULATE (
        SUM ( Balances[Balance] ),
        LASTNONBLANK (
            'Date'[Date],
            COUNTROWS ( RELATEDTABLE ( Balances ) )
        )
    )
)</pre></div>
<p class="edition">This code works, but it suffers from a major drawback: It contains two iterations, and the optimizer is likely to use a suboptimal execution plan for the measure. It would be better to create a table containing the customer name and the date of the last balance, and then use that table as a filter argument in <em class="calibre5">CALCULATE</em> to filter the last date available for each customer. It turns out that this is possible by using <em class="calibre5">TREATAS</em>:</p>
<p class="codelink"><a href="#calibre_link-996" id="calibre_link-2541" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">LastBalanceIndividualCustomer Optimized :=
VAR LastCustomerDate =
    ADDCOLUMNS (
        VALUES ( Balances[Name] ),
        "LastDate", CALCULATE (
            MAX ( Balances[Date] ),
            DATESBETWEEN ( 'Date'[Date], BLANK(), MAX ( Balances[Date] ) )
        )
    )
VAR FilterCustomerDate =
    <strong class="calibre7">TREATAS (</strong>
        <strong class="calibre7">LastCustomerDate,</strong>
        <strong class="calibre7">Balances[Name],</strong>
        <strong class="calibre7">'Date'[Date]</strong>
    <strong class="calibre7">)</strong>
<span type="pagebreak" id="calibre_link-1715"></span>VAR SumLastBalance =
    CALCULATE (
        SUM ( Balances[Balance] ),
        FilterCustomerDate
    )
RETURN
    SumLastBalance</pre></div>
<p class="edition">The measure performs the following operations:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">LastCustomerDate</em> contains the last date for which there is data for each customer. The result is a table that contains two columns: the first is the <em class="calibre5">Balances[Name]</em> column, whereas the second is an anonymous column because it is the result of an expression.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">FilterCustomerDate</em> has the same content as <em class="calibre5">LastCustomerDate</em>. By using <em class="calibre5">TREATAS</em>, both columns are now tagged with the desired data lineage. The first column targets <em class="calibre5">Balances[Name]</em>, whereas the second column targets <em class="calibre5">Date[Date]</em>.</p></li>
<li class="calibre10"><p class="listp">The last step is to use <em class="calibre5">FilterCustomerDate</em> as a filter argument of <em class="calibre5">CALCULATE</em>. Because the table is now correctly tagged with the data lineage, <em class="calibre5">CALCULATE</em> filters the model in such a way that only one date is selected for every customer. This date is the last date with data in the <em class="calibre5">Balances</em> table for the given customer.</p></li>
</ul>
<p class="edition">Most of the time, <em class="calibre5">TREATAS</em> is applied to change the data lineage of a table with a single column. The previous example shows a more complex scenario where the data lineage is modified on a table containing two columns. The data lineage of a table resulting from a DAX expression can include columns of different tables. When this table is applied to the filter context, it often generates an arbitrarily shaped filter, discussed in the next section.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-181" class="h2a">Understanding arbitrarily shaped filters</h3>
<p class="edition">Filters in the filter context can have two different shapes: simple filters and arbitrarily shaped filters. All the filters we have used so far are simple filters. In this section, we describe arbitrarily shaped filters, and we briefly discuss the implications of using them in your code. Arbitrarily shaped filters can be created by using a PivotTable in Excel or by writing DAX code in a measure, whereas the Power BI user interface currently requires a custom visual to create arbitrarily shaped filters. This section describes what these filters are and how to manage them in DAX.</p>
<p class="edition">We can start by describing the difference between a simple filter and an arbitrarily shaped filter in the filter context.</p>
<ul class="sq">
<li class="calibre10"><p class="listp">A <strong class="calibre7"><em class="calibre5">column filter</em></strong> is a list of values for one column only. A list of three colors, like red, blue, and green, is a column filter. For example, the following <em class="calibre5">CALCULATE</em> generates a column filter in the filter context that only affects the <em class="calibre5">Product[Color]</em> column:</p>
<p class="codelink1"><a href="#calibre_link-997" id="calibre_link-2542" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    'Product'[Color] IN { "Red", "Blue", "Green" }
)</pre></div></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-1718"></span>A <strong class="calibre7"><em class="calibre5">simple filter</em></strong> is a filter over one or more columns that corresponds to a set of simple column filters. Almost all the filters used in this book so far are column filters. Column filters are created quite simply, by using multiple filter arguments in <em class="calibre5">CALCULATE</em>:</p>
<p class="codelink1"><a href="#calibre_link-998" id="calibre_link-2543" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    'Product'[Color] IN { "Red", "Blue" },
    'Date'[Calendar Year Number] IN { 2007, 2008, 2009 }
)</pre></div>
<p class="listp">The previous code could be written using a simple filter with two columns:</p>
<p class="codelink1"><a href="#calibre_link-999" id="calibre_link-2544" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    TREATAS (
        {
            ( "Red", 2007 ),
            ( "Red", 2008 ),
            ( "Red", 2009 ),
            ( "Blue", 2007 ),
            ( "Blue", 2008 ),
            ( "Blue", 2009 )
        },
        'Product'[Color],
        'Date'[Calendar Year Number]
     )
)</pre></div>
<p class="listp">Because a simple filter contains all the possible combinations of two columns, it is simpler to express it using two column filters.</p></li>
<li class="calibre10"><p class="listp">An <strong class="calibre7"><em class="calibre5">arbitrarily shaped filter</em></strong> is any filter that cannot be expressed as a simple filter. For example, look at the following expression:</p>
<p class="codelink1"><a href="#calibre_link-1000" id="calibre_link-2545" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    TREATAS (
        {
            ( "CY 2007", "December" ),
            ( "CY 2008", "January" )
        },
        'Date'[Calendar Year],
        'Date'[Month]
    )
)</pre></div>
<p class="listp">The filter on year and month is not a column filter because it involves two columns. Moreover, the filter does not include all the combinations of the two columns existing in the data model. In fact, one cannot filter year and month separately. Indeed, there are two year and two month references, and there are four existing combinations in the <em class="calibre5">Date</em> table for the values provided, whereas the filter only includes two of these combinations. In other words, using two column filters, the resulting filter context would also include January 2007 and December 2008, which are not included in the filter described by the previous code. Therefore, this is an arbitrarily shaped filter.</p></li>
</ul>
<p class="edition"><span type="pagebreak" id="calibre_link-1717"></span>An arbitrarily shaped filter is not just a filter with multiple columns. Certainly, a filter with multiple columns could be an arbitrarily shaped filter, but one can build a filter with multiple columns retaining the shape of a simple filter. The following example is a simple filter, despite it involving multiple columns:</p>
<p class="codelink"><a href="#calibre_link-1001" id="calibre_link-2546" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    TREATAS (
        {
            <strong class="calibre7">( "CY 2007", "December" ),</strong>
            <strong class="calibre7">( "CY 2008", "December" )</strong>
        },
        'Date'[Calendar Year],
        'Date'[Month]
    )
)</pre></div>
<p class="edition">The previous expression can be rewritten as the combination of two column filters this way:</p>
<p class="codelink"><a href="#calibre_link-1002" id="calibre_link-2547" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    'Date'[Calendar Year] IN { "CY 2007",  "CY 2008" },
    'Date'[Month] = "December"
)</pre></div>
<p class="edition">Although they seem complex to author, arbitrarily shaped filters can easily be defined through the user interface of Excel and Power BI. At the time of writing, Power BI can only generate an arbitrarily shaped filter by using the Hierarchy Slicer custom visual, which defines filters based on a hierarchy with multiple columns. For example, in <a href="#calibre_link-1003" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-20</a> you can see the Hierarchy Slicer filtering different months in 2007 and 2008.</p>
<figure id="calibre_link-1003" class="image-l">
<img src="images/000506.jpg" alt="The figure shows Sales Amount specifically for a set of months selected in a slicer." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-20</strong> Filtering a hierarchy makes it possible to build an arbitrarily shaped filter.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3099"></span>In Microsoft Excel you find a native feature to build arbitrarily shaped sets out of hierarchies, as shown in <a href="#calibre_link-1004" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-21</a>.</p>
<figure id="calibre_link-1004" class="image-l">
<img src="images/000513.jpg" alt="The figure shows the equivalent feature in Excel." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-21</strong> Microsoft Excel builds arbitrarily shaped filters using the native hierarchy filter.</figcaption>
</figure>
<p class="edition">Arbitrarily shaped filters are complex to use in DAX because of the way <em class="calibre5">CALCULATE</em> might change them in the filter context. In fact, when <em class="calibre5">CALCULATE</em> applies a filter on a column, it removes previous filters on that column only, replacing any previous filter with the new filter. The result is that typically, the original shape of the arbitrarily shaped filter is lost. This behavior leads to formulas that produce inaccurate results and that are hard to debug. Thus, to demonstrate the problem, we will increase the complexity of the code step-by-step, until the problem arises.</p>
<p class="edition">Imagine you define a simple measure that overwrites the year, forcing it to be 2007:</p>
<p class="codelink"><a href="#calibre_link-1005" id="calibre_link-2548" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount 2007 :=
CALCULATE (
    [Sales Amount],
    'Date'[Calendar Year] = "CY 2007"
)</pre></div>
<p class="edition"><em class="calibre5">CALCULATE</em> overwrites the filter on the year but it does not change the filter on the month. When it is used in a report, the results of the measure might seem unusual, as shown in <a href="#calibre_link-1006" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-22</a>.</p>
<figure id="calibre_link-1006" class="image-l">
<img src="images/000520.jpg" alt="Sales Amount 2007 and Sales Amount only show the same numbers for months in 2007." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3100"></span><strong class="calibre7">Figure 10-22</strong> The year 2007 replaces the previous filter on the year.</figcaption>
</figure>
<p class="edition">When 2007 is selected, the results of the two measures are the same. However, when the year selected is 2008, it gets replaced with 2007, whereas months are left untouched. The result is that the value shown for January 2008 is the sales amount of January 2007. The same happens for February and March. The main thing to note is that the original filter did not contain the first three months of 2007, and by replacing the filter on the year, our formula shows their value. As anticipated, so far there is nothing special.</p>
<p class="edition">Things suddenly become much more intricate if one wants to compute the average monthly sales. A possible solution to this calculation is to iterate over the months and average the partial results using <em class="calibre5">AVERAGEX</em>:</p>
<p class="codelink"><a href="#calibre_link-1007" id="calibre_link-2549" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Monthly Avg :=
AVERAGEX (
    VALUES ( 'Date'[Month] ),
    [Sales Amount]
)</pre></div>
<p class="edition">You can see the result in <a href="#calibre_link-1008" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-23</a>. This time, the grand total is surprisingly large.</p>
<figure id="calibre_link-1008" class="image-l">
<img src="images/000527.jpg" alt="Sales Amount and Monthly Avg return numbers for a set of months from the slicer. The monthly average for the grand total is obviously incorrect." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-23</strong> The grand total is definitely not the average of months; it is too large.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3101"></span>Understanding the problem is much harder than fixing it. Focus your attention on the cell that computes the wrong value&mdash;the grand total of <em class="calibre5">Monthly Avg</em>. The filter context of the <em class="calibre5">Total</em> row of the report is the following:</p>
<p class="codelink"><a href="#calibre_link-1009" id="calibre_link-2550" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">TREATAS (
    {
        ( "CY 2007", "September" ),
        ( "CY 2007", "October" ),
        ( "CY 2007", "November" ),
        ( "CY 2007", "December" ),
        ( "CY 2008", "January" ),
        ( "CY 2008", "February" ),
        ( "CY 2008", "March" )
    },
    'Date'[Calendar Year],
    'Date'[Month]
)</pre></div>
<p class="edition">In order to follow the execution of the DAX code, we expand the full calculation in that cell by defining the corresponding filter context in a <em class="calibre5">CALCULATE</em> statement that evaluates the <em class="calibre5">Monthly Avg</em> measure. Moreover, we expand the code of <em class="calibre5">Monthly Avg</em> to build a single formula that simulates the execution:</p>
<p class="codelink"><a href="#calibre_link-1010" id="calibre_link-2551" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    AVERAGEX (
        VALUES ( 'Date'[Month] ),
        <strong class="calibre7">CALCULATE (</strong>
            <strong class="calibre7">SUMX (</strong>
                 <strong class="calibre7">Sales,</strong>
                 <strong class="calibre7">Sales[Quantity] * Sales[Net Price]</strong>
            <strong class="calibre7">)</strong>
        <strong class="calibre7">)</strong>
    ),
    TREATAS (
        {
            ( "CY 2007", "September" ),
            ( "CY 2007", "October" ),
            ( "CY 2007", "November" ),
            ( "CY 2007", "December" ),
            ( "CY 2008", "January" ),
            ( "CY 2008", "February" ),
            ( "CY 2008", "March" )
        },
        'Date'[Calendar Year],
        'Date'[Month]
    )
)</pre></div>
<p class="edition">The key to fixing the problem is to understand what happens when the highlighted <em class="calibre5">CALCULATE</em> is executed. That <em class="calibre5">CALCULATE</em> is executed in a row context that is iterating over the <em class="calibre5">Date[Month]</em> column. Consequently, context transition takes place and the current value of the month is added to the filter <span type="pagebreak" id="calibre_link-3102"></span>context. On a given month, say January, <em class="calibre5">CALCULATE</em> adds January to the filter context, replacing the current filter on the month but leaving all the other filters untouched.</p>
<p class="edition">When <em class="calibre5">AVERAGEX</em> is iterating January, the resulting filter context is January in both 2007 and 2008; this is because the original filter context filters two years for the year column. Therefore, on each iteration DAX computes the sales amount of one month in two distinct years. This is the reason why the value is much higher than any monthly sales.</p>
<p class="edition">The original shape of the arbitrarily shaped filter is lost because <em class="calibre5">CALCULATE</em> overrides one of the columns involved in the arbitrarily shaped filter. The net result is that the calculation produces an incorrect result.</p>
<p class="edition">Fixing the problem is much easier than expected. Indeed, it is enough to iterate over a column that is guaranteed to have a unique value on every month. If, instead of iterating over the month name, which is not unique over different years, the formula iterates over the <em class="calibre5">Calendar Year Month</em> column, then the code produces the correct result:</p>
<p class="codelink"><a href="#calibre_link-1011" id="calibre_link-2552" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Monthly Avg :=
AVERAGEX (
    VALUES ( 'Date'[Calendar Year Month] ),
    [Sales Amount]
)</pre></div>
<p class="edition">Using this version of <em class="calibre5">Monthly Avg</em>, on each iteration the context transition overrides the filter on <em class="calibre5">Calendar Year Month</em>, which represents both year and month values in the same column. As a result, it is guaranteed to always return the sales of an individual month, producing the correct outcome shown in <a href="#calibre_link-1012" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 10-24</a>.</p>
<figure id="calibre_link-1012" class="image-l">
<img src="images/000535.jpg" alt="In this report, the grand total returns the accurate average." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 10-24</strong> Iterating over a unique column makes the code compute the correct result.</figcaption>
</figure>
<p class="edition">If a unique column for the cardinality of the iterator is not available, another viable solution is to use <em class="calibre5">KEEPFILTERS</em>. The following alternative version of the code works correctly, because instead of <span type="pagebreak" id="calibre_link-1716"></span>replacing the previous filter, it adds the month filter to the previously existing arbitrarily shaped set; this maintains the format of the original filter:</p>
<p class="codelink"><a href="#calibre_link-1013" id="calibre_link-2553" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Monthly Avg KeepFilters :=
AVERAGEX (
    KEEPFILTERS ( VALUES ( 'Date'[Month] ) ),
    [Sales Amount]
)</pre></div>
<p class="edition">As anticipated, arbitrarily shaped sets are not commonly observed in real-world reports. Nevertheless, users have multiple and legitimate ways of generating them. In order to guarantee that a measure works correctly even in the presence of arbitrarily shaped sets, it is important to follow some best practices:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">When iterating over a column, make sure that the column has unique values at the granularity where the calculation is being performed. For example, if a <em class="calibre5">Date</em> table has more than 12 months, a <em class="calibre5">YearMonth</em> column should be used for monthly calculations.</p></li>
<li class="calibre10"><p class="listp">If the previous best practice cannot be applied, then protect the code using <em class="calibre5">KEEPFILTERS</em> to guarantee that the arbitrarily shaped filter is maintained in the filter context. Be mindful that <em class="calibre5">KEEPFILTERS</em> might change the semantics of the calculations. Indeed, it is important to double-check that <em class="calibre5">KEEPFILTERS</em> does not introduce errors in the measure.</p></li>
</ul>
<p class="edition">Following these simple rules, your code will be safe even in the presence of arbitrarily shaped filters.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-182" class="h2a">Conclusions</h3>
<p class="edition">In this chapter we described several functions that are useful to inspect the content of the filter context and/or to modify the behavior of a measure depending on the context. We also introduced important techniques to manipulate the filter context with the increased knowledge of the possible states of the filter context. Here is a recap of the important concepts you learned in this chapter:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">A column can be either filtered or cross-filtered. It is filtered if there is a direct filter; it is cross-filtered if the filter is coming from a direct filter on another column or table. You can verify whether a column is filtered or not by using <em class="calibre5">ISFILTERED</em> and <em class="calibre5">ISCROSSFILTERED</em>.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">HASONEVALUE</em> checks whether a column only has one value visible in the filter context. This is useful before retrieving that value using <em class="calibre5">VALUES</em>. The <em class="calibre5">SELECTEDVALUE</em> function simplifies the <em class="calibre5">HASONEVALUE</em>/<em class="calibre5">VALUES</em> pattern.</p></li>
<li class="calibre10"><p class="listp">Using <em class="calibre5">ALLEXCEPT</em> is not the same as using the pair <em class="calibre5">ALL</em> and <em class="calibre5">VALUES</em>. In the presence of cross-filtering, <em class="calibre5">ALL</em>/<em class="calibre5">VALUES</em> is safer because it also considers cross-filtering as part of its evaluation.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">ALL</em> and all the <em class="calibre5">ALL*</em> functions are useful to avoid the effect of context transition. Indeed, using <em class="calibre5">ALL</em> in a calculated column, or in general in a row context, informs DAX that the context transition is not needed.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-2039"></span>Each column in a table is tagged with data lineage. Data lineage lets DAX apply filters and relationships. Data lineage is maintained whenever one references a column, whereas it is lost when using expressions.</p></li>
<li class="calibre10"><p class="listp">Data lineage can be assigned to one or more columns by using <em class="calibre5">TREATAS</em>.</p></li>
<li class="calibre10"><p class="listp">Not all filters are simple filters. A user can build more complex filters either through the user interface or by code. The most complex kind of filter is the arbitrarily shaped filter, which could be complex to use because of its interaction with the <em class="calibre5">CALCULATE</em> function and the context transition.</p></li>
</ul>
<p class="edition">You will likely not remember all the concepts and functions described in this chapter immediately after having read them. Regardless, it is crucial that you be exposed to these concepts in your learning of DAX. You will for sure run into one of the issues described here as you gain DAX experience. At that point, it will be useful to come back to this chapter and refresh your memory about the specific problem you are dealing with.</p>
<p class="edition">In the next chapter, we use many of the functions described here to apply calculations over hierarchies. As you will learn, working with hierarchies is mainly a matter of understanding the shape of the current filter context.</p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1014">
<div id="calibre_link-3103" class="calibre2">
<div id="calibre_link-3104" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-16"><span type="pagebreak" id="calibre_link-2071"></span><span class="pd_ash">Chapter 11</span><br class="calibre3" />Handling hierarchies</h2>
<p class="edition">Hierarchies are oftentimes present in data models to make it easier for the user to slice and dice using predefined exploration paths. Nevertheless, DAX does not have any built-in function providing a calculation over hierarchies. Computing a simple calculation like the ratio to parent requires complex DAX code, and the support for calculations over hierarchies proves to be a challenge in general.</p>
<p class="edition">However, it is worth learning the DAX code required to handle hierarchies because calculations over hierarchies are very common. In this chapter, we show how to create basic calculations over hierarchies and how to use DAX to transform a parent/child hierarchy into a regular hierarchy.</p>
<section class="calibre4">
<h3 id="calibre_link-183" class="h2a">Computing percentages over hierarchies</h3>
<p class="edition">A common requirement when dealing with hierarchies is to create a measure that behaves differently depending on the level of the item selected. An example is the ratio to parent calculation. Ratio to parent displays for each level the percentage of that level against its parent.</p>
<p class="edition">For instance, consider a hierarchy made of product category, subcategory, and product name. A ratio to parent calculation shows the percentage of a category against the grand total, of a subcategory against its category, and of a product against its subcategory. Thus, depending on the level of the hierarchy, it shows a different calculation.</p>
<p class="edition">An example of this report is visible in <a href="#calibre_link-1015" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-1</a>.</p>
<figure id="calibre_link-1015" class="image-l">
<img src="images/000647.jpg" alt="The report shows Sales Amount and PercOnParent per category, subcategory, and product name." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2077"></span><strong class="calibre7">Figure 11-1</strong> The <em class="calibre5">PercOnParent</em> measure is useful to better understand the values in a table.</figcaption>
</figure>
<p class="edition">In Excel, one might create this calculation by using the PivotTable feature Show Values As, so that the computation is performed by Excel. However, if you want to use the calculation regardless of specific features of the client, then it is better to create a new measure that performs the computation so that the value is computed in the data model. Moreover, learning the technique comes handy in many similar scenarios.</p>
<p class="edition">Unfortunately, computing the ratio to parent in DAX is not so easy. Here is the first big DAX limitation we face: There is no way of building a generic ratio to parent measure that works on any arbitrary combination of columns in a report. The reason is that inside DAX, there is no way of knowing how the report was created or how the hierarchy was used in the client tool. DAX has no knowledge of the way a user builds a report. It receives a DAX query; the query does not contain information about what is on the rows, what is on the columns, or what slicers were used to build the report.</p>
<p class="edition">Though a generic formula cannot be created, it is still possible to create a measure that computes the correct percentages when used properly. Because there are three levels in the hierarchy (category, subcategory, and product), we start with three different measures that compute three different percentages, one for each level:</p>
<p class="codelink"><a href="#calibre_link-1016" id="calibre_link-2555" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PercOnSubcategory :=
DIVIDE (
    [Sales Amount],
    CALCULATE (
        [Sales Amount],
        ALLSELECTED ( Product[Product Name] )
    )
)

PercOnCategory :=
DIVIDE (
    [Sales Amount],
    CALCULATE (
        [Sales Amount],
        ALLSELECTED  ( Product[Subcategory] )
    )
)

PercOnTotal :=
DIVIDE (
    [Sales Amount],
    CALCULATE (
        [Sales Amount],
<span type="pagebreak" id="calibre_link-3105"></span>        ALLSELECTED ( Product[Category] )
    )
)</pre></div>
<p class="edition">These three measures compute the percentages needed. <a href="#calibre_link-1017" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-2</a> shows the results in a report.</p>
<figure id="calibre_link-1017" class="image-l">
<img src="images/000654.jpg" alt="The report shows the measures in a report, per category, subcategory and product name." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-2</strong> The three measures work well only at the level where they have meaning.</figcaption>
</figure>
<p class="edition">You can see that the measures only show the correct values where they are relevant. Otherwise, they return 100%, which is useless. Moreover, there are three different measures, but the goal is to only have one measure showing different percentages at different levels. This is the next step.</p>
<p class="edition">We start by clearing the 100% out of the <em class="calibre5">PercOnSubcategory</em> measure. We want to avoid performing the calculation if the hierarchy is not showing the <em class="calibre5">Product Name</em> column on the rows. This means checking if the <em class="calibre5">Product Name</em> is currently being filtered by the query that produces the matrix. There is a specific function for this purpose: <em class="calibre5">ISINSCOPE</em>. <em class="calibre5">ISINSCOPE</em> returns <em class="calibre5">TRUE</em> if the column passed as the argument is filtered and it is part of the columns used to perform the grouping. Thus, the formula can be updated to this new expression:</p>
<p class="codelink"><a href="#calibre_link-1018" id="calibre_link-2556" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PercOnSubcategory :=
IF (
    ISINSCOPE ( Product[Product Name] ),
    DIVIDE (
        [Sales Amount],
        CALCULATE (
            [Sales Amount],
            ALLSELECTED ( Product[Product Name] )
        )
    )
)</pre></div>
<p class="edition"><a href="#calibre_link-1019" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-3</a> shows the report using this new formula.</p>
<figure id="calibre_link-1019" class="image-l">
<img src="images/000660.jpg" alt="In this report, PercOnSubcategory returns blank values at the category and subcategory levels." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2076"></span><strong class="calibre7">Figure 11-3</strong> Using <em class="calibre5">ISINSCOPE</em>, we remove the useless 100% values from the <em class="calibre5">PercOnSubcategory</em> column.</figcaption>
</figure>
<p class="edition">The same technique can be used to remove the 100% from other measures. Be careful that in <em class="calibre5">PercOnCategory</em>, we must check that <em class="calibre5">Subcategory</em> is in scope and <em class="calibre5">Product Name</em> is not. This is because when the report is slicing by <em class="calibre5">Product Name</em> using the hierarchy, it is also slicing by <em class="calibre5">Subcategory</em>&mdash;displaying a product rather than a subcategory. In order to avoid duplicating code to check these conditions, a better option is to write a single measure that executes a different operation depending on the level of the hierarchy visible&mdash;based on the <em class="calibre5">ISINSCOPE</em> condition tested from the bottom to the top of the hierarchy levels. Here is the code for the <em class="calibre5">PercOnParent</em> measure:</p>
<p class="codelink"><a href="#calibre_link-1020" id="calibre_link-2557" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PercOnParent :=
VAR CurrentSales = [Sales Amount]
VAR SubcategorySales =
    CALCULATE (
        [Sales Amount],
        ALLSELECTED ( Product[Product Name] )
    )
VAR CategorySales =
    CALCULATE (
        [Sales Amount],
        ALLSELECTED ( Product[Subcategory] )
    )
VAR TotalSales =
    CALCULATE (
        [Sales Amount],
        ALLSELECTED ( Product[Category] )
    )
VAR RatioToParent =
    IF (
        ISINSCOPE ( Product[Product Name] ),
        DIVIDE ( CurrentSales, SubcategorySales ),
        IF (
            ISINSCOPE  ( Product[Subcategory] ),
            DIVIDE ( CurrentSales, CategorySales ),
            IF (
<span type="pagebreak" id="calibre_link-2075"></span>                ISINSCOPE  ( Product[Category] ),
                DIVIDE ( CurrentSales, TotalSales )
            )
        )
    )
RETURN RatioToParent</pre></div>
<p class="edition">Using the <em class="calibre5">PercOnParent</em> measure, the result is as expected, as you can see in <a href="#calibre_link-1021" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-4</a>.</p>
<figure id="calibre_link-1021" class="image-l">
<img src="images/000666.jpg" alt="The report shows that the three measures computed earlier can be merged together in one single column, returning the right percentage at each hierarchical level." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-4</strong> The <em class="calibre5">PercOnParent</em> measure merges the three columns computed before into a single column.</figcaption>
</figure>
<p class="edition">The three measures created previously are no longer useful. A single measure computes everything needed, putting the right value into a single column by detecting the level the hierarchy is being browsed at.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The order of the <em class="calibre5">IF</em> conditions is important. We want to start by testing the innermost level of the hierarchy and then proceed one step at a time to check the outer levels. Otherwise, if we reverse the order of the conditions, the results will be incorrect. It is important to remember that when the subcategory is filtered through the hierarchy, the category is filtered too.</p>
</div>
<p class="edition">The <em class="calibre5">PercOnParent</em> measure written in DAX only works if the user puts the correct hierarchy on the rows. For example, if the user replaces the category hierarchy with the color, the numbers reported are hard to understand. Indeed, the measure always works considering the product hierarchy regardless of whether it is used or not in the report.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-184" class="h2a"><span type="pagebreak" id="calibre_link-2073"></span>Handling parent/child hierarchies</h3>
<p class="edition">The native data model used by DAX does not support true parent/child hierarchies, such as the ones found in a Multidimensional database in Analysis Services. However, several DAX functions are available to flatten parent/child hierarchies into regular, column-based hierarchies. This is good enough for most scenarios, though it means making an educated guess at design time about what the maximum depth of the hierarchy will be. In this section, you learn how to use DAX functions to create a parent/child hierarchy, often abbreviated as P/C.</p>
<p class="edition">You can see a classical P/C hierarchy in <a href="#calibre_link-1022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-5</a>.</p>
<figure id="calibre_link-1022" class="image-l">
<img src="images/000672.jpg" alt="The figure shows a sample hierarchy with the names of people." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-5</strong> The chart shows a graphical representation of a P/C hierarchy.</figcaption>
</figure>
<p class="edition">P/C hierarchies present certain unique qualities:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The number of levels is not always the same throughout the hierarchy. For example, the path from Annabel to Michael has a depth of two levels, whereas in the same hierarchy the path from Bill to Chris has a depth of three levels.</p></li>
<li class="calibre10"><p class="listp">The hierarchy is normally represented in a single table, storing a link to the parent for each row.</p></li>
</ul>
<p class="edition">The canonical representation of P/C hierarchies is visible in <a href="#calibre_link-1023" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-6</a>.</p>
<figure id="calibre_link-1023" class="image-l">
<img src="images/000679.jpg" alt="This figure shows key and ParentKey for each name in the hierarchy." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-6</strong> A table containing a P/C hierarchy.</figcaption>
</figure>
<p class="edition">It is easy to see that the <em class="calibre5">ParentKey</em> is the key of the parent of each node. For example, for Catherine it shows 6, which is the key of her parent, Annabel. The issue with this data model is that this time, the relationship is self-referenced; that is, the two tables involved in the relationship are really the same table.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3106"></span>A tabular data model does not support self-referencing relationships. Consequently, the data model itself has to be modified; the parent/child hierarchy needs to be turned into a regular hierarchy, based on one column for each level of the hierarchy.</p>
<p class="edition">Before we delve into the details of P/C hierarchies handling, it is worth noting one last point. Look at the table in <a href="#calibre_link-1024" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-7</a> containing the values we want to aggregate using the hierarchy.</p>
<figure id="calibre_link-1024" class="image-l">
<img src="images/000686.jpg" alt="The figure shows amounts for each name." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-7</strong> This table contains the data for the P/C hierarchy.</figcaption>
</figure>
<p class="edition">The rows in the fact table contain references to both leaf-level and middle nodes in the hierarchy. For example, the highlighted row references Annabel. Not only does Annabel have a value by herself, she also has three children nodes. Therefore, when summarizing all her data, the formula needs to aggregate both her numbers and her children’s values.</p>
<p class="edition"><a href="#calibre_link-1025" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-8</a> displays the result we want to achieve.</p>
<figure id="calibre_link-1025" class="image-l">
<img src="images/000693.jpg" alt="The report shows individual values as well as aggregated values for parents." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-8</strong> This report shows the result of browsing a P/C with a matrix visual.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3107"></span>There are many steps to cover before reaching the final goal. Once the tables have been loaded in the data model, the first step is to create a calculated column that contains the path to reach each node, respectively. In fact, because we cannot use standard relationships, we will need to use a set of special functions available in DAX and designed for P/C hierarchies handling.</p>
<p class="edition">The new calculated column named <em class="calibre5">FullPath</em> uses the <em class="calibre5">PATH</em> function:</p>
<p class="codelink"><a href="#calibre_link-1026" id="calibre_link-2558" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Persons[FullPath] = PATH ( Persons[PersonKey], Persons[ParentKey] )</pre></div>
<p class="edition"><em class="calibre5">PATH</em> is a function that receives two parameters. The first parameter is the key of the table (in this case, <em class="calibre5">Persons[PersonKey]</em>), and the second parameter is the name of the column that holds the parent key. <em class="calibre5">PATH</em> performs a recursive traversal of the table, and for each node it builds the path as a list of keys separated by the pipe (<em class="calibre5">|</em>) character. In <a href="#calibre_link-1027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-9</a>, you can see the <em class="calibre5">FullPath</em> calculated column.</p>
<figure id="calibre_link-1027" class="image-l">
<img src="images/000700.jpg" alt="The report shows the result of FullPath." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-9</strong> The <em class="calibre5">FullPath</em> column contains the complete path to reach each node, respectively.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">FullPath</em> column by itself is not useful. However, it is important because it acts as the basis for another set of calculated columns required to build the hierarchy. The next step is to build three calculated columns, one for each level of the hierarchy:</p>
<p class="codelink"><a href="#calibre_link-1028" id="calibre_link-2559" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Persons[Level1] = LOOKUPVALUE(
    Persons[Name],
    Persons[PersonKey], PATHITEM ( Persons[FullPath], 1, INTEGER )
)

Persons[Level2] = LOOKUPVALUE(
    Persons[Name],
    Persons[PersonKey], PATHITEM ( Persons[FullPath], 2, INTEGER )
)

Persons[Level3] = LOOKUPVALUE(
    Persons[Name],
    Persons[PersonKey], PATHITEM ( Persons[FullPath], 3, INTEGER )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3108"></span>The three columns will be <em class="calibre5">Level1</em>, <em class="calibre5">Level2</em>, and <em class="calibre5">Level3</em> and the only change is in the second <em class="calibre5">PATHITEM</em> parameter, which is 1, 2, and 3. The calculated column uses <em class="calibre5">LOOKUPVALUE</em> to search a row where the <em class="calibre5">PersonKey</em> equals the result of <em class="calibre5">PATHITEM</em>. <em class="calibre5">PATHITEM</em> returns the nth item in a column built with <em class="calibre5">PATH</em>, or it returns blank if there is no such item when we request a number greater than the length of the path. The resulting table is shown in <a href="#calibre_link-1029" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-10</a>.</p>
<figure id="calibre_link-1029" class="image-l">
<img src="images/000707.jpg" alt="The report shows the paths for each name." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-10</strong> The <em class="calibre5">Level</em> columns contain the values to show in the hierarchy.</figcaption>
</figure>
<p class="edition">In this example, we used three columns because the maximum depth of the hierarchy is three. In a real-world scenario, one needs to count the maximum number of levels of the hierarchy and to build a number of columns big enough to hold all the levels. Thus, although the number of levels in a P/C hierarchy should be flexible, in order to implement hierarchies in a data model, that maximum number needs to be set. It is a good practice to add a couple more levels to create space and enable any future growth of the hierarchy without needing to update the data model.</p>
<p class="edition">Now, we need to transform the set of level columns into a hierarchy. Also, because none of the other columns in the P/C is useful, we should hide everything else from the client tools. At this point, we can create a report using the hierarchy on the rows and the sum of amounts on the values&mdash;but the result is not yet as desired. <a href="#calibre_link-1030" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-11</a> displays the result in a matrix.</p>
<p class="edition">There are a couple problems with this report:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Under Annabel, two blank rows contain the value of Annabel herself.</p></li>
<li class="calibre10"><p class="listp">Under Catherine, a blank row contains the value of Catherine herself. The same happens for many other rows.</p></li>
</ul>
<p class="edition">The hierarchy always shows three levels, even for paths where the maximum depth should be two such as Harry, who has no children.</p>
<figure id="calibre_link-1030" class="image-l">
<img src="images/000714.jpg" alt="The P/C hierarchy contains too many rows." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3109"></span><strong class="calibre7">Figure 11-11</strong> The P/C hierarchy is not exactly what we want because it shows too many rows.</figcaption>
</figure>
<p class="edition">These issues pertain to the visualization of the results. Other than that, the hierarchy computes the correct values, because under Annabel’s row, you can see the values of all of Annabel’s children. The important aspect of this solution is that we were able to mimic a self-referencing relationship (also known as a recursive relationship) by using the <em class="calibre5">PATH</em> function to create a calculated column. The remaining part is solving the presentation issues, but at least things are moving toward the correct solution.</p>
<p class="edition">Our first challenge is the removal of all the blank values. For example, the second row of the matrix in the report accounts for an amount of 600 that should be visible for Annabel and not for blank. We can solve this by modifying the formula for the <em class="calibre5">Level</em> columns. First, we remove all the blanks, repeating the previous level if we reached the end of the path. Here, you see the pattern for <em class="calibre5">Level2</em>:</p>
<p class="codelink"><a href="#calibre_link-1031" id="calibre_link-2560" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PC[Level2] =
IF ( PATHLENGTH ( Persons[FullPath] ) &gt;= 2,
    LOOKUPVALUE(
        Persons[Name],
        Persons[PersonKey], PATHITEM ( Persons[FullPath], 2, INTEGER )
    ),
    Persons[Level1]
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3110"></span><em class="calibre5">Level1</em> does not need to be modified because there is always a first level. Columns from <em class="calibre5">Level3</em> must follow the same pattern as <em class="calibre5">Level2</em>. With this new formula, the table looks like <a href="#calibre_link-1032" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-12</a>.</p>
<figure id="calibre_link-1032" class="image-l">
<img src="images/000721.jpg" alt="The report does not contain any blanks." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-12</strong> With the new formula, the <em class="calibre5">Level</em> columns never contain a blank.</figcaption>
</figure>
<p class="edition">At this point, if you look at the report, the blank rows are gone. Yet, there are still too many rows. In <a href="#calibre_link-1033" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-13</a>, you can see the report with two rows highlighted.</p>
<figure id="calibre_link-1033" class="image-l">
<img src="images/000728.jpg" alt="The formerly blank cells now have a name, but there is still redundant information in this report." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-13</strong> The new report does not have blank rows.</figcaption>
</figure>
<p class="edition">Pay attention to the second and third rows of the report. In both cases, the matrix shows a single row of the hierarchy (that is, the row of Annabel). We might want to show the second row because it contains a relevant value for Annabel. However, we certainly do not want to see the third row because the hierarchy is browsing too deep and the path of Annabel is no longer helpful. As you see, the decision whether to show or hide a node of the hierarchy depends on the depth of the node. We can let a user expand Annabel up to the second level of the hierarchy, but we surely want to remove the third level of Annabel.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3111"></span>We can store the length of the path needed to reach the row into a calculated column. The length of the path shows that Annabel is a root node. Indeed, it is a node of level 1 with a path containing one value only. Catherine, on the other hand, is a node of level 2 because she is a daughter of Annabel and the path of Catherine is of length 2. Moreover, although it might not be so evident, Catherine is visible at level 1 because her value is aggregated under the first node of Annabel. In other words, even though the name of Catherine is not present in the report at level 1, her amount is aggregated under her parent, which is Annabel. The name of Catherine is visible because her row contains Annabel as <em class="calibre5">Level1</em>.</p>
<p class="edition">Once we know the level of each node in the hierarchy, we can define that each node be visible whenever the report browses the hierarchy up to its level. When the report shows a level that is too deep, then the node needs to be hidden. To implement this algorithm, two values are needed:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The depth of each node; this is a fixed value for each row of the hierarchy, and as such, it can safely be stored in a calculated column.</p></li>
<li class="calibre10"><p class="listp">The current browsing depth of the report visual; this is a dynamic value that depends on the current filter context. It needs to be a measure because its value changes depending on the report and it has a different value for each row of the report. For example, Annabel is a node at level 1, but she appears in three rows because the current depth of the report has three different values.</p></li>
</ul>
<p class="edition">The depth of each node is easy to compute. We can add a new calculated column to the <em class="calibre5">Persons</em> table with this simple expression:</p>
<p class="codelink"><a href="#calibre_link-1034" id="calibre_link-2561" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Persons[NodeDepth] = PATHLENGTH ( Persons[FullPath] )</pre></div>
<p class="edition"><em class="calibre5">PATHLENGTH</em> returns the length of a value computed by <em class="calibre5">PATH</em>. You can see the resulting calculated column in <a href="#calibre_link-1035" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-14</a>.</p>
<figure id="calibre_link-1035" class="image-l">
<img src="images/000735.jpg" alt="The report shows the values for the level measures and NodeDepth." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-14</strong> The <em class="calibre5">NodeDepth</em> column stores the depth of each node in a calculated column.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">NodeDepth</em> column is easy to create. Computing the browsing depth is more difficult because it needs to be computed in a measure. Nevertheless, the logic behind it is not very complex, and it is <span type="pagebreak" id="calibre_link-3112"></span>similar to the technique you have already learned for standard hierarchies. The measure uses <em class="calibre5">ISINSCOPE</em> to discover which of the hierarchy columns is filtered versus not.</p>
<p class="edition">Moreover, the formula takes advantage of the fact that a <em class="calibre5">Boolean</em> value can be converted to a number, where <em class="calibre5">TRUE</em> has a value of 1 and <em class="calibre5">FALSE</em> has a value of 0:</p>
<p class="codelink"><a href="#calibre_link-1036" id="calibre_link-2562" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">BrowseDepth :=
ISINSCOPE ( Persons[Level1] ) +
ISINSCOPE ( Persons[Level2] ) +
ISINSCOPE ( Persons[Level3] )</pre></div>
<p class="edition">Thus, if only <em class="calibre5">Level1</em> is filtered, then the result is 1. If both <em class="calibre5">Level1</em> and <em class="calibre5">Level2</em> are filtered, but not <em class="calibre5">Level3</em>, then the result is 2, and so on. You can see the result for the <em class="calibre5">BrowseDepth</em> measure in <a href="#calibre_link-1037" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-15</a>.</p>
<figure id="calibre_link-1037" class="image-l">
<img src="images/000742.jpg" alt="The report displays Amount and BrowseDepth for each hierarchy level." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-15</strong> The <em class="calibre5">BrowseDepth</em> measure computes the depth of browsing in the report.</figcaption>
</figure>
<p class="edition">We are nearing the resolution of the scenario. The last piece of information we need is that by default, a report will hide rows that result in a blank value for all the displayed measures. Specifically, we are going to use this behavior to hide the unwanted rows. By transforming the value of <em class="calibre5">Amount</em> into a blank when we do not want it to appear in the report, we will be able to hide rows from the matrix. Thus, the solution is going to use these elements:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The depth of each node, in the <em class="calibre5">NodeDepth</em> calculated column,</p></li>
<li class="calibre10"><p class="listp">The depth of the current cell in the report, in the <em class="calibre5">BrowseDepth</em> measure,</p></li>
<li class="calibre10"><p class="listp">A way to hide unwanted rows, by means of blanking the value of the result.</p></li>
</ul>
<p class="edition">It is time to merge all this information into a single measure, as follows:</p>
<p class="codelink"><a href="#calibre_link-1038" id="calibre_link-2563" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PC Amount :=
IF (
    MAX (Persons[NodeDepth]) &lt; [BrowseDepth],
    BLANK (),
    SUM(Sales[Amount])
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3113"></span>To understand how this measure works, look at the report in <a href="#calibre_link-1039" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-16</a>. It contains all the values that are useful to grasp the behavior of the formula.</p>
<figure id="calibre_link-1039" class="image-l">
<img src="images/000749.jpg" alt="The report displays Amount, BrowseDepth, MaxNodeDepth, and PC Amount for each hierarchy level." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-16</strong> This report shows the result and all the partial measures used by the formula.</figcaption>
</figure>
<p class="edition">If you look at Annabel in the first row, you see that <em class="calibre5">BrowseDepth</em> equals 1 because this is the root of the hierarchy. <em class="calibre5">MaxNodeDepth</em>, which is defined as <em class="calibre5">MAX ( Persons[NodeDepth] )</em>, has a value of 2&mdash;meaning that the current node is not only showing data at level 1, but also data for some children that are at level 2. Thus, the current node is showing data for some children too, and for this reason it needs to be visible. The second line of Annabel, on the other hand, has a <em class="calibre5">BrowseDepth</em> of 2 and a <em class="calibre5">MaxNodeDepth</em> of 1. The reason is that the filter context filters all the rows where <em class="calibre5">Level1</em> equals Annabel and <em class="calibre5">Level2</em> equals Annabel, and there is only one row in the hierarchy satisfying this condition&mdash;this is Annabel herself. But Annabel has a <em class="calibre5">NodeDepth</em> of 1, and because the report is browsing at level 2, we need to hide the node. Indeed, the <em class="calibre5">PC Amount</em> measure returns a blank.</p>
<p class="edition">It is useful to verify the behavior for other nodes by yourself. This way you can improve your understanding of how the formula is working. Although one can simply return to this part of the book and copy the formula whenever they need to, understanding it is a good exercise because it forces you to think in terms of how the filter context interacts with various parts of the formula.</p>
<p class="edition">To reach the result, the last step is to remove all the columns that are not needed from the report, leaving <em class="calibre5">PC Amount</em> alone. The visualization becomes the one we wanted, as you can see in <a href="#calibre_link-1040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-17</a>.</p>
<figure id="calibre_link-1040" class="image-l">
<img src="images/000756.jpg" alt="The report shows the correct aggregated amount for all nine names, without any additional rows. Parents&apos; respective amounts are missing. Parents are displayed as aggregates of their own values and their children&apos;s." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3114"></span><strong class="calibre7">Figure 11-17</strong> Once the measure is left alone in the report, all unwanted rows disappear.</figcaption>
</figure>
<p class="edition">The biggest drawback of this approach is that the same pattern has to be used for any measure a user may add to the report after the P/C hierarchy is in place. If a measure that does not have a blank for unwanted rows is being used as a value, then all the rows will suddenly appear and disrupt the pattern.</p>
<p class="edition">At this point, the result is already satisfactory. Yet there is still a small problem. Indeed, if you look at the total of Annabel, it is 3,200. Summed up, her children show a total of 2,600. There is a missing amount of 600, which is the value of Annabel herself. Some might already be satisfied by this visualization: The value of a node is easy to calculate, by simply looking at the difference between its total and the total of its children. However, if you compare this figure to the original goal, you see that in the final formula, the value of each node is clearly visible as a child of the node itself. The comparison is visible in <a href="#calibre_link-1041" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-18</a>, which shows the current and the desired results together.</p>
<figure id="calibre_link-1041" class="image-l">
<img src="images/000763.jpg" alt="The report compares where we currently stand with our final goal." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-18</strong> The original goal has not been reached yet. We still need to show some rows.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3115"></span>At this point, the technique should be clear enough. To show a value for Annabel, we need to find a condition that lets us identify it as a node that should be made visible. In this case, the condition is somewhat complex. The nodes that need to be made visible are non-leaf nodes&mdash;that is, they have children&mdash;that have values for themselves. The code will make those nodes visible for one additional level. All other nodes&mdash;that is, leaf nodes or nodes with no value associated&mdash;will follow the original rule and be hidden when the hierarchy is browsing over their depth.</p>
<p class="edition">First, we need to create a calculated column in the <em class="calibre5">PC</em> table that indicates whether a node is a leaf. The DAX expression is easy: leaves are nodes that are not parents of any other node. In order to check the condition, we can count the number of nodes that have the current node as their parent. If it equals zero, then we know that the current node is a leaf. The following code does this:</p>
<p class="codelink"><a href="#calibre_link-1042" id="calibre_link-2564" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Persons[IsLeaf] =
VAR CurrentPersonKey = Persons[PersonKey]
VAR PersonsAtParentLevel =
    CALCULATE (
        COUNTROWS ( Persons ),
        ALL ( Persons ),
        Persons[ParentKey] = CurrentPersonKey
    )
VAR Result = ( PersonsAtParentLevel = 0 )
RETURN Result</pre></div>
<p class="edition">In <a href="#calibre_link-1043" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 11-19</a>, the <em class="calibre5">IsLeaf</em> column has been added to the data model.</p>
<figure id="calibre_link-1043" class="image-l">
<img src="images/000770.jpg" alt="The data model now contains IsLeaf, which is a Boolean value for each name." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 11-19</strong> The <em class="calibre5">IsLeaf</em> column indicates which nodes are leaves of the hierarchy.</figcaption>
</figure>
<p class="edition">Now that we can identify leaves, it is time to write the final formula for handling the P/C hierarchy:</p>
<p class="codelink"><a href="#calibre_link-1044" id="calibre_link-2565" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">FinalFormula =
VAR TooDeep = [MaxNodeDepth] + 1 &lt; [BrowseDepth]
VAR AdditionalLevel = [MaxNodeDepth] + 1 = [BrowseDepth]
VAR Amount =
    SUM ( Sales[Amount] )
VAR HasData =
    NOT ISBLANK ( Amount )
VAR Leaf =
<span type="pagebreak" id="calibre_link-2074"></span>    SELECTEDVALUE (
        Persons[IsLeaf],
        FALSE
    )
VAR Result =
    IF (
        NOT TooDeep,
        IF (
            AdditionalLevel,
            IF (
                NOT Leaf &amp;&amp; HasData,
                Amount
            ),
            Amount
        )
    )
RETURN
    Result</pre></div>
<p class="edition">The use of variables makes the formula easier to read. Here are some comments about their usage:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">TooDeep</em> checks if the browsing depth is greater than the maximum node depth plus one; that is, it checks whether the browsing of the report is over the additional level.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">AdditionalLevel</em> checks if the current browsing level is the additional level for nodes that have values for themselves and that are not leaves.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">HasData</em> checks if a node itself has a value.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Leaf</em> checks whether a node is a leaf or not.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Result</em> is the final result of the formula, making it easy to change the measure result to inspect intermediate steps during development.</p></li>
</ul>
<p class="edition">The remaining part of the code is just a set of <em class="calibre5">IF</em> statements that check the various scenarios and behave accordingly.</p>
<p class="edition">It is clear that if the data model had the ability to handle P/C hierarchies natively, then all this hard work would have been avoided. After all, this is not an easy formula to digest because it requires a full understanding of evaluation contexts and data modeling.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">If the model is in compatibility level 1400, you can enable the behavior of a special property called Hide Members. Hide Members automatically hides blank members. This property is unavailable in Power BI and in Power Pivot as of April 2019. A complete description of how to use this property in a Tabular model is available at <a href="https://docs.microsoft.com/en-us/sql/analysis-services/what-s-new-in-sql-server-analysis-services-2017?view=sqlserver-2017" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://docs.microsoft.com/en-us/sql/analysis-services/what-s-new-in-sql-server-analysis-services-2017?view=sqlserver-2017</a>. In case the tool you are using implements this important feature, then we strongly suggest using the Hide Members property instead of implementing the complex DAX code shown above to hide levels of an unbalanced hierarchy.</p>
</div>
</section>
<section class="calibre4">
<h3 id="calibre_link-185" class="h2a"><span type="pagebreak" id="calibre_link-2072"></span>Conclusions</h3>
<p class="edition">In this chapter you learned how to correctly handle calculations over hierarchies. As usual, we now recap the most relevant topics covered in the chapter:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Hierarchies are not part of DAX. They can be built in the model, but from a DAX point of view there is no way to reference a hierarchy and use it inside an expression.</p></li>
<li class="calibre10"><p class="listp">In order to detect the level of a hierarchy, one needs to use <em class="calibre5">ISINSCOPE</em>. Although it is a simple workaround, <em class="calibre5">ISINSCOPE</em> does not actually detect the browsing level; rather, it detects the presence of a filter on a column.</p></li>
<li class="calibre10"><p class="listp">Computing simple percentages over the parent requires the ability to both analyze the current level of a hierarchy and create a suitable set of filters to recreate the filter of the parent.</p></li>
<li class="calibre10"><p class="listp">Parent/child hierarchies can be handled in DAX by using the predefined <em class="calibre5">PATH</em> function and by building a proper set of columns, one for each level of the hierarchy.</p></li>
<li class="calibre10"><p class="listp">Unary operators, often used in parent/child hierarchies, can prove to be a challenge; they can therefore be handled in their simpler version (only +/-) by authoring rather complex DAX code. Handling more complex scenarios requires even more complicated DAX code, which is beyond the scope of this chapter.</p></li>
</ul>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1045">
<div id="calibre_link-3116" class="calibre2">
<div id="calibre_link-3117" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-17"><span type="pagebreak" id="calibre_link-1829"></span><span class="pd_ash">Chapter 12</span><br class="calibre3" />Working with tables</h2>
<p class="edition">Tables are an important part of DAX formulas. In previous chapters you learned how to iterate over tables, how to create calculated tables, and how to perform several other calculation techniques that require a table as their starting point. Moreover, <em class="calibre5">CALCULATE</em> filter arguments are tables: When authoring complex formulas, an ability to build the correct filter table is of paramount importance. DAX offers a rich set of functions to manage tables. In this chapter we introduce many DAX functions that are helpful for creating and managing tables.</p>
<p class="edition">For most of the new functions, we provide some examples that are useful for two purposes: They show how to use the function, and they act as a good DAX exercise to understand how to write complex measures.</p>
<section class="calibre4">
<h3 id="calibre_link-186" class="h2a">Using <em class="calibre5">CALCULATETABLE</em></h3>
<p class="edition">The first function to manipulate tables is <em class="calibre5">CALCULATETABLE</em>. We have already used <em class="calibre5">CALCULATETABLE</em> multiple times in the book prior to this point. In this section we provide a more complete reference to the function, along with some considerations about when to use it.</p>
<p class="edition"><em class="calibre5">CALCULATETABLE</em> performs the same operations as <em class="calibre5">CALCULATE</em>, the only difference being in their result. <em class="calibre5">CALCULATETABLE</em> returns a table, whereas <em class="calibre5">CALCULATE</em> returns a single value like an integer or a string. As an example, if one needs to produce a table containing only red products, then <em class="calibre5">CALCULATETABLE</em> is the function to use:</p>
<p class="codelink"><a href="#calibre_link-1046" id="calibre_link-2567" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATETABLE (
    'Product',
    'Product'[Color] = "Red"
)</pre></div>
<p class="edition">A common question is what the difference is between <em class="calibre5">CALCULATETABLE</em> and <em class="calibre5">FILTER</em>. Indeed, the previous expression can be written with <em class="calibre5">FILTER</em> too:</p>
<p class="codelink"><a href="#calibre_link-1047" id="calibre_link-2568" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">FILTER (
    'Product',
    'Product'[Color] = "Red"
)</pre></div>
<p class="edition">Even though the only difference seems to be the function name, in reality the semantics of these two functions are very different. <em class="calibre5">CALCULATETABLE</em> operates by changing the filter context first and <span type="pagebreak" id="calibre_link-3118"></span>later evaluating the expression. <em class="calibre5">FILTER</em>, on the other hand, iterates the result of its first argument, retrieving the rows that satisfy the condition. In other words, <em class="calibre5">FILTER</em> does not change the filter context.</p>
<p class="edition">You can appreciate the difference by reviewing the following example:</p>
<p class="codelink"><a href="#calibre_link-1048" id="calibre_link-2569" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Red Products CALCULATETABLE =
CALCULATETABLE (
    ADDCOLUMNS (
        VALUES ( 'Product'[Color] ),
        "Num of Products", COUNTROWS ( 'Product' )
    ),
    'Product'[Color] = "Red"
)</pre></div>
<p class="edition">The result is in <a href="#calibre_link-1049" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-1</a>.</p>
<figure id="calibre_link-1049" class="image-l">
<img src="images/000848.jpg" alt="The figure shows a table with only one row for Color and Num of Products." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-1</strong> There are 99 red products in the Contoso database.</figcaption>
</figure>
<p class="edition">By using <em class="calibre5">CALCULATETABLE</em>, the filter context where both <em class="calibre5">ADDCOLUMNS</em> and COUNTROWS are evaluated is filtering red products. Therefore, the result is one row only that contains red as color and 99 as number of products. In other words, <em class="calibre5">COUNTROWS</em> only counted the red products, without requiring a context transition from the row generated by the <em class="calibre5">VALUES</em> function.</p>
<p class="edition">If one replaces <em class="calibre5">CALCULATETABLE</em> with <em class="calibre5">FILTER</em>, the result is different. Look at the following table:</p>
<p class="codelink"><a href="#calibre_link-1050" id="calibre_link-2570" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Red Products FILTER external =
<strong class="calibre7">FILTER (</strong>
    ADDCOLUMNS (
        VALUES ( 'Product'[Color] ),
        "Num of Products", COUNTROWS ( 'Product' )
    ),
    'Product'[Color] = "Red"
)</pre></div>
<p class="edition">This time, the result is no longer 99; instead, it shows the total number of products, as shown in <a href="#calibre_link-1051" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-2</a>.</p>
<figure id="calibre_link-1051" class="image-l">
<img src="images/000855.jpg" alt="In this figure, the table still only has one row but Num of Products shoots to 2,517." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-2</strong> Although it shows a single line with Red, <em class="calibre5">Num of Products</em> counts all the products.</figcaption>
</figure>
<p class="edition">This table still contains Red for the product color, but now the number of products computes 2,517, which is the total number of products. The reason is that <em class="calibre5">FILTER</em> does not change the filter context. Moreover, <em class="calibre5">FILTER</em> is evaluated after <em class="calibre5">ADDCOLUMNS</em>. Consequently, <em class="calibre5">ADDCOLUMNS</em> iterates all the products, and <em class="calibre5">COUNTROWS</em> computes the total number of products because there is no context transition. Only later does <em class="calibre5">FILTER</em> select the Red row out of all the colors.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1830"></span>If one uses <em class="calibre5">FILTER</em> instead of <em class="calibre5">CALCULATETABLE</em>, the expression must be written differently, relying on <em class="calibre5">CALCULATE</em> to force the context transition:</p>
<p class="codelink"><a href="#calibre_link-1052" id="calibre_link-2571" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Red Products FILTER internal =
ADDCOLUMNS (
    FILTER (
        VALUES ( 'Product'[Color] ),
        'Product'[Color] = "Red"
    ),
    "Num of Products", <strong class="calibre7">CALCULATE ( COUNTROWS ( 'Product' ) )</strong>
)</pre></div>
<p class="edition">Now the result is back to 99. In order to obtain the same behavior as <em class="calibre5">CALCULATETABLE</em>, we needed to invert the execution order. This way <em class="calibre5">FILTER</em> runs first, and then the calculation of the number of rows relies on the context transition to force the row context of <em class="calibre5">ADDCOLUMNS</em> to become a filter context for <em class="calibre5">COUNTROWS</em>.</p>
<p class="edition"><em class="calibre5">CALCULATETABLE</em> works by modifying the filter context. It is powerful because it propagates its effect to multiple functions in a DAX expression. Its power comes with limitations in the type of filtering it can create. For example, <em class="calibre5">CALCULATETABLE</em> can only apply filters to columns that belong to the data model. If one only needs the customer whose sales amount is greater than one million, then <em class="calibre5">CALCULATETABLE</em> is not the right choice because <em class="calibre5">Sales Amount</em> is a measure. Therefore, <em class="calibre5">CALCULATETABLE</em> cannot apply a filter on a measure, whereas <em class="calibre5">FILTER</em> can. This is shown in the following expression; replacing <em class="calibre5">FILTER</em> with <em class="calibre5">CALCULATETABLE</em> is not an option, as it would lead to a syntax error:</p>
<p class="codelink"><a href="#calibre_link-1053" id="calibre_link-2572" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Large Customers =
FILTER (
    Customer,
    [Sales Amount] &gt; 1000000
)</pre></div>
<p class="edition"><em class="calibre5">CALCULATETABLE</em>&mdash;like <em class="calibre5">CALCULATE</em>&mdash;performs a context transition and can have all the <em class="calibre5">CALCULATE</em> modifiers like <em class="calibre5">ALL</em>, <em class="calibre5">USERELATIONSHIPS</em>, <em class="calibre5">CROSSFILTER</em>, and many others. Consequently, it is much more powerful than <em class="calibre5">FILTER</em>. This is not to say that one should always try to use <em class="calibre5">CALCULATETABLE</em> and stop using <em class="calibre5">FILTER</em>. Each of the two functions has advantages and disadvantages, and the choice needs to be an educated one.</p>
<p class="edition">As a rule of thumb, one uses <em class="calibre5">CALCULATETABLE</em> whenever they need to apply a filter on a model column and/or there is the need for the other functionalities of <em class="calibre5">CALCULATETABLE</em>, like context transition and filter context modifiers.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-187" class="h2a">Manipulating tables</h3>
<p class="edition">DAX offers several functions to manipulate tables. These functions can be used to create new calculated tables, to create tables to iterate on, or to use their results as filter arguments in <em class="calibre5">CALCULATE</em>. In this section we provide a complete reference of those functions, along with examples. There are also other table functions that are mainly useful in queries. We show them in <a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 13</a>, “<a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Authoring queries</a>.”</p>
<section class="calibre4">
<h4 id="calibre_link-188" class="calibre13"><span type="pagebreak" id="calibre_link-1649"></span>Using <em class="calibre5">ADDCOLUMNS</em></h4>
<p class="edition"><em class="calibre5">ADDCOLUMNS</em> is an iterator that returns all the rows and columns of its first argument, adding newly created columns to the output. For example, the following calculated table definition produces a table with all the colors and the value of sales amount for each color:</p>
<p class="codelink"><a href="#calibre_link-1054" id="calibre_link-2573" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ColorsWithSales =
ADDCOLUMNS (
    VALUES ( 'Product'[Color] ),
    "Sales Amount", [Sales Amount]
)</pre></div>
<p class="edition">You can see the result in <a href="#calibre_link-1055" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-3</a>.</p>
<figure id="calibre_link-1055" class="image-l">
<img src="images/000862.jpg" alt="The figure shows sales amount per color." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-3</strong> The result contains all the product colors and the sales amount for each color.</figcaption>
</figure>
<p class="edition">Being an iterator, <em class="calibre5">ADDCOLUMNS</em> evaluates the column expressions in a row context. In this example, it computes the sales of the given product color because the expression of <em class="calibre5">Sales Amount</em> uses a measure. Thus, there is an automatic <em class="calibre5">CALCULATE</em> surrounding <em class="calibre5">Sales Amount</em> that generates the context transition. If one uses a regular expression instead of a measure, then <em class="calibre5">CALCULATE</em> is frequently used to force the context transition.</p>
<p class="edition"><em class="calibre5">ADDCOLUMNS</em> is oftentimes used in conjunction with <em class="calibre5">FILTER</em> to obtain filters on temporary calculated columns. For example, to compute the products that sold more than 150,000.00 USD, a possible implementation is the following one:</p>
<p class="codelink"><a href="#calibre_link-1056" id="calibre_link-2574" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">HighSalesProducts =
VAR ProductsWithSales =
    ADDCOLUMNS (
<span type="pagebreak" id="calibre_link-3119"></span>        VALUES ( 'Product'[Product Name] ),
        "Product Sales", [Sales Amount]
    )
VAR Result =
    FILTER (
        ProductsWithSales,
        [Product Sales] &gt;= 150000
    )
RETURN Result</pre></div>
<p class="edition">You can see the result in <a href="#calibre_link-1057" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-4</a>.</p>
<figure id="calibre_link-1057" class="image-l">
<img src="images/000870.jpg" alt="The figure returns sales amount per product name." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-4</strong> The result contains all the product names and the sales amount for each name.</figcaption>
</figure>
<p class="edition">The same expression can be written in several different ways, even without using <em class="calibre5">ADDCOLUMNS</em>. The following code, for example, ends up even simpler than the previous one, even though it does not add a <em class="calibre5">Product Sales</em> column to the output:</p>
<p class="codelink"><a href="#calibre_link-1058" id="calibre_link-2575" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">FILTER (
    VALUES ( 'Product'[Product Name] ),
    [Sales Amount] &gt;= 150000
)</pre></div>
<p class="edition"><em class="calibre5">ADDCOLUMNS</em> is useful to compute multiple columns or when further calculations are needed after this first step. For example, consider computing the set of products that together represent 15% of total sales. This calculation is no longer trivial because several steps are needed:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">Computing the sales amount for each product.</p></li>
<li class="calibre25"><p class="listp">Computing a running total of sales amount, by aggregating each product with all the products that sold more than the product itself.</p></li>
<li class="calibre25"><p class="listp">Transforming the running total into a percentage against the grand total of sales.</p></li>
<li class="calibre25"><p class="listp">Only returning the products whose percentage is less than or equal to 15%.</p></li>
</ol>
<p class="edition"><span type="pagebreak" id="calibre_link-3120"></span>Authoring the full query in a single step is unnecessarily complex, whereas splitting the evaluation in four steps proves much easier:</p>
<p class="codelink"><a href="#calibre_link-1059" id="calibre_link-2576" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Top Products =
VAR TotalSales = [Sales Amount]
VAR ProdsWithSales =
    ADDCOLUMNS (
        VALUES ( 'Product'[Product Name] ),
        "ProductSales", [Sales Amount]
    )
VAR ProdsWithRT =
    ADDCOLUMNS (
        ProdsWithSales,
        "RunningTotal",
        VAR SalesOfCurrentProduct = [ProductSales]
        RETURN
            SUMX (
                FILTER (
                    ProdsWithSales,
                    [ProductSales] &gt;= SalesOfCurrentProduct
                ),
                [ProductSales]
            )
    )
VAR Top15Percent =
    FILTER (
        ProdsWithRT,
        [RunningTotal] / TotalSales &lt;= 0.15
    )
RETURN Top15Percent</pre></div>
<p class="edition">You can see the result in <a href="#calibre_link-1060" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-5</a>.</p>
<figure id="calibre_link-1060" class="image-l">
<img src="images/000878.jpg" alt="This table shows product sales and running total per product name." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-5</strong> The result contains the top products that generate 15% of sales.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1650"></span>In the example, we implemented the result as a calculated table, but other uses are possible. For example, one could iterate the <em class="calibre5">Top15Percent</em> variable using <em class="calibre5">SUMX</em> to create a measure computing the sales of those products.</p>
<p class="edition">As with most other DAX functions, one should think of <em class="calibre5">ADDCOLUMNS</em> as one of the many building blocks of DAX. The real power of DAX unfolds when you learn how to leverage those building blocks and have them interact in more sophisticated calculations.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-189" class="calibre13">Using <em class="calibre5">SUMMARIZE</em></h4>
<p class="edition"><em class="calibre5">SUMMARIZE</em> is one of the most commonly used functions in DAX. It scans a table (its first argument), grouping columns of the same or other related tables in groups of one or more. The main use of <em class="calibre5">SUMMARIZE</em> is to only retrieve an existing combination of values, rather than the full list of values.</p>
<p class="edition">An example would be computing the number of distinct colors sold, to produce a report that shows the number of colors available and the number of colors sold at least once. The following measures would produce the desired result:</p>
<p class="codelink"><a href="#calibre_link-1061" id="calibre_link-2577" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Num of colors :=
COUNTROWS (
    VALUES ( 'Product'[Color] )
)

Num of colors sold :=
COUNTROWS (
    SUMMARIZE ( Sales, 'Product'[Color] )
)</pre></div>
<p class="edition">You can see the result of these two measures by brand in the report in <a href="#calibre_link-1062" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-6</a>.</p>
<figure id="calibre_link-1062" class="image-l">
<img src="images/000886.jpg" alt="The report shows Num of Colors and Num of Colors sold by brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-6</strong> <em class="calibre5">Num of colors sold</em> uses <em class="calibre5">SUMMARIZE</em> to compute the number of colors sold.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3121"></span>In this case we used <em class="calibre5">SUMMARIZE</em> to group the sales by <em class="calibre5">Product[Color]</em>, and then we counted the number of rows in the result. Because <em class="calibre5">SUMMARIZE</em> performs a group by, it only returns the colors referenced by <em class="calibre5">Sales</em>. On the other hand, <em class="calibre5">VALUES ( Product[Color] )</em> returns all the existing colors whether they have sales or not.</p>
<p class="edition">Using <em class="calibre5">SUMMARIZE</em>, one can group data by any number of columns, provided that the columns used as parameters are reachable from <em class="calibre5">Sales</em> only when following many-to-one or one-to-one relationships. For example, to compute the average quantity sold per product and per day, this is one possible implementation:</p>
<p class="codelink"><a href="#calibre_link-1063" id="calibre_link-2578" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AvgDailyQty :=
VAR ProductsDatesWithSales =
    SUMMARIZE (
        Sales,
        'Product'[Product Name],
        'Date'[Date]
    )
VAR Result =
    AVERAGEX (
        ProductsDatesWithSales,
        CALCULATE (
            SUM ( Sales[Quantity] )
        )
    )
RETURN Result</pre></div>
<p class="edition">You can see the result of this measure in <a href="#calibre_link-1064" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-7</a>.</p>
<figure id="calibre_link-1064" class="image-l">
<img src="images/000894.jpg" alt="The report shows the average daily sales quantity per year and per brand, along with an overall average in the total column." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-7</strong> The report shows the average daily sales quantity per year and per brand.</figcaption>
</figure>
<p class="edition">In this case, we used <em class="calibre5">SUMMARIZE</em> to scan <em class="calibre5">Sales</em> and to group it by product name and by date. The resulting table contains the product name and the date, only considering days with sales for that product. <em class="calibre5">AVERAGEX</em> takes care of computing the average over each row of the temporary table returned by <span type="pagebreak" id="calibre_link-1651"></span><em class="calibre5">SUMMARIZE</em>. If there are no sales for a certain product on any given day, then the resulting table will not contain that date.</p>
<p class="edition"><em class="calibre5">SUMMARIZE</em> can also be used like <em class="calibre5">ADDCOLUMNS</em> to add further columns to the result. For example, the previous measure could also be authored the following way:</p>
<p class="codelink"><a href="#calibre_link-1065" id="calibre_link-2579" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AvgDailyQty :=
VAR ProductsDatesWithSalesAndQuantity =
    SUMMARIZE (
        Sales,
        'Product'[Product Name],
        'Date'[Date],
        <strong class="calibre7">"Daily qty", SUM ( Sales[Quantity] )x</strong>
    )
VAR Result =
    AVERAGEX (
        ProductsDatesWithSalesAndQuantity,
        [Daily qty]
    )
RETURN Result</pre></div>
<p class="edition">In this case <em class="calibre5">SUMMARIZE</em> returns a table that contains the product name, the date, and a newly introduced column named <em class="calibre5">Daily qty</em>. <em class="calibre5">Daily qty</em> is later averaged by <em class="calibre5">AVERAGEX</em>. Nevertheless, <strong class="calibre7"><em class="calibre5">the use of SUMMARIZE to create temporary columns is deprecated</em></strong> because <em class="calibre5">SUMMARIZE</em> creates one row context and one filter context at the same time. For this reason, results are complex to understand when a context transition is generated in the expression by referencing either a measure or an explicit <em class="calibre5">CALCULATE</em> function. If one needs to compute additional columns after <em class="calibre5">SUMMARIZE</em> has performed the grouping operation, then it is better to use a pair of <em class="calibre5">ADDCOLUMNS</em> and <em class="calibre5">SUMMARIZE</em> together:</p>
<p class="codelink"><a href="#calibre_link-1066" id="calibre_link-2580" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AvgDailyQty :=
VAR ProductsDatesWithSales =
    SUMMARIZE (
        Sales,
        'Product'[Product Name],
        'Date'[Date]
    )
VAR ProductsDatesWithSalesAndQuantity =
    ADDCOLUMNS (
        ProductsDatesWithSales,
        "Daily qty", CALCULATE ( SUM ( Sales[Quantity] ) )
    )
VAR Result =
    AVERAGEX (
        ProductsDatesWithSalesAndQuantity,
        [Daily qty]
    )
RETURN Result</pre></div>
<p class="edition">Despite the code being more verbose, it is much easier to read and write because there is a single row context used in a context transition. This row context is introduced by <em class="calibre5">ADDCOLUMNS</em> while iterating over the result of <em class="calibre5">SUMMARIZE</em>. This pattern results in simpler (and most of the times faster) code.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1652"></span>It is possible to use more&mdash;optional&mdash;parameters with <em class="calibre5">SUMMARIZE</em>. They exist for the calculation of subtotals and to add columns to the result. We deliberately decided not to write about them to make the point even stronger: <em class="calibre5">SUMMARIZE works fine when grouping tables and should not be used to compute additional columns</em>. Although you can find code on the web that still uses <em class="calibre5">SUMMARIZE</em> to author new columns, consider it a very bad practice and always replace it with the pair <em class="calibre5">ADDCOLUMNS</em>/<em class="calibre5">SUMMARIZE</em>.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-190" class="calibre13">Using <em class="calibre5">CROSSJOIN</em></h4>
<p class="edition"><em class="calibre5">CROSSJOIN</em> performs the cross-join of two tables, returning the cartesian product of the two input tables. In other words, it returns all possible combinations of the values in the input tables. For example, the following expression returns all the combinations of product names and years:</p>
<p class="codelink"><a href="#calibre_link-1067" id="calibre_link-2581" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CROSSJOIN (
    ALL ( 'Product'[Product Name] ),
    ALL ( 'Date'[Calendar Year] )
)</pre></div>
<p class="edition">If the model contains 1,000 product names and five years, the resulting table contains 5,000 rows. <em class="calibre5">CROSSJOIN</em> is more often used in queries than in measures. Nevertheless, there are some scenarios where the use of <em class="calibre5">CROSSJOIN</em> becomes relevant&mdash;mostly because of performance.</p>
<p class="edition">For example, consider the need for an <em class="calibre5">OR</em> condition between two different columns in a <em class="calibre5">CALCULATE</em> filter argument. Because <em class="calibre5">CALCULATE</em> merges its filter arguments with an intersection, implementing the <em class="calibre5">OR</em> condition requires closer attention. For example, this is a possible implementation of <em class="calibre5">CALCULATE</em> filtering all the products that belong to the Audio category or have a Black color:</p>
<p class="codelink"><a href="#calibre_link-1068" id="calibre_link-2582" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AudioOrBlackSales :=
VAR CategoriesColors =
    SUMMARIZE (
        'Product',
        'Product'[Category],
        'Product'[Color]
    )
VAR AudioOrBlack =
    FILTER (
        CategoriesColors,
        OR (
            'Product'[Category] = "Audio",
            'Product'[Color] = "Black"
        )
    )
VAR Result =
    CALCULATE (
        [Sales Amount],
        AudioOrBlack
    )
RETURN Result</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2062"></span>The previous code works well, and it is optimal also from a performance point of view. <em class="calibre5">SUMMARIZE</em> scans the <em class="calibre5">Product</em> table, which is expected to contain a small number of rows. Thus, the evaluation of the filter is very quick.</p>
<p class="edition">If the requirement is to filter columns from different tables like color and year, then things are different. Indeed, one could extend the previous example; but to summarize by columns from two separate tables, <em class="calibre5">SUMMARIZE</em> needs to scan the <em class="calibre5">Sales</em> table:</p>
<p class="codelink"><a href="#calibre_link-1069" id="calibre_link-2583" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AudioOr2007 Sales :=
VAR CategoriesYears =
    SUMMARIZE (
        Sales,
        'Product'[Category],
        'Date'[Calendar Year]
    )
VAR Audio2007 =
    FILTER (
        CategoriesYears,
        OR (
            'Product'[Category] = "Audio",
            'Date'[Calendar Year] = "CY 2007"
        )
    )
VAR Result =
    CALCULATE (
        [Sales Amount],
        Audio2007
    )
RETURN Result</pre></div>
<p class="edition"><em class="calibre5">Sales</em> is not a small table; it might contain hundreds of millions of rows. Scanning it to retrieve the existing combinations of category and years could result in an expensive operation. Regardless, the resulting filter is not going to be large because there are only a few categories and years, yet the engine needs to scan a large table to retrieve the filter.</p>
<p class="edition">In that scenario, we recommend you build all the combinations of category and year, producing a small table; you would then filter that table, as in the following code:</p>
<p class="codelink"><a href="#calibre_link-1070" id="calibre_link-2584" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AudioOr2007 Sales :=
VAR CategoriesYears =
    <strong class="calibre7">CROSSJOIN (</strong>
        <strong class="calibre7">VALUES ( 'Product'[Category] ),</strong>
        <strong class="calibre7">VALUES ( 'Date'[Calendar Year] )</strong>
    <strong class="calibre7">)</strong>
VAR Audio2007 =
    FILTER (
        CategoriesYears,
        OR (
            'Product'[Category] = "Audio",
            'Date'[Calendar Year] = "CY 2007"
        )
    )
<span type="pagebreak" id="calibre_link-1915"></span>VAR Result =
    CALCULATE (
        [Sales Amount],
        Audio2007
    )
RETURN Result</pre></div>
<p class="edition">The full <em class="calibre5">CROSSJOIN</em> of categories and years contains a few hundred rows and the execution of this last version of the measure is faster.</p>
<p class="edition"><em class="calibre5">CROSSJOIN</em> is not only useful to speed up calculations. Sometimes, one is interested in retrieving rows even when no event happened. For example, by using <em class="calibre5">SUMMARIZE</em> to scan sales by category and country, the result only contains the categories and countries with sales for certain products. This is the intended behavior of <em class="calibre5">SUMMARIZE</em>, so it is not surprising. However, sometimes the absence of an event is more important than its presence. For example, one might want to investigate which brands have no sales in certain regions. In that case, the measure needs to build a more complex expression involving a <em class="calibre5">CROSSJOIN</em>, so to be able to also retrieve nonexistent combinations of values. We will provide more examples of <em class="calibre5">CROSSJOIN</em> in the next chapter.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-191" class="calibre13">Using <em class="calibre5">UNION</em></h4>
<p class="edition"><em class="calibre5">UNION</em> is a set function that performs the union of two tables. The ability to combine different tables into a single table can be important in certain circumstances. It is mainly used in calculated tables, much less frequently in measures. For example, the following table contains all the countries from both the <em class="calibre5">Customer</em> and the <em class="calibre5">Store</em> tables:</p>
<p class="codelink"><a href="#calibre_link-1071" id="calibre_link-2585" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AllCountryRegions =
UNION (
    ALL ( Customer[CountryRegion] ),
    ALL ( Store[CountryRegion] )
)</pre></div>
<p class="edition">You can look at the result in <a href="#calibre_link-1072" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-8</a>.</p>
<figure id="calibre_link-1072" class="image-l">
<img src="images/000902.jpg" alt="The report is a single column, CountryRegion, which lists countries from two different tables." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-8</strong> <em class="calibre5">UNION</em> does not remove duplicates.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-2004"></span><em class="calibre5">UNION</em> does not remove duplicates before returning a result. Thus, if Australia belongs to the countries of both customers and stores, it appears twice in the resulting table. If needed, leveraging the <em class="calibre5">DISTINCT</em> function will remove duplicates.</p>
<p class="edition">We have described and used <em class="calibre5">DISTINCT</em> multiple times prior to this point, to obtain the distinct values of a column as visible in the current filter context. <em class="calibre5">DISTINCT</em> can also be used with a table expression as a parameter, and in that special case it returns the distinct rows of the table. Thus, the following is a good implementation removing potential duplicates from the <em class="calibre5">CountryRegion</em> column:</p>
<p class="codelink"><a href="#calibre_link-1073" id="calibre_link-2586" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DistinctCountryRegions =
VAR CountryRegions =
    UNION (
        ALL ( Customer[CountryRegion] ),
        ALL ( Store[CountryRegion] )
   )
VAR UniqueCountryRegions =
    DISTINCT ( CountryRegions )
RETURN UniqueCountryRegions</pre></div>
<p class="edition">You can see the resulting table in <a href="#calibre_link-1074" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-9</a>.</p>
<figure id="calibre_link-1074" class="image-l">
<img src="images/000909.jpg" alt="In this report, CountryRegion only displays countries once." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-9</strong> <em class="calibre5">DISTINCT</em> removes duplicates from a table.</figcaption>
</figure>
<p class="edition"><em class="calibre5">UNION</em> maintains the data lineage of the input tables if the lineage of both tables is the same. In the previous formula, the result of <em class="calibre5">DISTINCT</em> has no lineage because the first table contains <em class="calibre5">Customer[CountryRegion]</em>, and the second table contains <em class="calibre5">Store[CountryRegion]</em>. Because the data lineage of the input tables is different, the result has a new lineage not corresponding to any of the existing columns. Therefore, the following calculated table returns the same grand total of sales on all the rows:</p>
<p class="codelink"><a href="#calibre_link-1075" id="calibre_link-2587" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DistinctCountryRegions =
VAR CountryRegions =
    UNION (
        ALL ( Customer[CountryRegion] ),
        ALL ( Store[CountryRegion] )
   )
<span type="pagebreak" id="calibre_link-1815"></span>VAR UniqueCountryRegions =
    DISTINCT ( CountryRegions )
VAR Result =
    ADDCOLUMNS (
        UniqueCountryRegions,
        "Sales Amount", [Sales Amount]
    )
RETURN Result</pre></div>
<p class="edition">The result is presented in <a href="#calibre_link-1076" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-10</a>.</p>
<figure id="calibre_link-1076" class="image-l">
<img src="images/000916.jpg" alt="In this report, you see sales amount per country. There are no duplicates in the CountryRegion column, and all amounts are the same." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-10</strong> <em class="calibre5">CountryRegion</em> is not a column in the model. Therefore, it does not filter <em class="calibre5">Sales Amount</em>.</figcaption>
</figure>
<p class="edition">If the calculated table needs to contain both the sales amount and the number of stores, including all country regions of both customers and stores, then the filtering must be handled manually through a more complex expression:</p>
<p class="codelink"><a href="#calibre_link-1077" id="calibre_link-2588" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DistinctCountryRegions =
VAR CountryRegions =
    UNION (
        ALL ( Customer[CountryRegion] ),
        ALL ( Store[CountryRegion] )
   )
VAR UniqueCountryRegions =
    DISTINCT ( CountryRegions )
VAR Result =
    ADDCOLUMNS (
        UniqueCountryRegions,
        "Customer Sales Amount",
            VAR CurrentRegion = [CountryRegion]
            RETURN
                CALCULATE (
                    [Sales Amount],
                    Customer[CountryRegion] = CurrentRegion
                ),
        "Number of stores",
            VAR CurrentRegion = [CountryRegion]
            RETURN
                CALCULATE (
                    COUNTROWS ( Store ),
<span type="pagebreak" id="calibre_link-2069"></span>                    Store[CountryRegion] = CurrentRegion
                )
    )
RETURN Result</pre></div>
<p class="edition">You see the result in <a href="#calibre_link-1078" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-11</a>.</p>
<figure id="calibre_link-1078" class="image-l">
<img src="images/000923.jpg" alt="The report shows Customer Sales Amount and Number of stores per CountryRegion. The numbers make sense." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-11</strong> By using more complex <em class="calibre5">CALCULATE</em> statements, one can move the filter on stores and sales.</figcaption>
</figure>
<p class="edition">In the previous example <em class="calibre5">CALCULATE</em> applies a filter on either the customer or the store country region, using the value currently iterated by <em class="calibre5">ADDCOLUMN</em> on the result of <em class="calibre5">UNION</em>. Another option to obtain the same result is to restore the lineage using <em class="calibre5">TREATAS</em> (see <a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10</a>, “<a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with the filter context</a>,” for more information about <em class="calibre5">TREATAS</em>), as in the following equivalent expression:</p>
<p class="codelink"><a href="#calibre_link-1079" id="calibre_link-2589" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DistinctCountryRegions =
VAR CountryRegions =
    UNION (
        ALL ( Customer[CountryRegion] ),
        ALL ( Store[CountryRegion] )
    )
VAR UniqueCountryRegions =
    DISTINCT ( CountryRegions )
VAR Result =
    ADDCOLUMNS (
        UniqueCountryRegions,
        "Customer Sales Amount", CALCULATE (
            [Sales Amount],
            TREATAS (
                { [CountryRegion] },
                Customer[CountryRegion]
            )
        ),
        "Number of stores", CALCULATE (
            COUNTROWS ( Store ),
            TREATAS (
                { [CountryRegion] },
<span type="pagebreak" id="calibre_link-1816"></span>                Store[CountryRegion]
            )
        )
    )
RETURN Result</pre></div>
<p class="edition">The result of our last two examples is the same; what differs is the technique used to move the filter from a new column to one that is part of the model. Moreover, in this last example you may notice the use of a table constructor: The curly braces transform <em class="calibre5">CountryRegion</em> into a table that can be used as a parameter of <em class="calibre5">TREATAS</em>.</p>
<p class="edition">Because <em class="calibre5">UNION</em> loses the data lineage if values come from different columns, <em class="calibre5">TREATAS</em> is a convenient function to control the data lineage of the result. It is worth noting that <em class="calibre5">TREATAS</em> ignores values that do not exist in the target columns.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-192" class="calibre13">Using <em class="calibre5">INTERSECT</em></h4>
<p class="edition"><em class="calibre5">INTERSECT</em> is a set function much like <em class="calibre5">UNION</em>. However, instead of appending one table to another, it returns the intersection of the two tables&mdash;that is, only the rows that appear in both tables. It was popular before the <em class="calibre5">TREATAS</em> function was introduced because it allows one to apply the result of a table expression as a filter to other tables and columns. Since the introduction of <em class="calibre5">TREATAS</em>, the number of use cases of <em class="calibre5">INTERSECT</em> was greatly reduced.</p>
<p class="edition">For example, if one needs to retrieve the customers who bought in both 2007 and 2008, a possible implementation is the following:</p>
<p class="codelink"><a href="#calibre_link-1080" id="calibre_link-2590" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CustomersBuyingInTwoYears =
VAR Customers2007 =
    CALCULATETABLE (
        SUMMARIZE ( Sales, Customer[Customer Code] ),
        'Date'[Calendar Year] = "CY 2007"
    )
VAR Customers2008 =
    CALCULATETABLE (
        SUMMARIZE ( Sales, Customer[Customer Code] ),
        'Date'[Calendar Year] = "CY 2008"
    )
VAR Result =
    INTERSECT ( Customers2007, Customers2008 )
RETURN Result</pre></div>
<p class="edition">From the lineage point of view, <em class="calibre5">INTERSECT</em> retains the data lineage of the first table. In the previous example, both tables have the same data lineage. If one builds a table with different data lineages, then only the lineage of the first table is kept. For example, the countries where there are both customers and stores can be expressed as follows:</p>
<p class="codelink"><a href="#calibre_link-1081" id="calibre_link-2591" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">INTERSECT (
    ALL ( Store[CountryRegion] ),
    ALL ( Customer[CountryRegion] )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2026"></span>In this latter example, the lineage is that of <em class="calibre5">Store[CountryRegion]</em>. Consequently, a more complex expression like the following returns the sales filtered by <em class="calibre5">Store[CountryRegion]</em>, not <em class="calibre5">Customer[CountryRegion]</em>:</p>
<p class="codelink"><a href="#calibre_link-1082" id="calibre_link-2592" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SalesStoresInCustomersCountries =
VAR CountriesWithStoresAndCustomers =
    INTERSECT (
        ALL ( Store[CountryRegion] ),
        ALL ( Customer[CountryRegion] )
    )
VAR Result =
    ADDCOLUMNS (
        CountriesWithStoresAndCustomers,
        "StoresSales", [Sales Amount]
    )
RETURN Result</pre></div>
<p class="edition">You see the result of this expression in <a href="#calibre_link-1083" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-12</a>.</p>
<figure id="calibre_link-1083" class="image-l">
<img src="images/000930.jpg" alt="The report shows stores sales per country/region. Only certain countries have data for stores sales; others are left blank." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-12</strong> <em class="calibre5">StoresSales</em> contains the sales in the store country, not the sales in the customer country.</figcaption>
</figure>
<p class="edition">In this latter example, the <em class="calibre5">StoresSales</em> column contains the sales related to the country of the store.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-193" class="calibre13">Using <em class="calibre5">EXCEPT</em></h4>
<p class="edition"><em class="calibre5">EXCEPT</em> is the last of the set functions introduced in this section. <em class="calibre5">EXCEPT</em> removes the rows present in the second table from the first table. As such, it implements set subtraction with two tables. For example, if one is interested in customers who bought a product in 2007 but not in 2008, one possible implementation is the following:</p>
<p class="codelink"><a href="#calibre_link-1084" id="calibre_link-2593" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CustomersBuyingIn2007butNotIn2008 =
VAR Customers2007 =
    CALCULATETABLE (
        SUMMARIZE ( Sales, Customer[Customer Code] ),
<span type="pagebreak" id="calibre_link-1918"></span>        'Date'[Calendar Year] = "CY 2007"
    )
VAR Customers2008 =
    CALCULATETABLE (
        SUMMARIZE ( Sales, Customer[Customer Code] ),
        'Date'[Calendar Year] = "CY 2008"
    )
VAR Result =
    EXCEPT ( Customers2007, Customers2008 )
RETURN Result</pre></div>
<p class="edition">The first rows of the calculated table are visible in <a href="#calibre_link-1085" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-13</a>.</p>
<figure id="calibre_link-1085" class="image-l">
<img src="images/000937.jpg" alt="The report only shows one column, Customer Code." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-13</strong> Partial list of customers that bought a product in 2007 but not in 2008.</figcaption>
</figure>
<p class="edition">As usual, one could use the previous calculation as a filter argument of <em class="calibre5">CALCULATE</em> to obtain the sales amount of those customers. <em class="calibre5">EXCEPT</em> is frequently used when analyzing customer behavior. For example, a common calculation for many businesses is establishing the number of new customers, returning customers, and lost customers.</p>
<p class="edition">There are several possible implementations of the same calculations, each one targeted to a specific data model. The following implementation is not always the most optimal, but it is flexible and easy to understand. To compute the number of customers who did not buy anything last year but bought something this year, the following measure removes customers who bought a product in the previous year from the set of current customers:</p>
<p class="codelink"><a href="#calibre_link-1086" id="calibre_link-2594" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SalesOfNewCustomers :=
VAR CurrentCustomers =
    VALUES ( Sales[CustomerKey] )
VAR CustomersLastYear =
    CALCULATETABLE (
        VALUES ( Sales[CustomerKey] ),
        DATESINPERIOD ( 'Date'[Date], MIN ( 'Date'[Date] ) - 1, -1, YEAR )
    )
VAR CustomersNotInLastYear =
    EXCEPT ( CurrentCustomers, CustomersLastYear )
VAR Result =
    CALCULATE ( [Sales Amount], CustomersNotInLastYear )
RETURN Result</pre></div>
<p class="edition">The implementation of this code as a measure works with any filter and provides a flexible way to slice by any column. Please be mindful that this implementation of new customers is not the best in <span type="pagebreak" id="calibre_link-1919"></span>terms of performance. We used it here to demonstrate a possible usage of <em class="calibre5">EXCEPT</em>. Later in this chapter we show a much faster version of the same calculation, although a bit more complex to learn.</p>
<p class="edition">From the lineage point of view, <em class="calibre5">EXCEPT</em> retains the data lineage of the first table, as was the case with <em class="calibre5">INTERSECT</em>. For example, the following expression computes the sales made to customers living in countries where there are no stores:</p>
<p class="codelink"><a href="#calibre_link-1087" id="calibre_link-2595" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SalesInCountriesWithNoStores :=
VAR CountriesWithActiveStores =
    CALCULATETABLE (
        SUMMARIZE ( Sales, Store[CountryRegion] ),
        ALL ( Sales )
    )
VAR CountriesWithSales =
    SUMMARIZE ( Sales, Customer[CountryRegion] )
VAR CountriesWithNoStores =
    EXCEPT ( CountriesWithSales, CountriesWithActiveStores )
VAR Result =
    CALCULATE (
        [Sales Amount],
        CountriesWithNoStores
    )
RETURN Result</pre></div>
<p class="edition">The result of <em class="calibre5">EXCEPT</em> filters the <em class="calibre5">Customer[CountryRegion]</em> column because it is the column used by the table taken as the first argument of <em class="calibre5">EXCEPT</em>.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-194" class="h2a">Using tables as filters</h3>
<p class="edition">Functions manipulating tables are oftentimes used to build complex filters for <em class="calibre5">CALCULATE</em> parameters. In this section, we provide further examples, always leading you one step further in your understanding of DAX.</p>
<section class="calibre4">
<h4 id="calibre_link-195" class="calibre13">Implementing <em class="calibre5">OR</em> conditions</h4>
<p class="edition">A first example where manipulating tables proves to be a useful skill is the following. Imagine having to implement an <em class="calibre5">OR</em> condition between the selections made in different slicers, instead of the default <em class="calibre5">AND</em> behavior provided by client tools like Excel and Power BI.</p>
<p class="edition">The report in <a href="#calibre_link-1088" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-14</a> contains two slicers. The default behavior of Power BI is to intersect the two conditions. As a consequence, the numbers shown represent the sales of Home Appliances to customers with a High School education.</p>
<figure id="calibre_link-1088" class="image-l">
<img src="images/000944.jpg" alt="The report shows sales for several years, per month. The results are sliced per category and education level." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1807"></span><strong class="calibre7">Figure 12-14</strong> By default, slicer conditions are intersected so that all the conditions are applied together.</figcaption>
</figure>
<p class="edition">Instead of intersecting the two conditions, one might want to merge them. In other words, the numbers shown in the report need to be the sales of products sold to customers with a High School education or the sales of Home Appliances. Because Power BI does not support “or” conditions between slicers, one can solve the problem by using DAX.</p>
<p class="edition">Remember that each cell of the report has a filter context containing both a filter on the category and a filter on the education. Both filters need to be replaced. There are several possible solutions to the same pattern; we demonstrate the use of three different formulas.</p>
<p class="edition">The first, and probably the easiest expression of that filter, is the following:</p>
<p class="codelink"><a href="#calibre_link-1089" id="calibre_link-2596" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">OR 1 :=
VAR CategoriesEducations =
    CROSSJOIN (
        ALL ( 'Product'[Category] ),
        ALL ( Customer[Education] )
    )
VAR CategoriesEducationsSelected =
    FILTER (
        CategoriesEducations,
        OR (
            'Product'[Category] IN VALUES ( 'Product'[Category] ),
            Customer[Education] IN VALUES ( Customer[Education] )
        )
    )
VAR Result =
    CALCULATE (
        [Sales Amount],
        CategoriesEducationsSelected
    )
RETURN Result</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1916"></span>The measure first builds the cross-join of all the categories and education levels. Once the table is prepared, it filters out the rows that do not satisfy the condition, and finally it uses the resulting table as a filter argument for <em class="calibre5">CALCULATE</em>. <em class="calibre5">CALCULATE</em> overrides the current filter on both the category and the education, resulting in the report in <a href="#calibre_link-1090" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-15</a>.</p>
<figure id="calibre_link-1090" class="image-l">
<img src="images/000951.jpg" alt="The report shows sales volumes for Home Appliances or High School, monthly for each year." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-15</strong> The report now shows sales volumes for the Home Appliances category <em class="calibre5">OR</em> the High School education level.</figcaption>
</figure>
<p class="edition">The first implementation of the measure is already simple&mdash;both to use and to understand. In case there is a large number of rows in the columns used to filter the <em class="calibre5">OR</em> condition, or when there are more than just two conditions, the resulting temporary table would quickly become huge. In such a case, one can limit its size by removing the <em class="calibre5">CROSSJOIN</em> in favor of <em class="calibre5">SUMMARIZE</em>, as in this second implementation of the same measure:</p>
<p class="codelink"><a href="#calibre_link-1091" id="calibre_link-2597" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">OR 2 :=
VAR CategoriesEducations =
    <strong class="calibre7">CALCULATETABLE (</strong>
        <strong class="calibre7">SUMMARIZE (</strong>
            <strong class="calibre7">Sales,</strong>
            <strong class="calibre7">'Product'[Category],</strong>
            <strong class="calibre7">Customer[Education]</strong>
        <strong class="calibre7">),</strong>
        <strong class="calibre7">ALL ( 'Product'[Category] ),</strong>
        <strong class="calibre7">ALL ( Customer[Education] )</strong>
    <strong class="calibre7">)</strong>
VAR CategoriesEducationsSelected =
    FILTER (
        CategoriesEducations,
        OR (
            'Product'[Category] IN VALUES ( 'Product'[Category] ),
            Customer[Education] IN VALUES ( Customer[Education] )
        )
    )
VAR Result =
    CALCULATE (
<span type="pagebreak" id="calibre_link-1808"></span>         [Sales Amount],
        CategoriesEducationsSelected
    )
RETURN Result</pre></div>
<p class="edition">The logic of this second implementation is close to the first one, the only noticeably difference being the presence of <em class="calibre5">SUMMARIZE</em> instead of <em class="calibre5">CROSSJOIN</em>. Moreover, it is worth pointing out that <em class="calibre5">SUMMARIZE</em> needs to be executed in a filter context without the filter on <em class="calibre5">Category</em> and <em class="calibre5">Education</em>. Otherwise, the slicer would affect the calculation executed by <em class="calibre5">SUMMARIZE</em>, destroying the effort of the filter.</p>
<p class="edition">There is at least a third solution to the same scenario, potentially faster though harder to understand at first sight. Indeed, the same table filter can be expressed thinking that if the category is in the selected values for the categories, then any value for the education level is fine. The same happens for the education level: As long as the education level is in the selected values for the education level, then any category is fine. This reasoning leads to the third formulation of the same expression:</p>
<p class="codelink"><a href="#calibre_link-1092" id="calibre_link-2598" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">OR 3 :=
<strong class="calibre7">VAR Categories =</strong>
    <strong class="calibre7">CROSSJOIN (</strong>
        <strong class="calibre7">VALUES ( 'Product'[Category] ),</strong>
        <strong class="calibre7">ALL ( Customer[Education] )</strong>
    <strong class="calibre7">)</strong>
<strong class="calibre7">VAR Educations =</strong>
    <strong class="calibre7">CROSSJOIN (</strong>
        <strong class="calibre7">ALL ( 'Product'[Category] ),</strong>
        <strong class="calibre7">VALUES ( Customer[Education] )</strong>
    <strong class="calibre7">)</strong>
VAR CategoriesEducationsSelected =
    <strong class="calibre7">UNION ( Categories, Educations )</strong>
VAR Result =
    CALCULATE (
         [Sales Amount],
        CategoriesEducationsSelected
    )
RETURN Result</pre></div>
<p class="edition">As you can see, one can author the same formula in several ways. The difference is in both readability and performance. Being able to write the same formula using different methods is a skill that will prove extremely useful in the final optimization chapters, where you learn to evaluate the performance of different versions of the same code, seeking the most optimal.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-196" class="calibre13">Narrowing sales computation to the first year’s customers</h4>
<p class="edition">As another example of a useful calculation involving the manipulation of tables, we demonstrate how to analyze sales over time but only considering customers who made a purchase during the first year of a selected time period. In other words, we consider the first year with sales in <span type="pagebreak" id="calibre_link-3122"></span>the visual, evaluate the customers who bought during that first year, and then we only analyze the sales of those customers over the following years, ignoring those who became customers afterwards.</p>
<p class="edition">The code needs to perform three steps:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">Checking what is the first year with sales on any product.</p></li>
<li class="calibre25"><p class="listp">Storing the set of customers of that first year into a variable, ignoring any other filter.</p></li>
<li class="calibre25"><p class="listp">Computing the sales of the customers determined in step 2 in the current period.</p></li>
</ol>
<p class="edition">The following code implements this algorithm by using variables to store temporary results:</p>
<p class="codelink"><a href="#calibre_link-1093" id="calibre_link-2599" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SalesOfFirstYearCustomers :=
VAR FirstYearWithSales =
    CALCULATETABLE (
        FIRSTNONBLANK (
            'Date'[Calendar Year],
            [Sales Amount]
        ),
        ALLSELECTED ()
    )
VAR CustomersFirstYear =
    CALCULATETABLE (
        VALUES ( Sales[CustomerKey] ),
        FirstYearWithSales,
        ALLSELECTED ()
    )
VAR Result =
    CALCULATE (
        [Sales Amount],
        KEEPFILTERS ( CustomersFirstYear )
    )
RETURN Result</pre></div>
<p class="edition">The <em class="calibre5">FirstYearWithSales</em> variable stores the first year with sales. Please note that <em class="calibre5">FIRSTNONBLANK</em> returns a table as a result, with the data lineage of <em class="calibre5">Date[Calendar Year]</em>. The <em class="calibre5">CustomersFirstYear</em> variable retrieves the list of all customers in that first year. The last step is the easiest because it only applies the filter on the customer; in each cell of the report, the value of <em class="calibre5">Sales Amount</em> is restricted to only the customers found during the second step. The <em class="calibre5">KEEPFILTERS</em> modifier makes it possible to filter these customers by country, for example.</p>
<p class="edition">The result is visible in <a href="#calibre_link-1094" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-16</a>, indicating that&mdash;after the first year&mdash;sales made to those customers are decreasing over time.</p>
<figure id="calibre_link-1094" class="image-l">
<img src="images/000958.jpg" alt="The figure shows sales volumes over the years per category." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1920"></span><strong class="calibre7">Figure 12-16</strong> The report shows sales over the years, focusing only on customers acquired in 2007.</figcaption>
</figure>
<p class="edition">This latter example is important to learn. Indeed, there are several scenarios where one needs to place a filter over time, compute a set, and finally analyze the behavior of this set (of customers, products, stores) over different years. With this pattern one can easily implement same-store analyses or any other calculation with similar requirements.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-197" class="calibre13">Computing new customers</h4>
<p class="edition">In a previous section of this chapter about <em class="calibre5">EXCEPT</em>, we showed how to compute new customers. In this section we provide a much better implementation of the same calculation that&mdash;again&mdash;makes heavy use of table functions.</p>
<p class="edition">The idea in this new algorithm is the following: First we determine the earliest day when each customer made a purchase. Once this table is available, the formula checks if the first sale to the customer falls within the current time period. If that holds true, it means that the customer&mdash;in the current period&mdash;is a new customer.</p>
<p class="edition">Here is the code of the measure:</p>
<p class="codelink"><a href="#calibre_link-1095" id="calibre_link-2600" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">New Customers :=
VAR CustomersFirstSale =
    CALCULATETABLE (
        ADDCOLUMNS (
            VALUES ( Sales[CustomerKey] ),
            "FirstSale", CALCULATE (
                MIN ( Sales[Order Date] )
            )
        ),
        ALL ( 'Date' )
    )
VAR CustomersWith1stSaleInCurrentPeriod =
    FILTER (
        CustomersFirstSale,
        [FirstSale] IN VALUES ( 'Date'[Date] )
<span type="pagebreak" id="calibre_link-1900"></span>    )
VAR Result =
    COUNTROWS ( CustomersWith1stSaleInCurrentPeriod )
RETURN Result</pre></div>
<p class="edition">The <em class="calibre5">CustomersFirstSale</em> variable needs to use <em class="calibre5">ALL</em> on the <em class="calibre5">Date</em> table to first compute sales that happened before the current time period. You can see the resulting report in <a href="#calibre_link-1096" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-17</a>.</p>
<figure id="calibre_link-1096" class="image-l">
<img src="images/000965.jpg" alt="This report shows Num of Customers and New Customers per month in 2007." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-17</strong> The report shows the number of customers and new customers over the year 2007.</figcaption>
</figure>
<p class="edition">The way it is written now, if a user further filters other tables like the product category, a customer will be considered new when they buy the selected category for the first time. Thus, one individual customer might be considered new multiple times, depending on the filters applied. By adding further <em class="calibre5">CALCULATE</em> modifiers to the computation of the first variable, it is possible to implement several different variations of the same code. For example, by adding <em class="calibre5">ALL ( Product )</em>, then customers are only considered new when they buy any product. By adding <em class="calibre5">ALL ( Store )</em>, customers are only new the first time they buy in any store.</p>
<div class="sidebar">
<p class="edition">Using <em class="calibre5">IN, CONTAINSROW</em>, and <em class="calibre5">CONTAINS</em></p>
<p class="edition">In the previous example, as in many others, we used the <em class="calibre5">IN</em> keyword to check whether a value is present in a table. Internally, <em class="calibre5">IN</em> is translated into a <em class="calibre5">CONTAINSROW</em> function call, so there are no differences in performance between the two syntaxes. The two following expressions are equivalent:</p>
<p class="codelink"><a href="#calibre_link-1097" id="calibre_link-2601" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Product[Color] IN { "Red", "Blue", "Yellow" }
CONTAINSROW ( { "Red", "Blue", "Yellow" }, Product[Color] )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1901"></span>The syntax also works with tables containing multiple columns:</p>
<p class="codelink"><a href="#calibre_link-1098" id="calibre_link-2602" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">( 'Date'[Year], 'Date'[MonthNumber] ) IN { ( 2018, 12 ), ( 2019, 1 ) }
CONTAINSROW ( { ( 2018, 12 ), ( 2019, 1 ) }, 'Date'[Year], 'Date'[MonthNumber] )</pre></div>
<p class="edition"><em class="calibre5">IN</em> and <em class="calibre5">CONTAINSROW</em> are not available in older versions of DAX. An alternative to these functions is <em class="calibre5">CONTAINS</em>, which requires us to provide pairs of columns and values to search for the presence of a row in a table. However, <em class="calibre5">CONTAINS</em> is less efficient than <em class="calibre5">IN</em> and <em class="calibre5">CONTAINSROW</em>. Because the syntax of table constructors is not available in versions of DAX without <em class="calibre5">IN</em> and <em class="calibre5">CONTAINSROW</em>, using <em class="calibre5">CONTAINS</em> requires a much more verbose syntax:</p>
<p class="codelink"><a href="#calibre_link-1099" id="calibre_link-2603" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">VAR Colors =
    UNION (
        ROW ( "Color", "Red" ),
        ROW ( "Color", "Blue" ),
        ROW ( "Color", "Yellow" )
    )
RETURN
    CONTAINS ( Colors, [Color], Product[Color] )</pre></div>
<p class="edition">At the time of writing, <em class="calibre5">IN</em> is the most convenient way of searching for a value in a table; it is much easier to read than any other function of its category, and it provides the same performance as <em class="calibre5">CONTAINSROW</em>.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-198" class="calibre13">Reusing table expressions with <em class="calibre5">DETAILROWS</em></h4>
<p class="edition">The PivotTable in Excel offers a feature to retrieve the underlying data used to compute a cell. That feature is called “Show Details” in the Excel user interface, and its more technical name is “drillthrough.” This name could be confusing because in Power BI the term “drillthrough” refers to a feature that allows the user to move from one report page to another, in a manner controlled by the report author. For this reason, a feature that allows control over the “Show Details” result was called “Detail Rows Expression” in the Tabular model and was introduced in SQL Server Analysis Services 2017. As of April 2019, it is not available in Power BI, but it should be planned for a future release.</p>
<p class="edition">The Detail Rows Expression is a DAX table expression associated with a measure and invoked to retrieve the table for the Show Details feature. This expression is executed in the filter context of the measure. The idea is that if a measure changes the filter context to compute a variable, the Detail Rows Expression should apply a similar transformation to the filter context.</p>
<p class="edition">For example, consider <em class="calibre5">Sales YTD</em> that computes the year-to-date value of <em class="calibre5">Sales Amount</em>:</p>
<p class="codelink"><a href="#calibre_link-1100" id="calibre_link-2604" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales YTD :=
CALCULATE (
    [Sales Amount],
    DATESYTD ( 'Date'[Date] )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1998"></span>The corresponding Detail Rows Expression should be a <em class="calibre5">CALCULATETABLE</em> that applies the same filter context transformation as the one made by the corresponding measure. For example, the following expression returns all the columns of the <em class="calibre5">Sales</em> table from the beginning of the year considered in the calculation:</p>
<p class="codelink"><a href="#calibre_link-1101" id="calibre_link-2605" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATETABLE (
    Sales,
    DATESYTD ( 'Date'[Date] )
)</pre></div>
<p class="edition">A DAX client tool executes this measure by invoking a specific DAX function called <em class="calibre5">DETAILROWS</em>, specifying the measure that the Detail Rows Expression belongs to:</p>
<div class="program"><pre class="calibre14">DETAILROWS ( [Sales YTD] )</pre></div>
<p class="edition">The <em class="calibre5">DETAILROWS</em> function invokes a table expression stored in a measure. Therefore, one can define hidden measures just to store long table expressions often used as filter arguments of many other DAX measures. For example, consider a <em class="calibre5">Cumulative Total</em> measure with a Detail Rows Expression that retrieves any dates less than or equal to the maximum date available in the filter context:</p>
<p class="codelink"><a href="#calibre_link-1102" id="calibre_link-2606" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">-- Detail Rows Expression for Cumulative Total measure
VAR LastDateSelected = MAX ( 'Date'[Date] )
RETURN
    FILTER (
        ALL ( 'Date'[Date] ),
        'Date'[Date] &lt;= LastDateSelected
    )</pre></div>
<p class="edition">One can reference this table expression in different measures by using the <em class="calibre5">DETAILROWS</em> function:</p>
<p class="codelink"><a href="#calibre_link-1103" id="calibre_link-2607" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Cumulative Sales Amount :=
CALCULATE (
    [Sales Amount],
    DETAILROWS ( [Cumulative Total] )
)

Cumulative Total Cost :=
CALCULATE (
    [Total Cost],
    DETAILROWS ( [Cumulative Total] )
)</pre></div>
<p class="edition">More detailed examples of this technique are available at <a href="https://www.sqlbi.com/articles/creating-table-functions-in-dax-using-detailrows/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.sqlbi.com/articles/creating-table-functions-in-dax-using-detailrows/</a>. However, reusing table expressions with <em class="calibre5">DETAILROWS</em> is just a workaround for the lack of custom-defined functions in DAX, and it may have performance implications. Many use cases for <em class="calibre5">DETAILROWS</em> can be solved by using calculation groups, and this technique will become obsolete once DAX introduces measures returning tables or custom-defined DAX functions.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-199" class="h2a"><span type="pagebreak" id="calibre_link-1827"></span>Creating calculated tables</h3>
<p class="edition">All the table functions shown in the previous sections can be used either as table filters in <em class="calibre5">CALCULATE</em> or to create calculated tables and queries. Earlier on, we described the ones more likely to be used as table filters, whereas in this section we describe some additional functions that are mostly used when creating calculated tables. There are other table functions whose main usage is in authoring queries; we will describe them in the next chapter. Nevertheless, be mindful that there are no limits in the use of table functions. Nothing is preventing anyone from using <em class="calibre5">DATATABLE</em>, <em class="calibre5">SELECTCOLUMNS</em>, or <em class="calibre5">GENERATESERIES</em> (some of the functions described later) in a measure or as a table filter. It is only a matter of convenience: Some functions better fit certain specific needs.</p>
<section class="calibre4">
<h4 id="calibre_link-200" class="calibre13">Using <em class="calibre5">SELECTCOLUMNS</em></h4>
<p class="edition"><em class="calibre5">SELECTCOLUMNS</em> is useful to reduce the number of columns in a table, and it also provides the capability to add new columns like <em class="calibre5">ADDCOLUMNS</em> does. In practice, <em class="calibre5">SELECTCOLUMNS</em> implements projection of columns like the SQL <em class="calibre5">SELECT</em> statement.</p>
<p class="edition">The most common usage of <em class="calibre5">SELECTCOLUMNS</em> is to scan a table and only return some of the columns. For example, the following expression only returns the customer education and gender, that is, two columns:</p>
<p class="codelink"><a href="#calibre_link-1104" id="calibre_link-2608" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECTCOLUMNS (
    Customer,
    "Education", Customer[Education],
    "Gender", Customer[Gender]
)</pre></div>
<p class="edition">The result contains a lot of duplicates, as you can see in <a href="#calibre_link-1105" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-18</a>.</p>
<figure id="calibre_link-1105" class="image-l">
<img src="images/000972.jpg" alt="In the report, you only see one value being repeated under Education, and Gender displays both possible values multiple times." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-18</strong> <em class="calibre5">SELECTCOLUMNS</em> returns duplicate values.</figcaption>
</figure>
<p class="edition"><em class="calibre5">SELECTCOLUMNS</em> is very different from <em class="calibre5">SUMMARIZE</em>. <em class="calibre5">SUMMARIZE</em> performs a grouping of the result, whereas <em class="calibre5">SELECTCOLUMNS</em> only reduces the number of columns. Therefore, the output of <em class="calibre5">SELECTCOLUMNS</em> might contain duplicates, whereas the output of <em class="calibre5">SUMMARIZE</em> does not. One needs to provide <em class="calibre5">SELECTCOLUMNS</em> with pairs of names and expressions for each column in the resulting set. <span type="pagebreak" id="calibre_link-1828"></span>The resulting columns can also be new ones. For example, the following formula returns a new column named <em class="calibre5">Customer</em> containing the name followed by its code in parentheses:</p>
<p class="codelink"><a href="#calibre_link-1106" id="calibre_link-2609" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECTCOLUMNS (
    Customer,
    "Education", Customer[Education],
    "Gender", Customer[Gender],
    "Customer", Customer[Name] &amp; " (" &amp; Customer[Customer Code] &amp; ")"
)</pre></div>
<p class="edition">You can see the result in <a href="#calibre_link-1107" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-19</a>.</p>
<figure id="calibre_link-1107" class="image-l">
<img src="images/000979.jpg" alt="The report shows Education and Gender, plus a new column, Customer." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-19</strong> <em class="calibre5">SELECTCOLUMNS</em> can also compute new columns, like <em class="calibre5">ADDCOLUMNS</em> does.</figcaption>
</figure>
<p class="edition"><em class="calibre5">SELECTCOLUMNS</em> maintains the data lineage if the expression is a single column reference, whereas it generates a new data lineage whenever one uses an expression. Consequently, the following result contains two columns: The first column has the data lineage of <em class="calibre5">Customer[Name]</em>, whereas the second column has a different data lineage that cannot filter the original columns, even though the content of the two columns is the same:</p>
<p class="codelink"><a href="#calibre_link-1108" id="calibre_link-2610" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECTCOLUMNS (
    Customer,
    "Customer Name with lineage", Customer[Name],
    "Customer Name without lineage", Customer[Name] &amp; ""
)</pre></div>
</section>
<section class="calibre4">
<h4 id="calibre_link-201" class="calibre13">Creating static tables with <em class="calibre5">ROW</em></h4>
<p class="edition"><em class="calibre5">ROW</em> is a simple function that returns a table with only one row. <em class="calibre5">ROW</em> requires pairs of name and expression, and the result is a table with one row and a suitable number of columns. For example, the following expression is a table with one row and two columns, containing the sales amount and the quantity sold:</p>
<p class="codelink"><a href="#calibre_link-1109" id="calibre_link-2611" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ROW (
    "Sales", [Sales Amount],
    "Quantity", SUM ( Sales[Quantity] )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1935"></span>The result is a table with one row and two columns, as you can see in <a href="#calibre_link-1110" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-20</a>.</p>
<figure id="calibre_link-1110" class="image-l">
<img src="images/000986.jpg" alt="The figure shows a table with two columns and one row." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-20</strong> <em class="calibre5">ROW</em> creates a table with one single row.</figcaption>
</figure>
<p class="edition"><em class="calibre5">ROW</em> is no longer commonly used since the table constructor syntax was introduced. Indeed, the previous expression can be written as:</p>
<p class="codelink"><a href="#calibre_link-1111" id="calibre_link-2612" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">{
    ( [Sales Amount], SUM ( Sales[Quantity] ) )
}</pre></div>
<p class="edition">The column names are generated automatically by the table constructor syntax, as shown in <a href="#calibre_link-1112" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-21</a>.</p>
<figure id="calibre_link-1112" class="image-l">
<img src="images/000993.jpg" alt="In this report, the column names are generic: Value1 and Value2." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-21</strong> The table constructor generates column names automatically.</figcaption>
</figure>
<p class="edition">When using the table constructor syntax, commas separate rows. To include multiple columns, one needs to use parentheses to encapsulate multiple columns in a single row. The main difference between the <em class="calibre5">ROW</em> function and the curly braces syntax is that <em class="calibre5">ROW</em> specifies names for the columns, whereas the curly braces automatically generate names for the columns. The latter makes it harder to later reference column values.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-202" class="calibre13">Creating static tables with <em class="calibre5">DATATABLE</em></h4>
<p class="edition"><em class="calibre5">ROW</em> is useful when wanting to create a table with a single row. On the other hand, to create multiple rows, one would use <em class="calibre5">DATATABLE</em>. <em class="calibre5">DATATABLE</em> creates a table specifying not only the column names, but also the data type of each column and its content. For example, if one needs a table with three rows to cluster prices, an easy way to build the table is the following expression:</p>
<p class="codelink"><a href="#calibre_link-1113" id="calibre_link-2613" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DATATABLE (
    "Segment", STRING,
    "Min", DOUBLE,
    "Max", DOUBLE,
    {
        { "LOW", 0, 20 },
        { "MEDIUM", 20, 50 },
        { "HIGH", 50, 99 }
    }
)</pre></div>
<p class="edition">You can see the result in <a href="#calibre_link-1114" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-22</a>.</p>
<figure id="calibre_link-1114" class="image-l">
<img src="images/001000.jpg" alt="The report shows a table with three segments, and the Min and Max per segment." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1883"></span><strong class="calibre7">Figure 12-22</strong> The figure shows the resulting table generated with <em class="calibre5">DATATABLE</em>.</figcaption>
</figure>
<p class="edition">The data type of columns can be any of the following values: <em class="calibre5">INTEGER</em>, <em class="calibre5">DOUBLE</em>, <em class="calibre5">STRING</em>, <em class="calibre5">BOOLEAN</em>, <em class="calibre5">CURRENCY</em>, and <em class="calibre5">DATETIME</em>. The syntax is somewhat inconsistent with the new table constructor using curly braces. Indeed, <em class="calibre5">DATATABLE</em> uses curly braces to delimit rows, whereas the anonymous table constructor uses regular parentheses leaving the curly braces only to delimit the entire table.</p>
<p class="edition">A strong limitation of <em class="calibre5">DATATABLE</em> is that the contents of the table need to be constant values. Using any DAX expression would result in an error. This makes <em class="calibre5">DATATABLE</em> a function that is not used much. The table constructor syntax gives developers much more flexibility in terms of expressivity.</p>
<p class="edition">One can use <em class="calibre5">DATATABLE</em> to define simple, constant calculated tables. In SQL Server Data Tools (SSDT) for Analysis Services Tabular, a calculated table using <em class="calibre5">DATATABLE</em> is generated when a developer pastes the content of the clipboard into the model, whereas Power BI uses Power Query to define constant tables. This is another reason why <em class="calibre5">DATATABLE</em> is not common among Power BI users.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-203" class="calibre13">Using <em class="calibre5">GENERATESERIES</em></h4>
<p class="edition"><em class="calibre5">GENERATESERIES</em> is a utility function that generates series of values once the developer provides a lower boundary, an upper boundary, and a step. For example, the following expression produces a table containing 20 values, from 1 to 20:</p>
<div class="program"><pre class="calibre14">GENERATESERIES ( 1, 20, 1 )</pre></div>
<p class="edition">The resulting data type depends on the input; that can be either a number or a <em class="calibre5">DateTime</em>. For example, if the developer needs a table containing the time of the day, this expression provides a quick way of generating an 86,400-row table (one row per second):</p>
<p class="codelink"><a href="#calibre_link-1115" id="calibre_link-2614" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Time =
GENERATESERIES (
    TIME ( 0, 0, 0 ),       -- Start value
    TIME ( 23, 59, 59 ),    -- End value
    TIME ( 0, 0, 1 )        -- Step: 1 second
)</pre></div>
<p class="edition">By changing the step and adding new columns, one could create a smaller table that acts as a suitable dimension&mdash;for example, to slice sales by time:</p>
<p class="codelink"><a href="#calibre_link-1116" id="calibre_link-2615" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Time =
SELECTCOLUMNS (
    GENERATESERIES (
        TIME ( 0, 0, 0 ),
        TIME ( 23, 59, 59 ),
        TIME ( 0, 30, 0 )
<span type="pagebreak" id="calibre_link-1884"></span>    ),
    "Time", [Value],
    "HH:MM AMPM", FORMAT ( [Value], "HH:MM AM/PM" ),
    "HH:MM", FORMAT ( [Value], "HH:MM" ),
    "Hour", HOUR ( [Value] ),
    "Minute", MINUTE ( [Value] )
)</pre></div>
<p class="edition">You can see the result in <a href="#calibre_link-1117" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 12-23</a>.</p>
<figure id="calibre_link-1117" class="image-l">
<img src="images/001008.jpg" alt="The figure shows a time table." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 12-23</strong> Using <em class="calibre5">GENERATESERIES</em> and <em class="calibre5">SELECTCOLUMNS</em>, one can easily create a time table.</figcaption>
</figure>
<p class="edition">Using <em class="calibre5">GENERATESERIES</em> in a measure is uncommon, whereas that function is called upon to create simple tables that become useful as slicers, so the user can select different parameters. For example, Power BI uses <em class="calibre5">GENERATESERIES</em> to add parameters for the what-if analysis.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-204" class="h2a">Conclusions</h3>
<p class="edition">In this chapter, we introduced many new table functions. Still, many have yet to come in the next chapter. Here we focused the attention on the set of table functions that are commonly used to create calculated tables or to implement complex filter arguments for <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em>. Always remember that the code we provide is an example of what is possible with DAX; we leave it up to the reader’s imagination to find practical scenarios calling for the code in a specific model.</p>
<p class="edition">The main functions you learned in this chapter are:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">ADDCOLUMNS</em>, to add new columns to the input table.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">SUMMARIZE</em>, to perform grouping after the scan of a table.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">CROSSJOIN</em>, to perform the cartesian product of two tables.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">UNION</em>, <em class="calibre5">INTERSECT</em>, and <em class="calibre5">EXCEPT</em>, to compute the basic set of operations on tables.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">SELECTCOLUMNS</em>, to select certain columns of a table.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">ROW</em>, <em class="calibre5">DATATABLE</em>, and <em class="calibre5">GENERATESERIES</em>, to generate mostly constant tables as calculated tables.</p></li>
</ul>
<p class="edition">In the next chapter, we will describe other table functions focusing more on complex queries or complex calculated tables.</p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1118">
<div id="calibre_link-3123" class="calibre2">
<div id="calibre_link-3124" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-18"><span type="pagebreak" id="calibre_link-1724"></span><span class="pd_ash">Chapter 13</span><br class="calibre3" />Authoring queries</h2>
<p class="edition">In this chapter we continue our journey, discovering new table functions in DAX. Here, the focus is on functions that are more useful when preparing queries and calculated tables, rather than in measures. Keep in mind that most of the functions you learn in this chapter can be used in measures too, although some have limitations that we outline.</p>
<p class="edition">For each function, we provide examples of queries using them. The chapter has two goals: learning new functions and presenting useful patterns that you can implement in your data model.</p>
<p class="edition">All the demo files in this chapter are provided as a text file, containing the query executed with DAX Studio connected to a common Power BI file. The Power BI file contains the usual Contoso data model used through the entire book.</p>
<section class="calibre4">
<h3 id="calibre_link-205" class="h2a">Introducing DAX Studio</h3>
<p class="edition">DAX Studio is a free tool available at <a href="http://www.daxstudio.org" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">www.daxstudio.org</a> that provides help in authoring queries, debugging code, and measuring the performance of queries.</p>
<p class="edition">DAX Studio is a live project with new features continuously being added to it. Here are a few of the most relevant features:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Connectivity to Analysis Services, Power BI, or Power Pivot for Excel.</p></li>
<li class="calibre10"><p class="listp">Full text editor to author queries and code.</p></li>
<li class="calibre10"><p class="listp">Automatic formatting of the code through the daxformatter.com service.</p></li>
<li class="calibre10"><p class="listp">Automatic measure definition to debug or fine-tune performance.</p></li>
<li class="calibre10"><p class="listp">Detailed performance information about your queries.</p></li>
</ul>
<p class="edition">Though other tools are available to test and write queries in DAX, we strongly encourage the reader to download, install and learn DAX Studio. If you are unsure, just think that we wrote all the DAX code in this book using that tool. We work with DAX all day long, and we like to be productive. A complete documentation of DAX Studio is available at <a href="http://daxstudio.org/documentation/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://daxstudio.org/documentation/</a>.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-206" class="h2a"><span type="pagebreak" id="calibre_link-1729"></span>Understanding <em class="calibre5">EVALUATE</em></h3>
<p class="edition"><em class="calibre5">EVALUATE</em> is a DAX statement that is needed to execute a query. <em class="calibre5">EVALUATE</em> followed by any table expression returns the result of the table expression. Moreover, one or more <em class="calibre5">EVALUATE</em> statements can be preceded by special definitions like local tables, columns, measures, and variables that have the scope of the entire batch of <em class="calibre5">EVALUATE</em> statements executed together.</p>
<p class="edition">For example, the following query returns the red products by using <em class="calibre5">EVALUATE</em>, followed by a simple <em class="calibre5">CALCULATETABLE</em> function:</p>
<p class="codelink"><a href="#calibre_link-1119" id="calibre_link-2617" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
CALCULATETABLE (
    'Product',
    'Product'[Color] = "Red"
)</pre></div>
<p class="edition">Before diving deeper into the description of more advanced table functions, we must introduce the syntax and the options available in <em class="calibre5">EVALUATE</em>, which we will use when writing complex queries.</p>
<section class="calibre4">
<h4 id="calibre_link-207" class="calibre13">Introducing the <em class="calibre5">EVALUATE</em> syntax</h4>
<p class="edition">An <em class="calibre5">EVALUATE</em> statement is divided in three parts:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Definition section:</strong> Introduced by the <em class="calibre5">DEFINE</em> keyword, it includes the definition of local entities like tables, columns, variables, and measures. There can be a single definition section for the entire query, even though the query can contain multiple <em class="calibre5">EVALUATE</em> statements.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Query expression:</strong> Introduced by the <em class="calibre5">EVALUATE</em> keyword, it contains the table expression to evaluate and return as the result. There might be multiple query expressions, each introduced by <em class="calibre5">EVALUATE</em> and each with its own set of result modifiers.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Result modifiers:</strong> An optional additional section to <em class="calibre5">EVALUATE</em>, which is introduced by the keyword <em class="calibre5">ORDER BY</em>. It includes the sort order of the result and the optional definition of which rows to return, by providing a starting point with <em class="calibre5">START AT</em>.</p></li>
</ul>
<p class="edition">The first and the third part of the statement are optional. Thus, one can just use <em class="calibre5">EVALUATE</em> followed by any table expression to produce a query. Nevertheless, by doing so, the developer cannot use many useful features of <em class="calibre5">EVALUATE</em>. Therefore, time spent learning the whole syntax is time well spent.</p>
<p class="edition">Here is an example of a query:</p>
<p class="codelink"><a href="#calibre_link-1120" id="calibre_link-2618" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    VAR MinimumAmount = 2000000
    VAR MaximumAmount = 8000000
EVALUATE
FILTER (
    ADDCOLUMNS (
        SUMMARIZE ( Sales, 'Product'[Category] ),
        "CategoryAmount", [Sales Amount]
    ),
<span type="pagebreak" id="calibre_link-1728"></span>    AND (
        [CategoryAmount] &gt;= MinimumAmount,
        [CategoryAmount] &lt;= MaximumAmount
    )
)
ORDER BY [CategoryAmount]</pre></div>
<p class="edition">The previous query returns the result shown in <a href="#calibre_link-1121" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-1</a>.</p>
<figure id="calibre_link-1121" class="image-l">
<img src="images/001090.jpg" alt="The figure shows CategoryAmount per category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-1</strong> The result only includes the category amount included between 2,000,000 and 8,000,000.</figcaption>
</figure>
<p class="edition">The example defines two variables storing the upper and lower boundary of the sales amount. The query then retrieves all the categories whose total sales fall in between the boundaries defined by the variables. Finally, it sorts the result by sales amount. As simple as it is, the syntax is powerful, and in the next sections, we provide some important considerations about the usage of each part of the <em class="calibre5">EVALUATE</em> syntax.</p>
<p class="edition">One important detail is that the definition section and the result modifiers are only available in conjunction with <em class="calibre5">EVALUATE</em>. Thus, these features are only available when authoring queries. If writing a query that will later be used as a calculated table, a careful developer should avoid relying on the <em class="calibre5">DEFINE</em> and <em class="calibre5">ORDER BY</em> sections, only focusing on the query expression. A calculated table is defined by a table expression, not by a DAX query.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-208" class="calibre13">Using <em class="calibre5">VAR</em> in <em class="calibre5">DEFINE</em></h4>
<p class="edition">In the definition section, it is possible to use the <em class="calibre5">VAR</em> keyword to define variables. Each variable is as simple as a name followed by an expression. Variables introduced in queries do not need the <em class="calibre5">RETURN</em> part required when variables are used as part of an expression. Indeed, the result is defined by the <em class="calibre5">EVALUATE</em> section. We distinguish between regular variables (variables used in expressions) and variables defined in the <em class="calibre5">DEFINE</em> section by naming the former <em class="calibre5">expression variables</em>, and the latter <em class="calibre5">query variables</em>.</p>
<p class="edition">As is the case with expression variables, query variables can contain both values and tables without restriction. For example, the query shown in the previous section can also be authored with a query table variable:</p>
<p class="codelink"><a href="#calibre_link-1122" id="calibre_link-2619" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    VAR MinimumAmount = 2000000
    VAR MaximumAmount = 8000000
    <strong class="calibre7">VAR CategoriesSales =</strong>
        <strong class="calibre7">ADDCOLUMNS (</strong>
            <strong class="calibre7">SUMMARIZE ( Sales, 'Product'[Category] ),</strong>
            <strong class="calibre7">"CategoryAmount", [Sales Amount]</strong>
<span type="pagebreak" id="calibre_link-1730"></span>        <strong class="calibre7">)</strong>
EVALUATE
FILTER (
    CategoriesSales,
    AND (
        [CategoryAmount] &gt;= MinimumAmount,
        [CategoryAmount] &lt;= MaximumAmount
    )
)
ORDER BY [CategoryAmount]</pre></div>
<p class="edition">A query variable has the scope of the entire batch of <em class="calibre5">EVALUATE</em> statements executed together. This means that after it has been defined, the variable can be used anywhere in the following queries. The one limitation is that a variable can only be referenced after it has been defined. In the previous query, if you define <em class="calibre5">CategoriesSales</em> before <em class="calibre5">MinimumAmount</em> or <em class="calibre5">MaximumAmount</em>, the result is a syntax error: The expression of <em class="calibre5">CategoriesSales</em> references two variables not yet defined. This is useful to prevent circular dependencies. Besides, the very same limitation exists for expression variables; therefore, query variables follow the same limitations as expression variables.</p>
<p class="edition">If the query contains multiple <em class="calibre5">EVALUATE</em> sections, query variables are available through all of them. For example, queries generated by Power BI use the <em class="calibre5">DEFINE</em> part to store slicer filters in query variables and then include multiple <em class="calibre5">EVALUATE</em> statements to compute the various parts of the visual.</p>
<p class="edition">Variables can also be defined in the <em class="calibre5">EVALUATE</em> section; in that case, being expression variables, they are local to the table expression. The previous query can be equivalently defined this way:</p>
<p class="codelink"><a href="#calibre_link-1123" id="calibre_link-2620" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR MinimumAmount = 2000000
VAR MaximumAmount = 8000000
VAR CategoriesSales =
    ADDCOLUMNS (
        SUMMARIZE ( Sales, 'Product'[Category] ),
        "CategoryAmount", [Sales Amount]
    )
RETURN
    FILTER (
        CategoriesSales,
        AND (
            [CategoryAmount] &gt;= MinimumAmount,
            [CategoryAmount] &lt;= MaximumAmount
        )
    )
ORDER BY [CategoryAmount]</pre></div>
<p class="edition">As you can see, the variables are now defined as part of the table expression, and the <em class="calibre5">RETURN</em> keyword is needed to define the result of the expression. The scope of the expression variables, in this case, is the <em class="calibre5">RETURN</em> section.</p>
<p class="edition">Choosing between using a query variable or an expression variable comes with advantages and disadvantages. If the variable is needed in further table or column definitions, then you need to use a query variable. On the other hand, if the variable is not required in other definitions (or in multiple <span type="pagebreak" id="calibre_link-1727"></span><em class="calibre5">EVALUATE</em> sections), then it is better to use an expression variable. Indeed, if the variable is part of the expression, then it will be much easier to use the expression to compute a calculated table or to embed it into a measure. Otherwise, there will always be the need to update the syntax of the query to transform it into an expression.</p>
<p class="edition">The rule of thumb for choosing between query variables and expression variables is simple. Use expression variables whenever possible and use query variables when strictly necessary; indeed, query variables require additional work to re-use the code in a different formula.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-209" class="calibre13">Using <em class="calibre5">MEASURE</em> in <em class="calibre5">DEFINE</em></h4>
<p class="edition">Another entity that one can define locally to a query is a measure. This is achieved by using the keyword <em class="calibre5">MEASURE</em>. A query measure behaves in all respects like a regular measure, but it exists only for the lifetime of the query. In the definition of the measure it is mandatory to specify the table that hosts the measure. The following is an example of a query measure:</p>
<p class="codelink"><a href="#calibre_link-1124" id="calibre_link-2621" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[LargeSales] =
        CALCULATE (
            [Sales Amount],
            Sales[Net Price] &gt;= 200
        )
EVALUATE
ADDCOLUMNS (
    VALUES ( 'Product'[Category] ),
    "Large Sales", [LargeSales]
)</pre></div>
<p class="edition">The result of the query is visible in <a href="#calibre_link-1125" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-2</a>.</p>
<figure id="calibre_link-1125" class="image-l">
<img src="images/001097.jpg" alt="The report shows large sales per category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-2</strong> The <em class="calibre5">LargeSales</em> query measure is evaluated for every <em class="calibre5">Category</em> in the <em class="calibre5">Large Sales</em> column of the result.</figcaption>
</figure>
<p class="edition">Query measures are useful for two purposes: the first, more obvious, is to write complex expressions that can be called multiple times inside the query. The other reason is that query measures are extremely useful for debugging and for performance tuning. Indeed, if a query measure has the same name as a model measure, it gains precedence in the query. In other words, references to the measure name in the query will use the query measure and not the model measure. However, any other model measures that reference the redefined measure still use the original measure. Therefore, you should <span type="pagebreak" id="calibre_link-1735"></span>include all the dependent measures as query measures to evaluate the impact of changing a measure in the model.</p>
<p class="edition">Thus, when testing the behavior of a measure, the best strategy is to write a query that uses the measure, add the local definition of the measure, and then perform various tests to either debug or optimize the code. Once the process is done, the code of the measure can be updated in the model with the new version. DAX Studio offers a specific feature for this purpose: It lets a developer automatically add the <em class="calibre5">DEFINE MEASURE</em> statement to a query to speed up these steps.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-210" class="h2a">Implementing common DAX query patterns</h3>
<p class="edition">Now that we have described the syntax of <em class="calibre5">EVALUATE</em>, we introduce many functions that are common in authoring queries. For the most commonly used functions, we also provide sample queries that allow further elaborating on their use.</p>
<section class="calibre4">
<h4 id="calibre_link-211" class="calibre13">Using <em class="calibre5">ROW</em> to test measures</h4>
<p class="edition">Introduced in the previous chapter, <em class="calibre5">ROW</em> is typically used to obtain the value of a measure or to perform an investigation on the measure query plan. <em class="calibre5">EVALUATE</em> requires a table as an argument, and it returns a table as a result. If all you need is the value of a measure, <em class="calibre5">EVALUATE</em> will not accept it as an argument. It will require a table instead. So, by using <em class="calibre5">ROW</em>, you can transform any value into a table, like in the following example:</p>
<p class="codelink"><a href="#calibre_link-1126" id="calibre_link-2622" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ROW ( "Result", [Sales Amount] )</pre></div>
<p class="edition">The result is visible in <a href="#calibre_link-1127" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-3</a>.</p>
<figure id="calibre_link-1127" class="image-l">
<img src="images/001104.jpg" alt="The report consists of one row in the one column, Result." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-3</strong> The <em class="calibre5">ROW</em> function returns a table with a single row.</figcaption>
</figure>
<p class="edition">Be mindful that the same behavior can be obtained by using the table constructor syntax:</p>
<div class="program"><pre class="calibre14">EVALUATE
{ [Sales Amount] }</pre></div>
<p class="edition"><a href="#calibre_link-1128" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-4</a> displays the result of the preceding example.</p>
<figure id="calibre_link-1128" class="image-l">
<img src="images/001111.jpg" alt="The report shows one row in a single column, named Value." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-4</strong> The table constructor returns a row with a column named <em class="calibre5">Value</em>.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1736"></span><em class="calibre5">ROW</em> provides the developer with control over the resulting column’s name, which on the other hand is generated automatically with the table constructor. <em class="calibre5">ROW</em> allows the developer to generate a table with more than one column, where they can provide for each column a column name and its corresponding expression. In case one needs to simulate the presence of a slicer, <em class="calibre5">CALCULATETABLE</em> comes in handy:</p>
<p class="codelink"><a href="#calibre_link-1129" id="calibre_link-2623" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
CALCULATETABLE (
    ROW (
        "Sales", [Sales Amount],
        "Cost", [Total Cost]
    ),
    'Product'[Color] = "Red"
)</pre></div>
<p class="edition">The result is visible in <a href="#calibre_link-1130" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-5</a>.</p>
<figure id="calibre_link-1130" class="image-l">
<img src="images/001118.jpg" alt="The report shows two columns: Sales and Cost." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-5</strong> The <em class="calibre5">ROW</em> function can return multiple columns, and values provided are computed in a filter context.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-212" class="calibre13">Using <em class="calibre5">SUMMARIZE</em></h4>
<p class="edition">We introduced and used <em class="calibre5">SUMMARIZE</em> in previous chapters of the book. We mentioned that <em class="calibre5">SUMMARIZE</em> performs two operations: grouping by columns and adding values. Using <em class="calibre5">SUMMARIZE</em> to group tables is a safe operation, whereas using <em class="calibre5">SUMMARIZE</em> to add new columns might lead to unexpected results that are hard to debug.</p>
<p class="edition">Though adding columns with <em class="calibre5">SUMMARIZE</em> is a bad idea, at this point we introduce two additional features of <em class="calibre5">SUMMARIZE</em> used in order to add columns. Our intention is to support our reader in understanding code they might run into, written by someone else. However, we reiterate here that <strong class="calibre7"><em class="calibre5">using SUMMARIZE to add columns aggregating values should be avoided</em></strong>.</p>
<p class="edition">In case one uses <em class="calibre5">SUMMARIZE</em> to compute values, the option is there to let <em class="calibre5">SUMMARIZE</em> compute additional rows that represent subtotals. There is a <em class="calibre5">SUMMARIZE</em> modifier named <em class="calibre5">ROLLUP</em> that changes the aggregation function of columns requiring for the subtotals to be added to the result. Look at the following query:</p>
<p class="codelink"><a href="#calibre_link-1131" id="calibre_link-2624" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZE (
    Sales,
    ROLLUP (
        'Product'[Category],
        'Date'[Calendar Year]
    ),
    "Sales", [Sales Amount]
)
ORDER BY
<span type="pagebreak" id="calibre_link-2053"></span>    'Product'[Category],
    'Date'[Calendar Year]</pre></div>
<p class="edition"><em class="calibre5">ROLLUP</em> instructs <em class="calibre5">SUMMARIZE</em> to not only compute the value of <em class="calibre5">Sales</em> for each category and year, but also to add additional rows that contain a blank in the year and that represent the subtotal at the category level. Because the category is also marked as <em class="calibre5">ROLLUP</em>, one row in the set contains a blank in both category and year along with the grand total for <em class="calibre5">Sales</em>. This is shown in <a href="#calibre_link-1132" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-6</a>.</p>
<figure id="calibre_link-1132" class="image-l">
<img src="images/001125.jpg" alt="The figure shows Calendar Year and Sales, per category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-6</strong> The <em class="calibre5">ROLLUP</em> function creates additional total rows in the <em class="calibre5">SUMMARIZE</em> result.</figcaption>
</figure>
<p class="edition">The rows added by <em class="calibre5">ROLLUP</em> contain a blank instead of the value of the column they are summing up. In case there are blanks in the column, then the output contains two rows with a blank category: one with the value for the blank category and one with the total by category. To distinguish between the two, and to make it easier to mark subtotal rows, one can add a new column using the <em class="calibre5">ISSUBTOTAL</em> function:</p>
<p class="codelink"><a href="#calibre_link-1133" id="calibre_link-2625" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZE (
    Sales,
    ROLLUP (
        'Product'[Category],
        'Date'[Calendar Year]
    ),
    "Sales", [Sales Amount],
    "SubtotalCategory", ISSUBTOTAL ( 'Product'[Category] ),
    "SubtotalYear", ISSUBTOTAL ( 'Date'[Calendar Year] )
)
ORDER BY
    'Product'[Category],
    'Date'[Calendar Year]</pre></div>
<p class="edition">The last two columns of the previous query contain a <em class="calibre5">Boolean</em> value that is set to <em class="calibre5">TRUE</em> when the row contains a subtotal (on category or on year) and <em class="calibre5">FALSE</em> otherwise, as shown in <a href="#calibre_link-1134" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-7</a>.</p>
<figure id="calibre_link-1134" class="image-l">
<img src="images/001132.jpg" alt="The new report shows SubtotalYear and SubtotalCategory in addition to the previous columns." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1738"></span><strong class="calibre7">Figure 13-7</strong> The <em class="calibre5">ISSUBTOTAL</em> function returns <em class="calibre5">True</em> whenever a column is a subtotal in the <em class="calibre5">SUMMARIZE</em> result.</figcaption>
</figure>
<p class="edition">By adding these additional columns using <em class="calibre5">ISSUBTOTAL</em>, it is possible to clearly distinguish between rows containing actual data and rows containing subtotals.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition"><em class="calibre5">SUMMARIZE</em> should not be used to add new columns. Therefore, we mention the syntax of <em class="calibre5">ROLLUP</em> and <em class="calibre5">ISSUBTOTAL</em> just to be able to read existing code. You should never use <em class="calibre5">SUMMARIZE</em> this way, but prefer <em class="calibre5">SUMMARIZECOLUMNS</em> instead, or use <em class="calibre5">ADDCOLUMNS</em> and <em class="calibre5">SUMMARIZE</em> when the use of <em class="calibre5">SUMMARIZECOLUMNS</em> is not possible.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-213" class="calibre13">Using <em class="calibre5">SUMMARIZECOLUMNS</em></h4>
<p class="edition"><em class="calibre5">SUMMARIZECOLUMNS</em> is an extremely powerful query function that is intended to be the “one function fits all” to run queries. In a single function, <em class="calibre5">SUMMARIZECOLUMNS</em> contains all the features needed to execute a query. <em class="calibre5">SUMMARIZECOLUMNS</em> lets you specify:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">A set of columns used to perform the group-by, like in <em class="calibre5">SUMMARIZE</em>, with the option of producing subtotals.</p></li>
<li class="calibre10"><p class="listp">A set of new columns to add to the result, like both <em class="calibre5">SUMMARIZE</em> and <em class="calibre5">ADDCOLUMNS</em>.</p></li>
<li class="calibre10"><p class="listp">A set of filters to apply to the model prior to performing the group-by, like <em class="calibre5">CALCULATETABLE</em>.</p></li>
</ul>
<p class="edition">Finally, <em class="calibre5">SUMMARIZECOLUMNS</em> automatically removes from the output any row for which all the added columns produce a blank value. It does not come as a surprise that Power BI uses <em class="calibre5">SUMMARIZECOLUMNS</em> for nearly all the queries it runs.</p>
<p class="edition">The following is a first, simple query using <em class="calibre5">SUMMARIZECOLUMNS</em>:</p>
<p class="codelink"><a href="#calibre_link-1135" id="calibre_link-2626" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    'Product'[Category],
    'Date'[Calendar Year],
    "Amount", [Sales Amount]
)
ORDER BY
    'Product'[Category],
    'Date'[Calendar Year]</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2063"></span>The previous query groups data by category and year, computing the sales amount in a filter context containing the given category and year for every row of the result. The result is visible in <a href="#calibre_link-1136" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-8</a>.</p>
<figure id="calibre_link-1136" class="image-l">
<img src="images/001139.jpg" alt="The report shows amounts per calendar year and per category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-8</strong> The result contains the category, year, and the amount of the given category and year.</figcaption>
</figure>
<p class="edition">Years with no sales (like 2005) do not appear in the result. The reason is that, for that specific row of the result, the new Amount column returned a blank, so <em class="calibre5">SUMMARIZECOLUMNS</em> removed the row from the result. If the developer needs to ignore this behavior for certain columns, they can use the <em class="calibre5">IGNORE</em> modifier like in the following variation of the same query:</p>
<p class="codelink"><a href="#calibre_link-1137" id="calibre_link-2627" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    'Product'[Category],
    'Date'[Calendar Year],
    "Amount", <strong class="calibre7">IGNORE ( [Sales Amount] )</strong>
)
ORDER BY
    'Product'[Category],
    'Date'[Calendar Year]</pre></div>
<p class="edition">As a result, <em class="calibre5">SUMMARIZECOLUMNS</em> ignores the fact that <em class="calibre5">Sales Amount</em> returns a blank; the result also contains sales for Audio in 2005 and 2006, as you can see in <a href="#calibre_link-1138" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-9</a>.</p>
<figure id="calibre_link-1138" class="image-l">
<img src="images/001146.jpg" alt="In this report, there are blank values for certain amounts." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-9</strong> Using <em class="calibre5">IGNORE</em>, combinations producing blank results in a measure are still returned.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3125"></span>In case multiple columns are added by <em class="calibre5">SUMMARIZECOLUMNS</em>, it is possible to choose which one to tag with <em class="calibre5">IGNORE</em> and which one to use for blank checks. The common practice is that of removing blanks anyway, to avoid empty results.</p>
<p class="edition"><em class="calibre5">SUMMARIZECOLUMNS</em> offers the option of computing subtotals too, using both <em class="calibre5">ROLLUPADDSUBTOTAL</em> and <em class="calibre5">ROLLUPGROUP</em>. In the previous query, if you need the yearly subtotal, you should mark the <em class="calibre5">Date[Calendar Year]</em> column with <em class="calibre5">ROLLUPADDISSUBTOTAL</em>, also specifying the name of a column that indicates whether a given row is a subtotal or not:</p>
<p class="codelink"><a href="#calibre_link-1139" id="calibre_link-2628" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    'Product'[Category],
    ROLLUPADDISSUBTOTAL (
        'Date'[Calendar Year],
        "YearTotal"
    ),
    "Amount", [Sales Amount]
)
ORDER BY
    'Product'[Category],
    'Date'[Calendar Year]</pre></div>
<p class="edition">The result now contains additional rows representing the subtotal at the year level, with an additional column named <em class="calibre5">YearTotal</em> containing <em class="calibre5">TRUE</em> only for the subtotal rows. You see this in <a href="#calibre_link-1140" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-10</a> where the subtotal rows are highlighted.</p>
<figure id="calibre_link-1140" class="image-l">
<img src="images/001154.jpg" alt="The report now shows whether a row is a subtotal or not, along with the amount for that subtotal." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-10</strong> <em class="calibre5">ROLLUPADDISSUBTOTAL</em> creates a Boolean column indicating the presence of a subtotal, and new rows with the subtotal amounts.</figcaption>
</figure>
<p class="edition">When summarizing by multiple columns, you can mark several columns with <em class="calibre5">ROLLUPADDISSUBTOTAL</em>. This produces several total groups. For example, the following query produces both the subtotal of a category for all years and a subtotal of a year over all categories:</p>
<p class="codelink"><a href="#calibre_link-1141" id="calibre_link-2629" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-2037"></span>EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL (
        'Product'[Category],
        "CategoryTotal"
    ),
    ROLLUPADDISSUBTOTAL (
        'Date'[Calendar Year],
        "YearTotal"
    ),
    "Amount", [Sales Amount]
)
ORDER BY
    'Product'[Category],
    'Date'[Calendar Year]</pre></div>
<p class="edition">The subtotal of a year over all categories and an example of a subtotal of a category for all years are highlighted in that order, in <a href="#calibre_link-1142" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-11</a>.</p>
<figure id="calibre_link-1142" class="image-l">
<img src="images/001161.jpg" alt="In this report, the reader sees subtotals for all categories over each year as well as subtotals for all years, for each category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-11</strong> <em class="calibre5">ROLLUPADDISSUBTOTAL</em> can group multiple columns.</figcaption>
</figure>
<p class="edition">If you need subtotals for a group of columns instead of just one column, then the modifier <em class="calibre5">ROLLUPGROUP</em> becomes useful. The following query produces only one subtotal for both category and year, adding only one extra row to the result:</p>
<p class="codelink"><a href="#calibre_link-1143" id="calibre_link-2630" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL (
        ROLLUPGROUP (
            'Product'[Category],
            'Date'[Calendar Year]
        ),
        "CategoryYearTotal"
    ),
    "Amount", [Sales Amount]
)
ORDER BY
<span type="pagebreak" id="calibre_link-2064"></span>    'Product'[Category],
    'Date'[Calendar Year]</pre></div>
<p class="edition">You can see the result with only one total row in <a href="#calibre_link-1144" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-12</a>.</p>
<figure id="calibre_link-1144" class="image-l">
<img src="images/001168.jpg" alt="The report shows the overall total for all categories and years, followed by subtotals at the year level for each category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-12</strong> <em class="calibre5">ROLLUPADDISSUBTOTAL</em> creates both new rows and one new column with the subtotals.</figcaption>
</figure>
<p class="edition">The last feature of <em class="calibre5">SUMMARIZECOLUMNS</em> is the ability to filter the result, like <em class="calibre5">CALCULATETABLE</em> does. One can specify one or more filters by using tables as additional arguments. For example, the following query only retrieves the sales of customers with a high school education; the result is similar to <a href="#calibre_link-1145" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-13</a>, but with smaller amounts:</p>
<p class="codelink"><a href="#calibre_link-1146" id="calibre_link-2631" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL (
        ROLLUPGROUP (
            'Product'[Category],
            'Date'[Calendar Year]
        ),
        "CategoryYearTotal"
    ),
    FILTER (
        ALL ( Customer[Education] ),
        Customer[Education] = "High School"
    ),
    "Amount", [Sales Amount]
)</pre></div>
<p class="edition">Please note that with <em class="calibre5">SUMMARIZECOLUMNS</em>, the compact syntax of filter arguments using predicates in <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em> is not available. Thus, the following query generates a syntax error:</p>
<p class="codelink"><a href="#calibre_link-1147" id="calibre_link-2632" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL (
        ROLLUPGROUP (
            'Product'[Category],
<span type="pagebreak" id="calibre_link-2065"></span>            'Date'[Calendar Year]
        ),
        "CategoryYearTotal"
    ),
    <strong class="calibre7">Customer[Education] = "High School",    -- This syntax is not available</strong>
    "Amount", [Sales Amount]
)</pre></div>
<p class="edition">The reason is that the filter arguments of <em class="calibre5">SUMMARIZECOLUMNS</em> need to be tables, and there are no shortcuts in this case. An easy and compact way of expressing a filter with <em class="calibre5">SUMMARIZECOLUMNS</em> is to use <em class="calibre5">TREATAS:</em></p>
<p class="codelink"><a href="#calibre_link-1148" id="calibre_link-2633" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL (
        ROLLUPGROUP (
            'Product'[Category],
            'Date'[Calendar Year]
        ),
        "CategoryYearTotal"
    ),
    <strong class="calibre7">TREATAS ( { "High School" }, Customer[Education] ),</strong>
    "Amount", [Sales Amount]
)</pre></div>
<p class="edition"><em class="calibre5">SUMMARIZECOLUMNS</em> is extremely powerful, but it comes with a strong limitation: It cannot be called if the external filter context has performed a context transition. For this reason, <em class="calibre5">SUMMARIZECOLUMNS</em> is useful when authoring queries; however, it is not available as a replacement for <em class="calibre5">ADDCOLUMNS</em> and <em class="calibre5">SUMMARIZE</em> in measures because it will not work in most reports. Indeed, a measure is often used in a visual like a matrix or a chart, which internally executes the measure in a row context for each value displayed in the report.</p>
<p class="edition">As a further example of <em class="calibre5">SUMMARIZECOLUMNS</em> limitations in a row context, consider the following query that returns the total sales of all products using an inefficient but still valid approach:</p>
<p class="codelink"><a href="#calibre_link-1149" id="calibre_link-2634" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
{
    SUMX (
        VALUES ( 'Product'[Category] ),
        CALCULATE (
            SUMX (
                ADDCOLUMNS (
                    VALUES ( 'Product'[Subcategory] ),
                    "SubcategoryTotal", [Sales Amount]
                ),
                [SubcategoryTotal]
            )
        )
    )
}</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1739"></span>If you replace the innermost <em class="calibre5">ADDCOLUMNS</em> with <em class="calibre5">SUMMARIZECOLUMNS</em>, then the query fails because <em class="calibre5">SUMMARIZECOLUMNS</em> is being called in a context where <em class="calibre5">CALCULATE</em> forced context transition. Therefore, the following query is not valid:</p>
<p class="codelink"><a href="#calibre_link-1150" id="calibre_link-2635" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
{
    SUMX (
        VALUES ( 'Product'[Category] ),
        CALCULATE (
            SUMX (
                <strong class="calibre7">SUMMARIZECOLUMNS</strong> (
                    'Product'[Subcategory],
                    "SubcategoryTotal", [Sales Amount]
                ),
                [SubcategoryTotal]
            )
        )
    )
}</pre></div>
<p class="edition">In general, <em class="calibre5">SUMMARIZECOLUMNS</em> is not suitable in measures because the measure will be called inside a much more complex query generated by the client tool. That query is likely to contain context transitions, making <em class="calibre5">SUMMARIZECOLUMNS</em> fail.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-214" class="calibre13">Using <em class="calibre5">TOPN</em></h4>
<p class="edition"><em class="calibre5">TOPN</em> is a function that sorts a table and then returns a subset of the first rows only. It is useful whenever one needs to reduce the number of rows of a set. For example, when Power BI shows the result of a table, it does not retrieve the full result from the database. Instead, it only retrieves the first few rows that are needed to produce the page on the screen. The remaining part of the result is retrieved only on demand, when the user scrolls down the visual. Another scenario where <em class="calibre5">TOPN</em> is useful is to retrieve top performers, like top products, top customers, and so on.</p>
<p class="edition">The top three products based on sales can be computed with the following query, which evaluates the <em class="calibre5">Sales Amount</em> measure for each row of the <em class="calibre5">Product</em> table:</p>
<div class="program"><pre class="calibre14">EVALUATE
TOPN (
    3,
    'Product',
    [Sales Amount]
)</pre></div>
<p class="edition">The resulting table contains all the columns of the source table. When a table is used in a query, one is seldom interested in all the columns, so the input table of <em class="calibre5">TOPN</em> should reduce the columns to merely the ones needed. The following variation produces fewer columns than are available in the entire <em class="calibre5">Product</em> table. This is shown in <a href="#calibre_link-1145" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-13</a>:</p>
<p class="codelink"><a href="#calibre_link-1151" id="calibre_link-2636" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR ProductsBrands =
<span type="pagebreak" id="calibre_link-2067"></span>    SUMMARIZE (
        Sales,
        'Product'[Product Name],
        'Product'[Brand]
    )
VAR Result =
    TOPN (
        3,
        ProductsBrands,
        [Sales Amount]
    )
RETURN Result
ORDER BY 'Product'[Product Name]</pre></div>
<figure id="calibre_link-1145" class="image-l">
<img src="images/001175.jpg" alt="The report only shows three rows for Product Name and Brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-13</strong> <em class="calibre5">TOPN</em> filters the rows of a table expression based on the value of the Sales Amount measure.</figcaption>
</figure>
<p class="edition">It is likely that one also needs the value of <em class="calibre5">Sales Amount</em> in the result, in order to correctly sort the resulting three rows. In such a case, the best option is to precompute the value inside the parameter of <em class="calibre5">SUMMARIZE</em> and then reference it in <em class="calibre5">TOPN</em>. Thus, the most frequently used pattern of <em class="calibre5">TOPN</em> is the following:</p>
<p class="codelink"><a href="#calibre_link-1152" id="calibre_link-2637" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR ProductsBrands =
    SUMMARIZE (
        Sales,
        'Product'[Product Name],
        'Product'[Brand]
    )
VAR ProductsBrandsSales =
    ADDCOLUMNS (
        ProductsBrands,
        "Product Sales", [Sales Amount]
    )
VAR Result =
    TOPN (
        3,
        ProductsBrandsSales,
        [Product Sales]
    )
RETURN Result
ORDER BY [Product Sales] DESC</pre></div>
<p class="edition">You can see the result of this query in <a href="#calibre_link-1153" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-14</a>.</p>
<figure id="calibre_link-1153" class="image-l">
<img src="images/001182.jpg" alt="This report returns the same three rows, this time sorted in descending sales volumes." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3126"></span><strong class="calibre7">Figure 13-14</strong> <em class="calibre5">TOPN</em> returns the top N rows of a table sorted by an expression.</figcaption>
</figure>
<p class="edition">The table can be sorted ascending or descending order to apply the top filter. By default, it is sorted in descending order so that it returns the rows with the largest values first. The third, optional parameter can change the sort order. The values can be 0 or <em class="calibre5">FALSE</em> for the default descending order, or 1 or <em class="calibre5">TRUE</em> for the ascending order.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">Do not confuse the sort order of <em class="calibre5">TOPN</em> with the sort order of the result of the query; the latter is managed by the <em class="calibre5">ORDER</em> BY condition of the <em class="calibre5">EVALUATE</em> statement. The third parameter of <em class="calibre5">TOPN</em> only affects how to sort the table generated internally by <em class="calibre5">TOPN</em> itself.</p>
</div>
<p class="edition">In the presence of ties, <em class="calibre5">TOPN</em> is not guaranteed to return the exact number of rows requested. Instead, it returns all the rows with the same value. For example, in the following query we request the top four brands, and we introduced a modified calculation that uses <em class="calibre5">MROUND</em> to fictitiously introduce ties:</p>
<p class="codelink"><a href="#calibre_link-1154" id="calibre_link-2638" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR SalesByBrand =
    ADDCOLUMNS (
        VALUES ( 'Product'[Brand] ),
        "Product Sales", MROUND ( [Sales Amount], 1000000 )
    )
VAR Result =
    TOPN (
        4,
        SalesByBrand,
        [Product Sales]
    )
RETURN Result
ORDER BY [Product Sales] DESC</pre></div>
<p class="edition">The result contains five rows, not just four, because both Litware and Proseware produce a result of 3,000,000. Finding ties and not knowing how to differentiate between the two, <em class="calibre5">TOPN</em> returns both, as you can see in <a href="#calibre_link-1155" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-15</a>.</p>
<figure id="calibre_link-1155" class="image-l">
<img src="images/001190.jpg" alt="This report returns five brands, since two of them are a tie. They are sorted in descending order." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-15</strong> In the presence of ties, <em class="calibre5">TOPN</em> might return more values than requested.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3127"></span>A common technique to avoid this problem is to add extra columns to the expression of <em class="calibre5">TOPN</em>. Indeed, in the third parameter, multiple columns can be used to sort the result of <em class="calibre5">TOPN</em>. For example, to retrieve the top four brands and to choose the first brand in alphabetical order in case of a tie, you can use additional sort orders:</p>
<p class="codelink"><a href="#calibre_link-1156" id="calibre_link-2639" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR SalesByBrand =
    ADDCOLUMNS (
        VALUES ( 'Product'[Brand] ),
        "Product Sales", MROUND ( [Sales Amount], 1000000 )
    )
VAR Result =
    TOPN (
        4,
        SalesByBrand,
        [Product Sales], 0,
        'Product'[Brand], 1
    )
RETURN Result
ORDER BY [Product Sales] DESC</pre></div>
<p class="edition">The result shown in <a href="#calibre_link-1157" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-16</a> removes Proseware because alphabetically it comes after Litware. Please note that in the query, we used a descending order for the sales and an ascending order for the brand.</p>
<figure id="calibre_link-1157" class="image-l">
<img src="images/001198.jpg" alt="This report returns four brands; one of the ties has been removed." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-16</strong> Using additional sort orders, one can remove ties in the table.</figcaption>
</figure>
<p class="edition">Be mindful that adding columns to the sort order does not guarantee that only the right number of rows will be returned. <em class="calibre5">TOPN</em> can always return multiple rows in the presence of ties. Adding columns to the sort order only mitigates the problem by reducing the number of ties. If one needs a guarantee to retrieve an exact number of rows, then a column with unique values should be added to the sort order, removing any possible ties.</p>
<p class="edition">Consider a more complex example where <em class="calibre5">TOPN</em> is mixed with set functions and variables. The requirement is a report showing the sales of the top 10 products plus an additional “Others” row showing the sales of all other products combined. A possible implementation is the following:</p>
<p class="codelink"><a href="#calibre_link-1158" id="calibre_link-2640" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR NumOfTopProducts = 10
VAR ProdsWithSales =
    ADDCOLUMNS (
<span type="pagebreak" id="calibre_link-3128"></span>        VALUES ( 'Product'[Product Name] ),
        "Product Sales", [Sales Amount]
    )
VAR TopNProducts =
    TOPN (
        NumOfTopProducts,
        ProdsWithSales,
        [Product Sales]
    )
VAR RemainingProducts =
    EXCEPT ( ProdsWithSales, TopNProducts )
VAR OtherRow =
    ROW (
        "Product Name", "Others",
        "Product Sales", SUMX (
            RemainingProducts,
            [Product Sales]
        )
    )
VAR Result =
    UNION ( TopNProducts, OtherRow )
RETURN Result
ORDER BY [Product Sales] DESC</pre></div>
<p class="edition">The <em class="calibre5">ProdsWithSales</em> variable computes a table with products and sales. Then <em class="calibre5">TopNProducts</em> only computes the top 10 products. The <em class="calibre5">RemainingProducts</em> variable uses <em class="calibre5">EXCEPT</em> to compute the products that are not in the top 10. Once the code has split the products into two sets (<em class="calibre5">TopNProducts</em> and <em class="calibre5">RemainingProducts</em>), it builds a single-row table containing the string “Others”; it also aggregates all the products in the <em class="calibre5">RemainingProducts</em> variable, summing all the remaining products. The result is then the <em class="calibre5">UNION</em> of the top 10 products with the additional row, computed in the formula. The result is visible in <a href="#calibre_link-1159" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-17</a>.</p>
<figure id="calibre_link-1159" class="image-l">
<img src="images/001205.jpg" alt="In the report there are 10 product names, plus an Others row." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-17</strong> The additional row containing Others is created by the query.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1731"></span>Although correct, this result is not perfect yet. Indeed, the Others row appears at the beginning of the report, but it could actually appear in any position depending on its value. One might want to sort the rows in such a way that the Others row is always at the end of the report, while the top products are sorted by their sales, with the top performer being first.</p>
<p class="edition">The result can be achieved by introducing a sort column that moves the Others row to the end by using a ranking based on <em class="calibre5">Product Sales</em> for the top rows:</p>
<p class="codelink"><a href="#calibre_link-1160" id="calibre_link-2641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR NumOfTopProducts = 10
VAR ProdsWithSales =
    ADDCOLUMNS (
        VALUES ( 'Product'[Product Name] ),
        "Product Sales", [Sales Amount]
    )
VAR TopNProducts =
    TOPN (
        NumOfTopProducts,
        ProdsWithSales,
        [Product Sales]
    )
VAR RemainingProducts =
    EXCEPT ( ProdsWithSales, TopNProducts )
VAR RankedTopProducts =
    ADDCOLUMNS(
        TopNProducts,
        "SortColumn", RANKX ( TopNProducts, [Product Sales] )
    )
VAR OtherRow =
    ROW (
        "Product Name", "Others",
        "Product Sales", SUMX (
            RemainingProducts,
            [Product Sales]
        ),
        "SortColumn", NumOfTopProducts + 1
    )
VAR Result =
    UNION ( RankedTopProducts, OtherRow )
RETURN
    Result
ORDER BY [SortColumn]</pre></div>
<p class="edition">The result visible in <a href="#calibre_link-1161" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-18</a> is now sorted better.</p>
<figure id="calibre_link-1161" class="image-l">
<img src="images/001214.jpg" alt="The Others row is at the end of the report. A SortColumn column was introduced." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3129"></span><strong class="calibre7">Figure 13-18</strong> The <em class="calibre5">SortColumn</em> index is how a developer can sort the results as desired.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-215" class="calibre13">Using <em class="calibre5">GENERATE</em> and <em class="calibre5">GENERATEALL</em></h4>
<p class="edition"><em class="calibre5">GENERATE</em> is a powerful function that implements the OUTER APPLY logic from the SQL language. <em class="calibre5">GENERATE</em> takes two arguments: a table and an expression. It iterates the table, evaluates the expression in the row context of the iteration, and then joins the row of the iteration with the rows returned by the table expression. Its behavior is like a regular join, but instead of joining with a table, it joins with an expression evaluated for each row. It is an extremely versatile function.</p>
<p class="edition">To demonstrate its behavior, we extend the previous <em class="calibre5">TOPN</em> example. Instead of computing the top products of all time, the requirement is to compute the top three products by year. We can split this problem into two steps: first, computing the top three products, and then repeating this calculation for every year. One possible solution for the top three products is the following:</p>
<p class="codelink"><a href="#calibre_link-1162" id="calibre_link-2642" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR ProductsSold =
    SUMMARIZE (
        Sales,
        'Product'[Product Name]
    )
VAR ProductsSales =
    ADDCOLUMNS (
        ProductsSold,
        "Product Sales", [Sales Amount]
    )
VAR Top3Products =
    <strong class="calibre7">TOPN (</strong>
        <strong class="calibre7">3,</strong>
        <strong class="calibre7">ProductsSales,</strong>
        <strong class="calibre7">[Product Sales]</strong>
    <strong class="calibre7">)</strong>
RETURN
    Top3Products
ORDER BY [Product Sales] DESC</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3130"></span>The result shown in <a href="#calibre_link-1163" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-19</a> contains just three products.</p>
<figure id="calibre_link-1163" class="image-l">
<img src="images/001222.jpg" alt="The report returns three products and their respective product sales." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-19</strong> <em class="calibre5">TOPN</em> returns the top three products of all time.</figcaption>
</figure>
<p class="edition">If the previous query is evaluated in a filter context that filters the year, the result is different: It returns the top three products of the given year. Here is where <em class="calibre5">GENERATE</em> comes in handy: We use <em class="calibre5">GENERATE</em> to iterate the years, and for each year we compute the <em class="calibre5">TOPN</em> expression. During each iteration, <em class="calibre5">TOPN</em> returns the top three products of the selected year. Finally, <em class="calibre5">GENERATE</em> joins the years with the result of the expression at each iteration. This is the complete query:</p>
<p class="codelink"><a href="#calibre_link-1164" id="calibre_link-2643" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
<strong class="calibre7">GENERATE (</strong>
    <strong class="calibre7">VALUES ( 'Date'[Calendar Year] ),</strong>
    CALCULATETABLE (
        VAR ProductsSold =
            SUMMARIZE ( Sales, 'Product'[Product Name] )
        VAR ProductsSales =
            ADDCOLUMNS ( ProductsSold, "Product Sales", [Sales Amount] )
        VAR Top3Products =
            TOPN ( 3, ProductsSales, [Product Sales] )
        RETURN Top3Products
    )
<strong class="calibre7">)</strong>
ORDER BY
    'Date'[Calendar Year],
    [Product Sales] DESC</pre></div>
<p class="edition">The result of the query is visible in <a href="#calibre_link-1165" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-20</a>.</p>
<figure id="calibre_link-1165" class="image-l">
<img src="images/001230.jpg" alt="The report returns nine rows: There are three consecutive years, and the top three products for each year." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-20</strong> <em class="calibre5">GENERATE</em> joins the years with the top three products by year.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1732"></span>If one needs to compute the top products by category, the only thing that needs to be updated in the formula is the table iterated by <em class="calibre5">GENERATE</em>. The following produces the top three products by category:</p>
<p class="codelink"><a href="#calibre_link-1166" id="calibre_link-2644" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
GENERATE (
    <strong class="calibre7">VALUES ( 'Product'[Category] ),</strong>
    CALCULATETABLE (
        VAR ProductsSold =
            SUMMARIZE ( Sales, 'Product'[Product Name] )
        VAR ProductsSales =
            ADDCOLUMNS ( ProductsSold, "Product Sales", [Sales Amount] )
        VAR Top3Products =
            TOPN ( 3, ProductsSales, [Product Sales] )
        RETURN Top3Products
    )
)
ORDER BY
    'Product'[Category],
    [Product Sales] DESC</pre></div>
<p class="edition">As shown in <a href="#calibre_link-1167" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-21</a>, the result now contains three products for each category.</p>
<figure id="calibre_link-1167" class="image-l">
<img src="images/001238.jpg" alt="The report returns the top three products per category, along with product sales." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-21</strong> Iterating over the categories, the result shows the top three products by category.</figcaption>
</figure>
<p class="edition">If the expression provided as the second argument of <em class="calibre5">GENERATE</em> produces an empty table, then <em class="calibre5">GENERATE</em> skips the row from the result. If one needs to also retrieve rows of the first table producing an empty result, then <em class="calibre5">GENERATEALL</em> is needed. For example, there are no sales in 2005, so there are no top three products in 2005; <em class="calibre5">GENERATE</em> does not return any row for 2005. The following query leverages <em class="calibre5">GENERATEALL</em> and returns 2005 and 2006:</p>
<p class="codelink"><a href="#calibre_link-1168" id="calibre_link-2645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
<strong class="calibre7">GENERATEALL (</strong>
    VALUES ( 'Date'[Calendar Year] ),
    CALCULATETABLE (
        VAR ProductsSold =
            SUMMARIZE ( Sales, 'Product'[Product Name] )
        VAR ProductsSales =
            ADDCOLUMNS ( ProductsSold, "Product Sales", [Sales Amount] )
<span type="pagebreak" id="calibre_link-3131"></span>        VAR Top3Products =
            TOPN ( 3, ProductsSales, [Product Sales] )
        RETURN Top3Products
    )
)
ORDER BY
    'Date'[Calendar Year],
    [Product Sales] DESC</pre></div>
<p class="edition">The result of this query is visible in <a href="#calibre_link-1169" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-22</a>.</p>
<figure id="calibre_link-1169" class="image-l">
<img src="images/001246.jpg" alt="This report includes blank values for Product Name and Product Sales, for certain years." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-22</strong> <em class="calibre5">GENERATEALL</em> returns years for which there are no sales, whereas <em class="calibre5">GENERATE</em> did not.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-216" class="calibre13">Using <em class="calibre5">ISONORAFTER</em></h4>
<p class="edition"><em class="calibre5">ISONORAFTER</em> is a utility function. It is heavily used by Power BI and reporting tools to provide pagination, and it is seldom used by developers in queries and measures. When a user browses a report in Power BI, the engine only retrieves the rows needed for the current page from the data model. To obtain this, it always uses a <em class="calibre5">TOPN</em> function.</p>
<p class="edition">If a user is browsing a products table, they might reach a certain point during the scanning. For example, in <a href="#calibre_link-1170" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-23</a> the last row shown is Stereo Bluetooth Headphones New Gen, and the arrow shows the relative position in the list.</p>
<figure id="calibre_link-1170" class="image-l">
<img src="images/001254.jpg" alt="The figure shows a list of products, along with the scrolling bar on the right-hand side." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1655"></span><strong class="calibre7">Figure 13-23</strong> The user is browsing the <em class="calibre5">Product</em> table and has reached a certain point in the list.</figcaption>
</figure>
<p class="edition">When the user scrolls down, they might reach the bottom of the rows retrieved previously; at this point, Power BI needs to retrieve the next rows. The query that retrieves the next rows will still be a <em class="calibre5">TOPN</em> because Power BI always retrieves a subset of the whole data. Moreover, it needs to be the next <em class="calibre5">TOPN</em>. This is where <em class="calibre5">ISONORAFTER</em> comes in. This is the full query executed by Power BI when scrolling down, and its result is shown in <a href="#calibre_link-1171" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-24</a>:</p>
<p class="codelink"><a href="#calibre_link-1172" id="calibre_link-2646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
TOPN (
    501,
    FILTER (
        KEEPFILTERS (
            SUMMARIZECOLUMNS (
                'Product'[Category],
                'Product'[Color],
                'Product'[Product Name],
                "Sales_Amount", 'Sales'[Sales Amount]
            )
        ),
        <strong class="calibre7">ISONORAFTER (</strong>
            <strong class="calibre7">'Product'[Category], "Audio", ASC,</strong>
            <strong class="calibre7">'Product'[Color], "Yellow", ASC,</strong>
            <strong class="calibre7">'Product'[Product Name],</strong>
                <strong class="calibre7">"WWI Stereo Bluetooth Headphones New Generation M370 Yellow", ASC</strong>
        <strong class="calibre7">)</strong>
    ),
    'Product'[Category], 1,
    'Product'[Color], 1,
    'Product'[Product Name], 1
)
ORDER BY
    'Product'[Category],
    'Product'[Color],
    'Product'[Product Name]</pre></div>
<figure id="calibre_link-1171" class="image-l">
<img src="images/000416.jpg" alt="The figure shows the next set of values." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1656"></span><strong class="calibre7">Figure 13-24</strong> This is the next set of rows starting from the last row in the previous figure.</figcaption>
</figure>
<p class="edition">The code executes a <em class="calibre5">TOPN 501</em> of a <em class="calibre5">FILTER</em>. <em class="calibre5">FILTER</em> is used to remove previously retrieved rows, and in order to obtain the scope, it leverages <em class="calibre5">ISONORAFTER</em>. That same condition of <em class="calibre5">ISONORAFTER</em> could have been expressed with standard Boolean logic. Indeed, the whole preceding <em class="calibre5">ISONORAFTER</em> expression could be written this way:</p>
<p class="codelink"><a href="#calibre_link-1173" id="calibre_link-2647" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Product'[Category] &gt; "Audio"
|| ( 'Product'[Category] = "Audio" &amp;&amp; 'Product'[Color] &gt; "Yellow" )
|| ( 'Product'[Category] = "Audio"
         &amp;&amp; 'Product'[Color] = "Yellow"
         &amp;&amp; 'Product'[Product Name]
                 &gt;= "WWI Stereo Bluetooth Headphones New Generation M370 Yellow"
   )</pre></div>
<p class="edition">The advantage of using <em class="calibre5">ISONORAFTER</em> is twofold: The code is easier to write, and the query plan is potentially better.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-217" class="calibre13">Using <em class="calibre5">ADDMISSINGITEMS</em></h4>
<p class="edition"><em class="calibre5">ADDMISSINGITEMS</em> is another function frequently used by Power BI and seldom used in authoring data models. Its purpose is to add rows that might have been skipped by <em class="calibre5">SUMMARIZECOLUMNS</em>. For example, the following query uses <em class="calibre5">SUMMARIZECOLUMNS</em> grouping by year; its result is visible in <a href="#calibre_link-1174" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-25</a>.</p>
<p class="codelink"><a href="#calibre_link-1175" id="calibre_link-2648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    'Date'[Calendar Year],
    "Amt", [Sales Amount]
)
ORDER BY 'Date'[Calendar Year]</pre></div>
<figure id="calibre_link-1174" class="image-l">
<img src="images/000011.jpg" alt="The report shows Amt per calendar year, and it returns three rows." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-25</strong> <em class="calibre5">SUMMARIZECOLUMNS</em> does not include years without sales where <em class="calibre5">Amt</em> column would be blank.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3132"></span>Years with no sales are not returned by <em class="calibre5">SUMMARIZECOLUMNS</em>. To retrieve the rows removed by <em class="calibre5">SUMMARIZECOLUMNS</em>, one option is to use <em class="calibre5">ADDMISSINGITEMS:</em></p>
<p class="codelink"><a href="#calibre_link-1176" id="calibre_link-2649" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ADDMISSINGITEMS (
    'Date'[Calendar Year],
    SUMMARIZECOLUMNS (
        'Date'[Calendar Year],
        "Amt", [Sales Amount]
    ),
    'Date'[Calendar Year]
)
ORDER BY 'Date'[Calendar Year]</pre></div>
<p class="edition">The result of this query is visible in <a href="#calibre_link-1177" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-26</a>, where we highlighted the rows returned by <em class="calibre5">SUMMARIZECOLUMNS</em>. The rows with a blank in the <em class="calibre5">Amt</em> column were added by <em class="calibre5">ADDMISSINGITEMS</em>.</p>
<figure id="calibre_link-1177" class="image-l">
<img src="images/000141.jpg" alt="In this report there are blank and nonblank rows for Amt." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-26</strong> <em class="calibre5">ADDMISSINGITEMS</em> added the rows with a blank value for <em class="calibre5">Amt</em>.</figcaption>
</figure>
<p class="edition"><em class="calibre5">ADDMISSINGITEMS</em> accepts several modifiers and parameters to better control the result for subtotals and other filters.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-218" class="calibre13">Using <em class="calibre5">TOPNSKIP</em></h4>
<p class="edition">The <em class="calibre5">TOPNSKIP</em> function is used extensively by Power BI to send just a few rows of a large raw dataset to the Data View of Power BI. Other tools, such as Power Pivot and SQL Server Data Tools, use other techniques to quickly browse and filter the raw data of a table. The reason for using them is to quickly browse over a large table without having to wait for the materialization of the entire set of rows. Both <em class="calibre5">TOPNSKIP</em> and other techniques are described in the article at <a href="http://www.sqlbi.com/articles/querying-raw-data-to-tabular/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://www.sqlbi.com/articles/querying-raw-data-to-tabular/</a>.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-219" class="calibre13">Using <em class="calibre5">GROUPBY</em></h4>
<p class="edition"><em class="calibre5">GROUPBY</em> is a function used to group a table by one or more columns, aggregating other data similarly to what is possible using <em class="calibre5">ADDCOLUMNS</em> and <em class="calibre5">SUMMARIZE</em>. The main difference between <em class="calibre5">SUMMARIZE</em> and <em class="calibre5">GROUPBY</em> is that <em class="calibre5">GROUPBY</em> can group columns whose data lineage does not correspond to columns in the data model, whereas <em class="calibre5">SUMMARIZE</em> can only use columns defined in the data model. <span type="pagebreak" id="calibre_link-3133"></span>In addition, columns added by <em class="calibre5">GROUPBY</em> need to use an iterator that aggregates data such as <em class="calibre5">SUMX</em>, <em class="calibre5">AVERAGEX</em>, or other “X” aggregation functions.</p>
<p class="edition">For example, consider the requirement to group sales by year and month and compute the sales amount. This is a possible solution using <em class="calibre5">GROUPBY;</em> the query result is visible in <a href="#calibre_link-1178" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-27</a>:</p>
<p class="codelink"><a href="#calibre_link-1179" id="calibre_link-2650" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
GROUPBY (
    Sales,
    'Date'[Calendar Year],
    'Date'[Month],
    'Date'[Month Number],
    "Amt", AVERAGEX (
        CURRENTGROUP (),
        Sales[Quantity] * Sales[Net Price]
    )
)
ORDER BY
    'Date'[Calendar Year],
    'Date'[Month Number]</pre></div>
<figure id="calibre_link-1178" class="image-l">
<img src="images/000149.jpg" alt="The report shows Amt per month, each month having a name and a number." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-27</strong> <em class="calibre5">GROUPBY</em> in this example aggregates the average of the line amount by year and month.</figcaption>
</figure>
<p class="edition">Performance-wise, <em class="calibre5">GROUPBY</em> can be slow in handling larger datasets&mdash;tens of thousands of rows or more. Indeed, GROUPBY performs the grouping after having materialized the table; it is thus not the suggested option to scan larger datasets. Besides, most queries can be expressed more easily by using the <em class="calibre5">ADDCOLUMNS</em> and <em class="calibre5">SUMMARIZE</em> pair. Indeed, the previous query is better written as:</p>
<p class="codelink"><a href="#calibre_link-1180" id="calibre_link-2651" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ADDCOLUMNS (
    SUMMARIZE (
        Sales,
        'Date'[Calendar Year],
        'Date'[Month],
        'Date'[Month Number],
    ),
    "Amt", AVERAGEX (
        RELATEDTABLE ( Sales ),
        Sales[Quantity] * Sales[Net Price]
    )
)
ORDER BY
<span type="pagebreak" id="calibre_link-1733"></span>    'Date'[Calendar Year],
    'Date'[Month Number]</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">In the previous query, it is worthwhile to note that the result of <em class="calibre5">SUMMARIZE</em> is a table containing columns from the <em class="calibre5">Date table</em>. Therefore, when <em class="calibre5">AVERAGEX</em> later iterates over the result of <em class="calibre5">RELATEDTABLE</em>, the table returned by <em class="calibre5">RELATEDTABLE</em> is the table of the year and month currently iterated by <em class="calibre5">ADDCOLUMNS</em> over the result of <em class="calibre5">SUMMARIZE</em>. Remember that data lineage is kept; therefore, the result of <em class="calibre5">SUMMARIZE</em> is a table along with its data lineage.</p>
</div>
<p class="edition">One advantage of <em class="calibre5">GROUPBY</em> is its option to group by columns added to the query by <em class="calibre5">ADDCOLUMNS</em> or <em class="calibre5">SUMMARIZE</em>. The following is an example where <em class="calibre5">SUMMARIZE</em> would not be an alternative:</p>
<p class="codelink"><a href="#calibre_link-1181" id="calibre_link-2652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR AvgCustomerSales =
    AVERAGEX (
        Customer,
        [Sales Amount]
    )
VAR ClassifiedCustomers =
    ADDCOLUMNS (
        VALUES ( Customer[Customer Code] ),
        "Customer Category", IF (
            [Sales Amount] &gt;= AvgCustomerSales,
            "Above Average",
            "Below Average"
        )
    )
VAR GroupedResult =
    GROUPBY (
        ClassifiedCustomers,
        [Customer Category],
        "Number of Customers", SUMX (
            CURRENTGROUP (),
            1
        )
    )
RETURN GroupedResult
ORDER BY [Customer Category]</pre></div>
<p class="edition">You can see the result in <a href="#calibre_link-1182" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-28</a>.</p>
<figure id="calibre_link-1182" class="image-l">
<img src="images/000022.jpg" alt="The report displays number of customers per customer category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-28</strong> <em class="calibre5">GROUPBY</em> can group columns computed during the query.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-2093"></span>The previous formula shows both the advantages and the disadvantages of <em class="calibre5">GROUPBY</em> at the same time. Indeed, the code first creates a new column in the customer table that checks if the customer sales are above or below the average sales. It then groups by this temporary column, and it returns the number of customers.</p>
<p class="edition">Grouping by a temporary column is a useful feature; however, to compute the number of customers, the code needs to use a <em class="calibre5">SUMX</em> over a <em class="calibre5">CURRENTGROUP</em> using a constant expression of 1. The reason is that columns added by <em class="calibre5">GROUPBY</em> need to be iterations over <em class="calibre5">CURRENTGROUP</em>. A simple function like <em class="calibre5">COUNTROWS ( CURRENTGROUP () )</em> would not work here.</p>
<p class="edition">There are only a few scenarios where <em class="calibre5">GROUPBY</em> is useful. In general, <em class="calibre5">GROUPBY</em> can be used when there is the need to group by a column added in the query, but be mindful that the column used to group by should have a small cardinality. Otherwise, you might face performance and memory consumption issues.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-220" class="calibre13">Using <em class="calibre5">NATURALINNERJOIN</em> and <em class="calibre5">NATURALLEFTOUTERJOIN</em></h4>
<p class="edition">DAX uses model relationships automatically whenever a developer runs a query. Still, it might be useful to join two tables that have no relationships. For example, one might define a variable containing a table and then join a calculated table with that variable.</p>
<p class="edition">Consider the requirement to compute the average sales per category and to then build a report showing the categories below, around, and above the average. This column is easy to compute with a simple <em class="calibre5">SWITCH</em> function. However, if the results need to be sorted in a particular way, then it is necessary to compute both the category description and the sort order (as a new column) at the same time, using a similar piece of code.</p>
<p class="edition">Another approach would be to compute only one of the two values and then use a temporary table with a temporary relationship to retrieve the description. This is exactly what the following query does:</p>
<p class="codelink"><a href="#calibre_link-1183" id="calibre_link-2653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR AvgSales =
    AVERAGEX (
        VALUES ( 'Product'[Brand] ),
        [Sales Amount]
    )
VAR LowerBoundary = AvgSales * 0.8
VAR UpperBoundary = AvgSales * 1.2
VAR Categories =
    DATATABLE (
        "Cat Sort", INTEGER,
        "Category", STRING,
        {
            { 0, "Below Average" },
            { 1, "Around Average" },
            { 2, "Above Average" }
        }
    )
VAR BrandsClassified =
<span type="pagebreak" id="calibre_link-1734"></span>    ADDCOLUMNS (
        VALUES ( 'Product'[Brand] ),
        "Sales Amt", [Sales Amount],
        "Cat Sort", SWITCH (
            TRUE (),
            [Sales Amount] &lt;= LowerBoundary, 0,
            [Sales Amount] &gt;= UpperBoundary, 2,
            1
        )
    )
VAR JoinedResult =
    <strong class="calibre7">NATURALINNERJOIN (</strong>
        <strong class="calibre7">Categories,</strong>
        <strong class="calibre7">BrandsClassified</strong>
    <strong class="calibre7">)</strong>
RETURN JoinedResult
ORDER BY
    [Cat Sort],
    'Product'[Brand]</pre></div>
<p class="edition">It is useful to look at the result of the query shown in <a href="#calibre_link-1184" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-29</a> before commenting on it.</p>
<figure id="calibre_link-1184" class="image-l">
<img src="images/000709.jpg" alt="The report shows brands below, around, and above average with their respective sales amount." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-29</strong> The <em class="calibre5">Cat Sort</em> column must be used as the “sort by column” argument on <em class="calibre5">Category</em>.</figcaption>
</figure>
<p class="edition">The query first builds a table containing the brands, the sales amounts, and a column with values between 0 and 2. The value will be used as a key in the <em class="calibre5">Categories</em> variable to retrieve the category description. This final join between the temporary table and the variable is performed by <em class="calibre5">NATURALINNERJOIN</em>, which joins the two tables based on the <em class="calibre5">Cat Sort</em> column.</p>
<p class="edition"><em class="calibre5">NATURALINNERJOIN</em> performs the join between two tables based on columns that have the same name in both tables. <em class="calibre5">NATURALLEFTOUTERJOIN</em> performs the same operation, but instead of an inner join, it uses a left outer join. By using a left outer join, <em class="calibre5">NATURALLEFTOUTERJOIN</em> keeps rows in the first table even if there are no matches in the second table.</p>
<p class="edition">In case the two tables are physically defined in the data model, they can only be joined using a relationship. This can be useful to obtain the result of the join between two tables&mdash;similarly to what is <span type="pagebreak" id="calibre_link-3134"></span>possible in a SQL query. Both <em class="calibre5">NATURALINNERJOIN</em> and <em class="calibre5">NATURALLEFTOUTERJOIN</em> use the relationship between the tables if it exists. Otherwise, they need the same data lineage to perform the join.</p>
<p class="edition">For example, this query returns all the rows in <em class="calibre5">Sales</em> that have corresponding rows in <em class="calibre5">Product</em>, only including all the columns of the two tables once:</p>
<p class="codelink"><a href="#calibre_link-1185" id="calibre_link-2654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
NATURALINNERJOIN ( Sales, Product )</pre></div>
<p class="edition">The following query returns all the rows in <em class="calibre5">Product</em>, also showing the products that have no <em class="calibre5">Sales</em>:</p>
<p class="codelink"><a href="#calibre_link-1186" id="calibre_link-2655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
NATURALLEFTOUTERJOIN ( Product, Sales )</pre></div>
<p class="edition">In both cases, the column that defines the relationship is only present once in the result, which includes all the other columns of the two tables.</p>
<p class="edition">However, one important limitation of these join functions is that they do not match two columns of the data model with different data lineage and no relationship. In practice, two tables of the data model that have one or more columns with the same name and no relationship cannot be joined together. As a workaround, one can use <em class="calibre5">TREATAS</em> to change the data lineage of a column so that the join becomes possible. The article at <a href="https://www.sqlbi.com/articles/from-sql-to-dax-joining-tables/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.sqlbi.com/articles/from-sql-to-dax-joining-tables/</a> describes this limitation and a possible workaround in detail.</p>
<p class="edition"><em class="calibre5">NATURALINNERJOIN</em> or <em class="calibre5">NATURALLEFTOUTERJOIN</em> are useful in a limited number of cases; in DAX, they are not as frequent as the equivalent join function in the SQL language.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition"><em class="calibre5">NATURALINNERJOIN</em> and <em class="calibre5">NATURALLEFTOUTERJOIN</em> are useful to join the result of temporary tables, where the data lineage of certain columns does not point to physical columns of the data model. In order to join tables in the model that do not have a proper relationship, it is necessary to use <em class="calibre5">TREATAS</em> to change the data lineage of the columns to use in the join operation.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-221" class="calibre13">Using <em class="calibre5">SUBSTITUTEWITHINDEX</em></h4>
<p class="edition">The <em class="calibre5">SUBSTITUTEWITHINDEX</em> function can replace the columns in a row set corresponding to the column headers of a matrix, with indexes representing their positions. <em class="calibre5">SUBSTITUTEWITHINDEX</em> is not a function a developer would use in a regular query because its behavior is quite intricate. One possible usage might be when creating a dynamic user interface for querying DAX. Indeed, Power BI internally uses <em class="calibre5">SUBSTITUTEWITHINDEX</em> for matrix charts.</p>
<p class="edition">For example, consider the Power BI matrix in <a href="#calibre_link-1187" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-30</a>.</p>
<figure id="calibre_link-1187" class="image-l">
<img src="images/000218.jpg" alt="This figure shows three years columns, populated with sales amounts for each category." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1737"></span><strong class="calibre7">Figure 13-30</strong> A matrix in Power BI is populated using a query with <em class="calibre5">SUBSTITUTEWITHINDEX</em>.</figcaption>
</figure>
<p class="edition">The result of a DAX query is always a table. Each cell of the matrix in the report corresponds to a single row of the table returned by the DAX query. In order to correctly display the data in the report, Power BI uses <em class="calibre5">SUBSTITUTEWITHINDEX</em> to translate the column names of the matrix (CY 2007, CY 2008, and CY 2009) into sequential numbers, making it easier to populate the matrix when reading the result. The following is a simplified version of the DAX request generated for the previous matrix:</p>
<p class="codelink"><a href="#calibre_link-1188" id="calibre_link-2656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    VAR SalesYearCategory =
        SUMMARIZECOLUMNS (
            'Product'[Category],
            'Date'[Calendar Year],
            "Sales_Amount", [Sales Amount]
        )
    VAR MatrixRows =
        SUMMARIZE (
            SalesYearCategory,
            'Product'[Category]
        )
    VAR MatrixColumns =
        SUMMARIZE (
            SalesYearCategory,
            'Date'[Calendar Year]
        )
    VAR SalesYearCategoryIndexed =
        <strong class="calibre7">SUBSTITUTEWITHINDEX (</strong>
            <strong class="calibre7">SalesYearCategory,</strong>
            <strong class="calibre7">"ColumnIndex", MatrixColumns,</strong>
            <strong class="calibre7">'Date'[Calendar Year], ASC</strong>
        <strong class="calibre7">)</strong>
-- First result: matrix column headers
EVALUATE
MatrixColumns
ORDER BY 'Date'[Calendar Year]

-- Second result: matrix rows and content
EVALUATE
NATURALLEFTOUTERJOIN (
<span type="pagebreak" id="calibre_link-1725"></span>    MatrixRows,
    SalesYearCategoryIndexed
)
ORDER BY
    'Product'[Category],
    [ColumnIndex]</pre></div>
<p class="edition">The request contains two <em class="calibre5">EVALUATE</em> statements. The first <em class="calibre5">EVALUATE</em> returns the content of the column headers, as shown in <a href="#calibre_link-1189" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-31</a>.</p>
<figure id="calibre_link-1189" class="image-l">
<img src="images/000794.jpg" alt="The figure shows the column headers from before, in a column called Calendar Year." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-31</strong> Result of the column headers of a matrix in Power BI.</figcaption>
</figure>
<p class="edition">The second <em class="calibre5">EVALUATE</em> returns the remaining content of the matrix, providing one row for each cell of the matrix content. Every row in the result has the columns required to populate the row header of the matrix followed by the numbers to display, and one column containing the column index computed by using the <em class="calibre5">SUBSTITUTEWITHINDEX</em> function. This is shown in <a href="#calibre_link-1190" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-32</a>.</p>
<figure id="calibre_link-1190" class="image-l">
<img src="images/000018.jpg" alt="In this report, we see ColumnIndex and Sales_Amount per category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-32</strong> Result of the rows’ content of a matrix in Power BI generated using <em class="calibre5">SUBSTITUTEWITHINDEX</em>.</figcaption>
</figure>
<p class="edition"><em class="calibre5">SUBSTITUTEWITHINDEX</em> is mainly used to build visuals like the matrix in Power BI.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-222" class="calibre13">Using <em class="calibre5">SAMPLE</em></h4>
<p class="edition"><em class="calibre5">SAMPLE</em> returns a sample of rows from a table. Its arguments are the number of rows to be returned, the table name, and a sort order. <em class="calibre5">SAMPLE</em> returns the first and the last rows of the table, plus additional rows up to exactly the number of rows requested. <em class="calibre5">SAMPLE</em> picks evenly distributed rows from the source table.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1740"></span>For example, the following query returns exactly 10 products after having sorted the input table by <em class="calibre5">Product Name</em>:</p>
<p class="codelink"><a href="#calibre_link-1191" id="calibre_link-2657" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SAMPLE (
    10,
    ADDCOLUMNS (
        VALUES ( 'Product'[Product Name] ),
        "Sales", [Sales Amount]
    ),
    'Product'[Product Name]
)
ORDER BY 'Product'[Product Name]</pre></div>
<p class="edition">The result of the previous query is visible in <a href="#calibre_link-1192" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-33</a>.</p>
<figure id="calibre_link-1192" class="image-l">
<img src="images/000026.jpg" alt="The figure shows sales per product name, for a sample set of products." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-33</strong> <em class="calibre5">SAMPLE</em> returns a subset of a table by choosing evenly distributed rows.</figcaption>
</figure>
<p class="edition"><em class="calibre5">SAMPLE</em> is useful for a DAX client tool to generate values for the axis of a chart. Another scenario is an analysis where the user needs a sample of a table to perform a statistical calculation.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-223" class="h2a">Understanding the auto-exists behavior in DAX queries</h3>
<p class="edition">Many DAX functions use a behavior known as <em class="calibre5">auto-exists</em>. Auto-exists is a mechanism used when a function joins two tables. It is important when authoring queries because, although it is usually intuitive, it might produce unexpected results.</p>
<p class="edition">Consider the following expression:</p>
<p class="codelink"><a href="#calibre_link-1193" id="calibre_link-2658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    'Product'[Category],
<span type="pagebreak" id="calibre_link-3135"></span>    'Product'[Subcategory]
)
ORDER BY
    'Product'[Category],
    'Product'[Subcategory]</pre></div>
<p class="edition">The result can be either the full cross-join of categories and subcategories, or only the existing combinations of categories and subcategories. Indeed, each category contains just a subset of subcategories. Thus, the list of existing combinations is smaller than the full cross-join.</p>
<p class="edition">The most intuitive answer would be that <em class="calibre5">SUMMARIZECOLUMNS</em> only returns the existing combination. This is exactly what happens because of the auto-exists feature. The result in <a href="#calibre_link-1194" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-34</a> shows no more than three subcategories for the Audio category, and not a list of all the subcategories.</p>
<figure id="calibre_link-1194" class="image-l">
<img src="images/000033.jpg" alt="In this figure, only the subcategories that belong to a category are visible." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-34</strong> <em class="calibre5">SUMMARIZECOLUMNS</em> only returns the existing combinations of values.</figcaption>
</figure>
<p class="edition">Auto-exists kicks in whenever the query groups by columns coming from the same table. When the auto-exists logic is used, existing combinations of values are generated exclusively. This reduces the number of rows to evaluate, generating better query plans. On the other hand, if one uses columns coming from different tables, then the result is different. If the columns used in <em class="calibre5">SUMMARIZECOLUMNS</em> are from different tables, then the result is the full cross-join of the two tables. This is made visible by the following query whose result is shown in <a href="#calibre_link-1195" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-35</a>:</p>
<p class="codelink"><a href="#calibre_link-1196" id="calibre_link-2659" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    'Product'[Category],
    'Date'[Calendar Year]
)
ORDER BY
    'Product'[Category],
    'Date'[Calendar Year]</pre></div>
<p class="edition">Though the two tables are linked to the <em class="calibre5">Sales</em> table through relationships and there are years without transactions, the auto-exists logic is not used when the columns do not come from the same table.</p>
<figure id="calibre_link-1195" class="image-l">
<img src="images/000040.jpg" alt="In this figure, all options are visible for calendar years per category." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3136"></span><strong class="calibre7">Figure 13-35</strong> Columns coming from different tables generate the full cross-join.</figcaption>
</figure>
<p class="edition">Be mindful that <em class="calibre5">SUMMARIZECOLUMNS</em> removes the columns if all the additional columns computing aggregation expressions are blank. Thus, if the previous query also includes the <em class="calibre5">Sales Amount</em> measure, <em class="calibre5">SUMMARIZECOLUMNS</em> removes the years and categories without sales, as shown in <a href="#calibre_link-1197" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-36</a>:</p>
<p class="codelink"><a href="#calibre_link-1198" id="calibre_link-2660" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Sales Amount] =
        SUMX (
            Sales,
            Sales[Quantity] * Sales[Net Price]
        )
EVALUATE
SUMMARIZECOLUMNS (
    'Product'[Category],
    'Date'[Calendar Year],
    <strong class="calibre7">"Sales", [Sales Amount]</strong>
)
ORDER BY
    'Product'[Category],
    'Date'[Calendar Year]</pre></div>
<figure id="calibre_link-1197" class="image-l">
<img src="images/000047.jpg" alt="Now only calendar years and categories are visible only with sales, along with sales amount." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-36</strong> The presence of an aggregation expression removes the rows with a blank result.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1657"></span>The behavior of the previous query does not correspond to an auto-exists logic because it is based on the result of an expression that includes an aggregation. Constant expressions are ignored on this basis. For example, the presence of a 0 instead of a blank generates a list with all the years and categories. The result of the following query is visible in <a href="#calibre_link-1199" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-37</a>:</p>
<p class="codelink"><a href="#calibre_link-1200" id="calibre_link-2661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Sales Amount] =
        SUMX (
            Sales,
            Sales[Quantity] * Sales[Net Price]
        )
EVALUATE
SUMMARIZECOLUMNS (
    'Product'[Category],
    'Date'[Calendar Year],
    "Sales", [Sales Amount] <strong class="calibre7">+ 0 -- Returns 0 instead of blank</strong>
)
ORDER BY
    'Product'[Category],
    'Date'[Calendar Year]</pre></div>
<figure id="calibre_link-1199" class="image-l">
<img src="images/000054.jpg" alt="The visualization displays all possible calendar years for each category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-37</strong> An aggregation expression resulting in 0 instead of blank maintains the rows in the <em class="calibre5">SUMMARIZECOLUMNS</em> results.</figcaption>
</figure>
<p class="edition">However, the same approach does not produce additional combinations for columns coming from the same table. The auto-exists behavior is always applied to columns of the same table. The following query solely generates existing combinations of <em class="calibre5">Category</em> and <em class="calibre5">Subcategory</em> values, despite the measure expression returning 0 instead of blank:</p>
<p class="codelink"><a href="#calibre_link-1201" id="calibre_link-2662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-1658"></span>DEFINE
    MEASURE Sales[Sales Amount] =
        SUMX (
            Sales,
            Sales[Quantity] * Sales[Net Price]
        )
EVALUATE
SUMMARIZECOLUMNS (
    'Product'[Category],
    'Product'[Subcategory],
    "Sales", [Sales Amount] + 0
)
ORDER BY
    'Product'[Category],
    'Product'[Subcategory]</pre></div>
<p class="edition">The result is visible in <a href="#calibre_link-1202" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-38</a>.</p>
<figure id="calibre_link-1202" class="image-l">
<img src="images/000062.jpg" alt="This report only shows sales amounts for combinations of categories and subcategories where sales are above zero." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-38</strong> <em class="calibre5">SUMMARIZECOLUMNS</em> applies the auto-exists to columns from the same table even when aggregation expressions return 0.</figcaption>
</figure>
<p class="edition">It is important to consider the auto-exists logic when using <em class="calibre5">ADDMISSINGITEMS</em>. Indeed, <em class="calibre5">ADDMISSINGITEMS</em> only adds rows that are removed because of blank results in <em class="calibre5">SUMMARIZECOLUMNS. ADDMISSINGITEMS</em> does not add rows removed by auto-exists for columns of the same table. The following query thus returns the same result as the one shown in <a href="#calibre_link-1202" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-38</a>:</p>
<p class="codelink"><a href="#calibre_link-1203" id="calibre_link-2663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Sales Amount] =
        SUMX (
            Sales,
            Sales[Quantity] * Sales[Net Price]
        )
EVALUATE
<strong class="calibre7">ADDMISSINGITEMS (</strong>
    <strong class="calibre7">'Product'[Category],</strong>
    <strong class="calibre7">'Product'[Subcategory],</strong>
    SUMMARIZECOLUMNS (
        'Product'[Category],
        'Product'[Subcategory],
        "Sales", [Sales Amount] + 0
    ),
<span type="pagebreak" id="calibre_link-1726"></span>    <strong class="calibre7">'Product'[Category],</strong>
    <strong class="calibre7">'Product'[Subcategory]</strong>
<strong class="calibre7">)</strong>
ORDER BY
    'Product'[Category],
    'Product'[Subcategory]</pre></div>
<p class="edition">Auto-exists is an important aspect to consider when using <em class="calibre5">SUMMARIZECOLUMNS</em>. On the other hand, the behavior of <em class="calibre5">SUMMARIZE</em> is different. <em class="calibre5">SUMMARIZE</em> always requires a table to use as a bridge between the columns, acting as an auto-exists between different tables. For example, the following <em class="calibre5">SUMMARIZE</em> produces just the combinations of category and year where there are corresponding rows in the <em class="calibre5">Sales</em> table, as shown by the result in <a href="#calibre_link-1204" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 13-39</a>:</p>
<p class="codelink"><a href="#calibre_link-1205" id="calibre_link-2664" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZE (
    Sales,
    'Product'[Category],
    'Date'[Calendar Year]
)</pre></div>
<figure id="calibre_link-1204" class="image-l">
<img src="images/000070.jpg" alt="The figure shows calendar years per category, and only select calendar years are there." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 13-39</strong> <em class="calibre5">SUMMARIZE</em> only returns combinations between categories and year where there are matching rows in <em class="calibre5">Sales</em>.</figcaption>
</figure>
<p class="edition">The reason why nonexisting combinations are not returned is because <em class="calibre5">SUMMARIZE</em> uses the <em class="calibre5">Sales</em> table as the starting point to perform the grouping. Thus, any value in category or year not referenced in <em class="calibre5">Sales</em> is not part of the result. Even though the result is identical, <em class="calibre5">SUMMARIZE</em> and <em class="calibre5">SUMMARIZECOLUMNS</em> achieve the same result through different techniques.</p>
<p class="edition">Be mindful that the user experience might be different when using a specific client tool. Indeed, if a user puts the category and the year in a Power BI report without including any measure, the result only shows the existing combinations in the <em class="calibre5">Sales</em> table. The reason is not that auto-exists is in place. The reason is that Power BI adds its own business rules to the auto-exists logic of DAX. A simple report with just <em class="calibre5">Year</em> and <em class="calibre5">Category</em> in a table produces a complex query like the following one:</p>
<p class="codelink"><a href="#calibre_link-1206" id="calibre_link-2665" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-3137"></span>EVALUATE
TOPN (
    501,
    SELECTCOLUMNS (
        KEEPFILTERS (
            FILTER (
                KEEPFILTERS (
                    SUMMARIZECOLUMNS (
                        'Date'[Calendar Year],
                        'Product'[Category],
                        <strong class="calibre7">"CountRowsSales", CALCULATE ( COUNTROWS ( 'Sales' ) )</strong>
                    )
                ),
                OR (
                    NOT ( ISBLANK ( 'Date'[Calendar Year] ) ),
                    NOT ( ISBLANK ( 'Product'[Category] ) )
                )
            )
        ),
        "'Date'[Calendar Year]", 'Date'[Calendar Year],
        "'Product'[Category]", 'Product'[Category]
    ),
    'Date'[Calendar Year], 1,
    'Product'[Category], 1
)</pre></div>
<p class="edition">The highlighted row shows that Power BI adds a hidden calculation that computes the number of rows in <em class="calibre5">Sales</em>. Because <em class="calibre5">SUMMARIZECOLUMNS</em> removes all the rows where the aggregation expression is blank, this results in a behavior similar to the auto-exists obtained by combining columns of the same table.</p>
<p class="edition">Power BI only adds this calculation if there are no measures in the report, including a table that has a many-to-one relationship with all the tables used in <em class="calibre5">SUMMARIZECOLUMNS</em>. As soon as one adds a calculation by using a measure, Power BI stops this behavior and checks for the measure value instead of the number of rows in <em class="calibre5">Sales</em>.</p>
<p class="edition">Overall, the behavior of <em class="calibre5">SUMMARIZECOLUMNS</em> and <em class="calibre5">SUMMARIZE</em> is intuitive most of the time. However, in complex scenarios like many-to-many relationships, the results might be surprising. In this short section we only introduced auto-exists. A more detailed explanation of how these functions work in complex scenarios is available in the article “Understanding DAX Auto-Exist,” available at <a href="https://www.sqlbi.com/articles/understanding-dax-auto-exist/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.sqlbi.com/articles/understanding-dax-auto-exist/</a>. The article also shows how this behavior might produce reports with unexpected&mdash;or just counterintuitive&mdash;results.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-224" class="h2a">Conclusions</h3>
<p class="edition">This chapter presented several functions that are useful to author queries. Always remember that any of these functions (apart from <em class="calibre5">SUMMARIZECOLUMNS</em> and <em class="calibre5">ADDMISSINGITEMS</em>) can be used in measures too. Some experience is needed to learn how to mix these functions together to build more complex queries.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3138"></span>Here is the list of the most relevant topics covered in the chapter:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Some functions are more useful in queries. Others are so technical and specialized that their purpose is more to serve client tools generating queries, rather than data modelers writing DAX expressions manually. Regardless, it is important to read about all of them; at some point, it could become necessary to read somebody else’s code, so basic knowledge of all the functions is important.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">EVALUATE</em> introduces a query. Using <em class="calibre5">EVALUATE</em>, you can define variables and measures that only exist for the duration of the query.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">EVALUATE</em> cannot be used to create calculated tables. A calculated table comes from an expression. Thus, when creating a query for a calculated table, you cannot create local measures or columns.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">SUMMARIZE</em> is useful to perform grouping, and it is usually side-by-side with <em class="calibre5">ADDCOLUMNS</em>.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">SUMMARIZECOLUMNS</em> is one-function-fits-all. It is useful and powerful to generate complex queries, and it is used extensively by Power BI. However, <em class="calibre5">SUMMARIZECOLUMNS</em> cannot be used in a filter context that contains a context transition. This usually prevents the use of <em class="calibre5">SUMMARIZECOLUMNS</em> in measures.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">TOPN</em> is extremely useful to retrieve the top (or the bottom) performers out of a category.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">GENERATE</em> implements the OUTER APPLY logic of SQL. It becomes handy whenever you need to produce a table with a first set of columns that act as a filter and a second set of columns that depends on the values of the first set.</p></li>
<li class="calibre10"><p class="listp">Many other functions are mostly useful for query generators.</p></li>
</ul>
<p class="edition">Finally, remember that all the table functions described in previous chapters can be used to author queries. The options available to produce queries are not limited to the functions demonstrated in this chapter.</p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1207">
<div id="calibre_link-3139" class="calibre2">
<div id="calibre_link-3140" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-19"><span type="pagebreak" id="calibre_link-2028"></span><span class="pd_ash">Chapter 14</span><br class="calibre3" />Advanced DAX concepts</h2>
<p class="edition">So far in the book, we have provided a complete description of the pillars of DAX: row context, filter context and context transition. In previous chapters, we made several references to this chapter as the chapter where we would uncover all the secrets of DAX. You might want to read this chapter multiple times, for a complete understanding of certain concepts. In our experience, the first read can make a developer wonder, “Why should it be so complicated?” However, after learning the concepts outlined here for the first time, readers start to realize that many of the concepts they struggled in learning have a common denominator; once they grasp it, everything becomes clear.</p>
<p class="edition">We introduced several chapters saying that the goal of the chapter was to move the reader to the next level. If each chapter is a level, this is the boss level! Indeed, the concepts of expanded tables and of shadow filter contexts are hard to learn. Once learned, they shed a completely different light upon everything described so far. It is fair to say that&mdash;after finishing this chapter&mdash;a second read of the whole book is strongly suggested. A second read will likely uncover many details that did not seem helpful at first read. We realize that a full second read of the book takes a lot of effort. But then we did promise that reading <em class="calibre5">The Definitive Guide to DAX</em> would transform the reader into a DAX guru. We never said it would be an easy task.</p>
<section class="calibre4">
<h3 id="calibre_link-225" class="h2a">Introducing expanded tables</h3>
<p class="edition">The first&mdash;and most important&mdash;concept to learn is that of <em class="calibre5">expanded tables</em>. In DAX, every table has a matching expanded version. The expanded version of a table contains all the columns of the original table, plus all the columns of the tables that are on the one-side of a chain of many-to-one relationships starting from the source table.</p>
<p class="edition">Consider the model in <a href="#calibre_link-1208" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-1</a>.</p>
<figure id="calibre_link-1208" class="image-l">
<img src="images/000206.jpg" alt="In this figure, we visualize a model with several tables and relationships." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3141"></span><strong class="calibre7">Figure 14-1</strong> The figure shows the model used to describe the concept of expanded tables.</figcaption>
</figure>
<p class="edition">Table expansion goes towards the one-side. Therefore, to expand a table, one starts from the base table and adds to the base table all the columns of the related tables that are on the one-side of any relationships. For example, <em class="calibre5">Sales</em> has a many-to-one relationship with <em class="calibre5">Product</em>, so the expanded version of <em class="calibre5">Sales</em> contains also all the columns of <em class="calibre5">Product</em>. On the other hand, the expanded version of <em class="calibre5">Product Category</em> only contains the base table. Indeed, the only table with a relationship with <em class="calibre5">Product Category</em> is <em class="calibre5">Product Subcategory</em>, but it is on the many-side of the relationship. Thus, table expansion goes from <em class="calibre5">Product Subcategory</em> to <em class="calibre5">Product Category</em>, but not the other way around.</p>
<p class="edition">Table expansion does not stop at the first level. For example, from <em class="calibre5">Sales</em> one can reach <em class="calibre5">Product Category</em> following only many-to-one relationships. Thus, the expanded version of <em class="calibre5">Sales</em> contains <em class="calibre5">Product</em>, <em class="calibre5">Product Subcategory</em>, and <em class="calibre5">Product Category</em> columns. Moreover, because <em class="calibre5">Sales</em> is on the many side of a many-to-one relationship with <em class="calibre5">Date</em>, the expanded version of <em class="calibre5">Sales</em> contains <em class="calibre5">Date</em> too. In other words, the expanded version of <em class="calibre5">Sales</em> contains the entire data model.</p>
<p class="edition">The <em class="calibre5">Date</em> table requires a bit more attention. In fact, it can be filtered by <em class="calibre5">Sales</em> because the relationship that links <em class="calibre5">Sales</em> and <em class="calibre5">Date</em> has a bidirectional filter direction. Though this relationship is bidirectional, it is not a many-to-one: It is a one-to-many. The expanded version of <em class="calibre5">Date</em> only contains <em class="calibre5">Date</em> itself, even though <em class="calibre5">Date</em> can be filtered by <em class="calibre5">Sales</em>, <em class="calibre5">Product</em>, <em class="calibre5">Product Subcategory</em>, and <em class="calibre5">Product Category</em>. When filtering occurs because a relationship is bidirectional, the mechanism that applies the filtering is not that of expanded tables. Instead, filters are injected by the DAX code using a different mechanism, which is out of the scope of this chapter. Bidirectional filter propagation is discussed in <a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 15</a>, “<a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Advanced relationships</a>.”</p>
<p class="edition">When repeating the same exercise for the other tables in the data model, we create the expanded tables described in <a href="#calibre_link-1209" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 14-1</a>.</p>
<p class="edition" id="calibre_link-1209"><strong class="calibre7">Table 14-1</strong> Expanded versions of the tables</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Table</p></th>
<th class="th"><p class="tab-text">Expanded Version</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">Date</p></td>
<td class="th1"><p class="tab-text">Date</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Sales</p></td>
<td class="th1"><p class="tab-text">All the tables in the entire model</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Product</p></td>
<td class="th1"><p class="tab-text">Product, Product Subcategory, Product Category</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Product Subcategory</p></td>
<td class="th1"><p class="tab-text">Product Subcategory, Product Category</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Product Category</p></td>
<td class="th1"><p class="tab-text">Product Category</p></td>
</tr>
</tbody>
</table>
<p class="edition"><span type="pagebreak" id="calibre_link-1928"></span>There might be different kinds of relationships in a data model: one-to-one relationships, one-to-many relationships, and many-to-many relationships. The rule is always the same: Expansion goes towards the one-side of a relationship. Nevertheless, some examples might help in understanding the concept better. For example, consider the data model in <a href="#calibre_link-1210" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-2</a>, which does not follow best practices in data modeling but is useful for educational purposes.</p>
<figure id="calibre_link-1210" class="image-l">
<img src="images/000214.jpg" alt="In this model we see Product, flanked with Product Details and Product Category." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 14-2</strong> In this model both relationships have a bidirectional filter. One relationship is one-to-one, and the other is many-to-many.</figcaption>
</figure>
<p class="edition">We purposely used complex kinds of relationships in this model, where the <em class="calibre5">Product Category</em> table has one row for each value in <em class="calibre5">Subcategory</em>, so there are multiple rows for each category in such a table, and the <em class="calibre5">ProductCategoryKey</em> column does not contain unique values. Both relationships have a bidirectional filter. The relationship between <em class="calibre5">Product</em> and <em class="calibre5">Product Details</em> is a one-to-one relationship, whereas the one between <em class="calibre5">Product</em> and <em class="calibre5">Product Category</em> is a weak relationship where both sides are the many-side. The rule is always the same: Expansion goes towards the one-side of a relationship, regardless of the side it starts from.</p>
<p class="edition">Consequently, <em class="calibre5">Product Details</em> expands to <em class="calibre5">Product</em>, and <em class="calibre5">Product</em> expands to <em class="calibre5">Product Details</em> at the same time. The expanded version of the two tables, <em class="calibre5">Product</em> and <em class="calibre5">Product Details</em>, is indeed the same. Moreover, <em class="calibre5">Product Category</em> does not expand to <em class="calibre5">Product</em>, nor does <em class="calibre5">Product</em> expand to <em class="calibre5">Product Category</em>. The reason is that both tables are on the many-side of a weak relationship. When both sides of a relationship are the many-side, expansion does not happen. When both sides of a relationship are set as the many-side, the relationship becomes automatically a <em class="calibre5">weak relationship</em>. Not that they have any kind of weakness&mdash;weak relationships, like bidirectional filtering, work with a different goal than that of table expansion.</p>
<p class="edition">Expanded tables are a useful concept because they provide a clear explanation of how filter context propagation works within a DAX formula. Once a filter is being applied to a column, all the expanded tables containing that column are filtered. This statement deserves further explanation.</p>
<p class="edition">We present the expanded tables of the model used in <a href="#calibre_link-1208" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-1</a> on a diagram, which is shown in <a href="#calibre_link-1211" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-3</a>.</p>
<figure id="calibre_link-1211" class="image-l">
<img src="images/000223.jpg" alt="This figure is a table showing native columns and derived columns." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3142"></span><strong class="calibre7">Figure 14-3</strong> Presenting the data model on a diagram makes it easier to visualize expanded tables.</figcaption>
</figure>
<p class="edition">The chart in <a href="#calibre_link-1211" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-3</a> lists all the columns of the model on the horizontal lines and each table name on the vertical lines. Please note that some column names appear multiple times. Duplicate column names come from the fact that different tables may have column names in common. We colored the cells to distinguish between the columns of the base table and the columns belonging to the expanded table. There are two types of columns:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Native columns</strong> are the columns that originally belong to the base table, colored in a slightly darker grey.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Related columns</strong> are the columns added to the expanded table by following the existing relationships. These columns are light grey in the diagram.</p></li>
</ul>
<p class="edition">The diagram helps in finding which tables are filtered by a column. For example, the following measure uses <em class="calibre5">CALCULATE</em> to apply a filter on the <em class="calibre5">Product[Color]</em> column:</p>
<p class="codelink"><a href="#calibre_link-1212" id="calibre_link-2667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">RedSales :=
CALCULATE (
    SUM ( Sales[Quantity] ),
    'Product'[Color] = "Red"
)</pre></div>
<p class="edition">We can use the diagram to highlight the tables containing the <em class="calibre5">Product[Color]</em> column. Looking at <a href="#calibre_link-1213" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-4</a>, we can immediately conclude that both <em class="calibre5">Product</em> and <em class="calibre5">Sales</em> are the affected tables.</p>
<figure id="calibre_link-1213" class="image-l">
<img src="images/000231.jpg" alt="In the figure, the line for Color was highlighted. It crosses over to product and sales." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2027"></span><strong class="calibre7">Figure 14-4</strong> Coloring the line corresponding to a column makes it evident which tables are filtered.</figcaption>
</figure>
<p class="edition">We can use the same diagram to check how the filter context propagates through relationships. Once DAX filters any column on the one-side of a relationship, it filters all the tables that contain that column in their expanded version. This includes all the tables that are on the many-side of the relationships.</p>
<p class="edition">Thinking in terms of expanded tables makes the whole filter context propagation much easier. Indeed, a <em class="calibre5">filter context operates on all the expanded tables containing the filtered columns</em>. When speaking in terms of expanded tables, one no longer needs to consider relationships as part of the discussion. Table expansion uses relationships. Once a table has been expanded, the relationships have been included in the expanded tables. They no longer need to be taken into account.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Please note that the filter on <em class="calibre5">Color</em> propagates to <em class="calibre5">Date</em> too, though technically, <em class="calibre5">Color</em> does not belong to the expanded version of <em class="calibre5">Date</em>. This is the effect of bidirectional filtering at work. It is important to note that the filter on <em class="calibre5">Color</em> reaches <em class="calibre5">Date</em> through a completely different process, not through expanded tables. Internally, DAX injects a specific filtering code to make bidirectional relationships work, whereas filtering on expanded tables occurs automatically. The difference is only internal, yet it is important to point it out. The same applies for weak relationships: They do not use expanded tables. Weak relationships use filter injection instead.</p>
</div>
<section class="calibre4">
<h4 id="calibre_link-226" class="calibre13">Understanding <em class="calibre5">RELATED</em></h4>
<p class="edition">Whenever one references a table in DAX, it is always the expanded table. From a semantic point of view, the <em class="calibre5">RELATED</em> keyword does not execute any operation. Instead, it gives a developer access to the related columns of an expanded table. Thus, in the following code the <em class="calibre5">Unit Price</em> column belongs to the expanded table of <em class="calibre5">Sales</em>, and <em class="calibre5">RELATED</em> permits access to it through the row context pointing to the <em class="calibre5">Sales</em> table:</p>
<p class="codelink"><a href="#calibre_link-1214" id="calibre_link-2668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-3143"></span>SUMX (
    Sales,
    Sales[Quantity] * RELATED ( 'Product'[Unit Price] )
)</pre></div>
<p class="edition">One important aspect of table expansion is that it takes place when a table is defined, not when it is being used. For example, consider the following query:</p>
<p class="codelink"><a href="#calibre_link-1215" id="calibre_link-2669" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR SalesA =
    CALCULATETABLE (
        Sales,
        USERELATIONSHIP ( Sales[Order Date], 'Date'[Date] )
    )
VAR SalesB =
    CALCULATETABLE (
        Sales,
        USERELATIONSHIP ( Sales[Delivery Date], 'Date'[Date] )
    )
RETURN
    GENERATE (
        VALUES ( 'Date'[Calendar Year] ),
        VAR CurrentYear = 'Date'[Calendar Year]
        RETURN
            ROW (
                "Sales From A", COUNTROWS (
                    FILTER (
                        SalesA,
                        <strong class="calibre7">RELATED ( 'Date'[Calendar Year] )</strong> = CurrentYear
                    )
                ),
                "Sales From B", COUNTROWS (
                    FILTER (
                        SalesB,
                        <strong class="calibre7">RELATED ( 'Date'[Calendar Year] )</strong> = CurrentYear
                    )
                )
            )
    )</pre></div>
<p class="edition"><em class="calibre5">SalesA</em> and <em class="calibre5">SalesB</em> are two copies of the <em class="calibre5">Sales</em> table, evaluated in a filter context where two different relationships are active: <em class="calibre5">SalesA</em> uses the relationship between <em class="calibre5">Order Date</em> and <em class="calibre5">Date</em>, whereas <em class="calibre5">SalesB</em> activates the relationship between <em class="calibre5">Delivery Date</em> and <em class="calibre5">Date</em>.</p>
<p class="edition">Once the two variables are evaluated, <em class="calibre5">GENERATE</em> iterates over the years; it then creates two additional columns. The two additional columns contain the count of <em class="calibre5">SalesA</em> and <em class="calibre5">SalesB</em>, applying a further filter for the rows where <em class="calibre5">RELATED ( 'Date'[Calendar Year] )</em> equals the current year. Please note that we had to write rather convoluted code in order to avoid any context transition. Indeed, no context transitions are taking place in the whole <em class="calibre5">GENERATE</em> function call.</p>
<p class="edition">The question here is understanding what happens when the two highlighted <em class="calibre5">RELATED</em> functions are called. Unless one thinks in terms of expanded tables, the answer is problematic. When <em class="calibre5">RELATED</em> <span type="pagebreak" id="calibre_link-1804"></span>is executed, the active relationship is the one between <em class="calibre5">Sales[Order Date]</em> and <em class="calibre5">Date[Date]</em> because the two variables have already been computed earlier and both <em class="calibre5">USERELATIONSHIP</em> modifiers have finished their job. Nevertheless, both <em class="calibre5">SalesA</em> and <em class="calibre5">SalesB</em> are expanded tables, and the expansion occurred when there were two different relationships active. Because <em class="calibre5">RELATED</em> only gives access to an expanded column, the consequence is that when iterating over <em class="calibre5">SalesA</em>, <em class="calibre5">RELATED</em> returns the order year, whereas while iterating over <em class="calibre5">SalesB</em>, <em class="calibre5">RELATED</em> returns the delivery year.</p>
<p class="edition">We can appreciate the difference by looking at the result in <a href="#calibre_link-1216" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-5</a>. Without the expanded table, we would have expected the same number of rows for each order year in both columns.</p>
<figure id="calibre_link-1216" class="image-l">
<img src="images/000239.jpg" alt="In this figure we see different numbers in Sales From A and Sales From B for the same years." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 14-5</strong> The two calculations filter different years.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-227" class="calibre13">Using <em class="calibre5">RELATED</em> in calculated columns</h4>
<p class="edition">The <em class="calibre5">RELATED</em> function accesses the expanded columns of a table. The table expansion occurs when the table is defined, not when it is used. Because of these facts, changing the relationships in a calculated column turns out to be problematic.</p>
<p class="edition">As an example, look at the model in <a href="#calibre_link-1217" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-6</a>, with two relationships between <em class="calibre5">Sales</em> and <em class="calibre5">Date</em>.</p>
<figure id="calibre_link-1217" class="image-l">
<img src="images/000247.jpg" alt="This figure shows a data model with Sales and Date and two relationships linking them." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 14-6</strong> There are two relationships between <em class="calibre5">Sales</em> and <em class="calibre5">Date</em>, but only one can be active.</figcaption>
</figure>
<p class="edition">A developer might be interested in adding a calculated column in <em class="calibre5">Sales</em> that checks whether the delivery happened in the same quarter as the order. The <em class="calibre5">Date</em> table contains a column&mdash;<em class="calibre5">Date[Calendar Year Quarter]</em>&mdash;that can be used for the comparison. Unfortunately, it is easy to obtain the quarter of the order date, whereas retrieving the quarter of the delivery proves to be more challenging.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1805"></span>Indeed, <em class="calibre5">RELATED ( 'Date'[Calendar Year Quarter] )</em> returns the quarter of the order date by using the default active relationship. Nevertheless, writing an expression like the following will not change the relationship used for <em class="calibre5">RELATED</em>:</p>
<p class="codelink"><a href="#calibre_link-1218" id="calibre_link-2670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[DeliveryQuarter] =
CALCULATE (
    RELATED ( 'Date'[Calendar Year Quarter] ),
    USERELATIONSHIP (
        Sales[Delivery Date],
        'Date'[Date]
    )
)</pre></div>
<p class="edition">There are several problems here. The first is that <em class="calibre5">CALCULATE</em> removes the row context, but <em class="calibre5">CALCULATE</em> is needed to change the active relationship for <em class="calibre5">RELATED</em>. Thus, <em class="calibre5">RELATED</em> cannot be used inside the formula argument of <em class="calibre5">CALCULATE</em> because <em class="calibre5">RELATED</em> requires a row context. There is a second sneaky problem: Even if it were possible to do that, <em class="calibre5">RELATED</em> would not work because the row context of a calculated column is created when the table is defined. The row context of a calculated column is generated automatically, so the table is always expanded using the default relationship.</p>
<p class="edition">There is no perfect solution to this problem. The best option is to rely on <em class="calibre5">LOOKUPVALUE</em>. <em class="calibre5">LOOKUPVALUE</em> is a search function that retrieves a value from a table, searching for columns that are equal to certain values provided. The delivery quarter can be computed using the following code:</p>
<p class="codelink"><a href="#calibre_link-1219" id="calibre_link-2671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[DeliveryQuarter] =
LOOKUPVALUE (
    'Date'[Calendar Year Quarter],     -- Returns the Calendar Year quarter
    'Date'[Date],                      -- where the Date[Date] column is equal
    Sales[Delivery Date]               -- to the value of Sales[Delivery Date]
)</pre></div>
<p class="edition"><em class="calibre5">LOOKUPVALUE</em> searches for values that are equal. One cannot add more complex conditions. If needed, then a more complex expression using <em class="calibre5">CALCULATE</em> would be required. Moreover, in this case we used <em class="calibre5">LOOKUPVALUE</em> in a calculated column, so the filter context is empty. But even in cases where the filter context is actively filtering the model, <em class="calibre5">LOOKUPVALUE</em> would ignore it. <em class="calibre5">LOOKUPVALUE</em> always searches for a row in a table ignoring any filter context. Finally, <em class="calibre5">LOOKUPVALUE</em> accepts a last argument, if provided alone, that is the default value in case there is no match.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-228" class="h2a">Understanding the difference between table filters and column filters</h3>
<p class="edition">In DAX there is a huge difference between filtering a table and filtering a column. Table filters are powerful tools in the hands of an experienced DAX developer, but they can get quite confusing if used improperly. We will start by looking at a scenario where table filters produce an incorrect result. Later in this section, we will demonstrate how to leverage table filters properly in complex scenarios.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1790"></span>Often a novice DAX developer makes the mistake of thinking that the two following expressions compute the same value:</p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    Sales[Quantity] &gt; 1
)

CALCULATE (
    [Sales Amount],
    FILTER (
        Sales,
        Sales[Quantity] &gt; 1
    )
)</pre></div>
<p class="edition">The two definitions are actually very different. One is filtering a column; the other is filtering a table. Even though the two versions of the code provide the same result in several scenarios, they are, in fact, computing a completely different expression. To demonstrate their behavior, we included the two definitions in a query:</p>
<p class="codelink"><a href="#calibre_link-1220" id="calibre_link-2672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ADDCOLUMNS (
    VALUES ( 'Product'[Brand] ),
    "FilterCol", CALCULATE (
        [Sales Amount],
        Sales[Quantity] &gt; 1
    ),
    "FilterTab", CALCULATE (
        [Sales Amount],
        FILTER (
            Sales,
            Sales[Quantity] &gt; 1
        )
    )
)</pre></div>
<p class="edition">The result is surprising to say the least, as we can see in <a href="#calibre_link-1221" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-7</a>.</p>
<p class="edition"><em class="calibre5">FilterCol</em> returns the expected values, whereas <em class="calibre5">FilterTab</em> always returns the same number that corresponds to the grand total of all the brands. Expanded tables play an important role in understanding the reason for this result.</p>
<figure id="calibre_link-1221" class="image-l">
<img src="images/000255.jpg" alt="This figure shows FilterCol first and FilterTab second for each brand." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3144"></span><strong class="calibre7">Figure 14-7</strong> The first column computes the correct results, whereas the second column always shows a higher number corresponding to the grand total.</figcaption>
</figure>
<p class="edition">We can examine the behavior of the <em class="calibre5">FilterTab</em> calculation in detail. The filter argument of <em class="calibre5">CALCULATE</em> iterates over <em class="calibre5">Sales</em> and returns all the rows of <em class="calibre5">Sales</em> with a quantity greater than 1. The result of <em class="calibre5">FILTER</em> is a subset of rows of the <em class="calibre5">Sales</em> table. Remember: In DAX a table reference always references the expanded table. Because <em class="calibre5">Sales</em> has a relationship with <em class="calibre5">Product</em>, the expanded table of <em class="calibre5">Sales</em> contains the whole <em class="calibre5">Product</em> table too. Among the many columns, it also contains <em class="calibre5">Product[Brand]</em>.</p>
<p class="edition">The filter arguments of <em class="calibre5">CALCULATE</em> are evaluated in the original filter context, ignoring the context transition. The filter on <em class="calibre5">Brand</em> comes into effect after <em class="calibre5">CALCULATE</em> has performed the context transition. Consequently, the result of <em class="calibre5">FILTER</em> contains the values of all the brands related to rows with a quantity greater than 1. Indeed, there are no filters on <em class="calibre5">Product[Brand]</em> during the iteration made by <em class="calibre5">FILTER</em>.</p>
<p class="edition">When generating the new filter context, <em class="calibre5">CALCULATE</em> performs two consecutive steps:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">It operates the context transition.</p></li>
<li class="calibre25"><p class="listp">It applies the filter arguments.</p></li>
</ol>
<p class="edition">Therefore, filter arguments might override the effects of context transition. Because <em class="calibre5">ADDCOLUMNS</em> is iterating over the product brand, the effects of context transition on each row should be that of filtering an individual brand. Nevertheless, because the result of <em class="calibre5">FILTER</em> also contains the product brand, it overrides the effects of the context transition. The net result is that the value shown is always the total of <em class="calibre5">Sales Amount</em> for all the transactions whose quantity is greater than 1, regardless of the product brand.</p>
<p class="edition">Using table filters is always challenging because of table expansion. Whenever one applies a filter to a table, the filter is really applied to the expanded table, and this can cause several side effects. The golden rule is simple: Try to avoid using table filters whenever possible. Working with columns leads to simpler calculations, whereas working with tables is much more problematic.</p>
<span type="pagebreak" id="calibre_link-1791"></span><div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The example shown in this section might not be easily applied to a measure defined in a data model. This is because the measure is always executed in an implicit <em class="calibre5">CALCULATE</em> to produce the context transition. For example, consider the following measure:</p>
<div class="program"><pre class="calibre14">Multiple Sales :=
CALCULATE (
    [Sales Amount],
    FILTER (
        Sales,
        Sales[Quantity] &gt; 1
    )
)</pre></div>
<p class="edition">When executed in a report, a possible DAX query could be:</p>
<p class="codelink"><a href="#calibre_link-1222" id="calibre_link-2673" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ADDCOLUMNS (
    VALUES ( 'Product'[Brand] ),
    "FilterTabMeasure", [Multiple Sales]
)</pre></div>
<p class="edition">The expansion of the table drives the execution of this corresponding query:</p>
<p class="codelink"><a href="#calibre_link-1223" id="calibre_link-2674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ADDCOLUMNS (
    VALUES ( 'Product'[Brand] ),
    "FilterTabMeasure", CALCULATE (
        CALCULATE (
            [Sales Amount],
            FILTER (
                Sales,
                Sales[Quantity] &gt; 1
            )
        )
    )
)</pre></div>
<p class="edition">The first <em class="calibre5">CALCULATE</em> performs the context transition that affects both arguments of the second <em class="calibre5">CALCULATE</em>, including the <em class="calibre5">FILTER</em> argument. Even though this produces the same result as <em class="calibre5">FilterCol</em>, the use of a table filter has a negative impact on performance. Therefore, it is always better to use column filters whenever possible.</p>
</div>
<section class="calibre4">
<h4 id="calibre_link-229" class="calibre13">Using table filters in measures</h4>
<p class="edition">In the previous section, we showed a first example where being familiar with expanded tables helped make sense of a result. However, there are several other scenarios where expanded tables prove to be useful. Besides, in previous chapters we used the concept of expanded tables multiple times, although we could not describe what was happening in detail just yet.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3145"></span>For example in <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>, “<a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em></a>,” while explaining how to remove all the filters applied to the model, we used the following code in a report that was slicing measures by category:</p>
<p class="codelink"><a href="#calibre_link-1224" id="calibre_link-2675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Pct All Sales :=
VAR CurrentCategorySales =
    [Sales Amount]
VAR AllSales =
    CALCULATE (
        [Sales Amount],
        <strong class="calibre7">ALL ( Sales )</strong>
    )
VAR Result =
    DIVIDE (
        CurrentCategorySales,
        AllSales
    )
RETURN
    Result</pre></div>
<p class="edition">Why does <em class="calibre5">ALL ( Sales )</em> remove any filter? If one does not think in terms of expanded tables, <em class="calibre5">ALL</em> should only remove filters from the <em class="calibre5">Sales</em> table, keeping any other filter untouched. In fact, using <em class="calibre5">ALL</em> on the <em class="calibre5">Sales</em> table means removing any filter from the expanded <em class="calibre5">Sales</em> table. Because <em class="calibre5">Sales</em> expands to all the related tables, including <em class="calibre5">Product</em>, <em class="calibre5">Customer</em>, <em class="calibre5">Date</em>, <em class="calibre5">Store</em>, and any other related tables, using <em class="calibre5">ALL ( Sales )</em> removes any filter from the entire data model used by that example.</p>
<p class="edition">Most of the time this behavior is the one desired and it works intuitively. Still, understanding the internal behavior of expanded tables is of paramount importance; failing to gain that understanding might be a root cause for inaccurate calculations. In the next example, we demonstrate how a simple calculation can fail simply due to a subtlety of expanded tables. We will see why it is better to avoid using table filters in <em class="calibre5">CALCULATE</em> statements, unless the developer is purposely looking to take advantage of the side effects of expanded tables. The latter are described in the following sections.</p>
<p class="edition">Consider the requirements of a report like the one in <a href="#calibre_link-1225" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-8</a>. The report contains a slicer that filters the <em class="calibre5">Category</em>, and a matrix showing the sales of subcategories and their respective percentage against the total.</p>
<figure id="calibre_link-1225" class="image-l">
<img src="images/000264.jpg" alt="In this report we see the slicer, and the matrix containing Sales amount and Pct per subcategory." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 14-8</strong> The <em class="calibre5">Pct</em> column shows the percentage of a subcategory against the total sales.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3146"></span>Because the percentage needs to divide the current <em class="calibre5">Sales Amount</em> by the corresponding <em class="calibre5">Sales Amount</em> for all the subcategories of the selected category, a first (inaccurate) solution might be the following:</p>
<p class="codelink"><a href="#calibre_link-1226" id="calibre_link-2676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Pct :=
DIVIDE (
    [Sales Amount],
    CALCULATE (
        [Sales Amount],
        <strong class="calibre7">ALL ( 'Product Subcategory' )</strong>
    )
)</pre></div>
<p class="edition">The idea is that by removing the filter on <em class="calibre5">Product Subcategory</em>, DAX retains the filter on <em class="calibre5">Category</em> and produces the correct result. However, the result is wrong, as we can see in <a href="#calibre_link-1227" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-9</a>.</p>
<figure id="calibre_link-1227" class="image-l">
<img src="images/000271.jpg" alt="In this figure, the values in Pct add up to 22.04 instead of 100." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 14-9</strong> The first implementation of <em class="calibre5">Pct</em> produces the wrong result.</figcaption>
</figure>
<p class="edition">The problem with this formula is that <em class="calibre5">ALL ( 'Product Subcategory' )</em> refers to the expanded <em class="calibre5">Product Subcategory</em> table. <em class="calibre5">Product Subcategory</em> expands to <em class="calibre5">Product Category</em>. Consequently, <em class="calibre5">ALL</em> removes the filter not only from the <em class="calibre5">Product Subcategory</em> table, but also from the <em class="calibre5">Product Category</em> table. Therefore, the denominator returns the grand total of all the categories, in turn calculating the wrong percentage.</p>
<p class="edition">There are multiple solutions available. In the current report, they all compute the same value, even though they use slightly different approaches. For example, the following <em class="calibre5">Pct Of Categories</em> measure computes the percentage of the selected subcategories compared to the total of the related categories. After removing the filter from the expanded table of <em class="calibre5">Product Subcategory</em>, <em class="calibre5">VALUES</em> restores the filter of the <em class="calibre5">Product Category</em> table:</p>
<p class="codelink"><a href="#calibre_link-1228" id="calibre_link-2677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Pct Of Categories :=
DIVIDE (
    [Sales Amount],
    CALCULATE (
        [Sales Amount],
        <strong class="calibre7">ALL ( 'Product Subcategory' ),</strong>
        <strong class="calibre7">VALUES ( 'Product Category' )</strong>
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1646"></span>Another possible solution is the <em class="calibre5">Pct Of Visual Total</em> measure, which uses <em class="calibre5">ALLSELECTED</em> without an argument. <em class="calibre5">ALLSELECTED</em> restores the filter context of the slicers outside the visual, without the developer having to worry about expanded tables:</p>
<div class="program"><pre class="calibre14">Pct Of Visual Total :=
DIVIDE (
    [Sales Amount],
    CALCULATE (
        [Sales Amount],
        <strong class="calibre7">ALLSELECTED ()</strong>
    )
)</pre></div>
<p class="edition"><em class="calibre5">ALLSELECTED</em> is attractive because of its simplicity. However, in a later section of this chapter we introduce shadow filter contexts. These will provide the reader with a fuller understanding of <em class="calibre5">ALLSELECTED</em>. <em class="calibre5">ALLSELECTED</em> can be powerful, but it is also a complex function that must be used carefully in convoluted expressions.</p>
<p class="edition">Finally, another solution is available using <em class="calibre5">ALLEXCEPT</em>, thus comparing the selected subcategories with the categories selected in the slicer:</p>
<p class="codelink"><a href="#calibre_link-1229" id="calibre_link-2678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Pct :=
DIVIDE (
    [Sales Amount],
    CALCULATE (
        [Sales Amount],
        <strong class="calibre7">ALLEXCEPT ( 'Product Subcategory', 'Product Category' )</strong>
    )
)</pre></div>
<p class="edition">This last formula leverages a particular <em class="calibre5">ALLEXCEPT</em> syntax that we have never used so far in the book: <em class="calibre5">ALLEXCEPT</em> with two tables, instead of a table and a list of columns.</p>
<p class="edition"><em class="calibre5">ALLEXCEPT</em> removes filters from the source table, with the exception of any columns provided as further arguments. That list of columns can include any column (or table) belonging to the expanded table of the first argument. Because the expanded table of <em class="calibre5">Product Subcategory</em> contains the whole <em class="calibre5">Product Category</em> table, the code provided is a valid syntax. It removes any filter from the whole expanded table of <em class="calibre5">Product Subcategory</em>, except for the columns of the expanded table of <em class="calibre5">Product Category</em>.</p>
<p class="edition">It is worth noting that expanded tables tend to cause more issues when the data model is not correctly denormalized. As a matter of fact, in most of this book we use a version of Contoso where <em class="calibre5">Category</em> and <em class="calibre5">Subcategory</em> are stored as columns in the <em class="calibre5">Product</em> table, instead of being tables by themselves. In other words, we denormalized the category and subcategory tables as attributes of the <em class="calibre5">Product</em> table. In a correctly denormalized model, table expansion takes place between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em> in a more natural way. So as it often happens, putting some thought into the model makes the DAX code easier to author.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-230" class="calibre13"><span type="pagebreak" id="calibre_link-1644"></span>Understanding active relationships</h4>
<p class="edition">When working with expanded tables, another important aspect to consider is the concept of active relationships. It is easy to get confused in a model with multiple relationships. In this section, we want to share an example where the presence of multiple relationships proves to be a real challenge.</p>
<p class="edition">Imagine needing to compute <em class="calibre5">Sales Amount</em> and <em class="calibre5">Delivered Amount</em>. These two measures can be computed by activating the correct relationship with <em class="calibre5">USERELATIONSHIP</em>. The following two measures work:</p>
<p class="codelink"><a href="#calibre_link-1230" id="calibre_link-2679" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
SUMX (
    Sales,
    Sales[Quantity] * Sales[Net Price]
)

Delivered Amount :=
CALCULATE (
    [Sales Amount],
    USERELATIONSHIP ( Sales[Delivery Date], 'Date'[Date] )
)</pre></div>
<p class="edition">The result is visible in <a href="#calibre_link-1231" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-10</a>.</p>
<figure id="calibre_link-1231" class="image-l">
<img src="images/000279.jpg" alt="The figure shows Sales Amount and Delivered Amount per calendar year, with totals." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 14-10</strong> <em class="calibre5">Sales Amount</em> and <em class="calibre5">Delivered Amount</em> use different relationships.</figcaption>
</figure>
<p class="edition">It is interesting to see a variation of the <em class="calibre5">Delivered Amount</em> measure that does not work because it uses a table filter:</p>
<p class="codelink"><a href="#calibre_link-1232" id="calibre_link-2680" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Delivered Amount =
CALCULATE (
    [Sales Amount],
    <strong class="calibre7">CALCULATETABLE (</strong>
        <strong class="calibre7">Sales,</strong>
        <strong class="calibre7">USERELATIONSHIP ( Sales[Delivery Date], 'Date'[Date] )</strong>
    <strong class="calibre7">)</strong>
)</pre></div>
<p class="edition">This new&mdash;and unfortunate&mdash;formulation of the measure produces a blank result, as we can see in <a href="#calibre_link-1233" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-11</a>.</p>
<figure id="calibre_link-1233" class="image-l">
<img src="images/000287.jpg" alt="The figure only displays blanks for the Delivered Amount column. Other amounts stay unchanged." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3147"></span><strong class="calibre7">Figure 14-11</strong> Using a table filter, <em class="calibre5">Delivered Amount</em> only produces a blank value.</figcaption>
</figure>
<p class="edition">We now investigate why the result is a blank. This requires paying a lot of attention to expanded tables. The result of <em class="calibre5">CALCULATETABLE</em> is the expanded version of <em class="calibre5">Sales</em>, and among other tables it contains the <em class="calibre5">Date</em> table. When <em class="calibre5">Sales</em> is evaluated by <em class="calibre5">CALCULATETABLE</em>, the active relationship is the one with <em class="calibre5">Sales[Delivery Date]</em>. <em class="calibre5">CALCULATETABLE</em> therefore returns all the sales delivered in a given year, as an expanded table.</p>
<p class="edition">When <em class="calibre5">CALCULATETABLE</em> is used as a filter argument by the outer <em class="calibre5">CALCULATE</em>, the result of <em class="calibre5">CALCULATETABLE</em> filters <em class="calibre5">Sales</em> and <em class="calibre5">Date</em> through the <em class="calibre5">Sales</em> expanded table, which uses the relationship between <em class="calibre5">Sales[Delivery Date]</em> and <em class="calibre5">Date[Date]</em>. Nevertheless, once <em class="calibre5">CALCULATETABLE</em> ends its execution, the default relationship between <em class="calibre5">Sales[Order Date]</em> and <em class="calibre5">Date[Date]</em> becomes the active relationship again. Therefore, the dates being filtered are now the order dates, not the delivery dates any more. In other words, a table containing delivery dates is used to filter order dates. At this point, the only rows that remain visible are the ones where <em class="calibre5">Sales[Order Date]</em> equals <em class="calibre5">Sales[Delivery Date]</em>. There are no rows in the model that satisfy this condition; consequently, the result is blank.</p>
<p class="edition">To further clarify the concept, imagine that the <em class="calibre5">Sales</em> table contains just a few rows, like the ones in <a href="#calibre_link-1234" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 14-2</a>.</p>
<p class="edition" id="calibre_link-1234"><strong class="calibre7">Table 14-2</strong> Example of <em class="calibre5">Sales</em> table with only two rows</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Order Date</p></th>
<th class="th"><p class="tab-text">Delivery Date</p></th>
<th class="th"><p class="tab-text">Quantity</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">12/31/2007</p></td>
<td class="th1"><p class="tab-text">01/07/2008</p></td>
<td class="th1"><p class="tab-text">100</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">01/05/2008</p></td>
<td class="th1"><p class="tab-text">01/10/2008</p></td>
<td class="th1"><p class="tab-text">200</p></td>
</tr>
</tbody>
</table>
<p class="edition">If the year 2008 is selected, the inner <em class="calibre5">CALCULATETABLE</em> returns the expanded version of <em class="calibre5">Sales</em>, containing, among many others, the columns shown in <a href="#calibre_link-1235" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 14-3</a>.</p>
<p class="edition" id="calibre_link-1235"><strong class="calibre7">Table 14-3</strong> The result of <em class="calibre5">CALCULATETABLE</em> is the expanded <em class="calibre5">Sales</em> table, including <em class="calibre5">Date[Date]</em> using the <em class="calibre5">Sales[Delivery Date]</em> relationship</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Order Date</p></th>
<th class="th"><p class="tab-text">Delivery Date</p></th>
<th class="th"><p class="tab-text">Quantity</p></th>
<th class="th"><p class="tab-text">Date</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">12/31/2007</p></td>
<td class="th1"><p class="tab-text">01/07/2008</p></td>
<td class="th1"><p class="tab-text">100</p></td>
<td class="th1"><p class="tab-text">01/07/2008</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">01/05/2008</p></td>
<td class="th1"><p class="tab-text">01/10/2008</p></td>
<td class="th1"><p class="tab-text">200</p></td>
<td class="th1"><p class="tab-text">01/10/2008</p></td>
</tr>
</tbody>
</table>
<p class="edition"><span type="pagebreak" id="calibre_link-1645"></span>When this table is used as a filter, the <em class="calibre5">Date[Date]</em> column uses the active relationship, which is the one between <em class="calibre5">Date[Date]</em> and <em class="calibre5">Sales[Order Date]</em>. At this point, the expanded table of <em class="calibre5">Sales</em> appears as in <a href="#calibre_link-1236" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 14-4</a>.</p>
<p class="edition" id="calibre_link-1236"><strong class="calibre7">Table 14-4</strong> The expanded <em class="calibre5">Sales</em> table using the default active relationship using the <em class="calibre5">Sales[Order Date]</em> column</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Order Date</p></th>
<th class="th"><p class="tab-text">Delivery Date</p></th>
<th class="th"><p class="tab-text">Quantity</p></th>
<th class="th"><p class="tab-text">Date</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">12/31/2007</p></td>
<td class="th1"><p class="tab-text">01/07/2008</p></td>
<td class="th1"><p class="tab-text">100</p></td>
<td class="th1"><p class="tab-text">12/31/2007</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">01/05/2008</p></td>
<td class="th1"><p class="tab-text">01/10/2008</p></td>
<td class="th1"><p class="tab-text">200</p></td>
<td class="th1"><p class="tab-text">01/05/2008</p></td>
</tr>
</tbody>
</table>
<p class="edition">The rows visible in <a href="#calibre_link-1235" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 14-3</a> try to filter the rows visible in <a href="#calibre_link-1236" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 14-4</a>. However, the <em class="calibre5">Date</em> column is always different in the two tables, for each corresponding row. Because they do not have the same value, the first row will be removed from the active set of rows. Following the same reasoning, the second row is excluded too.</p>
<p class="edition">At the end, only the rows where <em class="calibre5">Sales[Order Date]</em> equals <em class="calibre5">Sales[Delivery Date]</em> survive the filter; they produce the same value in the <em class="calibre5">Date[Date]</em> column of the two expanded tables generated for the different relationships. This time, the complex filtering effect comes from the active relationship. Changing the active relationship inside a <em class="calibre5">CALCULATE</em> statement only affects the computation inside <em class="calibre5">CALCULATE</em>, but when the result is used outside of <em class="calibre5">CALCULATE</em>, the relationship goes back to the default.</p>
<p class="edition">As usual, it is worth pointing out that this behavior is the correct one. It is complex, but it is correct. There are good reasons to avoid table filters as much as possible. Using table filters might result in the correct behavior, or it might turn into an extremely complex and unpredictable scenario. Moreover, the measure with a column filter instead of a table filter works fine and it is easier to read.</p>
<p class="edition">The golden rule with table filters is to avoid them. The price to pay for developers who do not follow this simple suggestion is twofold: A significant amount of time will be spent understanding the filtering behavior, and performance becomes the worst it could possibly be.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-231" class="calibre13">Difference between table expansion and filtering</h4>
<p class="edition">As explained earlier, table expansion solely takes place from the many-side to the one-side of a relationship. Consider the model in <a href="#calibre_link-1237" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-12</a>, where we enabled bidirectional filtering in all the relationships of the data model.</p>
<figure id="calibre_link-1237" class="image-l">
<img src="images/000296.jpg" alt="This figure shows a data model with relationships between the tables." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1905"></span><strong class="calibre7">Figure 14-12</strong> All the relationships in this model are set with bidirectional cross-filter.</figcaption>
</figure>
<p class="edition">Though the relationship between <em class="calibre5">Product</em> and <em class="calibre5">Product Subcategory</em> is set with bidirectional filtering, the expanded <em class="calibre5">Product</em> table contains subcategories, whereas the expanded <em class="calibre5">Product Subcategory</em> table does not contain <em class="calibre5">Product</em>.</p>
<p class="edition">The DAX engine injects filtering code in the expressions to make bidirectional filtering work as if the expansion went both ways. A similar behavior happens when using the <em class="calibre5">CROSSFILTER</em> function. Therefore, in most cases a measure works just as if table expansion took place in both directions. However, be mindful that table expansion actually does not go in the many-side direction.</p>
<p class="edition">The difference becomes important with the use of <em class="calibre5">SUMMARIZE</em> or <em class="calibre5">RELATED</em>. If a developer uses <em class="calibre5">SUMMARIZE</em> to perform a grouping of a table based on another table, they have to use one of the columns of the expanded table. For example, the following <em class="calibre5">SUMMARIZE</em> statement works well:</p>
<p class="codelink"><a href="#calibre_link-1238" id="calibre_link-2681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZE (
    'Product',
    'Product Subcategory'[Subcategory]
)</pre></div>
<p class="edition">Whereas the next one&mdash;which tries to summarize subcategories based on product color&mdash;does not work:</p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZE (
    'Product Subcategory',
    'Product'[Color]
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1702"></span>The error is “The column ‘<em class="calibre5">Color</em>’ specified in the ‘<em class="calibre5">SUMMARIZE</em>’ function was not found in the input table,” meaning that the expanded version of <em class="calibre5">Product Subcategory</em> does not contain <em class="calibre5">Product[Color]</em>. Like <em class="calibre5">SUMMARIZE</em>, <em class="calibre5">RELATED</em> also works with columns that belong to the expanded table exclusively.</p>
<p class="edition">Similarly, one cannot group the <em class="calibre5">Date</em> table by using columns from other tables, even when these tables are linked by a chain of bidirectional relationships:</p>
<p class="codelink"><a href="#calibre_link-1239" id="calibre_link-2682" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZE ( 'Date', 'Product'[Color] )</pre></div>
<p class="edition">There is only one special case where table expansion goes in both directions, which is the case of a relationship defined as one-to-one. If a relationship is a one-to-one relationship, then both tables are expanded one into the other. This is because a one-to-one relationship makes the two tables semantically identical: Each row in one table has a direct relationship with a single row in the other table. Therefore, it is fair to think of the two tables as being one, split into two sets of columns.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-232" class="calibre13">Context transition in expanded tables</h4>
<p class="edition">The expanded table also influences context transition. The row context converts into an equivalent filter context for all the columns that are part of the expanded table. For example, consider the following query returning the category of a product using two techniques: the <em class="calibre5">RELATED</em> function in a row context and the <em class="calibre5">SELECTEDVALUE</em> function with a context transition:</p>
<p class="codelink"><a href="#calibre_link-1240" id="calibre_link-2683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SELECTCOLUMNS (
    'Product',
    "Product Key", 'Product'[ProductKey],
    "Product Name", 'Product'[Product Name],
    "Category RELATED", RELATED ( 'Product Category'[Category] ),
    "Category Context Transition", CALCULATE (
        SELECTEDVALUE ( 'Product Category'[Category] )
    )
)
ORDER BY [Product Key]</pre></div>
<p class="edition">The result of the query includes two identical columns, <em class="calibre5">Category RELATED</em> and <em class="calibre5">Category Context Transition</em>, as shown in <a href="#calibre_link-1241" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-13</a>.</p>
<figure id="calibre_link-1241" class="image-l">
<img src="images/000304.jpg" alt="This report shows categories for a few product names. Category RELATED and Category Context Transition return the same categories." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 14-13</strong> The category of each product is displayed in two columns computed with different techniques.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">Category RELATED</em> column shows the category corresponding to the product displayed on the same line of the report. This value is retrieved by using <em class="calibre5">RELATED</em> when the row context on <em class="calibre5">Product</em> is <span type="pagebreak" id="calibre_link-3148"></span>available. The <em class="calibre5">Category Context Transition</em> column uses a different approach, generating a context transition by invoking <em class="calibre5">CALCULATE</em>. The context transition filters just one row in the <em class="calibre5">Product</em> table; this filter is also applied to <em class="calibre5">Product Subcategory</em> and <em class="calibre5">Product Category</em>, filtering the corresponding rows for the product. Because at this point the filter context only filters one row in <em class="calibre5">Product Category</em>, <em class="calibre5">SELECTEDVALUE</em> returns the value of the <em class="calibre5">Product Category</em> column in the only row filtered in the <em class="calibre5">Product Category</em> table.</p>
<p class="edition">While this side effect is well known, it is not efficient to rely on this behavior when wanting to retrieve a value from a related table. Even though the result is identical, performance could be very different. The solution using a context transition is particularly expensive if used for many rows in <em class="calibre5">Product</em>. Context transition comes at a significant computational cost. Thus, as we will see later in the book, reducing the number of context transitions is important in order to improve performance. Therefore, <em class="calibre5">RELATED</em> is a better solution to this specific problem; it avoids the context transition required for <em class="calibre5">SELECTEDVALUE</em> to work.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-233" class="h2a">Understanding <em class="calibre5">ALLSELECTED</em> and shadow filter contexts</h3>
<p class="edition"><em class="calibre5">ALLSELECTED</em> is a handy function that hides a giant trap. In our opinion, <em class="calibre5">ALLSELECTED</em> is the most complex function in the whole DAX language, even though it looks harmless. In this section we provide an exhaustive technical description of the <em class="calibre5">ALLSELECTED</em> internals, along with a few suggestions on when to use and when not to use <em class="calibre5">ALLSELECTED</em>.</p>
<p class="edition"><em class="calibre5">ALLSELECTED</em>, as any other <em class="calibre5">ALL*</em> function, can be used in two different ways: as a table function or as a <em class="calibre5">CALCULATE</em> modifier. Its behavior differs in these two scenarios. Moreover, <em class="calibre5">ALLSELECTED</em> is the only DAX function that leverages <em class="calibre5">shadow filter contexts</em>. In this section, we first examine the behavior of <em class="calibre5">ALLSELECTED</em>, then we introduce shadow filter contexts, and finally we provide a few tips on using <em class="calibre5">ALLSELECTED</em> optimally.</p>
<p class="edition"><em class="calibre5">ALLSELECTED</em> can be used quite intuitively. For example, consider the requirements for the report in <a href="#calibre_link-1242" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-14</a>.</p>
<figure id="calibre_link-1242" class="image-l">
<img src="images/000312.jpg" alt="The figure shows Sales Amount and Pct per brand, with a slicer on brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 14-14</strong> The report shows the sales amount of a few selected brands, along with their percentages.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1703"></span>The report uses a slicer to filter certain brands. It shows the sales amount of each brand, along with the percentage of each given brand over the total of all selected brands. The percentage formula is simple:</p>
<p class="codelink"><a href="#calibre_link-1243" id="calibre_link-2684" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Pct :=
DIVIDE (
    [Sales Amount],
    CALCULATE (
        [Sales Amount],
        ALLSELECTED ( 'Product'[Brand] )
    )
)</pre></div>
<p class="edition">Intuitively, our reader likely knows that <em class="calibre5">ALLSELECTED</em> returns the values of the brands selected outside of the current visual&mdash;that is, the brands selected between Adventure Works and Proseware. But what Power BI sends to the DAX engine is a single DAX query that does not have any concept of “current visual.”</p>
<p class="edition">How does DAX know about what is selected in the slicer and what is selected in the matrix? The answer is that it does not know these. <em class="calibre5">ALLSELECTED</em> does not return the values of a column (or table) filtered outside a visual. What it does is a totally different task, which as a side effect returns the same result most of the time. The correct definition of <em class="calibre5">ALLSELECTED</em> consists of the two following statements:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">When used as a table function, <em class="calibre5">ALLSELECTED</em> returns the set of values as visible in the last shadow filter context.</p></li>
<li class="calibre10"><p class="listp">When used as a <em class="calibre5">CALCULATE</em> modifier, <em class="calibre5">ALLSELECTED</em> restores the last shadow filter context on its parameter.</p></li>
</ul>
<p class="edition">These last two sentences deserve a much longer explanation.</p>
<section class="calibre4">
<h4 id="calibre_link-234" class="calibre13">Introducing shadow filter contexts</h4>
<p class="edition">In order to introduce shadow filter contexts, it is useful to look at the query that is executed by Power BI to produce the result shown in <a href="#calibre_link-1242" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-14</a>:</p>
<p class="codelink"><a href="#calibre_link-1244" id="calibre_link-2685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    VAR __DS0FilterTable =
        TREATAS (
            {
                "Adventure Works",
                "Contoso",
                "Fabrikam",
                "Litware",
                "Northwind Traders",
                "Proseware"
            },
            'Product'[Brand]
        )
<span type="pagebreak" id="calibre_link-3149"></span>EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL (
            'Product'[Brand],
            "IsGrandTotalRowTotal"
        ),
        __DS0FilterTable,
        "Sales_Amount", 'Sales'[Sales Amount],
        "Pct", 'Sales'[Pct]
    ),
    [IsGrandTotalRowTotal], 0,
    'Product'[Brand], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Product'[Brand]</pre></div>
<p class="edition">The query is a bit too complex to analyze&mdash;not because of its inherent complexity but because it is generated by an engine and is thus not designed to be human-readable. The following is a version of the formula that is close enough to the original, but easier to understand and describe:</p>
<p class="codelink"><a href="#calibre_link-1245" id="calibre_link-2686" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR Brands =
    FILTER (
        ALL ( 'Product'[Brand] ),
        'Product'[Brand]
            IN {
                "Adventure Works",
                "Contoso",
                "Fabrikam",
                "Litware",
                "Northwind Traders",
                "Proseware"
            }
    )
RETURN
    CALCULATETABLE (
        ADDCOLUMNS (
            VALUES ( 'Product'[Brand] ),
            "Sales_Amount", [Sales Amount],
            "Pct", [Pct]
        ),
        Brands
    )</pre></div>
<p class="edition">The result of this latter query is nearly the same as the report we examined earlier, with the noticeable difference that it is missing the total. We see this in <a href="#calibre_link-1246" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-15</a>.</p>
<figure id="calibre_link-1246" class="image-l">
<img src="images/000320.jpg" alt="In this figure we see Sales Amount and Pct per brand, without the totals row." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1706"></span><strong class="calibre7">Figure 14-15</strong> The query provides almost the same result as the prior report. The only missing part is the total.</figcaption>
</figure>
<p class="edition">Here are some useful notes about the query:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The outer <em class="calibre5">CALCULATETABLE</em> creates a filter context containing six brands.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">ADDCOLUMNS</em> iterates over the six brands visible inside the <em class="calibre5">CALCULATETABLE</em>.</p></li>
<li class="calibre10"><p class="listp">Both <em class="calibre5">Sales Amount</em> and <em class="calibre5">Pct</em> are measures executed inside an iteration. Therefore, a context transition is taking place before the execution of both measures, and the filter context of each of the two measures only contains the currently iterated brand.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Sales Amount</em> does not change the filter context, whereas <em class="calibre5">Pct</em> uses <em class="calibre5">ALLSELECTED</em> to modify the filter context.</p></li>
<li class="calibre10"><p class="listp">After <em class="calibre5">ALLSELECTED</em> modifies the filter context inside <em class="calibre5">Pct</em>, the updated filter context shows all six brands instead of the currently iterated brand.</p></li>
</ul>
<p class="edition">The last point is the most helpful point in order to understand what a shadow filter context is and how DAX uses it in <em class="calibre5">ALLSELECTED</em>. Indeed, the key is that <em class="calibre5">ADDCOLUMNS</em> iterates over six brands, the context transition makes only one of them visible, and <em class="calibre5">ALLSELECTED</em> needs a way to restore a filter context containing the six iterated brands.</p>
<p class="edition">Here is a more detailed description of the query execution, where we introduce shadow filter contexts in step 3:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">The outer <em class="calibre5">CALCULATETABLE</em> creates a filter context with six brands.</p></li>
<li class="calibre25"><p class="listp"><em class="calibre5">VALUES</em> returns the six visible brands and returns the result to <em class="calibre5">ADDCOLUMNS</em>.</p></li>
<li class="calibre25"><p class="listp">Being an iterator, <em class="calibre5">ADDCOLUMNS</em> creates a <em class="calibre5">shadow filter context</em> containing the result of <em class="calibre5">VALUES</em>, right before starting the iteration.</p>
<ul class="bull">
<li class="calibre25"><p class="listp">The shadow filter context is like a filter context, but it remains dormant, not affecting the evaluation in any way.</p></li>
<li class="calibre25"><p class="listp">A shadow filter context can only be activated by <em class="calibre5">ALLSELECTED</em>, as we are about to explain. For now, just remember that the shadow filter context contains the six iterated brands.</p></li>
<li class="calibre25"><p class="listp">We distinguish between a shadow filter context and a regular filter context by calling the latter an <em class="calibre5">explicit filter context</em>.</p></li>
</ul></li>
<li class="calibre25"><p class="listp"><span type="pagebreak" id="calibre_link-1705"></span>During the iteration, the context transition occurs on one given row. Therefore, the context transition creates a new explicit filter context containing solely the iterated brand.</p></li>
<li class="calibre25"><p class="listp">When <em class="calibre5">ALLSELECTED</em> is invoked during the evaluation of the <em class="calibre5">Pct</em> measure, <em class="calibre5">ALLSELECTED</em> does the following: <strong class="calibre7"><em class="calibre5">ALLSELECTED</em> restores the last shadow filter context on the column or table passed as parameter, or on all the columns if <em class="calibre5">ALLSELECTED</em> has no arguments</strong>. (The behavior of <em class="calibre5">ALLSELECTED</em> without parameters is explained in the following section.)</p>
<ul class="bull">
<li class="calibre25"><p class="listp">Because the last shadow filter context contained six brands, the selected brands become visible again.</p></li>
</ul></li>
</ol>
<p class="edition">This simple example allowed us to introduce the concept of shadow filter context. The previous query shows how <em class="calibre5">ALLSELECTED</em> takes advantage of shadow filter contexts to retrieve the filter context outside of the current visual. Please note that the description of the execution does not use the Power BI visuals anywhere. Indeed, the DAX engine is not cognizant of which visual it is helping to produce. All it receives is a DAX query.</p>
<p class="edition">Most of the time <em class="calibre5">ALLSELECTED</em> retrieves the correct filter context; indeed, all the visuals in Power BI and, in general, most of the visuals generated by any client tool all generate the same kind of query. Those auto-generated queries always include a top-level iterator that generates a shadow filter context on the items it is displaying. This is the reason why <em class="calibre5">ALLSELECTED</em> seems to restore the filter context outside of the visual.</p>
<p class="edition">Having taken our readers one step further in their understanding of <em class="calibre5">ALLSELECTED</em>, we now need to examine more closely the conditions required for <em class="calibre5">ALLSELECTED</em> to work properly:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The query needs to contain an iterator. If there is no iterator, then no shadow filter context is present, and <em class="calibre5">ALLSELECTED</em> does not perform any operation.</p></li>
<li class="calibre10"><p class="listp">If there are multiple iterators before <em class="calibre5">ALLSELECTED</em> is executed, then <em class="calibre5">ALLSELECTED</em> restores the last shadow filter context. In other words, nesting <em class="calibre5">ALLSELECTED</em> inside an iteration in a measure will most likely produce unwanted results because the measure is almost always executed in another iteration of the DAX query produced by a client tool.</p></li>
<li class="calibre10"><p class="listp">If the columns passed to <em class="calibre5">ALLSELECTED</em> are not filtered by a shadow filter context, then <em class="calibre5">ALLSELECTED</em> does not do anything.</p></li>
</ul>
<p class="edition">At this point, our readers can see more clearly that the behavior of <em class="calibre5">ALLSELECTED</em> is quite complex. Developers predominantly use <em class="calibre5">ALLSELECTED</em> to retrieve the outer filter context of a visualization. We also used <em class="calibre5">ALLSELECTED</em> previously in the book for the very same purpose. In doing so, we always double-checked that <em class="calibre5">ALLSELECTED</em> was used in the correct environment, even though we did not explain in detail what was happening.</p>
<p class="edition">The fuller semantics of <em class="calibre5">ALLSELECTED</em> are related to shadow filter contexts, and merely by chance (or, to be honest, by careful and masterful design) does its effect entail the retrieving of the filter context outside of the current visual.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-2049"></span>A good developer knows exactly what <em class="calibre5">ALLSELECTED</em> does and only uses it in the scenarios where <em class="calibre5">ALLSELECTED</em> works the right way. Overusing <em class="calibre5">ALLSELECTED</em> by relying on it in conditions where it is not expected to work can only produce unwanted results, at which point the developer is to blame, not <em class="calibre5">ALLSELECTED</em>....</p>
<p class="edition">The golden rule for <em class="calibre5">ALLSELECTED</em> is quite simple: <strong class="calibre7"><em class="calibre5">ALLSELECTED can be used to retrieve the outer filter context if and only if it is being used in a measure that is directly projected in a matrix or in a visual</em></strong>. By no means should the developer expect to obtain correct results by using a measure containing <em class="calibre5">ALLSELECTED</em> inside an iteration, as we are going to demonstrate in the following sections. Because of this, we, as DAX developers, use a simple rule: If a measure contains <em class="calibre5">ALLSELECTED</em> anywhere in the code, then that measure cannot be called by any other measure. This is to avoid the risk that in the chain of measure calls, a developer could start an iteration that includes a call to a measure containing <em class="calibre5">ALLSELECTED</em>.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-235" class="calibre13"><em class="calibre5">ALLSELECTED</em> returns the iterated rows</h4>
<p class="edition">To further demonstrate the behavior of <em class="calibre5">ALLSELECTED</em>, we make a small change to the previous query. Instead of iterating over <em class="calibre5">VALUES ( Product[Brand] )</em>, we make <em class="calibre5">ADDCOLUMNS</em> iterate over <em class="calibre5">ALL ( Product[Brand] )</em>:</p>
<p class="codelink"><a href="#calibre_link-1247" id="calibre_link-2687" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR Brands =
    FILTER (
        ALL ( 'Product'[Brand] ),
        'Product'[Brand]
            IN {
                "Adventure Works",
                "Contoso",
                "Fabrikam",
                "Litware",
                "Northwind Traders",
                "Proseware"
            }
    )
RETURN
    CALCULATETABLE (
        ADDCOLUMNS (
            <strong class="calibre7">ALL ( 'Product'[Brand] ),</strong>
            "Sales_Amount", [Sales Amount],
            "Pct", [Pct]
        ),
        Brands
    )</pre></div>
<p class="edition">In this new scenario, the shadow filter context created by <em class="calibre5">ADDCOLUMNS</em> before the iteration contains all the brands&mdash;not simply the selected brands. Therefore, when called in the <em class="calibre5">Pct</em> measure, <em class="calibre5">ALLSELECTED</em> restores the shadow filter context, thus making all brands visible. The result shown in <a href="#calibre_link-1248" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-16</a> is different from that of the previous query shown in <a href="#calibre_link-1246" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-15</a>.</p>
<figure id="calibre_link-1248" class="image-l">
<img src="images/000328.jpg" alt="The figure shows Sales_Amount and Pct per brand. There is no totals row." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1697"></span><strong class="calibre7">Figure 14-16</strong> <em class="calibre5">ALLSELECTED</em> restores the currently iterated values, not the previous filter context.</figcaption>
</figure>
<p class="edition">As you can see, all the brands are visible&mdash;and this is expected&mdash;but the numbers are different than before, even though the code computing them is the same. The behavior of <em class="calibre5">ALLSELECTED</em> in this scenario is correct. Developers might think that it behaves unexpectedly because the filter context defined by the <em class="calibre5">Brands</em> variable is ignored by the <em class="calibre5">Pct</em> measure; however, <em class="calibre5">ALLSELECTED</em> is indeed behaving as it was designed to. <em class="calibre5">ALLSELECTED</em> returns the last shadow filter context; In this latter version of the query, the last shadow filter context contains all brands, not only the filtered ones. Indeed, <em class="calibre5">ADDCOLUMNS</em> introduced a shadow filter context on the rows it is iterating, which includes all brands.</p>
<p class="edition">If one needs to retain the previous filter context, they cannot rely solely on <em class="calibre5">ALLSELECTED</em>. The <em class="calibre5">CALCULATE</em> modifier that retains the previous filter context is <em class="calibre5">KEEPFILTERS</em>. It is interesting to see the result when <em class="calibre5">KEEPFILTERS</em> comes into play:</p>
<p class="codelink"><a href="#calibre_link-1249" id="calibre_link-2688" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR Brands =
    FILTER (
        ALL ( 'Product'[Brand] ),
        'Product'[Brand]
            IN {
                "Adventure Works",
                "Contoso",
                "Fabrikam",
                "Litware",
                "Northwind Traders",
                "Proseware"
            }
    )
RETURN
    CALCULATETABLE (
        ADDCOLUMNS (
            <strong class="calibre7">KEEPFILTERS ( ALL ( 'Product'[Brand] ) ),</strong>
            "Sales_Amount", [Sales Amount],
            "Pct", [Pct]
        ),
        Brands
    )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3150"></span>When used as a modifier of an iterator, <em class="calibre5">KEEPFILTERS</em> does not change the result of the iterated table. Instead, it instructs the iterator to apply <em class="calibre5">KEEPFILTERS</em> as an implicit <em class="calibre5">CALCULATE</em> modifier whenever context transition occurs while iterating on the table. As a result, <em class="calibre5">ALL</em> returns all the brands and the shadow filter context also contains all the brands. When the context transition takes place, the previous filter applied by the outer <em class="calibre5">CALCULATETABLE</em> with the <em class="calibre5">Brands</em> variable is kept. Thus, the query returns all the brands, but values are computed considering only the selected brands, as we can see in <a href="#calibre_link-1250" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-17</a>.</p>
<figure id="calibre_link-1250" class="image-l">
<img src="images/000336.jpg" alt="In this figure there are a few blank rows." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 14-17</strong> <em class="calibre5">ALLSELECTED</em> with <em class="calibre5">KEEPFILTERS</em> produces another result, containing many blanks.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-236" class="calibre13"><em class="calibre5">ALLSELECTED</em> without parameters</h4>
<p class="edition">As the name suggests, <em class="calibre5">ALLSELECTED</em> belongs to the <em class="calibre5">ALL*</em> family. As such, when used as a <em class="calibre5">CALCULATE</em> modifier, it acts as a filter remover. If the column used as a parameter is included in any shadow filter context, then it restores the last shadow filter context on that column only. Otherwise, if there is no shadow filter context then it does not do anything.</p>
<p class="edition">When used as a <em class="calibre5">CALCULATE</em> modifier, <em class="calibre5">ALLSELECTED</em>, like <em class="calibre5">ALL</em>, can also be used without any parameter. In that case, <em class="calibre5">ALLSELECTED</em> restores the last shadow filter context on any column. Remember that this happens if and only if the column is included in any shadow filter context. If a column is filtered through explicit filters only, then its filter remains untouched.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-237" class="h2a">The <em class="calibre5">ALL*</em> family of functions</h3>
<p class="edition">Because of the complexity of the <em class="calibre5">ALL*</em> family of functions, in this section we provide a summary of their behavior. Every <em class="calibre5">ALL*</em> function behaves slightly differently, so mastering them takes time and experience. In this chapter about advanced DAX concepts, it is time to sum up the main concepts.</p>
<p class="edition">The <em class="calibre5">ALL*</em> family includes the following functions: <em class="calibre5">ALL</em>, <em class="calibre5">ALLEXCEPT</em>, <em class="calibre5">ALLNOBLANKROW</em>, <em class="calibre5">ALLCROSSFILTERED</em>, and <em class="calibre5">ALLSELECTED</em>. All these functions can be used either as table functions or as <em class="calibre5">CALCULATE</em> modifiers. When used as table functions, they are much easier to understand than when used as <span type="pagebreak" id="calibre_link-1675"></span><em class="calibre5">CALCULATE</em> modifiers. Indeed, when used as <em class="calibre5">CALCULATE</em> modifiers, they might produce unexpected results because they act as filter removers.</p>
<p class="edition"><a href="#calibre_link-1251" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 14-5</a> provides a summary of the <em class="calibre5">ALL*</em> functions. In the remaining part of this section we provide a more complete description of each function.</p>
<p class="edition" id="calibre_link-1251"><strong class="calibre7">Table 14-5</strong> Summary of the <em class="calibre5">ALL*</em> family of functions</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Function</p></th>
<th class="th"><p class="tab-text">Table function</p></th>
<th class="th"><p class="tab-text"><em class="calibre5">CALCULATE</em> modifier</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">ALL</p></td>
<td class="th1"><p class="tab-text">Returns all the distinct values of a column or of a table.</p></td>
<td class="th1"><p class="tab-text">Removes any filter from columns or expanded tables. It never adds a filter; it only removes them if present.</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">ALLEXCEPT</p></td>
<td class="th1"><p class="tab-text">Returns all the distinct values of a table, ignoring filters on some of the columns of the expanded table.</p></td>
<td class="th1"><p class="tab-text">Removes filters from an expanded table, except from the columns (or tables) passed as further arguments.</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">ALLNOBLANKROW</p></td>
<td class="th1"><p class="tab-text">Returns all the distinct values of a column or table, ignoring the blank row added for invalid relationships.</p></td>
<td class="th1"><p class="tab-text">Removes any filter from columns or expanded tables; also adds a filter that only removes the blank row. Thus, even if there are no filters, it actively adds one filter to the context.</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">ALLSELECTED</p></td>
<td class="th1"><p class="tab-text">Returns the distinct values of a column or a table, as they are visible in the last shadow filter context.</p></td>
<td class="th1"><p class="tab-text">Restores the last shadow filter context on tables or columns, if a shadow filter context is present. Otherwise, it does not do anything. It always adds filters, even in the case where the filter shows all the values.</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">ALLCROSSFILTERED</p></td>
<td class="th1"><p class="tab-text">Not available as a table function.</p></td>
<td class="th1"><p class="tab-text">Removes any filter from an expanded table, including also the tables that can be reached directly or indirectly through bidirectional cross-filters. <em class="calibre5">ALLCROSSFILTERED</em> never adds a filter; it only removes filters if present.</p></td>
</tr>
</tbody>
</table>
<p class="edition">The “Table function” column in <a href="#calibre_link-1251" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 14-5</a> corresponds to the scenario where the <em class="calibre5">ALL*</em> function is being used in a DAX expression, whereas the “<em class="calibre5">CALCULATE</em> modifier” column is the specific case when the <em class="calibre5">ALL*</em> function is the top-level function of a filter argument in <em class="calibre5">CALCULATE</em>.</p>
<p class="edition">Another significant difference between the two usages is that when one retrieves the result of these <em class="calibre5">ALL*</em> functions through an <em class="calibre5">EVALUATE</em> statement, the result contains only the base table columns and not the expanded table. Nevertheless, internal calculations like the context transition always use the corresponding expanded table. The following examples of DAX code show the different uses of the <em class="calibre5">ALL</em> function. The same concepts can be applied to any function of the <em class="calibre5">ALL*</em> family.</p>
<p class="edition">In the following example, <em class="calibre5">ALL</em> is used as a simple table function.</p>
<p class="codelink"><a href="#calibre_link-1252" id="calibre_link-2689" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SUMX (
    ALL ( Sales ),                                  -- ALL is a table function
    Sales[Quantity] * Sales[Net Price]
)</pre></div>
<p class="edition">In the next example there are two formulas, involving iterations. In both cases the <em class="calibre5">Sales Amount</em> measure reference generates the context transition, and the context transition happens on the expanded table. When used as a table function, <em class="calibre5">ALL</em> returns the whole expanded table.</p>
<p class="codelink"><a href="#calibre_link-1253" id="calibre_link-2690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-1676"></span>FILTER (
    Sales,
    [Sales Amount] &gt; 100                            -- The context transition takes place
                                                    -- over the expanded table
)

FILTER (
    ALL ( Sales ),                                  -- ALL is a table function
    [Sales Amount] &gt; 100                            -- The context transition takes place
                                                    -- over the expanded table anyway
)</pre></div>
<p class="edition">In the next example we use <em class="calibre5">ALL</em> as a <em class="calibre5">CALCULATE</em> modifier to remove any filter from the expanded version of <em class="calibre5">Sales</em>:</p>
<p class="codelink"><a href="#calibre_link-1254" id="calibre_link-2691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    ALL ( Sales )                                   -- ALL is a CALCULATE modifier
)</pre></div>
<p class="edition">This latter example, although similar to the previous one, is indeed very different. <em class="calibre5">ALL</em> is not used as a <em class="calibre5">CALCULATE</em> modifier; instead, it is used as an argument of <em class="calibre5">FILTER</em>. In such a case, <em class="calibre5">ALL</em> behaves as a regular table function returning the entire expanded <em class="calibre5">Sales</em> table.</p>
<p class="codelink"><a href="#calibre_link-1255" id="calibre_link-2692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CALCULATE (
    [Sales Amount],
    FILTER ( ALL ( Sales ), Sales[Quantity] &gt; 0 )   -- ALL is a table function
                                                    -- The filter context receives the
                                                    -- expanded table as a filter anyway
)</pre></div>
<p class="edition">The following are more detailed descriptions of the functions included in the <em class="calibre5">ALL*</em> family. These functions look simple, but they are rather complex. Most of the time, their behavior is exactly what is needed, but they might produce undesired effects in boundary cases. It is not easy to remember all these rules and all the specific behaviors. We hope our reader finds <a href="#calibre_link-1251" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 14-5</a> useful when unsure about an <em class="calibre5">ALL*</em> function.</p>
<section class="calibre4">
<h4 id="calibre_link-238" class="calibre13"><em class="calibre5">ALL</em></h4>
<p class="edition">When used as a table function, <em class="calibre5">ALL</em> is a simple function. It returns all the distinct values of one or more columns, or all the values of a table. When used as a <em class="calibre5">CALCULATE</em> modifier, it acts as a hypothetical <em class="calibre5">REMOVEFILTER</em> function. If a column is filtered, it removes the filter. It is important to note that if a column is cross-filtered, then the filter is not removed. Only direct filters are removed by <em class="calibre5">ALL</em>. Thus, using <em class="calibre5">ALL ( Product[Color] )</em> as a <em class="calibre5">CALCULATE</em> modifier might still leave <em class="calibre5">Product[Color]</em> cross-filtered in case there is a filter on another column of the <em class="calibre5">Product</em> table. <em class="calibre5">ALL</em> operates on the expanded table. This is why <em class="calibre5">ALL ( Sales )</em> removes any filter from the tables in the sample model: the expanded <em class="calibre5">Sales</em> table includes all the tables of the entire model. <em class="calibre5">ALL</em> with no arguments removes any filter from the entire model.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-239" class="calibre13"><span type="pagebreak" id="calibre_link-3151"></span><em class="calibre5">ALLEXCEPT</em></h4>
<p class="edition">When used as a table function, <em class="calibre5">ALLEXCEPT</em> returns all the distinct values of the columns in a table, except the columns listed. If used as a filter, the result includes the full expanded table. When used as a filter argument in <em class="calibre5">CALCULATE</em>, <em class="calibre5">ALLEXCEPT</em> acts exactly as an <em class="calibre5">ALL</em>, but it does not remove the filter from the columns provided as arguments. It is important to remember that using <em class="calibre5">ALL</em>/<em class="calibre5">VALUES</em> is not the same as <em class="calibre5">ALLEXCEPT</em>. <em class="calibre5">ALLEXCEPT</em> only removes filters, whereas <em class="calibre5">ALL</em> removes filters while <em class="calibre5">VALUES</em> retains cross-filtering by imposing a new filter. Though subtle, this difference is important.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-240" class="calibre13"><em class="calibre5">ALLNOBLANKROW</em></h4>
<p class="edition">When used as a table function, <em class="calibre5">ALLNOBLANKROW</em> behaves like <em class="calibre5">ALL</em>, but it does not return the blank row potentially added because of invalid relationships. <em class="calibre5">ALLNOBLANKROW</em> can still return a blank row, if blanks are present in the table. The only row that is never returned is the one added automatically by the engine to fix invalid relationships. When used as a <em class="calibre5">CALCULATE</em> modifier, <em class="calibre5">ALLNOBLANKROW</em> replaces all the filters with a new filter that only removes the blank row. Therefore, all the columns will only filter out the blank value.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-241" class="calibre13"><em class="calibre5">ALLSELECTED</em></h4>
<p class="edition">When used as a table function, <em class="calibre5">ALLSELECTED</em> returns the values of a table (or column) as filtered in the last shadow filter context. When used as a <em class="calibre5">CALCULATE</em> modifier, it restores the last shadow filter context on each column. If multiple columns are present in different shadow filter contexts, it uses the last shadow filter context for each column.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-242" class="calibre13"><em class="calibre5">ALLCROSSFILTERED</em></h4>
<p class="edition"><em class="calibre5">ALLCROSSFILTERED</em> can be used only as a <em class="calibre5">CALCULATE</em> modifier and cannot be used as a table function. <em class="calibre5">ALLCROSSFILTERED</em> has only one argument that must be a table. <em class="calibre5">ALLCROSSFILTERED</em> removes all the filters on an expanded table (like <em class="calibre5">ALL</em>) and on columns and tables that are cross-filtered because of bidirectional cross-filters set on relationships directly or indirectly connected to the expanded table.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-243" class="h2a">Understanding data lineage</h3>
<p class="edition">We introduced data lineage in <a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10</a>, “<a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with the filter context</a>,” and we have shown our readers how to control data lineage using <em class="calibre5">TREATAS</em>. In <a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 12</a>, “<a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with tables</a>,” and <a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 13</a>, “<a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Authoring queries</a>,” we described how certain table functions can manipulate the data lineage of the result. This section is a summary of the rules to remember about data lineage, with additional information we could not cover in previous chapters.</p>
<p class="edition">Here are the basic rules of data lineage:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Each column of a table in a data model has a unique data lineage.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-2068"></span>When a filter context filters the model, it filters the model column with the same data lineage of the columns included in the filter context.</p></li>
<li class="calibre10"><p class="listp">Because a filter is the result of a table, it is important to know how a table function may affect the data lineage of the result:</p>
<ul class="bull">
<li class="calibre10"><p class="listp">In general, columns used to group data keep their data lineage in the result.</p></li>
<li class="calibre10"><p class="listp">Columns containing the result of an aggregation always have a new data lineage.</p></li>
<li class="calibre10"><p class="listp">Columns created by <em class="calibre5">ROW</em> and <em class="calibre5">ADDCOLUMNS</em> always have a new data lineage.</p></li>
<li class="calibre10"><p class="listp">Columns created by <em class="calibre5">SELECTEDCOLUMNS</em> keep the data lineage of the original column whenever the expression is just a copy of a column in the data model; otherwise, they have a new data lineage.</p></li>
</ul></li>
</ul>
<p class="edition">For example, the following code seems to produce a table where each product color has a corresponding <em class="calibre5">Sales Amount</em> value summing all the sales for that color. Instead, because <em class="calibre5">C2</em> is a column created by <em class="calibre5">ADDCOLUMNS</em>, it does not have the same lineage as <em class="calibre5">Product[Color]</em>, even though it has the same content. Please note that we had to use several steps: first, we create the <em class="calibre5">C2</em> column; then we select that column only. If other columns remain in the same table, then the result would be very different.</p>
<p class="codelink"><a href="#calibre_link-1256" id="calibre_link-2693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Sales Amount] =
        SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
EVALUATE
VAR NonBlueColors =
    FILTER (
        ALL ( 'Product'[Color] ),
        'Product'[Color] &lt;&gt; "Blue"
    )
VAR AddC2 =
    ADDCOLUMNS (
        NonBlueColors,
        "[C2]", 'Product'[Color]
    )
VAR SelectOnlyC2 =
    SELECTCOLUMNS ( AddC2, "C2", [C2] )
VAR Result =
    ADDCOLUMNS ( SelectOnlyC2, "Sales Amount", [Sales Amount] )
RETURN Result
ORDER BY [C2]</pre></div>
<p class="edition">The previous query produces a result where the <em class="calibre5">Sales Amount</em> column always has the same value, corresponding to the sum of all the rows in the <em class="calibre5">Sales</em> table. This is shown in <a href="#calibre_link-1257" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-18</a>.</p>
<figure id="calibre_link-1257" class="image-l">
<img src="images/000344.jpg" alt="In this report, all sales amounts are the same for each value in C2." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1923"></span><strong class="calibre7">Figure 14-18</strong> The <em class="calibre5">C2</em> column does not have the same data lineage as <em class="calibre5">Product[Color]</em>.</figcaption>
</figure>
<p class="edition"><em class="calibre5">TREATAS</em> can be used to transform the data lineage of a table. For example, the following code restores the data lineage to <em class="calibre5">Product[Color]</em> so that the last <em class="calibre5">ADDCOLUMNS</em> computes <em class="calibre5">Sales Amount</em> leveraging the context transition over the <em class="calibre5">Color</em> column:</p>
<p class="codelink"><a href="#calibre_link-1258" id="calibre_link-2694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Sales Amount] =
        SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
EVALUATE
VAR NonBlueColors =
    FILTER (
        ALL ( 'Product'[Color] ),
        'Product'[Color] &lt;&gt; "Blue"
    )
VAR AddC2 =
    ADDCOLUMNS (
        NonBlueColors,
        "[C2]", 'Product'[Color]
    )
VAR SelectOnlyC2 =
    SELECTCOLUMNS ( AddC2, "C2", [C2] )
<strong class="calibre7">VAR TreatAsColor =</strong>
    <strong class="calibre7">TREATAS ( SelectOnlyC2, 'Product'[Color] )</strong>
VAR Result =
    ADDCOLUMNS ( TreatAsColor, "Sales Amount", [Sales Amount] )
RETURN Result
<strong class="calibre7">ORDER BY 'Product'[Color]</strong></pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3152"></span>As a side effect, <em class="calibre5">TREATAS</em> also changes the column name, which must be correctly referenced in the <em class="calibre5">ORDER BY</em> condition. The result is visible in <a href="#calibre_link-1259" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 14-19</a>.</p>
<figure id="calibre_link-1259" class="image-l">
<img src="images/000352.jpg" alt="In this report, sales amounts are accurate for each color." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 14-19</strong> The <em class="calibre5">Color</em> column in the result has the same data lineage as <em class="calibre5">Product[Color]</em>.</figcaption>
</figure>
</section>
<section class="calibre4">
<h3 id="calibre_link-244" class="h2a">Conclusions</h3>
<p class="edition">In this chapter we introduced two complex concepts: expanded tables and shadow filter contexts.</p>
<p class="edition">Expanded tables are at the core of DAX. It takes some time before one gets used to thinking in terms of expanded tables. However, once the concept of expanded tables has become familiar, they are much simpler to work with than relationships. Only rarely does a developer have to deal with expanded tables, but knowing about them proves to be invaluable when they are the only way to make sense of a result.</p>
<p class="edition">In this regard, shadow filter contexts are like expanded tables: They are hard to see and understand, but when they come into play in the evaluation of a formula, they explain exactly how the numbers were computed. Making sense of a complex formula that uses <em class="calibre5">ALLSELECTED</em> without first mastering shadow filter contexts is nearly impossible.</p>
<p class="edition">However, both concepts are so complex that the best thing to do is to try to avoid them. We do show a few examples of expanded tables being useful in <a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 15</a>. Shadow filter contexts are useless in code; they are merely a technical means for DAX to let developers compute totals at the visual level.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3153"></span>Try to avoid using expanded tables by only using column filters and not table filters in <em class="calibre5">CALCULATE</em> filter arguments. Doing this, the code will be much easier to understand. Usually, it is possible to ignore expanded tables, as long as they are not required for some complex measure.</p>
<p class="edition">Try to avoid shadow filter context by never letting <em class="calibre5">ALLSELECTED</em> be called inside an iteration. The only iteration before <em class="calibre5">ALLSELECTED</em> needs to be the outermost iteration created by the query engine&mdash;mostly Power BI. Calling a measure containing <em class="calibre5">ALLSELECTED</em> from inside an iteration makes the calculation more complex.</p>
<p class="edition">When you follow these two pieces of advice, your DAX code will be correct and easy to understand. Remember that experts can appreciate complexity, but they also understand when it is better to stay away from complexity. Avoiding table filters and <em class="calibre5">ALLSELECTED</em> inside iterations does not make a developer look uneducated. Rather, it puts the developer in the category of experts that want their code to always work smoothly.</p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1260">
<div id="calibre_link-3154" class="calibre2">
<div id="calibre_link-3155" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-20"><span type="pagebreak" id="calibre_link-1825"></span><span class="pd_ash">Chapter 15</span><br class="calibre3" />Advanced relationships</h2>
<p class="edition">At this point in the book, there are no more DAX secrets to share. In previous chapters we covered all there is to know about the syntax and the functionalities of DAX. Still, there is a long way to go. There are another two chapters dedicated to DAX, and then we will talk about optimization. The next chapter is dedicated to advanced DAX calculations. In this chapter we describe how to leverage DAX to create advanced types of relationships. These include calculated physical relationships and virtual relationships. Then, while on the topic of relationships, we want to share a few considerations about different types of physical relationships: one-to-one, one-to-many, and many-to-many. Each of these types of relationships is worth describing in its peculiarities. Moreover, a topic that still needs some attention is ambiguity. A DAX model can be&mdash;or become&mdash;ambiguous; this is a serious problem you need to be aware of, in order to handle it well.</p>
<p class="edition">At the end of this chapter we cover a topic that is more relevant to data modeling than to DAX, which is relationships with different granularity. When a developer needs to analyze budget and sales, they are likely working with multiple tables with different granularity. Knowing how to manage them properly is a useful skill for DAX developers.</p>
<section class="calibre4">
<h3 id="calibre_link-245" class="h2a">Implementing calculated physical relationships</h3>
<p class="edition">The first set of relationships we describe is <em class="calibre5">calculated physical relationships</em>. In scenarios where the relationship cannot be set because a key is missing, or when one needs to compute the key with complex formulas, a good option is to leverage calculated columns to set the relationship. The result is still a physical relationship; the only difference with a standard relationship is that the relationship key is a calculated column instead of being a column from the data source.</p>
<section class="calibre4">
<h4 id="calibre_link-246" class="calibre13">Computing multiple-column relationships</h4>
<p class="edition">A Tabular model allows the creation of relationships based on a single column only. It does not support relationships based on multiple columns. Nevertheless, relationships based on multiple columns are useful when they appear in data models that cannot be changed. Here are two methods to work with relationships based on multiple columns:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Define a calculated column containing the composition of the keys; then use it as the new key for the relationship.</p></li>
<li class="calibre10"><p class="listp">Denormalize the columns of the target table&mdash;the one-side in a one-to-many relationship&mdash;using the <em class="calibre5">LOOKUPVALUE</em> function.</p></li>
</ul>
<p class="edition"><span type="pagebreak" id="calibre_link-1888"></span>As an example, consider the case of Contoso offering a “Products of the Day” promotion. On certain days, a discount is offered on a set of products. The model is visible in <a href="#calibre_link-1261" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-1</a>.</p>
<figure id="calibre_link-1261" class="image-l">
<img src="images/000466.jpg" alt="This figure shows the data model with tables and relationships." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-1</strong> The <em class="calibre5">Discounts</em> table needs a relationship based on two columns with <em class="calibre5">Sales</em>.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">Discounts</em> table contains three columns: <em class="calibre5">Date, ProductKey</em>, and <em class="calibre5">Discount</em>. If a developer needs this information in order to compute the amount of the discount, they are faced with a problem: for any given sale, the discount depends on <em class="calibre5">ProductKey</em> and <em class="calibre5">Order Date</em>. Thus, it is not possible to create the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Discounts</em>; it would involve two columns, and DAX only supports relationships based on a single column.</p>
<p class="edition">The first option is to create a new column in both <em class="calibre5">Discount</em> and <em class="calibre5">Sales</em>, containing the combination of the two columns:</p>
<p class="codelink"><a href="#calibre_link-1262" id="calibre_link-2696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[DiscountKey] =
COMBINEVALUES (
    "-",
    Sales[Order Date],
    Sales[ProductKey]
)

Discounts[DiscountKey] =
COMBINEVALUES(
    "-",
    Discounts[Date],
    Discounts[ProductKey]
)</pre></div>
<p class="edition">The calculated columns use the <em class="calibre5">COMBINEVALUES</em> function. <em class="calibre5">COMBINEVALUES</em> requires a separator and a set of expressions that are concatenated as strings, separated by the separator provided. One could obtain the same result in terms of column values by using a simpler string concatenation, but <em class="calibre5">COMBINEVALUES</em> offers a few advantages. Indeed, <em class="calibre5">COMBINEVALUES</em> is particularly useful when <span type="pagebreak" id="calibre_link-1826"></span>creating relationships based on calculated columns if the model uses DirectQuery. <em class="calibre5">COMBINEVALUES</em> assumes&mdash;but does not validate&mdash;that when the input values are different, the output strings are also different. Based on this assumption, when <em class="calibre5">COMBINEVALUES</em> is used to create calculated columns to build a relationship that joins multiple columns from two DirectQuery tables, an optimized join condition is generated at query time.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">More details about optimizations obtained by using <em class="calibre5">COMBINEVALUES</em> with Direct-Query are available at <a href="https://www.sqlbi.com/articles/using-combinevalues-to-optimizedirectquery-performance/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.sqlbi.com/articles/using-combinevalues-to-optimizedirectquery-performance/</a>.</p>
</div>
<p class="edition">Once the two columns are in place, one can finally create the relationship between the two tables. Indeed, a relationship can be safely created on top of calculated columns.</p>
<p class="edition">This solution is straightforward and works well. Yet there are scenarios where this is not the best option because it requires the creation of two calculated columns with potentially many different values. As you learn in later chapters about optimization, this might have a negative impact on both model size and query speed.</p>
<p class="edition">The second option is to use the <em class="calibre5">LOOKUPVALUE</em> function. Using <em class="calibre5">LOOKUPVALUE</em>, one can denormalize the discount in the <em class="calibre5">Sales</em> table by defining a new calculated column containing the discount:</p>
<p class="codelink"><a href="#calibre_link-1263" id="calibre_link-2697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Discount] =
LOOKUPVALUE (
    Discounts[Discount],
    Discounts[ProductKey], Sales[ProductKey],
    Discounts[Date], Sales[Order Date]
)</pre></div>
<p class="edition">Following this second pattern, no relationship is created. Instead, the <em class="calibre5">Discount</em> value is denormalized in the <em class="calibre5">Sales</em> table by performing a lookup.</p>
<p class="edition">Both options work well, and picking the right one depends on several factors. If <em class="calibre5">Discount</em> is the only column needed, then denormalization is the best option because it makes the code simple to author, and it reduces memory usage. Indeed, it requires a single calculated column with fewer distinct values compared to the two calculated columns required for a relationship.</p>
<p class="edition">On the other hand, if the <em class="calibre5">Discounts</em> table contains many columns needed in the code, then each of them should be denormalized in the <em class="calibre5">Sales</em> table. This results in a waste of memory and possibly in decreased processing performance. In that case, the calculated column with the new composite key might be preferable.</p>
<p class="edition">This simple first example is important because it demonstrates a common and important feature of DAX: the ability to create relationships based on calculated columns. This demonstrates that a user can create a new relationship, provided that they can compute and materialize the key in a calculated column. The next example demonstrates how to create relationships based on static ranges. By extending the concept, it is possible to create several kinds of relationships.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-247" class="calibre13"><span type="pagebreak" id="calibre_link-1802"></span>Implementing relationships based on ranges</h4>
<p class="edition">In order to show why calculated physical relationships are a useful tool, we examine a scenario where one needs to perform a static segmentation of products based on their list price. The price of a product has many different values and performing an analysis slicing by price does not provide useful insights. In that case, a common technique is to partition the different prices into separate buckets, using a configuration table like the one in <a href="#calibre_link-1264" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-2</a>.</p>
<figure id="calibre_link-1264" class="image-l">
<img src="images/000474.jpg" alt="The table contains PriceRangeKey, PriceRange, MinPrice, and MaxPrice." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-2</strong> This is the <em class="calibre5">Configuration</em> table for the price ranges.</figcaption>
</figure>
<p class="edition">As was the case in the previous example, it is not possible to create a direct relationship between the <em class="calibre5">Sales</em> table and the <em class="calibre5">Configuration</em> table. The reason is that the key in the configuration table depends on a relationship based on a range of values (also known as a between condition), which is not supported by DAX. We could compute a key in the <em class="calibre5">Sales</em> table by using nested <em class="calibre5">IF</em> statements; however, this would require including the values of the configuration table in the formula like in the following example, which is not the suggested solution:</p>
<p class="codelink"><a href="#calibre_link-1265" id="calibre_link-2698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[PriceRangeKey] =
SWITCH (
    TRUE (),
    Sales[Net Price] &lt;=  10, 1,
    Sales[Net Price] &lt;=  30, 2,
    Sales[Net Price] &lt;=  80, 3,
    Sales[Net Price] &lt;= 150, 4,
    5
)</pre></div>
<p class="edition">A good solution should not include the boundaries in the formula. Instead, the code should be designed to adapt to the contents of the table, so that updating the configuration table updates the whole model.</p>
<p class="edition">In this case a better solution is to denormalize the price range directly in the <em class="calibre5">Sales</em> table by using a calculated column. The pattern of the code is quite similar to the previous one&mdash;the main difference being the formula, which, this time, cannot be a simple <em class="calibre5">LOOKUPVALUE</em>:</p>
<p class="codelink"><a href="#calibre_link-1266" id="calibre_link-2699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[PriceRange] =
VAR FilterPriceRanges =
    FILTER (
        PriceRanges,
        AND (
            PriceRanges[MinPrice] &lt;= Sales[Net Price],
<span type="pagebreak" id="calibre_link-3156"></span>            PriceRanges[MaxPrice] &gt; Sales[Net Price]
        )
    )
VAR Result =
    CALCULATE (
        VALUES ( PriceRanges[PriceRange] ),
        FilterPriceRanges
    )
RETURN
    Result</pre></div>
<p class="edition">It is interesting to note the usage of <em class="calibre5">VALUES</em> to retrieve a single value: <em class="calibre5">VALUES</em> returns a table, not a value. However, as explained in <a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 3</a>, “<a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Using basic table functions</a>,” whenever a table contains a single row and a single column, the table is automatically converted into a scalar value if required by the expression.</p>
<p class="edition">Because of the way <em class="calibre5">FILTER</em> computes its result, it always returns a single row from the configuration table. Therefore, <em class="calibre5">VALUES</em> is guaranteed to always return a single row; the result of <em class="calibre5">CALCULATE</em> is thus the description of the price range containing the net price of the current row in the <em class="calibre5">Sales</em> table. This expression works well if the configuration table is well designed. But if the ranges contain holes or overlaps in range of values, then <em class="calibre5">VALUES</em> might return multiple rows, and the expression might result in an error.</p>
<p class="edition">The previous technique denormalizes values in the <em class="calibre5">Sales</em> table. Going one step further means denormalizing the key instead of the description and then building a physical relationship based on the new calculated column. This additional step requires some level of attention in the definition of the calculated column. A simple modification of the <em class="calibre5">PriceRange</em> column is enough to retrieve the key, but it is still not enough to create the relationship. The following is the code required to retrieve the key and blank the result in case of errors:</p>
<p class="codelink"><a href="#calibre_link-1267" id="calibre_link-2700" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[PriceRangeKey] =
VAR FilterPriceRanges =
    FILTER (
        PriceRanges,
        AND (
            PriceRanges[MinPrice] &lt;= Sales[Net Price],
            PriceRanges[MaxPrice] &gt; Sales[Net Price]
        )
    )
VAR Result =
    CALCULATE (
        IFERROR (
            <strong class="calibre7">VALUES ( PriceRanges[PriceRangeKey] ),</strong>
            BLANK ()
        ),
        FilterPriceRanges
    )
RETURN
    Result</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1803"></span>The column computes the correct value. Unfortunately, trying to build the relationship between <em class="calibre5">PriceRanges</em> and <em class="calibre5">Sales</em> based on the newly created <em class="calibre5">PriceRangeKey</em> column results in an error because of a circular dependency. Circular dependencies frequently occur when creating relationships based on calculated columns or calculated tables.</p>
<p class="edition">In this example, the fix is indeed simple: you need to use <em class="calibre5">DISTINCT</em> instead of <em class="calibre5">VALUES</em> in the highlighted row of the formula. Once <em class="calibre5">DISTINCT</em> is in place, the relationship can be created. The result is visible in <a href="#calibre_link-1268" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-3</a>.</p>
<figure id="calibre_link-1268" class="image-l">
<img src="images/000481.jpg" alt="The table shows Sales Amount per PriceRange accurately." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-3</strong> Slicing by price range is possible once the relationship is set correctly.</figcaption>
</figure>
<p class="edition">Prior to using <em class="calibre5">DISTINCT</em>, the presence of <em class="calibre5">VALUES</em> would generate a circular dependency. Replacing <em class="calibre5">VALUES</em> with <em class="calibre5">DISTINCT</em> works like magic. The underlying mechanisms are quite intricate. The next section provides a complete explanation of circular dependencies that might appear because of relationships with calculated columns or calculated tables, along with a complete explanation of why <em class="calibre5">DISTINCT</em> removes the problem.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-248" class="calibre13">Understanding circular dependency in calculated physical relationships</h4>
<p class="edition">In the previous example, we created a calculated column and then used it in a relationship. This resulted in a circular dependency error. As soon as you start working with calculated physical relationships, this error can appear quite often. Therefore, it is useful to spend some time understanding exactly the source of the error. This way, you will also learn how to avoid it.</p>
<p class="edition">Let us recall the code of the calculated column in its shorter form:</p>
<p class="codelink"><a href="#calibre_link-1269" id="calibre_link-2701" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[PriceRangeKey] =
CALCULATE (
    VALUES ( PriceRanges[PriceRangeKey] ),
    FILTER (
        PriceRanges,
        AND (
            PriceRanges[MinPrice] &lt;= Sales[Net Price],
            PriceRanges[MaxPrice] &gt; Sales[Net Price]
        )
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-2003"></span>The <em class="calibre5">PriceRangeKey</em> column depends on the <em class="calibre5">PriceRanges</em> table. If a change is detected in the <em class="calibre5">PriceRanges</em> table, then <em class="calibre5">Sales[PriceRangeKey]</em> must be recalculated. Because the formula contains several references to the <em class="calibre5">PriceRanges</em> table, the dependency is clear. What is less obvious is that creating a relationship between this column and the <em class="calibre5">PriceRanges</em> table creates a dependency the other way around.</p>
<p class="edition">In <a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 3</a> we mentioned that the DAX engine creates a blank row on the one-side of a relationship if the relationship is invalid. Thus, when a table is on the one-side of a relationship, its content depends on the validity of the relationship. In turn, the validity of the relationship depends on the content of the column used to set the relationship.</p>
<p class="edition">In our scenario, if one could create a relationship between <em class="calibre5">Sales</em> and <em class="calibre5">PriceRanges</em> based on <em class="calibre5">Sales[PriceRangeKey]</em>, then <em class="calibre5">PriceRanges</em> might have a blank row or not, depending on the value of <em class="calibre5">Sales[PriceRangeKey]</em>. In other words, when the value of <em class="calibre5">Sales[PriceRangeKey]</em> changes, the content of the <em class="calibre5">PriceRanges</em> table might also change. But in turn, if the value of <em class="calibre5">PriceRanges</em> changes, then <em class="calibre5">Sales[PriceRangeKey]</em> might require an update&mdash;even though the added blank row should never be used. This is the reason why the engine detects a circular dependency. It is hard to spot for a human, but the DAX algorithm finds it immediately.</p>
<p class="edition">If the engineers who created DAX had not worked on the problem, it would have been impossible to create relationships based on calculated columns. Instead, they added some logic in DAX specifically to handle scenarios like this.</p>
<p class="edition">Instead of having only one kind of dependency, in DAX there are two types of dependencies: formula dependency and blank row dependency. In our example, this is the situation:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">Sales[PriceRangeKey]</em> depends on <em class="calibre5">PriceRanges</em> both because of the formula (it references the <em class="calibre5">PriceRanges</em> table) and because of the blank row (it uses the <em class="calibre5">VALUES</em> function, which might return the additional blank row).</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">PriceRanges</em> depends on <em class="calibre5">Sales[PriceRangeKey]</em> only because of the blank row. A change in the value of <em class="calibre5">Sales[PriceRangeKey]</em> does not change the content of <em class="calibre5">PriceRanges</em>. It only affects the presence of the blank row.</p></li>
</ul>
<p class="edition">To break the chain of the circular dependency, it is enough to break the dependency of <em class="calibre5">Sales[PriceRangeKey]</em> from the presence of the blank row in <em class="calibre5">PriceRanges</em>. This can be obtained by making sure that all the functions used in the formula do not depend on the blank row. <em class="calibre5">VALUES</em> includes the additional blank row if present. Therefore, <em class="calibre5">VALUES</em> depends on the blank row. <em class="calibre5">DISTINCT</em>, on the other hand, always has the same value, regardless of the presence of the additional blank row. Consequently, <em class="calibre5">DISTINCT</em> does not depend on the blank row.</p>
<p class="edition">If you use <em class="calibre5">DISTINCT</em> instead of <em class="calibre5">VALUES</em>, then <em class="calibre5">Sales[PriceRangeKey]</em> no longer depends on the blank row. The net effect is that the two entities&mdash;the table and the column&mdash;still depend on each other, but for different reasons. <em class="calibre5">PriceRanges</em> depends on <em class="calibre5">Sales[PriceRangeKey]</em> for the blank row, whereas <em class="calibre5">Sales[PriceRangeKey]</em> depends on <em class="calibre5">Sales</em> because of the formula. Being two unrelated dependencies, the circular dependency disappears and it is possible to create the relationship.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1684"></span>Whenever creating columns that might later be used to set relationships, you need to pay special attention to the following details:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Using <em class="calibre5">DISTINCT</em> instead of <em class="calibre5">VALUES</em>.</p></li>
<li class="calibre10"><p class="listp">Using <em class="calibre5">ALLNOBLANKROW</em> instead of <em class="calibre5">ALL</em>.</p></li>
<li class="calibre10"><p class="listp">Beware of <em class="calibre5">CALCULATE</em> with filters using the compact syntax.</p></li>
</ul>
<p class="edition">The first two points are quite clear. The following elaborates on the last point&mdash;paying attention to <em class="calibre5">CALCULATE</em>. For example, consider the following expression:</p>
<p class="codelink"><a href="#calibre_link-1270" id="calibre_link-2702" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">=
CALCULATE (
    MAX ( Customer[YearlyIncome] ),
    Customer[Education] = "High school"
)</pre></div>
<p class="edition">At first sight, it looks like this formula does not depend on the blank row in <em class="calibre5">Customer</em>. But in fact, it does. The reason is that DAX expands the syntax of <em class="calibre5">CALCULATE</em> with the compact syntax of a filter argument, into a complete filter over a table corresponding to the following code:</p>
<p class="codelink"><a href="#calibre_link-1271" id="calibre_link-2703" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">=
CALCULATE (
    MAX ( Customer[YearlyIncome] ),
    FILTER (
        <strong class="calibre7">ALL ( Customer[Education] ),</strong>
        Customer[Education] = "High school"
    )
)</pre></div>
<p class="edition">The highlighted row containing the <em class="calibre5">ALL</em> function creates a dependency on the blank row. In general, blank row dependencies might be hard to spot. But once you understand the basic principle of circular dependencies, they are not complex to remove. The previous example can easily be rewritten this way:</p>
<p class="codelink"><a href="#calibre_link-1272" id="calibre_link-2704" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">=
CALCULATE (
    MAX ( Customer[YearlyIncome] ),
    FILTER (
        <strong class="calibre7">ALLNOBLANKROW ( Customer[Education] ),</strong>
        Customer[Education] = "High school"
    )
)</pre></div>
<p class="edition">By using <em class="calibre5">ALLNOBLANKROW</em> instead of <em class="calibre5">ALL</em>, the dependency on the additional blank row in <em class="calibre5">Customer</em> table disappears.</p>
<p class="edition">It is important to note that often, the presence of functions that rely on the blank row is hidden within the code. As an example, consider the code used in the previous section where we created the calculated physical relationship based on the price range. Here is the original code:</p>
<p class="codelink"><a href="#calibre_link-1273" id="calibre_link-2705" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-2059"></span>Sales[PriceRangeKey] =
CALCULATE (
    VALUES ( PriceRanges[PriceRangeKey] ),
    FILTER (
        PriceRanges,
        AND (
            PriceRanges[MinPrice] &lt;= Sales[Net Price],
            PriceRanges[MaxPrice] &gt; Sales[Net Price]
        )
    )
)</pre></div>
<p class="edition">In the previous formula, the presence of <em class="calibre5">VALUES</em> is very clear. Yet, a different way to author the same code without using <em class="calibre5">VALUES</em> is to rely on <em class="calibre5">SELECTEDVALUE</em>, which does not return an error in case multiple rows are visible:</p>
<p class="codelink"><a href="#calibre_link-1274" id="calibre_link-2706" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[PriceRangeKey] =
VAR FilterPriceRanges =
    FILTER (
        PriceRanges,
        AND (
            PriceRanges[MinPrice] &lt;= Sales[Net Price],
            PriceRanges[MaxPrice] &gt; Sales[Net Price]
        )
    )
VAR Result =
    CALCULATE (
        SELECTEDVALUE ( PriceRanges[PriceRangeKey] ),
        FilterPriceRanges
    )
RETURN Result</pre></div>
<p class="edition">Unfortunately, as soon as you try to create the relationship, this code raises a circular dependency error too, although it looks like <em class="calibre5">VALUES</em> is not present. Indeed, though hidden, <em class="calibre5">VALUES</em> is present. The reason is that <em class="calibre5">SELECTEDVALUE</em> internally implements the following logic:</p>
<p class="codelink"><a href="#calibre_link-1275" id="calibre_link-2707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[PriceRangeKey] =
VAR FilterPriceRanges =
    FILTER (
        PriceRanges,
        AND (
            PriceRanges[MinPrice] &lt;= Sales[Net Price],
            PriceRanges[MaxPrice] &gt; Sales[Net Price]
        )
    )
VAR Result =
    CALCULATE (
        IF (
            HASONEVALUE ( PriceRanges[PriceRangeKey] ),
<span type="pagebreak" id="calibre_link-1774"></span>            VALUES ( PriceRanges[PriceRangeKey] ),
            BLANK ()
        ),
        FilterPriceRanges
    )
RETURN
    Result</pre></div>
<p class="edition">By expanding the code of <em class="calibre5">SELECTEDVALUES</em>, now the presence of <em class="calibre5">VALUES</em> is more evident. Hence, so is the dependency on the blank row that generates the circular dependency.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-249" class="h2a">Implementing virtual relationships</h3>
<p class="edition">In the previous sections we discussed how to leverage calculated columns to create physical relationships. However, there are scenarios where a physical relationship is not the right solution and virtual relationships are a better approach. A virtual relationship mimics a real relationship. From a user point of view, a virtual relationship looks like a real relationship although there is no relationship in the physical model. Because there is no relationship, you need to author DAX code to transfer a filter from one table to another.</p>
<section class="calibre4">
<h4 id="calibre_link-250" class="calibre13">Transferring filters in DAX</h4>
<p class="edition">One of the most powerful features of DAX is its ability to move a filter from one table to another by following relationships. Yet, there are scenarios where it is hard&mdash;if not impossible&mdash;to create a physical relationship between two entities. A DAX expression can mimic the relationship in multiple ways. This section shows a few techniques by using a somewhat elaborate scenario.</p>
<p class="edition">Contoso advertises in local newspapers and on the web, choosing one or more brands to promote each month. This information is stored in a table named <em class="calibre5">Advertised Brands</em> that contains the year, the month, and the brand&mdash;if any&mdash;on sale. You can see an excerpt of the table in <a href="#calibre_link-1276" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-4</a>.</p>
<figure id="calibre_link-1276" class="image-l">
<img src="images/000489.jpg" alt="This table contains the brand on sale per month and per calendar year." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-4</strong> The table contains one row for each brand in the month where it was advertised.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1902"></span>It is important to note that there is no unique column in the table. Although all the rows are unique, each column has many duplicates. Therefore, the table cannot be on the one-side of a relationship. This fact becomes of higher importance as soon as we further outline the requirements.</p>
<p class="edition">The requirement is to create a measure that computes the sales amount of the products, only within the time period when they were being advertised. In order to solve that scenario, it is necessary to determine whether a brand is being advertised or not in a given month. If it were possible to create a relationship between <em class="calibre5">Sales</em> and the <em class="calibre5">Advertised Brands</em> table, the code would be simple to author. Unfortunately, the relationship is not easy to create (and this is by design for the purpose of this teaching).</p>
<p class="edition">One possible solution is to create a new calculated column in both tables containing the concatenation of year, month, and brand. This follows the technique outlined earlier in this chapter, to create a relationship between two tables based on multiple columns. Nevertheless, in this scenario there are other interesting alternatives worth exploring that avoid the creation of new calculated columns.</p>
<p class="edition">A first yet suboptimal solution is to rely on iterations. One could iterate the <em class="calibre5">Sales</em> table row by row, and on each row check if the brand of the product being sold was being advertised in that month. Thus, the following measure solves the scenario, but it is not the best solution:</p>
<p class="codelink"><a href="#calibre_link-1277" id="calibre_link-2708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Advertised Brand Sales :=
SUMX (
    FILTER (
        Sales,
        CONTAINS (
            'Advertised Brands',
            'Advertised Brands'[Brand], RELATED ( 'Product'[Brand] ),
            'Advertised Brands'[Calendar Year], RELATED ( 'Date'[Calendar Year] ),
            'Advertised Brands'[Month], RELATED ( 'Date'[Month] )
        )
    ),
    Sales[Quantity] * Sales[Net Price]
)</pre></div>
<p class="edition">The measure uses the <em class="calibre5">CONTAINS</em> function, which searches for the presence of a row in a table. <em class="calibre5">CONTAINS</em> accepts the table to search in as its first parameter. Following are pairs of parameters: the first one being a column in the table to search and the second one being the value to search. In the example, <em class="calibre5">CONTAINS</em> returns <em class="calibre5">True</em> if in <em class="calibre5">Advertised Brands</em> there is at least one row where the brand is the current brand, the year is the current year, and the month is the current month&mdash;where “current” means the <em class="calibre5">Sales</em> row currently iterated by <em class="calibre5">FILTER</em>.</p>
<p class="edition">The measure computes a correct result, as shown in <a href="#calibre_link-1278" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-5</a>, but there are several issues.</p>
<figure id="calibre_link-1278" class="image-l">
<img src="images/000496.jpg" alt="The report shows Advertised Brand Sales and Sales Amount per category per calendar year, with yearly totals." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1811"></span><strong class="calibre7">Figure 15-5</strong> <em class="calibre5">Advertised Brand Sales</em> represents the sales of only the brands being advertised.</figcaption>
</figure>
<p class="edition">Here are the two most problematic issues of the previous code:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">FILTER</em> iterates over <em class="calibre5">Sales</em>&mdash;which is a large table&mdash;and for each row it calls the <em class="calibre5">CONTAINS</em> function. Even though <em class="calibre5">CONTAINS</em> is a fast function, calling it millions of times results in poor performance.</p></li>
<li class="calibre10"><p class="listp">The measure does not take advantage of the presence of the <em class="calibre5">Sales Amount</em> measure, which already computes the sales amount. In this case the duplicated code is a simple multiplication, but if the measure to compute were more complex, this approach would not be the best. Indeed, it requires duplicating the expression to compute within the iteration.</p></li>
</ul>
<p class="edition">A much better option to solve the scenario is to use <em class="calibre5">CALCULATE</em> to transfer the filter from the <em class="calibre5">Advertised Brands</em> table both to the <em class="calibre5">Product</em> table (using the brand as a filter) and to the <em class="calibre5">Date</em> table (using the year and the month). This can be accomplished in several ways, as shown in the next sections.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-251" class="calibre13">Transferring a filter using <em class="calibre5">TREATAS</em></h4>
<p class="edition">The first and best option is using <em class="calibre5">TREATAS</em> to move the filter from the <em class="calibre5">Advertised Brands</em> over to the other tables. As explained in <a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapters 10</a>, “<a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with the filter context</a>,” <a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">12</a>, “<a href="#calibre_link-17" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Working with tables</a>,” and <a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">13</a>, “<a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Authoring queries</a>,” <em class="calibre5">TREATAS</em> changes the data lineage of a table so that its content can be used as a filter on specific columns of the data model.</p>
<p class="edition"><em class="calibre5">Advertised Brands</em> has no relationships with any other table in the model. Thus, normally its content cannot be used as a filter. By using <em class="calibre5">TREATAS</em>, one can change the data lineage of <em class="calibre5">Advertised Brands</em> so that it can be used as a filter argument of <em class="calibre5">CALCULATE</em> and propagate its filter to the entire model. The following measure performs exactly this operation:</p>
<p class="codelink"><a href="#calibre_link-1279" id="calibre_link-2709" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Advertised Brand Sales TreatAs :=
VAR AdvertisedBrands =
    SUMMARIZE (
        'Advertised Brands',
<span type="pagebreak" id="calibre_link-1812"></span>        'Advertised Brands'[Brand],
        'Advertised Brands'[Calendar Year],
        'Advertised Brands'[Month]
    )
VAR FilterAdvertisedBrands =
    TREATAS (
        AdvertisedBrands,
        'Product'[Brand],
        'Date'[Calendar Year],
        'Date'[Month]
    )
VAR Result =
    CALCULATE ( [Sales Amount], KEEPFILTERS ( FilterAdvertisedBrands ) )
RETURN
    Result</pre></div>
<p class="edition"><em class="calibre5">SUMMARIZE</em> retrieves the brand, year, and month advertised. <em class="calibre5">TREATAS</em> receives this table and changes its lineage, so that it will filter the product brand and the year and month in <em class="calibre5">Date</em>. The resulting table in <em class="calibre5">FilterAdvertisedBrands</em> has the correct data lineage. Therefore, it filters the model showing only the brands in the year and month when they are being advertised.</p>
<p class="edition">It is important to note that <em class="calibre5">KEEPFILTERS</em> is required. Indeed, forgetting it means that <em class="calibre5">CALCULATE</em> will override the filter context on the brand, year, and month&mdash;and this is unwanted. The <em class="calibre5">Sales</em> table needs to receive both the filter coming from the visual (which might be filtering only one year or one brand) and the filter coming from the <em class="calibre5">Advertised Brands</em> table. Therefore, <em class="calibre5">KEEPFILTERS</em> is mandatory to obtain a correct result.</p>
<p class="edition">This version of the code is much better than the one using the iteration. It uses the <em class="calibre5">Sales Amount</em> measure, thus avoiding the need to rewrite its code, and it does not iterate over the <em class="calibre5">Sales</em> table to perform the lookup. This code only scans the <em class="calibre5">Advertised Brands</em> table, which is expected to be on the smaller side; it then applies the filter to the model prior to calling the <em class="calibre5">Sales Amount</em> measure. Even though this version might be less intuitive, it performs much better than the example based on <em class="calibre5">CONTAINS</em> shown in the previous section.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-252" class="calibre13">Transferring a filter using <em class="calibre5">INTERSECT</em></h4>
<p class="edition">Another option to obtain the same result is to use the <em class="calibre5">INTERSECT</em> function. Compared to the previous example using <em class="calibre5">TREATAS</em>, the logic is similar; performance-wise there is a small difference in favor of the <em class="calibre5">TREATAS</em> version, which is still the best option. The following code implements the technique based on <em class="calibre5">INTERSECT</em>:</p>
<p class="codelink"><a href="#calibre_link-1280" id="calibre_link-2710" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Advertised Brand Sales Intersect :=
VAR SelectedBrands =
    SUMMARIZE (
        Sales,
        'Product'[Brand],
        'Date'[Calendar Year],
        'Date'[Month]
    )
<span type="pagebreak" id="calibre_link-1813"></span>VAR AdvertisedBrands =
    SUMMARIZE (
        'Advertised Brands',
        'Advertised Brands'[Brand],
        'Advertised Brands'[Calendar Year],
        'Advertised Brands'[Month]
    )
VAR Result =
    CALCULATE (
        [Sales Amount],
        INTERSECT (
            SelectedBrands,
            AdvertisedBrands
        )
    )
RETURN
    Result</pre></div>
<p class="edition"><em class="calibre5">INTERSECT</em> retains the data lineage of the first table it receives. Therefore, the resulting table is still a table that can filter <em class="calibre5">Product</em> and <em class="calibre5">Date</em>. This time, <em class="calibre5">KEEPFILTERS</em> is not needed because the first <em class="calibre5">SUMMARIZE</em> already only contains the visible brands and months; <em class="calibre5">INTERSECT</em> only removes from this list the ones that are not being advertised.</p>
<p class="edition">From a performance point of view, this code requires a scan of the <em class="calibre5">Sales</em> table to produce the list of existing brands and months, plus another scan to compute the sales amount. Therefore, it is slower than the version using <em class="calibre5">TREATAS</em>. But it is worth learning this technique because it might be useful in other scenarios involving other set functions, like <em class="calibre5">UNION</em> and <em class="calibre5">EXCEPT</em>. The set functions in DAX can be combined to create filters, authoring powerful measures in a relatively simple way.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-253" class="calibre13">Transferring a filter using <em class="calibre5">FILTER</em></h4>
<p class="edition">A third alternative is available to the DAX developer: using <em class="calibre5">FILTER</em> and <em class="calibre5">CONTAINS</em>. The code is similar to the first version with <em class="calibre5">SUMX</em>&mdash;the main differences being that it uses <em class="calibre5">CALCULATE</em> instead of <em class="calibre5">SUMX</em>, and it avoids iterating over the <em class="calibre5">Sales</em> table. The following code implements this alternative:</p>
<p class="codelink"><a href="#calibre_link-1281" id="calibre_link-2711" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Advertised Brand Sales Contains :=
VAR SelectedBrands =
    SUMMARIZE (
        Sales,
        'Product'[Brand],
        'Date'[Calendar Year],
        'Date'[Month]
    )
VAR FilterAdvertisedBrands =
    FILTER (
        SelectedBrands,
        CONTAINS (
            'Advertised Brands',
            'Advertised Brands'[Brand], 'Product'[Brand],
            'Advertised Brands'[Calendar Year], 'Date'[Calendar Year],
            'Advertised Brands'[Month], 'Date'[Month]
<span type="pagebreak" id="calibre_link-1814"></span>        )
    )
VAR Result =
    CALCULATE (
        [Sales Amount],
        FilterAdvertisedBrands
    )
RETURN
    Result</pre></div>
<p class="edition">The <em class="calibre5">FILTER</em> function used as a filter argument to <em class="calibre5">CALCULATE</em> uses the same <em class="calibre5">CONTAINS</em> technique used in the first example. This time, instead of iterating <em class="calibre5">Sales</em>, it iterates over the result of <em class="calibre5">SUMMARIZE</em>. As explained in <a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a>, “<a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Advanced DAX concepts</a>,” using the <em class="calibre5">Sales</em> table as a filter argument in <em class="calibre5">CALCULATE</em> would be wrong because of the expanded table. Therefore, filtering only three columns is a better approach. The result of <em class="calibre5">SUMMARIZE</em> already has the correct data lineage; moreover, <em class="calibre5">KEEPFILTERS</em> is not required because <em class="calibre5">SUMMARIZE</em> already only retains the existing values for brand, year, and month.</p>
<p class="edition">Performance-wise this is the worst solution among the last three, even though it is faster than the original code based on <em class="calibre5">SUMX</em>. Moreover, all the solutions based on <em class="calibre5">CALCULATE</em> share the significant advantage that they do not need to duplicate the business logic of the calculation included in the <em class="calibre5">Sales Amount</em> measure, as our first trial with <em class="calibre5">SUMX</em> did.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-254" class="calibre13">Implementing dynamic segmentation using virtual relationships</h4>
<p class="edition">In all the variations demonstrated earlier, we used DAX code to compute values and transfer a filter in absence of a relationship, though it would have been possible to create a physical relationship modifying the data model. However, there are scenarios where the relationship cannot be created in any way, like the one described in this section.</p>
<p class="edition">The virtual relationship solves a variation of the static segmentation learned earlier in this chapter. In the static segmentation, we assigned each sale to a specific segment using a calculated column. In dynamic segmentation, the assignment occurs dynamically; also, it is not based on a column like the net price but rather on a calculation like the sales amount. The dynamic segmentation must have a filter target: In this example, the segmentation filters customers based on the <em class="calibre5">Sales Amount</em> measure.</p>
<p class="edition">The configuration table contains the segment names and their boundaries, as shown in <a href="#calibre_link-1282" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-6</a>.</p>
<figure id="calibre_link-1282" class="image-l">
<img src="images/000503.jpg" alt="The table shows MinSale and MaxSale per segment." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-6</strong> Configuration table for dynamic segmentation.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3157"></span>If a customer spends between 75 and 100 USD in one sale, then they are assigned to the Low segment as per the configuration table. One important detail about dynamic segmentation is that the value of the measure depends on the user selection in the report. For example, if a user selects one color, then the assignment of a customer to a segment must be executed only considering the sales of products of that given color. Because of this dynamic calculation, using a relationship is not an option. Consider the following report in <a href="#calibre_link-1283" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-7</a> that shows how many customers belong to each segment every year, only filtering a selection of categories.</p>
<figure id="calibre_link-1283" class="image-l">
<img src="images/000510.jpg" alt="In this report we see that the numbers for each segment are variable from one calendar year to the next, considering two categories." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-7</strong> Each customer is assigned a segment, possibly a different one every year.</figcaption>
</figure>
<p class="edition">One customer might belong to different segments over the years. One customer can be in the Very Low segment in 2008 and then move to the Medium segment the next year. Moreover, by changing the selection on the categories, all the numbers must be updated accordingly.</p>
<p class="edition">In other words, a user browsing the model has the perception that a relationship is indeed present, meaning that each customer is uniquely assigned to one segment. However, this assignment cannot be made by using a physical relationship. The reason is that the same customer can be assigned to different segments in different cells of the report. In this scenario, DAX is the only way to solve the problem.</p>
<p class="edition">The measure to compute is the number of customers belonging to a specific segment. In other words, the measure counts how many customers belong to a segment considering all the filters in the current filter context. The formula looks simple, and yet its behavior requires a little clarification:</p>
<p class="codelink"><a href="#calibre_link-1284" id="calibre_link-2712" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CustInSegment :=
SUMX (
    Segments,
    COUNTROWS (
        FILTER (
            Customer,
            VAR SalesOfCustomer = [Sales Amount]
            VAR IsCustomerInSegment =
                AND (
                    SalesOfCustomer &gt; Segments[MinSale],
                    SalesOfCustomer &lt;= Segments[MaxSale]
                )
            RETURN
                IsCustomerInSegment
        )
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3158"></span>Apart from the grand total, every row of the report in <a href="#calibre_link-1283" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-7</a> has a filter context filtering one segment only. Thus, <em class="calibre5">SUMX</em> iterates only one row. <em class="calibre5">SUMX</em> is useful to make it easy to retrieve the segment boundaries (<em class="calibre5">MinSale</em> and <em class="calibre5">MaxSale</em>) and to correctly compute the total in the presence of filters. Inside <em class="calibre5">SUMX</em>, <em class="calibre5">COUNTROWS</em> counts the number of customers whose sales (saved in the <em class="calibre5">SalesOfCustomer</em> variable for performance reasons) fall between the boundaries of the current segment.</p>
<p class="edition">The resulting measure is additive against segments and customers, and nonadditive against all other filters. You can note that in the first row of the report, the Total result 213 is lower than the sum of the three years, which is 214. The reason is that at the Total level, the formula counts the number of customers that are in the Very Low segment over the three years. It appears that one of those customers bought enough products in three years to be moved to the next segment at the total level.</p>
<p class="edition">Though it is somewhat counterintuitive, the nonadditive behavior over time is a good feature. Indeed, to make it additive over the years, one would need to update the formula to include the time as part of the calculation. For instance, the following version of the code is additive over time. Yet, it is less powerful because one can no longer produce meaningful results if the year is not part of the report:</p>
<p class="codelink"><a href="#calibre_link-1285" id="calibre_link-2713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CustInSegment Additive :=
SUMX (
    VALUES ( 'Date'[Calendar Year] ),
    SUMX (
        Segments,
        COUNTROWS (
            FILTER (
                Customer,
                VAR SalesOfCustomer = [Sales Amount]
                VAR IsCustomerInSegment =
                    AND (
                        SalesOfCustomer &gt; Segments[MinSale],
                        SalesOfCustomer &lt;= Segments[MaxSale]
                    )
                RETURN
                    IsCustomerInSegment
            )
        )
    )
)</pre></div>
<p class="edition">As shown in <a href="#calibre_link-1286" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-8</a>, the rows now sum up correctly in the Total column, even though the Grand Total&mdash;that is, the total of all years and segments&mdash;might be inaccurate.</p>
<figure id="calibre_link-1286" class="image-l">
<img src="images/000517.jpg" alt="The report is similar to the previous report, with different total values." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-8</strong> Now the rows sum up correctly, but the column total might be inaccurate.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1890"></span>The problem is that by obtaining the correct sum for one segment, one needs to sacrifice the grand total cumulating multiple segments and years. For example, one customer might be in the Very Low cluster in 2009 and in the Very High cluster in 2008; therefore, in the Grand Total they would be counted twice. The Grand Total shown in <a href="#calibre_link-1286" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-8</a> is 1,472, whereas the total number of customers is 1,437 as reported accurately in <a href="#calibre_link-1283" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-7</a>.</p>
<p class="edition">Unfortunately with these kinds of calculations, additivity is more of a problem than a feature. By nature these calculations are nonadditive. Trying to make them additive might be appealing at first sight, but it is likely to produce misleading results. Therefore, it is always important to pay attention to these details, and our suggestion is to not force a measure to be additive without carefully considering the implications of that choice.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-255" class="h2a">Understanding physical relationships in DAX</h3>
<p class="edition">A relationship can be <em class="calibre5">strong</em> or <em class="calibre5">weak</em>. In a <em class="calibre5">strong</em> relationship the engine knows that the one-side of the relationship contains unique values. If the engine cannot check that the one-side of the relationship contains unique values for the key, then the relationship is <em class="calibre5">weak</em>. A relationship can be weak because either the engine cannot ensure the uniqueness of the constraint, due to technical reasons we outline later in this section, or the developer defined it as such. A weak relationship is not used as part of table expansion described in <a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a>.</p>
<p class="edition">Starting from 2018, Power BI allows composite models. In a composite model it is possible to create tables in a model containing data in both VertiPaq mode (a copy of data from the data source is preloaded and cached in memory) and in DirectQuery mode (the data source is accessed only at query time). DirectQuery and VertiPaq engines are explained in <a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 17</a>, “<a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">The DAX engines</a>.”</p>
<p class="edition">A single data model can contain some tables stored in VertiPaq and some others stored in DirectQuery. Moreover, tables in DirectQuery can originate from different data sources, generating several DirectQuery data islands.</p>
<p class="edition">In order to differentiate between data in VertiPaq and data in DirectQuery, we talk about data in the <em class="calibre5">continent</em> (VertiPaq) or in the <em class="calibre5">islands</em> (DirectQuery data sources), as depicted in <a href="#calibre_link-1287" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-9</a>.</p>
<figure id="calibre_link-1287" class="image-l">
<img src="images/000524.jpg" alt="The figure shows one continent with some tables, two islands with some other tables, and relationships between tables both in the continent, in the islands, and between tables in different islands." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-9</strong> A composite model contains tables in different islands.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1867"></span>The VertiPaq store is nothing but another data island. We call it the continent only because it is the most frequently used data island.</p>
<p class="edition">A relationship links two tables. If both tables belong to the same island, then the relationship is an intra-island relationship. If the two tables belong to different islands, then it is a cross-island relationship. Cross-island relationships are always weak relationships. Therefore, table expansion never crosses islands.</p>
<p class="edition">Relationships have a cardinality, of which there are three types. The difference between them is both technical and semantical. Here we do not cover the reasoning behind those relationships because it would involve many data modeling digressions that are outside of the scope of the book. Instead, we need to cover the technical details of physical relationships and the impact they have on the DAX code.</p>
<p class="edition">These are the three types of relationship cardinality available:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">One-to-many relationships:</strong> This is the most common type of relationship cardinality. On the one-side of the relationship the column must have unique values; on the many-side the value can (and usually does) contain duplicates. Some client tools differentiate between one-to-many relationships and many-to-one relationships. Still, they are the same type of relationship. It all depends on the order of the tables: a one-to-many relationship between <em class="calibre5">Product</em> and <em class="calibre5">Sales</em> is the same as a many-to-one relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em>.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">One-to-one relationships:</strong> This is a rather uncommon type of relationship cardinality. On both sides of the relationship the columns need to have unique values. A more accurate name would be “zero-or-one”-to-“zero-or-one” relationship because the presence of a row in one table does not imply the presence of a corresponding row in the other table.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Many-to-many relationships:</strong> On both sides of the relationship the columns can have duplicates. This feature was introduced in 2018, and unfortunately its name is somewhat confusing. Indeed, in common data modeling language “many-to-many” refers to a different kind of implementation, created by using pairs of one-to-many and many-to-one relationships. It is important to understand that in this scenario many-to-many does not refer to the many-to-many relationship but, instead, to the many-to-many cardinality of the relationship.</p></li>
</ul>
<p class="edition">In order to avoid ambiguity between the canonical terminology, which uses many-to-many for a different kind of implementation, we use acronyms to describe the cardinality of a relationship:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">One-to-many relationship: We call them <strong class="calibre7">SMR</strong>, which stands for Single-Many-Relationship.</p></li>
<li class="calibre10"><p class="listp">One-to-one relationship : We use the acronym <strong class="calibre7">SSR</strong>, which stands for Single-Single-Relationship.</p></li>
<li class="calibre10"><p class="listp">Many-to-many relationship: We call them <strong class="calibre7">MMR</strong>, which stands for Many-Many-Relationship.</p></li>
</ul>
<p class="edition">Another important detail is that an MMR relationship is always weak, regardless of whether the two tables belong to the same island or not. If the developer defines both sides of the relationship as the many-side, then the relationship is automatically treated as a weak relationship, with no table expansion happening.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1750"></span>In addition, each relationship has a cross-filter direction. The cross-filter direction is the direction used by the filter context to propagate its effect. The cross-filter can be set to one of two values:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Single:</strong> The filter context is always propagated in one direction of the relationship and not the other way around. In a one-to-many relationship, the direction is always from the one-side of the relationship to the many-side. This is the standard and most desirable behavior.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Both:</strong> The filter context is propagated in both directions of the relationship. This is also called a <strong class="calibre7">bidirectional cross-filter</strong> and sometimes just a bidirectional relationship. In a one-to-many relationship, the filter context still retains its feature of propagating from the one-side to the many-side, but it also propagates from the many-side to the one-side.</p></li>
</ul>
<p class="edition">The cross-filter directions available depend on the type of relationship.</p>
<ul class="sq">
<li class="calibre10"><p class="listp">In an <strong class="calibre7">SMR</strong> relationship one can always choose single or bidirectional.</p></li>
<li class="calibre10"><p class="listp">An <strong class="calibre7">SSR</strong> relationship always uses bidirectional filtering. Because both sides of the relationship are the one-side and there is no many-side, bidirectional filtering is the only option available.</p></li>
<li class="calibre10"><p class="listp">In an <strong class="calibre7">MMR</strong> relationship both sides are the many-side. This scenario is the opposite of the SSR relationship: Both sides can be the source and the target of a filter context propagation. Thus, one can choose the cross-filter direction to be bidirectional, in which case the propagation always goes both ways. Or if the developer chooses single propagation, they also must choose which table to start the filter propagation from. As with all other relationships, single propagation is the best practice. Later in this chapter we expand on this topic.</p></li>
</ul>
<p class="edition"><a href="#calibre_link-1288" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 15-1</a> summarizes the different types of relationships with the available cross-filter directions, their effect on the filter context propagation, and the options for weak/strong relationship.</p>
<p class="edition" id="calibre_link-1288"><strong class="calibre7">Table 15-1</strong> Different types of relationships</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Type of Relationship</p></th>
<th class="th"><p class="tab-text">Cross-filter Direction</p></th>
<th class="th"><p class="tab-text">Filter Context Propagation</p></th>
<th class="th"><p class="tab-text">Weak / Strong Type</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">SMR</p></td>
<td class="th1"><p class="tab-text">Single</p></td>
<td class="th1"><p class="tab-text">From the one side to the many side</p></td>
<td class="th1"><p class="tab-text">Weak if cross-island, strong otherwise</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">SMR</p></td>
<td class="th1"><p class="tab-text">Both</p></td>
<td class="th1"><p class="tab-text">Bidirectional</p></td>
<td class="th1"><p class="tab-text">Weak if cross-island, strong otherwise</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">SSR</p></td>
<td class="th1"><p class="tab-text">Both</p></td>
<td class="th1"><p class="tab-text">Bidirectional</p></td>
<td class="th1"><p class="tab-text">Weak if cross-island, strong otherwise</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">MMR</p></td>
<td class="th1"><p class="tab-text">Single</p></td>
<td class="th1"><p class="tab-text">Must choose the source table</p></td>
<td class="th1"><p class="tab-text">Always weak</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">MMR</p></td>
<td class="th1"><p class="tab-text">Both</p></td>
<td class="th1"><p class="tab-text">Bidirectional</p></td>
<td class="th1"><p class="tab-text">Always weak</p></td>
</tr>
</tbody>
</table>
<p class="edition">When two tables are linked through a strong relationship, the table on the one-side might contain the additional blank row in case the relationship is invalid. Thus, if the many-side of a strong relationship contains values not present in the table on the one-side, then a blank row is appended to the one-side table. This was further explained in <a href="#calibre_link-8" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 3</a>. The additional blank row is never added to a weak relationship.</p>
<p class="edition">As explained earlier, we are not going to discuss why one would choose one type of relationship over another. The choice between different types of relationships and filter propagation is in the hands <span type="pagebreak" id="calibre_link-1751"></span>of the data modeler; their decision flows from a deep reasoning on the semantics of the model itself. However, from a DAX point of view each relationship behaves differently, and it is important to understand the differences among the relationships and the impact they have on DAX code.</p>
<p class="edition">The next sections provide useful information about the differences between these types of relationships and several tips on which relationship to use in your models.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-256" class="h2a">Using bidirectional cross-filters</h3>
<p class="edition">Bidirectional cross-filters can be enabled in two ways: in the data model or by using the <em class="calibre5">CROSSFILTER</em> modifier in a <em class="calibre5">CALCULATE</em> function, as explained in <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>, “<a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em>.</a>” As a rule, a bidirectional cross-filter should not be enabled in the data model unless strictly needed. The reason is that bidirectional cross-filters quickly increase the complexity of the filter context propagation, up to a point where it is hard to predict and control how the filter context will propagate.</p>
<p class="edition">Nevertheless, there are scenarios where bidirectional cross-filtering is a useful feature. For example, look at the report in <a href="#calibre_link-1289" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-10</a>; it is built on top of the usual Contoso model with all relationships set to single cross-filter propagation.</p>
<figure id="calibre_link-1289" class="image-l">
<img src="images/000531.jpg" alt="In this report we see Sales Amount per CountryRegion, and there are more CountryRegions available in the slicer than returned in the matrix." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-10</strong> The <em class="calibre5">CountryRegion</em> slicer shows countries with no sales.</figcaption>
</figure>
<p class="edition">There are two slicers: <em class="calibre5">Brand</em>, which filters the <em class="calibre5">Product[Brand]</em> column; and <em class="calibre5">CountryRegion</em>, which filters the <em class="calibre5">Customer[CountryRegion]</em> column. Even though there are no sales for Northwind Traders in Armenia, the <em class="calibre5">CountryRegion</em> slicer shows Armenia as valid options to select.</p>
<p class="edition">The reason for this is that the filter context <em class="calibre5">on Product[Brand]</em> affects <em class="calibre5">Sales</em> because of the one-to-many relationship between <em class="calibre5">Product</em> and <em class="calibre5">Brand</em>. But then from <em class="calibre5">Sales</em>, the filter does not move to <em class="calibre5">Customer</em> because <em class="calibre5">Customer</em> is on the one-side of the one-to-many relationship between <em class="calibre5">Customer</em> and <em class="calibre5">Sales</em>. Therefore, the slicer shows all the possible values of <em class="calibre5">CountryRegion</em>. In other words, the two slicers are not in sync. The matrix does not show Armenia because the value of <em class="calibre5">Sales Amount</em> is a blank for this country, and by default a matrix does not show rows containing blank values from measures.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3159"></span>If slicer syncing is important, then it is possible to enable the bidirectional cross-filter between <em class="calibre5">Customer</em> and <em class="calibre5">Sales</em>, generating a model like the one in <a href="#calibre_link-1290" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-11</a>.</p>
<figure id="calibre_link-1290" class="image-l">
<img src="images/000538.jpg" alt="The figure shows a data model with relationships. The cross-filter direction of the relationship between Customer and Sales is set to bidirectional." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-11</strong> The cross-filter direction between <em class="calibre5">Customer</em> and <em class="calibre5">Sales</em> is now set to bidirectional.</figcaption>
</figure>
<p class="edition">Setting the cross-filter direction of the relationship to bidirectional ensures that the <em class="calibre5">CountryRegion</em> slicer only shows the rows that are referenced by <em class="calibre5">Sales</em>. <a href="#calibre_link-1291" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-12</a> shows that the slicers are now synced, improving user experience.</p>
<figure id="calibre_link-1291" class="image-l">
<img src="images/000545.jpg" alt="In this report, the CountryRegion slicer selection only consists of countries relevant to our analysis." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-12</strong> By enabling bidirectional cross-filter, the slicers are now synced.</figcaption>
</figure>
<p class="edition">Bidirectional filtering is convenient, but it comes at a price. First, from a performance point of view, the bidirectional cross-filter slows down the model because the filter context must be propagated to both sides of the relationship. It is much faster to filter the many-side starting from the one-side rather than going in the opposite direction. Thus, with the goal of optimal performance in mind, bidirectional cross-filtering is one of the features to avoid. Moreover, bidirectional cross-filters increase chances to generate ambiguous data models. We discuss ambiguity later in this chapter.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span type="pagebreak" id="calibre_link-1752"></span><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Using visual level filters, it is possible to reduce the members visible in a Power BI visual without using the bidirectional filter in a relationship. Unfortunately, visual level filters are not supported for slicers in Power BI as of April 2019. Once visual level filters will also be available for slicers, using bidirectional filters will be no longer necessary to reduce the members visible in a slicer.</p>
</div>
</section>
<section class="calibre4">
<h3 id="calibre_link-257" class="h2a">Understanding one-to-many relationships</h3>
<p class="edition">One-to-many relationships are the most common and desirable type of relationships in a data model. For example, a one-to-many relationship relates <em class="calibre5">Product</em> with <em class="calibre5">Sales</em>. Given one product there can be many sales related to it, whereas for one given sale there is only one product. Consequently, <em class="calibre5">Product</em> is on the one-side and <em class="calibre5">Sales</em> is on the many-side.</p>
<p class="edition">Moreover, when analyzing data, users expect to be able to slice by a product attribute and compute values from <em class="calibre5">Sales</em>. Therefore, the default behavior is that a filter on <em class="calibre5">Product</em> (one-side) is propagated to <em class="calibre5">Sales</em> (many-side). If needed, one can change this behavior by enabling a bidirectional cross-filter in the relationship.</p>
<p class="edition">With strong one-to-many relationships, table expansion always goes towards the one-side. Moreover, in case the relationship is invalid, the table sitting on the one-side of the relationship might receive the blank row. Semantically, weak one-to-many relationships behave the same, except from the blank row. Performance-wise, weak one-to-many relationships generally generate slower queries.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-258" class="h2a">Understanding one-to-one relationships</h3>
<p class="edition">One-to-one relationships are quite uncommon in data models. Two tables linked through a one-to-one relationship are really just the same table split into two. In a well-designed model, these two tables would have been joined together before being loaded into the data model.</p>
<p class="edition">Therefore, the best way to handle one-to-one relationships is to avoid them by merging the two tables into a single table. One exception to this best practice is when data is going into one same business entity from different data sources that must be refreshed independently. In those cases, one might prefer to import two separate tables into the data model, avoiding complex and expensive transformations during the refresh operation. In any case, when handling one-to-one relationships, users need to pay attention to the following details:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The cross-filter direction is always bidirectional. One cannot set the cross-filter direction to single on a one-to-one relationship. Thus, a filter on one of the two tables is always propagated to the other table, unless the relationship is deactivated&mdash;either by using <em class="calibre5">CROSSFILTER</em> or in the model.</p></li>
<li class="calibre10"><p class="listp">From a table expansion point of view, as described in <a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a> in a strong one-to-one relationship each table expands the other table that is part of that relationship. In other words, a strong one-to-one relationship produces two identical expanded tables.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-1769"></span>Because both sides of the relationship are on the one-side, if the relationship is both strong and invalid&mdash;that is, there are values for the key in one table that are not matched in the other&mdash;then both tables might contain the blank row. Moreover, the values of the column used for the relationship need to be unique in both tables.</p></li>
</ul>
</section>
<section class="calibre4">
<h3 id="calibre_link-259" class="h2a">Understanding many-to-many relationships</h3>
<p class="edition">Many-to-many relationships are an extremely powerful modeling tool, and they appear much more often than one-to-one relationships. Handling them correctly is not trivial, yet it is useful to master them because of their analytical power.</p>
<p class="edition">A many-to-many relationship is present in a model whenever two entities cannot be related through a simple one-to-many relationship. There are two different types of many-to-many relationships, and several ways to solve the two scenarios. The next sections present several techniques to manage many-to-many relationships.</p>
<section class="calibre4">
<h4 id="calibre_link-260" class="calibre13">Implementing many-to-many using a bridge table</h4>
<p class="edition">The following example comes from a banking scenario. The bank stores accounts in one table and customers in a different table. One account can be owned by multiple customers, while one customer may own multiple accounts. Therefore, it is not possible to store the customer name in the account, and at the same time it is not possible to store the account number in the customer table. This scenario cannot be modeled by using regular relationships between accounts and customers.</p>
<p class="edition">The canonical solution to this scenario is to build a table to store the relationship between customers and accounts. This is called a bridge table, and is shown in the model in <a href="#calibre_link-1292" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-13</a>.</p>
<figure id="calibre_link-1292" class="image-l">
<img src="images/000553.jpg" alt="The model shows the AccountsCustomers bridge table between Accounts and Customers." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-13</strong> The <em class="calibre5">AccountsCustomers</em> table is related to both <em class="calibre5">Accounts</em> and <em class="calibre5">Customers</em>.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3160"></span>In this model, the many-to-many relationship between <em class="calibre5">Account</em> and <em class="calibre5">Customers</em> is implemented through the bridge table called <em class="calibre5">AccountsCustomers</em>. A row in the bridge table indicates that one account is owned by one customer.</p>
<p class="edition">As it is now, the model is not working yet. Indeed, a report slicing by <em class="calibre5">Account</em> works well because <em class="calibre5">Accounts</em> filters <em class="calibre5">Transactions</em>, <em class="calibre5">Accounts</em> being on the one-side of a one-to-many relationship. On the other hand, slicing by <em class="calibre5">Customers</em> does not work because <em class="calibre5">Customers</em> filters <em class="calibre5">AccountsCustomers</em>, but then <em class="calibre5">AccountsCustomers</em> does not propagate the filter to <em class="calibre5">Accounts</em> because the cross-filter goes in the other direction. Moreover, this last relationship must have its one-side on the <em class="calibre5">Accounts</em> table because <em class="calibre5">AccountKey</em> has unique values in <em class="calibre5">Accounts</em> and contains duplicates in <em class="calibre5">AccountsCustomers</em>.</p>
<p class="edition"><a href="#calibre_link-1293" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-14</a> shows that the <em class="calibre5">CustomerName</em> values do not apply any kind of filter to the sum of <em class="calibre5">Amount</em> displayed in the matrix.</p>
<figure id="calibre_link-1293" class="image-l">
<img src="images/000560.jpg" alt="The report shows amounts on different accounts. Quite a few values do not make sense." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-14</strong> <em class="calibre5">Accounts</em> on rows filters the amount, whereas <em class="calibre5">Customers</em> on columns does not.</figcaption>
</figure>
<p class="edition">This scenario can be solved by enabling the bidirectional cross-filter in the relationship between <em class="calibre5">AccountsCustomers</em> and <em class="calibre5">Accounts</em>; this is achieved either by updating the data model or by using <em class="calibre5">CROSSFILTER</em> as in the following measure:</p>
<p class="codelink"><a href="#calibre_link-1294" id="calibre_link-2714" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">-- Version using CROSSFILTER
SumOfAmt CF :=
CALCULATE (
    SUM ( Transactions[Amount] ),
    CROSSFILTER (
        AccountsCustomers[AccountKey],
        Accounts[AccountKey],
        BOTH
    )
)</pre></div>
<p class="edition">Either way, the formula will now produce the expected result, as shown in <a href="#calibre_link-1295" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-15</a>.</p>
<figure id="calibre_link-1295" class="image-l">
<img src="images/000567.jpg" alt="This report only displays values that make sense." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3161"></span><strong class="calibre7">Figure 15-15</strong> By enabling the bidirectional cross-filter, the measure now returns the correct result.</figcaption>
</figure>
<p class="edition">Setting the bidirectional cross-filter in the data model has the advantage of ensuring that it is automatically applied to any calculation&mdash;also working on implicit measures generated by client tools such as Excel or Power BI. However, the presence of bidirectional cross-filters in a data model increases the complexity of the filter propagation and might have a negative impact on the performance of measures that should not be affected by said filter. Moreover, if new tables are later added to the data model, the presence of the bidirectional cross-filter might generate ambiguities that require a change in the cross-filter. This could potentially break other, pre-existing reports. For these reasons, before enabling bidirectional cross-filters on a relationship, one should think twice and carefully check that the model is still sound.</p>
<p class="edition">You are of course free to use bidirectional cross-filter in your models. But for all the reasons described in the book, our personal attitude is to never enable bidirectional cross-filter on a relationship. Because we love simplicity and sound models, we strongly prefer the <em class="calibre5">CROSSFILTER</em> solution applied to every measure. Performance-wise, enabling the bidirectional cross-filter in the data model or using <em class="calibre5">CROSSFILTER</em> in DAX is identical.</p>
<p class="edition">Another way of achieving our goal is by using more complex DAX code. Despite its complexity, that code also brings an increased level of flexibility. One option to author the <em class="calibre5">SumOfAmt</em> measure without using <em class="calibre5">CROSSFILTER</em> is to rely on <em class="calibre5">SUMMARIZE</em> and use it as a <em class="calibre5">CALCULATE</em> filter argument:</p>
<p class="codelink"><a href="#calibre_link-1296" id="calibre_link-2715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">-- Version using SUMMARIZE
SumOfAmt SU :=
CALCULATE (
    SUM ( Transactions[Amount] ),
    SUMMARIZE (
        AccountsCustomers,
        Accounts[AccountKey]
    )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3162"></span><em class="calibre5">SUMMARIZE</em> returns a column with the data lineage of <em class="calibre5">Accounts[AccountKey]</em>, actively filtering the <em class="calibre5">Accounts</em> and then the <em class="calibre5">Transactions</em> table. Another way of obtaining a similar result is by using <em class="calibre5">TREATAS</em>:</p>
<p class="codelink"><a href="#calibre_link-1297" id="calibre_link-2716" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">-- Version using TREATAS
SumOfAmt TA :=
CALCULATE (
    SUM ( Transactions[Amount] ),
    TREATAS (
        VALUES ( AccountsCustomers[AccountKey] ),
        Accounts[AccountKey]
    )
)</pre></div>
<p class="edition">Also in this case, <em class="calibre5">VALUES</em> returns the values of <em class="calibre5">AccountsCustomers[AccountKey]</em> filtered by the <em class="calibre5">Customers</em> table, and <em class="calibre5">TREATAS</em> changes the data lineage to make it filter the <em class="calibre5">Accounts</em> and then the <em class="calibre5">Transactions</em> table.</p>
<p class="edition">Lastly, an even simpler formulation of the same expression is to use table expansion. Noting that the bridge table expands to both the <em class="calibre5">Customers</em> and the <em class="calibre5">Accounts</em> tables, the following code produces almost the same result as the previous ones. It is, however, noticeably shorter:</p>
<p class="codelink"><a href="#calibre_link-1298" id="calibre_link-2717" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">-- Version using Expanded Table
SumOfAmt ET :=
CALCULATE (
    SUM ( Transactions[Amount] ),
    AccountsCustomers
)</pre></div>
<p class="edition">Despite the many variations, all these solutions can be grouped into two options:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Using the bidirectional cross-filter feature of DAX.</p></li>
<li class="calibre10"><p class="listp">Using a table as a filter argument in <em class="calibre5">CALCULATE</em>.</p></li>
</ul>
<p class="edition">These two groups behave differently if the relationship between <em class="calibre5">Transactions</em> and <em class="calibre5">Accounts</em> is invalid. Indeed, if a relationship is invalid, the table on the one-side of the relationship contains an additional blank row. In case the <em class="calibre5">Transactions</em> table relates to accounts that are not available in the <em class="calibre5">Accounts</em> table, the relationship between <em class="calibre5">Transactions</em> and <em class="calibre5">Accounts</em> is invalid and the blank row is added to the <em class="calibre5">Accounts</em> table. This effect does not propagate to <em class="calibre5">Customers</em>. Therefore, in this case the <em class="calibre5">Customers</em> table has no blank row, and only the <em class="calibre5">Accounts</em> table has one blank row.</p>
<p class="edition">Consequently, slicing <em class="calibre5">Transactions</em> by <em class="calibre5">Account</em> shows the blank row, whereas slicing <em class="calibre5">Transactions</em> by <em class="calibre5">CustomerName</em> does not show transactions linked to the blank row. This behavior might be confusing; to demonstrate the behavior, we added a row to the <em class="calibre5">Transactions</em> table with an invalid <em class="calibre5">AccountKey</em> and a value of 10,000.00. The different results are visible in <a href="#calibre_link-1299" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-16</a>, where the matrix on the left slices by <em class="calibre5">Account</em> and the matrix on the right slices by <em class="calibre5">CustomerName</em>. The measure shown is the one using <em class="calibre5">CROSSFILTER</em>.</p>
<figure id="calibre_link-1299" class="image-l">
<img src="images/000574.jpg" alt="Only the matrix on the left-hand side contains a blank row." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3163"></span><strong class="calibre7">Figure 15-16</strong> <em class="calibre5">CustomerName</em> does not contain a blank row; consequently, the total on the right looks wrong.</figcaption>
</figure>
<p class="edition">When the matrix is slicing by <em class="calibre5">Account</em>, the blank row is present and the value of 10,000.00 is visible. When the matrix is slicing by <em class="calibre5">CustomerName</em>, there is no blank row to show. The filter starts from the <em class="calibre5">CustomerName</em> column in the <em class="calibre5">Customers</em> table, but there are no values in <em class="calibre5">AccountsCustomers</em> that can include in the filter the blank row in <em class="calibre5">Accounts</em>. The value related to the blank row is only visible at the grand total because the filter on <em class="calibre5">CustomerName</em> is no longer present there. Consequently, at the grand total level the <em class="calibre5">Accounts</em> table is no longer cross-filtered; all the rows of <em class="calibre5">Accounts</em> become active, including the blank row, and 15,000.00 is displayed as a result.</p>
<p class="edition">Be mindful that we are using the blank row as an example, but the same scenario would happen whenever there are accounts that are not linked to any customer. Starting the filter from the customer, their value will not show up other than on the grand total. The reason is that the filter on the customer removes accounts not linked to any customer from any row. This consideration is important because the behavior observed in <a href="#calibre_link-1299" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-16</a> is not necessarily related to the presence of an invalid relationship. For example, if the transaction with the value of 10,000.00 were related to a Service account defined in the <em class="calibre5">Accounts</em> table but not related to any <em class="calibre5">Customer</em>, the <em class="calibre5">Account</em> name would be visible in the report&mdash;despite the fact that this value still would not be related to any single customer. This is shown in <a href="#calibre_link-1300" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-17</a>.</p>
<figure id="calibre_link-1300" class="image-l">
<img src="images/000581.jpg" alt="The figure shows the same matrices as earlier, but this time on the left-hand side the blank row was replaced by the name Service." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-17</strong> The value related to the Service account does not appear related to any single <em class="calibre5">CustomerName</em>.</figcaption>
</figure>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span type="pagebreak" id="calibre_link-1770"></span><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The scenario depicted in <a href="#calibre_link-1300" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-17</a> does not violate any referential integrity constraints in a relational database, as was the case in <a href="#calibre_link-1299" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-16</a>. Thus, validating data making sure that this condition is not present requires additional validation logic in the relational database.</p>
</div>
<p class="edition">If, instead of using the <em class="calibre5">CROSSFILTER</em> technique, we rely on table filtering in <em class="calibre5">CALCULATE</em>, then the behavior is different. The rows that are not reachable from the bridge table are always filtered out. Because the filter is always forced by <em class="calibre5">CALCULATE</em>, they will not show even at the grand total level. In other words, the filter is always forced to be active. You can look at the result in <a href="#calibre_link-1301" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-18</a>.</p>
<figure id="calibre_link-1301" class="image-l">
<img src="images/000588.jpg" alt="This time, the 10,000.00 amount is nowhere to be found, and even the grand total does not take it into account." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-18</strong> Using the table filter technique, the blank row disappears everywhere and is not included in the total.</figcaption>
</figure>
<p class="edition">Not only does the total now show a lower value; this time, even slicing by <em class="calibre5">Account</em> does not show the blank row anymore. The reason is that the blank row is filtered out by the table filter applied by <em class="calibre5">CALCULATE</em>.</p>
<p class="edition">Neither of these values is totally correct or totally wrong. Moreover, if the bridge table references all the rows in <em class="calibre5">Transactions</em> starting from <em class="calibre5">Customers</em>, then the two measures behave the same way. Developers should choose the technique that better fit their needs, paying attention to details and making sense of unexpected values, if any.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Performance-wise, the solutions based on using a table as a filter argument in <em class="calibre5">CALCULATE</em> always involve paying the price of scanning the bridge table (<em class="calibre5">AccountsCustomers</em>). This means that any report using the measure without a filter over <em class="calibre5">Customers</em> will pay the highest possible price, which is useless in case every account has at least one customer. Therefore, the solutions based on the bidirectional cross-filter should be the default choice whenever the data consistency guarantees the same result with both techniques. Moreover, remember that any solution involving table expansion works only with strong relationships. Therefore, the presence of weak relationships might force the solution in favor of the bidirectional cross-filter. More details about these considerations are available in the article at <a href="https://www.sqlbi.com/articles/many-to-many-relationships-in-power-bi-and-excel-2016/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.sqlbi.com/articles/many-to-many-relationships-in-power-bi-and-excel-2016/</a>.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-261" class="calibre13"><span type="pagebreak" id="calibre_link-2089"></span>Implementing many-to-many using a common dimension</h4>
<p class="edition">There is another scenario where many-to-many is a useful tool, even though from a technical point of view it is not a many-to-many relationship. This scenario defines a relationship between two entities at a granularity different from the primary key.</p>
<p class="edition">The example comes from a budgeting scenario, where the budget information is stored in a table containing the country, the brand, and the budget for the one year. The model is visible in <a href="#calibre_link-1302" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-19</a>.</p>
<figure id="calibre_link-1302" class="image-l">
<img src="images/000595.jpg" alt="The figure shows the data model." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-19</strong> The <em class="calibre5">Budget</em> table contains <em class="calibre5">CountryRegion</em>, <em class="calibre5">Brand</em>, and <em class="calibre5">Budget</em> columns.</figcaption>
</figure>
<p class="edition">If the requirement is to produce a report that shows the sales and the budget values side-by-side, then it is necessary to filter both the <em class="calibre5">Budget</em> table and the <em class="calibre5">Sales</em> table at the same time. The <em class="calibre5">Budget</em> table contains <em class="calibre5">CountryRegion</em>, which is also a column in <em class="calibre5">Customer</em>. However, the <em class="calibre5">CountryRegion</em> column is not unique&mdash;neither in the <em class="calibre5">Customer</em> table nor in the <em class="calibre5">Budget</em> table. Similarly, <em class="calibre5">Brand</em> is a column in <em class="calibre5">Product</em>, but it is also not unique in either table. One could author a <em class="calibre5">Budget Amt</em> measure that simply sums the <em class="calibre5">Budget</em> column of the <em class="calibre5">Budget</em> table.</p>
<div class="program"><pre class="calibre14">Budget Amt :=
SUM ( Budget[Budget] )</pre></div>
<p class="edition">A matrix slicing by <em class="calibre5">Customer[CountryRegion]</em> with this data model produces the result visible in <a href="#calibre_link-1303" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-20</a>. The <em class="calibre5">Budget Amt</em> measure always shows the same value, corresponding to the sum of all the rows in the <em class="calibre5">Budget</em> table.</p>
<figure id="calibre_link-1303" class="image-l">
<img src="images/000602.jpg" alt="The report shows Budget Amt and Sales in 2009 per CountryRegion." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3164"></span><strong class="calibre7">Figure 15-20</strong> <em class="calibre5">Budget Amt</em> is not filtered by <em class="calibre5">Customer[CountryRegion]</em> and always shows the same value.</figcaption>
</figure>
<p class="edition">There are several solutions to this scenario. One involves implementing a virtual relationship using one of the techniques previously shown in this chapter, moving the filter from one table to another. For example, by using <em class="calibre5">TREATAS</em>, one could move the filter from both the <em class="calibre5">Customer</em> and <em class="calibre5">Product</em> tables to the <em class="calibre5">Budget</em> table using this code:</p>
<p class="codelink"><a href="#calibre_link-1304" id="calibre_link-2718" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Budget Amt :=
CALCULATE (
    SUM ( Budget[Budget] ),
    TREATAS (
        VALUES ( Customer[CountryRegion] ),
        Budget[CountryRegion]
    ),
    TREATAS (
        VALUES ( 'Product'[Brand] ),
        Budget[Brand]
    )
)</pre></div>
<p class="edition">The <em class="calibre5">Budget Amt</em> measure now uses the filter coming from <em class="calibre5">Customer</em> and/or from <em class="calibre5">Product</em> properly, producing the correct result shown in <a href="#calibre_link-1305" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-21</a>.</p>
<figure id="calibre_link-1305" class="image-l">
<img src="images/000608.jpg" alt="In this report Budget Amt returns different amounts." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-21</strong> <em class="calibre5">Budget Amt</em> is now filtered by <em class="calibre5">Customer[CountryRegion]</em>.</figcaption>
</figure>
<p class="edition">This solution presents a couple of limitations:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">If a new brand exists in the <em class="calibre5">Budget</em> table and it is not present in the <em class="calibre5">Product</em> table, its value will always be filtered out. As a result, the figures of the budget will be inaccurate.</p></li>
<li class="calibre10"><p class="listp">Instead of using the most efficient technique of relying on physical relationships, the code is using DAX to move the filter. On large models, this might lead to bad performance.</p></li>
</ul>
<p class="edition"><span type="pagebreak" id="calibre_link-3165"></span>A better solution to this scenario is to slightly change the data model, adding a new table that acts as a filter on both the <em class="calibre5">Budget</em> and the <em class="calibre5">Customer</em> tables. This can be easily accomplished with a DAX calculated table:</p>
<p class="codelink"><a href="#calibre_link-1306" id="calibre_link-2719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">CountryRegions =
DISTINCT (
    UNION (
        DISTINCT ( Budget[CountryRegion] ),
        DISTINCT ( Customer[CountryRegion] )
    )
)</pre></div>
<p class="edition">This formula retrieves all the values of <em class="calibre5">CountryRegion</em> from both <em class="calibre5">Customer</em> and <em class="calibre5">Budget</em>, then it merges them into a single table that contains duplicates. Finally, the formula removes duplicates from the table. As a result, this new table contains all the values of <em class="calibre5">CountryRegion</em>, whether they come from <em class="calibre5">Budget</em> or from <em class="calibre5">Customer</em>. In a similar way, a table that links to <em class="calibre5">Product</em> and <em class="calibre5">Budget</em> is needed, following the same process for <em class="calibre5">Product[Brand]</em> and for <em class="calibre5">Budget[Brand]</em>.</p>
<p class="codelink"><a href="#calibre_link-1307" id="calibre_link-2720" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Brands =
DISTINCT (
    UNION (
        DISTINCT ( 'Product'[Brand] ),
        DISTINCT ( Budget[Brand] )
    )
)</pre></div>
<p class="edition">Once the table is in the data model, one then needs to create the proper set of relationships. The resulting model is visible in <a href="#calibre_link-1308" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-22</a>.</p>
<figure id="calibre_link-1308" class="image-l">
<img src="images/000616.jpg" alt="The figure shows the data model." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3166"></span><strong class="calibre7">Figure 15-22</strong> The data model contains two additional tables: <em class="calibre5">CountryRegions</em> and <em class="calibre5">Brands</em>.</figcaption>
</figure>
<p class="edition">With the new model in place, the <em class="calibre5">Brands</em> table filters both <em class="calibre5">Product</em> and <em class="calibre5">Budget</em>, whereas the new <em class="calibre5">CountryRegions</em> table filters both <em class="calibre5">Customer</em> and <em class="calibre5">Budget</em>. Thus, there is no need to use the <em class="calibre5">TREATAS</em> pattern shown in the previous example. A simple <em class="calibre5">SUM</em> computes the correct value from both <em class="calibre5">Budget</em> and <em class="calibre5">Sales</em> as shown in the following version of the <em class="calibre5">Budget Amt</em> measure. This does require using the columns from the <em class="calibre5">CountryRegions</em> and <em class="calibre5">Brands</em> tables in the report, which will appear as in <a href="#calibre_link-1305" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-21</a>.</p>
<div class="program"><pre class="calibre14">Budget Amt :=
SUM ( Budget[Budget] )</pre></div>
<p class="edition">By leveraging the bidirectional cross-filter between <em class="calibre5">Customer</em> and <em class="calibre5">CountryRegions</em> and between <em class="calibre5">Product</em> and <em class="calibre5">Brands</em>, it is possible to hide the <em class="calibre5">CountryRegions</em> and <em class="calibre5">Brands</em> tables in report view, moving the filter from <em class="calibre5">Customer</em> and <em class="calibre5">Product</em> to <em class="calibre5">Budget</em> without writing any additional DAX code. The resulting model shown in <a href="#calibre_link-1309" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-23</a> creates a logical relationship between <em class="calibre5">Customer</em> and <em class="calibre5">Budget</em> at the granularity of the <em class="calibre5">CountryRegion</em> column. The same happens between <em class="calibre5">Product</em> and <em class="calibre5">Budget</em> at the granularity of the <em class="calibre5">Brand</em> column.</p>
<figure id="calibre_link-1309" class="image-l">
<img src="images/000623.jpg" alt="The figure shows the data model with CountryRegions and Brands table hidden in report view." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-23</strong> Having enabled bidirectional cross-filtering, the technical tables can be hidden.</figcaption>
</figure>
<p class="edition">The result of the report produced by this model is identical to <a href="#calibre_link-1305" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-21</a>. The relationship between <em class="calibre5">Customer</em> and <em class="calibre5">Budget</em> is a sequence of a many-to-one and a one-to-many relationship. The bidirectional cross-filter between <em class="calibre5">Customer</em> and <em class="calibre5">CountryRegions</em> ultimately transfers the filter from <em class="calibre5">Customer</em> to <em class="calibre5">Budget</em> and not the other way around. If the bidirectional filter were also active between <span type="pagebreak" id="calibre_link-2090"></span><em class="calibre5">CountryRegions</em> and <em class="calibre5">Budget</em>, the model would have involved some level of ambiguity that would stop the creation of a similar pattern between <em class="calibre5">Product</em> and <em class="calibre5">Budget</em>.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The model in <a href="#calibre_link-1309" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-23</a> suffers from the same limitations as the model in <a href="#calibre_link-1302" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-19</a>: If there are brands or countries in the budget that are not defined in the <em class="calibre5">Customer</em> and <em class="calibre5">Product</em> tables, that budget value might disappear in the report. This problem is described in more detail in the next section.</p>
</div>
<p class="edition">Be mindful that technically, this is not a many-to-many pattern. In this model we are linking <em class="calibre5">Product</em> to <em class="calibre5">Budget</em> (same for <em class="calibre5">Customer</em>) using a granularity that is not the individual product. Instead, we are linking the two tables at the granularity level of <em class="calibre5">Brand</em>. The same operation can be achieved in a simpler&mdash;though less effective&mdash;way by using weak relationships, as described in the next section. Moreover, linking tables at different granularity conceals several complex aspects that are discussed later in this chapter.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-262" class="calibre13">Implementing many-to-many using MMR weak relationships</h4>
<p class="edition">In the previous example we linked <em class="calibre5">Products</em> to <em class="calibre5">Budget</em> by using an intermediate&mdash;ad hoc&mdash;table. DAX versions from after October 2018 introduced the feature of weak relationships, which addresses the same scenario in a more automated way.</p>
<p class="edition">One can create an MMR weak relationship between two tables in case the two columns involved in the relationship have duplicates in both tables. In other words, the same model shown in <a href="#calibre_link-1309" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-23</a> can be created by directly linking <em class="calibre5">Budget</em> to <em class="calibre5">Product</em> using the <em class="calibre5">Product[Brand]</em> column, avoiding the creation of the intermediate <em class="calibre5">Brands</em> table used in the previous section. The resulting model is visible in <a href="#calibre_link-1310" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-24</a>.</p>
<figure id="calibre_link-1310" class="image-l">
<img src="images/000630.jpg" alt="The figure shows the data model." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3167"></span><strong class="calibre7">Figure 15-24</strong> <em class="calibre5">Budget</em> is directly linked to <em class="calibre5">Customer</em> and <em class="calibre5">Product</em> using two weak relationships.</figcaption>
</figure>
<p class="edition">When creating an MMR weak relationship, one has the option of choosing the direction of the filter context propagation. It can be bidirectional or single, as is the case with a regular one-to-many relationship. The choice for this example is necessarily the single direction from <em class="calibre5">Customer</em> to <em class="calibre5">Budget</em> and from <em class="calibre5">Product</em> to <em class="calibre5">Budget</em>. Setting a bidirectional filter in both relationships would create a model ambiguity.</p>
<p class="edition">In MMR relationships, both sides of the relationship are the many-side. Therefore, the columns can contain duplicates in both tables. This model works exactly like the model shown in <a href="#calibre_link-1309" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-23</a>, and it computes the correct values without the need for additional DAX code in measures or calculated tables.</p>
<p class="edition">Nevertheless, a trap lies in this model that our reader must be aware of. Because the relationship is weak, neither of the two tables will contain the blank row in case the relationship is invalid. In other words, if <em class="calibre5">Budget</em> contains a country or a brand that is not present in <em class="calibre5">Customer</em> or in <em class="calibre5">Product</em>, then its values will be hidden, as is the case for the model in <a href="#calibre_link-1310" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-24</a>.</p>
<p class="edition">To demonstrate this behavior, we changed the content of the <em class="calibre5">Budget</em> table, replacing Germany with Italy. There are no customers whose country is Italy in the model used for this example. The result of this change is somewhat surprising, as shown in <a href="#calibre_link-1311" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-25</a>.</p>
<figure id="calibre_link-1311" class="image-l">
<img src="images/000637.jpg" alt="The report returns a blank for Germany under Budget Amt." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2091"></span><strong class="calibre7">Figure 15-25</strong> If the relationship between <em class="calibre5">Budget</em> and <em class="calibre5">Customer</em> is invalid, the missing blank row produces surprising results.</figcaption>
</figure>
<p class="edition">The row with Germany is empty. This is correct, because we moved the entire budget of Germany to Italy. But you should notice two details:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">There is no row showing the budget for Italy.</p></li>
<li class="calibre10"><p class="listp">The grand total of the budget is larger than the sum of the two visible rows.</p></li>
</ul>
<p class="edition">When there is a filter on <em class="calibre5">Customer[CountryRegion]</em>, the filter is moved to the <em class="calibre5">Budget</em> table through the weak relationship. As a consequence, the <em class="calibre5">Budget</em> table only shows the values of the given country. Because Italy does not exist in <em class="calibre5">Customer[CountryRegion]</em>, no value is shown. That said, when there is no filter on <em class="calibre5">Customer[CountryRegion]</em>, <em class="calibre5">Budget</em> does not receive any filter. As such, it shows its grand total, which also includes Italy.</p>
<p class="edition">The result of <em class="calibre5">Budget Amt</em> thus depends on the presence of a filter on <em class="calibre5">Customer[CountryRegion]</em>; in the presence of invalid relationships, the numbers produced might be surprising.</p>
<p class="edition">Weak MMR relationships represent a powerful tool that greatly simplifies the creation of data models because it reduces the need to create additional tables. Nevertheless, the fact that no blank row is ever added to the tables might produce unexpected results if the feature is not used properly. We showed the more complex technique of creating additional tables before showing weak relationships because they are basically the same thing: The difference is that creating additional tables makes visible the values that exist in just one of the two related tables&mdash;something that is not possible using weak MMR relationships, but that might be required in particular scenarios.</p>
<p class="edition">Indeed, if we perform the same substitution of Germany with Italy in the data model with the <em class="calibre5">Brands</em> and <em class="calibre5">CountryRegions</em> table (<a href="#calibre_link-1309" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-23</a>), the result is much clearer, as shown in <a href="#calibre_link-1312" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-26</a>.</p>
<figure id="calibre_link-1312" class="image-l">
<img src="images/000643.jpg" alt="The report shows both Germany and Italy." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-26</strong> Using the intermediate table, Italy and Germany both appear in the report with their correct values.</figcaption>
</figure>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-263" class="h2a"><span type="pagebreak" id="calibre_link-1753"></span>Choosing the right type of relationships</h3>
<p class="edition">Complex relationships are a powerful way to generate advanced models. Working with complex scenarios, you face the choice between building a physical (maybe calculated) relationship and building a virtual relationship.</p>
<p class="edition">Physical and virtual relationships are similar because they fulfill the same goal: transferring a filter from one table to another. However, they have different performance and different implications at the data model level.</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">A physical relationship is defined in the data model; a virtual relationship only exists in DAX code.</strong> The diagram view of a data model clearly shows the relationships between tables. Yet virtual relationships are not visible in the diagram view; locating them requires a detailed review of the DAX expression used in measures, calculated columns, and calculated tables. If a logical relationship is used in several measures, its code must be duplicated in every measure requiring it, unless the logical relationship is implemented in a calculation item of a calculation group. Physical relationships are easier to manage and less error-prone than virtual relationships.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">A physical relationship defines a constraint on the one-side table of the relationship.</strong> One-to-many and one-to-one relationships require that the column used on the one-side of a relationship have unique nonblank values. The refresh operation of a data model fails in case the new data would violate this constraint. From this point of view, there is a huge difference with the foreign key constraint defined in a relational database. A foreign key relationship defines a constraint on the many-side of a relationship, whose values can only be values that exist in the other table. A relationship in a Tabular model never enforces a foreign key constraint.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">A physical relationship is faster than a virtual relationship.</strong> The physical relationship defines an additional structure that accelerates the query execution, enabling the storage engine to execute part of the query involving two or more queries. A virtual relationship always requires additional work from the formula engine, which is slower than the storage engine. Differences between formula engine and storage engine are discussed in <a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 17</a>.</p></li>
</ul>
<p class="edition">Generally, physical relationships are a better option. In terms of query performance there is no difference between a standard relationship (based on a column coming from the data source) and a calculated physical relationship (based on a calculated column). The engine computes calculated columns at process time (when data is refreshed), so it does not really matter how complex the expression is; the relationship is a physical relationship and the engine can take full advantage of it.</p>
<p class="edition">A virtual relationship is just an abstract concept. Technically, every time one transfers a filter from one table to another using DAX code, they are implementing a virtual relationship. Virtual relationships are resolved at query time, and the engine does not have the additional structures created for physical relationships to optimize the query execution. Thus, whenever you have the option of doing that, you should prefer a physical relationship to a virtual relationship.</p>
<p class="edition">The many-to-many relationships are in an intermediate position between physical and virtual relationships. One can define many-to-many relationships in the model by leveraging bidirectional relationships or table expansion. In general, the presence of a relationship is better than an approach based on <span type="pagebreak" id="calibre_link-3168"></span>table expansion because the engine has more chances to optimize the query plan by removing unnecessary filter propagations. Even so, table expansion and bidirectional cross-filters have a similar cost when a filter is active, even though technically they execute two different query plans with a similar cost.</p>
<p class="edition">Performance-wise the priority in relationships choice should be the following:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Physical one-to-many relationships to get best performance and the best use of the VertiPaq engine. Calculated physical relationships have the same query performance as relationships on native columns.</p></li>
<li class="calibre10"><p class="listp">Bidirectional cross-filter relationships, many-to-many with table expansion, and weak relationships are a second option. They provide good performance and a good use of the engine, although not the best.</p></li>
<li class="calibre10"><p class="listp">Virtual relationships are the last choice because of the risk of bad performance. Note that being at risk does not mean you will experience performance issues, but only that you need to care about different aspects of the query, which you will learn in the next chapters about optimization.</p></li>
</ul>
</section>
<section class="calibre4">
<h3 id="calibre_link-264" class="h2a">Managing granularities</h3>
<p class="edition">As described in earlier sections, by using intermediate tables or MMR weak relationships, one can link two tables using a relationship at a granularity level lower than the primary key of a table. In a previous example, we linked the <em class="calibre5">Budget</em> table to both <em class="calibre5">Product</em> and <em class="calibre5">Customer</em>. The relationship with <em class="calibre5">Product</em> is at the <em class="calibre5">Brand</em> level, whereas the relationship with <em class="calibre5">Customer</em> is at the <em class="calibre5">CountryRegion</em> level.</p>
<p class="edition">If a data model contains relationships at a lower granularity, special care needs to be taken whenever authoring measures that use that relationship. As an example, <a href="#calibre_link-1313" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-27</a> shows the starting model with two MMR weak relationships between <em class="calibre5">Customer</em>, <em class="calibre5">Product</em>, and <em class="calibre5">Budget</em>.</p>
<figure id="calibre_link-1313" class="image-l">
<img src="images/000650.jpg" alt="The figure shows the data model with the relationships." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-27</strong> The relationships between <em class="calibre5">Customer</em>, <em class="calibre5">Product</em>, and <em class="calibre5">Budget</em> are weak relationships.</figcaption>
</figure>
<p class="edition">A weak relationship transfers the filter from one table to another following the granularity of the column. This statement is true for any relationship. Indeed, the relationship between <em class="calibre5">Customer</em> and <span type="pagebreak" id="calibre_link-3169"></span><em class="calibre5">Sales</em> also transfers the filter at the granularity of the column involved in the relationship. Nevertheless, if the column used to create the relationship is the key of the table, the behavior is intuitive. When the relationship is set at a lower granularity&mdash;as in the case of weak relationships&mdash;it is all too easy to produce calculations that might be hard to understand.</p>
<p class="edition">For example, consider the <em class="calibre5">Product</em> table. The relationship with <em class="calibre5">Budget</em> is set at the <em class="calibre5">Brand</em> level. Thus, one can create a matrix that slices <em class="calibre5">Budget Amt</em> by <em class="calibre5">Brand</em> and obtain an accurate result, as shown in <a href="#calibre_link-1314" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-28</a>.</p>
<figure id="calibre_link-1314" class="image-l">
<img src="images/000657.jpg" alt="The matrix shows Budget Amt, per brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-28</strong> Slicing budget by brand, all calculations provide an accurate result.</figcaption>
</figure>
<p class="edition">Things suddenly become much more intricate if other columns from the <em class="calibre5">Product</em> table are involved in the analysis. In <a href="#calibre_link-1315" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-29</a> we added a slicer to filter a few colors, and we added the color on the columns of the matrix. The result is confusing.</p>
<figure id="calibre_link-1315" class="image-l">
<img src="images/000663.jpg" alt="In this report, the totals do not add up, and the amounts in various colors are the same." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3170"></span><strong class="calibre7">Figure 15-29</strong> Slicing budget by brand and color, the numbers reported are confusing.</figcaption>
</figure>
<p class="edition">Please note that given a <em class="calibre5">Brand</em>, its value&mdash;if present&mdash;is always the same, regardless of the filter on the color. The total of each color is different, but the grand total is clearly not the sum of individual colors.</p>
<p class="edition">To make sense of these numbers, we use a simplified version of the matrix where the brand is not present. In <a href="#calibre_link-1316" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-30</a>, <em class="calibre5">Budget Amt</em> is sliced only by <em class="calibre5">Product[Color]</em>.</p>
<figure id="calibre_link-1316" class="image-l">
<img src="images/000669.jpg" alt="In this report we see Budget Amt per color." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-30</strong> Slicing only by color makes it easier to focus on individual cells.</figcaption>
</figure>
<p class="edition">Look at the Blue budget amount in <a href="#calibre_link-1316" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-30</a>. When the evaluation starts, the filter context filters the <em class="calibre5">Product</em> table only showing blue products. Not all the brands produce blue products. For instance, The Phone Company does not have any product that is blue, as shown in <a href="#calibre_link-1315" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-29</a>. Thus, the <em class="calibre5">Product[Brand]</em> column is cross-filtered by <em class="calibre5">Product[Color]</em>, and it shows all the brands except for The Phone Company. When the filter context is moved to the <em class="calibre5">Budget</em> table, the operation occurs at the <em class="calibre5">Brand</em> granularity. Consequently, the <em class="calibre5">Budget</em> table is filtered showing all brands but The Blue Company.</p>
<p class="edition">The value shown is the sum of all brands except for The Blue Company. While traversing the relationship, the information about the color has been lost. The relationship between <em class="calibre5">Color</em> and <em class="calibre5">Brand</em> is used when cross-filtering <em class="calibre5">Brand</em> by <em class="calibre5">Color</em>, but then, the filter on <em class="calibre5">Budget</em> is based on <em class="calibre5">Brand</em> alone. In other words, every cell shows the sum of all brands that have at least one product of the given color. <span type="pagebreak" id="calibre_link-3171"></span>This behavior is seldom desirable. There are few scenarios where this is exactly the calculation required; most of the times the numbers are just wrong.</p>
<p class="edition">The problem appears whenever a user browses an aggregation of values at a granularity that is not supported by the relationship. A good practice consists of hiding the value if the browsing granularity is not supported. This raises the problem of detecting when the report is or is not analyzing data at the correct granularity. To solve the problem, we create more measures.</p>
<p class="edition">We start with a matrix containing the brand (correct granularity) and the color (wrong granularity). In the report, we also added a new measure, <em class="calibre5">NumOfProducts</em> that just counts the number of rows in the <em class="calibre5">Product</em> table:</p>
<div class="program"><pre class="calibre14">NumOfProducts :=
COUNTROWS ( 'Product' )</pre></div>
<p class="edition">You can see the resulting report in <a href="#calibre_link-1317" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-31</a>.</p>
<figure id="calibre_link-1317" class="image-l">
<img src="images/000675.jpg" alt="The matrix shows Budget Amt and NumOfProducts per color per brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-31</strong> The value of <em class="calibre5">Budget Amt</em> is correct for the <em class="calibre5">Brand</em> and wrong for the individual colors.</figcaption>
</figure>
<p class="edition">The key to solve the scenario is the <em class="calibre5">NumOfProducts</em> measure. When the A. Datum brand is selected, there are 132 products visible, which are all A. Datum products. If the user further filters with the color (or any other column), the number of visible products is reduced. The values from <em class="calibre5">Budget</em> make sense if all 132 products are visible. They lose meaning if fewer products are selected. Thus, we hide the value of the <em class="calibre5">Budget Amt</em> measure when the number of visible products is not exactly the number of all the products within the selected brand.</p>
<p class="edition">A measure that computes the number of products at the brand granularity is the following:</p>
<p class="codelink"><a href="#calibre_link-1318" id="calibre_link-2721" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">NumOfProducts Budget Grain :=
CALCULATE (
    [NumOfProducts],
<span type="pagebreak" id="calibre_link-1709"></span>    ALL ( 'Product' ),
    VALUES ( 'Product'[Brand] )
)</pre></div>
<p class="edition">In this case <em class="calibre5">ALL</em> / <em class="calibre5">VALUES</em> must be used instead of <em class="calibre5">ALLEXCEPT</em>; the reader can find more details about their differences in <a href="#calibre_link-15" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 10</a>. With this new measure, it is now enough to use a simple <em class="calibre5">IF</em> statement to check if the two numbers are identical to show the <em class="calibre5">Budget Amt</em> measure; otherwise, a blank is returned and the row will be hidden in the report. The <em class="calibre5">Corrected Budget</em> measure implements this logic:</p>
<p class="codelink"><a href="#calibre_link-1319" id="calibre_link-2722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Corrected Budget :=
IF (
    [NumOfProducts] = [NumOfProducts Budget Grain],
    [Budget Amt]
)</pre></div>
<p class="edition"><a href="#calibre_link-1320" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-32</a> shows the entire report with the newly introduced measures. The <em class="calibre5">Corrected Budget</em> value is hidden when the granularity of the report is not compatible with the granularity of the <em class="calibre5">Budget</em> table.</p>
<figure id="calibre_link-1320" class="image-l">
<img src="images/000682.jpg" alt="This matrix shows Budget Amt, NumOfProducts, NumOfProducts Budget Grain, and Corrected Budget per color per brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-32</strong> The value of <em class="calibre5">Corrected Budget</em> is hidden whenever the report is browsing an incompatible granularity.</figcaption>
</figure>
<p class="edition">The same pattern must be applied to the <em class="calibre5">Customer</em> table too, where the granularity is set at the <em class="calibre5">CountryRegion</em> level. If needed, more information about this pattern is available at <a href="https://www.daxpatterns.com/budget-patterns/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.daxpatterns.com/budget-patterns/</a>.</p>
<p class="edition">In general, whenever using relationships at a granularity different than the key of a table, one should always check the calculations and make sure any value is hidden if the granularity is not supported. Using MMR weak relationships always requires attention to these details.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-265" class="h2a"><span type="pagebreak" id="calibre_link-1710"></span>Managing ambiguity in relationships</h3>
<p class="edition">When we think about relationships, another important topic is ambiguity. Ambiguity might appear in a model if there are multiple paths linking two tables, and unfortunately, ambiguity could be hard to spot in a complex data model.</p>
<p class="edition">The simplest kind of ambiguity that one can introduce in a model is by creating two or more relationships between two tables. For example, the <em class="calibre5">Sales</em> table contains both the order date and the delivery date. When you try to create two relationships between <em class="calibre5">Date</em> and <em class="calibre5">Sales</em> based on the two columns, the second one is disabled. For example, <a href="#calibre_link-1321" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-33</a> shows that one of the two relationship between <em class="calibre5">Date</em> and <em class="calibre5">Sales</em> is represented by a dashed line because it is not active.</p>
<figure id="calibre_link-1321" class="image-l">
<img src="images/000689.jpg" alt="This shows a small data model with two relationships between two tables." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-33</strong> No more than one relationship can be active between any two tables.</figcaption>
</figure>
<p class="edition">If both relationships were active at the same time, then the model would be ambiguous. The engine would not know which path to follow to transfer a filter from <em class="calibre5">Date</em> to <em class="calibre5">Sales</em>.</p>
<p class="edition">Understanding ambiguity when working with two tables is easy. But as the number of tables increases, ambiguity is much harder to spot. The engine automatically detects ambiguity in a model and prevents developers from creating ambiguous models. However, the engine uses an algorithm that is complex, following rules that are not easy to grasp for humans. As a result, sometimes it does not consider as ambiguous a model that, in reality, contains ambiguity.</p>
<p class="edition">For example, consider the model in <a href="#calibre_link-1322" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-34</a>. Before moving further, focus on the figure and answer this simple question: Is the model ambiguous?</p>
<figure id="calibre_link-1322" class="image-l">
<img src="images/000696.jpg" alt="The figure shows a data model with various tables and relationships." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1642"></span><strong class="calibre7">Figure 15-34</strong> Is this model ambiguous? Will a developer be able to create it, or will it generate an error?</figcaption>
</figure>
<p class="edition">The answer to the question itself is ambiguous: The model is ambiguous for a human, but it is not ambiguous for DAX. Still, it is a bad data model because it is extremely complex to analyze. First, we analyze where the ambiguity is.</p>
<p class="edition">There is a bidirectional cross-filter in the relationship between <em class="calibre5">Product</em> and <em class="calibre5">Sales</em>, meaning that the filter context from <em class="calibre5">Sales</em> flows to <em class="calibre5">Product</em> and then to <em class="calibre5">Receipts</em>. Now, focus on <em class="calibre5">Date</em>. Starting from <em class="calibre5">Date</em>, the filter can go to <em class="calibre5">Sales</em>, then to <em class="calibre5">Product</em>, and finally to <em class="calibre5">Receipts</em>, following a legitimate path. At the same time, the filter could flow from <em class="calibre5">Date</em> to <em class="calibre5">Receipts</em>, simply using the relationship between the two tables. Thus, the model is ambiguous because there are multiple paths to propagate the filter from <em class="calibre5">Date</em> to <em class="calibre5">Receipts</em>.</p>
<p class="edition">Nevertheless, it is possible to create and use such models because the DAX engine implements special rules to reduce the number of ambiguous models detected. In this case, the rule is that only the shortest path propagates the filter. Therefore, the model is allowed, even though it is ambiguous. This is not to say that working with such models is a good idea in any way. Instead, it is a bad idea, and we strongly suggest our readers avoid ambiguity at all in their models.</p>
<p class="edition">Moreover, things are more intricate than this. Ambiguity can appear in a model because of the way relationships are designed. Ambiguity might also appear during the execution of DAX code because a DAX developer can change the relationship architecture using <em class="calibre5">CALCULATE</em> modifiers like <em class="calibre5">USERELATIONSHIP</em> and <em class="calibre5">CROSSFILTER</em>. For example, you write a measure that works perfectly fine, then you call the measure from inside another measure that uses <em class="calibre5">CROSSFILTER</em> to enable a relationship, and your measure starts computing wrong values because of ambiguity introduced in the model by <span type="pagebreak" id="calibre_link-1643"></span><em class="calibre5">CROSSFILTER</em>. We do not want to scare our readers; we want them to be aware of the complexity that can arise in a model as soon as ambiguity comes into play.</p>
<section class="calibre4">
<h4 id="calibre_link-266" class="calibre13">Understanding ambiguity in active relationships</h4>
<p class="edition">The first example is based on the model shown in <a href="#calibre_link-1322" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-34</a>. The report projects <em class="calibre5">Sales Amount</em> and <em class="calibre5">Receipts Amount</em> (simple <em class="calibre5">SUMX</em> over the two tables) in a matrix that slices by year. The result is visible in <a href="#calibre_link-1323" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-35</a>.</p>
<figure id="calibre_link-1323" class="image-l">
<img src="images/000703.jpg" alt="The figure shows Sales Amt and Receipts Amt per calendar year." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-35</strong> <em class="calibre5">Calendar Year</em> is filtering <em class="calibre5">Receipts</em>, but through which path?</figcaption>
</figure>
<p class="edition">The filter from <em class="calibre5">Date</em> can reach <em class="calibre5">Receipts</em> through two paths:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">A direct path (<em class="calibre5">Date</em> to <em class="calibre5">Receipts</em>).</p></li>
<li class="calibre10"><p class="listp">A path traversing <em class="calibre5">Date</em> to <em class="calibre5">Sales</em>, then <em class="calibre5">Sales</em> to <em class="calibre5">Product</em>, and finally <em class="calibre5">Product</em> to <em class="calibre5">Receipts</em>.</p></li>
</ul>
<p class="edition">The model is not considered ambiguous because the DAX engine chooses the shortest path between the two tables. Having the ability to move the filter from <em class="calibre5">Date</em> to <em class="calibre5">Receipts</em> directly, it ignores any other path. If the shortest path is not available, then the engine uses the longer one. Look at what happens by creating a new measure that calls <em class="calibre5">Receipts Amt</em> after having disabled the relationship between <em class="calibre5">Date</em> and <em class="calibre5">Receipts</em>:</p>
<p class="codelink"><a href="#calibre_link-1324" id="calibre_link-2723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Rec Amt Longer Path :=
CALCULATE (
    [Receipts Amt],
    CROSSFILTER ( 'Date'[Date], Receipts[Sale Date], NONE )
)</pre></div>
<p class="edition">The <em class="calibre5">Rec Amt Longer Path</em> measure disables the relationship between <em class="calibre5">Date</em> and <em class="calibre5">Receipts</em>, so the engine must follow the longer path. The result is visible in <a href="#calibre_link-1325" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-36</a>.</p>
<figure id="calibre_link-1325" class="image-l">
<img src="images/000710.jpg" alt="The figure shows Sales Amt, Receipts Amt, and Rec Amt Longer Path per calendar year." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 15-36</strong> <em class="calibre5">Rec Amt Longer Path</em> uses the longer path to filter <em class="calibre5">Receipts</em> starting from <em class="calibre5">Date</em>.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-2070"></span>At this point, one interesting exercise for the reader is to describe exactly what the numbers reported by <em class="calibre5">Rec Amt Longer Path</em> mean. We encourage this effort be made before reading further, as the answer follows in the next paragraphs.</p>
<p class="edition">The filter starts from <em class="calibre5">Date</em>; then it reaches <em class="calibre5">Sales</em>. From <em class="calibre5">Sales</em>, it proceeds to <em class="calibre5">Product</em>. The products filtered are the ones that were sold in one of the selected dates. In other words, when the filter is 2007, <em class="calibre5">Product</em> only shows the products sold in 2007. Then, the filter moves one step forward and it reaches <em class="calibre5">Receipts</em>. In other words, the number is the total of <em class="calibre5">Receipts</em> for all the products sold in one given year. Not an intuitive value at all.</p>
<p class="edition">The most complex detail about the formula is that it uses <em class="calibre5">CROSSFILTER NONE</em>. Thus, a developer would tend to think that the code only deactivates a relationship. In reality, deactivating one path makes another path active. Thus, the measure does not really remove a relationship, it activates another one that is not cited anywhere in the code.</p>
<p class="edition">In this scenario, ambiguity is introduced by the bidirectional cross-filter between <em class="calibre5">Product</em> and <em class="calibre5">Sales</em>. A bidirectional cross-filter is a very dangerous feature because it might introduce ambiguities that are resolved by the engine but hard for a developer to find. After many years using DAX, we concluded that the bidirectional cross-filter should be avoided if not strictly necessary. Moreover, in the few scenarios where it makes sense to use a bidirectional cross-filter, one should double-check the whole model and then double-check it again to make sure no ambiguity is present. Obviously, as soon as another table or relationship is added to the model, the full checking process should start again. Doing this exercise on a model with 50 tables is a tedious exercise that can be easily avoided by staying away from bidirectional cross-filters defined in the data model.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-267" class="calibre13">Solving ambiguity in non-active relationships</h4>
<p class="edition">Though bidirectional cross-filters are likely the most offending feature that generates ambiguity, they are not the only reason behind the appearance of ambiguity. Indeed, a developer could create a perfectly legitimate model, with no ambiguity, and still face the problem of ambiguity at query time.</p>
<p class="edition">As an example, look at the model in <a href="#calibre_link-1326" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-37</a>. It is not ambiguous.</p>
<figure id="calibre_link-1326" class="image-l">
<img src="images/000717.jpg" alt="The figure shows a data model." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1711"></span><strong class="calibre7">Figure 15-37</strong> The model is not ambiguous, because the potentially offending relationships are disabled.</figcaption>
</figure>
<p class="edition">Focus on the <em class="calibre5">Date</em> table. <em class="calibre5">Date</em> filters <em class="calibre5">Sales</em> through the only active relationship (<em class="calibre5">Date[Date]</em> to <em class="calibre5">Sales[Date]</em>). There are two relationships between <em class="calibre5">Date</em> and <em class="calibre5">Sales</em>. One of them is inactive to avoid ambiguity. There is also a relationship between <em class="calibre5">Date</em> and <em class="calibre5">Customer</em>, based on <em class="calibre5">Customer[FirstSale]</em> that must be inactive. If this latter relationship were activated, then the filter from <em class="calibre5">Date</em> could reach <em class="calibre5">Sales</em> following two paths, making the model ambiguous. Thus, this model works just fine because it only uses the active relationships.</p>
<p class="edition">Now what happens if one activates one or more of the inactive relationships inside a <em class="calibre5">CALCULATE</em>? The model would suddenly become ambiguous. For example, the following measure activates the relationship between <em class="calibre5">Date</em> and <em class="calibre5">Customer</em>:</p>
<p class="codelink"><a href="#calibre_link-1327" id="calibre_link-2724" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">First Date Sales :=
CALCULATE (
    [Sales Amount],
    USERELATIONSHIP ( Customer[FirstSale], 'Date'[Date] )
)</pre></div>
<p class="edition">Because <em class="calibre5">USERELATIONSHIP</em> makes the relationship active, inside <em class="calibre5">CALCULATE</em> the model becomes ambiguous. The engine cannot work on an ambiguous model, so it needs to deactivate other relationships. In this case, it does not use the shortest path. Indeed, the shortest path between <em class="calibre5">Date</em> and <em class="calibre5">Sales</em> is the direct relationship. A reasonable conclusion could be that&mdash;to disambiguate the model&mdash;the engine uses the direct relationship, as it did in the previous example. But because the developer explicitly asked to activate the relationship between <em class="calibre5">Customer</em> and <em class="calibre5">Date</em> by using <em class="calibre5">USERELATIONSHIP</em>, the engine decides to disable the relationship between <em class="calibre5">Date</em> and <em class="calibre5">Sale</em> instead.</p>
<p class="edition">As a result, because of <em class="calibre5">USERELATIONSHIP</em>, the filter will not propagate from <em class="calibre5">Date</em> to <em class="calibre5">Sales</em> using the direct relationship. Instead, it propagates the filter from <em class="calibre5">Date</em> to <em class="calibre5">Customer</em> and then from <em class="calibre5">Customer</em> to <em class="calibre5">Sales</em>. Therefore, given a customer and a date, the measure shows all the sales of that customer but only at the date of that customer’s first purchase. You can see this behavior in <a href="#calibre_link-1328" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 15-38</a>.</p>
<figure id="calibre_link-1328" class="image-l">
<img src="images/000724.jpg" alt="This report shows Sales Amount and First Date Sales per date per user." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3172"></span><strong class="calibre7">Figure 15-38</strong> <em class="calibre5">First Date Sales</em> shows all the sales of a customer, but only on the day of their first purchase.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">First Date Sales</em> measure always shows the total of the <em class="calibre5">Sales</em> of each customer, showing blank values on dates that do not correspond to the first date of purchase. From a business point of view, this measure shows the future value of a customer projected on the date when that customer was acquired. While this description makes sense, the chances that it be a real requirement are very low.</p>
<p class="edition">As it happened earlier, the goal here is not to understand exactly how the engine resolved the ambiguity. The disambiguation rules have never been documented; thus, they might change at some point. The real problem of such models is that ambiguity might appear in a valid model because of an inactive relationship being activated. Understanding which of the multiple paths the engine will follow to solve ambiguities is more of a guess than science.</p>
<p class="edition">With ambiguity and relationships, the golden rule is to just keep it simple. DAX might have some disambiguation algorithm that is powerful and can disambiguate nearly every model. Indeed, to raise an ambiguity error at runtime, one needs to use a set of USERELATIONSHIP functions that forces the model to be ambiguous. Only in such cases does the engine raise an error. For example, the following measure requests a clearly ambiguous model:</p>
<p class="codelink"><a href="#calibre_link-1329" id="calibre_link-2725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">First Date Sales ERROR :=
CALCULATE (
    [Sales Amount],
    USERELATIONSHIP ( Customer[FirstSale], 'Date'[Date] ),
    USERELATIONSHIP ( 'Date'[Date], Sales[Date] )
)</pre></div>
<p class="edition">At this point, DAX is not able to disambiguate a model with both relationships active, and it raises an error. Regardless, the measure can be defined in the data model without raising any exception; the error only appears when the measure is executed and filtered by date.</p>
<p class="edition">The goal of this section was not to describe the modeling options in Tabular. Instead, we wanted to bring your attention to issues that might happen when the data model is not correctly built. Building the correct model to perform an analysis is a complex task. Using bidirectional cross-filters and inactive relationships without a deep understanding of their implications is perhaps the quickest way to produce an unpredictable model.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-268" class="h2a">Conclusions</h3>
<p class="edition">Relationships are an important part of any data model. The Tabular mode offers different types of relationships, like one-to-many (SMR), one-to-one (SSR), and MMR weak relationships. MMR relationships are also called many-to-many relationships in some user interfaces, which is a misleading name that can be confused with a different data modeling concept. Every relationship can propagate the filter either in a single direction or bidirectionally, with the only exception of one-to-one relationships that are always bidirectional.</p>
<p class="edition">The available tools can be extended in a logical data model by implementing calculated physical relationships, or virtual relationships by using <em class="calibre5">TREATAS</em>, <em class="calibre5">SUMMARIZE</em>, or table expansion. The many-to-many relationships between business entities can be implemented with a bridge table and rely on bidirectional cross-filters applied to the relationships in the chain.</p>
<p class="edition">All these features are extremely powerful, and being powerful they can be dangerous. Relationships must be handled with care. A developer should always double-check the models for ambiguity, also verifying that ambiguity will not be introduced by using <em class="calibre5">USERELATIONSHIP</em> or <em class="calibre5">CROSSFILTER</em>.</p>
<p class="edition">The larger the model, the higher the chances of making mistakes. If a model contains any inactive relationship, check the reason why the relationship is inactive and what would happen if it were activated. Remember that investing the time to properly design your model is foundational to successful DAX calculations, whereas a poorly designed model will usually give developers many headaches down the road.</p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1330">
<div id="calibre_link-3173" class="calibre2">
<div id="calibre_link-3174" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-21"><span type="pagebreak" id="calibre_link-1851"></span><span class="pd_ash">Chapter 16</span><br class="calibre3" />Advanced calculations in DAX</h2>
<p class="edition">In this last chapter about the features of the DAX language and before discussing optimization, we want to show several examples of calculations performed with DAX. The goal of this chapter is not to provide ready-to-use patterns that one can use out of the box; these patterns are available at <a href="https://www.daxpatterns.com" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.daxpatterns.com</a>. Instead, the goal is to show formulas of different levels of complexity to exercise your mind in the fascinating art of “thinking in DAX.”</p>
<p class="edition">DAX does indeed require your brain to think creatively. Now that you have learned all the secrets of the language, it is time to put everything into practice. From the next chapter onwards, we will start to cover optimization. Therefore, in this chapter we start bringing up measure performance, providing the first clues as to how to measure the complexity of a formula.</p>
<p class="edition">Here, the goal is not to try to achieve the best performance because performance analysis requires knowledge that you will only learn in later chapters. Nevertheless, in this chapter we provide different formulations of the same measure, analyzing the complexity of each version. Being able to author several different versions of the same measure is a skill that will be of paramount importance in performance optimization.</p>
<section class="calibre4">
<h3 id="calibre_link-269" class="h2a">Computing the working days between two dates</h3>
<p class="edition">Given two dates, one can compute the difference in days by using a simple subtraction. In the <em class="calibre5">Sales</em> table there are two dates: the delivery date and the order date. The average number of days required for delivery can be obtained with the following measure:</p>
<p class="codelink"><a href="#calibre_link-1331" id="calibre_link-2727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Avg Delivery :=
AVERAGEX (
    Sales,
    INT ( Sales[Delivery Date] - Sales[Order Date] + 1)
)</pre></div>
<p class="edition">Because of the internal format of a <em class="calibre5">DateTime</em>, this measure produces an accurate result. Yet it would be unfair to consider that an order received on Friday and shipped on Monday took three days to deliver, if Saturdays and Sundays are considered nonworking days. In fact, it only took one working day to ship the order&mdash;same as if the order had been received on Monday and shipped on Tuesday. Therefore, a more accurate calculation should consider the difference between the two dates expressed in <span type="pagebreak" id="calibre_link-3175"></span>working days. We provide several versions of the same calculation, seeking for the best in terms of performance and flexibility.</p>
<p class="edition">Excel provides a specific function to perform that calculation: <em class="calibre5">NETWORKDAYS</em>. However, DAX does not offer an equivalent feature. DAX offers the building blocks to author a complex expression that computes the equivalent of <em class="calibre5">NETWORKDAYS</em>, and much more. For example, a first way to compute the number of working days between two dates is to count the number of days between the two dates that are working days:</p>
<p class="codelink"><a href="#calibre_link-1332" id="calibre_link-2728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Avg Delivery WD :=
AVERAGEX (
    Sales,
    VAR RangeOfDates =
        DATESBETWEEN (
            'Date'[Date],
            Sales[Order Date],
            Sales[Delivery Date]
        )
    VAR WorkingDates =
        FILTER (
            RangeOfDates,
            NOT ( WEEKDAY ( 'Date'[Date] ) IN { 1, 7 } )
        )
    VAR NumberOfWorkingDays =
        COUNTROWS ( WorkingDates )
    RETURN
        NumberOfWorkingDays
)</pre></div>
<p class="edition">For each row in <em class="calibre5">Sales</em>, the measure creates a temporary table in <em class="calibre5">RangeOfDates</em> with all the dates in between the order and delivery dates. Then, it filters out Saturdays and Sundays in <em class="calibre5">WorkingDates</em>, and finally it counts the number of rows that survived the filter in <em class="calibre5">NumberOfWorkingDays</em>. <a href="#calibre_link-1333" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-1</a> shows a line chart with the difference between the average delivery time in days and in working days.</p>
<figure id="calibre_link-1333" class="image-l">
<img src="images/000851.jpg" alt="The figure is a line chart where Avg delivery is consistently higher than Avg Delivery WD over time." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-1</strong> The average delivery days and working days are different.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3176"></span>The measure works well, with a few shortcomings. First, it does not consider holidays. For example, by removing Saturdays and Sundays, the first of January is considered a regular working day, provided it does not fall on a weekend. The same happens for any other holidays in the year. Second, the performance of the formula can be improved.</p>
<p class="edition">In order to handle holidays, one needs to store the information about whether a given day is a holiday or not in a table. The <em class="calibre5">Date</em> table is the perfect place for this, in a column named <em class="calibre5">Is Holiday</em>. Then, the formula should use other columns of the <em class="calibre5">Date</em> table instead of just using the <em class="calibre5">Date[Date]</em> column like the previous measure did:</p>
<p class="codelink"><a href="#calibre_link-1334" id="calibre_link-2729" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Avg Delivery WD DT :=
AVERAGEX (
    Sales,
    VAR RangeOfDates =
        DATESBETWEEN (
            'Date'[Date],
            Sales[Order Date],
            Sales[Delivery Date]
        )
    VAR NumberOfWorkingDays =
        CALCULATE (
            COUNTROWS ( 'Date' ),
            RangeOfDates,
            NOT ( WEEKDAY ( 'Date'[Date] ) IN { 1, 7 } ),
            'Date'[Is Holiday] = 0
        )
    RETURN
        NumberOfWorkingDays
)</pre></div>
<p class="edition">Now that the measure is more data-driven, one could also store the information about the weekend in the <em class="calibre5">Date</em> table, replacing the test with <em class="calibre5">WEEKDAY</em> with a new column containing <em class="calibre5">Workday</em> or <em class="calibre5">Weekend</em>. This reduces the complexity of the measure and moves most of the logic into the data, gaining in flexibility.</p>
<p class="edition">In terms of complexity, the measure performs two operations:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">An iteration over the <em class="calibre5">Sales</em> table.</p></li>
<li class="calibre10"><p class="listp">For each row in <em class="calibre5">Sales</em>, the creation of a temporary table with all the dates between the order and delivery dates.</p></li>
</ul>
<p class="edition">If there are one million rows in <em class="calibre5">Sales</em> and the average for delivery days is seven, the complexity of the measure is around seven million. Indeed, the engine needs to build a temporary table with around seven rows, one million times.</p>
<p class="edition">It is possible to reduce the complexity of the formula by reducing either the number of iterations performed by <em class="calibre5">AVERAGEX</em> or the number of rows in the temporary table with the business days. An interesting point is that the calculation is not necessary at the individual sale level. Indeed, all the orders with the same <em class="calibre5">Order Date</em> and <em class="calibre5">Delivery Date</em> share the same duration. Thus, it is possible to first group all the orders by <em class="calibre5">Order Date</em> and <em class="calibre5">Delivery Date</em>, then compute the duration of these pairs of <span type="pagebreak" id="calibre_link-3177"></span>dates for a reduced number of rows. By doing so, we can reduce the number of iterations performed by <em class="calibre5">AVERAGEX</em>, but at the same time we lose information about how many orders each pair of dates was pertaining to. This can be resolved by transforming the simple average into a weighted average, using the number of orders as the weight for the average.</p>
<p class="edition">This idea is implemented in the following code:</p>
<p class="codelink"><a href="#calibre_link-1335" id="calibre_link-2730" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Avg Delivery WD WA :=
VAR NumOfAllOrders =
    COUNTROWS ( Sales )
VAR CombinationsOrderDeliveryDates =
    SUMMARIZE (
        Sales,
        Sales[Order Date],
        Sales[Delivery Date]
    )
VAR DeliveryWeightedByNumOfOrders =
    SUMX (
        CombinationsOrderDeliveryDates,
        VAR RangeOfDates =
            DATESBETWEEN (
                'Date'[Date],
                Sales[Order Date],
                Sales[Delivery Date]
            )
        VAR NumOfOrders =
            CALCULATE (
                COUNTROWS ( Sales )
            )
        VAR WorkingDays =
            CALCULATE (
                COUNTROWS ( 'Date' ),
                RangeOfDates,
                NOT ( WEEKDAY ( 'Date'[Date] ) IN { 1, 7 } ),
                'Date'[Is Holiday] = 0
            )
        VAR NumberOfWorkingDays = NumOfOrders * WorkingDays
        RETURN
            NumberOfWorkingDays
    )
VAR AverageWorkingDays =
    DIVIDE (
        DeliveryWeightedByNumOfOrders,
        NumOfAllOrders
    )
RETURN
    AverageWorkingDays</pre></div>
<p class="edition">The code is now much harder to read. An important question is: is it worth making the code more complex just to improve performance? As always, it depends. Before diving into this kind <span type="pagebreak" id="calibre_link-1693"></span>of optimization, it is always useful to perform some tests to check if the number of iterations is indeed reduced. In this case, one could evaluate the benefits by running the following query, which returns the total number of rows and the number of unique combinations of <em class="calibre5">Order Date</em> and <em class="calibre5">Delivery Date</em>:</p>
<p class="codelink"><a href="#calibre_link-1336" id="calibre_link-2731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
{ (
    COUNTROWS ( Sales ),
    COUNTROWS (
        SUMMARIZE (
            Sales,
            Sales[Order Date],
            Sales[Delivery Date]
        )
    )
) }

-- The result is:
--
-- Value1  |  Value2
--------------------
-- 100231  |    6073</pre></div>
<p class="edition">In the demo database there are 100,231 rows in <em class="calibre5">Sales</em> and only 6,073 distinct combinations of order and delivery dates. The more complex code in the <em class="calibre5">Avg Delivery WD WA</em> measure reduces the number of iterations by a bit more than an order of magnitude. Therefore, in this case authoring more complex code is worth the effort. You will learn how to evaluate the impact on execution time in later chapters. For now, we focus on code complexity.</p>
<p class="edition">The complexity of the <em class="calibre5">Avg Delivery WD WA</em> measure depends on the number of combinations of order and delivery dates, and on the average duration of an order. If the average duration of an order is just a few days, then the formula runs very fast. If the average duration of an order is of several years, then performance might start to be an issue because the result of <em class="calibre5">DATESBETWEEN</em> starts to be a large table with hundreds of rows.</p>
<p class="edition">Because the number of nonworking days is usually smaller than the number of working days, an idea could be to count nonworking days instead of counting working days. Therefore, another algorithm might be the following:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">Compute the difference between the two dates in days.</p></li>
<li class="calibre25"><p class="listp">Compute the number of nonworking days in between the two dates.</p></li>
<li class="calibre25"><p class="listp">Subtract the values computed in (1) and (2).</p></li>
</ol>
<p class="edition">One can implement this with the following measure:</p>
<p class="codelink"><a href="#calibre_link-1337" id="calibre_link-2732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Avg Delivery WD NWD :=
VAR NonWorkingDays =
    CALCULATETABLE (
<span type="pagebreak" id="calibre_link-3178"></span>        VALUES ( 'Date'[Date] ),
        WEEKDAY ( 'Date'[Date] ) IN { 1, 7 },
        ALL ( 'Date' )
    )
VAR NumOfAllOrders =
    COUNTROWS ( Sales )
VAR CombinationsOrderDeliveryDates =
    SUMMARIZE (
        Sales,
        Sales[Order Date],
        Sales[Delivery Date]
    )
VAR DeliveryWeightedByNumOfOrders =
    CALCULATE (
        SUMX (
            CombinationsOrderDeliveryDates,
            VAR NumOfOrders =
                CALCULATE (
                    COUNTROWS ( Sales )
                )
            VAR NonWorkingDaysInPeriod =
                FILTER (
                    NonWorkingDays,
                    AND (
                        'Date'[Date] &gt;= Sales[Order Date],
                        'Date'[Date] &lt;= Sales[Delivery Date]
                    )
                )
            VAR NumberOfNonWorkingDays =
                COUNTROWS ( NonWorkingDaysInPeriod )
            VAR DeliveryWorkingDays =
                Sales[Delivery Date] - Sales[Order Date] - NumberOfNonWorkingDays + 1
            VAR NumberOfWorkingDays =
                NumOfOrders * DeliveryWorkingDays
            RETURN
                NumberOfWorkingDays
        )
    )
VAR AverageWorkingDays =
    DIVIDE (
        DeliveryWeightedByNumOfOrders,
        NumOfAllOrders
    )
RETURN
    AverageWorkingDays</pre></div>
<p class="edition">This code runs more slowly than the previous code in the database used for this book. Regardless, this version of the same calculation might perform better on a different database where orders have a much larger duration. Only testing will point you in the right direction.</p>
<div class="sidebar">
<p class="edition"><span type="pagebreak" id="calibre_link-1694"></span>Why <em class="calibre5">ALL</em> is used in the <em class="calibre5">NonWorkingDays</em> variable</p>
<p class="edition">In the previous example, the <em class="calibre5">NonWorkingDays</em> variable calls an <em class="calibre5">ALL</em> on the <em class="calibre5">Date</em> table. This <em class="calibre5">ALL</em> function was not present in previous formulations of similar tables used as filters. The reason is that in previous versions of the measure, we used <em class="calibre5">DATESBETWEEN</em>, which is designed to ignore the filter context.</p>
<p class="edition">When used in a matrix, the <em class="calibre5">Date</em> table might be filtered to show a smaller time period. In that situation, orders having the order date outside of the selected time period would produce an incorrect result. Therefore, before building the table with nonworking days, one should get rid of the filter context on <em class="calibre5">Date</em>.</p>
<p class="edition">It is interesting to note that <em class="calibre5">ALL</em> might not be entirely necessary. Consider this expression of the variable:</p>
<p class="codelink"><a href="#calibre_link-1338" id="calibre_link-2733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">VAR NonWorkingDays =
    CALCULATETABLE (
        VALUES ( 'Date'[Date] ),
        NOT ( WEEKDAY ( 'Date'[Date] ) IN { 1, 7 } )
    )</pre></div>
<p class="edition">The filtering condition of <em class="calibre5">CALCULATE</em> does not seem to have an <em class="calibre5">ALL</em> anywhere. But <em class="calibre5">ALL</em> is indeed present, and it becomes evident by expanding the compact syntax of the filter predicate to the full syntax:</p>
<p class="codelink"><a href="#calibre_link-1339" id="calibre_link-2734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">VAR NonWorkingDays =
    CALCULATETABLE (
        VALUES ( 'Date'[Date] ),
        FILTER (
            ALL ( 'Date'[Date] ),
            NOT ( WEEKDAY ( 'Date'[Date] ) IN { 1, 7 } )
        )
    )</pre></div>
<p class="edition">Because <em class="calibre5">ALL</em> works on the <em class="calibre5">Date</em> column of the <em class="calibre5">Date</em> table, marked as a date table in the model, the engine automatically adds an <em class="calibre5">ALL</em> on the entire <em class="calibre5">Date</em> table.</p>
<p class="edition">Even though we could have authored the code that way, we do not want our measures to be cryptic and hard to read. Therefore, we preferred a more explicit formulation of the same code, making it easier to read.</p>
</div>
<p class="edition">Finally, be mindful that when seeking optimal performance, nothing beats precomputing the values. Indeed, no matter what, the difference in working days between two dates always leads to the same result. We already know that there are around 6,000 combinations of order and delivery dates in our demo data model. One could precompute the difference in working days between these 6,000 pairs of dates and store the result in a physical, hidden table. Therefore, at query time there is no need to compute the value. A simple lookup of the result provides the number needed.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3179"></span>Therefore, an option is to create a physical hidden table with the following code:</p>
<p class="codelink"><a href="#calibre_link-1340" id="calibre_link-2735" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WD Delta =
ADDCOLUMNS (
    SUMMARIZE (
        Sales,
        Sales[Order Date],
        Sales[Delivery Date]
    ),
    "Duration", [Avg Delivery WD WA]
)</pre></div>
<p class="edition">Once the table is in the model, we take advantage of the precomputed differences in working days by modifying the previous best formula with the following:</p>
<p class="codelink"><a href="#calibre_link-1341" id="calibre_link-2736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Avg Delivery WD WA Precomp :=
VAR NumOfAllOrders =
    COUNTROWS ( Sales )
VAR CombinationsOrderDeliveryDates =
    SUMMARIZE (
        Sales,
        Sales[Order Date],
        Sales[Delivery Date]
    )
VAR DeliveryWeightedByNumOfOrders =
    SUMX (
        CombinationsOrderDeliveryDates,
        VAR NumOfOrders =
            CALCULATE (
                COUNTROWS ( Sales )
            )
        <strong class="calibre7">VAR WorkingDays =</strong>
            <strong class="calibre7">LOOKUPVALUE (</strong>
                <strong class="calibre7">'WD Delta'[Duration],</strong>
                <strong class="calibre7">'WD Delta'[Order Date], Sales[Order Date],</strong>
                <strong class="calibre7">'WD Delta'[Delivery Date], Sales[Delivery Date]</strong>
            <strong class="calibre7">)</strong>
        VAR NumberOfWorkingDays = NumOfOrders * WorkingDays
        RETURN
            NumberOfWorkingDays
    )
VAR AverageWorkingDays =
    DIVIDE (
        DeliveryWeightedByNumOfOrders,
        NumOfAllOrders
    )
RETURN
    AverageWorkingDays</pre></div>
<p class="edition">It is very unlikely that this level of optimization would be required for a simple calculation involving the number of working days between two dates. That said, we were not trying to demonstrate how to super-optimize a measure. Instead, we wanted to show several different ways of obtaining the same <span type="pagebreak" id="calibre_link-1771"></span>result, from the most intuitive version down to a very technical and optimized version that is unlikely to be useful in most scenarios.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-270" class="h2a">Showing budget and sales together</h3>
<p class="edition">Consider a data model that contains budget information for the current year, along with actual sales. At the beginning of the year, the only available information is the budget figures. As time goes by, there are actual sales, and it becomes interesting both to compare sales and budget, and to adjust the forecast until the end of the year by mixing budget and actual sales.</p>
<p class="edition">To simulate this scenario, we removed all the sales after August 15, 2009, and we created a <em class="calibre5">Budget</em> table containing the daily budget for the entire year 2009. The resulting data is visible in <a href="#calibre_link-1342" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-2</a>.</p>
<figure id="calibre_link-1342" class="image-l">
<img src="images/000858.jpg" alt="The report shows Budget Amt and Sales Amt per month." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-2</strong> Sales stop in August, whereas the budget goes until the end of the year.</figcaption>
</figure>
<p class="edition">The business question is: provided that on August 15, the <em class="calibre5">Sales Amount</em> is 24 million, what should be the adjusted forecast at the end of the year, using actuals for the past and budget for the future? Be mindful that because sales ended on the 15<sup class="calibre26">th</sup>, in August there should be a mix of sales and budget.</p>
<p class="edition">The first step is determining the date where sales stop. Using a simple function like <em class="calibre5">TODAY</em> would be misleading because data in the model are not necessarily updated to the current day. A better approach is to search for the last date with any data in the <em class="calibre5">Sales</em> table. A simple <em class="calibre5">MAX</em> works well, but it <span type="pagebreak" id="calibre_link-3180"></span>is important to note that user selection might have a negative effect on the result. For example, consider the following measure:</p>
<p class="codelink"><a href="#calibre_link-1343" id="calibre_link-2737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">LastDateWithSales := MAX ( 'Sales'[OrderDateKey] )</pre></div>
<p class="edition">Different brands, or in general different selections, might return different dates. This is shown in <a href="#calibre_link-1344" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-3</a>.</p>
<figure id="calibre_link-1344" class="image-l">
<img src="images/000866.jpg" alt="The report shows LastDateWithSales per brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-3</strong> Not all brands have the same last date with sales.</figcaption>
</figure>
<p class="edition">An appropriate way to compute the last date with any sales is to remove all the filters before computing the maximum date. This way, August 15, 2009, is used for all the products. If any brand does not have any sales on August 15, the value to use is zero, not the budget of the last day with sales for that brand. Therefore, the correct formulation for <em class="calibre5">LastDateWithSales</em> is the following:</p>
<p class="codelink"><a href="#calibre_link-1345" id="calibre_link-2738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">LastDateWithSales :=
CALCULATE (
    MAX ( 'Sales'[OrderDateKey] ),
    ALL ( Sales )
)</pre></div>
<p class="edition">By removing the filter from <em class="calibre5">Sales</em> (which is the expanded <em class="calibre5">Sales</em> table), the code is ignoring any filter coming from the query, always returning August 15, 2009. At this point, one needs to write code that uses the value of <em class="calibre5">Sales Amount</em> for all the dates before the last date with any sales, and the value of <em class="calibre5">Budget Amt</em> for the dates after. One simple implementation is the following:</p>
<p class="codelink"><a href="#calibre_link-1346" id="calibre_link-2739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Adjusted Budget :=
VAR LastDateWithSales =
    CALCULATE (
        MAX ( Sales[OrderDateKey] ),
<span type="pagebreak" id="calibre_link-3181"></span>        ALL ( Sales )
    )
VAR AdjustedBudget =
    SUMX (
        'Date',
        IF (
            'Date'[DateKey] &lt;= LastDateWithSales,
            [Sales Amount],
            [Budget Amt]
        )
    )
RETURN AdjustedBudget</pre></div>
<p class="edition"><a href="#calibre_link-1347" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-4</a> shows the result of the new <em class="calibre5">Adjusted Budget</em> measure.</p>
<figure id="calibre_link-1347" class="image-l">
<img src="images/000874.jpg" alt="The report shows Budget Amt, Sales Amount, and Adjusted Budget for each month." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-4</strong> <em class="calibre5">Adjusted Budget</em> uses actuals or budget, depending on the date.</figcaption>
</figure>
<p class="edition">At this point, we can investigate the measure’s complexity. The outer iteration performed by <em class="calibre5">SUMX</em> iterates over the <em class="calibre5">Date</em> table. In a year, it iterates 365 times. At every iteration, depending on the value of the date, it scans either the <em class="calibre5">Sales</em> or the <em class="calibre5">Budget</em> table, performing a context transition. It would be good to reduce the number of iterations, thus reducing the number of context transitions and/or aggregations of the larger <em class="calibre5">Sales</em> and <em class="calibre5">Budget</em> tables.</p>
<p class="edition">Indeed, a good solution does not need to iterate over the dates. The only reason to perform the iteration is that the code is more intuitive to read. A slightly different algorithm is the following:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">Split the current selection on <em class="calibre5">Date</em> in two sets: before and after the last date with sales.</p></li>
<li class="calibre25"><p class="listp">Compute the sales for the previous period.</p></li>
<li class="calibre25"><p class="listp">Compute the budget for the future.</p></li>
<li class="calibre25"><p class="listp">Sum sales and budget computed earlier during (2) and (3).</p></li>
</ol>
<p class="edition"><span type="pagebreak" id="calibre_link-1772"></span>Moreover, there is no need to compute sales just for the period before the last date. Indeed, there will be no sales in the future, so there is no need to filter dates when computing the amount of sales. The only measure that needs to be restricted is the budget. In other words, the formula can sum the entire amount of sales plus the budget of the dates after the last date with sales. This leads to a different formulation of the <em class="calibre5">Adjusted Budget</em> measure:</p>
<p class="codelink"><a href="#calibre_link-1348" id="calibre_link-2740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Adjusted Budget Optimized :=
VAR LastDateWithSales =
    CALCULATE (
        MAX ( Sales[OrderDateKey] ),
        ALL ( Sales )
    )
VAR SalesAmount = [Sales Amount]
VAR BudgetAmount =
    CALCULATE (
        [Budget Amt],
        KEEPFILTERS ( 'Date'[DateKey] &gt; LastDateWithSales )
    )
VAR AdjustedBudget = SalesAmount + BudgetAmount
RETURN
    AdjustedBudget</pre></div>
<p class="edition">The results from <em class="calibre5">Adjusted Budget Optimized</em> are identical to those of the <em class="calibre5">Adjusted Budget</em> measure, but the code complexity is much lower. Indeed, the code of <em class="calibre5">Adjusted Budget Optimized</em> only requires one scan of the <em class="calibre5">Sales</em> table and one scan of the <em class="calibre5">Budget</em> table, the latter with an additional filter on the <em class="calibre5">Date</em> table. Please note that <em class="calibre5">KEEPFILTERS</em> is required. Otherwise, the condition on the <em class="calibre5">Date</em> table would override the current context, providing incorrect figures. This final version of the code is slightly harder to read and to understand, but it is much better performance-wise.</p>
<p class="edition">As with previous examples, there are different ways of expressing the same algorithm. Finding the best way requires experience and a solid understanding of the internals of the engine. With that said, simple considerations about the cardinality required in a DAX expression already help a lot in optimizing the code.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-271" class="h2a">Computing same-store sales</h3>
<p class="edition">This scenario is one specific case of a much broader family of calculations. Contoso has several stores all around the world, and each store has different departments, each one selling specific product categories. Departments are continuously updated: Some are opened, others are closed or renewed. When analyzing sales performance, it is important to compare like-for-like&mdash;that is, analyze the sales behavior of comparable departments. Otherwise, one might erroneously conclude that a department performed very poorly, just because for some time in the selected period it had been closed down.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3182"></span>The like-for-like concept can be tailored to every business. In this example, the requirement is to exclusively compare stores and product categories that have sales in the years considered for the analysis. For each product category, a report should solely include stores that have sales in the same years. Variations to this requirement might use the month or the week as granularity in the like-for-like comparison, without changing the approach described as follows.</p>
<p class="edition">For example, consider the report in <a href="#calibre_link-1349" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-5</a>, which analyzes the sales of one product category (Audio) in German stores over three calendar years.</p>
<figure id="calibre_link-1349" class="image-l">
<img src="images/000882.jpg" alt="The matrix shows CY 2007 to 2009, and totals for each row and column. The Audio category is selected." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-5</strong> Several stores were opened and closed over the years, polluting the analysis.</figcaption>
</figure>
<p class="edition">The Berlin store was closed in 2007. Out of the two stores in Koln, one was under maintenance in 2008; it was thus only open two out of the three years considered. In order to achieve a fair comparison of the values calculated, any analysis of sales trends needs to be restricted to stores within the selection that were always open.</p>
<p class="edition">Because the rules of a like-for-like comparison can be complex and require different types of adjustments, it is a good idea to store the status of the comparable elements in a separate table. This way, any complexity in the business logic will not affect the query performance but only the time required to refresh the status table. In this example, the <em class="calibre5">StoresStatus</em> table contains one row for each combination of year, category, and store, alongside with status, which can be Open or Closed. <a href="#calibre_link-1350" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-6</a> shows the status of the German stores, only showing the Open status and hiding the Closed status to improve readability.</p>
<figure id="calibre_link-1350" class="image-l">
<img src="images/000890.jpg" alt="The report shows either open or blanks, for each store for each calendar year, under Audio." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3183"></span><strong class="calibre7">Figure 16-6</strong> The <em class="calibre5">StoresStatus</em> table indicates whether a store is open in a given year and for a given product category.</figcaption>
</figure>
<p class="edition">The most interesting column is the last one: Just four stores have been open for all three years. A relevant trend analysis should consider these four stores exclusively, for Audio sales. Moreover, if one changes the selection on the years, the status changes too. Indeed, if one only selects two years (2007 and 2008), the status of the stores is different, as shown in <a href="#calibre_link-1351" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-7</a>.</p>
<figure id="calibre_link-1351" class="image-l">
<img src="images/000898.jpg" alt="The difference in this report selecting only 2007 and 2008 is that more stores return Open in the last column." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-7</strong> The <em class="calibre5">Total</em> column considers the status of the years included in the report.</figcaption>
</figure>
<p class="edition">The like-for-like measure must perform the following steps:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Determine the stores open in all the years of the report for each product category.</p></li>
<li class="calibre10"><p class="listp">Use the result of the first step to filter the <em class="calibre5">Amount</em> measure, restricting the values to stores and product categories that have sales in all the years included in the report.</p></li>
</ul>
<p class="edition"><span type="pagebreak" id="calibre_link-2060"></span>Before moving further with the example, a deeper analysis of the data model is required. The diagram view is represented in <a href="#calibre_link-1352" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-8</a>.</p>
<figure id="calibre_link-1352" class="image-l">
<img src="images/000905.jpg" alt="The figure shows the diagram view of the data model." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-8</strong> The <em class="calibre5">StoreStatus</em> table has the status of each store for any combination of year and product category.</figcaption>
</figure>
<p class="edition">Let us point out a few things about the model:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The relationship between <em class="calibre5">Date</em> and <em class="calibre5">StoreStatus</em> is an MMR weak relationship based on <em class="calibre5">Year</em>, with the cross-filter direction going towards <em class="calibre5">StoreStatus</em>. <em class="calibre5">Date</em> filters <em class="calibre5">StoreStatus</em>, not the other way around.</p></li>
<li class="calibre10"><p class="listp">The relationship between <em class="calibre5">Product Category</em> and <em class="calibre5">StoreStatus</em> is a regular one-to-many relationship.</p></li>
<li class="calibre10"><p class="listp">All other relationships are regular one-to-many relationships, with a single cross-filter used in many other demos of this book.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">StoreStatus</em> contains one row for each store, product category, and year combination. The status of each row is either Open or Closed. In other words, there are no gaps in the table. This is relevant to reduce the complexity of the formula.</p></li>
</ul>
<p class="edition">The first step is determining which departments are open over all the years selected. To obtain this, the code must filter the <em class="calibre5">StoresStatus</em> table with a given product category and all the selected years. If after having performed this filter, all the filtered rows contain Open in the status, then the department has been open over the whole time period. Otherwise, if there are multiple values (some Open, some Closed), this means that the department was closed at some point. The following query performs this calculation:</p>
<p class="codelink"><a href="#calibre_link-1353" id="calibre_link-2741" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-2061"></span>EVALUATE
VAR StatusGranularity =
    SUMMARIZE (
        Receipts,
        Store[Store Name],
        'Product Category'[Category]
    )
VAR Result =
    FILTER (
        StatusGranularity,
        CALCULATE (
            SELECTEDVALUE ( StoresStatus[Status] ),
            ALLSELECTED ( 'Date'[Calendar Year] )
        ) = "Open"
    )
RETURN
    Result</pre></div>
<p class="edition">The query iterates at the store/category cardinality, and for each of these pairs it checks if the value of the <em class="calibre5">Status</em> is Open for all selected years. In case there are multiple values for <em class="calibre5">StoreStatus[Status]</em>, the result of <em class="calibre5">SELECTEDVALUE</em> is blank preventing the pair from surviving the filter.</p>
<p class="edition">Once we can determine the set of departments open all of the years, the set obtained can be used as a filter to <em class="calibre5">CALCULATE</em> to obtain the result:</p>
<p class="codelink"><a href="#calibre_link-1354" id="calibre_link-2742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">OpenStoresAmt :=
VAR StatusGranularity =
    SUMMARIZE (
        Receipts,
        Store[Store Name],
        'Product Category'[Category]
    )
VAR OpenStores =
    FILTER (
        StatusGranularity,
        CALCULATE (
            SELECTEDVALUE ( StoresStatus[Status] ),
            ALLSELECTED ( 'Date'[Calendar Year] )
        ) = "Open"
    )
VAR AmountLikeForLike =
    CALCULATE (
        [Amount],
        OpenStores
    )
RETURN
    AmountLikeForLike</pre></div>
<p class="edition">Once projected in a matrix, the measure produces the report in <a href="#calibre_link-1355" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-9</a>.</p>
<figure id="calibre_link-1355" class="image-l">
<img src="images/000913.jpg" alt="The report shows values per calendar year and per store, for a specific category, country, and store type." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2005"></span><strong class="calibre7">Figure 16-9</strong> <em class="calibre5">OpenStoreAmt</em> only returns a value if the store has been open in all selected years.</figcaption>
</figure>
<p class="edition">Stores that are not open all the time have disappeared from the report. It is important to learn this technique well because it is one of the most powerful and useful techniques in DAX. The ability to compute a table containing a filter and then use it to restrict the calculation is the foundation of several advanced calculations in DAX.</p>
<p class="edition">In this example, we used an additional table to store the information about whether a store is open or closed. We could have achieved a similar goal by inspecting the <em class="calibre5">Receipts</em> table alone, inferring whether a store was open or closed based on their sales. If there are sales, then the assumption is that the store was open. Unfortunately, the opposite is not quite true. The absence of sales does not imply that the store department selling that category was closed. In an unfortunate and borderline scenario, the absence of sales might simply mean that although the department was open, no sale took place.</p>
<p class="edition">This last consideration is more about data modeling than DAX, yet we felt it was important to mention it. In case one needs to retrieve the information about the store being open from the <em class="calibre5">Receipts</em> table, the formula requires more attention.</p>
<p class="edition">The following measure implements the <em class="calibre5">OpenStoresAmt</em> measure without using the <em class="calibre5">StoresStatus</em> table. For each pair of store and product category, the measure must check whether the number of years in which there are sales is the same as the number of years selected. If a store has sales for just two out of three years, this means that the considered department was closed for one year. The following code is a possible implementation:</p>
<p class="codelink"><a href="#calibre_link-1356" id="calibre_link-2743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">OpenStoresAmt Dynamic :=
VAR SelectedYears =
    CALCULATE (
        DISTINCTCOUNT ( 'Date'[Calendar Year] ),
        CROSSFILTER ( Receipts[SaleDateKey], 'Date'[DateKey], BOTH ),
        ALLSELECTED ()
    )
VAR StatusGranularity =
    SUMMARIZE (
        Receipts,
        Store[Store Name],
        'Product Category'[Category]
    )
<span type="pagebreak" id="calibre_link-1848"></span>VAR OpenStores =
    FILTER (
        StatusGranularity,
        VAR YearsWithSales =
            CALCULATE (
                DISTINCTCOUNT ( 'Date'[Calendar Year] ),
                CROSSFILTER ( Receipts[SaleDateKey], 'Date'[DateKey], BOTH ),
                ALLSELECTED ( 'Date'[Calendar Year] )
            )
        RETURN
            YearsWithSales = SelectedYears
    )
VAR AmountLikeForLike =
    CALCULATE (
        [Amount],
        OpenStores
    )
RETURN
    AmountLikeForLike</pre></div>
<p class="edition">The complexity of this latter version is much higher. Indeed, it requires moving the filter from the <em class="calibre5">Receipts</em> table to the <em class="calibre5">Date</em> table for every product category to compute the number of years with sales. Because&mdash;typically&mdash;the <em class="calibre5">Receipts</em> table is much larger than a table with only the status for the store, this code is slower than the previous solution based on the <em class="calibre5">StoresStatus</em> table. Nevertheless, it is useful to note that the only difference between the previous version and this one is in the condition inside <em class="calibre5">FILTER</em>. Instead of inspecting a dedicated table, the formula needs to scan the <em class="calibre5">Receipts</em> table. The pattern is still the same.</p>
<p class="edition">Another important detail of this code is the way it computes the <em class="calibre5">SelectedYears</em> variable. Here, a simple <em class="calibre5">DISTINCTCOUNT</em> of all the selected years would not fit. Indeed, the value to compute is not the number of all the selected years, but solely the selected years with sales. If there are 10 years in the <em class="calibre5">Date</em> table and just three of them have sales, using a simpler <em class="calibre5">DISTINCTCOUNT</em> would also consider the years with no sales, returning blank on every cell.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-272" class="h2a">Numbering sequences of events</h3>
<p class="edition">This section analyzes a surprisingly common pattern: the requirement to number sequences of events, to easily find the first, the last, and the previous event. In this example, the requirement is to number each order by customer in the Contoso database. The goal is to obtain a new calculated column that contains 1 for the first order of a customer, 2 for the second, and so on. Different customers will have the same number 1 for their first order.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000358.jpg" alt="Image" class="calibre27 pcalibre6" /></span> Warning</p>
<p class="edition">We should start with a big warning: Some of these formulas are slow. We show samples of code to discuss their complexity while searching for a better solution. If you plan to try them on your model, be prepared for a very long calculation time. By “long,” we mean hours of computation and tens of gigabytes of RAM used by the demo model provided. Otherwise, simply follow the description; we show a much better code at the end of the section.</p>
</div>
<p class="edition"><span type="pagebreak" id="calibre_link-1798"></span>The result to obtain is depicted in <a href="#calibre_link-1357" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-10</a>.</p>
<figure id="calibre_link-1357" class="image-l">
<img src="images/000919.jpg" alt="The report shows different order positions for several orders of a same customer." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-10</strong> Within all the orders of a same customer, <em class="calibre5">Order Position</em> contains the relative position of each order.</figcaption>
</figure>
<p class="edition">A first way to compute the order position is the following: for one same customer, the code could count the number of orders that date prior to the current order. Unfortunately, using the date does not work because there are customers who placed multiple orders on the same day; this would generate an incorrect numbering sequence. Luckily, the order number is unique and its value increases for every order. Thus, the formula computes the correct value by counting for one same customer, the number of orders with an order number less than or equal to the current order number.</p>
<p class="edition">The following code implements this logic:</p>
<p class="codelink"><a href="#calibre_link-1358" id="calibre_link-2744" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Order Position] =
VAR CurrentOrderNumber = Sales[Order Number]
VAR Position =
    CALCULATE (
        DISTINCTCOUNT ( Sales[Order Number] ),
        Sales[Order Number] &lt;= CurrentOrderNumber,
        ALLEXCEPT (
            Sales,
            Sales[CustomerKey]
        )
    )
RETURN
    Position</pre></div>
<p class="edition">Although it looks rather straightforward, this code is extremely complex. Indeed, in <em class="calibre5">CALCULATE</em> it uses a filter on the order number and the context transition generated by the calculated column. For each row in <em class="calibre5">Sales</em>, the engine must filter the <em class="calibre5">Sales</em> table itself. Therefore, its complexity is the size of <em class="calibre5">Sales</em> squared. Because <em class="calibre5">Sales</em> contains 100,000 rows, the total complexity is 100,000 multiplied by 100,000; that results in 10 billion. The net result is that this calculated column takes hours to compute. On a larger dataset, it would put any server on its knees.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1799"></span>We discussed the topic of using <em class="calibre5">CALCULATE</em> and context transition on large tables in <a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 5</a>, “<a href="#calibre_link-10" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em>.</a>” A good developer should try to avoid using context transition on large tables; otherwise, they run the risk of incurring poor performance.</p>
<p class="edition">A better implementation of the same idea is the following: Instead of using <em class="calibre5">CALCULATE</em> to apply a filter with the expensive context transition, the code could create a table containing all the combinations of <em class="calibre5">CustomerKey</em> and <em class="calibre5">Order Number</em>. Then, it could apply a similar logic to that table by counting the number of order numbers lower than the current one for that same customer. Here is the code:</p>
<p class="codelink"><a href="#calibre_link-1359" id="calibre_link-2745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Order Position] =
VAR CurrentCustomerKey = Sales[CustomerKey]
VAR CurrentOrderNumber = Sales[Order Number]
VAR CustomersOrders =
    ALL (
        Sales[CustomerKey],
        Sales[Order Number]
    )
VAR PreviousOrdersCurrentCustomer =
    FILTER (
        CustomersOrders,
        AND (
            Sales[CustomerKey] = CurrentCustomerKey,
            Sales[Order Number] &lt;= CurrentOrderNumber
        )
    )
VAR Position =
    COUNTROWS ( PreviousOrdersCurrentCustomer )
RETURN
    Position</pre></div>
<p class="edition">This new formulation is much quicker. First, the number of distinct combinations of <em class="calibre5">CustomerKey</em> and <em class="calibre5">Order Number</em> is 26,000 instead of 100,000. Moreover, by avoiding context transition the optimizer can generate a much better execution plan.</p>
<p class="edition">The complexity of this formula is still high, and the code is somewhat hard to follow. A much better implementation of the same logic uses the <em class="calibre5">RANKX</em> function. <em class="calibre5">RANKX</em> is useful to rank a value against a table, and doing that it can easily compute a sequence number. Indeed, the sequence number of an order is the same value as the ascending ranking of the order in the list of all the orders of the same customer.</p>
<p class="edition">The following is an implementation of the same calculation as the previous formula, this time using <em class="calibre5">RANKX</em>:</p>
<p class="codelink"><a href="#calibre_link-1360" id="calibre_link-2746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Order Position] =
VAR CurrentCustomerKey = Sales[CustomerKey]
VAR CustomersOrders =
    ALL (
        Sales[CustomerKey],
        Sales[Order Number]
    )
VAR OrdersCurrentCustomer =
    FILTER (
        CustomersOrders,
<span type="pagebreak" id="calibre_link-1846"></span>        Sales[CustomerKey] = CurrentCustomerKey
    )
VAR Position =
    RANKX (
        OrdersCurrentCustomer,
        Sales[Order Number],
        Sales[Order Number],
        ASC,
        DENSE
    )
RETURN
    Position</pre></div>
<p class="edition"><em class="calibre5">RANKX</em> is very well optimized. It has an efficient internal sorting algorithm that lets it execute quickly even on large datasets. On the demo database the difference between the last two formulas is not very high, yet a deeper analysis of the query plan reveals that the version with <em class="calibre5">RANKX</em> is the most efficient. The analysis of query plans is a topic discussed in the next chapters of the book.</p>
<p class="edition">Also, in this example there are multiple ways of expressing the same code. Using <em class="calibre5">RANKX</em> to compute a sequence number might not be obvious to a DAX novice, which is the reason we included this example in the book. Showing different versions of the same code provides food for thought.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-273" class="h2a">Computing previous year sales up to last date of sales</h3>
<p class="edition">The following example extends time intelligence calculations with more business logic. The goal is to compute a year-over-year comparison accurately, ignoring in the previous year any sales that took place after a set date. To demonstrate the scenario, we removed from the demo database all sales after August 15, 2009. Therefore, the last year (2009) is incomplete, and so is the month of August 2009.</p>
<p class="edition"><a href="#calibre_link-1361" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-11</a> shows that sales after August 2009 report empty values.</p>
<figure id="calibre_link-1361" class="image-l">
<img src="images/000926.jpg" alt="The report shows sales for each year, per month." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-11</strong> There are no sales after August 2009.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-2058"></span>When the month is present on the report as in the report shown, the numbers are clear. A user would quickly understand that the last year is incomplete; therefore, they would not make a comparison between the total of 2009 against the total of previous years. Nevertheless, a developer could author some code that&mdash;despite being useful&mdash;makes the wrong decisions. Consider the following two measures:</p>
<p class="codelink"><a href="#calibre_link-1362" id="calibre_link-2747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PY Sales :=
CALCULATE (
    [Sales Amount],
    SAMEPERIODLASTYEAR ( 'Date'[Date] )
)

Growth :=
DIVIDE (
    [Sales Amount] - [PY Sales],
    [PY Sales]
)</pre></div>
<p class="edition">A user might easily build a report like the one in <a href="#calibre_link-1363" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-12</a> and erroneously deduce that sales are decreasing dramatically for all the brands.</p>
<figure id="calibre_link-1363" class="image-l">
<img src="images/000933.jpg" alt="The report shows Sales Amount, PY Sales, and Growth as a percentage for each brand, in 2009." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-12</strong> The report seems to indicate a dramatic drop in sales for all the brands.</figcaption>
</figure>
<p class="edition">The report does not perform a fair comparison between 2008 and 2009. For the selected year (2009), it reports the sales up to August 15, 2009, whereas for the previous year it considers the sales of the entire year, including September and later dates.</p>
<p class="edition">An appropriate comparison should exclusively consider sales that occurred before August 15 in all previous years, so to produce meaningful growth percentages. In other words, the data from previous years should be restricted to the dates up to the last day and month of sales in 2009. The cutoff date is the last date for which there are sales reported in the database.</p>
<p class="edition">As usual, there are several ways to solve the problem, and this section presents some of them. The first approach is to modify the <em class="calibre5">PY Sales</em> measure, so that it only considers the dates that happen to <span type="pagebreak" id="calibre_link-3184"></span>be before the last date of sales projected in the previous year. One option to author the code is the following:</p>
<p class="codelink"><a href="#calibre_link-1364" id="calibre_link-2748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PY Sales :=
VAR LastDateInSales =
    CALCULATETABLE (
        LASTDATE ( Sales[Order Date] ),
        ALL ( Sales )
    )
VAR LastDateInDate =
    TREATAS (
        LastDateInSales,
        'Date'[Date]
    )
VAR PreviousYearLastDate =
    SAMEPERIODLASTYEAR ( LastDateInDate )
VAR PreviousYearSales =
    CALCULATE (
        [Sales Amount],
        SAMEPERIODLASTYEAR ( 'Date'[Date] ),
        'Date'[Date] &lt;= PreviousYearLastDate
    )
RETURN
    PreviousYearSales</pre></div>
<p class="edition">The first variable computes the last <em class="calibre5">Order Date</em> in all sales. In the sample data model, it retrieves August 15, 2009. The second variable (<em class="calibre5">LastDateInDate</em>) changes the data lineage of the previous result to <em class="calibre5">Date[Date]</em>. This step is needed because time intelligence functions are expected to work on the date table. Using them on different tables might lead to wrong behaviors, as we will demonstrate later. Once <em class="calibre5">LastDateInDate</em> contains August 15, 2009, with the right data lineage, <em class="calibre5">SAMEPERIODLASTYEAR</em> moves this date one year back. Finally, <em class="calibre5">CALCULATE</em> uses this value to compute the sales in the previous year combining two filters: the current selection moved one year back and every day before August 15, 2008.</p>
<p class="edition">The result of this new formula is visible in <a href="#calibre_link-1365" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-13</a>.</p>
<figure id="calibre_link-1365" class="image-l">
<img src="images/000940.jpg" alt="The report shows Sales Amount, PY Sales, and Growth for each brand, in 2009. The numbers are reasonable." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-13</strong> Considering the right fraction of the year, the results are now comparable.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3185"></span>It is important to understand the reason why the previous formula requires <em class="calibre5">TREATAS</em>. An inexperienced DAX developer might write the same measure with this simpler code:</p>
<p class="codelink"><a href="#calibre_link-1366" id="calibre_link-2749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PY Sales Wrong :=
VAR LastDateInSales =
    CALCULATETABLE (
        LASTDATE ( Sales[Order Date] ),
        ALL ( Sales )
    )
VAR PreviousYearLastDate =
    SAMEPERIODLASTYEAR ( LastDateInSales )
VAR PreviousYearSales =
    CALCULATE (
        [Sales Amount],
        SAMEPERIODLASTYEAR ( 'Date'[Date] ),
        'Date'[Date] &lt;= PreviousYearLastDate
    )
RETURN
    PreviousYearSales</pre></div>
<p class="edition">To make matters worse, on the demo model we provide as an example, this latter measure and the previous measure return the same figures. Therefore, there is a bug that is not evident at first sight. Here is the problem: The result from <em class="calibre5">SAMEPERIODLASTYEAR</em> is a table of one column with the same data lineage as its input column. If one passes a column with the lineage of <em class="calibre5">Sales[Order Date]</em> to <em class="calibre5">SAMEPERIODLASTYEAR</em>, then the function must return a value that exists among the possible values of <em class="calibre5">Sales[Order Date]</em>. Being a column in <em class="calibre5">Sales</em>, <em class="calibre5">Order Date</em> is not expected to contain all the possible values. For example, if there are no sales during a weekend, then that weekend date is not present among the possible values of <em class="calibre5">Sales[Order Date]</em>. In that scenario, <em class="calibre5">SAMEPERIODLASTYEAR</em> returns blank.</p>
<p class="edition"><a href="#calibre_link-1367" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 16-14</a> shows what happens to the report by removing any transaction from August 15, 2008, from the <em class="calibre5">Sales</em> table, for demo purposes.</p>
<figure id="calibre_link-1367" class="image-l">
<img src="images/000947.jpg" alt="The report shows Sales Amount, PY Sales Wrong, and Growth for each brand in 2009. PY Sales Wrong is empty." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 16-14</strong> The boxed area contains the value of <em class="calibre5">PY Sales Wrong</em>, which is always blank.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3186"></span>Because the last date is August 15, 2009, moving this date one year back leads to August 15, 2008, which, on purpose, does not exist in <em class="calibre5">Sales[Order Date]</em>. Therefore, <em class="calibre5">SAMEPERIODLASTYEAR</em> returned a blank. Since <em class="calibre5">SAMEPERIODLASTYEAR</em> returned a blank, the second condition inside <em class="calibre5">CALCULATE</em> imposes that the date be less than or equal to blank. There is no date satisfying the condition; therefore, the <em class="calibre5">PY Sales Wrong</em> measure always returns blank.</p>
<p class="edition">In the example, we removed one date from <em class="calibre5">Sales</em> to show the issue. In the real world, the problem might happen on any date, if on the corresponding day in the previous year there were no sales. Remember: Time intelligence functions are expected to work on a well-designed date table. Using them on columns from different tables might lead to unexpected results.</p>
<p class="edition">Of course, once the overall logic becomes clearer, there can be many ways of expressing the same code. We proposed one version, but you should feel free to experiment.</p>
<p class="edition">Finally, scenarios like this one have a much better solution if one can update the data model. Indeed, computing the last date with sales every time a calculation is required and moving it back one year (or by whatever offset is needed) proves to be a tedious, error-prone task. A much better solution is to pre-calculate whether each date should be included in the comparison or not, and consolidate this value directly in the <em class="calibre5">Date</em> table.</p>
<p class="edition">One could create a new calculated column in the <em class="calibre5">Date</em> table, which indicates whether a given date should be included in the comparison with the last year or not. In other words, all dates before August 15 have a value of <em class="calibre5">TRUE</em>, whereas all the rows after August 15 have a value of <em class="calibre5">FALSE</em>.</p>
<p class="edition">The new calculated column can be authored this way:</p>
<p class="codelink"><a href="#calibre_link-1368" id="calibre_link-2750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">'Date'[IsComparable] =
VAR LastDateInSales =
    MAX ( Sales[Order Date] )
VAR LastMonthInSales =
    MONTH ( LastDateInSales )
VAR LastDayInSales =
    DAY ( LastDateInSales )
VAR LastDateCurrentYear =
    DATE ( YEAR ( 'Date'[Date] ), LastMonthInSales, LastDayInSales )
VAR DateIncludedInCompare =
    'Date'[Date] &lt;= LastDateCurrentYear
RETURN
    DateIncludedInCompare</pre></div>
<p class="edition">Once the column is in place, the <em class="calibre5">PY Sales</em> measure can be authored much more simply:</p>
<p class="codelink"><a href="#calibre_link-1369" id="calibre_link-2751" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">PY Sales :=
CALCULATE (
    [Sales Amount],
    SAMEPERIODLASTYEAR ( 'Date'[Date] ),
    'Date'[IsComparable] = TRUE
)</pre></div>
<p class="edition">Not only is this code easier to read and debug, it is also way faster than the previous implementation. The reason is that it is no longer necessary to use the complex code required to compute the last <span type="pagebreak" id="calibre_link-1847"></span>date in <em class="calibre5">Sales</em>, move it as a filter on <em class="calibre5">Date</em>, and then apply it to the model. The code is now executed with a simple filter argument of <em class="calibre5">CALCULATE</em> that checks for a <em class="calibre5">Boolean</em> value. The takeaway of this example is that it is possible to move a complex logic for a filter in a calculated column, which is computed during data refresh and not when a user is waiting for the report to come up.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-274" class="h2a">Conclusions</h3>
<p class="edition">As you have seen, this chapter does not include any new function of the language. Instead, we wanted to show that the same problem can be approached in several different ways. We have not covered the internals of the engine, which is an important topic to introduce optimizations. However, by performing a simple analysis of the code and simulating its behavior, it is oftentimes possible to consider a better formula for the same scenario.</p>
<p class="edition">Please remember that this chapter is not about patterns. You can freely use this code in your models, but do not assume that it is the best implementation of the pattern. Our goal was to lead you in thinking about the same scenario in different ways.</p>
<p class="edition">As you learn in the next chapters, providing unique patterns in DAX is nearly impossible. The code that runs faster in one data model might not be the top performer in a different data model, or even in the same model with a different data distribution.</p>
<p class="edition">If you are serious about optimizing DAX code, then be prepared for a deep dive in the internals of the engine, discovering all the most intricate details of the DAX query engines. This fascinating and complex trip is about to begin, as soon as you turn to the next page.</p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1370">
<div id="calibre_link-3187" class="calibre2">
<div id="calibre_link-3188" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-22"><span type="pagebreak" id="calibre_link-1986"></span><span class="pd_ash">Chapter 17</span><br class="calibre3" />The DAX engines</h2>
<p class="edition">The goal of the book up to this point has been to provide a solid understanding of the DAX language. On top of gaining further experience through practice, the next goal for you is to write efficient DAX and not just DAX that works. Writing efficient DAX requires understanding the internals of the engine. The next chapters aim to provide the essential knowledge to measure and improve DAX code performance.</p>
<p class="edition">More specifically, this chapter is dedicated to the internal architecture of the engines running DAX queries. Indeed, a DAX query can run on a model that is stored entirely in memory, or entirely on the original data source, or on a mix of these two options.</p>
<p class="edition">Starting from this chapter, we somewhat deviate from DAX and begin to discuss low-level technical details about the implementation of products that use DAX. This is an important topic, but you need to be aware that implementation details change often. We did our best to show information at a level that is not likely to change soon, carefully balancing detail level and usefulness with consistency over time. Nevertheless, given the pace at which technology runs these days, the information might be outdated within a few years. The most up-to-date information is always available online, in blog posts and articles.</p>
<p class="edition">New versions of the engines come out every month, and the query optimizer can change and improve the query execution. Therefore, we aim to teach how the engines work, rather than just provide a few rules about writing DAX code that would quickly become obsolete. We sometimes provide best practices, but remember to always double-check how our suggestions apply to your specific scenario.</p>
<section class="calibre4">
<h3 id="calibre_link-275" class="h2a">Understanding the architecture of the DAX engines</h3>
<p class="edition">The DAX language is used in several Microsoft products based on the Tabular technology. Yet, specific features might only be available in a few editions or license conditions. A Tabular model uses both DAX and MDX as query languages. This section describes the broader architecture of a Tabular model, regardless of the query language and of the limitations of specific products.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1978"></span>Every report sends queries to Tabular using either DAX or MDX. Despite the query language used, the Tabular model uses two engines to process a query:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The <strong class="calibre7">formula engine</strong> (FE), which processes the request, generating and executing a query plan.</p></li>
<li class="calibre10"><p class="listp">The <strong class="calibre7">storage engine</strong> (SE), which retrieves data out of the Tabular model to answer the requests made by the Formula Engine. The Storage Engine has two implementations:</p>
<ul class="bull">
<li class="calibre10"><p class="listp"><strong class="calibre7">VertiPaq</strong> hosts a copy of the data in-memory that is refreshed periodically from the data source.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">DirectQuery</strong> forwards queries directly to the original data source for every request. DirectQuery does not create an additional copy of data.</p></li>
</ul></li></ul>
<p class="edition"><a href="#calibre_link-1371" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-1</a> represents the architecture that executes a DAX or MDX query.</p>
<figure id="calibre_link-1371" class="image-l">
<img src="images/001066.jpg" alt="The figure represents the architecture that executes a query." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 17-1</strong> A query is processed by an architecture using a formula engine and a storage engine.</figcaption>
</figure>
<p class="edition">The formula engine is the higher-level execution unit of the query engine in a Tabular model. It can handle all the operations requested by DAX and MDX functions and can solve complex DAX and MDX expressions. However, when the formula engine must retrieve data from the underlying tables, it forwards part of the requests to the storage engine.</p>
<p class="edition">The queries sent to the storage engine might vary from a simple retrieval of the raw table data to more complex queries aggregating data and joining tables. The storage engine only communicates with the formula engine. The storage engine returns data in an uncompressed format, regardless of the original format of the data.</p>
<p class="edition">A Tabular model usually stores data using either the VertiPaq or the DirectQuery storage engine. However, composite models can use both technologies within the same data model and for the same tables. The choice of which engine to use is made by the engine on a by-query basis.</p>
<p class="edition">This book is exclusively focused on DAX. Be mindful that MDX uses the same architecture when it queries a Tabular model. This chapter describes the different types of storage engines available in a Tabular model, focusing more on the details of the VertiPaq engine because it is the native and faster engine for DAX.</p>
<section class="calibre4">
<h4 id="calibre_link-276" class="calibre13"><span type="pagebreak" id="calibre_link-1932"></span>Introducing the formula engine</h4>
<p class="edition">The formula engine is the absolute core of the DAX execution. Indeed, the formula engine alone is able to understand the DAX language, though it understands MDX as well. The formula engine converts a DAX or MDX query into a query plan describing a list of physical steps to execute. The storage engine part of Tabular is not aware that its queries originated from a model supporting DAX.</p>
<p class="edition">Each step in the query plan corresponds to a specific operation executed by the formula engine. Typical operators of the formula engine include joins between tables, filtering with complex conditions, aggregations, and lookups. These operators typically require data from columns in the data model. In these cases, the formula engine sends a request to the storage engine, which answers by returning a datacache. A datacache is a temporary storage area created by the storage engine and read by the formula engine.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Datacaches are not compressed; datacaches are plain in-memory tables stored in an uncompressed format, regardless of the storage engine they come from.</p>
</div>
<p class="edition">The formula engine always works with datacaches returned by the storage engine or with data structures computed by other formula engine operators. The result of a formula engine operation is not persisted in memory across different executions, even within the same session. On the other hand, datacaches are kept in memory and can be reused in following queries. The formula engine does not have a cache system to reuse results between different queries. DAX relies entirely on the cache features of the storage engine.</p>
<p class="edition">Finally, the formula engine is single-threaded. This means that any operation executed in the formula engine uses just one thread and one core, no matter how many cores are available. The formula engine sends requests to the storage engine sequentially, one query at a time. A certain degree of parallelism is available only within each request to the storage engine, which has a different architecture and can take advantage of multiple cores available. This is described in the next sections.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-277" class="calibre13">Introducing the storage engine</h4>
<p class="edition">The goal of the storage engine is to scan the Tabular database and produce the datacaches needed by the formula engine. The storage engine is independent from DAX. For example, DirectQuery on top of SQL Server uses SQL as the storage engine. SQL was born much earlier than DAX. Although it might seem strange, the internal storage engine of Tabular (known as VertiPaq) is independent from DAX too. The overall architecture is very clean and sound. The storage engine executes exclusively queries allowed by its own set of operators. Depending on the kind of storage engine used, the set of operators might range from very limited (VertiPaq) to very rich (SQL). This affects the performance and the kind of optimizations that a developer should consider when analyzing query plans.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1667"></span>A developer can define the storage engine used for each table, using one of these three options:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Import:</strong> Also called in-memory, or VertiPaq. The content of the table is stored by the VertiPaq engine, copying and restructuring the data from the data source during data refresh.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">DirectQuery:</strong> The content of the table is read from the data source at query time, and it is not stored in memory during data refresh.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Dual:</strong> The table can be queried in both VertiPaq and DirectQuery. During data refresh the table is loaded in memory, but at query time the table may also be read in DirectQuery mode, with the most up-to-date information.</p></li>
</ul>
<p class="edition">Moreover, a table in a Tabular model could be used as an aggregation for another table. Aggregations are useful to optimize storage engine requests, but not to optimize a bottleneck in the formula engine. Aggregations can be defined in both VertiPaq and DirectQuery, though they are commonly defined in VertiPaq to achieve the best query performance.</p>
<p class="edition">The storage engine features a parallel implementation. However, it receives requests from the formula engine, which sends them synchronously. Thus, the formula engine waits for one storage engine query to finish before sending the next one. Therefore, parallelism in the storage engine might be reduced by the lack of parallelism of the formula engine.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-278" class="calibre13">Introducing the VertiPaq (in-memory) storage engine</h4>
<p class="edition">The VertiPaq storage engine is the native lower-level execution unit of the DAX query engine. In certain products it was officially named xVelocity In-Memory Analytical Engine. Nevertheless, it is widely known as VertiPaq, which is the original code name used during development. VertiPaq stores a copy of the data read from the data source in a compressed in-memory format based on a columnar database structure.</p>
<p class="edition">VertiPaq queries are expressed using an internal pseudo-SQL language called xmSQL. xmSQL is not a real query language, but rather a textual representation of a storage engine query. The intent of xmSQL is to give visibility to humans as to how the formula engine is querying VertiPaq. VertiPaq offers a very limited set of operators: In case the calculation requires a more complex evaluation within an internal data scan, VertiPaq can perform a callback to the formula engine.</p>
<p class="edition">The VertiPaq storage engine is multithreaded. The operations performed by the VertiPaq storage engine are very efficient and can scale up on multiple cores. A single storage engine query can increase its parallelism up to one thread for each segment of a table. We will describe segments later in this chapter. Considering that the storage engine can use up to one thread per column segment, one can benefit from the parallelism of the storage engine only when there are many segments involved in the query. In other words, if there are eight storage engine queries, running on a small table (one segment), they will run sequentially one after the other, instead of all in parallel, because of the synchronous nature of communication between the formula engine and the storage engine.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1929"></span>A cache system stores the results produced by the VertiPaq storage engine, holding a limited number of results&mdash;typically the last 512 internal queries per database, but different versions of the engine might use a different number. When the storage engine receives an xmSQL query identical to one already in cache, it returns the corresponding datacache without doing any scan of data in memory. The cache is not involved in security considerations because the row-level security system only influences the formula engine behavior, producing different xmSQL queries in case the user is restricted to seeing specific rows in a table.</p>
<p class="edition">A scan operation made by the storage engine is usually faster than the equivalent scan performed by the formula engine, even with a single thread available. This is because the storage engine is better optimized for these operations and because it iterates over compressed data; the formula engine, on the other hand, can only iterate over datacaches, which are uncompressed.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-279" class="calibre13">Introducing the DirectQuery storage engine</h4>
<p class="edition">The DirectQuery storage engine is a generic definition, describing the scenario where the data is kept in the original data source instead of being copied in the VertiPaq storage. When the formula engine sends a request to the storage engine in DirectQuery mode, it sends a query to the data source in its specific query language. This is SQL most of the time, but it could be different.</p>
<p class="edition">The formula engine is aware of the presence of DirectQuery. Therefore, the formula engine generates a different query plan compared to VertiPaq because it can take advantage of more advanced functions available in the query language used by the data source. For example, SQL can manage string transformations such as <em class="calibre5">UPPER</em> and <em class="calibre5">LOWER</em>, whereas the VertiPaq engine does not have any string manipulation functions available.</p>
<p class="edition">Any optimization of the storage engine using DirectQuery requires an optimization of the data source&mdash;for example, using indexes in a relational database. More details about DirectQuery and the possible optimizations are available in the following white paper: <a href="https://www.sqlbi.com/whitepapers/directquery-in-analysis-services-2016/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.sqlbi.com/whitepapers/directquery-in-analysis-services-2016/</a>. The considerations are valid for both Power BI and Analysis Services because they share the same underlying engine.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-280" class="calibre13">Understanding data refresh</h4>
<p class="edition">DAX runs on SQL Server Analysis Services (SSAS) Tabular, Azure Analysis Services (same as SSAS in this book), Power BI service (both on server and on the local Power BI Desktop), and in the Power Pivot for Microsoft Excel add-in. Technically, both Power Pivot for Excel and Power BI use a customized version of SSAS Tabular. Speaking about different engines is thus somewhat artificial: Power Pivot and Power BI are like SSAS although SSAS runs in a hidden mode. In this book, we do not discriminate between these engines; when we mention SSAS, the reader should always mentally replace SSAS with Power Pivot or Power BI. If there are differences worth highlighting, then we will note them in that specific section.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1876"></span>When SSAS loads the content of a source table in memory, we say that it processes the table. This takes place during the process operation of SSAS or during the data refresh in Power Pivot for Excel and Power BI. The table process for DirectQuery simply clears the internal cache without executing any access to the data source. On the other hand, when processing occurs in VertiPaq mode, the engine reads the content of the data sources and transforms it into the internal VertiPaq data structure.</p>
<p class="edition">VertiPaq processes a table following these few steps:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">Reading of the source dataset, transformation into the columnar data structure of VertiPaq, encoding and compressing of each column.</p></li>
<li class="calibre25"><p class="listp">Creating of dictionaries and indexes for each column.</p></li>
<li class="calibre25"><p class="listp">Creating of the data structures for relationships.</p></li>
<li class="calibre25"><p class="listp">Computing and compressing all the calculated columns and calculated tables.</p></li>
</ol>
<p class="edition">The last two steps are not necessarily sequential. Indeed, a relationship can be based on a calculated column, or calculated columns can depend on a relationship because they use <em class="calibre5">RELATED</em> or <em class="calibre5">CALCULATE</em>. Therefore, SSAS creates a complex graph of dependencies to execute the steps in the correct order.</p>
<p class="edition">In the next sections, we describe these steps in more detail. We also cover the format of the internal structures created by SSAS during the transformation of the data source into the VertiPaq model.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-281" class="h2a">Understanding the VertiPaq storage engine</h3>
<p class="edition">The VertiPaq engine is the most common storage engine used in Tabular models. VertiPaq is used whenever a table is in Import storage mode. This is the common choice in many data models, and it is the only choice in Power Pivot for Excel. In composite models, the presence of tables or aggregations in dual storage mode also implies the use of the VertiPaq storage engine combined with DirectQuery.</p>
<p class="edition">For these reasons, a solid knowledge of the VertiPaq storage engine is a basic skill required to understand how to optimize both the memory consumption of the model and the execution time of the queries. In this section, we describe how the VertiPaq storage works.</p>
<section class="calibre4">
<h4 id="calibre_link-282" class="calibre13">Introducing columnar databases</h4>
<p class="edition">VertiPaq is an in-memory columnar database. Being in-memory means that all the data handled by a model reside in RAM. But VertiPaq is not only in-memory; it is also a columnar database. Therefore, it is relevant to have a good understanding of what a columnar database is in order to correctly understand VertiPaq.</p>
<p class="edition">We think of a table as a list of rows, where each row is divided into columns. For example, consider the <em class="calibre5">Product</em> table in <a href="#calibre_link-1372" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-2</a>.</p>
<figure id="calibre_link-1372" class="image-l">
<img src="images/001073.jpg" alt="In this figure we see the Product table." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3189"></span><strong class="calibre7">Figure 17-2</strong> The figure shows the <em class="calibre5">Product</em> table, with four columns and nine rows.</figcaption>
</figure>
<p class="edition">Thinking of a table as a set of rows, we are using the most natural visualization of a table structure. Technically, this is known as a <em class="calibre5">row store</em>. In a row store, data is organized in rows. When the table is stored in memory, we might think that the value of the <em class="calibre5">Name</em> column in the first row is adjacent to the values of the <em class="calibre5">ID</em> and <em class="calibre5">Color</em> columns in the same row. On the other hand, the value in the second row of the <em class="calibre5">Name</em> column is slightly farther from the <em class="calibre5">Name</em> value in the first row because in between we find <em class="calibre5">Color</em> and <em class="calibre5">Unit Price</em> in the first row, and the value of the <em class="calibre5">ID</em> column in the second row. As an example, the following code is a schematic representation of the physical memory layout of a row store:</p>
<p class="codelink"><a href="#calibre_link-1373" id="calibre_link-2753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ID,Name,Color,Unit Price|1,Camcorder,Red,112.25|2,Camera,Red,97.50|3,Smartphone,
White,100.00|4,Console,Black,112.25|5,TV,Blue,1,240.85|6,CD,Red,39.99|7,
Touch screen,Blue,45.12|8,PDA,Black,120.25,9,Keyboard,Black,120.50</pre></div>
<p class="edition">Imagine a developer needs to compute the sum of <em class="calibre5">Unit Price</em>: The engine must scan the entire memory area, reading many irrelevant values in the process. Imagine scanning the memory of the database sequentially: To read the first value of <em class="calibre5">Unit Price</em>, the engine needs to read (and skip) the first row of <em class="calibre5">ID</em>, <em class="calibre5">Name</em>, and <em class="calibre5">Color</em>. Only then does it find an interesting value. The same process is repeated for all the rows. Following this technique, the engine needs to read and ignore many columns to find the relevant values to sum.</p>
<p class="edition">Reading and ignoring values take time. In fact, if we asked someone to compute the sum of <em class="calibre5">Unit Price</em>, they would not follow that algorithm. Instead, as human beings, they would probably scan the first row in <a href="#calibre_link-1372" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-2</a> searching for the position of <em class="calibre5">Unit Price</em>, and then move their eyes down, reading the values one at a time and mentally accumulating them to produce the sum. The reason for this very natural behavior is that we save time by reading vertically instead of row-by-row.</p>
<p class="edition">A columnar database organizes data to optimize vertical scanning. To obtain this result, it needs a way to make the different values of a column adjacent to one another. In <a href="#calibre_link-1374" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-3</a> you can see the same <em class="calibre5">Product</em> table as organized by a columnar database.</p>
<figure id="calibre_link-1374" class="image-l">
<img src="images/001080.jpg" alt="The figure shows four separate columns, with a color code." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3190"></span><strong class="calibre7">Figure 17-3</strong> The <em class="calibre5">Product</em> table organized column-by-column.</figcaption>
</figure>
<p class="edition">When stored in a columnar database, each column has its own data structure; it is physically separated from the others. Thus, the different values of <em class="calibre5">Unit Price</em> are adjacent to one another and distant from <em class="calibre5">Color</em>, <em class="calibre5">Name</em>, and <em class="calibre5">ID</em>. The following code is a schematic representation of the physical memory layout of a column store:</p>
<p class="codelink"><a href="#calibre_link-1375" id="calibre_link-2754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ID,1,2,3,4,5,6,7,8,9
Name,Camcorder,Camera,Smartphone,Console,TV,CD,Touch screen,PDA,Keyboard
Color,Red,Red,White,Black,Blue,Red,Blue,Black,Black
Unit Price,112.25,97.50,100.00,112.25,1240.85,39.99,45.12,120.25,120.50</pre></div>
<p class="edition">With this data structure, computing the sum of <em class="calibre5">Unit Price</em> is much easier because the engine immediately goes to the structure containing <em class="calibre5">Unit Price</em>. There, it finds all the values needed to perform the computation next to each other. In other words, it does not have to read and ignore other column values: In a single scan, it obtains exclusively the useful numbers, and it can quickly aggregate them.</p>
<p class="edition">In our next scenario, instead of summing <em class="calibre5">Unit Price</em>, we compute the sum of <em class="calibre5">Unit Price</em> just for the Red products. You are encouraged to give this a try before reading on, in order to better understand the algorithm.</p>
<p class="edition">This is not so easy anymore; indeed, it is no longer possible to obtain the desired number by simply scanning the <em class="calibre5">Unit Price</em> column. What developers would typically do is scan the <em class="calibre5">Color</em> column, and whenever it is Red, retrieve the corresponding value in <em class="calibre5">Unit Price</em>. At the end, all the values would be summed up to compute the result.</p>
<p class="edition">Though very intuitive, this algorithm requires a constant move of the eyes from one column to the other in <a href="#calibre_link-1374" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-3</a>, possibly using a finger as a guide to save the last scanned position of <em class="calibre5">Color</em>. It is not an optimized way of computing the value. The reason is that the engine needs to constantly jump from one memory area to another, resulting in poor performance. A better way&mdash;which only computers use&mdash;is to first scan the <em class="calibre5">Color</em> column, find the positions where the color is Red, and then scan the <em class="calibre5">Unit Price</em> column, summing only the values in the positions identified in the previous step.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1877"></span>This last algorithm is much better because it performs one scan of the first column and one scan of the second column, always accessing memory locations that are adjacent to one another&mdash;other than the jump between the scan of the first and second column. Sequential reading of memory is much faster than random access.</p>
<p class="edition">For a more complex expression, such as the sum of all products that are either Blue or Black with a price higher than US$50, things are even worse. This time, there is no possibility of scanning the column one at a time because the condition depends on way too many columns. As usual, trying on paper helps better understand the problem.</p>
<p class="edition">The simplest algorithm producing the desired result is to scan the table not on a column basis, but on a row basis instead. We naturally tend to scan the table row-by-row, though the storage organization is column-by-column. Although it is a very simple operation when executed on paper by a human, the same operation is extremely expensive if executed by a computer in RAM; indeed, it requires a lot of random reads of memory, leading to poorer performance than if computed doing a sequential scan.</p>
<p class="edition">As discussed, a columnar storage presents both pros and cons. Columnar databases provide very quick access to a single column; but as soon as one needs a calculation involving many columns, they need to spend some time&mdash;after having read the column content&mdash;to reorganize the information so that the final expression can be computed. Even though this example was very simple, it helps highlight the most important characteristics of column stores:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Single-column access is very fast: It sequentially reads a single block of memory and then computes whatever aggregation is needed on that memory block.</p></li>
<li class="calibre10"><p class="listp">If an expression uses many columns, the algorithm is more complex because it requires the engine to access different memory areas at different times, keeping track of the progress in a temporary area.</p></li>
<li class="calibre10"><p class="listp">The more columns are needed to compute an expression, the harder it becomes to produce a result. At a certain point it becomes easier to rebuild the row storage out of the column store to compute the expression.</p></li>
</ul>
<p class="edition">Column stores aim to reduce the read time. However, they spend more CPU cycles to rearrange the data when many columns from the same table are used. Row stores, on the other hand, have a more linear algorithm to scan data, but they result in many useless reads. As a rule, reducing reads at the cost of increasing CPU usage is a good deal, because with modern computers, it is always easier (and cheaper) to increase the CPU speed versus reducing I/O (or memory access) time.</p>
<p class="edition">Moreover, as we will see in the next sections, columnar databases have more options to reduce the amount of time spent scanning data. The most relevant technique used by VertiPaq is compression.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-283" class="calibre13">Understanding VertiPaq compression</h4>
<p class="edition">In the previous section, you learned that VertiPaq stores each column in a separate data structure. This simple fact allows the engine to implement some extremely important compressions and encoding described in this section.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1891"></span>The actual details of the compression algorithm of VertiPaq are proprietary. Thus, we cannot publish them in a book. Yet what we explain in this chapter is already a good approximation of what takes place in the engine, and we can use it, for all intents and purposes, to describe how the VertiPaq engine stores data.</p>
</div>
<p class="edition">VertiPaq compression algorithms aim to reduce the memory footprint of a data model. Reducing the memory usage is a very important task for two very good reasons:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">A smaller model makes better use of the hardware. Why spend money on 1 TB of RAM when the same model, once compressed, can be hosted in 256 GB? Saving RAM is always a good option, if feasible.</p></li>
<li class="calibre10"><p class="listp">A smaller model is faster to scan. As simple as this rule is, it is very important when speaking about performance. If a column is compressed, the engine will scan less RAM to read its content, resulting in better performance.</p></li>
</ul>
<section class="calibre4">
<h5 id="calibre_link-3191" class="calibre13">Understanding value encoding</h5>
<p class="edition">Value encoding is the first kind of encoding that VertiPaq might use to reduce the memory cost of a column. Consider a column containing the price of products, stored as integer values. The column contains many different values and a defined number of bits is required to represent all of them.</p>
<p class="edition">In the <a href="#calibre_link-1376" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-4</a> example, the maximum value of <em class="calibre5">Unit Price</em> is 216. At least 8 bits are required to store each integer value up to that number. Nevertheless, by using a simple mathematical operation, we can reduce the storage to 5 bits.</p>
<figure id="calibre_link-1376" class="image-l">
<img src="images/001087.jpg" alt="The figure demonstrates the concept of value encoding." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 17-4</strong> By using simple mathematical operations, VertiPaq reduces the number of bits needed for a column.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1892"></span>In the example, VertiPaq found out that by subtracting the minimum value (194) from all the values of the column, it could modify the range of the values in the column, reducing it to a range from 0 to 22. Storing numbers up to 22 requires fewer bits than storing numbers up to 216. While 3 bits might seem like an insignificant savings, when we multiply this by a few billion rows, it is easy to see that the difference can be important.</p>
<p class="edition">The VertiPaq engine is much more sophisticated than this. It can discover mathematical relationships between the values of a column, and when it finds them, it can use them to modify the storage. This reduces its memory footprint. Obviously, when using the column, it must reapply the transformation in the opposite direction to obtain the original value. Depending on the transformation, this can happen before or after aggregating the values. Again, this increases the CPU usage and reduces the number of reads, which is a very good option.</p>
<p class="edition">Value encoding only takes place for integer columns because it cannot be applied on strings or floating-point values. Be mindful that VertiPaq stores the <em class="calibre5">Currency</em> data type of DAX (also called Fixed Decimal Number) as an integer value. Therefore, currencies can be value-encoded too, whereas floating point numbers cannot.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-3192" class="calibre13">Understanding hash encoding</h5>
<p class="edition">Hash encoding (also known as dictionary encoding) is another technique used by VertiPaq to reduce the number of bits required to store a column. Hash encoding builds a dictionary of the distinct values of a column and then replaces the column values with indexes to the dictionary. In <a href="#calibre_link-1377" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-5</a> you can see the storage of the <em class="calibre5">Color</em> column, which uses strings and cannot be value-encoded.</p>
<figure id="calibre_link-1377" class="image-l">
<img src="images/001094.jpg" alt="The figure shows the concept of hash encoding." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 17-5</strong> Hash encoding consists of building a dictionary and replacing values with indexes.</figcaption>
</figure>
<p class="edition">When VertiPaq encodes a column with hash encoding, it</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Builds a dictionary, containing the distinct values of the column.</p></li>
<li class="calibre10"><p class="listp">Replaces the values with integer numbers, where each number is the dictionary index of the original value.</p></li>
</ul>
<p class="edition"><span type="pagebreak" id="calibre_link-1893"></span>There are some advantages in using hash encoding:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">All columns only contain integer values; this makes it simpler to optimize the internal code of the engine. Moreover, it also means that VertiPaq is data type independent.</p></li>
<li class="calibre10"><p class="listp">The number of bits used to store a single value is the minimum number of bits necessary to store an index entry. In the example provided, 2 bits are enough because there are only four different values.</p></li>
</ul>
<p class="edition">These two aspects are of paramount importance for VertiPaq. It does not matter whether a column uses a string, a 64-bit integer, or a floating point to represent a value. All these data types can be hash encoded, providing the same performance in terms of speed of scanning and of storage space. The only difference might be in the size of the dictionary, which is typically very small when compared with the size of the original column itself.</p>
<p class="edition">The primary factor to determine the column size is not the data type. Instead, it is the number of distinct values of the column. We refer to the number of distinct values of a column as its <em class="calibre5">cardinality</em>. Repeating a concept this important is always a good thing: Of all the various aspects of an individual column, the most important one when designing a data model is its cardinality.</p>
<p class="edition">The lower the cardinality, the smaller the number of bits required to store a single value. Consequently, the smaller the memory footprint of the column. If a column is smaller, not only will it be possible to store more data in the same amount of RAM, but it will also be much faster to scan it whenever the engine needs to aggregate its values in a DAX expression.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-3193" class="calibre13">Understanding Run Length Encoding (RLE)</h5>
<p class="edition">Hash encoding and value encoding are two very good compression techniques. However, there is another complementary compression technique used by VertiPaq: Run Length Encoding (RLE). This technique aims to reduce the size of a dataset by avoiding repeated values. For example, consider a column storing in which quarter the sales took place, stored in the <em class="calibre5">Sales</em> table. This column might contain the string “Q1” repeated many times in contiguous rows, for all the sales in the same quarter. In such a case, VertiPaq avoids storing values that are repeated. It replaces them with a slightly more complex structure that contains the value only once, with the number of contiguous rows having the same value. This is shown in <a href="#calibre_link-1378" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-6</a>.</p>
<figure id="calibre_link-1378" class="image-l">
<img src="images/001102.jpg" alt="The figure shows the concept of Run Length Encoding." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3194"></span><strong class="calibre7">Figure 17-6</strong> RLE replaces values that are repeated with the number of contiguous rows with the same value.</figcaption>
</figure>
<p class="edition">RLE’s efficiency strongly depends on the repetition pattern of the column. Some columns have the same value repeated for many rows, resulting in a great compression ratio. Other columns with quickly changing values produce a lower compression ratio. Data sorting is extremely important to improve the compression ratio of RLE. Therefore, finding an optimal sort order is an important step of the data refresh performed by VertiPaq.</p>
<p class="edition">Finally, there could be columns in which the content changes so often that if VertiPaq tried to compress them using RLE, the compressed columns would end up using more space than the original columns. A great example of this is the primary key of a table. It has a different value for each row, resulting in an RLE version larger than the column itself. In cases like this, VertiPaq skips the RLE compression and stores the column as-is. Thus, the VertiPaq storage of a column never exceeds the original column size. Worst-case scenario, both would be the same size.</p>
<p class="edition">In the example, we have shown RLE working on a <em class="calibre5">Quarter</em> column containing strings. RLE can also process the already hash-encoded version of a column. Each column can have both RLE and either hash or value encoding. Therefore, the VertiPaq storage for a column compressed with hash encoding consists of two distinct entities: the dictionary and the data rows. The latter is the RLE-encoded result of the hash-encoded version of the original column, as shown in <a href="#calibre_link-1379" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-7</a>.</p>
<figure id="calibre_link-1379" class="image-l">
<img src="images/001108.jpg" alt="This figure shows Run Length Encoding combined with hash encoding." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3195"></span><strong class="calibre7">Figure 17-7</strong> RLE is applied to the dictionary-encoded version of a column.</figcaption>
</figure>
<p class="edition">VertiPaq also applies RLE to value-encoded columns. In this case the dictionary is missing because the column already contains value-encoded integers.</p>
<p class="edition">The factors influencing the compression ratio of a Tabular model are, in order of importance:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">The cardinality of the column, which defines the number of bits used to store a value.</p></li>
<li class="calibre25"><p class="listp">The number of repetitions, that is, the distribution of data in a column. A column with many repeated values is compressed more than a column with very frequently changing values.</p></li>
<li class="calibre25"><p class="listp">The number of rows in the table.</p></li>
<li class="calibre25"><p class="listp">The data type of the column, which only affects the dictionary size.</p></li>
</ol>
<p class="edition">Given all these considerations, it is nearly impossible to predict the compression ratio of a table. Moreover, while a developer has full control over certain aspects of a table&mdash;they can limit the number of rows and change the data types&mdash;these are the least important aspects. Yet as you learn in the next chapter, one can work on cardinality and repetitions too. This improves the compression and performance of a model.</p>
<p class="edition">Finally, it is worth noting that reducing the cardinality of a column also increases the chances of repetitions. For example, if a time column is stored at the second granularity, then the column contains up <span type="pagebreak" id="calibre_link-1894"></span>to 86,400 distinct values. If, on the other hand, the developer stores the same time column at the hour granularity, then not only have they reduced the cardinality, but they also introduced repeating values. Indeed, 3,600 seconds convert to one same hour. All this results in a much better compression ratio. On the other hand, changing the data type from <em class="calibre5">DateTime</em> to <em class="calibre5">Integer</em> or even <em class="calibre5">String</em> offers a negligible impact on column size.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-3196" class="calibre13">Understanding re-encoding</h5>
<p class="edition">SSAS must decide which algorithm to use to encode each column. More specifically, it needs to decide whether to use value or dictionary encoding. In order to make an educated decision, it reads a row sample during the first scan of the source, and it chooses a compression algorithm depending on the values found.</p>
<p class="edition">If the data type of the column is not <em class="calibre5">Integer</em>, then the choice is straightforward: SSAS goes for dictionary encoding. For integer values, it uses some heuristics, for example:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">If the numbers in the column increase linearly, it is probably a primary key and value encoding is the best option.</p></li>
<li class="calibre10"><p class="listp">If all numbers fall within a defined range of values, then value encoding is the way to go.</p></li>
<li class="calibre10"><p class="listp">If the numbers fall within a very wide range of values, with values very different from another, then dictionary encoding is the best choice.</p></li>
</ul>
<p class="edition">Once the decision is made, SSAS starts to compress the column using the chosen algorithm. Unfortunately, it sometimes makes the wrong decision and finds this out only very late during processing. For example, SSAS might read a few million rows where the values are in the 100”“201 range, so value encoding is the best choice. After those millions of rows, suddenly an outlier appears, such as a large number like 60,000,000. Obviously, the initial choice was wrong because the number of bits needed to store such a large number is huge. What should SSAS do then? Instead of continuing with the wrong choice, SSAS can decide to re-encode the column. This means that the entire column is re-encoded using dictionary encoding. This process might take a long time because SSAS needs to reprocess the whole column.</p>
<p class="edition">For very large datasets where processing time is important, a best practice is the following: the data distribution in the first set of rows read by SSAS should be of such quality that all types of values are represented. This in turn reduces re-encoding to a minimum. Developers do so by providing a quality sample in the first partition processed or by providing an encoding hint parameter to the column.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The Encoding Hint property was introduced in Analysis Services 2017, and it is not available in all products.</p>
</div>
</section>
<section class="calibre4">
<h5 id="calibre_link-3197" class="calibre13"><span type="pagebreak" id="calibre_link-1994"></span>Finding the best sort order</h5>
<p class="edition">As we said earlier, RLE’s efficiency strongly depends on the sort order of the table. All the columns of the same table are sorted the same way to keep integrity of the data at the table level. In large tables it is important to determine the best sorting of data to improve the efficiency of RLE and to reduce the memory footprint of the model.</p>
<p class="edition">When SSAS reads a table, it tries different sort orders to improve the compression. In a table with many columns, this is a very expensive operation. SSAS then sets an upper limit to the time it can spend finding the best sort order. The default can change with different versions of the engine. At printing time, the default is currently 10 seconds per million rows. One can modify its value in the <em class="calibre5">ProcessingTimeboxSecPerMRow</em> entry in the configuration file of the SSAS service. Power BI and Power Pivot do not provide access to this value.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">SSAS searches for the best sort order in the data, using a heuristic algorithm that certainly also considers the physical order of the rows it receives. For this reason, although one cannot force the sort order used by VertiPaq for RLE, it is possible to provide the engine with data sorted arbitrarily. The VertiPaq engine includes this sort order in the options to consider.</p>
</div>
<p class="edition">To attain maximum compression, one can set the value of <em class="calibre5">ProcessingTimeboxSecPerMRow</em> to 0, which means SSAS stops searching only when it finds the best compression factor. The benefit in terms of space usage and query speed can vary. On the other hand, processing will take much longer because the engine is being instructed to try all the possible sort orders before making a choice.</p>
<p class="edition">Generally, developers should put the columns with the least number of unique values first in the sort order because these columns are likely to generate many repeating values. Still, keep in mind that finding the best sort order is a very complex task. It only makes sense to spend time on this when the data model is really large (in the order of a few billion rows). Otherwise, the benefit obtained from these extreme optimizations is limited.</p>
<p class="edition">Once all the columns are compressed, SSAS completes the processing by building calculated columns, tables, hierarchies, and relationships. Hierarchies and relationships are additional data structures needed by VertiPaq to execute queries, whereas calculated columns and tables are added to the model by using DAX expressions.</p>
<p class="edition">Calculated columns, like all other columns, are compressed after they are computed. However, calculated columns are not the same as standard columns. Calculated columns are compressed during the final stage of processing, when all the other columns have already finished their compression. Consequently, VertiPaq does not consider calculated columns when choosing the best sort order for a table.</p>
<p class="edition">Consider creating a calculated column that results in a <em class="calibre5">Boolean</em> value. There being only two values, the calculated column can be compressed very well (1 bit is enough to store a <em class="calibre5">Boolean</em> value), and it is a very good candidate to be first in the sort order list. Indeed, doing this, the table shows all the <em class="calibre5">True</em> <span type="pagebreak" id="calibre_link-1993"></span>values first and only later the <em class="calibre5">False</em> values. Being a calculated column, the sort order is already defined by other columns; it might be the case that with the defined sort order, the calculated column frequently changes its value. In that case, the column ends up with less-than-optimal compression.</p>
<p class="edition">Whenever there is a chance to compute a column in DAX or in the data source (including Power Query), keep in mind that computing it in the data source results in slightly better compression. Many other factors may drive the choice of DAX instead of Power Query or SQL to calculate the column. For example, the engine automatically computes a calculated column in a large table depending on a column in a small table, whenever said small table has a partial or full refresh. This happens without having to reprocess the entire large table, which would be necessary if the computation were in Power Query or SQL. This is something to consider when looking for the optimal compression.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">A calculated table has the same compression as a regular table, without the side effects described for calculated columns. However, creating a calculated table can be quite expensive. Indeed, a calculated table requires enough memory to keep a copy of the entire uncompressed table in memory before it is compressed. Carefully think before creating a large calculated table because of the memory pressure generated at refresh time.</p>
</div>
</section>
<section class="calibre4">
<h5 id="calibre_link-3198" class="calibre13">Understanding hierarchies and relationships</h5>
<p class="edition">As we said in the previous sections, at the end of table processing, SSAS builds two additional data structures: hierarchies and relationships.</p>
<p class="edition">There are two types of hierarchies: attribute hierarchies and user hierarchies. Hierarchies are data structures used primarily to improve performance of MDX queries and also to improve certain search operations in DAX. Because the concept of hierarchy is not present in the DAX language, hierarchies are not relevant to the topics of this book.</p>
<p class="edition">Relationships, on the other hand, play an important role in the VertiPaq engine; it is important to understand how they work for extreme optimizations. We will describe the role of relationships in a query in following chapters. Here, we are only interested in defining what relationships are, in terms of VertiPaq storage and behavior.</p>
<p class="edition">A relationship is a data structure that maps IDs from one table to row numbers in another table. For example, consider the columns <em class="calibre5">ProductKey</em> in <em class="calibre5">Sales</em> and <em class="calibre5">ProductKey</em> in <em class="calibre5">Product</em>. These two columns are used to build the relationship between the two tables. <em class="calibre5">Product[ProductKey]</em> is a primary key. Because it is a primary key, the engine used value encoding and no compression at all. Indeed, RLE could not reduce the size of a column in the absence of duplicated values. On the other hand, <em class="calibre5">Sales[ProductKey]</em> is likely to have been dictionary-encoded and compressed. This is because it probably contains many repetitions. Therefore, despite the columns having the same name and data type, their internal data structures are completely different.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1990"></span>Moreover, because they are part of a relationship, VertiPaq knows that queries are likely to use the columns very often placing a filter on <em class="calibre5">Product</em> and also expecting to filter <em class="calibre5">Sales</em>. VertiPaq would be very slow if&mdash;every time it needs to move a filter from <em class="calibre5">Product</em> to <em class="calibre5">Sales</em>&mdash;it had to perform the following: retrieve values from <em class="calibre5">Product[ProductKey]</em>, search them in the dictionary of <em class="calibre5">Sales[ProductKey]</em>, and finally retrieve the IDs of <em class="calibre5">Sales[ProductKey]</em> to place the filter.</p>
<p class="edition">Therefore, to improve query performance, VertiPaq stores relationships as pairs of IDs and row numbers. Given the ID of a <em class="calibre5">Sales[ProductKey]</em>, it can immediately find the corresponding rows of <em class="calibre5">Product</em> that match the relationship. Relationships are stored in memory, as any other data structure of VertiPaq. <a href="#calibre_link-1380" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-8</a> shows how the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em> is stored in VertiPaq.</p>
<figure id="calibre_link-1380" class="image-l">
<img src="images/001116.jpg" alt="The figure shows how the relationship between Sales and Product is stored." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 17-8</strong> The figure shows the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em>.</figcaption>
</figure>
<p class="edition">Even though the structure does not seem to be very intuitive, later in this chapter we describe how VertiPaq uses relationships and why relationships have this very specific structure. It would come naturally that it is a complex structure optimized for performance.</p>
</section>
</section>
<section class="calibre4">
<h4 id="calibre_link-284" class="calibre13">Understanding segmentation and partitioning</h4>
<p class="edition">Compressing a table of several billion rows in one single step would be extremely memory-intensive and time-consuming. Therefore, the table is not processed as a single unit. Instead, during processing, SSAS splits the table into segments that contain 8 million rows each by default. When a segment is completely read, the engine starts to compress the segment while reading the next segment in the meantime.</p>
<p class="edition">It is possible to configure the segment size in SSAS using the <em class="calibre5">DefaultSegmentRowCount</em> entry in the configuration file of the service (or in the server properties in Management Studio). In Power BI Desktop and Power Pivot, the segment size has a set value of 1 million rows, and it cannot be changed.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1991"></span>Segmentation is important for several reasons, including query parallelisms and compression efficiency. When querying a table, VertiPaq uses the segments as the basis for parallelism: It uses one core per segment when scanning a column. By default, SSAS always uses one single thread to scan a table with 8 million rows or less. We start observing parallelism in action only on much larger tables.</p>
<p class="edition">The larger the segment, the better the compression. Having the option of analyzing more rows in a single compression step, VertiPaq can achieve better compression levels. On very large tables, it is important to test different segment sizes and measure the memory usage to achieve optimal compression. Keep in mind that increasing the segment size can negatively affect processing time: The larger the segment, the slower the processing.</p>
<p class="edition">Although the dictionary is global to the table, bit-sizing takes place at the segment level. Thus, if a column has 1,000 distinct values but only two distinct values are used in a specific segment, then that column will be compressed to a single bit for that segment.</p>
<p class="edition">If segments are small, then the parallelism at query time is increased. This is not always a good thing. While it is true that scanning the column is faster because more cores can do that in parallel, VertiPaq needs more time at the end of the scan to aggregate partial results computed by the different threads. If a partition is too small, then the time required for managing task switching and final aggregation is more than the time needed to scan the data, with a negative impact on the overall query performance.</p>
<p class="edition">During processing, the treatment of the first segment is particular if the table has only one partition. Indeed, the first segment can be larger than <em class="calibre5">DefaultSegmentRowCount</em>. VertiPaq reads twice the size of <em class="calibre5">DefaultSegmentRowCount</em> and starts to segment a table only if the table contains more rows. This does not apply to a partitioned table. If a table is partitioned, then all the segments are smaller than the default segment row count. Consequently, in SSAS a nonpartitioned table with 10 million rows is stored as a single segment. On the other hand, a table with 20 million rows uses three segments: two containing 8 million rows and one containing 4 million rows. In Power BI Desktop and Power Pivot, VertiPaq uses multiple segments for tables with more than 2 million rows.</p>
<p class="edition">Segments cannot exceed the partition size. If the partitioning schema of a model creates partitions of only 1 million rows, then all the segments will be smaller than 8 million rows; namely, they will be same as the partition size. Overpartitioning a table is a common mistake made by novices to optimize performance. What they obtain is the opposite effect: Creating too many small partitions typically lowers performance.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-285" class="calibre13">Using Dynamic Management Views</h4>
<p class="edition">SSAS enables the discovery of all the information about the data model using Dynamic Management Views (DMV). DMVs are extremely useful to explore how a model is compressed, the space used by different columns and tables, the number of segments in a table, or the number of bits used by columns in different segments.</p>
<p class="edition">DMVs can run from inside SQL Server Management Studio. Regardless, we suggest you use DAX Studio; it offers a list of all DMVs in a simpler way without the need to remember them or to reopen this <span type="pagebreak" id="calibre_link-3199"></span>book looking for the DMV name. However, a more efficient way to use DMVs is with the free VertiPaq Analyzer tool (<a href="http://www.sqlbi.com/tools/vertipaq-analyzer/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://www.sqlbi.com/tools/vertipaq-analyzer/</a>), which displays data from DMVs and organizes them in useful reports, as shown in <a href="#calibre_link-1381" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-9</a>.</p>
<figure id="calibre_link-1381" class="image-l">
<img src="images/001122.jpg" alt="This figure is an example of a report on a data model, obtained with VertiPaq Analyzer." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 17-9</strong> VertiPaq Analyzer shows statistics about a data model in an efficient manner.</figcaption>
</figure>
<p class="edition">Although DMVs use an SQL-like syntax, the full SQL syntax is not available. DMVs do not run inside SQL Server. They are only a convenient way to discover the status of SSAS and to gather information about data models.</p>
<p class="edition">There are different DMVs, divided into two main categories:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">SCHEMA views:</strong> These return information about SSAS metadata, such as database names, tables, and individual columns. They are used to gather information about data types, names, and similar data, including statistical information about numbers of rows and unique values stored in columns.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">DISCOVER views:</strong> They are intended to gather information about the SSAS engine and/or discover statistics information about objects in a database. For example, one can use views in the discover area to enumerate the DAX keywords, the number of connections and sessions that are currently open, or the traces running.</p></li>
</ul>
<p class="edition">In this book, we do not describe the details of all the views because doing so would be going off topic. More information is available in Microsoft documentation on the web. Instead, we want to provide a few hints and point out the most useful DMVs related to databases used by DAX. Moreover, while many DMVs report useful information in many columns, in this book we describe the most interesting ones related to the internal structure.</p>
<p class="edition">A first useful DMV to discover the memory usage of all the objects in the SSAS instance is <em class="calibre5">DISCOVER_OBJECT_MEMORY_USAGE</em>. This DMV returns information about all the objects in all the databases in the SSAS instance. <em class="calibre5">DISCOVER_OBJECT_MEMORY_USAGE</em> is not limited to the current database. For example, the following query can be run in DAX Studio or SQL Server Management Studio:</p>
<p class="codelink"><a href="#calibre_link-1382" id="calibre_link-2755" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT * FROM $SYSTEM.DISCOVER_OBJECT_MEMORY_USAGE</pre></div>
<p class="edition"><a href="#calibre_link-1383" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-10</a> shows a small excerpt of the result of the previous query. There are many more columns and rows, so analyzing this detailed information can be very time-consuming.</p>
<figure id="calibre_link-1383" class="image-l">
<img src="images/001129.jpg" alt="This figure is a partial result of the Discover_Object_Memory_Usage DMV." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1992"></span><strong class="calibre7">Figure 17-10</strong> Partial result of the <em class="calibre5">DISCOVER_OBJECT_MEMORY_USAGE</em> DMV.</figcaption>
</figure>
<p class="edition">The output of the DMV is a table containing many rows that are very hard to read. The output structure is a parent/child hierarchy that starts with the instance name and ends with individual column information. Although the raw dataset is nearly impossible to read, one can build a Power Pivot data model on top of this query, implementing the parent/child hierarchy structure and browsing the full memory map of the instance. Kasper De Jonge published a workbook on his blog that does exactly this. It is available at <a href="http://www.powerpivotblog.nl/what-is-using-all-that-memory-on-my-analysis-server-instance/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://www.powerpivotblog.nl/what-is-using-all-that-memory-on-my-analysis-server-instance/</a>.</p>
<p class="edition">Other useful DMVs to check the current state of the Tabular engine are <em class="calibre5">DISCOVER_SESSIONS</em>, <em class="calibre5">DISCOVER_CONNECTIONS</em>, and <em class="calibre5">DISCOVER_COMMANDS</em>. These DMVs provide information about active sessions, connections, and executed commands. These views are used by an open source tool called SSAS Activity Monitor, available at <a href="https://github.com/RichieBzzzt/SSASActivityMonitor/tree/master/Download" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://github.com/RichieBzzzt/SSASActivityMonitor/tree/master/Download</a>, that provides the same information (plus much more) in a more convenient way.</p>
<p class="edition">There are also DMVs that analyze the distribution of data in columns and tables, and the memory required for compressed data. These are <em class="calibre5">TMSCHEMA_COLUMN_STORAGES</em> and <em class="calibre5">DISCOVER_STORAGE_TABLE_COLUMNS</em>. The former is the more recent one; the latter is there for compatibility with older versions of the engine (compatibility level 1103 or lower).</p>
<p class="edition">Finally, a very useful DMV to analyze calculation dependency is <em class="calibre5">DISCOVER_CALC_DEPENDENCY</em>. This DMV can be used to create a graph of dependencies between calculations in the data model, including calculated columns, calculated tables, and measures. <a href="#calibre_link-1384" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-11</a> shows an excerpt of the result of this DMV.</p>
<figure id="calibre_link-1384" class="image-l">
<img src="images/001136.jpg" alt="The figure shows a partial result of the DISCOVER_CALC_DEPENDENCY DMV." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 17-11</strong> Partial result of the <em class="calibre5">DISCOVER_CALC_DEPENDENCY</em> DMV.</figcaption>
</figure>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-286" class="h2a">Understanding the use of relationships in VertiPaq</h3>
<p class="edition">When a DAX query generates requests to the VertiPaq storage engine, the presence of relationships in the data model allows a quicker transfer of the filter context from one table to another. The internal implementation of a relationship in VertiPaq is worth knowing because relationships might affect the performance of a query even though most of the calculation happens in the storage engine.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3200"></span>To understand how relationships work, we start from the analysis of a query that only involves one table, <em class="calibre5">Sales</em>:</p>
<p class="codelink"><a href="#calibre_link-1385" id="calibre_link-2756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ROW (
    "Result", CALCULATE (
        COUNTROWS ( Sales ),
        Sales[Quantity] &gt; 1
    )
)

-- Result
-- 20016</pre></div>
<p class="edition">A developer used to working with tables in relational databases might suppose that the engine iterates the <em class="calibre5">Sales</em> table, tests the value of the <em class="calibre5">Quantity</em> column for each row of <em class="calibre5">Sales</em>, and increments the returned value if the <em class="calibre5">Quantity</em> value is greater than 1. In fact, VertiPaq does it better: VertiPaq only scans the <em class="calibre5">Quantity</em> column because it already provides the number of rows for the entire table. Therefore, a single column scan is enough to solve the entire query.</p>
<p class="edition">If we write a similar query using the column of another table as a filter, then scanning a single column is no longer enough to produce the result. For example, consider the following query that counts the number of rows in <em class="calibre5">Sales</em> related to products of the Contoso brand:</p>
<p class="codelink"><a href="#calibre_link-1386" id="calibre_link-2757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ROW (
    "Result", CALCULATE (
        COUNTROWS ( Sales ),
        'Product'[Brand] = "Contoso"
    )
)

-- Result
-- 37984</pre></div>
<p class="edition">This time, we are using two different tables: <em class="calibre5">Sales</em> and <em class="calibre5">Product</em>. Solving this query requires a bit more effort. Indeed, because the filter is on <em class="calibre5">Product</em> and the table to aggregate is <em class="calibre5">Sales</em>, it is not possible to scan a single column.</p>
<p class="edition">If you are not used to columnar databases, you probably think that, to solve the query, the engine should iterate the <em class="calibre5">Sales</em> table, follow the relationship with <em class="calibre5">Product</em>, and sum 1 if the product brand is Contoso, 0 otherwise. This would be an algorithm like the following DAX code:</p>
<p class="codelink"><a href="#calibre_link-1387" id="calibre_link-2758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ROW (
    "Result", SUMX (
        Sales,
        IF ( RELATED ( 'Product'[Brand] ) = "Contoso", 1, 0 )
    )
<span type="pagebreak" id="calibre_link-3201"></span>)

-- Result
-- 37984</pre></div>
<p class="edition">Although this is a simple algorithm, it contains much more complexity than expected. Indeed, if we carefully think about the columnar nature of VertiPaq, we realize that this query involves three different columns:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">Product[Brand]</em> used to filter the <em class="calibre5">Product</em> table.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Product[ProductKey]</em> used by the relationship between <em class="calibre5">Product</em> and <em class="calibre5">Sales</em>.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Sales[ProductKey]</em> used on the <em class="calibre5">Sales</em> side of the relationship.</p></li>
</ul>
<p class="edition">Iterating over <em class="calibre5">Sales[ProductKey]</em>, searching the row number in <em class="calibre5">Product</em> scanning <em class="calibre5">Product[ProductKey]</em>, and finally gathering the brand in <em class="calibre5">Product[Brand]</em> would be extremely expensive. The process requires a lot of random reads to memory, with negative consequences on performance. Therefore, VertiPaq uses a completely different algorithm, optimized for columnar databases.</p>
<p class="edition">First, VertiPaq scans the <em class="calibre5">Product[Brand]</em> column and retrieves the row numbers of the <em class="calibre5">Product</em> table where <em class="calibre5">Product[Brand]</em> is Contoso. As shown in <a href="#calibre_link-1388" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-12</a>, VertiPaq scans the <em class="calibre5">Brand</em> dictionary (1), retrieves the encoding of Contoso, and finally scans the segments (2) searching for the row numbers in the product table where the dictionary ID equals 0 (corresponding to Contoso), returning the indexes to the rows found (3).</p>
<figure id="calibre_link-1388" class="image-l">
<img src="images/001143.jpg" alt="The figure shows the sequence of events." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 17-12</strong> The output of a brand scan is the list of rows where <em class="calibre5">Brand</em> equals Contoso.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1661"></span>At this point, VertiPaq knows which rows in the <em class="calibre5">Product</em> table contain the given brand. The relationship between <em class="calibre5">Product</em> and <em class="calibre5">Sales</em> enables VertiPaq to translate the row numbers of <em class="calibre5">Product</em> in internal data IDs for <em class="calibre5">Sales[ProductKey]</em>. VertiPaq performs a lookup of the selected row numbers to determine the values of <em class="calibre5">Sales[ProductKey]</em> valid for those rows, as shown in <a href="#calibre_link-1389" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-13</a>.</p>
<figure id="calibre_link-1389" class="image-l">
<img src="images/001150.jpg" alt="The figure shows a sequence of events." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 17-13</strong> VertiPaq scans the product keys in the relationship to retrieve the IDs where brand equals Contoso.</figcaption>
</figure>
<p class="edition">The last step is to apply the filter on the <em class="calibre5">Sales</em> table. Since VertiPaq already has the list of values of <em class="calibre5">Sales[ProductKey]</em>, it is enough to scan the <em class="calibre5">Sales[ProductKey]</em> column to transform this list of values into row numbers and finally count them. If, instead of computing a <em class="calibre5">COUNTROWS</em>, VertiPaq had to perform the <em class="calibre5">SUM</em> of a column, then it would perform an additional step transforming row numbers into column values to perform the last step.</p>
<p class="edition">The important takeaway is that the cost of a relationship depends on the cardinality of the column that defines the relationship. Even though the previous query filtered only one brand, the cost of the relationship was the number of products for that brand. The lower the cardinality of a relationship, the better. When the cardinality of a relationship is above one million unique values, the end user can experience slower performance. A performance degradation is already measurable when the relationship has 100,000 unique values. VertiPaq aggregations can mitigate the impact of high-cardinality relationships by pre-aggregating data at a different granularity, removing the cost of traversing expensive relationships at query time. We briefly discuss aggregations later in this chapter.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-287" class="h2a">Introducing materialization</h3>
<p class="edition">Now that we have provided a basic explanation of how VertiPaq stores data in memory, we can describe what <em class="calibre5">materialization</em> is. Materialization is a step of the query execution that occurs when using columnar databases. Understanding when and how it happens is of paramount importance.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3202"></span>The basic principle about materialization is that every time the formula engine sends a request to the storage engine, the formula engine receives an uncompressed table that is generated dynamically by the storage engine. This special temporary table is called a <em class="calibre5">datacache</em>. A datacache is always the materialization of data that will be consumed by the formula engine, regardless of the storage engine used. Both VertiPaq and DirectQuery generate datacaches.</p>
<p class="edition">A large materialization happens when a single storage engine query produces a large datacache. The conditions for a DAX query to produce a large materialization depend on many factors; basically, whenever the storage engine is not able to execute all the operations required by the DAX query, the formula engine will do the work using a copy of the data owned by the storage engine. Be mindful that the formula engine cannot access the raw data directly, whether VertiPaq or DirectQuery. To access the raw data, the formula engine needs to ask the storage engine to retrieve the data and save it in a datacache. The amount and kind of materialization can be very different depending on the storage engine used. In this book, we only describe how to reduce the materialization in VertiPaq. For DirectQuery there could be differences between different data source drivers. Even so, the tools used to measure the materialization produced by the storage engine are the same used for VertiPaq.</p>
<p class="edition">The next chapters describe how to measure the materialization produced by a DAX query using specific tools and metrics. In this section, we just introduce the concept of materialization and how it relates to the result of a query. The cardinality of the result of every DAX query defines the optimal materialization. For example, the following query returns a single row, counting the number of rows in a table:</p>
<p class="codelink"><a href="#calibre_link-1390" id="calibre_link-2759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ROW (
   "Result", COUNTROWS ( Sales )
)

-- Result
-- 100231</pre></div>
<p class="edition">The optimal materialization for the previous query is a datacache with only one row. This means that the entire calculation is performed within the storage engine. The next query returns one row for each year; therefore, the optimal materialization is three rows, one for each year with sales:</p>
<p class="codelink"><a href="#calibre_link-1391" id="calibre_link-2760" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    'Date'[Calendar Year],
    "Sales Amount", [Sales Amount]
)

-- Calendar Year |  Sales Amount
-----------------|---------------
-- CY 2007       | 11,309,946.12
-- CY 2008       |  9,927,582.99
-- CY 2009       |  9,353,814.87</pre></div>
<p class="edition">Whenever the storage engine produces a single datacache with the same cardinality as the result of the DAX query, that is called a <em class="calibre5">late materialization</em>. If the storage engine produces more datacaches and/or the datacache produced has more rows than those displayed in the result, we have an <em class="calibre5">early</em> <span type="pagebreak" id="calibre_link-3203"></span><em class="calibre5">materialization</em>. With a late materialization the formula engine does not have to aggregate data, whereas with an early materialization the formula engine must perform operations like joining and grouping, which result in slower queries for the end users.</p>
<p class="edition">Predicting materialization is not easy without a deep knowledge of the VertiPaq engine. For example, the materialization of the following query is optimal because the entire calculation is executed within the storage engine:</p>
<p class="codelink"><a href="#calibre_link-1392" id="calibre_link-2761" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR LargeOrders =
    CALCULATETABLE (
        DISTINCT ( Sales[Order Number] ),
        Sales[Quantity] &gt; 1
    )
VAR Result =
    ROW (
        "Orders", COUNTROWS ( LargeOrders )
    )
RETURN
    Result

-- Orders
-- 8388</pre></div>
<p class="edition">On the other hand, the next query creates a temporary table that corresponds to the number of unique combinations between customers and dates related to sales with a quantity greater than one (for a total of 6,290 combinations):</p>
<p class="codelink"><a href="#calibre_link-1393" id="calibre_link-2762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
VAR LargeSalesCustomerDates =
    CALCULATETABLE (
        SUMMARIZE ( Sales, Sales[CustomerKey], Sales[Order Date] ),
        Sales[Quantity] &gt; 1
    )
VAR Result =
    ROW (
        "CustomerDates", COUNTROWS ( LargeSalesCustomerDates )
    )
RETURN
    Result

-- CustomerDates
-- 6290</pre></div>
<p class="edition">The latter query has a materialization of 6,290 rows, even though there is only one row in the result. The two queries are similar: a table is evaluated and then its rows are counted. The reason why the former has an earlier materialization is because it involves a single column, whereas the calculation requiring the combinations of two columns cannot be solved by the storage engine by just scanning the two columns. In general, any operation involving a single column has higher chances of being solved in the storage engine, but it would be a mistake to believe that involving multiple columns is <span type="pagebreak" id="calibre_link-1662"></span>always an issue. For example, the following query has an optimal late materialization even though it multiplies two columns from two tables, <em class="calibre5">Sales</em> and <em class="calibre5">Product</em>:</p>
<p class="codelink"><a href="#calibre_link-1394" id="calibre_link-2763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Sales Amount] =
        SUMX (
            Sales,
            Sales[Quantity] * RELATED ( 'Product'[Unit Price] )
        )
EVALUATE
ROW ( "Sales Amount", [Sales Amount] )

-- Sales Amount
-- 33,690,148.51</pre></div>
<p class="edition">In complex queries it is nearly impossible to obtain an optimal late materialization. Therefore, the effort for optimizing a query is reducing the materialization, pushing most of the workload to the storage engine, if possible.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-288" class="h2a">Introducing aggregations</h3>
<p class="edition">A data model can have multiple tables related to the same original raw data. The purpose of this redundancy is to offer alternative ways to the storage engine to retrieve the data faster. The tables used to this purpose are called <em class="calibre5">aggregations</em>.</p>
<p class="edition">An aggregation is nothing but a pregrouped version of the original table. By pre-aggregating data, one reduces the number of columns (hence, the number of rows) and replaces values with their aggregate.</p>
<p class="edition">As an example, consider the <em class="calibre5">Sales</em> table in <a href="#calibre_link-1395" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-14</a>, which has one row for each date, product, and customer.</p>
<figure id="calibre_link-1395" class="image-l">
<img src="images/001159.jpg" alt="This figure shows a data table with a few columns and many rows." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 17-14</strong> The original <em class="calibre5">Sales</em> table has a high number of rows.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3204"></span>If a query requires the sum of <em class="calibre5">Quantity</em> or <em class="calibre5">Amount</em> by <em class="calibre5">Date</em>, the storage engine must evaluate and aggregate all the rows with the same <em class="calibre5">Date</em>. In VertiPaq this operation is relatively quick, thanks to the compression and the optimized algorithms that scan the memory. DirectQuery is usually much slower than VertiPaq to perform the same operation. Anyway, VertiPaq also requires time to scan billions of rows rather than millions of rows. Therefore, there could be an advantage in creating an alternate&mdash;smaller&mdash;table to use in place of the original one.</p>
<p class="edition"><a href="#calibre_link-1396" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-15</a> shows the content of a <em class="calibre5">Sales</em> table aggregated by <em class="calibre5">Date</em>. In this case, there is only one row for every date, and the <em class="calibre5">Quantity</em> and <em class="calibre5">Amount</em> columns store the sum of the values included in the original rows, pre-aggregated by <em class="calibre5">Date</em>.</p>
<figure id="calibre_link-1396" class="image-l">
<img src="images/001165.jpg" alt="This figure shows the Sales Agg Date table." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 17-15</strong> The <em class="calibre5">Sales Agg Date</em> table has one row for every date.</figcaption>
</figure>
<p class="edition">In an aggregated table, every column is either a “group by” or an aggregation of the original table. If a request to the storage engine only needs columns that are present in an aggregation table, then the engine uses the aggregation rather than the original source. The <em class="calibre5">Sales Agg Date</em> table shown in <a href="#calibre_link-1396" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 17-15</a> can be mapped as an aggregation of <em class="calibre5">Sales</em> by specifying the role of each column:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">Date</em>: GroupBy <em class="calibre5">Sales[Date]</em></p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Quantity</em>: Sum <em class="calibre5">Sales[Quantity]</em></p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Amount</em>: Sum <em class="calibre5">Sales[Amount]</em></p></li>
</ul>
<p class="edition">The aggregation type must be specified for every column that is not a “group by.” The aggregation types available are Count, Min, Max, Sum, and count rows of the table. A column in an aggregation table can only map native columns in the original table; it is not possible to specify an aggregation over a calculated column.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">Aggregations cannot be used to optimize the execution of complex calculations in DAX. The only purpose of aggregations is to reduce the execution time of storage engine queries. Aggregations can be useful for relatively small tables in DirectQuery, whereas aggregations for VertiPaq should be considered only for tables with billions of rows.</p>
</div>
<p class="edition">A table in a Tabular model can have multiple aggregations with different priorities in case there are multiple aggregations compatible with a specific storage engine request. Moreover, aggregations and original tables can be stored with different storage engines. A common scenario is storing aggregations in VertiPaq to improve the performance of large tables accessed through DirectQuery. Nevertheless, it is also possible to create aggregations in the same storage engine used for the original table.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1989"></span>There could be limitations in storage engines available for aggregations and original tables, depending on the version and the license of the product used. This section provides general guidance on the concept of aggregations, which are one of the tools to optimize performance of a DAX query as described in the following chapters.</p>
</div>
<p class="edition">Aggregations are powerful, but they require a lot of attention to detail. An incorrect definition of aggregations produces incorrect or inconsistent results. It is a responsibility of the data modeler to guarantee that a query executed in an aggregation produces the same result as an equivalent query executed on the original table. Aggregations are an optimization tool and should be used only whenever strictly necessary. The presence of aggregations requires additional work to define and maintain the aggregation tables in the data model. One should therefore use them only after having checked that a performance benefit exists.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-289" class="h2a">Choosing hardware for VertiPaq</h3>
<p class="edition">Choosing the right hardware is critical for a solution based on a Tabular model using the VertiPaq storage engine. Spending more does not always mean having a better machine. This section describes how to choose the right hardware for a Tabular model.</p>
<p class="edition">Since the introduction of Analysis Services 2012, we helped several companies adopt the new Tabular model in their solutions. A very common issue was that when going into production, performance was slower than expected. Worse, sometimes it was slower than in the development environments. Most of the times, the reason for that was incorrect hardware sizing, especially when the server was in a virtualized environment. As we will explain, the problem is not the use of a virtual machine in itself. Instead, the problem is more likely the technical specs of the underlying hardware. A very complete and detailed hardware-sizing guide for Analysis Services Tabular is available in the whitepaper titled “Hardware Sizing a Tabular Solution (SQL Server Analysis Services)” (<a href="http://msdn.microsoft.com/en-us/library/jj874401.aspx" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://msdn.microsoft.com/en-us/library/jj874401.aspx</a>). The goal of this section is to provide a quick guide to understand the issues affecting many data centers when they host a Tabular solution. Users of Power Pivot or Power BI Desktop on a personal computer can skip the details about Non-Uniform Memory Access (NUMA) support, but all the other considerations are equally true for choosing the right hardware.</p>
<section class="calibre4">
<h4 id="calibre_link-290" class="calibre13">Hardware choice as an option</h4>
<p class="edition">The first question is whether one can choose their hardware or not. The problem of using a virtual machine for a Tabular solution is that often the hardware has already been selected and installed. One can only influence the number of cores and the amount of RAM that are assigned to the server. Unfortunately, these parameters are not so relevant for performance. If there are limited choices available, one should collect information about the CPU model and clock of the host server as soon as possible. If this information is not accessible, ask for a small virtual machine running on the same host server and run the Task Manager: The Performance tab shows the CPU model and the clock rate. With this <span type="pagebreak" id="calibre_link-1909"></span>information, one can predict whether the performance will be worse than an average modern laptop. Unfortunately, chances are that many developers will be in that position. If so, then they must sharpen their political skills to convince the right people that running Tabular on that server is a bad idea. If the host server is a good machine, then one still needs to avoid the pitfall of running a virtual machine on different NUMA nodes (more on this later).</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-291" class="calibre13">Set hardware priorities</h4>
<p class="edition">If it is possible to influence the hardware selection, this is the order of priorities:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp"><strong class="calibre7">CPU Clock and Model</strong>: the faster, the better.</p></li>
<li class="calibre25"><p class="listp"><strong class="calibre7">Memory Speed:</strong> the faster, the better.</p></li>
<li class="calibre25"><p class="listp"><strong class="calibre7">Number of Cores:</strong> the higher, the better. Still, a few fast cores are way better than many slow cores.</p></li>
<li class="calibre25"><p class="listp"><strong class="calibre7">Memory Size.</strong></p></li>
</ol>
<p class="edition">Disk I/O performance is not on the list. Indeed, it is not important at query time although it could have a role in improving the speed of a disaster recovery. There is only one condition (paging) where disk I/O affects performance, and we discuss it later in this section. However, the RAM of the system should be sized so that there will be no paging at all. Our reader should allocate the budget on CPU and memory speed, memory size, and not waste money on disk I/O bandwidth. The following sections include information to consider for such allocation.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-292" class="calibre13">CPU model</h4>
<p class="edition">The most important factors that affect the speed of code running in VertiPaq are CPU clock and model. Different CPU models might have a different performance at the same clock rate, so considering the clock alone is not enough. The best practice is to run a benchmark measuring the different performance in queries that stress the formula engine. An example of such a query is the following:</p>
<p class="codelink"><a href="#calibre_link-1397" id="calibre_link-2764" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
VAR t1 =
    SELECTCOLUMNS ( CALENDAR ( 1, 10000 ), "x", [Date] )
VAR t2 =
    SELECTCOLUMNS ( CALENDAR ( 1, 10000 ), "y", [Date] )
VAR c =
    CROSSJOIN ( t1, t2 )
VAR result =
    COUNTROWS ( c )
EVALUATE
    ROW ( "x", result )</pre></div>
<p class="edition">This query can run in DAX Studio or SQL Server Management Studio connected to any Tabular model; the execution is intentionally slow and does not produce any meaningful result. Using a query of a typical workload for a specific data model is certainly better because performance might vary on <span type="pagebreak" id="calibre_link-1914"></span>different hardware depending on the memory allocated to materialize intermediate results; the query in the preceding code block has a minimal use of memory.</p>
<p class="edition">For example, this query runs in 9.5 seconds on an Intel i7-4770K 3.5 GHz, and in 14.4 seconds on an Intel i7-6500U 2.5 GHz. These CPUs run a desktop workstation and a notebook, respectively. Do not assume that a server will be faster. You should always evaluate hardware performance by running the same test with the same version of the engine and looking at the results because they are often surprising.</p>
<p class="edition">In general, Intel Xeon processors used on a server are E5 and E7 series, and it is common to find clock speed around 2&ndash;2.4 GHz even with a very high number of cores available. You should look for a clock speed of 3 GHz or more. Another important factor is the L2 and L3 cache size: The larger, the better. This is especially important for large tables and relationships between tables based on columns that have more than 1 million unique values.</p>
<p class="edition">The reason why CPU and cache are so important for VertiPaq is clarified in <a href="#calibre_link-1398" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 17-1</a>, which compares the typical access time of data stored at different distances from the CPU. The column with human metrics represents the same difference using metrics that are easier for humans to understand.</p>
<p class="edition" id="calibre_link-1398"><strong class="calibre7">Table 17-1</strong> Expanded versions of the tables</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Access</p></th>
<th class="th"><p class="tab-text">Access Time</p></th>
<th class="th"><p class="tab-text">Human Metrics</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">1 CPU cycle</p></td>
<td class="th1"><p class="tab-text">0.3 ns</p></td>
<td class="th1"><p class="tab-text">1 s</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">L1 cache</p></td>
<td class="th1"><p class="tab-text">0.9 ns</p></td>
<td class="th1"><p class="tab-text">3 s</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">L2 cache</p></td>
<td class="th1"><p class="tab-text">2.8 ns</p></td>
<td class="th1"><p class="tab-text">9 s</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">L3 cache</p></td>
<td class="th1"><p class="tab-text">12.9 ns</p></td>
<td class="th1"><p class="tab-text">43 s</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">RAM access</p></td>
<td class="th1"><p class="tab-text">120 ns</p></td>
<td class="th1"><p class="tab-text">6 min</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Solid-state disk I/O</p></td>
<td class="th1"><p class="tab-text">50&ndash;150 µs s</p></td>
<td class="th1"><p class="tab-text">2&ndash;6 days</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Rotational disk I/O</p></td>
<td class="th1"><p class="tab-text">1&ndash;10 ms</p></td>
<td class="th1"><p class="tab-text">1&ndash;12 months</p></td>
</tr>
</tbody>
</table>
<p class="edition">As shown here, the fastest storage in a PC is not the RAM; it is the core cache. It should be clear that a large L2 cache is important, and the CPU speed plays a primary role in determining performance. The same table also clarifies why keeping data in RAM is so much better than accessing data in other, slower storage devices.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-293" class="calibre13">Memory speed</h4>
<p class="edition">The memory speed is an important factor for VertiPaq. Every operation made by the engine accesses memory at a very high speed. When the RAM bandwidth is the bottleneck, performance counters report CPU usage instead of I/O waits. Unfortunately, there are no performance counters that monitor the time spent waiting for the RAM access. In Tabular, this amount of time can be relevant, and it is hard to measure.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1910"></span>In general, you should use RAM that has at least 1,833 MHz; however, if the hardware platform permits, you should select faster RAM&mdash;2,133 MHz or more.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-294" class="calibre13">Number of cores</h4>
<p class="edition">VertiPaq splits execution on multiple threads only when the table involved has multiple segments. Each segment contains 8 million rows by default (1 million on Power BI and Power Pivot). A CPU with eight cores will not use all of them in a single query unless a table has at least 64 million rows, or 8 million rows in Power BI and Power Pivot.</p>
<p class="edition">For these reasons, scalability over multiple cores is effective only for very large tables. Raising the number of cores improves performance for a single query only when it hits a large table, 200 million rows or more. In terms of scalability (number of concurrent users), a higher number of cores might not improve performance if users access the same tables as they would contend access to shared RAM. A better way to increase the number of concurrent users is to use more servers in a load-balancing configuration.</p>
<p class="edition">The best practice is to get the maximum number of cores available on a single socket, getting the highest clock rate possible. Having two or more sockets on the same server is not good, even though Analysis Services Tabular recognizes the NUMA architecture. NUMA requires a more expensive inter-socket communication whenever a thread running on a socket accesses memory allocated by another socket. You can find more details about NUMA architecture in Hardware Sizing a Tabular Solution (SQL Server Analysis Services) at <a href="http://msdn.microsoft.com/en-us/library/jj874401.aspx" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://msdn.microsoft.com/en-us/library/jj874401.aspx</a>.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-295" class="calibre13">Memory size</h4>
<p class="edition">The entire volume of data managed by VertiPaq must be stored in memory. Additional RAM is required to execute process operations&mdash;unless there is a separate process server&mdash;and to execute queries. Optimized queries usually do not have a high request for RAM, but a single query can materialize temporary tables that could be very large. Database tables have a high compression rate, whereas materialization of intermediate tables during a single query generates uncompressed data.</p>
<p class="edition">Having enough memory only guarantees that a query will end by returning a result, but increasing available RAM does not produce any performance improvement. Cache used by Tabular does not increase just because there is more RAM available. However, a condition of low available memory might negatively affect query performance if the server starts paging data. Developers should have enough memory to store all the data of their database and to avoid materialization during query execution. More memory than this is a waste of resources.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-296" class="calibre13">Disk I/O and paging</h4>
<p class="edition">You should not allocate budget on storage I/O for Analysis Services Tabular. This is very different from Multidimensional, where random I/O operation on disk occurs very frequently, especially in certain measures. In Tabular, there are no direct storage I/O operations during a query. The only event when <span type="pagebreak" id="calibre_link-1985"></span>this might happen is under low memory conditions. However, it is less expensive and more effective to provide more RAM to a server than trying to improve performance by increasing storage I/O throughput when there is systematic paging caused by low memory availability.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-297" class="calibre13">Best practices in hardware selection</h4>
<p class="edition">You should measure performance before choosing the hardware for SSAS Tabular. It is common to observe a server running twice as slow as a development workstation, even if the server is very new. This is because a server designed to be scalable&mdash;especially for virtual machines&mdash;does not usually perform very well for activities made by a single thread. However, this type of workload is very common in VertiPaq. One will need time and numbers, doing a proper benchmark, to convince a company that a “standard server” could be the weak point of their entire BI solution.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-298" class="h2a">Conclusions</h3>
<p class="edition">In this first chapter about optimization we described the internal architecture of a Tabular engine, and we provided the basic information about how data is stored in VertiPaq. As you will see in the following chapters, this knowledge is of paramount importance to optimize your code.</p>
<p class="edition">These are the main topics you learned in the chapter:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">There are two engines inside a Tabular server: the formula engine and storage engine.</p></li>
<li class="calibre10"><p class="listp">The formula engine is the top-level query engine. It is very powerful but rather limited in terms of speed because it is single-threaded.</p></li>
<li class="calibre10"><p class="listp">There are two storage engines: VertiPaq and DirectQuery.</p></li>
<li class="calibre10"><p class="listp">VertiPaq is an in-memory columnar database. It stores information on a column-by-column basis, providing very quick access to single columns. Using multiple columns in a single DAX formula might require materialization.</p></li>
<li class="calibre10"><p class="listp">VertiPaq compresses columns to reduce the memory scan time. Optimizing a model means optimizing the compression by reducing the cardinality of a column as much as possible.</p></li>
<li class="calibre10"><p class="listp">Both VertiPaq and DirectQuery storage engines can coexist in the same model; this is called a composite model. A single query can use only VertiPaq, only DirectQuery, or both, depending on the storage model of the tables involved in the query.</p></li>
</ul>
<p class="edition">Now that we have provided the basic knowledge about the internals of the engine, in the next chapter we start learning a few techniques to optimize VertiPaq storage to reduce both the size of a data model and its execution time.<span type="pagebreak" id="calibre_link-3205"></span></p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1399">
<div id="calibre_link-3206" class="calibre2">
<div id="calibre_link-3207" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-23"><span type="pagebreak" id="calibre_link-1925"></span><span class="pd_ash">Chapter 18</span><br class="calibre3" />Optimizing VertiPaq</h2>
<p class="edition">The previous chapter introduced some of the internals of VertiPaq. That knowledge is useful to design and optimize a data model for a faster execution of DAX queries. While the previous chapter was more theoretical, in this chapter we move on to the more practical side. Indeed, this chapter describes the most important guidelines for saving memory and thereby improving the performance of a data model. The main objective in creating an efficient data model is to reduce the cardinality of columns in order to decrease the dictionary size, improve the compression, and speed up any iteration and filter.</p>
<p class="edition">The final goal of the chapter is optimizing a model. However, before going there, the first and most important skill to learn is the ability to evaluate the pros and cons of each design choice. <em class="calibre5">You should not follow any rules blindly without evaluating their impact</em>. For this reason, the first part of the chapter illustrates how to measure the size of each object in a model in memory. This is important when evaluating whether a decision made on a model was worth the effort or not, based on the memory impact of the decision.</p>
<p class="edition">Before moving on, we want to stress once more this important concept: <em class="calibre5">You should always test the techniques described in every data model</em>. Data distribution is important in VertiPaq. The very same <em class="calibre5">Sales</em> table structure may be compressed in different ways because of the data distribution, leading to different results for the same optimization techniques. Do not learn best practices. Instead, learn different optimization techniques, knowing in advance that not all of them will be applicable in every data model.</p>
<section class="calibre4">
<h3 id="calibre_link-299" class="h2a">Gathering information about the data model</h3>
<p class="edition">The first step for optimizing a data model is gathering information about the cost of the objects in the database. This section describes the tools and the techniques to collect all the data that help in prioritizing the possible optimizations of the physical structure.</p>
<p class="edition"><a href="#calibre_link-1400" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 18-1</a> shows the pieces of information to collect from each object in a database.</p>
<p class="edition" id="calibre_link-1400"><span type="pagebreak" id="calibre_link-1886"></span><strong class="calibre7">Table 18-1</strong> Information to collect for each object in a database</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Object</p></th>
<th class="th"><p class="tab-text">Information to Collect</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">Table</p></td>
<td class="th1"><p class="tab-text">Number of rows</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Column</p></td>
<td class="th1"><p class="tab-text">Number of unique values</p>
<p class="tab-text">Size of dictionary</p>
<p class="tab-text">Size of data (total size of all segments)</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Hierarchy</p></td>
<td class="th1"><p class="tab-text">Size of hierarchy structure</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Relationship</p></td>
<td class="th1"><p class="tab-text">Size of relationship structure</p></td>
</tr>
</tbody>
</table>
<p class="edition">In general, object size strongly depends on the number of unique values in the columns being used or referenced. For this reason, the number of unique values in a column, also known as column cardinality, is the single most important piece of information to gather from a database.</p>
<p class="edition">In <a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 17</a>, “<a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">The DAX engines</a>,” we introduced the Dynamic Management Views (DMVs) to retrieve information about the objects in the VertiPaq storage engine. The following sections describe how to interpret the relevant information through VertiPaq Analyzer, which simplifies the collection of data from DMVs.</p>
<p class="edition">The first piece of information to consider in a data model is the size of each table, in terms of cardinality (number of rows) and size in memory. <a href="#calibre_link-1401" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-1</a> shows the Table section of VertiPaq Analyzer executed on a Contoso data model in Power BI. The model used in this example contains more tables and data than the simplified data model previously used throughout the book.</p>
<figure id="calibre_link-1401" class="image-l">
<img src="images/000037.jpg" alt="The figure shows data pertaining to various tables." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 18-1</strong> Details of tables shown in VertiPaq Analyzer.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">Table Size</em> column represents the amount of memory used to store the compressed data in VertiPaq, whereas the <em class="calibre5">Cardinality</em> column shows the number of rows of each table. By drilling down a table name, it is possible to see the details of each column. At the column level, <em class="calibre5">Cardinality</em> shows the number of unique values in the entire table; however, the <em class="calibre5">Table Size</em> value is not available because each <span type="pagebreak" id="calibre_link-1870"></span>column only has the cost shown in <em class="calibre5">Columns Total</em> Size. For example, <a href="#calibre_link-1402" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-2</a> shows the columns available in the largest table of the data model, <em class="calibre5">SalesQuota</em>; note that the total size of each column is extremely variable within the same table.</p>
<figure id="calibre_link-1402" class="image-l">
<img src="images/000058.jpg" alt="In this figure we expand under SalesQuota to see more details." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 18-2</strong> Details of tables and columns shown in VertiPaq Analyzer.</figcaption>
</figure>
<p class="edition">Each column reported by VertiPaq Analyzer carries a specific meaning described in the following list:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Cardinality:</strong> Object cardinality; the number of rows in a table or the number of unique values in a column, depending on the level of detail in the report.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Rows:</strong> Number of rows in the table. This metric is shown in the columns report (visible later in <a href="#calibre_link-1403" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-3</a>) and not in the table report (in <a href="#calibre_link-1402" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-2</a>), where the same information is available in the <em class="calibre5">Cardinality</em> metric, at the table detail level of the report.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Table Size:</strong> Size of the table in bytes. This metric contains the sum of <em class="calibre5">Columns Total Size</em>, <em class="calibre5">User Hierarchies Size</em>, and <em class="calibre5">Relationships Size</em>.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Columns Total Size:</strong> Size in bytes of a column. This metric contains the sum of <em class="calibre5">Data Size</em>, <em class="calibre5">Dictionary Size</em>, and <em class="calibre5">Columns Hierarchies Size</em>.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Data Size:</strong> Size in bytes of all the compressed data in segments and partitions. It does not include dictionary and column hierarchies. This number depends on the compression of the column, which, in turn, depends on the number of unique values and the distribution of the data across the table.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Dictionary Size:</strong> Size in bytes of dictionary structures. This number is only relevant for columns with hash encoding; it is a small fixed number for columns with value encoding. The dictionary size depends on the number of unique values in the column and on the average length of the strings in case of a text column.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-1887"></span><strong class="calibre7">Columns Hierarchies Size:</strong> Size in bytes of the automatically generated attribute hierarchies for columns. These hierarchies are necessary to access a column in MDX, and they are also used by DAX to optimize filter and sort operations.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Encoding:</strong> Type of encoding (hash or value) used for the column. The encoding of a column is selected automatically by the VertiPaq compression algorithm.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">User Hierarchies Size:</strong> Bytes of user-defined hierarchies. This structure is computed at the table level, and its values are only visible at the table level detail in a VertiPaq Analyzer report. The user hierarchy size depends on the number of unique values and on the average length of the strings of the columns used in the hierarchy itself.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Relationship Size:</strong> Bytes of relationships between tables. The relationship size is related to the table on the many-side of a relationship. The size of a relationship depends on the cardinality of the columns involved in the relationship, although this is usually a tiny fraction of the cost of the table.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Table Size %:</strong> Ratio of <em class="calibre5">Columns Total Size</em> versus <em class="calibre5">Table Size</em>.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Database Size %:</strong> Ratio of <em class="calibre5">Table Size</em> versus <em class="calibre5">Database Size</em>, which is the sum of <em class="calibre5">Table Size</em> for all the tables.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Segments #:</strong> Number of segments. All the columns of a table have the same number of segments of the table.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Partitions #:</strong> Number of partitions. All the columns of a table have the same number of partitions of the table.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Columns #:</strong> Number of columns.</p></li>
</ul>
<div class="sidebar">
<p class="edition">Attribute hierarchies and column encoding</p>
<p class="edition">Two columns in VertiPaq Analyzer provide information that could be used to optimize large data models. We report the link to relevant documentation because we do not cover these optimizations in this book.</p>
<p class="edition">The attribute hierarchy size reported in <em class="calibre5">Columns Hierarchies</em> Size depends on the number of unique values in the column and on the average length of the strings, similarly to the dictionary size. However, the attribute hierarchy is created for both value and hash encoding, whereas the dictionary only exists for hash encoding. The attribute hierarchy creation can be disabled when the column is only used in aggregations and not as a filter or grouping condition. This optimization might require advanced settings. More details about the setting to disable attribute hierarchies are available at <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.analysisservices.tabular.column.isavailableinmdx" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://docs.microsoft.com/en-us/dotnet/api/microsoft.analysisservices.tabular.column.isavailableinmdx</a> and <a href="https://blogs.msdn.microsoft.com/analysisservices/2018/06/08/new-memory-options-foranalysis-services/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://blogs.msdn.microsoft.com/analysisservices/2018/06/08/new-memory-options-foranalysis-services/</a>.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1871"></span>The <em class="calibre5">Encoding</em> selected for a column in the model might be changed by the developer. The data model can offer hints to suggest an encoding type to use. Usually, VertiPaq chooses the encoding that saves more memory; however, the developer might choose a specific encoding that may turn out to be more expensive in order to meet specific needs, like improving the speed of dynamic aggregations. A difference in query performance might be visible in tables with billions of rows, whereas it is usually not significant for tables with a few million rows. More details about encoding hints are available at <a href="https://docs.microsoft.com/en-us/sql/analysisservices/what-s-new-in-sql-server-analysis-services-2017?view=sql-server-2017#encoding-hints" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://docs.microsoft.com/en-us/sql/analysisservices/what-s-new-in-sql-server-analysis-services-2017?view=sql-server-2017#encoding-hints</a>.</p>
</div>
<p class="edition">The first possible optimization using VertiPaq Analyzer reports is removing any columns that are not useful for the reports and that are expensive in memory. For example, the data shown in <a href="#calibre_link-1402" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-2</a> highlights that one of the most expensive columns of the <em class="calibre5">SalesQuota</em> table is <em class="calibre5">SalesQuotaKey</em>. <em class="calibre5">SalesQuotaKey</em> is not used in any report, and it is not required by the data model structure&mdash;as it happens for columns used in relationships. Indeed, the <em class="calibre5">SalesQuotaKey</em> column could be removed from the model without affecting any report and calculation, saving both refresh time and precious memory.</p>
<p class="edition">The process of identifying the most expensive columns is made simpler by using another report available in VertiPaq Analyzer shown in <a href="#calibre_link-1403" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-3</a>. This Columns report shows all the columns in a flattened list where the reported name is the concatenation of the table and column names, sorting the list by descending <em class="calibre5">Columns Total Size</em>.</p>
<figure id="calibre_link-1403" class="image-l">
<img src="images/000051.jpg" alt="This report sorts the columns by descending total size." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 18-3</strong> Details of columns shown in VertiPaq Analyzer.</figcaption>
</figure>
<p class="edition">Two of the three most expensive columns of the entire Contoso data model, <em class="calibre5">OnlineSalesKey</em> and <em class="calibre5">SalesOrderNumber</em> in the <em class="calibre5">OnlineSales</em> table, are seldom used in a report at the aggregated level. Each of these two columns imported in VertiPaq requires 10% of the data size of the entire data model. By removing these two columns, it is possible to save 20% of the database size. Being aware of the cost of every column helps one choose what to keep in the data model and what is too expensive relative to its analytical value.</p>
<p class="edition">The reason why the report in <a href="#calibre_link-1403" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-3</a> shows <em class="calibre5">Rows</em> and <em class="calibre5">Cardinality</em> side-by-side is to help recognize columns that are unique in a table. When the two numbers are close or identical, it is not useful to create summarized results over a column unless it is the target of an aggregation, such as the <em class="calibre5">Amount</em> column in the <em class="calibre5">StrategyPlan</em> table.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1926"></span>Another important piece of information available in VertiPaq Analyzer is included in the Relationships report shown in <a href="#calibre_link-1404" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-4</a>. This report makes it easy to identify expensive relationships present in a data model, even though there are no critical situations in this specific example.</p>
<figure id="calibre_link-1404" class="image-l">
<img src="images/000066.jpg" alt="Here we see a relationships report." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 18-4</strong> Size and cardinality of relationships shown in VertiPaq Analyzer.</figcaption>
</figure>
<p class="edition">In VertiPaq, relationships with a cardinality larger than 1 million unique values are particularly expensive, impacting the storage engine cost of any request involving that relationship. A common rule of thumb is to start paying attention to a relationship whenever its cardinality exceeds 100,000. Such relationships usually do not produce visible performance issues, but their presence starts to be measurable in hundreds of milliseconds and could create problems with any future growth of the database. While a single large relationship does not necessarily slow down a report visibly, its presence can undermine the performance of more complex calculations and reports.</p>
<p class="edition">An awareness of the cardinality of tables and columns is important in any further analyses of a DAX query’s performance. While this information could be retrieved by running simple DAX queries, it is faster and more efficient to use a tool like VertiPaq Analyzer to collect this data automatically&mdash;spending more time evaluating the metrics obtained rather than manually running trivial queries on the data model.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-300" class="h2a">Denormalization</h3>
<p class="edition">The first optimization that can be applied to a data model is to denormalize data. Every relationship has a memory cost and an additional overhead when the engine transfers the filter from one table to another. Purely from a performance point of view, an optimal model would be one made of a single table. However, such an approach would be less than usable and would force a single granularity for all the measures. Thus, an optimal data model is organized as a star schema around each table defined for measures sharing the same granularity. For this reason, one should denormalize unnecessary related tables, thus reducing the number of columns and relationships in the data model.</p>
<p class="edition">The denormalization required in a data model for DAX is usually counterintuitive for anyone with some experience in data modeling for a relational database. For instance, consider a simple data model where a <em class="calibre5">Payment</em> table has two columns, <em class="calibre5">Payment Code</em> and <em class="calibre5">Payment Description</em>. In a relational database, a table with <em class="calibre5">Code</em> and <em class="calibre5">Description</em> is commonly used to avoid duplicating the description content in each row of a <em class="calibre5">Transactions</em> table. It is common practice to only store the <em class="calibre5">Payment Code</em> in <em class="calibre5">Transactions</em> to save space in a relational model.</p>
<p class="edition"><a href="#calibre_link-1405" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 18-2</a> shows a denormalized version of the <em class="calibre5">Transactions</em> table. There are many rows with duplicated values of Credit Card and Cash in the <em class="calibre5">Payment Type Description</em> column.</p>
<p class="edition" id="calibre_link-1405"><span type="pagebreak" id="calibre_link-3208"></span><strong class="calibre7">Table 18-2</strong> <em class="calibre5">Transactions</em> table with <em class="calibre5">Payment Type</em> denormalized in the <em class="calibre5">Code</em> and <em class="calibre5">Description</em> columns</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Date</p></th>
<th class="th"><p class="tab-text">Amount</p></th>
<th class="th"><p class="tab-text">Payment Type Code</p></th>
<th class="th"><p class="tab-text">Payment Type Description</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">2015-06-21</p></td>
<td class="th1"><p class="tab-text">100</p></td>
<td class="th1"><p class="tab-text">00</p></td>
<td class="th1"><p class="tab-text">Cash</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2015-06-21</p></td>
<td class="th1"><p class="tab-text">100</p></td>
<td class="th1"><p class="tab-text">02</p></td>
<td class="th1"><p class="tab-text">Credit Card</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">2015-06-22</p></td>
<td class="th1"><p class="tab-text">200</p></td>
<td class="th1"><p class="tab-text">02</p></td>
<td class="th1"><p class="tab-text">Credit Card</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2015-06-23</p></td>
<td class="th1"><p class="tab-text">200</p></td>
<td class="th1"><p class="tab-text">00</p></td>
<td class="th1"><p class="tab-text">Cash</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">2015-06-23</p></td>
<td class="th1"><p class="tab-text">100</p></td>
<td class="th1"><p class="tab-text">03</p></td>
<td class="th1"><p class="tab-text">Wire Transfer</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2015-06-24</p></td>
<td class="th1"><p class="tab-text">200</p></td>
<td class="th1"><p class="tab-text">02</p></td>
<td class="th1"><p class="tab-text">Credit Card</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">2015-06-25</p></td>
<td class="th1"><p class="tab-text">100</p></td>
<td class="th1"><p class="tab-text">00</p></td>
<td class="th1"><p class="tab-text">Cash</p></td>
</tr>
</tbody>
</table>
<p class="edition">By using a separate table containing all the payment types, it is possible to only store the <em class="calibre5">Payment Type Code</em> in the <em class="calibre5">Transactions</em> table, as shown in <a href="#calibre_link-1406" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 18-3</a>.</p>
<p class="edition" id="calibre_link-1406"><strong class="calibre7">Table 18-3</strong> <em class="calibre5">Transactions</em> table normalized, with <em class="calibre5">Payment Type Code</em> only</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Date</p></th>
<th class="th"><p class="tab-text">Amount</p></th>
<th class="th"><p class="tab-text">Payment Type Code</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">2015-06-21</p></td>
<td class="th1"><p class="tab-text">100</p></td>
<td class="th1"><p class="tab-text">00</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2015-06-21</p></td>
<td class="th1"><p class="tab-text">100</p></td>
<td class="th1"><p class="tab-text">02</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">2015-06-22</p></td>
<td class="th1"><p class="tab-text">200</p></td>
<td class="th1"><p class="tab-text">02</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2015-06-23</p></td>
<td class="th1"><p class="tab-text">200</p></td>
<td class="th1"><p class="tab-text">00</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">2015-06-23</p></td>
<td class="th1"><p class="tab-text">100</p></td>
<td class="th1"><p class="tab-text">03</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2015-06-24</p></td>
<td class="th1"><p class="tab-text">200</p></td>
<td class="th1"><p class="tab-text">02</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">2015-06-25</p></td>
<td class="th1"><p class="tab-text">100</p></td>
<td class="th1"><p class="tab-text">00</p></td>
</tr>
</tbody>
</table>
<p class="edition">By storing the description of payment types in a separate table (see <a href="#calibre_link-1407" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 18-4</a>), there is only one row for each payment type code and description. That table in a relational database reduces the total amount of space required, by avoiding the duplication of a long string in the <em class="calibre5">Transactions</em> table.</p>
<p class="edition" id="calibre_link-1407"><strong class="calibre7">Table 18-4</strong> <em class="calibre5">Payment Type</em> table that normalizes <em class="calibre5">Code</em> and <em class="calibre5">Description</em></p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Payment Type Code</p></th>
<th class="th"><p class="tab-text">Payment Type Description</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">00</p></td>
<td class="th1"><p class="tab-text">Cash</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">01</p></td>
<td class="th1"><p class="tab-text">Debit Card</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">02</p></td>
<td class="th1"><p class="tab-text">Credit Card</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">03</p></td>
<td class="th1"><p class="tab-text">Wire Transfer</p></td>
</tr>
</tbody>
</table>
<p class="edition">However, this optimization, which works perfectly fine for a relational database, might be a bad choice in a data model for DAX. The VertiPaq engine automatically creates a dictionary for each column, which means that the <em class="calibre5">Transactions</em> table will not pay a cost for duplicated descriptions as would be the case in a relational model.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span type="pagebreak" id="calibre_link-1868"></span><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Compression techniques based on dictionaries are also available in certain relational databases. For example, Microsoft SQL Server offers this feature through the clustered columnstore indexes. However, the default behavior of a relational database is to store data without using a dictionary-based compression.</p>
</div>
<p class="edition">In terms of space saving, the denormalization is always better by denormalizing a single column in a separate table; on the other hand, the denormalization of many columns in a single table&mdash;as is the case for the attributes of a <em class="calibre5">Product</em>&mdash;might be more expensive than using a normalized model. For example, we can compare the memory cost between a normalized and a denormalized model:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Memory cost for normalized model:</p>
<ul class="bull">
<li class="calibre10"><p class="listp">Column <em class="calibre5">Transactions[Type Code]</em></p></li>
<li class="calibre10"><p class="listp">Column <em class="calibre5">Payments[Type Code]</em></p></li>
<li class="calibre10"><p class="listp">Column <em class="calibre5">Payments[Type Description]</em></p></li>
<li class="calibre10"><p class="listp">Relationship <em class="calibre5">Transactions[Type Code]</em> &ndash; <em class="calibre5">Payments[Type Code]</em></p></li>
</ul></li>
<li class="calibre10"><p class="listp">Memory cost for denormalized model:</p>
<ul class="bull">
<li class="calibre10"><p class="listp">Column <em class="calibre5">Transactions[Type Code]</em></p></li>
<li class="calibre10"><p class="listp">Column <em class="calibre5">Transactions[Type Description]</em></p></li>
</ul></li>
</ul>
<p class="edition">The denormalized model removes the cost of the <em class="calibre5">Payments[Type Code]</em> column and the cost of the relationship on <em class="calibre5">Transactions[Type Code]</em>. However, the cost of the <em class="calibre5">Type Description</em> column is different between <em class="calibre5">Transactions</em> and <em class="calibre5">Payments</em> tables, and in a very large table, the difference might be in favor of the normalized model. However, usually the aggregation of a column performs better when a filter is applied to another column of the same table, rather than a filter on a column in another table connected through a relationship. Does this justify a complete denormalization of the data model into a single table? Absolutely not! In terms of usability, the star schema should be always the preferred choice because it is a good trade-off in terms of resource usage and performance.</p>
<p class="edition">A star schema contains a table for each business entity such as <em class="calibre5">Customer</em> and <em class="calibre5">Product</em>, and all the attributes related to an entity are completely denormalized in such tables. For example, the <em class="calibre5">Product</em> table should have attributes such as <em class="calibre5">Category</em>, <em class="calibre5">Subcategory</em>, <em class="calibre5">Model</em>, and <em class="calibre5">Color</em>. This model works well whenever the cardinality of the relationship is not too large. As mentioned before, 1 million unique values is the threshold to define a large cardinality for a relationship, although 100,000 unique values already classifies a relationship as a potential risk for the performance of the queries.</p>
<p class="edition">In order to understand why the cardinality of a relationship is important for performance, it is useful to know what happens by applying a filter on a column. Consider the schema in <a href="#calibre_link-1408" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-5</a>, where there are relationships between the <em class="calibre5">Sales</em> table and <em class="calibre5">Product</em>, <em class="calibre5">Customer</em>, and <em class="calibre5">Date</em>. By querying the data model filtering customers by gender, the engine transfers the filter from <em class="calibre5">Customer</em> to <em class="calibre5">Sales</em> by specifying the list of customer keys that belong to each gender type included in the query. If there are <span type="pagebreak" id="calibre_link-1663"></span>10,000 customers, any list generated by a filter cannot be larger than this number. However, if there are 6 million customers, a filter by a single gender type might generate a list of unique keys, resulting in around 3 million unique values for each gender. A large number of keys involved in a relationship always has an impact in performance, even though in absolute terms said impact also depends on the version of the engine and on the hardware being used (CPU clock, cache size, RAM speed).</p>
<figure id="calibre_link-1408" class="image-l">
<img src="images/000074.jpg" alt="This figure shows the data model." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 18-5</strong> The <em class="calibre5">Sales</em> table has relationships with the <em class="calibre5">Product</em>, <em class="calibre5">Customer</em>, and <em class="calibre5">Date</em> tables.</figcaption>
</figure>
<p class="edition">What can be done to optimize the data model when a relationship involves millions of unique values? If the measured performance degradation is not compatible with the query latency requirements, one might consider other forms of denormalization that reduce the cardinality of the relationship or that remove entirely the need for a relationship in certain queries. In the previous example, one might consider denormalizing the <em class="calibre5">Gender</em> column in the <em class="calibre5">Sales</em> table, in the event it is the only case where they need to optimize performance. If there are more columns to optimize, consider creating another table with the columns of <em class="calibre5">Customer</em> table that users query often and that have a low cardinality (and a low selectivity).</p>
<p class="edition">For instance, consider a table called <em class="calibre5">Customer Info</em> with <em class="calibre5">Gender</em>, <em class="calibre5">Occupation</em>, and <em class="calibre5">Education</em> columns. If the cardinality of these columns is 2, 5, and 5 values, respectively, a table with all the possible combinations has 50 rows (2 × 5 × 5). A query on any of these columns will be much faster because the filter applied to <em class="calibre5">Sales</em> will have a very short list of values. In terms of usability, the user will see two groups of attributes for the same entity, corresponding to the two tables, <em class="calibre5">Customer</em> and <em class="calibre5">Customer Info</em>. This is not an ideal situation. For this reason, this optimization should only be considered when strictly necessary, unless the same result can be obtained by using the Aggregations feature in the Tabular model.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span type="pagebreak" id="calibre_link-1664"></span><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">The Aggregations feature is discussed later in this chapter. It is a feature that automates the creation of the underlying tables and relationships whose only purpose is to optimize the performance of the storage engine requests. As of April 2019, the Aggregations feature only works for tables stored in DirectQuery and cannot replace the techniques described in this section. This will be possible when the Aggregations also work for tables stored in VertiPaq.</p>
</div>
<p class="edition">It is important that both tables have a direct relationship with the <em class="calibre5">Sales</em> table, as shown in <a href="#calibre_link-1409" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-6</a>.</p>
<figure id="calibre_link-1409" class="image-l">
<img src="images/000082.jpg" alt="This figure shows the data model with the relationships." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 18-6</strong> Both the <em class="calibre5">Customer</em> and <em class="calibre5">Customer Info</em> tables have a relationship with <em class="calibre5">Sales</em>.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">CustomerInfoKey</em> column should be added to the <em class="calibre5">Sales</em> table before any data is imported into it so that it is a native column. As discussed in <a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 17</a>, native columns are better compressed than calculated columns. However, a calculated column could also be created with the following DAX expression:</p>
<p class="codelink"><a href="#calibre_link-1410" id="calibre_link-2766" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[CustomerInfoKey] =
LOOKUPVALUE (
    'Customer Info'[CustomerInfoKey],
    'Customer Info'[Gender], RELATED ( Customer[Gender] ),
    'Customer Info'[Occupation], RELATED ( Customer[Occupation] ),
    'Customer Info'[Education], RELATED ( Customer[Education] )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3209"></span>From a user experience perspective, the columns that are denormalized in the <em class="calibre5">Customer Info</em> table should be hidden from the <em class="calibre5">Customer</em> table. Showing the same attributes (<em class="calibre5">Gender</em>, <em class="calibre5">Occupation</em>, and <em class="calibre5">Education</em>) in two tables would generate confusion. However, by hiding these attributes from the <em class="calibre5">Customer</em> table, it is not possible to create a report with the list of customers with a certain <em class="calibre5">Occupation</em> without looking at the transactions in the <em class="calibre5">Sales</em> table. In order to avoid losing such features, the model should be enhanced including an inactive relationship, which can be activated if needed. We need specific measures to activate that relationship, as we will see later in the optimized <em class="calibre5">Sales Amount</em> measure. <a href="#calibre_link-1411" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-7</a> shows that there is an active relationship between the <em class="calibre5">Customer Info</em> table and the <em class="calibre5">Sales</em> table, and an inactive relationship between the <em class="calibre5">Customer Info</em> table and the <em class="calibre5">Customer</em> table.</p>
<figure id="calibre_link-1411" class="image-l">
<img src="images/000090.jpg" alt="This figure shows the data model and emphasizes the active versus inactive relationships." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 18-7</strong> An inactive relationship connects the <em class="calibre5">Customer</em> and <em class="calibre5">Customer Info</em> tables.</figcaption>
</figure>
<p class="edition">The relationship between <em class="calibre5">Customer Info</em> and <em class="calibre5">Customer</em> can be activated whenever there is any other filter active in the <em class="calibre5">Customer</em> table. For example, consider the following definition of the <em class="calibre5">Sales Amount</em> measure:</p>
<p class="codelink"><a href="#calibre_link-1412" id="calibre_link-2767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount :=
IF (
    ISCROSSFILTERED ( Customer[CustomerKey] ),
    CALCULATE (
        [Sales Internal],
        USERELATIONSHIP ( Customer[CustomerInfoKey], 'Customer Info'[CustomerInfoKey] ),
        CROSSFILTER ( Sales[CustomerInfoKey], 'Customer Info'[CustomerInfoKey], NONE )
    ),
    [Sales Internal]
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1869"></span>The cross filter is only active in the <em class="calibre5">Customer</em> table when there is a filter on any column of the <em class="calibre5">Customer</em> table, unless the relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Customer</em> is bidirectional. Indeed, when the cross filter is active, the relationship between <em class="calibre5">Customer</em> and <em class="calibre5">Customer Info</em> is enabled by using <em class="calibre5">USERELATIONSHIP</em>, automatically disabling the other relationship between <em class="calibre5">Customer Info</em> and <em class="calibre5">Sales</em>. Furthermore, the <em class="calibre5">CROSSFILTER</em> in the function is not necessary, but it is a good idea to keep it there; it highlights the intention to disable the filter propagation in the relationship between <em class="calibre5">Customer Info</em> and <em class="calibre5">Sales</em>. The idea is that, since the engine must process a list of <em class="calibre5">CustomerKey</em> values in any case, it is better to reduce such a filter by also including the attributes moved into <em class="calibre5">Customer Info</em>. However, when the user filters columns in <em class="calibre5">Customer Info</em> and not in <em class="calibre5">Customer</em>, the default active relationship uses a better relationship made with a lower number of unique values. Unfortunately, in order to optimize the use of the <em class="calibre5">Customer</em>-<em class="calibre5">Sales</em> relationship in a data model, this DAX pattern must be applied to all the measures that might involve <em class="calibre5">Customer Info</em> attributes. This is not necessary using Aggregations in the data model because the pattern is implemented automatically by the engine without requiring any effort in the DAX code.</p>
<p class="edition">Another very common scenario where a high cardinality in a relationship should be denormalized is that of a relationship between two large tables. For example, consider the <em class="calibre5">Sales Header</em> and <em class="calibre5">Sales Detail</em> tables in the data model in <a href="#calibre_link-1413" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-8</a>.</p>
<figure id="calibre_link-1413" class="image-l">
<img src="images/000098.jpg" alt="This figure is a data model with relationships." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 18-8</strong> The <em class="calibre5">Customer</em> table filters <em class="calibre5">Sales Detail</em> transactions through relationships with <em class="calibre5">Sales Header</em>.</figcaption>
</figure>
<p class="edition">This situation is common because many normalized relational databases are composed of this same design. However, the relationship between <em class="calibre5">Sales Header</em> and <em class="calibre5">Sales Detail</em> is particularly dangerous for a DAX query because of the high number of unique values. Any query grouping the <em class="calibre5">Quantity</em> column (from <em class="calibre5">Sales Detail</em>) by <em class="calibre5">Customer[Gender]</em> transfers a filter from <em class="calibre5">Sales Header</em> to <em class="calibre5">Sales Detail</em> through the <em class="calibre5">SalesOrderNumber</em> column. A better design is possible by denormalizing in <em class="calibre5">Sales Detail</em> all the relationships stored in <em class="calibre5">Sales Header</em>. In practice, there should be two star schemas sharing the same dimensions. The only purpose of the denormalization is to avoid passing a filter through the relationship between <em class="calibre5">Sales Header</em> and <em class="calibre5">Sales Detail</em>, which no longer exists in the new design shown in <a href="#calibre_link-1414" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 18-9</a>.</p>
<figure id="calibre_link-1414" class="image-l">
<img src="images/000106.jpg" alt="This figure shows the data model with the relationships discussed." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1863"></span><strong class="calibre7">Figure 18-9</strong> There are direct relationships between the <em class="calibre5">Sales Header</em> and <em class="calibre5">Sales Detail</em> tables, and <em class="calibre5">Customer</em> and <em class="calibre5">Calendar</em>.</figcaption>
</figure>
<p class="edition">Use the right degree of denormalization in a data model for DAX, especially for performance reasons. The best practices described in this section provide a good balance between usability and performance.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-301" class="h2a">Columns cardinality</h3>
<p class="edition">The cardinality of a column is the number of unique values that the column contains. This number is important to reduce the size of the column, which has a direct impact on VertiPaq scan performance. Another reason to reduce the cardinality of a column to a necessary minimum is that many DAX operations, such as iterations and filters, have an execution time that directly depends on this number. Often, the cardinality of a column is more important than the number of rows of the table containing the column.</p>
<p class="edition">The data model designer should identify the cardinality of a column and consider possible optimizations if the column is to be used in relationships, filters, or calculations. There are several common scenarios to consider:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Key of a relationship:</strong> The cardinality of the column cannot be changed unless the cardinality of the related table is changed, too. See the “<a href="#calibre_link-300" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Denormalization</a>” section, earlier in this chapter.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Numeric value aggregated in a measure:</strong> Do not change the precision of a number if that number represents a quantity or the amount of a monetary transaction. However, if a number represents a measure with a floating-point value, one might consider removing the decimals that are not relevant. For example, when collecting temperatures, the value could be rounded down to the closest decimal digit; the removed part is probably lower than the precision of the measuring tool.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-1864"></span><strong class="calibre7">Low cardinality text description:</strong> The only impact is on dictionary size in case the column has many unique values. There are no advantages in moving the column into a separate table because the dictionary would be the same. Keep this column if users need it.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">High cardinality text notes:</strong> Potentially different for every row of the table, but it is not a big issue if most of the rows have a blank value.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Pictures:</strong> This column is required to display graphics in a client tool&mdash;for example, a picture of a product. This data type is not available in Power BI; storing the URL of an image that is loaded dynamically is a better alternative that saves memory.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Transaction ID:</strong> This column has a high cardinality in a large table. Consider removing it if it is not necessary in DAX queries. If used in drill-through operations&mdash;for example, to see the transactions that form a particular aggregation&mdash;consider splitting the number/string into two or more parts, each with a smaller number of unique values.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Date and time:</strong> Consider splitting the column into two parts. More on this in the following section in this chapter, “<a href="#calibre_link-302" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Handling date and time</a>.”</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Audit columns:</strong> A table in a relational database often has standard columns used for auditing purposes&mdash;for instance, timestamp and user of last update. These columns should not be imported in a model stored by VertiPaq, unless required for drill-through. In that case, consider splitting the timestamp following the same rules applied to date and time.</p></li>
</ul>
<p class="edition">As a rule of thumb, consider that reducing the cardinality of a column saves memory and improves performance. Because reducing cardinality might imply losing information and/or accuracy, be careful in considering the implications of these optimizations.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-302" class="h2a">Handling date and time</h3>
<p class="edition">Almost any data model has one or more date columns. Every so often, the time is also an interesting dimension of analysis. Usually, these columns come from original <em class="calibre5">Datetime</em> columns in the data source. There are several best practices to optimize these types of columns.</p>
<p class="edition">First and foremost, date and time should be always split into two separate columns, without using calculated columns to do so. The split should take place by reading the original column in two different columns of the data model: one for the date, the other for the time. For example, reading a <em class="calibre5">TransactionExecution</em> column from a table in SQL Server, one should use the following syntax in a T-SQL query to create two columns, <em class="calibre5">TransactionDate</em> and <em class="calibre5">TransactionTime</em>:</p>
<p class="codelink"><a href="#calibre_link-1415" id="calibre_link-2768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"> ...
CAST ( TransactionExecution AS DATE ) AS TransactionDate,
CAST ( TransactionExecution AS TIME ) AS TransactionTime,
...</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3210"></span>It is very important to do this split operation; otherwise, the model would have a column in which dictionary and cardinality would increase every day. Moreover, analyzing a timestamp in Tabular is very hard. A <em class="calibre5">Date</em> table needs an exact match with the date, and the <em class="calibre5">Datetime</em> column would not work correctly in a relationship with the <em class="calibre5">Date</em> column of a <em class="calibre5">Date</em> table.</p>
<p class="edition">A <em class="calibre5">Date</em> column usually has a good granularity: 10 years correspond to less than 3,700 unique values, and even 100 years still fall within a manageable order of magnitude. Moreover, time intelligence functions require a complete calendar for each year considered, so removing days (for example, keeping only one day per month) is not an optimization to consider.</p>
<p class="edition">The <em class="calibre5">Time</em> column, on the other hand, should be subject to more considerations. With a <em class="calibre5">Time</em> column, one should consider creating a <em class="calibre5">Time</em> table, which contains one row for each point in the chosen granularity. The time should be rounded to the same granularity as the one chosen for the <em class="calibre5">Time</em> table. The <em class="calibre5">Time</em> table will make it easy to consider different time periods: for example, morning and evening, or 15-minute intervals. Depending on the data and the analysis required, the time could be rounded down to the closest hour or millisecond&mdash;even though the latter is very unlikely. <a href="#calibre_link-1416" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 18-5</a> shows the different cardinality corresponding to different precision levels.</p>
<p class="edition" id="calibre_link-1416"><strong class="calibre7">Table 18-5</strong> Cardinality corresponding to different precision levels for a <em class="calibre5">Time</em> column</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Precision</p></th>
<th class="th"><p class="tab-text">Cardinality</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">Hour</p></td>
<td class="th1"><p class="tab-text">24</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">15 Minutes</p></td>
<td class="th1"><p class="tab-text">96</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">5 Minutes</p></td>
<td class="th1"><p class="tab-text">288</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Minute</p></td>
<td class="th1"><p class="tab-text">1,440</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Second</p></td>
<td class="th1"><p class="tab-text">86,400</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Millisecond</p></td>
<td class="th1"><p class="tab-text">86,400,000</p></td>
</tr>
</tbody>
</table>
<p class="edition">Choosing the millisecond precision is usually the worst choice, and a precision down to the second still has a relatively high number of unique values. Most of the times the precision choice will be in a range between hours and minutes. At this point, one might think that the minute precision is a safe choice because it has a relatively low cardinality. However, remember that the compression of a column depends on the presence of duplicated values in contiguous rows. Thus, moving from a minute to 15-minute precision can have a big impact on the compression of large tables.</p>
<p class="edition">The choice between rounding to the closest second/minute or truncating the detail not needed for the analysis depends on analytical requirements. Here is an example of the T-SQL code that truncates a time to different precision levels:</p>
<p class="codelink"><a href="#calibre_link-1417" id="calibre_link-2769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">-- Truncate to the second
DATEADD (
    MILLISECOND,
    - DATEPART ( MILLISECOND, CAST ( TransactionExecution AS TIME(3) ) ),
    CAST ( TransactionExecution AS TIME(3) )
)
<span type="pagebreak" id="calibre_link-3211"></span>-- Truncate to the minute
DATEADD (
    SECOND,
    - DATEPART (SECOND, CAST ( TransactionExecution AS TIME(0) ) ),
    CAST ( TransactionExecution AS TIME(0) )
)

-- Truncate to 5 minutes
--   change 5 to 15 to truncate to 15 minutes
--   change 5 to 60 to truncate to the hour
CAST (
    DATEADD (
        MINUTE,
        ( DATEDIFF (
              MINUTE,
              0,
              DATEADD (
                  SECOND,
                  - DATEPART ( SECOND, CAST ( TransactionExecution AS TIME(0) ) ),
                  CAST ( TransactionExecution AS TIME(0) )
              )
          ) / 5 ) * 5,
        0
    ) AS TIME(0)
)</pre></div>
<p class="edition">The following T-SQL code shows examples for rounding time instead of truncating it:</p>
<p class="codelink"><a href="#calibre_link-1418" id="calibre_link-2770" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">-- Round to the second
CAST ( TransactionExecution AS TIME(0) )

-- Round to the minute
CAST ( DATEADD (
    MINUTE,
    DATEDIFF (
        MINUTE,
        0,
        DATEADD ( SECOND, 30, CAST ( TransactionExecution AS TIME(0) ) )
    ),
    0
) AS TIME ( 0 ) )

-- Round to 5 minutes
--   change 5 to 15 to truncate to 15 minutes
--   change 5 to 60 to truncate to the hour
CAST ( DATEADD (
    MINUTE,
    ( DATEDIFF (
        MINUTE,
        0,
        DATEADD ( SECOND, 5 * 30, CAST ( TransactionExecution AS TIME(0) ) )
      ) / 5 ) * 5,
    0
) AS TIME ( 0 ) )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1819"></span>Similar transformations can be applied in Power Query when importing data, though for tables with millions of rows a transformation made in the original data source may provide better performance.</p>
<p class="edition">When storing millions of new rows every day in a single table, these details can make a big difference in memory usage and performance. At the same time, do not spend too much time optimizing a data model that does not require very high a level of compression; after all, reducing the precision means removing some information that will no longer be available for deeper insights if needed.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-303" class="h2a">Calculated columns</h3>
<p class="edition">A calculated column stores the result of a DAX expression evaluated row-by-row during a table refresh. For this reason, calculated columns might be considered as a possible way to optimize query execution time. However, a calculated column has hidden costs, and it is only a good optimization technique under specific conditions.</p>
<p class="edition">Calculated columns should be considered as viable options only in these two situations:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Group or filter data:</strong> If a calculated column returns a value used to group or filter data, there is no alternative other than creating the same value before importing data into the data model. For example, the price of a product might be classified into Low, Medium, and High categories. This value is usually a string, especially when the user makes it available as a selection.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Precalculate complex formulas:</strong> A calculated column can store the result of a complex calculation that is not sensitive to filters made at query time. However, it is very hard to establish when this produces a real computational advantage, and it is necessary to measure the presence of a real advantage at query time in order to justify its use.</p></li>
</ul>
<p class="edition">Do not make the wrong assumption that any calculated column is faster than doing the same computation at query time. This is often inaccurate. Other times, the advantage is barely measurable and does not balance out the cost of the calculated column. There should be a relevant performance improvement at query time to justify a calculated column for optimization reasons. There are also many factors to consider when evaluating the cost/benefit ratio of a calculated column against an equivalent calculation made at runtime in a measure.</p>
<p class="edition">A calculated column is not as optimized as a native column. It might have a lower compression rate compared to native columns of the table because it does not take part in the heuristic that VertiPaq executes to find the optimal sort order of the data in each segment. Only a column storing a very low number of unique values might benefit from a good compression, but this is usually the result of logical conditions and not of numeric expressions.</p>
<p class="edition">For example, consider the case of a simple calculated column:</p>
<p class="codelink"><a href="#calibre_link-1419" id="calibre_link-2771" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Amount] = Sales[Quantity] * Sales[Price]</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3212"></span>If there are 100 unique values in <em class="calibre5">Quantity</em> and 1,000 unique values in <em class="calibre5">Price</em>, the resulting <em class="calibre5">Amount</em> column might have a cardinality between 1 and 100,000 unique values, depending on the actual values in the columns and on their distribution across table rows. Usually, the larger the number of rows in the table, the higher the number of unique values found in the <em class="calibre5">Amount</em> column&mdash;because of statistical distribution. With a dictionary that is one or two orders of magnitude larger than the original columns, the compression is usually worse. What about query performance? It depends, and it should be measured case-by-case in order to get a correct answer, considering the two possible calculations: one based on a calculated column and the other completely dynamic and based on measures.</p>
<p class="edition">A simple measure can sum the <em class="calibre5">Amount</em> calculated column:</p>
<p class="codelink"><a href="#calibre_link-1420" id="calibre_link-2772" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">TotalAmountCC := SUM ( Sales[Amount] )</pre></div>
<p class="edition">The alternative dynamic implementation transfers the expressions of the calculated column in an iterator over the table:</p>
<p class="codelink"><a href="#calibre_link-1421" id="calibre_link-2773" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">TotalAmountM := SUMX ( Sales, Sales[Quantity] * Sales[Price] )</pre></div>
<p class="edition">Is the cost of scanning the single <em class="calibre5">Sales[Amount]</em> column smaller than scanning the two original <em class="calibre5">Sales[Quantity]</em> and <em class="calibre5">Sales[Price]</em> columns? It is impossible to estimate this in advance, so it must be measured. Usually, the difference between these two options is only visible in very large tables. In small tables the performance might be very close, so the calculated column is not worth its memory footprint.</p>
<p class="edition">Most of the time, calculated columns used to compute aggregated values can be replaced by using the same expressions in iterators such as <em class="calibre5">SUMX</em> and <em class="calibre5">AVERAGEX</em>. In the previous example, <em class="calibre5">TotalAmountM</em> is a measure that dynamically executes the same expression defined in the calculated <em class="calibre5">Amount</em> column, used by the simple aggregation in <em class="calibre5">TotalAmountCC</em>.</p>
<p class="edition">A different evaluation is necessary when a context transition is present in an iterator. For example, consider the following DAX measure in a model where the <em class="calibre5">Sales Header</em> and <em class="calibre5">Sales Detail</em> tables are connected through a relationship:</p>
<p class="codelink"><a href="#calibre_link-1422" id="calibre_link-2774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AverageOrder :=
AVERAGEX (
    'Sales Header',
    CALCULATE (
        SUMX (
            'Sales Detail',
            'Sales Detail'[Quantity] * 'Sales Detail'[Unit Price]
        ),
        ALLEXCEPT ( 'Sales Detail', 'Sales Header' )
    )
)</pre></div>
<p class="edition">In this case, the context transition within the loop can be very expensive, especially if the <em class="calibre5">Sales Header</em> table contains millions of rows or more. Storing the value in a calculated column will probably save a lot of execution time.</p>
<p class="codelink"><a href="#calibre_link-1423" id="calibre_link-2775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-1760"></span>'Sales Header'[Amount] =
CALCULATE (
    SUMX (
        'Sales Detail',
        'Sales Detail'[Quantity] * 'Sales Detail'[Unit Price]
    )
)

AverageOrder :=
AVERAGEX (
    'Sales Header',
    'Sales Header'[Amount]
)</pre></div>
<p class="edition">We will never grow tired of repeating that these examples are guidelines. One should measure the performance improvements of a calculated column and its related memory cost in order to decide whether to use it or not.</p>
<p class="edition">Consider that a calculated column can be avoided by creating the same value for a native column in the data source when populating the table&mdash;for example, using an SQL statement or a Power Query transformation. A useful calculated column should leverage the VertiPaq engine, providing a faster and more flexible way to compute a column than reading the entire table again from the data source. Usually, this happens when the calculated column expression aggregates rows from tables other than the one it belongs to; the previous <em class="calibre5">Amount</em> calculated column in the <em class="calibre5">Sales Header</em> table is an example of such condition.</p>
<p class="edition">Finally, a calculated column increases the time to refresh a data model especially because it is an operation that cannot scale on multiple threads, as explained in more detail in a following section, “<a href="#calibre_link-305" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Processing of calculated columns</a>.”</p>
<p class="edition">At this point, it should be clear that calculated columns are expensive for two reasons:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Memory:</strong> The values are persisted using a nonoptimal compression.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Duration of Refresh:</strong> The process of calculated columns is a sequential operation using a single thread, which results in a nonscalable operation also in large servers.</p></li>
</ul>
<p class="edition">With that said, calculated columns prove useful in many scenarios. We do not want to pass on the message that calculated columns are always to be avoided. Instead, be aware of their cost and make an educated decision on whether to use them or not. In the next section we describe a good example where calculated columns really shine in improving performance.</p>
<section class="calibre4">
<h4 id="calibre_link-304" class="calibre13">Optimizing complex filters with <em class="calibre5">Boolean</em> calculated columns</h4>
<p class="edition">It is worth mentioning a specific case where optimization is achieved using calculated columns. A logical expression used to filter a high-cardinality column can be consolidated using a calculated column that stores the result of the logical expression itself.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1761"></span>For example, consider the following measure:</p>
<p class="codelink"><a href="#calibre_link-1424" id="calibre_link-2776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ExpensiveTransactions :=
COUNTROWS (
    FILTER (
        Sales,
        VAR UnitPrice =
            IF (
                Sales[Unit Discount] &gt; 0,
                RELATED ( 'Product'[Unit Price] ),
                Sales[Net Price]
            )
        VAR IsLargeTransaction = UnitPrice * Sales[Quantity] &gt; 100
        VAR IsLargePrice = UnitPrice &gt; 70
        VAR IsExpensive = IsLargeTransaction || IsLargePrice
        RETURN
            IsExpensive
    )
)</pre></div>
<p class="edition">In case there are millions of rows in the <em class="calibre5">Sales</em> table, the filter iteration could be expensive. If the expression used in the filter does not depend on the existing filter context, as in this case, the result of the expression can be consolidated in a calculated column, applying a filter on that column in a <em class="calibre5">CALCULATE</em> statement instead. For example, the previous operation can be rewritten this way:</p>
<p class="codelink"><a href="#calibre_link-1425" id="calibre_link-2777" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[IsExpensive] =
VAR UnitPrice =
    IF (
        Sales[Unit Discount] &gt; 0,
        RELATED ( 'Product'[Unit Price] ),
        Sales[Net Price]
    )
VAR IsLargeTransaction = UnitPrice * Sales[Quantity] &gt; 100
VAR IsLargePrice = UnitPrice &gt; 70
VAR IsExpensive = IsLargeTransaction || IsLargePrice
RETURN
    IsExpensive

ExpensiveTransactions :=
CALCULATE (
    COUNTROWS ( Sales ),
    Sales[IsExpensive] = TRUE
)</pre></div>
<p class="edition">The calculated column containing a logical value (<em class="calibre5">TRUE</em> or <em class="calibre5">FALSE</em>) usually benefits from good compression and a low memory cost. It is also very effective at execution time because it applies a direct filter to the scan of the <em class="calibre5">Sales</em> table required to count the rows. In this case, the benefit at query time is usually evident. Just consider if it is worth the longer processing time for the column; that processing time must be measured before making a final decision.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-305" class="calibre13"><span type="pagebreak" id="calibre_link-1707"></span>Processing of calculated columns</h4>
<p class="edition">The presence of one or more calculated columns slows down the refresh of any part of a table that is somewhat related to the calculated column. This section describes the reasons for that; it also provides background information on why an incremental refresh operation can be very expensive because of the presence of calculated columns.</p>
<p class="edition">Any refresh operation of a table requires recomputing all the calculated columns in the entire data model referencing any column of that table. For example, refreshing a partition of a table&mdash;as during any incremental refresh&mdash;requires a complete update of all the calculated columns stored in the table. Such a calculation is performed for all the rows of the table, even though the refresh only affects a single partition of the table. It does not matter whether the expression of the calculated column only depends on other columns of the same table; the calculated column is always computed for the entire table and not for a single partition.</p>
<p class="edition">Moreover, the expression of a calculated column might depend on the content of other tables. In this case, the calculated columns referencing a partially refreshed table must also be recalculated to guarantee the consistency of the data model. The cost for computing a calculated column usually depends on the number of rows of the table where the column is stored.</p>
<p class="edition">The process of a calculated column is a single-thread job, which iterates all the rows of the table to compute the column expression. In case there are several calculated columns, they are evaluated one at a time, making the entire operation a process bottleneck for large tables. For these reasons, creating a calculated column in a large table with hundreds of millions of rows is not a good idea. Creating tens of calculated columns in a large table can result in a very long processing time, adding minutes to the time required to process the native data.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-306" class="h2a">Choosing the right columns to store</h3>
<p class="edition">The previous section about calculated columns explained that storing a column that can be computed row-by-row using other columns of the same table is not always an advantage. The same consideration is also valid for native columns of the table. When choosing the columns to store in a table, consider the memory size and the query performance. Good optimizations of resource allocation (and memory in particular) are possible by doing the right evaluation in this area.</p>
<p class="edition">We consider the following types of columns in a table:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Primary or alternate keys:</strong> The column contains a unique value for each row of the table.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Qualitative attributes:</strong> The column can be text or number, used to group and/or filter rows in a table; for instance, name, color, city, country.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Quantitative attributes:</strong> The number is a value used both as a filter (for example, less than a certain value) and as an argument in a calculation, such as price, amount, quantity.</p></li>
<li class="calibre10"><p class="listp"><span type="pagebreak" id="calibre_link-1708"></span><strong class="calibre7">Descriptive attributes:</strong> The column contains text providing additional information about a row, but its content is never used to filter or to aggregate rows&mdash;for example, notes, comments.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Technical attributes:</strong> Information recorded in the database for technical reasons, without a business value, such as username of last update, timestamp, GUID for replication.</p></li>
</ul>
<p class="edition">The general principle is to try to minimize the cardinality of the columns imported into a table, not importing columns that have a high cardinality and that are not relevant for the analysis. However, every type of column deserves additional considerations.</p>
<p class="edition">The columns for <strong class="calibre7">primary</strong> or <strong class="calibre7">alternate keys</strong> are necessary if there are one or more one-to-many relationships with other tables. For instance, the product code and the product key columns of a table of products are certainly required columns. However, a table should not include a primary or alternate key column not used in a relationship with other tables. For example, the <em class="calibre5">Sales</em> table might have a unique identifier for each row in the original table. Such a column has a cardinality that corresponds to the number of rows of the <em class="calibre5">Sales</em> table. Moreover, a unique identifier is not necessary for relationships because no tables target <em class="calibre5">Sales</em> for a relationship. For these reasons, it is a very expensive column in terms of memory, and it should not be imported in memory. In a composite data model, a similar high-granularity column could be accessed only through DirectQuery without being stored in memory, as described later in the “<a href="#calibre_link-307" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing column storage</a>” section of this chapter.</p>
<p class="edition">A table should always include <strong class="calibre7">qualitative attributes</strong> that have a low cardinality because they have a good compression and might be useful for the analysis. For example, the product category is a column that has a low cardinality, related to the <em class="calibre5">Product</em> table. In case there is a high cardinality, we should consider carefully whether to import the column or not because its storage memory cost can be high. The high selectivity might justify the cost, but we should check that filters in queries usually select a low number of values in that column. For instance, the production lot number might be a piece of information included in the <em class="calibre5">Sales</em> table that users want to filter at query time. Its high cost might be justified by a business need to apply this filter in certain queries.</p>
<p class="edition">All the <strong class="calibre7">quantitative attributes</strong> are generally imported to guarantee any calculation, although we might consider skipping columns providing redundant information. Consider the <em class="calibre5">Quantity</em>, <em class="calibre5">Price</em>, and <em class="calibre5">Amount</em> columns of a <em class="calibre5">Sales</em> table, where the <em class="calibre5">Amount</em> column contains the result of the product between <em class="calibre5">Quantity</em> and <em class="calibre5">Price</em>. We probably want to create measures that aggregate each of these columns; yet we will probably calculate the price as a weighted average considering the sum of amount and quantity, instead of a simple average of the price considering each transaction at the same level. This is an example of the measure we want to define:</p>
<p class="codelink"><a href="#calibre_link-1426" id="calibre_link-2778" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sum of Quantity := SUM ( Sales[Quantity] )

Sum of Amount   := SUM ( Sales[Amount] )

Average Price   := DIVIDE ( [Sum of Amount], [Sum of Quantity] )</pre></div>
<p class="edition">By looking at these measures, we might say that we only need to import <em class="calibre5">Quantity</em> and <em class="calibre5">Amount</em> in the data model, without importing the <em class="calibre5">Price</em> column, which is not used by these measures. However, if we consider the cardinality of the columns, we start to have doubts. If there are 100 unique values <span type="pagebreak" id="calibre_link-1879"></span>in the <em class="calibre5">Quantity</em> column, and there are 10,000 unique values in the <em class="calibre5">Price</em> column, we might have up to 1,000,000 unique values in the <em class="calibre5">Amount</em> column. At this point, we might consider importing only the <em class="calibre5">Quantity</em> and <em class="calibre5">Price</em> columns, using the following definition of the measures in the data model; only <em class="calibre5">Sum of Amount</em> changes, the other two measures did not change:</p>
<p class="codelink"><a href="#calibre_link-1427" id="calibre_link-2779" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sum of Quantity := SUM ( Sales[Quantity] )

Sum of Amount   := SUMX ( Sales, Sales[Quantity] * Sales[Price] )

Average Price   := DIVIDE ( [Sum of Amount], [Sum of Quantity] )</pre></div>
<p class="edition">The new definition of the <em class="calibre5">Sum of Amount</em> measure might be slower because it has to scan two columns instead of one. However, these columns might be smaller than the original <em class="calibre5">Amount</em>. Trying to predict the faster option is very hard because we should also consider the distribution of the values in the table, and not only the cardinality of the column. We suggest measuring the memory used and the performance in both scenarios before making a final decision. Based on our experience, removing the <em class="calibre5">Amount</em> column in a small data model can be more important for Power BI and Power Pivot. Indeed, the available memory in personal computers is usually more limited than that of a server, and a smaller memory footprint also produces a faster loading time opening the smaller file. At any rate, in a large table with billions of rows stored in an Analysis Services Tabular model, the performance penalty of the multiplication between two columns (<em class="calibre5">Quantity</em> and <em class="calibre5">Price</em>) could be larger than the increased memory scan time for the <em class="calibre5">Amount</em> column. In this case, the better response time for the queries justifies the higher memory cost to store the <em class="calibre5">Amount</em> column. Regardless, we should measure size and performance in each specific case because the distribution of data plays a key role in compression and affects any decision pertaining to it.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Storing <em class="calibre5">Quantity</em> and <em class="calibre5">Price</em> instead of <em class="calibre5">Amount</em> is an advantage if the table is stored in VertiPaq, whereas it is not the suggested best practice for DirectQuery models. Moreover, if the table in VertiPaq contains billions of rows in memory, the <em class="calibre5">Amount</em> column can provide better query performance and it is compatible with future Aggregations over VertiPaq. More details in the section “<a href="#calibre_link-312" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Managing VertiPaq Aggregations</a>” later in this chapter.</p>
</div>
<p class="edition">We should consider whether to import <strong class="calibre7">descriptive attributes</strong> or not. In general, they have a high storage cost for the dictionary of the column when imported in memory. A few examples of descriptive attributes are the <em class="calibre5">Notes</em> field in an invoice and the <em class="calibre5">Description</em> column in the <em class="calibre5">Product</em> table. Usually, these attributes are mainly used to provide additional information about a specific entity. Users hardly use this type of column to group or filter data; the typical use case is to get detailed drill-through information. The only issue with including these columns in the data model is their memory storage cost, mainly related to the column dictionary. If the column has many blank values and a low number of unique nonblank values in the table, then its dictionary will be small and the column cost will be more acceptable. Nevertheless, a column containing the transcription of conversations made in a call center is probably too expensive for a <em class="calibre5">Service Calls</em> table containing date, time, duration, and operator who managed the call. When the cost of storing descriptive attributes in memory is too expensive, we can consider only accessing them through DirectQuery in a composite data model.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1880"></span>A particular type of descriptive attribute is the information provided as detail for transactions in a drill-through operation. For example, the invoice number or the order number of a transaction is an attribute that has a high cardinality, but that could be important for some reports. In this case, we should consider the particular optimizations for drill-through attributes described in the next section, “<a href="#calibre_link-307" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing column storage</a>.”</p>
<p class="edition">Most of the time, there is no reason to import columns for <strong class="calibre7">technical attributes</strong>, such as timestamp, date, time, and operator of the last update. This information is mainly for auditing and forensic requirements. Unless we have a data model specifically built for auditing requirements, the need for this information is usually low in an analytical solution. However, technical attributes are good candidates for columns accessed only through DirectQuery in a composite data model.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-307" class="h2a">Optimizing column storage</h3>
<p class="edition">The best optimization for a column is to remove the column from a table entirely. In the previous section, we described when this decision makes sense based on the type of columns in a table. Once we define the set of columns that are part of the data model, we can still use optimization techniques in order to reduce the amount of memory used, even though each optimization comes with side effects. In case the composite data model feature is available, an additional option is that of keeping a column in the data source, only making it accessible through DirectQuery.</p>
<section class="calibre4">
<h4 id="calibre_link-308" class="calibre13">Using column split optimization</h4>
<p class="edition">The memory footprint of a column can be lowered by reducing the column cardinality. In certain conditions, we can achieve this result by splitting the column into two or more parts. The column split cannot be obtained with calculated columns because that would require storing the original column in memory. We show examples of the split operation in SQL, but any other transformation tool (such as Power Query) can obtain the same result.</p>
<p class="edition">For instance, if there is a 10-character string (such as the values in <em class="calibre5">TransactionID</em>), we can split the column in two parts, five characters each (as in <em class="calibre5">TransactionID_High</em> and <em class="calibre5">TransactionID_Low</em>):</p>
<p class="codelink"><a href="#calibre_link-1428" id="calibre_link-2780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    LEFT ( TransactionID, 5 ) AS TransactionID_High,
    SUBSTRING ( TransactionID, 6, LEN ( TransactionID ) - 5 ) AS TransactionID_Low,
    ...</pre></div>
<p class="edition">In case of an integer value, we can use division and modulo for a number that creates an even distribution between the two columns. If there is an integer <em class="calibre5">TransactionID</em> column with numbers between 0 and 100 million, we can divide them by 10,000 as in the following example:</p>
<p class="codelink"><a href="#calibre_link-1429" id="calibre_link-2781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    TransactionID / 10000 AS TransactionID_High,
    TransactionID % 10000 AS TransactionID_Low,
    ...</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1865"></span>We can use a similar technique for decimal numbers. An easy split is separating the integer from the decimal part, although this might not produce an even distribution. For example, we can transform a <em class="calibre5">UnitPrice</em> decimal number column into <em class="calibre5">UnitPrice_Integer</em> and <em class="calibre5">UnitPrice_Decimal</em> columns:</p>
<p class="codelink"><a href="#calibre_link-1430" id="calibre_link-2782" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    FLOOR ( UnitPrice ) AS UnitPrice_Integer,
    UnitPrice - FLOOR ( UnitPrice ) AS UnitPrice_Decimal,
    ...</pre></div>
<p class="edition">We can use the result of a column split as is in simple details reports or measures that restore the original value during the calculation. If available in the client tool, the Detail Rows feature allows us to control the drill-through operation, showing to the client the original column and hiding the presence of the two split columns.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">The column split can optimize numbers aggregated in measures, using the separation between integer and decimal parts as in the previous example or similar techniques. However, consider that the aggregation operation will have to scan more than one column, and the total time of the operation is usually larger than with a single column. When optimizing for performance, saving memory might be not effective in this case, unless the dictionary is removed by enforcing value encoding instead of hash encoding for a currency or integer data type. A specific measurement is always required for a data model to validate if such optimization also works from a performance point of view.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-309" class="calibre13">Optimizing high-cardinality columns</h4>
<p class="edition">A column with a high cardinality has a high cost because of a large dictionary, a large hierarchy structure, and a lower compression in encoding. The attribute hierarchy structure can be expensive and may be disabled under certain conditions. We describe how to disable attribute hierarchies in the next section.</p>
<p class="edition">If it is not possible to disable the hierarchy, or if this reduction is not enough for memory optimization, then consider the column split optimization for a high-cardinality column used in a measure. We can hide this optimization from the user by hiding the split columns and by adapting the calculation in measures. For example, if we optimize <em class="calibre5">UnitPrice</em> using the column split, we can create the <em class="calibre5">Sum of Amount</em> measure this way:</p>
<p class="codelink"><a href="#calibre_link-1431" id="calibre_link-2783" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sum of Amount :=
SUMX (
    Sales,
    Sales[Quantity] * ( Sales[UnitPrice_Integer] + Sales[UnitPrice_Decimal] )
)</pre></div>
<p class="edition">Remember that the calculation will be more expensive, and only an accurate measurement of the performance of the two models (with and without column split optimization) can establish which one is better for a specific data model.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-310" class="calibre13"><span type="pagebreak" id="calibre_link-1668"></span>Disabling attribute hierarchies</h4>
<p class="edition">The attribute hierarchy structure is required by MDX queries that reference the column as an MDX attribute hierarchy. This structure contains a sorted list of all the values of the column, and its creation might require a large amount of time during a refresh operation, including incremental ones. The size of this structure is measured in the <em class="calibre5">Columns Hierarchies Size</em> column of VertiPaq Analyzer. If a column is only used by measures and in drill-through results, and it is not shown to the user as an attribute to filter or group data, then the attribute hierarchy structure is not necessary because it is never used.</p>
<p class="edition">The <em class="calibre5">Available In MDX</em> property of a column disables the creation of the attribute hierarchy structure when set to <em class="calibre5">False</em>. By default, this property is <em class="calibre5">True</em>. The name of this property in TMSL and TOM is <em class="calibre5">isAvailableInMdx</em>. Depending on the development tool and on the compatibility level of the data model, this property might be not available. A tool that shows this property is Tabular Editor: <a href="https://github.com/otykier/TabularEditor/releases/latest" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://github.com/otykier/TabularEditor/releases/latest</a>.</p>
<p class="edition">The attribute hierarchy structure is also used in DAX to optimize sorting and filter operations. It is safe to disable the <em class="calibre5">isAvailableInMdx</em> property when a column is only used in a measure expression, it is not visible, and it is never used to filter or sort data. This property is also documented at <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.analysisservices.tabular.column.isavailableinmdx" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://docs.microsoft.com/en-us/dotnet/api/microsoft.analysisservices.tabular.column.isavailableinmdx</a>.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-311" class="calibre13">Optimizing drill-through attributes</h4>
<p class="edition">If a column contains data used only for drill-through operations, there are two possible optimizations. The first is the column split optimization; the second is keeping the columns accessible only through DirectQuery in a composite data model.</p>
<p class="edition">When the column is not being used in measures, there are no concerns about possible costs of the materialization of the original values. By leveraging the Detail Rows feature, it is possible to show the original column in the result of a drill-through operation, hiding the presence of the two split columns. However, it is not possible to use the original value as a filter or group-by column.</p>
<p class="edition">In a composite data model, the entire table can be made accessible through a DirectQuery request, whereas the columns used by relationships and measures can be included in an in-memory aggregation managed by the VertiPaq engine. This way, it is possible to get the best performance when aggregating data, whereas the query execution time will be longer when the drill-through attributes are requested to the data source via DirectQuery. The next section, “<a href="#calibre_link-312" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Managing VertiPaq Aggregations</a>,” provides more details about that feature.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-312" class="h2a">Managing VertiPaq Aggregations</h3>
<p class="edition">The VertiPaq storage engine can be used for managing aggregations over DirectQuery data sources&mdash;and in the future, also over large VertiPaq tables. Aggregations were initially introduced in late 2018 as a Power BI feature. That same feature could later be adopted by other products. The purpose of Aggregations is to reduce the cost of a storage engine request, removing the need for an expensive DirectQuery request in case the data is available in a smaller table containing aggregated data.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3213"></span>The Aggregations feature is not necessarily related to VertiPaq: it is possible to define aggregations in a DirectQuery model so that different tables are queried on the data source, depending on the granularity of a client request. However, the typical use case for Aggregations is defining them in a composite data model, where each table has three possible storage modes:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Import:</strong> The table is stored in memory and managed by the VertiPaq storage engine.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">DirectQuery:</strong> The data is kept in the data source; at runtime, every DAX query might generate one or more requests to the data source, typically sending SQL queries.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Dual:</strong> The table is stored in memory by VertiPaq and can also be used in DirectQuery, typically joining other tables stored in DirectQuery or Dual mode.</p></li>
</ul>
<p class="edition">The principle of aggregations is to provide different options to solve a storage engine request. For example, a <em class="calibre5">Sales</em> table can store the details of each transaction, such as product, customer, and date. When one creates an aggregation by product and month, the aggregated table has a much smaller number of rows. The <em class="calibre5">Sales</em> table could also have more than one aggregation, each one with a precedence used in case of multiple aggregations compatible with the same request. Consider a case where the following aggregations are available in a model with <em class="calibre5">Sales</em>, <em class="calibre5">Product</em>, <em class="calibre5">Date</em>, and <em class="calibre5">Store</em>:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">Product</em> and <em class="calibre5">Date</em>&mdash;precedence 50</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">Store</em> and <em class="calibre5">Date</em>&mdash;precedence 20</p></li>
</ul>
<p class="edition">If a query required the total of sales by product brand and year, it would use the first aggregation. The same aggregation would be used when drilling down at the month or day level. Indeed, the aggregation that has the <em class="calibre5">Sales</em> data at the <em class="calibre5">Product</em> and <em class="calibre5">Date</em> granularity can solve any query that groups rows by using attributes included in these tables. With the same logic, a query aggregating data by store country and year will use the second aggregation created at the granularity of <em class="calibre5">Store</em> and <em class="calibre5">Date</em>. However, a query aggregating data by store country and product brand cannot use any existing aggregation. Such queries must use the <em class="calibre5">Sales</em> table that has all the details because none of the aggregations available have a granularity compatible with the request. If two or more aggregations are compatible with the request, the choice is made based on the precedence setting defined for each aggregation: The engine chooses the aggregation with the highest precedence. <a href="#calibre_link-1432" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 18-6</a> recaps the aggregations used based on the query request in the examples described.</p>
<p class="edition" id="calibre_link-1432"><strong class="calibre7">Table 18-6</strong> Examples of aggregation used, based on query request</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Query Request</p></th>
<th class="th"><p class="tab-text">Aggregation Used</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">Group by product brand and year</p></td>
<td class="th1"><p class="tab-text"><em class="calibre5">Product</em> and <em class="calibre5">Date</em></p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Group by product brand and month</p></td>
<td class="th1"><p class="tab-text"><em class="calibre5">Product</em> and <em class="calibre5">Date</em></p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Group by store country and year</p></td>
<td class="th1"><p class="tab-text"><em class="calibre5">Store</em> and <em class="calibre5">Date</em></p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Group by store country and month</p></td>
<td class="th1"><p class="tab-text"><em class="calibre5">Store</em> and <em class="calibre5">Date</em></p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Group by year</p></td>
<td class="th1"><p class="tab-text"><em class="calibre5">Product</em> and <em class="calibre5">Date</em> (highest precedence)</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Group by month</p></td>
<td class="th1"><p class="tab-text"><em class="calibre5">Product</em> and <em class="calibre5">Date</em> (highest precedence)</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Group by store country and product brand</p></td>
<td class="th1"><p class="tab-text">No aggregation&mdash;query <em class="calibre5">Sales</em> table at detail level</p></td>
</tr>
</tbody>
</table>
<p class="edition"><span type="pagebreak" id="calibre_link-3214"></span>The engine chooses the aggregation to use only considering the precedence order, regardless of the aggregation storage mode. Indeed, every aggregation has an underlying table that can be stored either in VertiPaq or in DirectQuery. Common sense would suggest that a VertiPaq aggregation should be preferred over a DirectQuery aggregation. Nevertheless, the DAX engine only follows precedence rules. If a DirectQuery aggregation has a higher precedence over a VertiPaq aggregation, and both are candidates to speed up a request, the engine chooses the DirectQuery aggregation. It is up to the developer to define a good set of precedence rules.</p>
<p class="edition">An aggregation can match a storage engine request depending on several conditions:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Granularity of the relationships involved in the storage engine request.</p></li>
<li class="calibre10"><p class="listp">Matching of columns defined as GroupBy in the summarization type of the aggregation.</p></li>
<li class="calibre10"><p class="listp">Summarization corresponding to a simple aggregation of a single column.</p></li>
<li class="calibre10"><p class="listp">Presence of a Count summarization of the detail table.</p></li>
</ul>
<p class="edition">These conditions might have an impact on the data model design. A model that imports all the tables in VertiPaq usually is designed to minimize the memory requirements. As described in the previous section, “<a href="#calibre_link-306" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Choosing the right columns to store</a>,” storing the <em class="calibre5">Quantity</em> and <em class="calibre5">Price</em> columns allows the developer to compute the <em class="calibre5">Amount</em> at query time using a measure such as:</p>
<p class="codelink"><a href="#calibre_link-1433" id="calibre_link-2784" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount := SUMX ( Sales, Sales[Quantity] * Sales[Price] )</pre></div>
<p class="edition">This version of the <em class="calibre5">Sales Amount</em> measure might not use an aggregation with a Sum summarization type because the Sum summarization only references a single column. However, an aggregation could match the request if <em class="calibre5">Sales[Quantity]</em> and <em class="calibre5">Sales[Price]</em> have the GroupBy summarization and if there is a Count summarization of the <em class="calibre5">Sales</em> table. For complex expressions it could be hard to define an efficient aggregation, and this could impact the model and aggregation design.</p>
<p class="edition">Consider the following code as an educational example. If there are two Sum aggregations for the <em class="calibre5">Sales[Amount]</em> and <em class="calibre5">Sales[Cost]</em> columns, then a <em class="calibre5">Margin</em> measure should be implemented using the difference between two aggregations (<em class="calibre5">Margin1</em> and <em class="calibre5">Margin2</em>), instead of aggregating the difference computed row-by-row (<em class="calibre5">Margin3</em>).</p>
<p class="codelink"><a href="#calibre_link-1434" id="calibre_link-2785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales Amount := SUM ( Sales[Amount] )                         -- Can use Sum aggregations
Total Cost   := SUM ( Sales[Cost] )                           -- Can use Sum aggregations
Margin1      := [Sales Amount] - [Total Cost]                 -- Can use Sum aggregations
Margin2      := SUM ( Sales[Amount] ) - SUM ( Sales[Cost] )   -- Can use Sum aggregations

Margin3 := SUMX ( Sales, Sales[Amount] - Sales[Cost] )   -- CANNOT use Sum aggregations</pre></div>
<p class="edition">However, the <em class="calibre5">Margin3</em> measure could match an aggregation that defines the GroupBy summarization for the <em class="calibre5">Sales[Amount]</em> and <em class="calibre5">Sales[Cost]</em> columns and that also includes a Count summarization of the <em class="calibre5">Sales</em> table. Such aggregation would potentially also be useful for the previous definitions of the <em class="calibre5">Sales Amount</em> and <em class="calibre5">Total Cost</em> measures, even though it would be less efficient than a Sum aggregation on the specific column.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1669"></span>As of April 2019, the Aggregations feature is available for DirectQuery tables. While it is not possible to define aggregations for a table imported in memory, that feature might be implemented in the near future. At that point, all these combinations will become possible:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">DirectQuery aggregation over a DirectQuery table</p></li>
<li class="calibre10"><p class="listp">VertiPaq aggregation over a DirectQuery table</p></li>
<li class="calibre10"><p class="listp">VertiPaq aggregation over a VertiPaq table (not available as of April 2019)</p></li>
</ul>
<p class="edition">The ability to create a VertiPaq aggregation over VertiPaq tables will provide a tool to optimize two scenarios for models imported in memory: very large tables (billions of rows) and relationships with a high cardinality (millions of unique values). These two scenarios can be managed by manually modifying the data model and the DAX code as described in the “<a href="#calibre_link-300" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Denormalization</a>” section earlier in this chapter. The aggregations over VertiPaq tables will automate this process, resulting in better performance, reduced maintenance, and decreased development costs.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-313" class="h2a">Conclusions</h3>
<p class="edition">In this chapter we focused on how to optimize a data model imported in memory using the VertiPaq storage engine. The goal is to reduce the memory required for a data model, obtaining as a side effect an improvement in query performance. VertiPaq can also be used to store aggregations in composite models, combining the use of the DirectQuery and VertiPaq storage engines in a single model.</p>
<p class="edition">The main takeaways of this chapter are:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Only import in memory the columns required for the analysis.</p></li>
<li class="calibre10"><p class="listp">Control columns cardinality, as a low cardinality column has better compression.</p></li>
<li class="calibre10"><p class="listp">Manage date and time in separate tables and store them at the proper granularity level for the analysis. Storing a precision higher than required (e.g., milliseconds) consumes memory and lowers query performance.</p></li>
<li class="calibre10"><p class="listp">Consider using VertiPaq to store in-memory aggregations for DirectQuery data sources in composite models.<span type="pagebreak" id="calibre_link-3215"></span></p></li>
</ul>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1435">
<div id="calibre_link-3216" class="calibre2">
<div id="calibre_link-3217" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-24"><span type="pagebreak" id="calibre_link-1861"></span><span class="pd_ash">Chapter 19</span><br class="calibre3" />Analyzing DAX query plans</h2>
<p class="edition">DAX is a functional language with an advanced query engine that can use different storage engines. As is the case with many query languages, it is usually possible to get the same result using different DAX expressions, each one performing differently. Optimizing a measure or a query requires finding the most efficient way to obtain the desired result. In order to find a more efficient implementation for an expression, the first step is to identify the bottlenecks of the existing code.</p>
<p class="edition">This chapter describes the components of the DAX query engine in more detail, explaining how to obtain information about query plans and performance counters related to a particular DAX expression using DAX Studio. This knowledge is fundamental to optimize any DAX formula.</p>
<section class="calibre4">
<h3 id="calibre_link-314" class="h2a">Capturing DAX queries</h3>
<p class="edition">In order to analyze a query plan, it is necessary to execute a DAX query. A report in Power BI or Excel automatically generates queries that invoke measures included in the data model. Thus, optimizing a DAX measure requires analyzing and optimizing the DAX query that invokes that measure. Collecting the queries generated for a report is the first step in the DAX optimization journey. Indeed, a single slow report is likely to generate dozens of queries. The careful developer should find the slowest query out of them all, thus focusing on the biggest bottleneck first.</p>
<p class="edition">DAX Studio (<a href="http://daxstudio.org/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://daxstudio.org/</a>) is a free open-source tool that offers several useful features to capture and analyze DAX queries. In the following example, see how DAX Studio connects to a Power BI data model to capture the queries generated by a report page.</p>
<p class="edition">The Power BI report shown in <a href="#calibre_link-1436" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-1</a> contains one visual that is slower to display. The table in the bottom-left corner with two columns (<em class="calibre5">Product Name</em> and <em class="calibre5">Customers</em>) requires a few seconds to be updated when the page is first opened and when the user changes the <em class="calibre5">Continent</em> slicer selection. We know this because we created the report on purpose. But how would one uncover the slowest visual in a report? DAX studio proves to be very helpful in this.</p>
<figure id="calibre_link-1436" class="image-l">
<img src="images/000227.jpg" alt="The report contains several visuals with different loading times." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2099"></span><strong class="calibre7">Figure 19-1</strong> A Power BI report with many visuals, one of which is slower to display.</figcaption>
</figure>
<p class="edition">DAX Studio can connect to a Power BI model by selecting the name of a Power BI Desktop file already opened on the same computer. This is shown in <a href="#calibre_link-1437" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-2</a>.</p>
<figure id="calibre_link-1437" class="image-l">
<img src="images/000235.jpg" alt="This figure shows the Connect window allowing DAX Studio to connect to a Power BI model." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-2</strong> DAX Studio can connect to multiple types of Tabular models, including Power BI.</figcaption>
</figure>
<p class="edition">Once connected, DAX Studio can start capturing all the queries sent to the Tabular engine after the user activates the All Queries button in the Traces tab of the Home ribbon. This is visible in <a href="#calibre_link-1438" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-3</a>.</p>
<figure id="calibre_link-1438" class="image-l">
<img src="images/000243.jpg" alt="This figure shows the Home ribbon, highlighting the All Queries button." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-3</strong> The All Queries feature captures all the queries sent to the Tabular engine.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1862"></span>At this point, every action in the client might produce one or more queries. For example, Power BI generates at least one DAX query for every visual in the page. <a href="#calibre_link-1439" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-4</a> shows the queries captured in the sample from <a href="#calibre_link-1436" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-1</a> when selecting the Asia continent in the Continent slicer.</p>
<figure id="calibre_link-1439" class="image-l">
<img src="images/000251.jpg" alt="This figure shows the All Queries pane." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-4</strong> The All Queries pane shows all the queries captured by DAX Studio.</figcaption>
</figure>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">DAX Studio listens to all the queries sent to the Tabular server. By connecting DAX Studio to Power BI Desktop, the queries are always executed by the same user on the same database. Different Power BI files require different connections and a different window in DAX Studio. However, a connection to Analysis Services (which requires administrative rights) will show queries executed by different users and on different databases. The query type will be MDX for any queries generated by a client like Excel. The <em class="calibre5">Duration</em> column shows the execution time in milliseconds, and the <em class="calibre5">Query</em> column contains the complete text of the query executed on the server.</p>
</div>
<p class="edition">You can easily check that the first query has a duration of around three seconds. All the remaining queries are very fast, thus not worth any further attention. In a real-world report you likely will notice more than one slow query. DAX Studio lets you quickly discover the slowest queries, focusing the attention on those and avoiding any waste of time on measures and queries that are quick enough.</p>
<p class="edition">When you double-click on a line in the All Queries list, the query is copied into the editor window. For example, <a href="#calibre_link-1440" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-5</a> shows the complete text of the first query in the previous list. When you press the highlighted Format Query button on the Home tab, the query is also formatted using the DAX Formatter web service.</p>
<figure id="calibre_link-1440" class="image-l">
<img src="images/000259.jpg" alt="The figure highlights the presence of DAX Formatter on the Home tab." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1979"></span><strong class="calibre7">Figure 19-5</strong> The Format Query button invokes DAX Formatter to format the DAX code in the editor.</figcaption>
</figure>
<p class="edition">Once a slow query is identified following these steps, it can be executed in DAX Studio multiple times. One would analyze its query plan and other metrics to evaluate the bottlenecks and to try changes that could improve performance. The following sections analyze very simple queries created from scratch for educational reasons, although the end goal is to also analyze queries captured from a real workload.</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-315" class="h2a">Introducing DAX query plans</h3>
<p class="edition">The DAX engine provides several details about how it executes a query in the query plan. However, “query plan” is a generic definition for a set of information including two different types of query plans (logical and physical) and a list of storage engine queries used by the physical query plan. Unless otherwise specified, the generic term “query plan” references the whole set of details available. These are introduced in this section and explained in more detail in the following part of the chapter.</p>
<p class="edition">In <a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 17</a>, “<a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">The DAX engines</a>,” we explained that there are two layers in the DAX query engine: the formula engine (FE) and the storage engine (SE). Every query result is produced by executing the following steps:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp"><strong class="calibre7">Building an Expression Tree.</strong> The engine transforms the query from a string to an expression tree, a data structure that is easier to manipulate for further optimization.</p></li>
<li class="calibre25"><p class="listp"><strong class="calibre7">Building a Logical Query Plan.</strong> The engine produces a list of the logical operations required to execute the query. This tree of logical operators resembles the original query syntax. It is easy to find a correspondence between a DAX function and a similar operation in the logical query plan.</p></li>
<li class="calibre25"><p class="listp"><strong class="calibre7">Building a Physical Query Plan.</strong> The engine transforms the logical query plan into a set of physical operations. A physical query plan is still a tree of operators, but the resulting tree can be different from the logical query plan.</p></li>
<li class="calibre25"><p class="listp"><span type="pagebreak" id="calibre_link-1970"></span><strong class="calibre7">Executing the Physical Query Plan.</strong> The engine finally executes the physical query plan, retrieving data from the SE and computing the query calculations.</p></li>
</ol>
<p class="edition">The first step is not interesting to analyze performance. Steps 2 and 3 involve the formula engine, whereas step 4 also involves the storage engine (SE). Technically, step 3 is the most important for determining how the query works, even though the physical query plan is available only after the actual execution of a query (step 4). Therefore, it is necessary to wait for the execution of a query before being able to see its physical query plan. However, during the execution of step 4, there are other interesting pieces of information (SE requests) that are easier to read compared to the physical query plan. For this reason, we will see how the analysis of a query often starts from the analysis of the SE requests generated at step 4.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Tabular can be queried in both MDX and DAX, even though its natural language is DAX. Nevertheless, the engine does not translate MDX into DAX. MDX queries generate both a logical and a physical query plan just as DAX queries do. Keep in mind that the same query written in DAX or in MDX typically produces different query plans despite returning similar results. Here the focus is on the DAX language; however, the information provided in this chapter is useful to analyze how Tabular handles MDX queries as well.</p>
</div>
<section class="calibre4">
<h4 id="calibre_link-316" class="calibre13">Collecting query plans</h4>
<p class="edition">As explained in the previous section, a DAX query generates both a logical and a physical query plan. These plans describe the operations performed by the query engine in detail. Unfortunately, the query plan is only available in textual representation, not graphical visualization. Because of the complexity and length of a typical query plan, other tools and techniques should be used to optimize a DAX expression before starting to analyze the query plan in detail. However, it is important to understand the basics of a DAX query plan in order to both understand the behavior of the engine and quickly spot potential bottlenecks in longer and more complex query plans. We will now describe in greater detail the different parts of a query plan using a simple query. As you will see, even the simplest query produces rather complex plans.</p>
<p class="edition">As an example, consider this query executed in DAX Studio:</p>
<p class="codelink"><a href="#calibre_link-1441" id="calibre_link-2787" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
{ SUM ( Sales[Quantity] ) }</pre></div>
<p class="edition">The result of the table constructor is a table with one row and one column (<em class="calibre5">Value</em>), filled with the sum of the <em class="calibre5">Quantity</em> column for all the rows of the <em class="calibre5">Sales</em> table, as shown in <a href="#calibre_link-1442" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-6</a>.</p>
<figure id="calibre_link-1442" class="image-l">
<img src="images/000267.jpg" alt="The figure shows the result as one row, one column." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-6</strong> The result of a query with a simple table constructor with one row and one column.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1980"></span>The next sections describe the query plans generated and executed by this DAX query. Later on we will see how to obtain this information for any query. At this stage, just focus your attention on the role of the query plans, how they are structured, and the information they provide.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-317" class="calibre13">Introducing logical query plans</h4>
<p class="edition">The logical query plan is a close representation of the DAX query expression tree. <a href="#calibre_link-1443" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-7</a> shows the logical query plan of the previous query.</p>
<figure id="calibre_link-1443" class="image-l">
<img src="images/000275.jpg" alt="The figure is a screenshot of the logical query plan." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-7</strong> The logical query plan of a simple query.</figcaption>
</figure>
<p class="edition">Each line is an operator, and the following lines, indented, are the parameters of the operator. By ignoring the parameters for each operator for a moment, it is possible to envision a simpler structure:</p>
<p class="codelink"><a href="#calibre_link-1444" id="calibre_link-2788" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AddColumns:
        Sum_Vertipaq:
                 Scan_Vertipaq:
                 'Sales'[Quantity]:</pre></div>
<p class="edition">The outermost operator is <em class="calibre5">AddColumns</em>. It creates the one-row table with the <em class="calibre5">Value</em> column containing the value returned by the DAX query. The <em class="calibre5">Sum_VertiPaq</em> operator scans the <em class="calibre5">Sales</em> table and sums the <em class="calibre5">Sales[Quantity]</em> column. The two operators included within <em class="calibre5">Sum_Vertipaq</em> are <em class="calibre5">Scan_Vertipaq</em> and a reference to the scanned column.</p>
<p class="edition">This query plan in plain English would be: “Create a table with a column named <em class="calibre5">Value</em>, filled with the content of a <em class="calibre5">SUM</em> operation, performed by the storage engine by scanning the <em class="calibre5">Quantity</em> column in the <em class="calibre5">Sales</em> table.”</p>
<p class="edition">The logical query plan shows what the DAX query engine plans to do in order to compute the results. Not surprisingly, it scans <em class="calibre5">Sales</em> summarizing <em class="calibre5">Quantity</em> using <em class="calibre5">SUM</em>. Clearly, more complex query plans will be harder to decode.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-318" class="calibre13">Introducing physical query plans</h4>
<p class="edition">The physical query plan has a similar format to the logical query plan. Each line is an operator and its parameters are in subsequent lines, indented with one tab. Apart from this aesthetic similarity, the two query plans use completely different operators. <a href="#calibre_link-1445" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-8</a> shows the physical query plan generated by the previous DAX query.</p>
<figure id="calibre_link-1445" class="image-l">
<img src="images/000283.jpg" alt="This figure shows a physical query plan." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3218"></span><strong class="calibre7">Figure 19-8</strong> The physical query plan of a simple query.</figcaption>
</figure>
<p class="edition">Again, a simplified version of the query plan is possible by removing the parameters of each operator:</p>
<p class="codelink"><a href="#calibre_link-1446" id="calibre_link-2789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">AddColumns:
         SingletonTable:
         SpoolLookup: LookupPhyOp
                 ProjectionSpool&lt;ProjectFusion&lt;Copy&gt;&gt;: SpoolPhyOp
                          Cache: IterPhyOp</pre></div>
<p class="edition">The first operator, <em class="calibre5">AddColumns</em>, builds the result table. Its first parameter is a <em class="calibre5">SingletonTable</em>, which is an operator returning a single-row table generated by the table constructor. The second parameter, <em class="calibre5">SpoolLookup</em>, searches for a value in the datacache obtained by a query sent to the storage engine. This is the most intricate part of DAX query plans. The physical query plan shows that it uses some data that was previously spooled by other SE queries, but it does not show exactly from which one. In other words, the code of an SE query cannot be obtained by reading the DAX query plan. It is possible to retrieve the queries sent to the storage engine, but matching them with the exact point in the query plan is only possible in simple DAX queries. In more complex&mdash;yet realistic&mdash;DAX operations, this association might require a longer analysis.</p>
<p class="edition">Before moving forward, it is important to highlight some important information included in the query plan:</p>
<p class="codelink"><a href="#calibre_link-1447" id="calibre_link-2790" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">ProjectionSpool&lt;ProjectionFusion&lt;Copy&gt;&gt;: SpoolPhyOp #Records=1
        Cache: IterPhyOp #FieldCols=0 #ValueCols=1</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">In former versions of the Tabular engine that did not support composite models, the <em class="calibre5">ProjectionSpool</em> and <em class="calibre5">Cache</em> operators were called <em class="calibre5">AggregationSpool</em> and <em class="calibre5">VertiPaqResult</em>, respectively. Besides some differences in operator names, the structure of the physical query plan did not change much, and the same logic described in this chapter can be applied to older Tabular engines.</p>
</div>
<p class="edition">The <em class="calibre5">ProjectionSpool</em> operator represents a query sent to the storage engine; the next section will describe storage engine requests. The <em class="calibre5">ProjectionSpool</em> operator iterates the result of the query, showing the total number of rows iterated in the <em class="calibre5">#Records=1</em> parameter. The number of records also represents the number of rows returned by the nested <em class="calibre5">Cache</em> operator.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1983"></span>The number of records is important for two reasons:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">It provides the size (in rows) of the datacache created by VertiPaq or DirectQuery. A large datacache consumes more memory at query time and takes more time to scan.</p></li>
<li class="calibre10"><p class="listp">The iteration performed by <em class="calibre5">ProjectionSpool</em> in the formula engine runs in a single thread. When a query is slow and this number is large, it could indicate a bottleneck in the query execution.</p></li>
</ul>
<p class="edition">Because of the importance of the number of records, DAX Studio reports it in the <em class="calibre5">Records</em> column of the query plan. We sometimes refer to the number of records as the <em class="calibre5">cardinality</em> of the operator.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-319" class="calibre13">Introducing storage engine queries</h4>
<p class="edition">The previous physical query plan includes a <em class="calibre5">ProjectionSpool</em> operator that represents an internal query sent to the storage engine (SE). Because the model is in Import mode, DAX uses the VertiPaq SE, which receives queries in xmSQL. The following is the xmSQL query generated during the execution of the DAX query analyzed in the previous sections:</p>
<p class="codelink"><a href="#calibre_link-1448" id="calibre_link-2791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SET DC_KIND="AUTO";
SELECT
SUM ( 'DaxBook Sales'[Quantity] )
FROM 'DaxBook Sales';

'Estimated size ( volume, marshalling bytes ) : 1, 16'</pre></div>
<p class="edition">The preceding code is a simplified version shown in DAX Studio, which removes a few internal details that are not relevant in performance analysis. The original xmSQL visible in SQL Server Profiler is the following:</p>
<p class="codelink"><a href="#calibre_link-1449" id="calibre_link-2792" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SET DC_KIND="AUTO";
SELECT
SUM([DaxBook Sales (905)].[Quantity (923)]) AS [$Measure0]
FROM [DaxBook Sales (905)];

[Estimated size (volume, marshalling bytes): 1, 16]</pre></div>
<p class="edition">This query aggregates all the rows of the <em class="calibre5">Sales</em> table, returning a single column with the sum of <em class="calibre5">Quantity</em>. The SE executes the entire aggregation operation, returning a small datacache (one row, one column) regardless of the size of the <em class="calibre5">Sales</em> table. The materialization required for this datacache is minimal. Moreover, the only data structures read by this query are those storing the <em class="calibre5">Quantity</em> column in the <em class="calibre5">Sales</em> table. A <em class="calibre5">Sales</em> table with hundreds of other columns would not affect the performance of this xmSQL query. The VertiPaq SE only scans columns included in the xmSQL query. If the model had been using DirectQuery, the query generated would have been a SQL query like the following one:</p>
<div class="program"><pre class="calibre14">SELECT
SUM ( [Quantity] )
FROM Sales</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span type="pagebreak" id="calibre_link-1981"></span><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">From here on out, we will not cover the details of query plans using DirectQuery. As discussed in <a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 17</a>, optimizing DirectQuery requires an optimization of the data source. However, changes to the DAX query can improve the SQL code sent to the DirectQuery data source, so the same techniques for analyzing a query plan described for VertiPaq can also be applied to DirectQuery, even though the assumptions on the speed of the storage engine are no longer valid for DirectQuery.</p>
</div>
<p class="edition">Later in the chapter we will explain why measuring the execution time of each SE query is an important part of the optimization process. Keep in mind that VertiPaq performance is related to the size of the columns involved in a query, and not only to the number of rows of the table. Different columns can have different compression rates and different sizes in memory, resulting in different scan times.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-320" class="h2a">Capturing profiling information</h3>
<p class="edition">The previous section introduced the DAX query plans. This section describes the tools to capture these events and how to measure their duration, which are the first steps in DAX optimization.</p>
<p class="edition">The DAX engine has grown as part of Microsoft SQL Server Analysis Services. Analysis Services provides trace events that can be captured with the SQL Server Profiler tool or by intercepting extended events (xEvents). Other products such as Power Pivot and Power BI use the same engine, although these products do not have the same tools available as for Analysis Services to capture trace or extended events. For example, Power Pivot for Excel and Power BI Desktop have diagnostic options that save trace events on a file, which can be opened later with the same SQL Server Profiler tool.</p>
<p class="edition">However, the events generated by the engine require some massage to be useful for performance analysis; the SQL Server Profiler is a general-purpose tool that is not designed specifically for this task. On the other hand, DAX Studio reads and interprets Analysis Services events, summarizing relevant information in an easier way. This is why we strongly suggest using DAX Studio as a primary tool to edit, test, and optimize DAX queries and expressions. A later section includes a description of SQL Server Profiler, providing more details to the readers interested in understanding the internal details. DAX Studio collects the same events as SQL Server Profiler, processing them and displaying summarized information in a very efficient way.</p>
<section class="calibre4">
<h4 id="calibre_link-321" class="calibre13">Using DAX Studio</h4>
<p class="edition">As explained at the beginning of this chapter, DAX Studio can also capture DAX queries sent to the Tabular engine. Indeed, DAX Studio can execute any valid DAX query, including those captured by DAX Studio itself. The DAX query syntax is explained in <a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 13</a>, “<a href="#calibre_link-18" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Authoring queries</a>.” DAX Studio collects trace events generated by one or more queries executed from within DAX Studio and displays the relevant information about the query plans and storage engine. DAX Studio can connect to Power BI, Analysis Services, and Power Pivot for Excel.</p>
<p class="edition">Before analyzing a query in DAX Studio, we must enable the Query Plan and Server Timings options in the Traces tab of the Home tab, as shown in <a href="#calibre_link-1450" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-9</a>.</p>
<figure id="calibre_link-1450" class="image-l">
<img src="images/000291.jpg" alt="This figure shows the Home tab with the Traces tab." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3219"></span><strong class="calibre7">Figure 19-9</strong> The Query Plan and Server Timings options enable the tracing features in DAX Studio.</figcaption>
</figure>
<p class="edition">When the user enables these options, DAX Studio shows the Query Plan and Server Timings panes next to the Output and Results pane, which is visible by default. DAX Studio connects to the DAX engine as if it were a profiler, and it captures the trace events described in the next section. It automatically only filters the events related to the executed query, so we do not have to worry if there are other concurrent users active on the same server.</p>
<p class="edition">The Query Plan pane displays the two query plans generated by the query, as shown in <a href="#calibre_link-1451" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-10</a>. The physical query plan is in the upper half of the pane, and the logical query plan is in the lower half. The physical query plan is usually the most important to analyze when looking for a performance bottleneck in the formula engine. For this reason, this list also provides a column containing the number of records iterated by a spool operation (which is an iteration performed by the formula engine, usually over a datacache). This way, we can easily recognize which operations iterate over a large number of records in a complex query plan. We will describe how to use this information later in <a href="#calibre_link-25" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 20</a>, “<a href="#calibre_link-25" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing DAX</a>.”</p>
<figure id="calibre_link-1451" class="image-l">
<img src="images/000300.jpg" alt="This figure shows the Query Plan pane." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-10</strong> The Query Plan pane displays the Physical Query Plan and the Logical Query Plan.</figcaption>
</figure>
<p class="edition">The Server Timings pane in <a href="#calibre_link-1452" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-11</a> shows information related to SE queries and how the execution time splits between FE and SE.</p>
<figure id="calibre_link-1452" class="image-l">
<img src="images/000308.jpg" alt="The figure shows the Server Timings pane." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-11</strong> The Server Timings pane displays a summary of timings information and the details of the storage engine queries.</figcaption>
</figure>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span type="pagebreak" id="calibre_link-3220"></span><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The SE query displayed in <a href="#calibre_link-1452" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-11</a> is applied to a model with 4 billion rows to show high CPU consumption. The model used for this example is not included in the companion files for the book.</p>
</div>
<p class="edition">The following metrics are found on the left side of the Server Timings pane:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Total:</strong> Elapsed time for the complete DAX query. It corresponds to the Duration of the <em class="calibre5">Query End</em> event.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">SE CPU:</strong> Sum of the CPU Time value for all the VertiPaq scan events. It also reports the degree of parallelism of VertiPaq operations (number of cores used in parallel).</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">FE:</strong> Time elapsed in the formula engine, in milliseconds and as a percentage of the Total time.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">SE:</strong> Time elapsed in the storage engine, in milliseconds and as a percentage of the Total time.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">SE Queries:</strong> Number of queries sent to the storage engine.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">SE Cache:</strong> Number of storage engine queries resolved by the storage engine cache, displayed as an absolute number and as a percentage of the SE Queries value.</p></li>
</ul>
<p class="edition">The list in the center shows the SE queries executed, and the panel on the right side displays the complete code of the SE query selected in the center list. By default, the list includes only one row for each query, hiding the <em class="calibre5">VertiPaq Scan Internal</em> and other cache events that are always visible in SQL Server Profiler. We can show/hide these more detailed events by enabling the Cache, Internal, and Batch buttons of the Server Timings group on the Home tab from <a href="#calibre_link-1450" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-9</a>. However, these events are usually not necessary in the performance analysis and are thus hidden by default.</p>
<p class="edition">A DAX performance analysis usually starts from the results displayed in the Server Timings pane. If the query spent more than 50% of the execution time in FE, then we might analyze the query plans first, looking for the most expensive operations in the FE. Otherwise, when most of the execution time is spent in SE, then we will look for the most expensive SE queries in the center list of the Server Timings pane.</p>
<p class="edition">Information provided in the <em class="calibre5">Duration</em> and <em class="calibre5">CPU</em> columns is helpful to identify performance bottlenecks in a query. Both values are in milliseconds. The <em class="calibre5">Duration</em> is the time elapsed between the start and the end of the request made to the SE. The <em class="calibre5">CPU</em> column shows the total amount of time consumed by one core. If the <em class="calibre5">CPU</em> number is larger than <em class="calibre5">Duration</em>, it means that more cores have been used in parallel to complete the operation.</p>
<p class="edition">The parallelism of an operation is obtained by dividing <em class="calibre5">CPU</em> by <em class="calibre5">Duration</em>. When this number is close to the total number of cores in the server, we cannot improve performance by increasing the parallelism. In this example, we used a system with eight cores. Thus, with a parallelism of 7.5, the query has reached the limits of the hardware. A concurrent user would not be able to get optimal performance executing a long-running query and would also slow down other users. In this condition, more cores would improve the speed of the query. In case the parallelism of a query is much smaller than the number of cores available, there would not be any benefit from providing more cores to the Tabular engine. <span type="pagebreak" id="calibre_link-1982"></span>The parallelism is computed only for SE operations because the FE runs in a single thread. Formula engine operations cannot benefit from parallel execution.</p>
<p class="edition">The <em class="calibre5">Rows</em> and <em class="calibre5">KB</em> columns show the estimated number of rows and size of the result (datacache) provided by each SE query. Because every datacache must be consumed by the FE in a single thread, a datacache with a large cardinality might be responsible for a slow FE operation. Moreover, the size of a datacache represents the memory cost required by the materialization of a set of data in an uncompressed format; indeed, the FE only consumes uncompressed data. The SE cost to create a large datacache is usually caused by the need to allocate and write uncompressed data in memory. Therefore, reducing the need for the materialization of a datacache is important to lower the volume of data exchanged between SE and FE, reducing memory pressure and improving both query performance and scalability.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The <em class="calibre5">Rows</em> and <em class="calibre5">KB</em> columns show an estimated value that can sometimes be wrong. The exact number of rows returned by an SE query is available in the physical query plan. It is reported in the <em class="calibre5">Records</em> column of the <em class="calibre5">ProjectionSpool</em> event consuming a <em class="calibre5">Cache</em> element. The exact size of a datacache is not available, but it can be approximated proportionally to the ratio between <em class="calibre5">Records</em> in the query plan and the estimated <em class="calibre5">Rows</em> of the SE query.</p>
</div>
<p class="edition">DAX Studio allows sorting of the queries by any column, making it easy to find the most expensive queries when they are sorted by <em class="calibre5">CPU</em>, <em class="calibre5">Duration</em>, <em class="calibre5">Rows</em>, or <em class="calibre5">KB</em>, depending on the ongoing investigation. DAX Studio makes finding the bottlenecks in a DAX query more productive. It does not optimize DAX by itself, but it simplifies the optimization task. In the remaining part of the book we will use DAX Studio as a reference. However, the same information could also be obtained by using SQL Server Profiler, which would be more expensive.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-322" class="calibre13">Using the SQL Server Profiler</h4>
<p class="edition">The SQL Server Profiler tool is installed as part of the SQL Server Management environment, which can be freely downloaded from <a href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms</a>. SQL Server Profiler can be connected to an Analysis Services instance and collects all the events related to a DAX query execution. SQL Server Profiler can also load a file containing a trace session produced by the same SQL Server Profiler, or by other services such as Power Pivot for Excel and Power BI Desktop. This section explains how to use SQL Server Profiler in case DAX Studio cannot be used for any reason. However, you can skip this section if DAX Studio is available. We provide it as a reference because it can be interesting to understand the underlying behavior of the events involved in performance analysis.</p>
<p class="edition">In order to catch DAX query plans and storage engine queries, it is necessary to configure a new trace session selecting the interesting events for a DAX query. This is shown in <a href="#calibre_link-1453" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-12</a>.</p>
<figure id="calibre_link-1453" class="image-l">
<img src="images/000316.jpg" alt="The figure shows the settings to use." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-2000"></span><strong class="calibre7">Figure 19-12</strong> SQL Server Profiler settings to capture DAX query plans and SE queries.</figcaption>
</figure>
<p class="edition">There are five classes of events required to collect the same information used by DAX Studio:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Query End:</strong> Event fired at the end of a query. One might include the <em class="calibre5">Query Begin</em> event too, but we suggest only catching <em class="calibre5">Query End</em> because it contains the execution time.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">DAX Query Plan:</strong> Event fired after the query engine has computed the query plan. It contains a textual representation of the query plan. This event class includes two different subclasses, <em class="calibre5">Logical Plan</em> and <em class="calibre5">Physical Plan</em>. For each query, the engine generates both classes: one logical query plan and one physical query plan.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">DirectQuery End:</strong> Event fired when the DirectQuery engine answers a query. As with the <em class="calibre5">Query End</em> event, to gather timing information we suggest including the end event of the queries executed by the DirectQuery engine.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">VertiPaq SE Query Cache Match:</strong> Event fired when a VertiPaq query is resolved by looking at the cache data. It is useful in order to see how much of your query performs real computations and how much of it just does cache lookups.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">VertiPaq SE Query End:</strong> Event fired when the VertiPaq engine answers a query. As with the <em class="calibre5">Query End</em> event, to gather timing information, we suggest including the end event of the queries executed by the VertiPaq storage engine.</p></li>
</ul>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span type="pagebreak" id="calibre_link-3221"></span><span class="middle"><img src="images/000350.jpg" alt="Image" class="pcalibre6 calibre20" /></span> Tip</p>
<p class="edition">Once you select the events needed, it is a good idea to organize columns (clicking the Organize Columns button you see in <a href="#calibre_link-1453" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-12</a>), and to save a template of the selections made, so you do not have to repeat the same selection every time you start a new session. You can save a trace template by using the File / Templates / New Template menu in SQL Server Profiler.</p>
</div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">In a production environment, one should filter the events of a single user session. Otherwise, all the events of different queries executed at the same time would be visible, which makes it harder to analyze events related to a single query. By running the Profiler in a development or test environment where there are no other active users, only the events related to the query executed for the performance tests would be visible without any background noise. DAX Studio automatically filters the events related to a single query analyzed, removing any background noise without requiring any further actions.</p>
</div>
<p class="edition">In order to see the sequence of events fired, we analyze what has happened by running the query used to generate the SE query displayed in <a href="#calibre_link-1452" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-11</a> using DAX Studio over a large table (over 4 billion rows):</p>
<p class="codelink"><a href="#calibre_link-1454" id="calibre_link-2793" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ROW ( "Result", SUM ( Audience[Weight] ) )</pre></div>
<p class="edition">The log window of the SQL Server Profiler shows the result, visible in <a href="#calibre_link-1455" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-13</a>.</p>
<figure id="calibre_link-1455" class="image-l">
<img src="images/000324.jpg" alt="The figure shows the log window of SQL Server Profiler." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-13</strong> Trace events captured in a SQL Server Profiler session for a simple DAX query.</figcaption>
</figure>
<p class="edition">Even for such a simple query, the DAX engine fires five different events:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">A <em class="calibre5">DAX VertiPaq Logical Plan</em> event, which is the logical query plan.</p></li>
<li class="calibre25"><p class="listp">An <em class="calibre5">Internal VertiPaq Scan</em> event, which corresponds to an SE query. There could be more than one internal event (subclass 10) for each <em class="calibre5">VertiPaq Scan</em> event (subclass 0).</p></li>
<li class="calibre25"><p class="listp">A <em class="calibre5">VertiPaq Scan</em> event, which describes a single SE query received by the FE.</p></li>
<li class="calibre25"><p class="listp">A DAX <em class="calibre5">VertiPaq Physical Plan</em> event, which is the physical query plan.</p></li>
<li class="calibre25"><p class="listp">A final <em class="calibre5">Query End</em> event, which returns the query duration of the complete DAX query. The CPU time reported by this event should be ignored. It should be close to the time spent in the FE but is not as accurate as the calculation explained later.</p></li>
</ol>
<p class="edition"><span type="pagebreak" id="calibre_link-1984"></span>All the events show both CPU time and duration, expressed in milliseconds. <em class="calibre5">CPU Time</em> is the amount of CPU time consumed to answer the query, whereas <em class="calibre5">Duration</em> is the time the user has had to wait for their result. When <em class="calibre5">Duration</em> is lower than <em class="calibre5">CPU Time</em>, the operation has been executed in parallel on many cores. When <em class="calibre5">Duration</em> is greater than <em class="calibre5">CPU Time</em>, the operation had to wait for other operations (usually logged in different events) to be completed.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The accuracy of the <em class="calibre5">CPU Time</em> and <em class="calibre5">Duration</em> columns is not very reliable for values lower than 16 milliseconds, and <em class="calibre5">CPU Time</em> can be less accurate than that in conditions of high parallelism. Moreover, these timings might depend on other operations in progress on the same server. It is a common practice to run the same test multiple times in order to create an average of the execution time of single operations, especially when one needs accurate numbers. However, if only looking for an order of magnitude, one might just ignore differences under 100 milliseconds.</p>
</div>
<p class="edition">Considering the sequence of events, the logical query plan precedes all the SE queries (VertiPaq scans), and only after their execution is the physical query plan raised. In other words, the physical query plan is an actual query plan and not an estimated one. Indeed, it contains the number of rows processed by any iteration in the FE, though it does not provide information about the CPU time and duration of each step in the query plan.</p>
<p class="edition">Logical and physical query plans do not provide any timing information, which are only available in the other events gathered by the Profiler. Information provided in the <em class="calibre5">CPU Time</em> and <em class="calibre5">Duration</em> columns is the same shown in <em class="calibre5">CPU</em> and <em class="calibre5">Duration</em> by DAX Studio for SE queries. However, the calculation of the time spent in the FE displayed in DAX Studio requires some more work using SQL Server Profiler.</p>
<p class="edition">The <em class="calibre5">Query End</em> event only provides the total elapsed time for a DAX query in the <em class="calibre5">Duration</em> column, summing both the FE and SE durations. The <em class="calibre5">VertiPaq</em> scan events provide the time spent in the SE. The elapsed time in FE is obtained by subtracting the duration of all the SE queries from the duration of the entire DAX query provided in the <em class="calibre5">Query End</em> event.</p>
<p class="edition">As shown in <a href="#calibre_link-1455" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-13</a>, the <em class="calibre5">Query End</em> event had a <em class="calibre5">Duration</em> of 844 milliseconds. The time spent in the SE was 838 milliseconds. There was only one SE query, which lasted 838 milliseconds; only consider the VertiPaq <em class="calibre5">Scan</em> event, ignoring internal ones. The difference is 6 milliseconds, which is the amount of time spent in the FE. In case of multiple SE queries, their execution time must be aggregated to calculate the total amount of time spent in the SE, which must be subtracted from the total duration to get the amount of time spent in the FE.</p>
<p class="edition">Finally, the SQL Server Profiler can save and load a trace session. SQL Server Profiler cannot connect to Power Pivot for Excel, but it can open a trace file saved by Power Pivot for Excel or Power BI Desktop. However, Power Pivot for Excel has an Enable Power Pivot Tracing check box in the Settings dialog box that generates a TRC file; TRC is the extension for trace file. The events captured in the profiler session saved this way cannot be customized; they also usually include more event types than those required to analyze DAX query plans. DAX Studio cannot load a trace session but can connect directly to all the tools including Power Pivot for Excel without any limitation.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-323" class="h2a"><span type="pagebreak" id="calibre_link-2102"></span>Reading VertiPaq storage engine queries</h3>
<p class="edition">In the previous sections, we described some details of the physical and logical query plans. Although these plans are useful in some scenarios, the most interesting part of a query plan is the set of VertiPaq SE queries.</p>
<p class="edition">In this section we describe how to read the VertiPaq SE queries and understand what happens in VertiPaq to execute an xmSQL query. This information is useful to solve a bottleneck in the VertiPaq storage engine. However, reading these queries is useful to also understand what happens in the FE: If a calculation is not performed by the SE, it must be computed in the FE. Because the number of SE queries is usually smaller than the rows in the query plan, it is more productive to always start analyzing the SE queries regardless of the detected bottleneck type.</p>
<section class="calibre4">
<h4 id="calibre_link-324" class="calibre13">Introducing xmSQL syntax</h4>
<p class="edition">In the previous section, we introduced a simple SE query described in a simplified xmSQL syntax, which is the same as displayed by DAX Studio:</p>
<div class="program"><pre class="calibre14">SELECT
SUM ( Sales[Quantity] )
FROM Sales;</pre></div>
<p class="edition">This syntax would be quite similar in standard ANSI SQL:</p>
<div class="program"><pre class="calibre14">SELECT
SUM ( Quantity )
FROM Sales;</pre></div>
<p class="edition">Every xmSQL query involves a <em class="calibre5">GROUP BY</em> condition, even if this is not explicitly stated as part of its syntax. For example, the following DAX query returns the list of unique values of the <em class="calibre5">Color</em> column in the <em class="calibre5">Product</em> table:</p>
<p class="codelink"><a href="#calibre_link-1456" id="calibre_link-2794" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE VALUES ( 'Product'[Color] )</pre></div>
<p class="edition">It results in this xmSQL query; note that no <em class="calibre5">GROUP BY</em> appears in the query:</p>
<div class="program"><pre class="calibre14">SELECT Product[Color]
FROM Product;</pre></div>
<p class="edition">The corresponding query in ANSI SQL would have a <em class="calibre5">GROUP BY</em> condition:</p>
<div class="program"><pre class="calibre14">SELECT Color
FROM Product
GROUP BY Color</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1659"></span>The reason we compare the xmSQL to an ANSI SQL query with <em class="calibre5">GROUP BY</em> instead of <em class="calibre5">DISTINCT</em>&mdash;which would be possible for the previous example&mdash;is that most of the time xmSQL queries also include aggregated calculations. For example, consider the following DAX query:</p>
<p class="codelink"><a href="#calibre_link-1457" id="calibre_link-2795" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    Sales[Order Date],
    "Revenues", CALCULATE ( SUM ( Sales[Quantity] ) )
)</pre></div>
<p class="edition">This is the corresponding xmSQL query sent to the SE:</p>
<p class="codelink"><a href="#calibre_link-1458" id="calibre_link-2796" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT Sales[Order Date], SUM ( Sales[Quantity] )
FROM Sales;</pre></div>
<p class="edition">In ANSI SQL there would be a <em class="calibre5">GROUP BY</em> condition for the <em class="calibre5">Order Date</em> column:</p>
<p class="codelink"><a href="#calibre_link-1459" id="calibre_link-2797" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT [Order Date], SUM ( Quantity )
FROM Sales
GROUP BY [Order Date]</pre></div>
<p class="edition">An xmSQL query never returns duplicated rows. When a DAX query runs over a table that does not have a unique key, the corresponding xmSQL query includes a special <em class="calibre5">RowNumber</em> column that keeps the rows unique. However, the <em class="calibre5">RowNumber</em> column is not accessible in DAX. For example, consider this DAX query:</p>
<div class="program"><pre class="calibre14">EVALUATE Sales</pre></div>
<p class="edition">It generates the following xmSQL code:</p>
<p class="codelink"><a href="#calibre_link-1460" id="calibre_link-2798" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT Sales[RowNumber], Sales[column1], Sales[column2], ... ,Sales[columnN]
FROM Sales</pre></div>
<section class="calibre4">
<h5 id="calibre_link-3222" class="calibre13">Aggregation functions</h5>
<p class="edition">xmSQL includes the following aggregation operations:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><em class="calibre5">SUM</em> sums the values of a column.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">MIN</em> returns the minimum value of a column.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">MAX</em> returns the maximum value of a column.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">COUNT</em> counts the number of rows in the current <em class="calibre5">GROUP BY</em>.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">DCOUNT</em> counts the number of distinct values of a column.</p></li>
</ul>
<p class="edition"><span type="pagebreak" id="calibre_link-3223"></span>The behavior of <em class="calibre5">SUM</em>, <em class="calibre5">MIN</em>, <em class="calibre5">MAX</em>, and <em class="calibre5">DCOUNT</em> is similar. For example, the following DAX query returns the number of unique customers for each order date:</p>
<p class="codelink"><a href="#calibre_link-1461" id="calibre_link-2799" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    Sales[Order Date],
    "Customers",  DISTINCTCOUNT ( Sales[CustomerKey] )
)</pre></div>
<p class="edition">It generates the following xmSQL code:</p>
<p class="codelink"><a href="#calibre_link-1462" id="calibre_link-2800" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT Sales[Order Date], DCOUNT ( Sales[CustomerKey] )
FROM Sales;</pre></div>
<p class="edition">Which corresponds to this ANSI SQL query:</p>
<p class="codelink"><a href="#calibre_link-1463" id="calibre_link-2801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT [Order Date], COUNT ( DISTINCT CustomerKey )
FROM Sales
GROUP BY [Order Date]</pre></div>
<p class="edition">The <em class="calibre5">COUNT</em> function does not have an argument. Indeed, it computes the number of rows for the current group. For example, consider the following DAX query that counts the number of products for each color:</p>
<p class="codelink"><a href="#calibre_link-1464" id="calibre_link-2802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    'Product'[Color],
    "Products", COUNTROWS ( 'Product' )
)</pre></div>
<p class="edition">This is the xmSQL code sent to the SE:</p>
<p class="codelink"><a href="#calibre_link-1465" id="calibre_link-2803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT Product[Color], COUNT ( )
FROM Product;</pre></div>
<p class="edition">A corresponding ANSI SQL query could be the following:</p>
<div class="program"><pre class="calibre14">SELECT Color, COUNT ( * )
FROM Product
GROUP BY Color</pre></div>
<p class="edition">Other aggregation functions in DAX do not have a corresponding xmSQL aggregation function. For example, consider the following DAX query using <em class="calibre5">AVERAGE</em>:</p>
<p class="codelink"><a href="#calibre_link-1466" id="calibre_link-2804" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    'Product'[Color],
    "Average Unit Price", AVERAGE ( 'Product'[Unit Price] )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1660"></span>The corresponding xmSQL code includes two aggregations: one for the numerator and one for the denominator of the division that will compute a simple average in the FE:</p>
<p class="codelink"><a href="#calibre_link-1467" id="calibre_link-2805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT Product[Color], SUM ( Product[Unit Price] ), COUNT ( )
FROM Product
WHERE Product[Unit Price] IS NOT NULL;</pre></div>
<p class="edition">Converting the xmSQL query in ANSI SQL, we would write:</p>
<p class="codelink"><a href="#calibre_link-1468" id="calibre_link-2806" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT Color, SUM ( [Unit Price] ), COUNT ( * )
FROM Product
WHERE Product[Unit Price] IS NOT NULL
GROUP BY Color</pre></div>
</section>
<section class="calibre4">
<h5 id="calibre_link-3224" class="calibre13">Arithmetical operations</h5>
<p class="edition">xmSQL includes simple arithmetical operations: +, −, *, / (sum, subtraction, multiplication, division). These operations work on single rows, whereas the FE usually performs arithmetical operations between the results of aggregations. It is common to see arithmetical operations in the expression used by an aggregation function. For example, the following DAX query returns the sum of the product of <em class="calibre5">Quantity</em> by <em class="calibre5">Unit Price</em> calculated row-by-row for the <em class="calibre5">Sales</em> table:</p>
<p class="codelink"><a href="#calibre_link-1469" id="calibre_link-2807" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
{ SUMX ( Sales, Sales[Quantity] * Sales[Unit Price] ) }</pre></div>
<p class="edition">It generates the following xmSQL code:</p>
<p class="codelink"><a href="#calibre_link-1470" id="calibre_link-2808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := ( Sales[Quantity] * Sales[Unit Price] )
SELECT
SUM ( @$Expr0 )
FROM Sales;</pre></div>
<p class="edition">The <em class="calibre5">WITH</em> statement introduces expressions associated with symbolic names (starting with the <em class="calibre5">$Expr</em> prefix) that are referenced later in the remaining part of the query. For example, in the previous code the <em class="calibre5">$Expr0</em> expression corresponds to the multiplication between <em class="calibre5">Quantity</em> and <em class="calibre5">Unit Price</em> that is later evaluated for each row of the <em class="calibre5">Sales</em> table, summing the result in the aggregated value.</p>
<p class="edition">The previous xmSQL code corresponds to this ANSI SQL query:</p>
<p class="codelink"><a href="#calibre_link-1471" id="calibre_link-2809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT SUM ( [Quantity] * [Unit Price] )
FROM Sales</pre></div>
<p class="edition">xmSQL can also execute casts between data types to perform arithmetical operations. It is important to remember that these operations only happen within a row context, from the point of view of a DAX expression.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-3225" class="calibre13"><span type="pagebreak" id="calibre_link-2048"></span>Filter operations</h5>
<p class="edition">An xmSQL query can include filters in a <em class="calibre5">WHERE</em> condition. The performance of a filter depends on the cardinality of the conditions applied (this will be discussed in more detail later in the section “<a href="#calibre_link-325" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding scan time</a>”).</p>
<p class="edition">For example, consider the following query that returns the sum of the <em class="calibre5">Quantity</em> column for all sales with a unit price equal to 42:</p>
<p class="codelink"><a href="#calibre_link-1472" id="calibre_link-2810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
CALCULATETABLE (
    ROW ( "Result", SUM ( Sales[Quantity] ) ),
    Sales[Unit Price] = 42
)</pre></div>
<p class="edition">The resulting xmSQL query is the following:</p>
<p class="codelink"><a href="#calibre_link-1473" id="calibre_link-2811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT SUM ( Sales[Quantity] )
FROM Sales
WHERE Sales[Unit Price] = 420000;</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The reason why the value in the <em class="calibre5">WHERE</em> condition is multiplied by 10,000 is because the <em class="calibre5">Unit Price</em> column is stored as a <em class="calibre5">Currency</em> data type (also known as <em class="calibre5">Fixed Decimal Number</em> in Power BI). That number is stored as an <em class="calibre5">Integer</em> in VertiPaq, so the FE performs the conversion to a decimal number by dividing the result by 10,000. Such division is not visible, neither in the query plan nor in the xmSQL code.</p>
</div>
<p class="edition">The <em class="calibre5">WHERE</em> condition might include a test with more than one value. For example, consider a small variation of the previous query that sums either the quantity or the sales with a unit price equal to 16 or 42. You see this in the following DAX query:</p>
<p class="codelink"><a href="#calibre_link-1474" id="calibre_link-2812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
CALCULATETABLE (
    ROW ( "Result", SUM ( Sales[Quantity] ) ),
    OR ( Sales[Unit Price] = 16, Sales[Unit Price] = 42 )
)</pre></div>
<p class="edition">The xmSQL uses the <em class="calibre5">IN</em> operator to include a list of values:</p>
<p class="codelink"><a href="#calibre_link-1475" id="calibre_link-2813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT SUM ( Sales[Quantity] )
FROM Sales
WHERE Sales[Unit Price] IN ( 16000, 42000 );</pre></div>
<p class="edition">Any filter condition in xmSQL only includes existing values of the column. For example, if a DAX condition references a value that does not exist in the column, the resulting xmSQL code will include a <span type="pagebreak" id="calibre_link-3226"></span>condition that will filter out all the rows. For example, if neither 16 nor 42 existed in the <em class="calibre5">Sales</em> table, the previous xmSQL query could be not invoked at all from the FE or would become something like:</p>
<p class="codelink"><a href="#calibre_link-1476" id="calibre_link-2814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT SUM ( Sales[Quantity] )
FROM Sales
WHERE Sales[Unit Price] IN ( );</pre></div>
<p class="edition">The result of such an xmSQL query will always be empty.</p>
<p class="edition">It is important to remember that xmSQL is a textual representation of an SE query. The actual structure is more optimized. For example, when the list of values allowed for a column is very long, the xmSQL reports a few values, highlighting the total number of values passed internally to the query. This happens quite often for time intelligence functions. For example, consider the following DAX query that returns the sum of the quantity for one year of sales:</p>
<p class="codelink"><a href="#calibre_link-1477" id="calibre_link-2815" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
CALCULATETABLE (
    ROW ( "Result", SUM ( Sales[Quantity] ) ),
    Sales[Order Date] &gt;= DATE ( 2006, 1, 1 ) &amp;&amp; Sales[Order Date] &lt;= DATE ( 2006, 12, 31 )
)</pre></div>
<p class="edition">Using a recent version of the DAX engine, it generates the following xmSQL query:</p>
<p class="codelink"><a href="#calibre_link-1478" id="calibre_link-2816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT SUM ( Sales[Quantity] )
FROM Sales
WHERE Sales[Order Date] &gt;= 38718.000000
  VAND Sales[Order Date] &lt;= 39082.000000</pre></div>
<p class="edition">DAX represents date and time values as floating-point numbers. For this reason, the comparison of the <em class="calibre5">Order Date</em> column happens with two numbers corresponding to the two dates used in the filter argument of the DAX expression.</p>
<p class="edition">However, older versions of the DAX engine might produce the following xmSQL query instead:</p>
<p class="codelink"><a href="#calibre_link-1479" id="calibre_link-2817" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT SUM ( Sales[Quantity] )
FROM Sales
WHERE Sales[Order Date] IN ( 38732.000000, 38883.000000, 38846.000000, 38997.000000,
38809.000000, 38960.000000, 38789.000000, 38923.000000, 39074.000000, 38752.000000..[365
total values, not all displayed] ) ;</pre></div>
<p class="edition">In this case, instead of a range condition, the xmSQL query has a bitmap index that identifies all the values included in the filter. The <em class="calibre5">WHERE</em> / <em class="calibre5">IN</em> condition represents such a bitmap index, only reporting in the xmSQL code a sample of the values followed by the total number of values in the column. In order to obtain the list of values for a range, another xmSQL query might be executed before:</p>
<p class="codelink"><a href="#calibre_link-1480" id="calibre_link-2818" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT Sales[Order Date]
FROM Sales
WHERE Sales[Order Date] &gt;= 38718.000000
    VAND Sales[Order Date] &lt;= 39082.000000</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1748"></span>The actual xmSQL query generated in this last example might be more complex, including a callback to the FE to transform the result of the <em class="calibre5">DATE</em> function into the corresponding floating-point value. More information about these callbacks is included in the section “<a href="#calibre_link-329" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding <em class="calibre5">CallbackDataID</em></a>” later in this chapter.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-3227" class="calibre13">Join operators</h5>
<p class="edition">The xmSQL code can execute <em class="calibre5">JOIN</em> conditions when a DAX query involves multiple tables connected by relationships in the data model. For example, consider the following DAX query returning the sum of the <em class="calibre5">Quantity</em> column in the <em class="calibre5">Sales</em> table for each <em class="calibre5">Color</em> name in the <em class="calibre5">Product</em> table:</p>
<p class="codelink"><a href="#calibre_link-1481" id="calibre_link-2819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    'Product'[Color],
    "Sales",  SUM ( Sales[Quantity] )
)</pre></div>
<p class="edition">If there is a one-to-many relationship between the <em class="calibre5">Product</em> and <em class="calibre5">Sales</em> tables in the data model, the corresponding xmSQL code includes a <em class="calibre5">LEFT OUTER JOIN</em> between the two tables, as shown in the following SE query:</p>
<p class="codelink"><a href="#calibre_link-1482" id="calibre_link-2820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT Product[Color], SUM ( Sales[Quantity] )
FROM Sales
    LEFT OUTER JOIN Product ON Sales[ProductKey] = Product[ProductKey];</pre></div>
<p class="edition">The <em class="calibre5">ON</em> condition of the <em class="calibre5">JOIN</em> automatically includes the columns that define the relationship in the data model. For each relationship involved in the query, there is one join in xmSQL.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-3228" class="calibre13">Temporary tables and shallow relationships in batch events</h5>
<p class="edition">VertiPaq can execute xmSQL queries whose result is kept in memory for another xmSQL query without being consumed by the FE. This improves the query performance because this temporary result is not materialized for the SE. If the temporary table is used in a different xmSQL operation, there should be a <em class="calibre5">Batch</em> operation in the VertiPaq storage engine grouping the different SE queries executed. For example, consider the following DAX query computing the average yearly income of customers that made at least one purchase in the corresponding year:</p>
<p class="codelink"><a href="#calibre_link-1483" id="calibre_link-2821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
CALCULATETABLE (
    SUMMARIZECOLUMNS (
        'Date'[Calendar Year],
        "Yearly Income", AVERAGE ( Customer[Yearly Income] )
    ),
    CROSSFILTER ( Sales[CustomerKey], Customer[CustomerKey], BOTH )
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3229"></span>The presence of the bidirectional filter between the <em class="calibre5">Sales</em> and <em class="calibre5">Customer</em> tables activates a special behavior of the SE, which generates a query executed in different steps of a <em class="calibre5">Batch</em> statement. In DAX Studio, the <em class="calibre5">Batch</em> event is hidden by default, but it can be activated to see the <em class="calibre5">Batch</em> event after one or more <em class="calibre5">Scan</em> events. This is shown in <a href="#calibre_link-1484" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-14</a>.</p>
<figure id="calibre_link-1484" class="image-l">
<img src="images/000332.jpg" alt="The figure shows SE events." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-14</strong> SE events captured in DAX Studio enabling the Batch filter in Server Timings.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">Batch</em> reported at line 7 includes all the <em class="calibre5">Scan</em> events reported in lines 2, 4, and 6. The SE query of each <em class="calibre5">Scan</em> event is separated by a comma, but the <em class="calibre5">Batch</em> event could have additional statements like the one highlighted in the complete code of the <em class="calibre5">Batch</em> event that follows. The <em class="calibre5">CREATE SHALLOW RELATION</em> statement implements the behavior of the bidirectional filter at the SE level, optimizing the execution of a DAX query involving one or more bidirectional filters:</p>
<p class="codelink"><a href="#calibre_link-1485" id="calibre_link-2822" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">--
-- This query is also the first Scan event processed
--
DEFINE TABLE '$TTable3' :=
SELECT
    Customer[CustomerKey], Date[Calendar Year]
FROM Sales
    LEFT OUTER JOIN Customer
        ON Sales[CustomerKey]=Customer[CustomerKey]
    LEFT OUTER JOIN Date
        ON Sales[OrderDateKey]=Date[DateKey],

--
-- This directive does not generate any Scan event
--
<strong class="calibre7">CREATE SHALLOW RELATION '$TRelation1' MANYTOMANY</strong>
    <strong class="calibre7">FROM Customer[CustomerKey] TO '$TTable3'[Customer$CustomerKey],</strong>

--
-- This query is the second Scan event processed
--
DEFINE TABLE '$TTable4' :=
SELECT
    SIMPLEINDEXN ( '$TTable3'[Customer$CustomerKey] )
FROM '$TTable3',

--
-- This query is the third and last Scan event processed for this batch
--
DEFINE TABLE '$TTable1' :=
<span type="pagebreak" id="calibre_link-1749"></span>SELECT
    '$TTable3'[Date$Calendar Year],
    SUM ( '$TTable2'[$Measure0] ), SUM ( '$TTable2'[$Measure1] )
FROM '$TTable2'
    INNER JOIN '$TTable3'
        ON '$TTable2'[Customer$CustomerKey]='$TTable3'[Customer$CustomerKey]

REDUCED BY

'$TTable2' :=
SELECT
    Customer[CustomerKey],
    SUM ( Customer[Yearly Income] ),
    SUM (  ( PFDATAID ( Customer[Yearly Income] ) &lt;&gt; 2 )  )
FROM Customer
WHERE
Customer[CustomerKey] ININDEX '$TTable4'[$Index1];</pre></div>
<p class="edition">Only the last <em class="calibre5">DEFINE TABLE</em> statement in a batch generates a result returned to the FE, corresponding to the <em class="calibre5">$TTable2</em> query. All the previous <em class="calibre5">DEFINE TABLE</em> statements generate temporary tables used later within the same batch. It is worth noting that the last query starts from <em class="calibre5">DEFINE TABLE $TTable1</em> and ends at the end of the batch, including the <em class="calibre5">REDUCED BY</em> clause. <em class="calibre5">REDUCED BY</em> is a syntax defining a subquery within the same SE request rather than requiring a separate SE query executed within the same batch, like <em class="calibre5">$TTable3</em> and <em class="calibre5">$TTable4</em> in this batch. The result of a temporary table defined within <em class="calibre5">DEFINE TABLE</em> before the last one in the batch could contain binary information that is never returned as a DAX result. For example, the <em class="calibre5">SIMPLEINDEXN</em> function generates an index structure, so that a following query can use that index to apply a filter to a column through the <em class="calibre5">ININDEX</em> operator. These temporary tables are not returned to the FE; they are only kept in the SE with an efficient structure used only to improve the internal evaluation of other SE queries.</p>
</section>
</section>
<section class="calibre4">
<h4 id="calibre_link-325" class="calibre13">Understanding scan time</h4>
<p class="edition">After having described the syntax of xmSQL queries, it is time to consider the work performed by the storage engine to execute such statements.</p>
<p class="edition">VertiPaq performs a complete scan of each column involved in an SE query. There could be more iterations for a column, depending on the request. Because there are no indexes, the time required to complete a scan depends on the memory footprint of the column, which depends on the number of unique values in the column, on their distribution across the rows, and on the number of rows in the table. The importance of these factors depends on the aggregation function used in the xmSQL query. For example, consider a large table with four columns: <em class="calibre5">Date</em>, <em class="calibre5">Time</em>, <em class="calibre5">Age</em>, and <em class="calibre5">Score</em>. The table has 4 billion rows, so that we can observe relevant differences in execution time. We executed the following DAX queries for each column:</p>
<p class="codelink"><a href="#calibre_link-1486" id="calibre_link-2823" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-3230"></span>EVALUATE
ROW ( "Sum", SUM ( Example[&lt;column name&gt;] ) )

EVALUATE
ROW (
    "Distinct Count",
    CALCULATE (
        DISTINCTCOUNT ( Example[&lt;column name&gt;] ),
        NOT ISBLANK ( Example[&lt;column name&gt;] )
    )
)</pre></div>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The second query includes a <em class="calibre5">NOT ISBLANK</em> condition that is required to obtain an SE query to execute the query. If the query did not have a filter, the number of distinct values in a column would have been retrieved from the metadata of the model, without actually executing any SE request.</p>
</div>
<p class="edition">We are not interested in the values returned by these queries. We are only interested in the time spent in the SE, which for these simple queries is always close to the entire execution time of the DAX queries. <a href="#calibre_link-1487" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 19-1</a> shows the results where we reported, for each column:</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Memory (MB):</strong> The memory footprint of the column for the entire table (4 billion rows).</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Distinct Values:</strong> The number of unique values in the column, obtained by executing the <em class="calibre5">DISTINCTCOUNT</em> aggregation function in DAX.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">SUM (ms):</strong> The execution time of the query that applies the <em class="calibre5">SUM</em> aggregation to the column.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">DISTINCTCOUNT (ms):</strong> The execution time of the query that applies the <em class="calibre5">DISTINCTCOUNT</em> aggregation to the column.</p></li>
</ul>
<p class="edition" id="calibre_link-1487"><strong class="calibre7">Table 19-1</strong> Column size, cardinality, and execution time of aggregation functions</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Column</p></th>
<th class="th"><p class="tab-text">Memory (MB)</p></th>
<th class="th"><p class="tab-text">Distinct Values</p></th>
<th class="th"><p class="tab-text">SUM (ms)</p></th>
<th class="th"><p class="tab-text">DISTINCTCOUNT (ms)</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">Date</p></td>
<td class="th1"><p class="tab-text">0.03</p></td>
<td class="th1"><p class="tab-text">1,588</p></td>
<td class="th1"><p class="tab-text">9</p></td>
<td class="th1"><p class="tab-text">20</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Age</p></td>
<td class="th1"><p class="tab-text">165.26</p></td>
<td class="th1"><p class="tab-text">96</p></td>
<td class="th1"><p class="tab-text">146</p></td>
<td class="th1"><p class="tab-text">333</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">Score</p></td>
<td class="th1"><p class="tab-text">2,648.40</p></td>
<td class="th1"><p class="tab-text">9,766,664</p></td>
<td class="th1"><p class="tab-text">837</p></td>
<td class="th1"><p class="tab-text"><strong class="calibre7">4,288</strong></p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">Time</p></td>
<td class="th1"><p class="tab-text">6,493.57</p></td>
<td class="th1"><p class="tab-text">1,439</p></td>
<td class="th1"><p class="tab-text"><strong class="calibre7">1,330</strong></p></td>
<td class="th1"><p class="tab-text">4,102</p></td>
</tr>
</tbody>
</table>
<p class="edition">At first sight, a few results might appear counterintuitive. Usually, the larger the number of unique values in a column, the slower the query. In this case, <em class="calibre5">Date</em> is faster than <em class="calibre5">Age</em>, which has a smaller number of unique values. Moreover, the <em class="calibre5">Time</em> column, which has a cardinality similar to <em class="calibre5">Date</em>, has a difference in performance of at least one order of magnitude compared to <em class="calibre5">Date</em>. The reasons for these differences are the different compression rates, derived by different sort orders of the columns.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1977"></span>The <em class="calibre5">Date</em> column always has the faster execution time. This is because the 4 billion rows have been processed as reading rows sorted by date. Even without partitioning, this created segments with one or two unique values each. Thus, all the rows in each segment had a very high compression rate, as is made clear by the memory used by the <em class="calibre5">Date</em> column.</p>
<p class="edition">The <em class="calibre5">Age</em> column has the second-best performance for both <em class="calibre5">SUM</em> and <em class="calibre5">DISTINCTCOUNT</em>. This column has a larger memory footprint than <em class="calibre5">Date</em> because there are different <em class="calibre5">Age</em> values for each <em class="calibre5">Date</em>, and rows are sorted by <em class="calibre5">Date</em> first.</p>
<p class="edition">The <em class="calibre5">Score</em> and <em class="calibre5">Time</em> columns have a slower performance. The performance of <em class="calibre5">SUM</em> depends mainly on the memory footprint, whereas <em class="calibre5">DISTINCTCOUNT</em> is also sensitive to the number of distinct values in the column. The reason for that is the different calculation algorithm used for these two aggregations.</p>
<p class="edition">The important concept here is that we can obtain a different performance for an SE query depending on the memory footprint of a column. We can optimize a VertiPaq SE query by reducing the memory footprint of the columns used. We can obtain that by using columns with a smaller number of unique values, or with a different sort order of the data source, or by reducing the number of rows in the table, or by applying other techniques that we will describe in the remaining part of this book.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-326" class="calibre13">Understanding <em class="calibre5">DISTINCTCOUNT</em> internals</h4>
<p class="edition">The use of the <em class="calibre5">DISTINCTCOUNT</em> function in a DAX expression generates multiple <em class="calibre5">VertiPaq Scan Internal</em> events for a single <em class="calibre5">VertiPaq Scan</em> event. We can see internal events by enabling the Internal button in the Server Timings group of DAX Studio.</p>
<p class="edition">Consider the following DAX query:</p>
<p class="codelink"><a href="#calibre_link-1488" id="calibre_link-2824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ROW (
    "Distinct Count",
    CALCULATE (
        DISTINCTCOUNT ( Example[Score] ),
        Example[Score] &lt;&gt; 0
    )
)</pre></div>
<p class="edition"><a href="#calibre_link-1489" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 19-2</a> shows the complete list of <em class="calibre5">VertiPaq Scan</em> events generated by the preceding query.</p>
<p class="edition" id="calibre_link-1489"><strong class="calibre7">Table 19-2</strong> <em class="calibre5">VertiPaq Scan</em> events for a DAX query with a <em class="calibre5">DISTINCTCOUNT</em> measure</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Line</p></th>
<th class="th"><p class="tab-text">Subclass</p></th>
<th class="th"><p class="tab-text">Duration</p></th>
<th class="th"><p class="tab-text">CPU</p></th>
<th class="th"><p class="tab-text">Query</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">Internal</p></td>
<td class="th1"><p class="tab-text">4,269</p></td>
<td class="th1"><p class="tab-text">31,641</p></td>
<td class="th1"><p class="tab-text">SELECT Example[Score] FROM Example;</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2</p></td>
<td class="th1"><p class="tab-text">Internal</p></td>
<td class="th1"><p class="tab-text">4,269</p></td>
<td class="th1"><p class="tab-text">31,641</p></td>
<td class="th1"><p class="tab-text">SELECT Example[Score] FROM Example;</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">3</p></td>
<td class="th1"><p class="tab-text">Internal</p></td>
<td class="th1"><p class="tab-text">&nbsp;&nbsp;&nbsp;&nbsp;19</p></td>
<td class="th1"><p class="tab-text">31,766</p></td>
<td class="th1"><p class="tab-text">SELECT COUNT( ) FROM $DCOUNT_DATACACHE;</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">4</p></td>
<td class="th1"><p class="tab-text">Scan</p></td>
<td class="th1"><p class="tab-text">4,288</p></td>
<td class="th1"><p class="tab-text">31,766</p></td>
<td class="th1"><p class="tab-text">SELECT DCOUNT ( Example[Score] ) FROM Example;</p></td>
</tr>
</tbody>
</table>
<p class="edition"><span type="pagebreak" id="calibre_link-1933"></span>The last line includes the SE query requested by the FE. However, internally the query is split into two subqueries. The first result is duplicated in two identical rows (see the content of the <em class="calibre5">Duration</em> and <em class="calibre5">CPU</em> columns). The following is the xmSQL code of the first internal subquery, which retrieves the list of unique values in the <em class="calibre5">Score</em> column of the <em class="calibre5">Example</em> table:</p>
<div class="program"><pre class="calibre14">SELECT Example[Score]
FROM Example
WHERE Example[Score] &lt;&gt; 0;</pre></div>
<p class="edition">The result of this SE query is a list of the unique values in the <em class="calibre5">Score</em> column of the <em class="calibre5">Example</em> table. The next step is to count how many rows are in this list. In other words, counting the rows returned by the internal query provides the correct result to the original query. This particular xmSQL query just references a special table named <em class="calibre5">$DCOUNT</em>_<em class="calibre5">DATACACHE</em>, which references the previous result from an SE query:</p>
<div class="program"><pre class="calibre14">SELECT COUNT ( )
FROM $DCOUNT_DATACACHE;</pre></div>
<p class="edition"><a href="#calibre_link-1489" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 19-2</a> also shows that the duration of the <em class="calibre5">Scan</em> event corresponds to the sum of the duration of the two internal events, although the duplicated event only counts once. Regarding the <em class="calibre5">CPU Time</em>, it is always the same in all the events of the same query. The parallelism ratio you can evaluate by dividing <em class="calibre5">CPU Time</em> by <em class="calibre5">Duration</em> is around seven, which means that up to eight threads in parallel were executed. The next section presents a deeper discussion about parallelism within an SE query.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-327" class="calibre13">Understanding parallelism and datacache</h4>
<p class="edition">Every SE query described by an xmSQL statement returns a result called a datacache, which is a single uncompressed table in memory. The result of an SE query can be completely materialized in memory, or its rows can be consumed during the iteration without them persisting. Usually, we refer to a datacache when this result is materialized, which is the case most of the time in complex queries.</p>
<p class="edition">The execution of the SE query can be parallelized among many cores, using different execution threads. The number of threads used depends on the hardware and on the physical structure of the columns involved in the query. The VertiPaq engine assigns one thread to each segment involved in a single scan operation as described in the section, “<a href="#calibre_link-284" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Understanding segmentation and partitioning</a>” in <a href="#calibre_link-22" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 17</a>. When the operation runs on multiple threads, every thread creates a partial result. Only when all the threads complete their execution will VertiPaq consolidate these results into a single final datacache. The FE will then consume the datacache in a single thread. It is also for this reason that the result of an SE query requires such a consolidation. You can see the parallel processing and consolidation behavior described in a schema in <a href="#calibre_link-1490" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-15</a>.</p>
<figure id="calibre_link-1490" class="image-l">
<img src="images/000340.jpg" alt="The diagram shows that each VertiPaq query generates a datacache by scanning in-memory data from column storage. After that, a consolidation task creates a single final datacache from the multiple datacaches." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3231"></span><strong class="calibre7">Figure 19-15</strong> The final datacache is a consolidation of different datacaches created by concurrent VertiPaq queries when the engine parallelizes execution.</figcaption>
</figure>
<p class="edition">A segment should not be too small because the consolidation process requires time. The efficiency of running scan operations in multiple threads should balance the overhead of the consolidation, but this is not possible if the segments are too small. As a side effect, VertiPaq operations on small tables cannot get the benefits of multiple cores: The consolidation process would be more expensive than the gain provided by the parallelization of small tables.</p>
<p class="edition">It is useful to remember that the SE query only provides data to the FE. In a simple scenario, we have the following steps:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">The SE receives an xmSQL query.</p></li>
<li class="calibre25"><p class="listp">The SE executes the scan operations potentially on many threads, creating one datacache per thread.</p></li>
<li class="calibre25"><p class="listp">The SE consolidates the different datacaches into a single, final datacache.</p></li>
<li class="calibre25"><p class="listp">The FE consumes the datacache in a single thread.</p></li>
<li class="calibre25"><p class="listp">The FE can use the same datacache in different steps of the query plan.</p></li>
</ol>
<p class="edition"><span type="pagebreak" id="calibre_link-1934"></span>In the Profiler, you will always see the SE events before the query plan. The physical query plan always appears at the end of the events related to a query. The logical query plan can be preceded by a few SE queries. When this is the case, it is because the DAX engine itself sends queries to retrieve information about the size and density of columns. The DAX engine uses this information to create a better query plan. Using DAX Studio, you cannot see such a behavior because this tool shows query plans and SE queries in different parts of the user interface.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-328" class="calibre13">Understanding the VertiPaq cache</h4>
<p class="edition">The DAX formula engine does not have a cache, whereas the VertiPaq storage engine has one: the VertiPaq cache. Its primary goal is to improve the performance of multiple requests of the same datacache within the same query. Its secondary goal is to improve the performance of different DAX queries requesting the same datacache. It is important to understand the goals of the VertiPaq cache in order to analyze its behavior and evaluate its efficiency.</p>
<p class="edition">For example, consider the following DAX query:</p>
<p class="codelink"><a href="#calibre_link-1491" id="calibre_link-2825" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ADDCOLUMNS (
    VALUES ( Example[Date] ),
    "A", CALCULATE ( SUM ( Example[Amt] ) ),
    "Q", CALCULATE ( SUM ( Example[Qty] ) )
)</pre></div>
<p class="edition">The result of the query includes two columns, <em class="calibre5">A</em> and <em class="calibre5">Q</em>, summing the <em class="calibre5">Amt</em> and <em class="calibre5">Qty</em> columns of the <em class="calibre5">Example</em> table for each <em class="calibre5">Date</em>. We are going to run the query twice, analyzing the different execution time of the two runs. <a href="#calibre_link-1492" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 19-3</a> shows the sequence of <em class="calibre5">Scan</em> events for the first execution, enabling both <em class="calibre5">Cache</em> and <em class="calibre5">Internal</em> events in DAX Studio.</p>
<p class="edition" id="calibre_link-1492"><strong class="calibre7">Table 19-3</strong> <em class="calibre5">VertiPaq</em> events for the first execution of a DAX query with two aggregations</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Line</p></th>
<th class="th"><p class="tab-text">Subclass</p></th>
<th class="th"><p class="tab-text">Duration</p></th>
<th class="th"><p class="tab-text">CPU</p></th>
<th class="th"><p class="tab-text">Query</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">Internal</p></td>
<td class="th1"><p class="tab-text">1,796</p></td>
<td class="th1"><p class="tab-text">13,516</p></td>
<td class="th1"><p class="tab-text">SELECT</p>
<p class="none">Example[Date], SUM ( Example[Amt] ),</p>
<p class="none">SUM ( Example[Qty] ), COUNT ( )</p>
<p class="tab-text">FROM Example;</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2</p></td>
<td class="th1"><p class="tab-text">Scan</p></td>
<td class="th1"><p class="tab-text">1,796</p></td>
<td class="th1"><p class="tab-text">13,516</p></td>
<td class="th1"><p class="tab-text">SELECT</p>
<p class="none">Example[Date], SUM ( Example[Amt] ),</p>
<p class="none">SUM ( Example[Qty] ), COUNT ( )</p>
<p class="tab-text">FROM Example;</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">3</p></td>
<td class="th1"><p class="tab-text">Internal</p></td>
<td class="th1"><p class="tab-text">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6</p></td>
<td class="th1"><p class="tab-text">&nbsp;&nbsp;&nbsp;&nbsp;31</p></td>
<td class="th1"><p class="tab-text">SELECT Example[Date], COUNT ( ) FROM Example;</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">4</p></td>
<td class="th1"><p class="tab-text">Scan</p></td>
<td class="th1"><p class="tab-text">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6</p></td>
<td class="th1"><p class="tab-text">&nbsp;&nbsp;&nbsp;&nbsp;31</p></td>
<td class="th1"><p class="tab-text">SELECT Example[Date] FROM Example;</p></td>
</tr>
</tbody>
</table>
<p class="edition"><span type="pagebreak" id="calibre_link-3232"></span>The second execution of the same query produces a different result because the second execution can benefit from the VertiPaq cache of the first run. This result is visible in <a href="#calibre_link-1493" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 19-4</a>.</p>
<p class="edition" id="calibre_link-1493"><strong class="calibre7">Table 19-4</strong> <em class="calibre5">VertiPaq</em> events for the second execution of a DAX query with two aggregations</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Line</p></th>
<th class="th"><p class="tab-text">Subclass</p></th>
<th class="th"><p class="tab-text">Duration</p></th>
<th class="th"><p class="tab-text">CPU</p></th>
<th class="th"><p class="tab-text">Query</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">Cache</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">SELECT</p>
<p class="none">Example[Date], SUM ( Example[Amt] ),</p>
<p class="none">SUM ( Example[Qty] ), COUNT ( )</p>
<p class="tab-text">FROM Example;</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2</p></td>
<td class="th1"><p class="tab-text">Scan</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">SELECT</p>
<p class="none">Example[Date], SUM ( Example[Amt] ),</p>
<p class="none">SUM ( Example[Qty] ), COUNT ( )</p>
<p class="tab-text">FROM Example;</p></td>
</tr>
<tr class="calibre17">
<td class="th1"><p class="tab-text">3</p></td>
<td class="th1"><p class="tab-text">Cache</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">SELECT Example[Date], COUNT ( ) FROM Example;</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">4</p></td>
<td class="th1"><p class="tab-text">Scan</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">SELECT Example[Date] FROM Example;</p></td>
</tr>
</tbody>
</table>
<p class="edition">The duration of the second execution is zero milliseconds. The reason is that the second time the query was run, a datacache containing the required data was already available in the VertiPaq cache. Therefore, the engine did not execute any VertiPaq query; instead it simply retrieved the result from the cache.</p>
<p class="edition">The <em class="calibre5">Cache</em> and <em class="calibre5">Internal</em> events are disabled by default in DAX Studio, so the typical result visible when hitting the cache for SE queries is shown in <a href="#calibre_link-1494" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 19-5</a>. The only visible events are the <em class="calibre5">Scan</em> events, with a duration of 0 milliseconds.</p>
<p class="edition" id="calibre_link-1494"><strong class="calibre7">Table 19-5</strong> <em class="calibre5">VertiPaq Scan</em> events visible for a DAX query with two aggregations</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Line</p></th>
<th class="th"><p class="tab-text">Subclass</p></th>
<th class="th"><p class="tab-text">Duration</p></th>
<th class="th"><p class="tab-text">CPU</p></th>
<th class="th"><p class="tab-text">Query</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">2</p></td>
<td class="th1"><p class="tab-text">Scan</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">SELECT</p>
<p class="none">Example[Date], SUM ( Example[Amt] ),</p>
<p class="none">SUM ( Example[Qty] ), COUNT ( )</p>
<p class="tab-text">FROM Example;</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">4</p></td>
<td class="th1"><p class="tab-text">Scan</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">SELECT Example[Date] FROM Example;</p></td>
</tr>
</tbody>
</table>
<p class="edition">The VertiPaq engine only reuses data in cache when the cardinality is the same and the columns are a subset of a previous query. This algorithm is very simple because the lookup in the VertiPaq cache must not be an overhead of the memory scan operation that it is trying to avoid. For this reason, the VertiPaq cache only keeps in memory a limited number of datacaches. Therefore, there is no guarantee that a request will hit the cache, even when the query plan repeats the same storage query multiple times within the same DAX query. Nevertheless, in most conditions the VertiPaq cache satisfies several of the requests that occur within a short period.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span type="pagebreak" id="calibre_link-1996"></span><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">VertiPaq ignores row-level security settings. The DAX formula engine manages the role-based security and generates different VertiPaq storage engine queries depending on security settings and user credentials. For this reason, the VertiPaq cache is a global resource and shares the results between different users and sessions. The FE guarantees the correctness of the result, generating different SE queries depending on the requirements.</p>
</div>
<p class="edition">When analyzing performance, it is important to clear the cache before running a query. In order to find bottlenecks and areas of improvement for a query plan, it is better to observe the time required to complete a scan in memory, simulating the worst-case scenario (empty cache). Because of the reduced size of the VertiPaq cache, missing the cache is a frequent event on a busy server with many concurrent users running queries.</p>
<p class="edition">DAX Studio provides two techniques to clear the cache before executing a query:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Clicking the Clear Cache button on the Home tab to clear the cache on the DAX engine before executing a query with the Run Query button.</p></li>
<li class="calibre10"><p class="listp">Selecting the Clear Cache then Run button on the Home tab so that the cache gets cleared before each Run execution.</p></li>
</ul>
<p class="edition">The Run and Clear Cache then Run buttons are shown in <a href="#calibre_link-1495" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-16</a>.</p>
<figure id="calibre_link-1495" class="image-l">
<img src="images/000348.jpg" alt="This figure is a part of the Home tab." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-16</strong> The Home tab in DAX Studio has several options to clear the cache of the DAX engine.</figcaption>
</figure>
<p class="edition">DAX Studio internally sends a clear cache command to the DAX engine using the following XMLA command, which removes the cache of results related to the specified database. This example clears the cache of the Contoso database:</p>
<p class="codelink"><a href="#calibre_link-1496" id="calibre_link-2826" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">&lt;ClearCache xmlns="http://schemas.microsoft.com/analysisservices/2003/engine"&gt;
<span type="pagebreak" id="calibre_link-1860"></span>    &lt;Object&gt;
        &lt;DatabaseID&gt;Contoso&lt;/DatabaseID&gt;
    &lt;/Object&gt;
&lt;/ClearCache&gt;</pre></div>
</section>
<section class="calibre4">
<h4 id="calibre_link-329" class="calibre13">Understanding <em class="calibre5">CallbackDataID</em></h4>
<p class="edition">The VertiPaq SE only supports a limited set of operators and functions in xmSQL. Thus, it is up to the FE to execute any operation not directly supported by the SE. However, when a complex calculation is required within a VertiPaq iterator, the SE may call the FE using a special xmSQL function called <em class="calibre5">CallbackDataID</em>.</p>
<p class="edition">The operators supported in xmSQL include the basic mathematical operations (sum, subtraction, multiplication, and division) but do not include mathematical functions such as square root (<em class="calibre5">SQRT</em> in DAX), or conditional logic such as the <em class="calibre5">IF</em> function. If you include an expression that is not supported by xmSQL in an iterator, then the query plan generates an xmSQL query containing a special function: <em class="calibre5">CallbackDataID</em>. During the iteration, the SE calls the FE for every row, passing the DAX expression and the values of its members as arguments.</p>
<p class="edition">For example, consider the sum of rounded values in this DAX query:</p>
<p class="codelink"><a href="#calibre_link-1497" id="calibre_link-2827" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ROW (
    "Result", SUMX ( Sales, ROUND ( Sales[Line Amount], 0 ) )
)</pre></div>
<p class="edition">In this expression, the SE cannot evaluate the <em class="calibre5">ROUND</em> function. Therefore, the query plan generates the following xmSQL statement:</p>
<p class="codelink"><a href="#calibre_link-1498" id="calibre_link-2828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := [<strong class="calibre7">CallbackDataID</strong> ( ROUND ( Sales[Line Amount]] ), 0 ) ]
              ( PFDATAID ( Sales[Line Amount] ) )
SELECT
    SUM ( @$Expr0 )
FROM Sales;</pre></div>
<p class="edition">The <em class="calibre5">CallbackDataID</em> function contains the DAX expression that rounds a value to the closest integer. This expression is evaluated for the <em class="calibre5">Line Amount</em> column in the <em class="calibre5">Sales</em> table for the current row. The <em class="calibre5">PFDATAID</em> syntax is not relevant for analyzing the logic we are describing now. The SE calls the <em class="calibre5">CallbackDataID</em> function for each row of the <em class="calibre5">Sales</em> table. The result of the xmSQL query is a datacache with only one row, corresponding to the aggregated result. Even though the FE is single threaded, when the SE calls the FE through a <em class="calibre5">CallbackDataID</em>, the parallelism of the SE is not affected. Indeed, there could be multiple instances of the FE executed in parallel, one for each thread of the SE.</p>
<div class="sidebar">
<p class="edition"><span type="pagebreak" id="calibre_link-1859"></span>Parallelism of <em class="calibre5">CallbackDataID</em> and possible alternatives</p>
<p class="edition">In order to understand how the parallelism interacts with <em class="calibre5">CallbackDataID</em> and the associated cost, consider what could happen if the <em class="calibre5">CallbackDataID</em> were not available. We might have a query plan requesting a datacache with the value of the <em class="calibre5">Line Amount</em> column for all the rows of the <em class="calibre5">Sales table</em>, using an xmSQL query such as the following:</p>
<p class="codelink"><a href="#calibre_link-1499" id="calibre_link-2829" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    Sales[Line Amount], COUNT( )
FROM Sales;</pre></div>
<p class="edition">The datacache obtained by the FE would contain one row for each unique value of the <em class="calibre5">Line Amount</em> column and the number of rows having this value in the <em class="calibre5">Sales table</em> (returned by <em class="calibre5">COUNT</em>). Using this information, the FE would apply the <em class="calibre5">ROUND</em> function to the value of <em class="calibre5">Line Amount</em> for each row of the datacache, multiplying that result by the number of occurrences of the <em class="calibre5">Line Amount</em> value in the <em class="calibre5">Sales table</em>. The result provided by the FE would be identical, but the SE should create a much larger datacache than the one-row datacache obtained by the xmSQL query with the <em class="calibre5">CallbackDataID</em>. Remember that the SE often materializes the entire datacache in memory, and that this would be in an uncompressed format. Then the FE would iterate this datacache sequentially in a single thread. This would result in poor performance and a larger memory consumption.</p>
<p class="edition">The execution using <em class="calibre5">CallbackDataID</em> is less expensive in terms of memory (the datacache materialized only has one row) and is more scalable. If the <em class="calibre5">VertiPaq Scan</em> operation spans on multiple threads, calls made to the FE through <em class="calibre5">CallbackDataID</em> use a thread instance of the FE. In other words, we can imagine that every running thread has its own instance of the FE&mdash;even within the same query. The only sequential operation is the consolidation made by the SE on the datacaches created by the running threads. However, this operation will be very fast because it consolidates different datacaches only containing one column each.</p>
</div>
<p class="edition">From a performance point of view, <em class="calibre5">CallbackDataID</em> has three other implications:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Expressions solved through <em class="calibre5">CallbackDataID</em> calls are more expensive than expressions solved by internal operators of the SE. There is an <strong class="calibre7">overhead associated with each call to</strong> <em class="calibre5">CallbackDataID</em>.</p></li>
<li class="calibre10"><p class="listp">In a trace session, <strong class="calibre7">a <em class="calibre5">VertiPaq SE</em> event includes the time spent in the FE by a <em class="calibre5">CallbackDataID</em> call</strong>. Consider that optimizing an SE query that has a long execution time might require you to reduce or to remove the calls to <em class="calibre5">CallbackDataID</em> made by xmSQL queries.</p></li>
<li class="calibre10"><p class="listp">The <strong class="calibre7">SE cache does not save datacaches</strong> produced by an xmSQL query <strong class="calibre7">containing <em class="calibre5">CallbackDataID</em> calls</strong>. Therefore, the presence of <em class="calibre5">CallbackDataID</em> in an xmSQL function should be carefully evaluated when the storage executes it in an iteration.</p></li>
</ul>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span type="pagebreak" id="calibre_link-2036"></span><span class="middle"><img src="images/000318.jpg" alt="Image" class="calibre21 pcalibre6" /></span> Important</p>
<p class="edition">The FE is single-threaded, but when the SE calls the FE through <em class="calibre5">CallbackDataID</em>, the execution of the code in the FE is parallelized through the several threads created by the SE. The parallelism provided by this technique reduces overall <em class="calibre5">Duration</em>, but <em class="calibre5">CPU Time</em> might increase because of the <em class="calibre5">CallbackDataID</em> calls overhead.</p>
</div>
<p class="edition">In order to understand the performance impact of <em class="calibre5">CallbackDataID</em>, consider the following DAX query that sums the result of a division made row by row:</p>
<p class="codelink"><a href="#calibre_link-1500" id="calibre_link-2830" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
{
    SUMX (
        Example,
        IF (
            Example[Denominator] &lt;&gt; 0,
            Example[Numerator] / Example[Denominator]
        )
    )
}</pre></div>
<p class="edition">The <em class="calibre5">IF</em> function avoids a calculation error in case one row contains a zero value in the denominator column. The xmSQL query sent to the SE is similar to the following one:</p>
<p class="codelink"><a href="#calibre_link-1501" id="calibre_link-2831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := [<strong class="calibre7">CallbackDataID</strong> (
        IF (
            Example[Denominator] &lt;&gt; 0,
            Example[Numerator] / Example[Denominator]
        ) ]
        ( PFDATAID ( Example[Numerator] ), PFDATAID ( Example[Denominator] ) )
SELECT
    SUM ( @$Expr0 )
FROM Example;</pre></div>
<p class="edition">We executed a corresponding DAX query on our <em class="calibre5">Example</em> table with 4 billion rows, obtaining the SE events shown in <a href="#calibre_link-1502" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 19-6</a>.</p>
<p class="edition" id="calibre_link-1502"><strong class="calibre7">Table 19-6</strong> <em class="calibre5">VertiPaq Scan</em> events with a <em class="calibre5">CallbackDataID</em> including an <em class="calibre5">IF</em> function in DAX</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Line</p></th>
<th class="th"><p class="tab-text">Subclass</p></th>
<th class="th"><p class="tab-text">Duration</p></th>
<th class="th"><p class="tab-text">CPU</p></th>
<th class="th"><p class="tab-text">Rows</p></th>
<th class="th"><p class="tab-text">Query</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">Internal</p></td>
<td class="th1"><p class="tab-text">8,379</p></td>
<td class="th1"><p class="tab-text">64,234</p></td>
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">WITH $Expr0 := [<strong class="calibre7">CallbackDataID</strong> ( IF ( Example[Denominator] &lt;&gt; 0, ...</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2</p></td>
<td class="th1"><p class="tab-text">Scan</p></td>
<td class="th1"><p class="tab-text">8,379</p></td>
<td class="th1"><p class="tab-text">64,234</p></td>
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">WITH $Expr0 := [<strong class="calibre7">CallbackDataID</strong> ( IF ( Example[Denominator] &lt;&gt; 0, ...</p></td>
</tr>
</tbody>
</table>
<p class="edition">The parallelism ratio (<em class="calibre5">CPU Time</em> divided by <em class="calibre5">Duration</em>) is close to eight because we used a server with eight cores. The important point is that different threads executed parallel calls to the FE. In previous chapters, we have seen that in DAX the <em class="calibre5">DIVIDE</em> function can replace the specific <em class="calibre5">IF</em> condition used <span type="pagebreak" id="calibre_link-3233"></span>to check whether the denominator of a division is equal to zero. We can see what happens if we use <em class="calibre5">DIVIDE</em> instead of <em class="calibre5">IF</em> in this example. The DAX query is the following:</p>
<p class="codelink"><a href="#calibre_link-1503" id="calibre_link-2832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
{
    SUMX (
        Example,
        DIVIDE ( Example[Numerator], Example[Denominator] )
    )
}</pre></div>
<p class="edition">The <em class="calibre5">DIVIDE</em> function does not have a corresponding syntax in xmSQL, so we have a <em class="calibre5">CallbackDataID</em> in the corresponding xmSQL query sent to the engines in this case too:</p>
<p class="codelink"><a href="#calibre_link-1504" id="calibre_link-2833" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := [<strong class="calibre7">CallbackDataID</strong> (
        DIVIDE ( Example[Numerator], Example[Denominator] ) ]
        ( PFDATAID ( Example[Numerator] ), PFDATAID ( Example[Denominator] ) )
SELECT
    SUM ( @$Expr0 )
FROM Example;</pre></div>
<p class="edition"><a href="#calibre_link-1505" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 19-7</a> shows the SE events obtained from running the query over the same 4-billion-row table used in the previous example.</p>
<p class="edition" id="calibre_link-1505"><strong class="calibre7">Table 19-7</strong> <em class="calibre5">VertiPaq Scan</em> events with a <em class="calibre5">CallbackDataID</em> including a <em class="calibre5">DIVIDE</em> function in DAX</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Line</p></th>
<th class="th"><p class="tab-text">Subclass</p></th>
<th class="th"><p class="tab-text">Duration</p></th>
<th class="th"><p class="tab-text">CPU</p></th>
<th class="th"><p class="tab-text">Rows</p></th>
<th class="th"><p class="tab-text">Query</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">Internal</p></td>
<td class="th1"><p class="tab-text">6,790</p></td>
<td class="th1"><p class="tab-text">51,984</p></td>
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">WITH $Expr0 := [<strong class="calibre7">CallbackDataID</strong> ( IF ( Example[Denominator] &lt;&gt; 0, ...</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2</p></td>
<td class="th1"><p class="tab-text">Scan</p></td>
<td class="th1"><p class="tab-text">6,790</p></td>
<td class="th1"><p class="tab-text">51,984</p></td>
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">WITH $Expr0 := [<strong class="calibre7">CallbackDataID</strong> ( IF ( Example[Denominator] &lt;&gt; 0, ...</p></td>
</tr>
</tbody>
</table>
<p class="edition">Using <em class="calibre5">DIVIDE</em> instead of <em class="calibre5">IF</em>, we obtained a 19% performance improvement in both <em class="calibre5">Duration</em> and <em class="calibre5">CPU Time</em>. However, despite the parallelism achieved with this technique, the overhead of <em class="calibre5">CallbackDataID</em> is still high because the SE calls a function in the FE. If we remove the <em class="calibre5">CallbackDataID</em> completely, this overhead disappears. In this case, this is possible by simply applying a filter so that the iteration ignores rows containing zero in the <em class="calibre5">Denominator</em> column. This is possible with the following DAX query:</p>
<p class="codelink"><a href="#calibre_link-1506" id="calibre_link-2834" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
{
    CALCULATE (
        SUMX (
            Example,
            Example[Numerator] / Example[Denominator]
        ),
        Example[Denominator] &lt;&gt; 0
    )
}</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1712"></span>The corresponding syntax in xmSQL for this entire DAX expression does not use <em class="calibre5">CallbackDataID</em>:</p>
<p class="codelink"><a href="#calibre_link-1507" id="calibre_link-2835" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := Example[Numerator] / Example[Denominator]
SELECT
    SUM ( @$Expr0 )
FROM Example
WHERE Example[Denominator] &lt;&gt; 0;</pre></div>
<p class="edition">The resulting SE events shown in <a href="#calibre_link-1508" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 19-8</a> demonstrate an improvement of more than 50% compared to the performance of the <em class="calibre5">DIVIDE</em> version.</p>
<p class="edition" id="calibre_link-1508"><strong class="calibre7">Table 19-8</strong> <em class="calibre5">VertiPaq Scan</em> events without <em class="calibre5">CallbackDataID</em> to execute a safe division in DAX</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Line</p></th>
<th class="th"><p class="tab-text">Subclass</p></th>
<th class="th"><p class="tab-text">Duration</p></th>
<th class="th"><p class="tab-text">CPU</p></th>
<th class="th"><p class="tab-text">Rows</p></th>
<th class="th"><p class="tab-text">Query</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">Internal</p></td>
<td class="th1"><p class="tab-text">3,108</p></td>
<td class="th1"><p class="tab-text">23,859</p></td>
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">WITH $Expr0 := Example[Numerator] / Example[Denominator], ...</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2</p></td>
<td class="th1"><p class="tab-text">Scan</p></td>
<td class="th1"><p class="tab-text">3,108</p></td>
<td class="th1"><p class="tab-text">23,859</p></td>
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">WITH $Expr0 := Example[Numerator] / Example[Denominator], ...</p></td>
</tr>
</tbody>
</table>
<p class="edition">This last version also offers another advantage by avoiding the use of <em class="calibre5">CallbackDataID</em>. The VertiPaq cache now keeps the datacache for future executions, which is not possible when the xmSQL query includes a <em class="calibre5">CallbackDataID</em>. If we execute the last DAX query twice, the second execution produces the events shown in <a href="#calibre_link-1509" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Table 19-9</a>.</p>
<p class="edition" id="calibre_link-1509"><strong class="calibre7">Table 19-9</strong> <em class="calibre5">VertiPaq Scan</em> events without <em class="calibre5">CallbackDataID</em> hitting the SE cache</p>
<table class="topbot">
<thead class="calibre15">
<tr class="tr">
<th class="th"><p class="tab-text">Line</p></th>
<th class="th"><p class="tab-text">Subclass</p></th>
<th class="th"><p class="tab-text">Duration</p></th>
<th class="th"><p class="tab-text">CPU</p></th>
<th class="th"><p class="tab-text">Rows</p></th>
<th class="th"><p class="tab-text">Query</p></th>
</tr>
</thead>
<tbody class="calibre16">
<tr class="calibre17">
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">Cache</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">WITH $Expr0 := Example[Numerator] / Example[Denominator], ...</p></td>
</tr>
<tr class="calibre18">
<td class="th1"><p class="tab-text">2</p></td>
<td class="th1"><p class="tab-text">Scan</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">0</p></td>
<td class="th1"><p class="tab-text">1</p></td>
<td class="th1"><p class="tab-text">WITH $Expr0 := Example[Numerator] / Example[Denominator], ...</p></td>
</tr>
</tbody>
</table>
<p class="edition">In general, a careful developer should avoid or at least reduce to a minimum the number of calls to <em class="calibre5">CallbackDataID</em> made by the SE. We will show some examples of this optimization in <a href="#calibre_link-25" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 20</a>.</p>
<div class="sidebar">
<p class="edition">Profiler limitations for <em class="calibre5">CallbackDataID</em> in Analysis Services 2012/2014</p>
<p class="edition">There are important limitations in profiler events generated by Analysis Services 2012 and 2014 when the xmSQL query includes <em class="calibre5">CallbackDataID</em>. The internal DAX expression passed to <em class="calibre5">CallbackDataID</em> might include subquery statements in DAX generating further requests to the SE. Unfortunately, versions of Analysis Services released before 2015 only provide information about these subqueries in the logical query plan. The physical query plan does not include the subexpression included within <em class="calibre5">CallbackDataID</em>. The SE queries executed to evaluate these subexpressions do not fire any event visible in the profiler. Analysis Services, Excel, and Power BI Desktop versions released since 2016 do not have this problem.</p>
</div>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-330" class="h2a"><span type="pagebreak" id="calibre_link-2001"></span>Reading DirectQuery storage engine queries</h3>
<p class="edition">This section describes how to read the DirectQuery SE queries. These queries are expressed in the SQL language accepted by the data source. It is advisable to read the previous section about VertiPaq storage engine queries before reading this section to understand the similarities and differences between the two.</p>
<p class="edition">For example, consider the following DAX query:</p>
<p class="codelink"><a href="#calibre_link-1510" id="calibre_link-2836" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    Sales[Order Date],
    "Total Quantity", SUM ( Sales[Quantity] )
)</pre></div>
<p class="edition">When executed in a DirectQuery model, the DAX engine generates a single SE query sent to the data source in SQL language, like the following one:</p>
<p class="codelink"><a href="#calibre_link-1511" id="calibre_link-2837" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    TOP (1000001) [t4].[Order Date],
    SUM ( CAST ( [t4].[Quantity] as BIGINT ) ) AS [a0]
FROM  (
    select [StoreKey],
           [ProductKey],
           ... // other columns of the tables omitted here
    from [dbo].[Sales] as [$Table]
) AS [t4]
GROUP BY [t4].[Order Date]</pre></div>
<p class="edition">The presence of a <em class="calibre5">TOP</em> condition limits the number of rows transferred from the data source to the DAX engine. If the number of rows returned is identical to the parameter of the <em class="calibre5">TOP</em> condition, then the DAX query fails because it is not able to retrieve the full set of data from the data source. For this reason the argument of <em class="calibre5">TOPN</em> is 1,000,001 when the limit of rows accepted by DirectQuery is 1,000,000. This limit avoids the consumption of too much memory because the entire result of the SE query should be loaded in memory in an uncompressed way after being transferred from the data source to the DAX engine.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The limit or rows accepted in a storage engine request using DirectQuery is 1,000,000 by default. This number can be modified in the <em class="calibre5">MaxIntermediateRowsetSize</em> configuration setting available in Analysis Services but not in Power BI. More details about this behavior are available in the article at <a href="https://www.sqlbi.com/articles/tuning-query-limits-fordirectquery/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.sqlbi.com/articles/tuning-query-limits-fordirectquery/</a>.</p>
</div>
<p class="edition"><a href="#calibre_link-1512" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-17</a> shows an example of the information retrieved for SQL SE queries sent to a DirectQuery data source. The <em class="calibre5">Duration</em> column shows the time in milliseconds spent waiting for the data source to <span type="pagebreak" id="calibre_link-1889"></span>provide the result of the SQL query. The <em class="calibre5">CPU</em> is usually a low number, if not 0, because it should report the cost to the DirectQuery engine to retrieve the result, but it ignores the effective cost on the data source. In order to evaluate the actual <em class="calibre5">CPU</em> consumption on the data source, it is necessary to analyze the query running on the data source engine&mdash;for example, by using SQL Server Profiler for Microsoft SQL Server databases.</p>
<figure id="calibre_link-1512" class="image-l">
<img src="images/000356.jpg" alt="This figure is an example of the information retrieved." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-17</strong> DirectQuery SE queries are displayed as SQL queries.</figcaption>
</figure>
<p class="edition">The SQL event in <a href="#calibre_link-1512" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-17</a> does not have any information for the columns <em class="calibre5">Rows</em> and <em class="calibre5">KB;</em> indeed, the <em class="calibre5">SQL</em> events do not have an estimate of the result in terms of rows and memory as it happens for xmSQL queries sent to VertiPaq.</p>
<p class="edition">Finally, the result of a DirectQuery SE query is never persisted in the storage engine cache, therefore, the <em class="calibre5">SE Cache</em> counter is always zero for a DirectQuery data model.</p>
<section class="calibre4">
<h4 id="calibre_link-331" class="calibre13">Analyzing composite models</h4>
<p class="edition">In a composite model the same DAX query can generate a mix of VertiPaq and DirectQuery SE queries. For example, consider the following DAX query executed in a model where the <em class="calibre5">Sales</em> table has a DirectQuery storage mode and all the other tables have a Dual storage mode:</p>
<p class="codelink"><a href="#calibre_link-1513" id="calibre_link-2838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
ADDCOLUMNS (
    VALUES ( 'Date'[Calendar Year] ),
    "Quantity", CALCULATE ( SUM ( Sales[Quantity] ) )
)</pre></div>
<p class="edition">The <em class="calibre5">ADDCOLUMNS</em> function usually generates at least two SE queries: one for the <em class="calibre5">VALUES</em> function and the other to compute the sum of sales quantity by calendar year. The screenshot in <a href="#calibre_link-1514" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-18</a> shows two storage queries of different types, indeed.</p>
<figure id="calibre_link-1514" class="image-l">
<img src="images/000364.jpg" alt="The figure shows two storage queries of different types." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-18</strong> DirectQuery SE are displayed as SQL queries.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1665"></span>The sum of quantity by calendar year requires that a SQL query (displayed at line 1) be sent to the DirectQuery data source. The list of <em class="calibre5">Calendar Year</em> names requested by <em class="calibre5">VALUES</em> is provided by the xmSQL VertiPaq SE query at line 3.</p>
<p class="edition">When analyzing a composite model, pay attention to the <em class="calibre5">Subclass</em> column that identifies the type of SE used. SQL always corresponds to a DirectQuery data source, which is usually slower than VertiPaq and can be optimized by using aggregations. This is described in the next section.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-332" class="calibre13">Using aggregations in the data model</h4>
<p class="edition">As described in <a href="#calibre_link-23" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 18</a>, “<a href="#calibre_link-23" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Optimizing VertiPaq</a>,” the presence of aggregations in a data model can improve the performance of the SE query. Aggregations can be defined in both VertiPaq and DirectQuery, providing alternative ways to execute an SE query. When there are aggregations available, the engine tries to rewrite an original SE query into a different one using an aggregation. This rewriting attempt is successful when there is a compatible aggregation. Whenever the rewriting attempt fails because of the lack of a compatible aggregation, the engine executes the original SE query.</p>
<p class="edition">DAX Studio can show the rewriting attempts to match an aggregation. These details might be useful to understand why an existing aggregation is not used when this was expected. For example, consider the following query executed in a composite model:</p>
<p class="codelink"><a href="#calibre_link-1515" id="calibre_link-2839" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
SUMMARIZECOLUMNS (
    'Date'[Calendar Year],
    "Qty", SUM ( Sales[Quantity] ),
    "Qty Red", CALCULATE (
        SUM ( Sales[Quantity] ),
        'Product'[Color] = "Red"
    )
)</pre></div>
<p class="edition">The model has an aggregation for the <em class="calibre5">Sales</em> table with the granularity of <em class="calibre5">Date</em> and <em class="calibre5">Customer</em>. The query computes two expressions for each calendar year: <em class="calibre5">Qty</em> is the sum of the quantity for all the orders made in the reported year, and <em class="calibre5">Qty Red</em> is the quantity for the orders of red products made in the same year. The screenshot in <a href="#calibre_link-1516" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-19</a> shows the SE queries reported by DAX Studio executing the preceding DAX query.</p>
<figure id="calibre_link-1516" class="image-l">
<img src="images/000371.jpg" alt="The figure shows the SE queries reported by DAX Studio." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-19</strong> Use of aggregations reported by <em class="calibre5">RewriteAttempted</em> events in DAX Studio.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1666"></span>There are two <em class="calibre5">RewriteAttempted</em> subclass events describing the evaluation made by the DAX engine before generating the SE query. The <em class="calibre5">Qty</em> calculation requires a filter by year; this request is compatible with the existing aggregation (which groups by <em class="calibre5">Date</em> and <em class="calibre5">Customer</em>). This is reported in Line 1 and the details about the match found are reported in the details of the event shown in <a href="#calibre_link-1517" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-20</a>.</p>
<figure id="calibre_link-1517" class="image-l">
<img src="images/000379.jpg" alt="This figure shows the details of the event." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-20</strong> A matching aggregation reports the use of aggregations reported by <em class="calibre5">RewriteAttempted</em> events in DAX Studio.</figcaption>
</figure>
<p class="edition">Because the aggregation is a table imported in memory, the engine generates the following VertiPaq SE query reported at Line 3 in <a href="#calibre_link-1516" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-19</a>:</p>
<p class="codelink"><a href="#calibre_link-1518" id="calibre_link-2840" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    'Date'[Calendar Year],
    SUM ( 'Sales_Agg'[Quantity] )
FROM 'Sales_Agg'
    LEFT OUTER JOIN 'Date' ON 'Sales_Agg'[Order Date]='Date'[Date];</pre></div>
<p class="edition">The <em class="calibre5">RewriteAttempted</em> event at line 4 in <a href="#calibre_link-1516" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-19</a> does not find a matching aggregation for the <em class="calibre5">Qty Red</em> calculation, which requires a filter by <em class="calibre5">Date</em> and <em class="calibre5">Product</em>. In this case the <em class="calibre5">Sales</em> original table (whose storage is DirectQuery) must be queried directly without using any aggregation, as shown in the details in <a href="#calibre_link-1519" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-21</a>.</p>
<figure id="calibre_link-1519" class="image-l">
<img src="images/000387.jpg" alt="This figure shows the details of the attempt." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-21</strong> Failed matching of aggregations reported by <em class="calibre5">RewriteAttempted</em> events in DAX Studio.</figcaption>
</figure>
<p class="edition">Because the <em class="calibre5">Sales</em> table has a DirectQuery storage, the engine generates an SQL query reported on line 5. The longer duration (more than two seconds) is normal and expected. Aggregations can be considered to improve the performance of DAX queries whose bottleneck is the SE. Aggregations are usually not useful for bottlenecks in the FE.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-333" class="h2a"><span type="pagebreak" id="calibre_link-2103"></span>Reading query plans</h3>
<p class="edition">At the beginning of this chapter, we described the two types of query plans available in DAX: logical and physical. In reality, we do not use these query plans often because we focus our attention on the SE queries first. We can analyze the performance of the SE queries to find issues caused by the SE and/or by the materialization of large datacaches in memory. SE queries are much easier to read than DAX query plans.</p>
<p class="edition">In this section, we describe some of the important behaviors to check in a query plan in order to identify performance bottlenecks. A complete and detailed coverage of all the operators used in logical and physical query plans is beyond the scope of this book. The goal here is to understand the relationships between a query plan and the SE queries, thus improving one’s ability to find bottlenecks and to improve query performance.</p>
<p class="edition">A query plan usually generates more than one SE query. The FE combines the results of different datacaches, doing operations like joins between temporary tables. Consider the following DAX query; it returns a table with the quantity sold for each product color, only for transactions with a <em class="calibre5">Net Price</em> greater than 1,000:</p>
<p class="codelink"><a href="#calibre_link-1520" id="calibre_link-2841" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
CALCULATETABLE (
    ADDCOLUMNS (
        ALL ( Product[Color] ),
        "Units", CALCULATE (
            SUM ( Sales[Quantity] )
        )
    ),
    Sales[Net Price] &gt; 1000
)
ORDER BY Product[Color]</pre></div>
<p class="edition">The result visible in <a href="#calibre_link-1521" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-22</a> includes all the unique values of <em class="calibre5">Color</em>, including those without any unit sold. In order to do that, the approach of the DAX engine is different from the one we would expect in plain SQL language; this is because of the different technique used to join tables in the SE. We will highlight this difference later; pay attention to the process for now.</p>
<figure id="calibre_link-1521" class="image-l">
<img src="images/000394.jpg" alt="The figure shows the result of the query, displaying units per color." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-22</strong> The result of <em class="calibre5">ADDCOLUMNS</em> includes rows with a blank value in the <em class="calibre5">Units</em> column.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-2085"></span>The logical query plan shown in <a href="#calibre_link-1522" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-23</a> includes three <em class="calibre5">Scan_Vertipaq</em> operations, two of which correspond to two datacaches provided by SE queries.</p>
<figure id="calibre_link-1522" class="image-l">
<img src="images/000402.jpg" alt="This figure is the query plan of the query." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-23</strong> Logical query plan of a simple DAX query.</figcaption>
</figure>
<p class="edition">The two <em class="calibre5">Scan_Vertipaq</em> operations at lines 4 and 6 require different sets of columns. The third <em class="calibre5">Scan_Vertipaq</em> operation at line 9 is used for a filter, and it does not generate a separate datacache. Its logic is included in one of the other two SE queries generated.</p>
<p class="edition">The <em class="calibre5">Scan_Vertipaq</em> at line 4 only uses the product color, whereas the <em class="calibre5">Scan_Vertipaq</em> at line 6 includes product color and sales quantity, which are two columns in two different tables. When this happens, a join between two or more tables is required.</p>
<p class="edition">After the logical query plan, the profiler receives the events from the SE. The corresponding xmSQL queries are the following:</p>
<p class="codelink"><a href="#calibre_link-1523" id="calibre_link-2842" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    Product[Color],
    SUM ( Sales[Quantity] )
FROM Sales
    LEFT OUTER JOIN Product ON Sales[ProductKey] = Product[ProductKey]
WHERE Sales[Net Price] &gt; 1000;

SELECT Product[Color] FROM Product;</pre></div>
<p class="edition">The first SE query retrieves a table containing one row for each color that has at least one unit sold at a price greater than 1,000 in the <em class="calibre5">Sales</em> table. In order to do that, the query joins <em class="calibre5">Sales</em> and <em class="calibre5">Product</em> using the <em class="calibre5">ProductKey</em> column. The second xmSQL statement returns the list of all the product colors, independent of the <em class="calibre5">Sales</em> table. These two queries generate two different datacaches, one with two columns (product color and sum of quantity) and another with only one column (the product color).</p>
<p class="edition">At this point, we might wonder why a second query is required. Why is the first xmSQL not enough? The reason is that the <em class="calibre5">LEFT JOIN</em> in xmSQL has <em class="calibre5">Sales</em> on the left side and <em class="calibre5">Product</em> on the right side. In plain SQL code, we would have written another query:</p>
<p class="codelink"><a href="#calibre_link-1524" id="calibre_link-2843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-2086"></span>SELECT
    Product.Color,
    SUM ( Sales.Quantity )
FROM Product
LEFT OUTER JOIN Sales
    ON Sales.ProductKey = Product.ProductKey
WHERE Sales.NetPrice &gt; 1000
GROUP BY Product.Color
ORDER BY Product.Color;</pre></div>
<p class="edition">Having the <em class="calibre5">Product</em> table on the left side of a <em class="calibre5">LEFT JOIN</em> would produce a result that includes all the product colors. However, the SE can only generate queries between tables with a relationship in the data model, and the resulting join in xmSQL always puts the table that is on the many-side of the relationship on the left side of the join condition. This guarantees that even though there are missing product keys in the <em class="calibre5">Product</em> table, the result will also include sales for those missing products; these sales will be included in a row with a blank value for all the product attributes, in this case the product color.</p>
<p class="edition">Now that we have seen why the DAX engine produces two SE queries for the initial DAX query, we can analyze the physical query plan shown in <a href="#calibre_link-1525" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-24</a>, where we can find more information about the query execution.</p>
<figure id="calibre_link-1525" class="image-l">
<img src="images/000409.jpg" alt="This figure shows the physical query plan." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-24</strong> Physical query plan of a simple DAX query.</figcaption>
</figure>
<p class="edition">The physical query plan uses the <em class="calibre5">Cache</em> operator (line 6 and 9) to indicate where it is consuming a datacache provided by the SE. Unfortunately, it is not possible to see the corresponding SE query for each operation. Nevertheless, at least in simple cases like the one considered, we can figure out this association by looking at other pieces of information. For example, one <em class="calibre5">Cache</em> only has one column obtained with a group operation, whereas the other <em class="calibre5">Cache</em> has two columns: one that is the result of a group operation and the other that is the result of an aggregation (the sum of the quantity). In the physical query plan, <em class="calibre5">#ValueCols</em> reports the number of columns that are the result of an aggregation, whereas <em class="calibre5">#FieldCols</em> reports the number of other columns used to group the result. By looking at the columns consumed by each <em class="calibre5">Cache</em> node, it is often possible to identify the corresponding xmSQL query even though it is a time-consuming process in complex query plans. In this example, the <em class="calibre5">Cache</em> node at line 6 returns a column with 16 product color names; on the other hand, the <em class="calibre5">Cache</em> node at line 9 only <span type="pagebreak" id="calibre_link-2032"></span>returns 10 rows and two columns, only with the product color names that have at least one transaction in <em class="calibre5">Sales</em> within the condition specified for <em class="calibre5">Net Price</em> (which must be greater than 1,000).</p>
<p class="edition">The <em class="calibre5">ProjectionSpool&lt;&gt;</em> operation consumes the datacaches corresponding to <em class="calibre5">Cache</em> nodes in the physical query plan. Here we can find an important piece of information: the number of records iterated, which corresponds to the number of rows in the datacache used. This number follows the <em class="calibre5">#Records</em> attribute, which is also reported in the <em class="calibre5">Records</em> column in DAX Studio. We can find the same <em class="calibre5">#Records</em> attribute in parent nodes of the query plan&mdash;a place where the type of aggregation performed by the engine is also available if there is one. In this example, the <em class="calibre5">Cache</em> at line 9 has two columns: one is <em class="calibre5">Product[Color]</em> and the other is the result of a sum aggregation. This information is available in the <em class="calibre5">LogOp</em> argument of the <em class="calibre5">Spool_Iterator</em> and <em class="calibre5">SpoolLookup</em> nodes at lines 4 and 7, respectively.</p>
<p class="edition">At this point, we can recap what we are reading in the query plans and the SE queries:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">The FE consumes two datacaches, corresponding to <em class="calibre5">Cache</em> nodes in the physical query plan.</p></li>
<li class="calibre25"><p class="listp">The FE iterates over the list of product colors, which is a table containing 16 rows and one column. This is the datacache obtained by the second SE query. Do not make assumptions about the order of the SE queries in the profiler.</p></li>
<li class="calibre25"><p class="listp">For each row of this datacache (a product color), the FE executes a lookup in the other datacache containing the product colors and the quantity sold for each color; this is a table with two columns and 10 rows.</p></li>
</ol>
<p class="edition">The entire process executed by the FE is sequential and single-threaded. The FE sends one request at a time to the SE. The SE might parallelize the query, but the FE does not send multiple requests in parallel to the SE.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The FE and the SE are subject to optimizations and improvements made in new releases. The behavior described might be different in newer versions of the DAX engine.</p>
</div>
<p class="edition">The FE can combine different results by using the lookup operation described in the previous query plan or other set operators. In any case, the FE executes this operation sequentially. For this reason, we might expect longer execution times by combining large datacaches or by performing a lookup for millions of rows in a large lookup datacache. A simple and effective way to identify these potential bottlenecks in the physical query plan is to look for the highest number of records in the operators of a logical query plan. For this reason, DAX Studio extracts that number from the query plan, making it easier to sort query plan operators by using the number of records iterated. It is possible to sort the rows by this number by clicking the <em class="calibre5">Records</em> column shown in <a href="#calibre_link-1525" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-24</a>. We will show a more detailed example of this approach in <a href="#calibre_link-25" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 20</a>.</p>
<p class="edition">The presence of relationships in the data model is important in order to obtain better performance. We can examine the behavior of a join between two tables when a relationship is not available. For example, consider a query returning the same result as the previous example, but operating in a data <span type="pagebreak" id="calibre_link-2033"></span>model that does not have a relationship between the <em class="calibre5">Product</em> and <em class="calibre5">Sales</em> tables. We need a DAX query such as the following; it uses the virtual relationship pattern shown in <a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 15</a>, “<a href="#calibre_link-20" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Advanced relationships</a>,” in the section “<a href="#calibre_link-252" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Transferring a filter using <em class="calibre5">INTERSECT</em></a>”:</p>
<p class="codelink"><a href="#calibre_link-1526" id="calibre_link-2844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Units] =
        CALCULATE (
            SUM ( Sales[Quantity] ),
            <strong class="calibre7">INTERSECT (</strong>
                <strong class="calibre7">ALL ( Sales[ProductKey] ),</strong>
                <strong class="calibre7">VALUES ( 'Product'[ProductKey] )</strong>
            <strong class="calibre7">),</strong>
            -- Disable the existing relationship between Sales and Product
            CROSSFILTER ( Sales[ProductKey], 'Product'[ProductKey], NONE )
        )
EVALUATE
ADDCOLUMNS (
    ALL ( 'Product'[Color] ),
    "Units", [Units]
)
ORDER BY 'Product'[Color]</pre></div>
<p class="edition">The function in the <em class="calibre5">Units</em> measure definition is equivalent to a relationship between <em class="calibre5">Sales</em> and <em class="calibre5">Product</em>. The resulting query plan is more complex than the previous one because there are many more operations in both the logical and the physical query plans. Without doing a dump of the complete query plan, which would be too long for a book, we can summarize the behavior of the query plan in these logical steps:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">Retrieves the list of <em class="calibre5">ProductKey</em> values for each product color.</p></li>
<li class="calibre25"><p class="listp">Sums the <em class="calibre5">Quantity</em> value for each <em class="calibre5">ProductKey</em>.</p></li>
<li class="calibre25"><p class="listp">For each color, aggregates the <em class="calibre5">Quantity</em> of the related <em class="calibre5">ProductKey</em> values.</p></li>
</ol>
<p class="edition">The FE executes four SE queries, as shown in <a href="#calibre_link-1527" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-25</a>.</p>
<figure id="calibre_link-1527" class="image-l">
<img src="images/000417.jpg" alt="The figure shows four SE queries." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-25</strong> SE queries executed for a DAX calculation using a virtual relationship with <em class="calibre5">INTERSECT</em>.</figcaption>
</figure>
<p class="edition">The following are the complete xmSQL statements of the four SE queries:</p>
<p class="codelink"><a href="#calibre_link-1528" id="calibre_link-2845" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
Sales[ProductKey]
FROM Sales;

<span type="pagebreak" id="calibre_link-2034"></span>SELECT
Product[Color]
FROM Product;

SELECT
Product[ProductKey], Product[Color]
FROM Product;

SELECT
Sales[ProductKey], SUM ( Sales[Quantity] )
FROM Sales
<strong class="calibre7">WHERE     Sales[ProductKey] IN ( 490, 479, 528, 379, 359, 332, 374, 597, 387,</strong>
                                 <strong class="calibre7">484..[158 total values, not all displayed] );</strong></pre></div>
<p class="edition">The <em class="calibre5">WHERE</em> condition highlighted in the last SE query might seem useless because the DAX query does not apply a filter over products. However, usually in the real world there are other filters active on products or other tables. The query plan tries to only extract the quantities sold of products that are relevant to the query, lowering the size of the datacache returned to the FE. When there are similar <em class="calibre5">WHERE</em> conditions in the SE, the only concern is the size of the corresponding bitmap index moved back and forth between the FE and the SE.</p>
<p class="edition">The FE has to group all the products belonging to each color. The performance of this join performed at the FE level mainly depends on the number of products and secondarily on the number of colors. Once again, the size of a datacache is the first and most important element to consider when we look for a performance bottleneck in the FE.</p>
<p class="edition">We considered the virtual relationship using <em class="calibre5">INTERSECT</em> for educational purposes. We wanted to display the SE queries required for a join condition resolved mainly by the FE. However, whenever possible, if a physical relationship is not available, <em class="calibre5">TREATAS</em> should be considered as a more optimized alternative. Consider this alternative implementation of the previous DAX query:</p>
<p class="codelink"><a href="#calibre_link-1529" id="calibre_link-2846" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Units] =
        CALCULATE (
            SUM ( Sales[Quantity] ),
            <strong class="calibre7">TREATAS (</strong>
                <strong class="calibre7">VALUES ( 'Product'[ProductKey] ),</strong>
                <strong class="calibre7">Sales[ProductKey]</strong>
            <strong class="calibre7">),</strong>
            -- Disable the existing relationship between Sales and Product
            CROSSFILTER ( Sales[ProductKey], 'Product'[ProductKey], NONE )
        )
EVALUATE
ADDCOLUMNS (
    ALL ( 'Product'[Color] ),
    "Units", [Units]
)
ORDER BY 'Product'[Color]</pre></div>
<p class="edition">As shown in <a href="#calibre_link-1530" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-26</a>, there are only three SE queries generated instead of four. Remember that <em class="calibre5">Batch</em> is just a recap of the previous <em class="calibre5">Scan</em> events. Moreover, the size of the datacaches is smaller <span type="pagebreak" id="calibre_link-2035"></span>because one result alone has 2,517 rows corresponding to the number of products in the <em class="calibre5">Product</em> table. In the previous implementation using <em class="calibre5">INTERSECT</em>, there were a larger number of queries returning thousands of rows. All of these datacaches must be consumed by the FE.</p>
<figure id="calibre_link-1530" class="image-l">
<img src="images/000425.jpg" alt="The figure shows three SE queries." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 19-26</strong> SE queries executed for a DAX calculation using a virtual relationship with <em class="calibre5">TREATAS</em>.</figcaption>
</figure>
<p class="edition">The following is the content of the <em class="calibre5">Batch</em> event at line 5, which includes the first two <em class="calibre5">Scan</em> events (lines 2 and 4):</p>
<p class="codelink"><a href="#calibre_link-1531" id="calibre_link-2847" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE TABLE '$TTable3' := SELECT
'Product'[ProductKey], 'Product'[Color]
FROM 'Product',

<strong class="calibre7">CREATE SHALLOW RELATION '$TRelation1' MANYTOMANY</strong>
<strong class="calibre7">FROM 'Sales'[ProductKey] TO '$TTable3'[Product$ProductKey],</strong>

DEFINE TABLE '$TTable1' := SELECT
    '$TTable3'[Product$Color],
    SUM ( '$TTable2'[$Measure0] )
FROM '$TTable2'
    INNER JOIN '$TTable3' ON '$TTable2'[Sales$ProductKey]='$TTable3'[Product$ProductKey]
REDUCED BY
'$TTable2' := SELECT
    'Sales'[ProductKey],
    SUM ( 'Sales'[Quantity] ) AS [$Measure0]
FROM 'Sales';</pre></div>
<p class="edition">The performance advantage of <em class="calibre5">TREATAS</em> is that it moves the execution of the operation to the SE, thanks to the <em class="calibre5">CREATE SHALLOW RELATION</em> statement highlighted in the previous code. This way, there is no need to materialize more data for the SE. Indeed, the join is executed within the FE, which reduces the number of lines of the physical query plan&mdash;from the 37 required by <em class="calibre5">INTERSECT</em> (not displayed in the book for brevity) to the 10 required by <em class="calibre5">TREATAS</em>. This results in a query plan very similar to the one shown in <a href="#calibre_link-1525" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 19-24</a>.</p>
<p class="edition">Analyzing complex and longer query plans would require another book, considering the length of the query plans involved. More details about the internals of the query plans are available in the white papers “Understanding DAX Query Plans” (<a href="http://www.sqlbi.com/articles/understanding-dax-query-plans/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://www.sqlbi.com/articles/understanding-dax-query-plans/</a>) and “Understanding Distinct Count in DAX Query Plans” (<a href="http://www.sqlbi.com/articles/understanding-distinct-count-in-dax-query-plans/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://www.sqlbi.com/articles/understanding-distinct-count-in-dax-query-plans/</a>).</p>
</section>
<section class="calibre4">
<h3 id="calibre_link-334" class="h2a"><span type="pagebreak" id="calibre_link-3234"></span>Conclusions</h3>
<p class="edition">As you have seen, diving into the complexity of query plans opens up a whole new world. In this chapter we barely scratched the surface of query plans, and a deeper analysis would require twice the size of this book. The good news is that in most&mdash;if not all&mdash;scenarios, going into more detail turns out to be useless.</p>
<p class="edition">An experienced DAX developer who aims to write optimal code should be able to focus their attention on the low-hanging fruit that can be discovered very quickly by looking at the most relevant parts of the query plan:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">In the physical query plan, the presence of a large number of rows scanned indicates the materialization of large datasets. This suggests that the query is memory-hungry and potentially slow.</p></li>
<li class="calibre10"><p class="listp">Most of the time, the VertiPaq queries include enough information to figure out the overall algorithm of the calculation. Whatever is not computed in a VertiPaq query, it must be computed by the formula engine. Knowing this enables you to get a clear idea of the whole query process.</p></li>
<li class="calibre10"><p class="listp"><em class="calibre5">CallbackDataID</em> presence indicates iterations at the row level where your code requires calculations that are too complex for VertiPaq storage engine. <em class="calibre5">CallbackDataIDs</em> by themselves are not totally bad. Nevertheless, removing them almost always results in better performance.</p></li>
<li class="calibre10"><p class="listp">VertiPaq and DirectQuery models are different. When using DirectQuery, the performance of DAX is strongly connected to the performance of the data source. It makes sense to use DirectQuery if and only if the underlying data source is specifically optimized for the kind of queries generated by the DirectQuery storage engine.</p></li>
</ul>
<p class="edition">In the next chapter, we are going to use the knowledge gained in this and previous chapters to provide a few guided optimization processes.</p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1532">
<div id="calibre_link-3235" class="calibre2">
<div id="calibre_link-3236" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-25"><span type="pagebreak" id="calibre_link-1971"></span><span class="pd_ash">Chapter 20</span><br class="calibre3" />Optimizing DAX</h2>
<p class="edition">This is the last chapter of the book, and it is time to use all the knowledge you have gained so far to explore the most fascinating DAX topic: optimizing formulas. You have learned how the DAX engines work, how to read a query plan, and the internals of the formula engine and of the storage engine. Now all the pieces are in place and you are ready to learn how to use that information to write faster code.</p>
<p class="edition">There is one very important warning before approaching this chapter. Do not expect to learn best practices or a simple way to write fast code. Simply stated: There is no way in DAX to write code that is always the fastest. The speed of a DAX formula depends on many factors, the most important of which unfortunately is not in the DAX code itself: It is data distribution. You have already learned that VertiPaq compression strongly depends on data distribution. The size of a column (hence, the speed to scan it) depends on its cardinality: the larger, the slower. Thus, the very same formula might behave differently when executed on one column or another.</p>
<p class="edition">You will learn how to measure the speed of a formula, and we will provide you with several examples where rewriting the expression differently leads to a faster execution time. Learn all these examples for what they are&mdash;examples that might help you in finding new ideas for your code. Do not take them as golden rules, because they are not.</p>
<p class="edition">We are not teaching you rules; we are trying to teach you how to find the best rules in the very specific scenario that is your data model. Be prepared to change them when the data model changes or when you approach a new scenario. Flexibility is key when optimizing DAX code: flexibility, a deep technical knowledge of the engine, and a good amount of creativity, to be prepared to test formulas and expressions that might be not so intuitive.</p>
<p class="edition">Finally, all the information we provide in this book is valid at the time of printing. New versions of the engine come on the market every month, and the development team is always working on improving the DAX engine. So be prepared to measure different numbers for the examples of the book in the version of the engine you will be running and be prepared to use different optimization methods if necessary. If one day you measure your code and reach the educated conclusion that “Marco and Alberto are wrong; this code runs much faster than their suggested code,” that will be our brightest day, because we will have been able to teach you all that we know, and you are moving forward in writing better DAX code than ours.</p>
<section class="calibre4">
<h3 id="calibre_link-335" class="h2a"><span type="pagebreak" id="calibre_link-1963"></span>Defining optimization strategies</h3>
<p class="edition">The optimization process for a DAX query, expression, or measure requires a strategy to reproduce a performance issue, identify the bottleneck, and remove it. Initially, you always observe a slowness in a complex query, but optimizing a complicated expression including several DAX measures is more involved than optimizing one measure at a time. For this reason, the approach we suggest is to isolate the slowest measure or expression first, and optimize it in a simpler query that reproduces the issue with a shorter query plan.</p>
<p class="edition">This is a simple to-do list you should follow every time you want to optimize DAX:</p>
<ol class="calibre24">
<li class="calibre25"><p class="listp">Identify a single DAX expression to optimize.</p></li>
<li class="calibre25"><p class="listp">Create a query that reproduces the issue.</p></li>
<li class="calibre25"><p class="listp">Analyze server timings and query plan information.</p></li>
<li class="calibre25"><p class="listp">Identify bottlenecks in the storage engine or formula engine.</p></li>
<li class="calibre25"><p class="listp">Implement changes and rerun the test query.</p></li>
</ol>
<p class="edition">You can see a more complete description of each of these steps in the following sections.</p>
<section class="calibre4">
<h4 id="calibre_link-336" class="calibre13">Identifying a single DAX expression to optimize</h4>
<p class="edition">If you have already found the slowest measure in your model, you probably can skip this section and move to the following one. However, it is common to get a performance issue in a report that might generate several queries. Each of these queries might include several measures. The first step is to identify a single DAX expression to optimize. Doing this, you reduce the reproduction steps to a single query and possibly to a single measure returned in the result.</p>
<p class="edition">A complete refresh of a report in Power BI or Reporting Services or of a Microsoft Excel workbook typically generates several queries in either DAX or MDX (PivotTables and charts in Excel always generate the latter). When a report generates several queries, you have to identify the slowest query first. In <a href="#calibre_link-24" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 19</a>, “<a href="#calibre_link-24" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Analyzing DAX query plans</a>,” you saw how DAX Studio can intercept all the queries sent to the DAX engine and identify the slowest query looking at the largest <em class="calibre5">Duration</em> amount.</p>
<p class="edition">If you are using Excel, you can also use a different technique to isolate a query. You can extract the MDX query it generates by using OLAP PivotTable Extensions, a free Excel add-in available at <a href="https://olappivottableextensions.github.io/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://olappivottableextensions.github.io/</a>.</p>
<p class="edition">Once you extract the slowest DAX or MDX query, you have to further restrict your focus and isolate the DAX expression that is causing the slowness. This way, you will concentrate your efforts on the right area. You can reduce the measures included in a query by modifying and executing the query interactively in DAX Studio.</p>
<p class="edition">For example, consider the following table result in Power BI with four expressions (two distinct counts and two measures) grouped by product brand, as shown in <a href="#calibre_link-1533" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-1</a>.</p>
<figure id="calibre_link-1533" class="image-l">
<img src="images/000406.jpg" alt="This table returns four values per brand." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3237"></span><strong class="calibre7">Figure 20-1</strong> Simple visualization in Power BI generated by a DAX query with four expressions.</figcaption>
</figure>
<p class="edition">The report generates the following DAX query, captured by using DAX Studio:</p>
<p class="codelink"><a href="#calibre_link-1534" id="calibre_link-2849" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL ( 'Product'[Brand], "IsGrandTotalRowTotal" ),
        "DistinctCountProductKey", CALCULATE (
            DISTINCTCOUNT ( 'Product'[ProductKey] )
        ),
        "Sales_Amount", 'Sales'[Sales Amount],
        "Margin__", 'Sales'[Margin %],
        "DistinctCountOrder_Number", CALCULATE (
            DISTINCTCOUNT ( 'Sales'[Order Number] )
        )
    ),
    [IsGrandTotalRowTotal], 0,
    'Product'[Brand], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Product'[Brand]</pre></div>
<p class="edition">You should reduce the query by trying one calculation at a time, to locate the slowest one. If you can manipulate the report, you might just include one calculation at a time. By accessing the DAX code, it is enough to comment or remove three of the four columns calculated in the <em class="calibre5">SUMMARIZECOLUMNS</em> function (<em class="calibre5">DistinctCountProductKey</em>, <em class="calibre5">Sales_Amount</em>, <em class="calibre5">Margin__</em>, and <em class="calibre5">DistinctCountOrder_Number</em>), finding the slowest one before proceeding. In this case, the most expensive calculation is the last one. The following query takes up 80% of the time required to compute the original query, meaning that the distinct count over <em class="calibre5">Sales[Order Number]</em> is the most expensive operation in the entire report:</p>
<p class="codelink"><a href="#calibre_link-1535" id="calibre_link-2850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL ( 'Product'[Brand], "IsGrandTotalRowTotal" ),
<span type="pagebreak" id="calibre_link-3238"></span>//        "DistinctCountProductKey", CALCULATE (
//            DISTINCTCOUNT ( 'Product'[ProductKey] )
//        ),
//        "Sales_Amount", 'Sales'[Sales Amount],
//        "Margin__", 'Sales'[Margin %],
        <strong class="calibre7">"DistinctCountOrder_Number", CALCULATE (</strong>
            <strong class="calibre7">DISTINCTCOUNT ( 'Sales'[Order Number] )</strong>
        <strong class="calibre7">)</strong>
    ),
    [IsGrandTotalRowTotal], 0,
    'Product'[Brand], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Product'[Brand]</pre></div>
<p class="edition">Another example is the following MDX query generated by the pivot table in Excel as seen in <a href="#calibre_link-1536" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-2</a>:</p>
<p class="codelink"><a href="#calibre_link-1537" id="calibre_link-2851" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT {
    [Measures].[Sales Amount],
    [Measures].[Total Cost],
    [Measures].[Margin],
    [Measures].[Margin %]
  } DIMENSION PROPERTIES PARENT_UNIQUE_NAME, HIERARCHY_UNIQUE_NAME ON COLUMNS,
NON EMPTY HIERARCHIZE(
    DRILLDOWNMEMBER(
        { { DRILLDOWNMEMBER(
                { { DRILLDOWNLEVEL(
                        { [Date].[Calendar].[All] },,, include_calc_members )
                } },
            { [Date].[Calendar].[Year].&amp;[CY 2008] },,, include_calc_members )
        } },
        { [Date].[Calendar].[Quarter].&amp;[Q4-2008] },,, include_calc_members
    )
)
DIMENSION PROPERTIES PARENT_UNIQUE_NAME,HIERARCHY_UNIQUE_NAME ON ROWS
FROM [Model]
CELL PROPERTIES VALUE, FORMAT_STRING, LANGUAGE, BACK_COLOR, FORE_COLOR, FONT_FLAGS</pre></div>
<figure id="calibre_link-1536" class="image-l">
<img src="images/000252.jpg" alt="This pivot table in Excel shows Sales Amount, Total Cost, Margin, and Margin% per time period." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-2</strong> Simple pivot table in Excel that generates an MDX query with four measures.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1964"></span>You can reduce the measures either in the pivot table or directly in the MDX code. You can manipulate the MDX code by reducing the list of measures in braces. For example, you reduce the code to only the <em class="calibre5">Sales Amount</em> measure by modifying the list, as in the following initial part of the query:</p>
<p class="codelink"><a href="#calibre_link-1538" id="calibre_link-2852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
<strong class="calibre7">{ [Measures].[Sales Amount] }</strong>
DIMENSION PROPERTIES PARENT_UNIQUE_NAME, HIERARCHY_UNIQUE_NAME ON COLUMNS,
...</pre></div>
<p class="edition">Regardless of the technique you use, once you identify the DAX expression (or measure) that is responsible for a performance issue, you need a reproduction query to use in DAX Studio.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-337" class="calibre13">Creating a reproduction query</h4>
<p class="edition">The optimization process requires a query that you can execute several times, possibly changing the definition of the measure in order to evaluate different levels of performance.</p>
<p class="edition">If you captured a query in DAX or MDX, you already have a good starting point for the reproduction (repro) query. You should try to simplify the query as much as you can, so that it becomes easier to find the bottleneck. You should only keep a complex query structure when it is fundamental in order to observe the performance issue.</p>
<section class="calibre4">
<h5 id="calibre_link-3239" class="calibre13">Creating a reproduction query in DAX</h5>
<p class="edition">When a measure is constantly slow, you should be able to create a repro query producing a single value as a result. Using <em class="calibre5">CALCULATE</em> or <em class="calibre5">CALCULATETABLE</em>, you can apply all the filters you need. For example, you can execute the <em class="calibre5">Sales Amount</em> measure for November 2008 using the following code, obtaining the same result ($96,777,975.30) you see in <a href="#calibre_link-1536" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-2</a> for that month:</p>
<p class="codelink"><a href="#calibre_link-1539" id="calibre_link-2853" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
{
    CALCULATE (
        [Sales Amount],
        'Date'[Calendar Year] = "CY 2008",
        'Date'[Calendar Year Quarter] = "Q4-2008",
        'Date'[Calendar Year Month] = "November 2008"
    )
}</pre></div>
<p class="edition">You can also write the previous query using <em class="calibre5">CALCULATETABLE</em> instead of <em class="calibre5">CALCULATE</em>:</p>
<p class="codelink"><a href="#calibre_link-1540" id="calibre_link-2854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">EVALUATE
CALCULATETABLE (
    { [Sales Amount] },
    'Date'[Calendar Year] = "CY 2008",
    'Date'[Calendar Year Quarter] = "Q4-2008",
    'Date'[Calendar Year Month] = "November 2008"
)</pre></div>
<p class="edition">The two approaches produce the same result. You should consider <em class="calibre5">CALCULATETABLE</em> when the query you use to test the measure is more complex than a simple table constructor.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-1976"></span>Once you have a repro query for a specific measure defined in the data model, you should consider writing the DAX expression of the measure as local in the query, using the <em class="calibre5">MEASURE</em> syntax. For example, you can transform the previous repro query into the following one:</p>
<p class="codelink"><a href="#calibre_link-1541" id="calibre_link-2855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Sales Amount] =
        SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
EVALUATE
CALCULATETABLE (
    { [Sales Amount] },
    'Date'[Calendar Year] = "CY 2008",
    'Date'[Calendar Year Quarter] = "Q4-2008",
    'Date'[Calendar Year Month] = "November 2008"
)</pre></div>
<p class="edition">At this point, you can apply changes to the DAX expression assigned to the measure directly into the query statement. This way, you do not have to deploy a change to the data model before executing the query again. You can change the query, clear the cache, and run the query in DAX Studio, immediately measuring the performance results of the modified expression.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-3240" class="calibre13">Creating query measures with DAX Studio</h5>
<p class="edition">DAX Studio can generate the <em class="calibre5">MEASURE</em> syntax for a measure defined in the model by using the Define Measure context menu item. The latter is available by selecting a measure in the Metadata pane, as shown in <a href="#calibre_link-1542" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-3</a>.</p>
<figure id="calibre_link-1542" class="image-l">
<img src="images/000446.jpg" alt="In this figure we see a screenshot of what comes up when we click on a measure in the metadata pane." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-3</strong> Screenshot of how a user would access the “Define Measure” menu item.</figcaption>
</figure>
<p class="edition">If a measure references other measures, all of them should be included as query measures in order to consider any possible change to the repro query. The Define Dependent Measures feature includes the definition of all the measures that are referenced by the selected measure, whereas Define and Expand Measure replaces any measure reference with the corresponding measure expression. For example, consider the following query that just evaluates the <em class="calibre5">Margin %</em> measure:</p>
<div class="program"><pre class="calibre14">EVALUATE
{ [Margin %] }</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1995"></span>By clicking Define Measure on <em class="calibre5">Margin %</em>, you get the following code, where there are two other references to <em class="calibre5">Sales Amount</em> and <em class="calibre5">Margin</em> measures:</p>
<p class="codelink"><a href="#calibre_link-1543" id="calibre_link-2856" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Margin %] =
        DIVIDE ( [Margin], [Sales Amount] )
EVALUATE
{ [Margin %] }</pre></div>
<p class="edition">Instead of repeating the Define Measure action on all the other measures, you can click on Define Dependent Measures on <em class="calibre5">Margin %</em>, obtaining the definition of all the other measures required; this includes <em class="calibre5">Total Cost</em>, which is used in the <em class="calibre5">Margin</em> definition:</p>
<p class="codelink"><a href="#calibre_link-1544" id="calibre_link-2857" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Margin] = [Sales Amount] - [Total Cost]
    MEASURE Sales[Sales Amount] =
        SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )
    MEASURE Sales[Total Cost] =
        SUMX ( Sales, Sales[Quantity] * Sales[Unit Cost] )
    MEASURE Sales[Margin %] =
        DIVIDE ( [Margin], [Sales Amount] )
EVALUATE
{ [Margin %] }</pre></div>
<p class="edition">You can also obtain a single DAX expression without measure references by clicking Define and Expand Measure on <em class="calibre5">Margin %</em>:</p>
<p class="codelink"><a href="#calibre_link-1545" id="calibre_link-2858" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Margin %] =
        DIVIDE (
            CALCULATE (
                CALCULATE ( SUMX ( Sales, Sales[Quantity] * Sales[Net Price] ) )
                    - CALCULATE ( SUMX ( Sales, Sales[Quantity] * Sales[Unit Cost] ) )
            ),
            CALCULATE ( SUMX ( Sales, Sales[Quantity] * Sales[Net Price] ) )
        )
EVALUATE
{ [Margin %] }</pre></div>
<p class="edition">This latter technique can be useful to quickly evaluate whether a measure includes nested iterators or not, though it could generate very verbose results.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-3241" class="calibre13">Creating a reproduction query in MDX</h5>
<p class="edition">In certain conditions, you have to use an MDX query to reproduce a problem that only happens in MDX and not in DAX. The same DAX measure, executed in a DAX or in an MDX query, generates different query plans; it might display a different behavior depending on the language of the query. However in <span type="pagebreak" id="calibre_link-1972"></span>this case too, you can define the DAX measure local to the query. That way, it is more efficient to edit and run again. For instance, you can define the <em class="calibre5">Sales Amount</em> measure local to the MDX query using the <em class="calibre5">WITH MEASURE</em> syntax:</p>
<p class="codelink"><a href="#calibre_link-1546" id="calibre_link-2859" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
     MEASURE Sales[Sales Amount] = SUMX ( Sales, Sales[Quantity] * Sales[Unit Price] )
SELECT {
    [Measures].[Sales Amount],
    [Measures].[Total Cost],
    [Measures].[Margin],
    [Measures].[Margin %]
  } DIMENSION PROPERTIES PARENT_UNIQUE_NAME, HIERARCHY_UNIQUE_NAME ON COLUMNS,
NON EMPTY HIERARCHIZE(
    DRILLDOWNMEMBER(
        { { DRILLDOWNMEMBER(
                { { DRILLDOWNLEVEL(
                        { [Date].[Calendar].[All] },,, include_calc_members )
                } },
            { [Date].[Calendar].[Year].&amp;[CY 2008] },,, include_calc_members )
        } },
        { [Date].[Calendar].[Quarter].&amp;[Q4-2008] },,, include_calc_members
    )
)
DIMENSION PROPERTIES PARENT_UNIQUE_NAME,HIERARCHY_UNIQUE_NAME ON ROWS
FROM [Model]
CELL PROPERTIES VALUE, FORMAT_STRING, LANGUAGE, BACK_COLOR, FORE_COLOR, FONT_FLAGS</pre></div>
<p class="edition">As you see, in MDX you must use <em class="calibre5">WITH</em> instead of <em class="calibre5">DEFINE</em>, which is how you can rename the syntax generated by DAX Studio if you optimize an MDX query. The syntax after <em class="calibre5">MEASURE</em> is always DAX code, so you will follow the same optimization process for an MDX query. Regardless of the repro query language (either DAX or MDX), you always have a DAX expression to optimize, which you can define within a local <em class="calibre5">MEASURE</em> definition.</p>
</section>
</section>
<section class="calibre4">
<h4 id="calibre_link-338" class="calibre13">Analyzing server timings and query plan information</h4>
<p class="edition">Once you have a repro query, you run it and collect information about execution time and query plan. You saw in <a href="#calibre_link-24" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 19</a> how to read the information provided by DAX Studio or SQL Server Profiler. In this section, we recap the steps required to analyze a simple query in DAX Studio.</p>
<p class="edition">For example, consider the following DAX query:</p>
<p class="codelink"><a href="#calibre_link-1547" id="calibre_link-2860" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Sales Amount] =
        SUMX ( Sales, Sales[Quantity] * Sales[Unit Price] )
EVALUATE
ADDCOLUMNS (
    VALUES ( 'Date'[Calendar Year] ),
    "Result", [Sales Amount]
)</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3242"></span>If you execute this query in DAX Studio after clearing the cache and enabling Query Plan and Server Timings, you obtain a result with one row for each year in the <em class="calibre5">Date</em> table, and the total of <em class="calibre5">Sales Amount</em> for sales made in that year. The starting point for an analysis is always the Server Timings pane, which displays information about the entire query, as shown in <a href="#calibre_link-1548" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-4</a>.</p>
<figure id="calibre_link-1548" class="image-l">
<img src="images/000467.jpg" alt="The figure shows the Server Timings pane." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-4</strong> Server Timings pane after a simple query execution.</figcaption>
</figure>
<p class="edition">Our query returned the result in 25 ms (<em class="calibre5">Total</em>), and it spent 72 percent of this time in the storage engine (<em class="calibre5">SE</em>), whereas the formula engine (<em class="calibre5">FE</em>) only used up 7 ms of the total time. This pane does not provide much information about the formula engine internals, but it is rich in details on storage engine activity. For example, there were two storage engine queries (<em class="calibre5">SE Queries</em>) that consumed a total of 94 ms of processing time (<em class="calibre5">SE CPU</em>). The <em class="calibre5">CPU</em> time can be larger than <em class="calibre5">Duration</em> thanks to the parallelism of the storage engine. Indeed, the engine used 94 ms of logical processors working in parallel, so that the duration time is a fraction of that number. The hardware used in this test had 8 logical processors, and the parallelism degree of this query (ratio between <em class="calibre5">SE CPU</em> and <em class="calibre5">SE</em>) is 5.2. The parallelism cannot be higher than the number of logical processors you have.</p>
<p class="edition">The storage engine queries are available in the list, and you can see that a single storage engine operation (the first one) consumes the entire duration and <em class="calibre5">CPU</em> time. By enabling the display of <em class="calibre5">Internal</em> and <em class="calibre5">Cache</em> subclass events, you can see in <a href="#calibre_link-1549" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-5</a> that the two storage engine queries were actually executed by the storage engine.</p>
<figure id="calibre_link-1549" class="image-l">
<img src="images/000460.jpg" alt="In this figure the internal subclass events are visible." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-5</strong> Server Timings pane with internal subclass events visible.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3243"></span>If you execute the same query again without clearing the cache, you see the results in <a href="#calibre_link-1550" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-6</a>. Both storage engine queries retrieved the values from the cache (<em class="calibre5">SE cache</em>), and the storage engine queries resolved in the cache are visible in the <em class="calibre5">Subclass</em> column.</p>
<figure id="calibre_link-1550" class="image-l">
<img src="images/000482.jpg" alt="This figure shows the Server Timings pane if the user does not clear the cache." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-6</strong> Server Timings pane with cache subclass events visible, after second execution of the same DAX query.</figcaption>
</figure>
<p class="edition">Usually, we will use the repro query with a cold cache (clearing the cache before the execution), but in some cases it is important to evaluate whether a given DAX expression can leverage the cache in an upcoming request or not. For this reason, the <em class="calibre5">Cache</em> visualization in DAX Studio is disabled by default, and you enable it on demand.</p>
<p class="edition">At this point, you can start looking at the query plans. In <a href="#calibre_link-1551" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-7</a> you see the physical and logical query plans of the query used in the previous example.</p>
<figure id="calibre_link-1551" class="image-l">
<img src="images/000475.jpg" alt="This figure shows the physical and logical query plans." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-1767"></span><strong class="calibre7">Figure 20-7</strong> Query Plan pane showing physical and logical query plans.</figcaption>
</figure>
<p class="edition">The physical query plan is the one you will use more often. In the query of the previous example, there are two datacaches&mdash;one for each storage engine query. Every <em class="calibre5">Cache</em> row in the physical query plan consumes one of the datacaches available. However, there is no simple way to match the correspondence between a query plan operation and a datacache. You can infer the datacache by looking at the columns used in the operations requiring a <em class="calibre5">Cache</em> result (the <em class="calibre5">Spool_Iterator</em> and <em class="calibre5">SpoolLookup</em> rows, in <a href="#calibre_link-1551" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-7</a>).</p>
<p class="edition">An important piece of information available in the physical query plan is the column showing the number of records processed. As you will see, when optimizing bottlenecks in the formula engine, it might be useful to identify the slowest operation in the formula engine by searching for the line with the largest number of records. You can sort the rows by clicking the <em class="calibre5">Records</em> column header, as you see in <a href="#calibre_link-1552" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-8</a>. You restore the original sort order by clicking the <em class="calibre5">Line</em> column header.</p>
<figure id="calibre_link-1552" class="image-l">
<img src="images/000497.jpg" alt="This figure shows the physical and logical query plans." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-8</strong> Steps in physical query plan sorted by <em class="calibre5">Records</em> column.</figcaption>
</figure>
</section>
<section class="calibre4">
<h4 id="calibre_link-339" class="calibre13">Identifying bottlenecks in the storage engine or formula engine</h4>
<p class="edition">There are many possible optimizations usually available for any query. The first and most important step is to identify whether a query spends most of the time in the formula engine or in the storage engine. A first indication is available in the percentages provided by DAX Studio for FE and SE. Usually, this is a good starting point, but you also have to identify the distribution of the workload in both the formula engine and the storage engine. In complex queries, a large amount of time spent in the storage engine might correspond to a large number of small storage engine queries or to a small number of storage engine queries that concentrate the most of the workload. As you will see, these differences require different approaches in your optimization strategy.</p>
<p class="edition">When you identify the execution bottleneck of a query, you should also prioritize the optimization areas. For example, there might be different inefficiencies in the query plan resulting in a large formula engine execution time. You should identify the most important inefficiency and concentrate on that first. If you do not follow this approach, you might end up spending time optimizing an expression that only marginally affects the execution time. Sometimes the more efficient optimizations are simple but hidden in counterintuitive context transitions or in other details of the DAX syntax. You should always measure the execution time before and after each optimization attempt, making sure that you obtain a <span type="pagebreak" id="calibre_link-1768"></span>real advantage and that you are not just applying some optimization pattern you found on the web or in this book without any real benefit.</p>
<p class="edition">Finally, remember that even if you have an issue in the formula engine, you should always start your analysis by looking at the storage engine queries. They provide valuable information about the content and size of the datacaches used by the formula engine. Reading the query plan that describes the operations made by the formula engine is a very complex process. It is easier to consider that the formula engine will use the content of datacaches and will have to do all the operations required to produce the result of a DAX query that has not already been produced by the storage engine. This approach is especially efficient for large and complex DAX queries. Indeed, these might generate thousands of lines in a query plan, but a relatively small number of datacaches produced by storage engine queries.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-340" class="calibre13">Implementing changes and rerunning the test query</h4>
<p class="edition">Once the bottlenecks have been identified, the next step is to change the DAX expressions and/or the data model, so that the query plan is more efficient. Running the test query again, it is possible to verify that the improvement is effective, starting the search for the next bottleneck and continuing the loop restarting at the step “<a href="#calibre_link-338" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Analyzing server timings and query plan information</a>.” This process will continue until the performance is optimal or there are no further possible improvements that are worth the effort.</p>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-341" class="h2a">Optimizing bottlenecks in DAX expressions</h3>
<p class="edition">A longer execution time in the storage engine is usually the consequence of one or more of the following causes (explained in more detail in <a href="#calibre_link-24" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 19</a>):</p>
<ul class="sq">
<li class="calibre10"><p class="listp"><strong class="calibre7">Longer scan time.</strong> Even for a simple aggregation, a DAX query must scan one or more columns. The cost for this scan depends on the size of the column, which depends on the number of unique values and on the data distribution. Different columns in the same table can have very different execution times.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Large cardinality.</strong> A large number of unique values in a column affects the <em class="calibre5">DISTINCTCOUNT</em> calculation and the filter arguments of the <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em> functions. A large cardinality can also affect the scan time of a column, but it could be an issue by itself regardless of the column data size.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">High frequency of <em class="calibre5">CallbackDataID</em>.</strong> A large number of calls made by the storage engine to the formula engine can affect the overall performance of a query.</p></li>
<li class="calibre10"><p class="listp"><strong class="calibre7">Large materialization.</strong> If a storage engine query produces a large datacache, its generation requires time (allocating and writing RAM). Moreover, its consumption (by the formula engine) is also another potential bottleneck.</p></li>
</ul>
<p class="edition">In the following sections, you will see several examples of optimization. Starting with the concepts you learned in previous chapters, you will see a typical problem reproduced in a simpler query and optimized.</p>
<section class="calibre4">
<h4 id="calibre_link-342" class="calibre13"><span type="pagebreak" id="calibre_link-3244"></span>Optimizing filter conditions</h4>
<p class="edition">Whenever possible, a filter argument of a <em class="calibre5">CALCULATE</em>/<em class="calibre5">CALCULATETABLE</em> function should always filter columns rather than tables. The DAX engine has improved over the years, and several simple table filters are relatively well optimized in 2019 or newer engine versions. However, expressing a filter condition by columns rather than by tables is always a best practice.</p>
<p class="edition">For example, consider the report in <a href="#calibre_link-1553" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-9</a> that compares the total of <em class="calibre5">Sales Amount</em> with the sum of the sales transactions larger than $1,000 (<em class="calibre5">Big Sales Amount</em>) for each product brand.</p>
<figure id="calibre_link-1553" class="image-l">
<img src="images/000490.jpg" alt="This figure shows Sales Amount and Big Sales Amount per Brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-9</strong> <em class="calibre5">Sales Amount</em> and <em class="calibre5">Big Sales Amount</em> reported by product brand.</figcaption>
</figure>
<p class="edition">Because the filter condition in the <em class="calibre5">Big Sales Amount</em> measure requires two columns, a trivial way to define the filter is by using a filter over the <em class="calibre5">Sales</em> table. The following query computes just the <em class="calibre5">Big Sales Amount</em> measure in the previous report, generating the server timings results visible in <a href="#calibre_link-1554" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-10</a>:</p>
<p class="codelink"><a href="#calibre_link-1555" id="calibre_link-2861" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Big Sales Amount (slow)] =
        CALCULATE (
            [Sales Amount],
            FILTER (
                <strong class="calibre7">Sales,</strong>
                Sales[Quantity] * Sales[Net Price] &gt; 1000
            )
        )
EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL ( 'Product'[Brand], "IsGrandTotalRowTotal" ),
    "Big_Sales_Amount", 'Sales'[Big Sales Amount (slow)]
)</pre></div>
<figure id="calibre_link-1554" class="image-l">
<img src="images/000511.jpg" alt="The figure shows the Server Timings." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-10</strong> Server Timings running the query for the <em class="calibre5">Big Sales Amount (slow)</em> measure.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3245"></span>Because <em class="calibre5">FILTER</em> is iterating a table, this query is generating a larger datacache than necessary. The result in <a href="#calibre_link-1553" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-9</a> only displays 11 brands and one additional row for the grand total. Nevertheless, the query plan estimates that the first two datacaches return 3,937 rows, which is the same number as reported also in the Query Plan pane visible in <a href="#calibre_link-1556" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-11</a>.</p>
<figure id="calibre_link-1556" class="image-l">
<img src="images/000504.jpg" alt="This figure shows the physical query plan." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-11</strong> Query Plan pane running the query for <em class="calibre5">Big Sales Amount (slow)</em> measure.</figcaption>
</figure>
<p class="edition">The formula engine receives a much larger datacache than the one required for the query result because there are two additional columns. Indeed, the xmSQL query at line 2 is the following:</p>
<p class="codelink"><a href="#calibre_link-1557" id="calibre_link-2862" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                  * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )
SELECT
    <strong class="calibre7">'DaxBook Product'[Brand],</strong>
    <strong class="calibre7">'DaxBook Sales'[Quantity],</strong>
    <strong class="calibre7">'DaxBook Sales'[Net Price],</strong>
    SUM ( @$Expr0 )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey]
WHERE
  ( COALESCE (  ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
    * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )  ) &gt; COALESCE ( 1000.000000 ) );</pre></div>
<p class="edition">The structure of the xmSQL query at line 4 in <a href="#calibre_link-1554" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-10</a> is similar to the previous one, just without the <em class="calibre5">SUM</em> aggregation. The presence of a table filter in <em class="calibre5">CALCULATE</em> results in this side effect in the query plan because the semantic of the filter includes all the columns of the <em class="calibre5">Sales</em> expanded table (expanded tables are described in <a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 14</a>, “<a href="#calibre_link-19" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Advanced DAX concepts</a>”).</p>
<p class="edition">The optimization of the measure only requires a column filter. Because the filter expression uses two columns, a row context requires a table with just those two columns to produce a corresponding and more efficient filter argument to <em class="calibre5">CALCULATE</em>. The following query implements the columns filter adding <em class="calibre5">KEEPFILTERS</em> to keep the same semantic as the previous version, generating the server timings results visible in <a href="#calibre_link-1558" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-12</a>:</p>
<p class="codelink"><a href="#calibre_link-1559" id="calibre_link-2863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-3246"></span>DEFINE
    MEASURE Sales[Big Sales Amount (fast)] =
        CALCULATE (
            [Sales Amount],
            <strong class="calibre7">KEEPFILTERS (</strong>
                FILTER (
                    <strong class="calibre7">ALL (</strong>
                        <strong class="calibre7">Sales[Quantity],</strong>
                        <strong class="calibre7">Sales[Net Price]</strong>
                    <strong class="calibre7">),</strong>
                    Sales[Quantity] * Sales[Net Price] &gt; 1000
                )
            <strong class="calibre7">)</strong>
        )
EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL ( 'Product'[Brand], "IsGrandTotalRowTotal" ),
    "Big_Sales_Amount", 'Sales'[Big Sales Amount (fast)]
)</pre></div>
<figure id="calibre_link-1558" class="image-l">
<img src="images/000525.jpg" alt="The figure displays the Server Timings." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-12</strong> Server Timings when running the query for the <em class="calibre5">Big Sales Amount (fast)</em> measure.</figcaption>
</figure>
<p class="edition">The DAX query runs faster, but what is more important is that there is only one datacache for the rows of the result, excluding the grand total, which still has a separate xmSQL query. The materialization of the datacache at line 2 in <a href="#calibre_link-1558" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-12</a> only returns 14 estimated rows, when there are only 11 in the actual count visible in the Query Plan pane in <a href="#calibre_link-1560" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-13</a>.</p>
<figure id="calibre_link-1560" class="image-l">
<img src="images/000518.jpg" alt="The figure displays the query plan for Big Sales Amount (fast)." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-13</strong> Query Plan pane running the query for <em class="calibre5">Big Sales Amount (fast)</em> measure.</figcaption>
</figure>
<p class="edition">The reason for this optimization is that the query plan can create a much more efficient calculation in the storage engine without returning additional data to the formula engine because of the semantic required by a table filter. The following is the xmSQL query at line 2 in <a href="#calibre_link-1558" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-12</a>:</p>
<p class="codelink"><a href="#calibre_link-1561" id="calibre_link-2864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-1903"></span>WITH
    $Expr0 := ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                  * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )
SELECT
    <strong class="calibre7">'DaxBook Product'[Brand],</strong>
    SUM ( @$Expr0 )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey]
WHERE
  ( COALESCE (  ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
    * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )  ) &gt; COALESCE ( 1000.000000 ) );</pre></div>
<p class="edition">The datacache no longer includes the <em class="calibre5">Quantity</em> and <em class="calibre5">Net Price</em> columns, and its cardinality corresponds to the cardinality of the DAX result. This is an ideal condition for minimal materialization. Keeping the filter conditions using columns rather than tables is an important effort to achieve this goal.</p>
<p class="edition">The important takeaway of this section is that you should always pay attention to the rows returned by storage engine queries. When their number is much bigger than the rows included in the result of a DAX query, there might be some overhead caused by the additional work performed by the storage engine to materialize datacaches and by the formula engine to consume such datacaches. Table filters are one of the most common reasons for excessive materialization, though they are not always responsible for bad performance.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">When you write a DAX filter, consider the cardinality of the resulting filter. If the cardinality using a table filter is identical to a column filter and the table filter does not expand to other tables, then the table filter can be used safely. For example, there is not usually much difference between filtering a <em class="calibre5">Date</em> table versus the <em class="calibre5">Date[Date]</em> column.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-343" class="calibre13">Optimizing context transitions</h4>
<p class="edition">The storage engine can only compute simple aggregations and simple grouping over columns of the model. Anything else must be computed by the formula engine. Every time there is an iteration and a corresponding context transition, the storage engine materializes a datacache at the granularity level of the iterated table. If the expression computed during the iteration is simple enough to be solved by the storage engine, the performance is typically good. Otherwise, if the expression is too complex, a large materialization and/or a <em class="calibre5">CallbackDataID</em> might occur as we demonstrate in the following example. In these scenarios, simplifying the code by reducing the number of context transitions and by reducing the granularity of the iterated table greatly helps in improving performance. For example, consider a <em class="calibre5">Cashback</em> measure that multiplies the <em class="calibre5">Sales Amount</em> by the <em class="calibre5">Cashback %</em> attribute assigned to each <em class="calibre5">Customer</em> based on an algorithm defined by the marketing department. The report in <a href="#calibre_link-1562" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-14</a> displays the <em class="calibre5">Cashback</em> amount for each country.</p>
<figure id="calibre_link-1562" class="image-l">
<img src="images/000539.jpg" alt="The report displays the Cashback amount for each country." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3247"></span><strong class="calibre7">Figure 20-14</strong> <em class="calibre5">Cashback</em> reported by customer country.</figcaption>
</figure>
<p class="edition">The easiest and most intuitive way to create the <em class="calibre5">Cashback</em> measure is also the slowest, which multiplies the <em class="calibre5">Cashback %</em> by the <em class="calibre5">Sales Amount</em> for each customer, summing the result. The following query computes the slowest <em class="calibre5">Cashback</em> measure in the previous report, generating the server timings results visible in <a href="#calibre_link-1563" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-15</a>:</p>
<p class="codelink"><a href="#calibre_link-1564" id="calibre_link-2865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Cashback (slow)] =
        SUMX (
            Customer,
            [Sales Amount] * Customer[Cashback %]
        )
EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL ( 'Customer'[Country], "IsGrandTotalRowTotal" ),
    "Cashback", 'Sales'[Cashback (slow)]
)</pre></div>
<figure id="calibre_link-1563" class="image-l">
<img src="images/000532.jpg" alt="The figure shows the Server Timings." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-15</strong> Server Timings running the query for the <em class="calibre5">Cashback (slow)</em> measure reported by country.</figcaption>
</figure>
<p class="edition">The queries at lines 2 and 4 of <a href="#calibre_link-1563" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-15</a> compute the result at the <em class="calibre5">Country</em> level, whereas the queries at lines 6 and 8 run the same task for the grand total. We will focus exclusively on the first two storage engine queries. In order to check whether the estimation for the rows materialized is correct, you can look at the query plan in <a href="#calibre_link-1565" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-16</a>. This could be surprising, because it seems that a few storage engine queries are not used at all.</p>
<figure id="calibre_link-1565" class="image-l">
<img src="images/000554.jpg" alt="The figure displays the query plan for Cashback (slow)." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3248"></span><strong class="calibre7">Figure 20-16</strong> Query Plan pane running the query for the <em class="calibre5">Cashback (slow)</em> measure reported by country.</figcaption>
</figure>
<p class="edition">The query plan in <a href="#calibre_link-1565" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-16</a> only reports two <em class="calibre5">Cache</em> nodes, which correspond to lines 4 and 8 of the Server Timings pane in <a href="#calibre_link-1563" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-15</a>. This is another example of why looking at the query plan could be confusing. The formula engine is actually doing some other work, but the execution within a <em class="calibre5">CallbackDataID</em> is not always reported in the query plan, and this is one of those cases. This is the xmSQL query at line 4 of <a href="#calibre_link-1563" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-15</a>, which returns 29 effective rows instead of the estimated 32:</p>
<p class="codelink"><a href="#calibre_link-1566" id="calibre_link-2866" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := ( <strong class="calibre7">[CallbackDataID ( SUMX ( Sales, Sales[Quantity]] * Sales[Net Price]] ) )</strong>
                   <strong class="calibre7">]</strong> ( PFDATAID ( 'DaxBook Customer'[CustomerKey] ) )
                * PFCAST ( 'DaxBook Customer'[Cashback %] AS  REAL )  )
SELECT
    'DaxBook Customer'[Country],
    SUM ( @$Expr0 )
FROM 'DaxBook Customer';</pre></div>
<p class="edition">The DAX code passed to <em class="calibre5">CallbackDataID</em> must be computed for each customer by the formula engine, which receives the <em class="calibre5">CustomerKey</em> as argument. You can see the additional storage engine queries, but the corresponding query plan is not visible in this case. Therefore, we can only imagine what the query plan does by looking at the other storage engine query at line 2 of <a href="#calibre_link-1563" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-15</a>:</p>
<p class="codelink"><a href="#calibre_link-1567" id="calibre_link-2867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
              * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )
SELECT
    'DaxBook Customer'[CustomerKey],
    SUM ( @$Expr0 )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Customer'
        ON 'DaxBook Sales'[CustomerKey]='DaxBook Customer'[CustomerKey];</pre></div>
<p class="edition">The result of this xmSQL query only contains two columns: the <em class="calibre5">CustomerKey</em> and the result of the <em class="calibre5">Sales Amount</em> measure for that customer. Thus, the formula engine uses the result of this query to provide a result to the <em class="calibre5">CallbackDataID</em> request of the former query.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3249"></span>Once again, instead of trying to describe the exact sequence of operations performed by the engine, it is easier to analyze the result of the storage engine queries, checking whether the materialization is larger than what is required for the query result. In this case the answer is yes: the DAX query returns only 6 visible countries, whereas a total of 29 countries were computed by the formula engine. In any case, there is a huge difference with the materialization of 18,872 customers produced by the latter xmSQL query analyzed. Is it possible to push more workload to the storage engine, aggregating the data by country instead of by customer? The answer is yes, by reducing the number of context transitions. Consider the original <em class="calibre5">Cashback</em> measure: the expression executed in the row context depends on a single column of the <em class="calibre5">Customer</em> table (<em class="calibre5">Cashback %</em>):</p>
<p class="codelink"><a href="#calibre_link-1568" id="calibre_link-2868" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">Sales[Cashback (slow)] :=
SUMX (
    Customer,
    <strong class="calibre7">[Sales Amount] * Customer[Cashback %]</strong>
)</pre></div>
<p class="edition">Because the <em class="calibre5">Sales Amount</em> measure can be computed for a group of customers that have the same <em class="calibre5">Cashback %</em>, the optimal cardinality for the <em class="calibre5">SUMX</em> iterator is defined by the unique values of the <em class="calibre5">Cashback %</em> column. The following optimized version just replaces the first argument of <em class="calibre5">SUMX</em> using the unique values of <em class="calibre5">Cashback %</em> visible in the filter context:</p>
<p class="codelink"><a href="#calibre_link-1569" id="calibre_link-2869" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Cashback (fast)] =
        SUMX (
            <strong class="calibre7">VALUES ( Customer[Cashback %] ),</strong>
            [Sales Amount] * Customer[Cashback %]
        )
EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL ( 'Customer'[Country], "IsGrandTotalRowTotal" ),
    "Cashback", 'Sales'[Cashback (fast)]
)</pre></div>
<p class="edition">This way, the materialization is much smaller, as visible in <a href="#calibre_link-1570" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-17</a>. However, even though the number of rows materialized is significantly smaller, the overall execution time is similar if not larger; remember that a difference of a few milliseconds should not be considered relevant.</p>
<figure id="calibre_link-1570" class="image-l">
<img src="images/000546.jpg" alt="The figure displays the Server Timings for Cashback (fast)." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-17</strong> Server Timings running the query for <em class="calibre5">Cashback (fast)</em> reported by country.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3250"></span>This time there is a single xmSQL query to compute the amount by country. This is the xmSQL query at line 2 of <a href="#calibre_link-1570" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-17</a>:</p>
<p class="codelink"><a href="#calibre_link-1571" id="calibre_link-2870" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
              * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )
SELECT
    'DaxBook Customer'[Country],
    'DaxBook Customer'[Cashback %],
    SUM ( @$Expr0 )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Customer'
        ON 'DaxBook Sales'[CustomerKey]='DaxBook Customer'[CustomerKey];</pre></div>
<p class="edition">The result of this query contains three columns: <em class="calibre5">Country</em>, <em class="calibre5">Cashback %</em>, and the corresponding <em class="calibre5">Sales Amount</em> value. Thus, the formula engine multiplies <em class="calibre5">Cashback %</em> by <em class="calibre5">Sales Amount</em> for each row, aggregating the rows belonging to the same country. The result presents an estimated count of 288 rows, whereas there are only 65 rows consumed by the formula engine. This is visible in the query plan in <a href="#calibre_link-1572" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-18</a>.</p>
<figure id="calibre_link-1572" class="image-l">
<img src="images/000568.jpg" alt="The figure shows the query plan for Cashback (fast)." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-18</strong> Query Plan pane running the query for <em class="calibre5">Cashback (fast)</em> reported by country.</figcaption>
</figure>
<p class="edition">Even though it is not evident, this measure is faster than the original measure. Having a smaller footprint in memory, it performs better in more complex reports. This is immediately visible by using a slightly different report like the one in <a href="#calibre_link-1573" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-19</a>, grouping the <em class="calibre5">Cashback</em> measure by product brand instead of by customer country.</p>
<figure id="calibre_link-1573" class="image-l">
<img src="images/000561.jpg" alt="This figure shows Cashback (slow) and Cashback (fast) by Brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-19</strong> <em class="calibre5">Cashback</em> reported by product brand.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3251"></span>The following query computes the slowest <em class="calibre5">Cashback</em> measure in the report shown in <a href="#calibre_link-1573" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-19</a>, generating the server timings results visible in <a href="#calibre_link-1574" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-20</a>:</p>
<p class="codelink"><a href="#calibre_link-1575" id="calibre_link-2871" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Cashback (slow)] =
        SUMX (
            Customer,
            [Sales Amount] * Customer[Cashback %]
        )
EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL ( <strong class="calibre7">Product[Brand],</strong> "IsGrandTotalRowTotal" ),
    "Cashback", 'Sales'[Cashback (slow)]
)</pre></div>
<figure id="calibre_link-1574" class="image-l">
<img src="images/000582.jpg" alt="The figure shows the Server Timings for Cashback (slow) by brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-20</strong> Server Timings running the query for <em class="calibre5">Cashback (slow)</em> reported by brand.</figcaption>
</figure>
<p class="edition">There are a few differences in this query plan, but we focus on the materialization of 192,514 rows produced by the following xmSQL query at line 2 of <a href="#calibre_link-1574" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-20</a>:</p>
<p class="codelink"><a href="#calibre_link-1576" id="calibre_link-2872" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
              * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )
SELECT
    <strong class="calibre7">'DaxBook Customer'[CustomerKey],</strong>
    <strong class="calibre7">'DaxBook Product'[Brand],</strong>
    SUM ( @$Expr0 )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Customer'
        ON 'DaxBook Sales'[CustomerKey]='DaxBook Customer'[CustomerKey]
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey];</pre></div>
<p class="edition">The reason for the larger materialization is that now, the inner calculation computes <em class="calibre5">Sales Amount</em> for each combination of <em class="calibre5">CustomerKey</em> and <em class="calibre5">Brand</em>. The estimated count of 192,514 rows is confirmed by the actual count visible in the query plan in <a href="#calibre_link-1577" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-21</a>.</p>
<figure id="calibre_link-1577" class="image-l">
<img src="images/000575.jpg" alt="The figure shows the query plan for Cashback (slow) by country." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-21</strong> Query Plan pane running the query for the <em class="calibre5">Cashback (slow)</em> measure reported by country.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1904"></span>When the test query is using the faster measure, the materialization is much smaller and the query response time is also much faster. The execution of the following DAX query produces the server timings results visible in <a href="#calibre_link-1578" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-22</a>:</p>
<p class="codelink"><a href="#calibre_link-1579" id="calibre_link-2873" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Cashback (fast)] =
        SUMX (
            VALUES ( Customer[Cashback %] ),
            [Sales Amount] * Customer[Cashback %]
        )
EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL ( <strong class="calibre7">Product[Brand],</strong> "IsGrandTotalRowTotal" ),
    "Cashback", 'Sales'[Cashback (fast)]
)</pre></div>
<figure id="calibre_link-1578" class="image-l">
<img src="images/000596.jpg" alt="The figure shows the Server Timings for Cashback (fast) by brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-22</strong> Server Timings running the query for <em class="calibre5">Cashback (fast)</em> reported by brand.</figcaption>
</figure>
<p class="edition">The materialization is three orders of magnitude smaller (126 rows instead of 192,000), and the total execution time is 9 times faster than the slow version (it was 415 milliseconds and it is 48 milliseconds with the fast version). Because these differences depend on the cardinality of the report, you should focus on the formula that minimizes the work in the formula engine by computing most of the aggregations in the storage engine. Reducing the number of context transitions is an important step to achieve this goal.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">Excessive materialization generated by unnecessary context transitions is the most common performance issue in DAX measures. Using table filters instead of column filters is the second most common performance issue. Therefore, making sure that your DAX measures do not have these two problems should be your priority in an optimization effort. By inspecting the server timings, you should be able to quickly see the symptoms by looking at the materialization size.</p>
</div>
</section>
<section class="calibre4">
<h4 id="calibre_link-344" class="calibre13">Optimizing <em class="calibre5">IF</em> conditions</h4>
<p class="edition">An <em class="calibre5">IF</em> function is always executed by the formula engine. When there is an <em class="calibre5">IF</em> function within an iteration, there could be a <em class="calibre5">CallbackDataID</em> involved in the execution. Moreover, the engine might evaluate the arguments of the <em class="calibre5">IF</em> regardless of the result of the condition in the first argument. Even though <span type="pagebreak" id="calibre_link-2078"></span>the result is correct, you might pay the full cost of processing all the possible solutions. As usual, there could be different behaviors depending on the version of the DAX engine used.</p>
<section class="calibre4">
<h5 id="calibre_link-3252" class="calibre13">Optimizing <em class="calibre5">IF</em> in measures</h5>
<p class="edition">Conditional statements in a measure could trigger a dangerous side effect in the query plan, generating the calculation of every conditional branch regardless of whether it is needed or not. In general, it is a good idea to avoid or at least reduce the number of conditional statements in expressions evaluated for measures, applying filters through the filter context whenever possible.</p>
<p class="edition">For example, the report in <a href="#calibre_link-1580" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-23</a> displays a <em class="calibre5">Fam. Sales</em> measure that only considers customers with at least one child at home. Because the goal is to display the value for individual customers, the first implementation (slow) does not work for aggregations of two or more customers (Total row is blank), whereas the alternative, faster implementation also works at aggregated levels.</p>
<figure id="calibre_link-1580" class="image-l">
<img src="images/000589.jpg" alt="The report shows Fam. Sales slow and fast, per product brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-23</strong> <em class="calibre5">Fam. Sales</em> reported by product brand.</figcaption>
</figure>
<p class="edition">The following query computes the <em class="calibre5">Fam. Sales (slow)</em> measure in a report similar to the one in <a href="#calibre_link-1533" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-1</a>. For each customer, an <em class="calibre5">IF</em> statement checks the number of children at home to filter customers classified as a family. The execution of the following DAX query produces the server timings results visible in <a href="#calibre_link-1578" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-22</a>:</p>
<p class="codelink"><a href="#calibre_link-1581" id="calibre_link-2874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Fam. Sales (slow)] =
        VAR ChildrenAtHome = SELECTEDVALUE ( Customer[Children At Home] )
        VAR Result =
            <strong class="calibre7">IF (</strong>
                <strong class="calibre7">ChildrenAtHome &gt; 0,</strong>
                <strong class="calibre7">[Sales Amount]</strong>
            <strong class="calibre7">)</strong>
        RETURN Result
EVALUATE
CALCULATETABLE (
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL (
            ROLLUPGROUP (
                'Customer'[CustomerKey],
                'Customer'[Name]
            ), "IsGrandTotalRowTotal"
<span type="pagebreak" id="calibre_link-3253"></span>        ),
        "Fam__Sales__slow_", 'Sales'[Fam. Sales (slow)]
    ),
    'Product Category'[Category] = "Home Appliances",
    'Product'[Manufacturer] = "Northwind Traders",
    'Product'[Class] = "Regular",
    DATESBETWEEN (
        'Date'[Date],
        DATE ( 2007, 5, 10 ),
        DATE ( 2007, 5, 10 )
    )
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Customer'[CustomerKey],
    'Customer'[Name]</pre></div>
<figure id="calibre_link-1582" class="image-l">
<img src="images/000609.jpg" alt="The figure shows the Server Timings for Fam. Sales (slow)." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-24</strong> Server Timings running the query for <em class="calibre5">Fam. Sales (slow)</em> reported by customer.</figcaption>
</figure>
<p class="edition">The query is not that slow, but we wanted a query result with a small number or rows because the focus is mainly on the materialization required. We can avoid looking at the query plan, which is already 62 lines long, because the information provided in the Server Timings pane already highlights several facts:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">Even though the DAX result only has 7 rows, the rows materialized in three xmSQL queries have more than 18,000 rows, a number close to the number of customers.</p></li>
<li class="calibre10"><p class="listp">The materialization produced by the storage engine query at line 4 in <a href="#calibre_link-1582" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-24</a> includes information about the number of children at home computed for each customer.</p></li>
<li class="calibre10"><p class="listp">The materialization produced by the storage engine query at line 9 in <a href="#calibre_link-1582" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-24</a> includes the <em class="calibre5">Sales Amount</em> measure computed for each customer.</p></li>
<li class="calibre10"><p class="listp">The grand total is not computed by any storage engine query, so it is the formula engine that aggregates the customers to obtain that number.</p></li>
</ul>
<p class="edition">This is the storage engine query at line 4 in <a href="#calibre_link-1582" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-24</a>. It provides the information required by the formula engine to filter customers based on the number of children at home:</p>
<p class="codelink"><a href="#calibre_link-1583" id="calibre_link-2875" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    'DaxBook Customer'[CustomerKey],
    SUM (  ( PFDATAID ( 'DaxBook Customer'[Children At Home] ) &lt;&gt; 2 )  ),
    MIN ( 'DaxBook Customer'[Children At Home] ),
<span type="pagebreak" id="calibre_link-3254"></span>    MAX ( 'DaxBook Customer'[Children At Home] ),
    COUNT (  )
FROM 'DaxBook Customer';</pre></div>
<p class="edition">This result is used as an argument to the following storage engine query at line 9 in <a href="#calibre_link-1582" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-24</a> in order to filter an estimate of 7,368 customers that have at least one child at home:</p>
<p class="codelink"><a href="#calibre_link-1584" id="calibre_link-2876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                 * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )
SELECT
    'DaxBook Customer'[CustomerKey],
    SUM ( @$Expr0 )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Customer'
        ON 'DaxBook Sales'[CustomerKey]='DaxBook Customer'[CustomerKey]
    LEFT OUTER JOIN 'DaxBook Date'
        ON 'DaxBook Sales'[OrderDateKey]='DaxBook Date'[DateKey]
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey]
    LEFT OUTER JOIN 'DaxBook Product Subcategory'
        ON 'DaxBook Product'[ProductSubcategoryKey]
               ='DaxBook Product Subcategory'[ProductSubcategoryKey]
    LEFT OUTER JOIN 'DaxBook Product Category'
        ON 'DaxBook Product Subcategory'[ProductCategoryKey]
               ='DaxBook Product Category'[ProductCategoryKey]
WHERE
    'DaxBook Customer'[CustomerKey]
        IN ( 2241, 13407, 5544, 7787, 11090, 7368, 17055, 16636, 1329, 12914..
            [7368 total values, not all displayed] )
VAND 'DaxBook Date'[Date] = 39212.000000
VAND 'DaxBook Product'[Manufacturer] = 'Northwind Traders'
VAND 'DaxBook Product'[Class] = 'Regular'
VAND 'DaxBook Product Category'[Category] = 'Home Appliances';</pre></div>
<p class="edition">The estimated number of rows in this result is wrong, because there are only 7 rows received in the previous storage engine query. This is visible in the query plan; however, it might not be trivial to find the corresponding xmSQL query for each <em class="calibre5">Cache</em> node in the query plan shown in <a href="#calibre_link-1585" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-25</a>.</p>
<figure id="calibre_link-1585" class="image-l">
<img src="images/000603.jpg" alt="The figure shows Server Timings for Fam. Sales (slow) per customer." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-25</strong> Server Timings running the query for the <em class="calibre5">Fam. Sales (slow)</em> measure reported by customer.</figcaption>
</figure>
<p class="edition">The previous storage engine query receives a filter over the <em class="calibre5">CustomerKey</em> column. The formula engine requires a materialization of such a list of values in <em class="calibre5">CustomerKey</em> in order to provide the corresponding filter in a storage engine query. However, the materialization of a large number of customers in the formula engine is likely to be the bigger cost for this query. The size of this materialization depends on the number of customers. Therefore, a model with hundreds of thousands or millions of customers would make the performance issue evident. In this case you should look at the size of the <span type="pagebreak" id="calibre_link-3255"></span>materialization rather than just the execution time. The latter is still relatively quick. Understanding whether the materialization is efficient is important to create a formula that scales up well with a growing number of rows in the model.</p>
<p class="edition">The <em class="calibre5">IF</em> statement in the measure can only be evaluated by the formula engine. This requires either materialization like in this example, or <em class="calibre5">CallbackDataID</em> calls, which we describe later. A better approach is to apply a filter to the filter context using <em class="calibre5">CALCULATE</em>. This removes the need to evaluate an <em class="calibre5">IF</em> condition for every cell of the query result.</p>
<p class="edition">When the test query is using the faster measure, the materialization is much smaller and the query response time is also much shorter. The execution of the following DAX query produces the server timings results visible in <a href="#calibre_link-1586" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-26</a>:</p>
<p class="codelink"><a href="#calibre_link-1587" id="calibre_link-2877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Fam. Sales (fast)] =
        <strong class="calibre7">CALCULATE (</strong>
            <strong class="calibre7">[Sales Amount],</strong>
            <strong class="calibre7">KEEPFILTERS ( Customer[Children At Home] &gt; 0 )</strong>
        <strong class="calibre7">)</strong>
EVALUATE
CALCULATETABLE (
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL (
            ROLLUPGROUP (
                'Customer'[CustomerKey],
                'Customer'[Name]
            ), "IsGrandTotalRowTotal"
        ),
        <strong class="calibre7">"Fam__Sales__fast_", 'Sales'[Fam. Sales (fast)]</strong>
    ),
    'Product Category'[Category] = "Home Appliances",
    'Product'[Manufacturer] = "Northwind Traders",
    'Product'[Class] = "Regular",
    DATESBETWEEN (
        'Date'[Date],
        DATE ( 2007, 5, 10 ),
        DATE ( 2007, 5, 10 )
    )
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Customer'[CustomerKey],
    'Customer'[Name]</pre></div>
<figure id="calibre_link-1586" class="image-l">
<img src="images/000624.jpg" alt="The figure shows Server Timings for Fam. Sales (fast) per customer." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-26</strong> Server Timings running the query for <em class="calibre5">Fam. Sales (fast)</em> reported by customer.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-2079"></span>Even though there are still four storage engine queries, the query at line 4 in <a href="#calibre_link-1582" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-24</a> is no longer used. The query at line 4 in <a href="#calibre_link-1586" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-26</a> corresponds to the query at line 9 in <a href="#calibre_link-1582" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-24</a>. It includes the filter over the number of children, highlighted in the last two lines of the following xmSQL query:</p>
<p class="codelink"><a href="#calibre_link-1588" id="calibre_link-2878" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                 * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )
SELECT
    'DaxBook Customer'[CustomerKey],
    SUM ( @$Expr0 )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Customer'
        ON 'DaxBook Sales'[CustomerKey]='DaxBook Customer'[CustomerKey]
    LEFT OUTER JOIN 'DaxBook Date'
        ON 'DaxBook Sales'[OrderDateKey]='DaxBook Date'[DateKey]
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey]
    LEFT OUTER JOIN 'DaxBook Product Subcategory'
        ON 'DaxBook Product'[ProductSubcategoryKey]
               ='DaxBook Product Subcategory'[ProductSubcategoryKey]
    LEFT OUTER JOIN 'DaxBook Product Category'
        ON 'DaxBook Product Subcategory'[ProductCategoryKey]
               ='DaxBook Product Category'[ProductCategoryKey]
WHERE
     'DaxBook Date'[Date] = 39212.000000
VAND 'DaxBook Product'[Manufacturer] = 'Northwind Traders'
VAND 'DaxBook Product'[Class] = 'Regular'
VAND 'DaxBook Product Category'[Category] = 'Home Appliances'
<strong class="calibre7">VAND ( PFCASTCOALESCE ( 'DaxBook Customer'[Children At Home] AS  INT )</strong>
           <strong class="calibre7">&gt; COALESCE ( 0 )  )</strong>;</pre></div>
<p class="edition">This different query plan has pros and cons. The advantage is that the formula engine bears a lower workload, not having to transfer the filter of customers back and forth between storage engine queries. The price to pay for this is that the execution of the filters is applied at the storage engine level, which results in an increased cost moving from a former 32 ms of <em class="calibre5">SE CPU</em> time to the current 94 ms of <em class="calibre5">SE CPU</em> time.</p>
<p class="edition">Another side effect of the new query plan is the additional storage engine query at line 8 in <a href="#calibre_link-1586" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-26</a>; this query computes the aggregation at the grand total without having to perform such aggregation in the formula engine, as was the case in the slower measure. The code is similar to the previous xmSQL query, without the aggregation by <em class="calibre5">CustomerKey</em>.</p>
<p class="edition">As a rule of thumb, replacing a conditional statement with a filter argument in <em class="calibre5">CALCULATE</em> is usually a good idea, prioritizing a smaller materialization rather than looking at the execution time for small queries. This way, the expression is usually more scalable with larger data models. However, you should always evaluate the performance in specific conditions, analyzing the metrics provided by DAX Studio using different implementations; you might otherwise choose an implementation that, in a particular scenario, turns out to be slower and not faster.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-3256" class="calibre13"><span type="pagebreak" id="calibre_link-2006"></span>Choosing between <em class="calibre5">IF</em> and <em class="calibre5">DIVIDE</em></h5>
<p class="edition">A very common use of the <em class="calibre5">IF</em> statement is to make sure that an expression is only evaluated with valid arguments. For example, an <em class="calibre5">IF</em> function can validate the denominator of a division to avoid a division by zero. For this specific condition, the <em class="calibre5">DIVIDE</em> function provides a faster alternative. It is interesting to consider why the code is faster by analyzing the different executions with DAX Studio.</p>
<p class="edition">The report in <a href="#calibre_link-1589" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-27</a> displays an <em class="calibre5">Average Price</em> measure by customer and brand.</p>
<figure id="calibre_link-1589" class="image-l">
<img src="images/000617.jpg" alt="The report shows Average Price (slow) and Average Price (fast) per brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-27</strong> <em class="calibre5">Average Price</em> reported by product brand and customer.</figcaption>
</figure>
<p class="edition">The following query computes the <em class="calibre5">Average Price (slow)</em> measure in the report shown in <a href="#calibre_link-1589" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-27</a>. For each combination of product brand and customer, it divides the sales amount by the sum of quantity&mdash;only if the latter is not equal to zero. The execution of this DAX query produces the server timings results visible in <a href="#calibre_link-1590" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-28</a>:</p>
<p class="codelink"><a href="#calibre_link-1591" id="calibre_link-2879" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-3257"></span>DEFINE
    MEASURE Sales[Average Price (slow)] =
        VAR Quantity = SUM ( Sales[Quantity] )
        VAR SalesAmount = [Sales Amount]
        VAR Result =
            <strong class="calibre7">IF (</strong>
                <strong class="calibre7">Quantity &lt;&gt; 0,</strong>
                <strong class="calibre7">SalesAmount / Quantity</strong>
            <strong class="calibre7">)</strong>
        RETURN Result
EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL (
            ROLLUPGROUP (
                'Customer'[CustomerKey],
                'Product'[Brand]
            ), "IsGrandTotalRowTotal"
        ),
        "Average_Price__slow_", 'Sales'[Average Price (slow)]
    ),
    [IsGrandTotalRowTotal], 0,
    'Customer'[CustomerKey], 1,
    'Product'[Brand], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Customer'[CustomerKey],
    'Product'[Brand]</pre></div>
<figure id="calibre_link-1590" class="image-l">
<img src="images/000638.jpg" alt="The figure shows Server Timings for Average Price (slow) per customer and brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-28</strong> Server Timings running the query for <em class="calibre5">Average Price (slow)</em> reported by product brand and customer.</figcaption>
</figure>
<p class="edition">Though the result of the query is limited to 500 rows, the materialization of the datacaches returned by the storage engine queries is much larger. The following xmSQL query is executed at line 2 in <a href="#calibre_link-1590" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-28</a>, and returns one row for each combination of customer and brand:</p>
<p class="codelink"><a href="#calibre_link-1592" id="calibre_link-2880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                  * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )
SELECT
    'DaxBook Customer'[CustomerKey],
    'DaxBook Product'[Brand],
    SUM ( @$Expr0 ),
    SUM ( 'DaxBook Sales'[Quantity] )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Customer'
        ON 'DaxBook Sales'[CustomerKey]='DaxBook Customer'[CustomerKey]
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey];</pre></div>
<p class="edition">The query does not have any filter; therefore, the formula engine evaluates every row returned by this datacache, sorting the result and choosing the first 500 rows to return. This is certainly the most expensive part of the storage engine execution, which consumes 90% of the query duration time. The other three storage engine queries return the list of product brands (line 4), the list of customers (line 6), and the value of sales amount and quantity at the grand total level (line 8). However, these queries are less important in the optimization process. What matters is the formula engine cost required to execute the <em class="calibre5">IF</em> condition on more than 190,000 rows. The query plan resulting from the slow version of the measure has more than 80 lines (not reported here), and it consumes every datacache multiple times. This is a side effect of having different execution branches in an <em class="calibre5">IF</em> statement.</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3258"></span>The optimization of the <em class="calibre5">Average Price</em> measure is based on replacing the <em class="calibre5">IF</em> function with <em class="calibre5">DIVIDE</em>. The execution of the following DAX query produces the server timings results visible in <a href="#calibre_link-1593" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-29</a>:</p>
<p class="codelink"><a href="#calibre_link-1594" id="calibre_link-2881" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Average Price (fast)] =
        VAR Quantity = SUM ( Sales[Quantity] )
        VAR SalesAmount = [Sales Amount]
        VAR Result =
            <strong class="calibre7">DIVIDE (</strong>
                <strong class="calibre7">SalesAmount,</strong>
                <strong class="calibre7">Quantity</strong>
            <strong class="calibre7">)</strong>
        RETURN Result
EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL (
            ROLLUPGROUP (
                'Customer'[CustomerKey],
                'Product'[Brand]
            ), "IsGrandTotalRowTotal"
        ),
        "Average_Price__fast_", 'Sales'[Average Price (fast)]
    ),
    [IsGrandTotalRowTotal], 0,
    'Customer'[CustomerKey], 1,
    'Product'[Brand], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Customer'[CustomerKey],
    'Product'[Brand]</pre></div>
<figure id="calibre_link-1593" class="image-l">
<img src="images/000631.jpg" alt="The figure shows the Server Timings for Average Price (fast) per customer and brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-29</strong> Server Timings running the query for <em class="calibre5">Average Price (fast)</em> reported by product brand and customer.</figcaption>
</figure>
<p class="edition">The query now runs in 413 milliseconds, saving more than 80% of the execution time. At first sight, there being only two storage engine queries instead of four might seem like a good reason for the improved performance. However, this is not really the case. Overall, the <em class="calibre5">SE CPU</em> time did not change significantly, and the larger materialization is still there. The optimization is obtained by a shorter and more efficient query plan, which has only 36 lines instead of more than 80 generated by the slower <span type="pagebreak" id="calibre_link-2007"></span>query. In other words, <em class="calibre5">DIVIDE</em> reduces the size and complexity of the query plan, saving time in the formula engine execution by almost one order of magnitude.</p>
</section>
<section class="calibre4">
<h5 id="calibre_link-3259" class="calibre13">Optimizing <em class="calibre5">IF</em> in iterators</h5>
<p class="edition">Using the <em class="calibre5">IF</em> statement within a large iterator might create expensive callbacks to the formula engine. For example, consider a <em class="calibre5">Discounted Sales</em> measure that applies a 10% discount to every transaction that has a quantity greater than or equal to 3. The report in <a href="#calibre_link-1595" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-30</a> displays the <em class="calibre5">Discounted Sales</em> amount for each product brand.</p>
<figure id="calibre_link-1595" class="image-l">
<img src="images/000651.jpg" alt="The report shows Sales Amount, Discounted Sales (slow), and Discounted Sales (scalable) per brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-30</strong> <em class="calibre5">Discounted Sales</em> reported by product brand.</figcaption>
</figure>
<p class="edition">The following query computes the slower <em class="calibre5">Discounted Sales</em> measure in the previous report, generating the server timings results visible in <a href="#calibre_link-1596" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-31</a>:</p>
<p class="codelink"><a href="#calibre_link-1597" id="calibre_link-2882" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Discounted Sales (slow)] =
        SUMX (
            Sales,
            Sales[Quantity] * Sales[Net Price] * IF (
                    Sales[Quantity] &gt;= 3,
                    .9,
                    1
                )
        )
EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL ( 'Product'[Brand], "IsGrandTotalRowTotal" ),
    "Sales_Amount", 'Sales'[Sales Amount],
    "Discounted_Sales__slow_", 'Sales'[Discounted Sales (slow)]
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Product'[Brand]</pre></div>
<figure id="calibre_link-1596" class="image-l">
<img src="images/000644.jpg" alt="The figure shows Server Timings for Discounted Sales (slow) per Product brand." class="calibre11" />
<figcaption class="calibre12"><span type="pagebreak" id="calibre_link-3260"></span><strong class="calibre7">Figure 20-31</strong> Server Timings running the query for <em class="calibre5">Discounted Sales (slow)</em> reported by product brand.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">IF</em> statement executed in the <em class="calibre5">SUMX</em> iterator produces two storage engine queries with a <em class="calibre5">CallbackDataID</em> call. The following is the xmSQL query at line 2 of <a href="#calibre_link-1596" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-31</a>:</p>
<p class="codelink"><a href="#calibre_link-1598" id="calibre_link-2883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := (  ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                     * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )
                     * <strong class="calibre7">[CallbackDataID ( IF ( Sales[Quantity]] &gt;= 3, .9, 1 )  ) ]</strong>
                         <strong class="calibre7">( PFDATAID ( 'DaxBook Sales'[Quantity] )  )  ) ,</strong>
    $Expr1 := ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                  * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )
SELECT
    'DaxBook Product'[Brand],
    SUM ( @$Expr0 ),
    SUM ( @$Expr1 )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey];</pre></div>
<p class="edition">The presence of a <em class="calibre5">CallbackDataID</em> comes with two consequences: a slower execution time compared to the storage engine performance and the unavailability of the storage engine cache. The datacache must be computed every time and cannot be retrieved from the cache in subsequent requests. The second issue could be more important than the first one, as is the case for this example.</p>
<p class="edition">The <em class="calibre5">CallbackDataID</em> can be removed by rewriting the measure in a different way, summing the value of two <em class="calibre5">CALCULATE</em> statements with different filters. For example, the <em class="calibre5">Discounted Sales</em> measure can be rewritten using two <em class="calibre5">CALCULATE</em> functions, one for each percentage, filtering the transactions that share the same multiplicator. The following DAX query implements a version of <em class="calibre5">Discounted Sales</em> that does not rely on any <em class="calibre5">CallbackDataID</em>. The code is longer and requires <em class="calibre5">KEEPFILTERS</em> to provide the same semantic as in the original measure, producing the server timings results visible in <a href="#calibre_link-1599" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-32</a>:</p>
<p class="codelink"><a href="#calibre_link-1600" id="calibre_link-2884" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Discounted Sales (scalable)] =
        <strong class="calibre7">CALCULATE (</strong>
            <strong class="calibre7">SUMX (</strong>
                <strong class="calibre7">Sales,</strong>
                <strong class="calibre7">Sales[Quantity] * Sales[Net Price]</strong>
            <strong class="calibre7">)</strong> * <strong class="calibre7">.9,</strong>
            <strong class="calibre7">KEEPFILTERS ( Sales[Quantity]</strong> &gt;= <strong class="calibre7">3 )</strong>
        <strong class="calibre7">)</strong> + <strong class="calibre7">CALCULATE (</strong>
                <strong class="calibre7"><span type="pagebreak" id="calibre_link-3261"></span>SUMX (</strong>
                    <strong class="calibre7">Sales,</strong>
                    <strong class="calibre7">Sales[Quantity] * Sales[Net Price]</strong>
                <strong class="calibre7">),</strong>
                <strong class="calibre7">KEEPFILTERS ( NOT ( Sales[Quantity]</strong> &gt;= <strong class="calibre7">3 ) )</strong>
            <strong class="calibre7">)</strong>
EVALUATE
SUMMARIZECOLUMNS (
    ROLLUPADDISSUBTOTAL ( 'Product'[Brand], "IsGrandTotalRowTotal" ),
    "Sales_Amount", 'Sales'[Sales Amount],
    "Discounted_Sales__slow_", 'Sales'[Discounted Sales (scalable)]
)</pre></div>
<figure id="calibre_link-1599" class="image-l">
<img src="images/000664.jpg" alt="The figure shows Server Timings for Discounted Sales (scalable) per product brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-32</strong> Server Timings running the query for <em class="calibre5">Discounted Sales (scalable)</em> by product brand for the first time.</figcaption>
</figure>
<p class="edition">Actually, in this simple query the result is not faster at all. The query required 159 milliseconds instead of the 142 milliseconds of the “slow” version. However, we called this measure “scalable.” Indeed, the important advantage is that a second execution of the last query with a warm cache produces the results visible in <a href="#calibre_link-1601" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-33</a>, whereas multiple executions of the query for the “slow” version always produce a result similar to the one shown in <a href="#calibre_link-1596" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-31</a>.</p>
<figure id="calibre_link-1601" class="image-l">
<img src="images/000658.jpg" alt="The figure shows Server Timings for Discounted Sales (scalable) per product brand, run a second time." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-33</strong> Server Timings running the query for <em class="calibre5">Discounted Sales (scalable)</em> by product brand a second time.</figcaption>
</figure>
<p class="edition">The Server Timings in <a href="#calibre_link-1601" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-33</a> show that there is no <em class="calibre5">SE CPU</em> cost after the first execution of the query. This is important when a model is published on a server and many users open the same reports: Users experience a faster response time, and the memory and CPU workload on the server side is reduced. This optimization is particularly relevant in environments with a fixed reserved capacity, such as Power BI Premium and Power BI Report Server.</p>
<p class="edition">The rule of thumb is to carefully consider the <em class="calibre5">IF</em> function in the expression of an iterator with a large cardinality because of the possible presence of <em class="calibre5">CallbackDataID</em> in the storage engine queries. The next section includes a deeper discussion on the impact of <em class="calibre5">CallbackDataID</em>, which might be required by many other DAX functions used in iterators.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span type="pagebreak" id="calibre_link-1857"></span><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition">The <em class="calibre5">SWITCH</em> function in DAX is similar to a series of nested <em class="calibre5">IF</em> functions and can be optimized in a similar way.</p>
</div>
</section>
</section>
<section class="calibre4">
<h4 id="calibre_link-345" class="calibre13">Reducing the impact of <em class="calibre5">CallbackDataID</em></h4>
<p class="edition">In <a href="#calibre_link-24" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Chapter 19</a>, you saw that the <em class="calibre5">CallbackDataID</em> function in a storage engine query can have a huge performance impact. This is because it slows down the storage engine execution, and it disables the use of the storage engine cache for the datacache produced. Identifying the <em class="calibre5">CallbackDataID</em> is important because this is often the reason behind a bottleneck in the storage engine, especially for models that only have a few million rows in their largest table (scan time should typically be in the order of magnitude of 10&ndash;100 milliseconds).</p>
<p class="edition">For example, consider the following query where the <em class="calibre5">Rounded Sales</em> measure computes its result rounding <em class="calibre5">Unit Price</em> to the nearest integer. The report in <a href="#calibre_link-1602" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-34</a> displays the <em class="calibre5">Rounded Sales</em> amount for each product brand.</p>
<figure id="calibre_link-1602" class="image-l">
<img src="images/000676.jpg" alt="The report shows Rounded Sales (slow) and Rounded Sales (fast) per product brand." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-34</strong> <em class="calibre5">Rounded Sales</em> reported by product brand.</figcaption>
</figure>
<p class="edition">The simpler implementation of <em class="calibre5">Rounded Sales</em> applies the <em class="calibre5">ROUND</em> function to every row of the <em class="calibre5">Sales</em> table. This results in a <em class="calibre5">CallbackDataID</em> call, which slows down the execution, thus lowering performance. The following query computes the slowest <em class="calibre5">Rounded Sales</em> measure in the previous report, generating the server timings results visible in <a href="#calibre_link-1603" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-35</a>:</p>
<p class="codelink"><a href="#calibre_link-1604" id="calibre_link-2885" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Rounded Sales (slow)] =
        SUMX (
            Sales,
            Sales[Quantity] * <strong class="calibre7">ROUND ( Sales[Net Price], 0 )</strong>
        )
EVALUATE
TOPN (
    502,
    <span type="pagebreak" id="calibre_link-3262"></span>SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL ( 'Product'[Brand], "IsGrandTotalRowTotal" ),
        "Rounded_Sales", 'Sales'[Rounded Sales (slow)]
    ),
    [IsGrandTotalRowTotal], 0,
    'Product'[Brand], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Product'[Brand]</pre></div>
<figure id="calibre_link-1603" class="image-l">
<img src="images/000670.jpg" alt="The figure shows Server Timings for Rounded Sales (slow)." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-35</strong> Server Timings running the query for <em class="calibre5">Rounded Sales (slow)</em>.</figcaption>
</figure>
<p class="edition">The two storage engine queries at lines 2 and 4 compute the value for each brand and for the grand total, respectively. This is the xmSQL query at line 2 of <a href="#calibre_link-1603" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-35</a>:</p>
<p class="codelink"><a href="#calibre_link-1605" id="calibre_link-2886" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                * <strong class="calibre7">[CallbackDataID ( ROUND ( Sales[Net Price]], 0 )  ) ]</strong>
                        ( PFDATAID ( 'DaxBook Sales'[Net Price] )  )  )
SELECT
    'DaxBook Product'[Brand],
    SUM ( @$Expr0 )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey];</pre></div>
<p class="edition">The <em class="calibre5">Sales</em> table contains more than 12 million rows, and each storage engine query computes an equivalent amount of <em class="calibre5">CallbackDataID</em> calls to execute the <em class="calibre5">ROUND</em> function. Indeed, the formula engine executes the <em class="calibre5">ROUND</em> operation to remove the decimal part of the <em class="calibre5">Unit Price</em> value. Based on the Server Timings report, we can estimate that the formula engine executes around 7,000 <em class="calibre5">ROUND</em> functions per millisecond. It is important to keep these numbers in mind, so that you can evaluate whether or not the cardinality of an iterator generating <em class="calibre5">CallbackDataID</em> calls would benefit from some amount of optimization. If the table contained 12,000 rows instead of 12 million rows, the priority would be to optimize something else. However, optimizing the measure in the current model requires reducing the number of <em class="calibre5">CallbackDataID</em> calls.</p>
<p class="edition">We aim to reduce the number of <em class="calibre5">CallbackDataID</em> calls by refactoring the measure. By looking at the information provided by VertiPaq Analyzer, we know that the <em class="calibre5">Sales</em> table has more than 12 million rows, whereas the <em class="calibre5">Net Price</em> column in the <em class="calibre5">Sales</em> table has less than 2,500 unique values. Accordingly, the formula can compute the same result by multiplying the rounded value of each unique <em class="calibre5">Unit Price</em> value by the sum of <em class="calibre5">Quantity</em> for all the <em class="calibre5">Sales</em> transaction with the same <em class="calibre5">Unit Price</em>.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3263"></span>You should always use the statistics of your data model during DAX optimization. A quick way to obtain these numbers for a data model is by using VertiPaq Analyzer (<a href="http://www.sqlbi.com/tools/vertipaq-analyzer/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">http://www.sqlbi.com/tools/vertipaq-analyzer/</a>).</p>
</div>
<p class="edition">The following optimized version of <em class="calibre5">Rounded Sales</em> materializes up to 2,500 rows computing the sum of <em class="calibre5">Quantity</em> iterating the unique values of <em class="calibre5">Unit Price</em>:</p>
<p class="codelink"><a href="#calibre_link-1606" id="calibre_link-2887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Rounded Sales (fast)] =
        SUMX (
            <strong class="calibre7">VALUES ( Sales[Net Price] ),</strong>
            <strong class="calibre7">CALCULATE ( SUM ( Sales[Quantity] ) )</strong> * <strong class="calibre7">ROUND ( Sales[Net Price], 0 )</strong>
        )
EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL ( 'Product'[Brand], "IsGrandTotalRowTotal" ),
        "Rounded_Sales", 'Sales'[Rounded Sales (fast)]
    ),
    [IsGrandTotalRowTotal], 0,
    'Product'[Brand], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Product'[Brand]</pre></div>
<p class="edition">This way, the formula engine executes the <em class="calibre5">ROUND</em> function using the result of the datacache returning the sum of <em class="calibre5">Quantity</em> for each <em class="calibre5">Net Price</em>. Despite a larger materialization compared to the slow version, the time required to obtain the solution is reduced by almost one order of magnitude. Moreover, the results provided by the storage engine queries can be reused in following executions because the storage engine cache will store the result of xmSQL queries that do not have any <em class="calibre5">CallbackDataID</em> calls.</p>
<p class="edition">The following is the xmSQL query at line 2 of <a href="#calibre_link-1607" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-36</a>. This query returns the <em class="calibre5">Net Price</em> and the sum of the <em class="calibre5">Quantity</em> for each brand and does not have any <em class="calibre5">CallbackDataID</em> calls:</p>
<p class="codelink"><a href="#calibre_link-1608" id="calibre_link-2888" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14"><span type="pagebreak" id="calibre_link-1858"></span>SELECT
    'DaxBook Product'[Brand],
    'DaxBook Sales'[Net Price],
    SUM ( 'DaxBook Sales'[Quantity] )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey];</pre></div>
<figure id="calibre_link-1607" class="image-l">
<img src="images/000690.jpg" alt="The figure shows Server Timings for Rounded Sales (fast)." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-36</strong> Server Timings running the query for <em class="calibre5">Rounded Sales (fast)</em>.</figcaption>
</figure>
<p class="edition">In this latter version, the rounding is executed by the formula engine and not by the storage engine through the <em class="calibre5">CallbackDataID</em>. Be mindful that a very large number of unique values in <em class="calibre5">Net Price</em> would require a bigger materialization, up to the point where the previous version could be faster with a different data distribution. If <em class="calibre5">Net Price</em> had millions of unique values, a benchmark comparison between the two solutions would be required in order to determine the optimal solution. Moreover, the result could be different depending on the hardware. Rather than assuming that one technique is better than another, you should always evaluate the performance using a real database and not just a sample before making a decision.</p>
<p class="edition">Finally, remember that most of the scalar DAX functions that do not aggregate data require a <em class="calibre5">CallbackDataID</em> if executed in an iterator. For example, <em class="calibre5">DATE</em>, <em class="calibre5">VALUE</em>, most of the type conversions, <em class="calibre5">IFERROR</em>, <em class="calibre5">DIVIDE</em>, and all the rounding, mathematical, and date/time functions are only implemented in the formula engine. Most of the time, their presence in an iterator generates a <em class="calibre5">CallbackDataID</em> call. However, you always have to check the xmSQL query to verify whether a <em class="calibre5">CallbackDataID</em> is present or not.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-346" class="calibre13">Optimizing nested iterators</h4>
<p class="edition">Nested iterators in DAX cannot be merged into a single storage engine query. Only the innermost iterator can be executed using a storage engine query, whereas the outer iterators typically require either a larger materialization or additional storage engine queries.</p>
<p class="edition">For example, consider another <em class="calibre5">Cashback</em> measure named “<em class="calibre5">Cashback Sim.”</em> that simulates a cashback for each customer using the current price of each product multiplied by the historical quantity and the cashback percentage of each customer. The report in <a href="#calibre_link-1609" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-37</a> displays the <em class="calibre5">Cashback Sim</em>. amount for each country.</p>
<figure id="calibre_link-1609" class="image-l">
<img src="images/000683.jpg" alt="The report shows Cashback Sim. (slow), (medium), and (fast) per country." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-37</strong> <em class="calibre5">Cashback Sim</em>. reported by customer country.</figcaption>
</figure>
<p class="edition">The first and slowest implementation iterates the <em class="calibre5">Customer</em> and <em class="calibre5">Product</em> tables in order to retrieve the cashback percentage of the customer and the current price of the product, respectively. The innermost iterators retrieve the quantity sold for each combination of customer and product, multiplying it<span type="pagebreak" id="calibre_link-3264"></span> by <em class="calibre5">Unit Price</em> and <em class="calibre5">Cashback %</em>. The following query computes the slowest <em class="calibre5">Cashback Sim</em>. measure in the previous report, generating the server timings results visible in <a href="#calibre_link-1610" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-38</a>:</p>
<p class="codelink"><a href="#calibre_link-1611" id="calibre_link-2889" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Cashback Sim. (slow)] =
        SUMX (
            Customer,
            SUMX (
                'Product',
                SUMX (
                    RELATEDTABLE ( Sales ),
                    Sales[Quantity] * 'Product'[Unit Price] * Customer[Cashback %]
                )
            )
        )
EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL ( 'Customer'[Country], "IsGrandTotalRowTotal" ),
        "Cashback Sim. (slow)", 'Sales'[Cashback Sim. (slow)]
    ),
    [IsGrandTotalRowTotal], 0,
    'Customer'[Country], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Customer'[Country]</pre></div>
<figure id="calibre_link-1610" class="image-l">
<img src="images/000704.jpg" alt="The figure shows Server Timings for Cashback Sim. (slow) per country." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-38</strong> Server Timings running the query for the <em class="calibre5">Cashback Sim. (slow)</em> measure reported by country.</figcaption>
</figure>
<p class="edition">The execution cost is split between the storage engine and the formula engine. The former pays a big price to produce a large materialization, whereas the latter spends time consuming that large set of materialized data. The storage engine queries at lines 2 and 10 of <a href="#calibre_link-1610" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-38</a> are identical and materialize the following columns for the entire <em class="calibre5">Sales</em> table: <em class="calibre5">CustomerKey</em>, <em class="calibre5">ProductKey</em>, <em class="calibre5">Quantity</em>, and <em class="calibre5">RowNumber</em>:</p>
<p class="codelink"><a href="#calibre_link-1612" id="calibre_link-2890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    'DaxBook Customer'[CustomerKey],
    'DaxBook Product'[ProductKey],
    'DaxBook Sales'[RowNumber],
    'DaxBook Sales'[Quantity]
<span type="pagebreak" id="calibre_link-3265"></span>FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Customer'
        ON 'DaxBook Sales'[CustomerKey]='DaxBook Customer'[CustomerKey]
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey];</pre></div>
<p class="edition">The <em class="calibre5">RowNumber</em> is a special column inaccessible to DAX that is used to uniquely identify a row in a table. These four columns are used in the formula engine to compute the formula in the innermost iterator, which considers the sales for each combination of <em class="calibre5">Customer</em> and <em class="calibre5">Product</em>. The query at line 2 creates the datacache that is also returned at line 10, hitting the cache. The presence of this second storage engine query is caused by the need to compute the grand total in <em class="calibre5">SUMMARIZECOLUMNS</em>. Without the two levels of granularity in the result, half the query plan and half the storage engine queries would not be necessary.</p>
<p class="edition">The DAX measure iterates two tables (<em class="calibre5">Customer</em> and <em class="calibre5">Product</em>) producing all the possible combinations. For each combination of customer and product, the innermost <em class="calibre5">SUMX</em> function iterates only the corresponding rows in <em class="calibre5">Sales</em>. The formula also considers the combinations of <em class="calibre5">Customer</em> and <em class="calibre5">Product</em> that do not have any rows in the <em class="calibre5">Sales</em> table, potentially wasting precious CPU time. The query plan shows that there are 2,517 products and 18,869 customers; these are the same numbers estimated for the storage engine queries at lines 4 and 6 in <a href="#calibre_link-1610" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-38</a>, respectively. Therefore, the formula engine performs 1,326,280 aggregations of the rows materialized by the <em class="calibre5">Sales</em> table, as shown in the excerpt of the query plan in <a href="#calibre_link-1613" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-39</a>. The <em class="calibre5">Records</em> column shows the number of rows iterated by consumed datacaches returned by storage engine queries (see the <em class="calibre5">Cache</em> nodes at lines 28, 33, and 36) or computed by other formula engine operations (see the <em class="calibre5">CrossApply</em> node at line 23).</p>
<figure id="calibre_link-1613" class="image-l">
<img src="images/000697.jpg" alt="The figure shows the query plan for Cashback Sim. (slow) per country." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-39</strong> Query Plan pane running the query for the <em class="calibre5">Cashback Sim. (slow)</em> measure reported by country.</figcaption>
</figure>
<p class="edition">Although the DAX code iterates the tables, the xmSQL code only retrieves the columns of the tables uniquely representing one row of each table. This reduces the number of columns materialized, even though the cardinality of the tables iterated is larger than necessary. At this point, there are two important considerations:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">The cardinality of the iterators is larger than required. Thanks to the context transition, it is possible to reduce the cardinality of the outer iterators; that way, the query context considers <span type="pagebreak" id="calibre_link-3266"></span>all the rows in <em class="calibre5">Sales</em> for a given combination of <em class="calibre5">Unit Price</em> and <em class="calibre5">Cashback %</em>, instead of each combination of product and customer.</p></li>
<li class="calibre10"><p class="listp">Removing nested iterators would produce a better query plan, also removing expensive materialization.</p></li>
</ul>
<p class="edition">The first consideration should suggest applying the technique previously described to optimize the context transitions. Indeed, the <em class="calibre5">RELATEDTABLE</em> function is like a <em class="calibre5">CALCULATETABLE</em> without filter arguments that only performs a context transition. The first variation to the DAX measure is a “medium” version that iterates the <em class="calibre5">Cashback %</em> and <em class="calibre5">Unit Price</em> columns, instead of iterating by <em class="calibre5">Customer</em> and <em class="calibre5">Product</em>. The semantic of the query is still the same because the innermost expression only depends on these columns:</p>
<p class="codelink"><a href="#calibre_link-1614" id="calibre_link-2891" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Cashback Sim. (medium)] =
        SUMX (
            <strong class="calibre7">VALUES ( Customer[Cashback %] ),</strong>
            SUMX (
                <strong class="calibre7">VALUES ( 'Product'[Unit Price] ),</strong>
                SUMX (
                    RELATEDTABLE ( Sales ),
                    Sales[Quantity] * 'Product'[Unit Price] * Customer[Cashback %]
                )
            )
        )
EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL ( 'Customer'[Country], "IsGrandTotalRowTotal" ),
        "Cashback Sim. (medium)", 'Sales'[Cashback Sim. (medium)]
    ),
    [IsGrandTotalRowTotal], 0,
    'Customer'[Country], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Customer'[Country]</pre></div>
<p class="edition"><a href="#calibre_link-1615" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-40</a> shows that the execution of the “medium” version is orders of magnitude faster than the “slow” version, thanks to a smaller granularity and a simpler dependency between tables iterated and columns referenced.</p>
<figure id="calibre_link-1615" class="image-l">
<img src="images/000718.jpg" alt="The figure shows Server Timings for Cashback Sim. (medium) per country." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-40</strong> Server Timings running the query for the <em class="calibre5">Cashback Sim. (medium)</em> measure reported by country.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3267"></span>The two storage engine queries provide a result for each of the cardinalities of the result. The following is the storage query at line 2, whereas the similar query at line 4 does not include the <em class="calibre5">Country</em> column and is used for the grand total:</p>
<p class="codelink"><a href="#calibre_link-1616" id="calibre_link-2892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := (  ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                      * PFCAST ( 'DaxBook Product'[Unit Price] AS  REAL )  )
                      * PFCAST ( 'DaxBook Customer'[Cashback] AS  REAL )  )
SELECT
    'DaxBook Customer'[Country],
    'DaxBook Customer'[Cashback],
    'DaxBook Product'[Unit Price],
    SUM ( @$Expr0 )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Customer'
        ON 'DaxBook Sales'[CustomerKey]='DaxBook Customer'[CustomerKey]
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey];</pre></div>
<p class="edition">The “medium” version of the <em class="calibre5">Cashback Sim</em>. measure still contains the same number of nested iterators, potentially considering all the possible combinations between the values of the <em class="calibre5">Unit Price</em> and <em class="calibre5">Cashback %</em> columns. In this simple measure, the query plan is able to establish the dependencies on the <em class="calibre5">Sales</em> table, reducing the calculation to the existing combinations. However, there is an alternative DAX syntax to explicitly instruct the engine to only consider the existing combinations. Instead of using nested iterators, a single iterator over the result of a <em class="calibre5">SUMMARIZE</em> enforces a query plan that does not compute calculations over non-existing combinations. The following version named “improved” could produce a more efficient query plan in complex scenarios, even though in this example it generates the same result and query plan:</p>
<p class="codelink"><a href="#calibre_link-1617" id="calibre_link-2893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">MEASURE Sales[Cashback Sim. (improved)] =
    SUMX (
        <strong class="calibre7">SUMMARIZE (</strong>
            <strong class="calibre7">Sales,</strong>
            <strong class="calibre7">'Product'[Unit Price],</strong>
            <strong class="calibre7">Customer[Cashback %]</strong>
        <strong class="calibre7">),</strong>
        <strong class="calibre7">CALCULATE ( SUM ( Sales[Quantity] ) )</strong>
            * 'Product'[Unit Price] * Customer[Cashback %]
    )</pre></div>
<p class="edition">The “medium” and “improved” versions of the <em class="calibre5">Cashback Sim</em>. measure can easily be adapted to use existing measures in the innermost calculations. Indeed, the “improved” version uses a <em class="calibre5">CALCULATE</em> function to compute the sum of <em class="calibre5">Sales[Quantity]</em> for a given combination of <em class="calibre5">Unit Price</em> and <em class="calibre5">Cashback %</em>, just like a measure reference would. You should consider this approach to write efficient code that is easier to maintain. However, a more efficient version is possible by removing any nested iterators.</p>
<div class="note pcalibre4 pcalibre5">
<p class="edition"><span class="middle"><img src="images/000334.jpg" alt="Image" class="pcalibre6 calibre19" /></span> Note</p>
<p class="edition"><span type="pagebreak" id="calibre_link-3268"></span>Note A measure definition often includes aggregation functions such as <em class="calibre5">SUM</em>. With the exception of <em class="calibre5">DISTINCTCOUNT</em>, simple aggregation functions are just a shorter syntax for an iterator. For example, <em class="calibre5">SUM</em> internally invokes <em class="calibre5">SUMX</em>. Hence, a measure reference in an iterator often implies the execution of another nested iterator with a context transition in the middle. When this is required by the nature of the calculation, this is a necessary computational cost. When the nested iterators are additive like the two nested <em class="calibre5">SUMX/SUM</em> of the <em class="calibre5">Cashback Sim. (improved)</em> measure, then a consolidation of the calculation may be considered to optimize the performance; however, this could affect the readability and reusability of the measure.</p>
</div>
<p class="edition">The following “fast” version of the <em class="calibre5">Cashback Sim</em>. measure optimizes the performance, at the cost of reducing the ability to reuse the business logic of existing measures:</p>
<p class="codelink"><a href="#calibre_link-1618" id="calibre_link-2894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Cashback Sim. (fast)] =
        <strong class="calibre7">SUMX (</strong>
            <strong class="calibre7">Sales,</strong>
            <strong class="calibre7">Sales[Quantity]</strong>
                * <strong class="calibre7">RELATED ( 'Product'[Unit Price] )</strong>
                * <strong class="calibre7">RELATED ( Customer[Cashback %] )</strong>
        <strong class="calibre7">)</strong>
EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL ( 'Customer'[Country], "IsGrandTotalRowTotal" ),
        "Cashback Sim. (fast)", 'Sales'[Cashback Sim. (fast)]
    ),
    [IsGrandTotalRowTotal], 0,
    'Customer'[Country], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Customer'[Country]</pre></div>
<p class="edition"><a href="#calibre_link-1619" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-41</a> shows the server timings information of the “fast” version, which saves more than 50% of the execution time compared to the “medium” and “improved” versions.</p>
<figure id="calibre_link-1619" class="image-l">
<img src="images/000711.jpg" alt="The figure shows Server Timings for Cashback Sim. (fast) per country." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-41</strong> Server Timings running the query for the <em class="calibre5">Cashback Sim. (fast)</em> measure reported by country.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1973"></span>The measure with a single iterator without context transitions generates the following simple storage engine query, reported at line 2 of <a href="#calibre_link-1619" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-41</a>:</p>
<p class="codelink"><a href="#calibre_link-1620" id="calibre_link-2895" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">WITH
    $Expr0 := (  ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                            * PFCAST ( 'DaxBook Product'[Unit Price] AS  REAL )  )
                            * PFCAST ( 'DaxBook Customer'[Cashback] AS  REAL )  )
SELECT
    'DaxBook Customer'[Country],
    SUM ( @$Expr0 )
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Customer'
        ON 'DaxBook Sales'[CustomerKey]='DaxBook Customer'[CustomerKey]
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey];</pre></div>
<p class="edition">Using the <em class="calibre5">RELATED</em> function does not require any <em class="calibre5">CallbackDataID</em>. Indeed, the only consequence of <em class="calibre5">RELATED</em> is that it enforces a join in the storage engine to enable the access to the related column, which typically has a smaller performance impact compared to a <em class="calibre5">CallbackDataID</em>. However, the “fast” version of the measure is not suggested unless it is critical to obtain the last additional performance improvement and to keep the materialization at a minimal level.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-347" class="calibre13">Avoiding table filters for <em class="calibre5">DISTINCTCOUNT</em></h4>
<p class="edition">We already mentioned that filter arguments in <em class="calibre5">CALCULATE</em>/<em class="calibre5">CALCULATETABLE</em> functions should be applied to columns instead of tables. The goal of this example on the same topic is to show you an additional query plan pattern that you might find in server timings. A side effect of a table filter is that it requires a large materialization to the storage engine, to enable the formula engine to compute the result. However, for non-additive expressions, the query plan might generate one storage engine query for each element included in the granularity of the result. The <em class="calibre5">DISTINCTCOUNT</em> aggregation is a simple and common example of a non-additive expression.</p>
<p class="edition">For example, consider the report in <a href="#calibre_link-1621" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-42</a> that shows the number of customers that made purchases over $1,000 (<em class="calibre5">Customers 1k</em>) for each product name.</p>
<figure id="calibre_link-1621" class="image-l">
<img src="images/000732.jpg" alt="The report shows Customers 1k (slow) and Customers 1k (fast) per Product Name." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-42</strong> Customers with purchase amounts over $1,000 for each product.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-3269"></span>The filter condition in the <em class="calibre5">Customers 1k</em> measure requires two columns. The less efficient way to implement such a condition is by using a filter over the <em class="calibre5">Sales</em> table. The following query computes the <em class="calibre5">Customers 1k</em> measure in the previous report, generating the server timings results visible in <a href="#calibre_link-1622" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-43</a>:</p>
<p class="codelink"><a href="#calibre_link-1623" id="calibre_link-2896" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Customers 1k (slow)] =
        CALCULATE (
            <strong class="calibre7">DISTINCTCOUNT ( Sales[CustomerKey] ),</strong>
            FILTER (
                <strong class="calibre7">Sales,</strong>
                Sales[Quantity] * Sales[Net Price] &gt; 1000
            )
        )
EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL ( 'Product'[Product Name], "IsGrandTotalRowTotal" ),
        "Customers_1k__slow_", 'Sales'[Customers 1k (slow)]
    ),
    [IsGrandTotalRowTotal], 0,
    'Product'[Product Name], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Product'[Product Name]</pre></div>
<figure id="calibre_link-1622" class="image-l">
<img src="images/000725.jpg" alt="The figure shows Server Timings for Customers 1k (slow)." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-43</strong> Server Timings running the query for the <em class="calibre5">Customers 1k (slow)</em> measure.</figcaption>
</figure>
<p class="edition">This query generates a large number of storage engine queries&mdash;one query for each product included in the result. Because each storage engine query requires 100 to 200 milliseconds, there are a total of several minutes of CPU cost, and the latency is below one minute just because of the parallelism of the storage engine.</p>
<p class="edition">The first xmSQL query at line 2 of <a href="#calibre_link-1622" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-43</a> returns the list of product names, including <em class="calibre5">Quantity</em> and <em class="calibre5">Net Price</em> for the sales transactions of that product. Indeed, even though there are only 1,091 products used at least once in the <em class="calibre5">Sales</em> table in transactions with an amount greater than $1,000, the <span type="pagebreak" id="calibre_link-3270"></span>granularity of the datacache is larger because it also includes additional details other than the product name, returning more rows for the same product:</p>
<p class="codelink"><a href="#calibre_link-1624" id="calibre_link-2897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    'DaxBook Product'[Product Name],
    'DaxBook Sales'[Quantity],
    'DaxBook Sales'[Net Price]
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey]
WHERE
    ( COALESCE (  ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                             * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )  )
      &gt; COALESCE ( 1000.000000 )
    );</pre></div>
<p class="edition">There are 1,091 xmSQL queries that are very similar to the one at line 6 of <a href="#calibre_link-1622" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-43</a> and return a single value obtained with a distinct count aggregation. In this case, the filter condition has all the combinations of <em class="calibre5">Quantity</em> and <em class="calibre5">Net Price</em> that return a value greater than 1,000 for the Adventure Works 52″ LCD HDTV X790W Silver product:</p>
<p class="codelink"><a href="#calibre_link-1625" id="calibre_link-2898" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    <strong class="calibre7">DCOUNT ( 'DaxBook Sales'[CustomerKey] )</strong>
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey]
WHERE
    ( COALESCE (  ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                             * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )  )
       &gt; COALESCE ( 1000.000000 )
    )
VAND (
        'DaxBook Product'[Product Name],
        'DaxBook Sales'[Quantity],
        'DaxBook Sales'[Net Price] )
    <strong class="calibre7">IN {</strong>
        <strong class="calibre7">( 'Adventure Works 52" LCD HDTV X790W Silver', 2, 1592.200000 ) ,</strong>
        <strong class="calibre7">( 'Adventure Works 52" LCD HDTV X790W Silver', 4, 1432.980000 ) ,</strong>
        <strong class="calibre7">( 'Adventure Works 52" LCD HDTV X790W Silver', 1, 1273.760000 ) ,</strong>
        <strong class="calibre7">( 'Adventure Works 52" LCD HDTV X790W Silver', 3, 1480.746000 ) ,</strong>
        <strong class="calibre7">( 'Adventure Works 52" LCD HDTV X790W Silver', 4, 1512.590000 ) ,</strong>
        <strong class="calibre7">( 'Adventure Works 52" LCD HDTV X790W Silver', 3, 1592.200000 ) ,</strong>
        <strong class="calibre7">( 'Adventure Works 52" LCD HDTV X790W Silver', 3, 1353.370000 ) ,</strong>
        <strong class="calibre7">( 'Adventure Works 52" LCD HDTV X790W Silver', 4, 1273.760000 ) ,</strong>
        <strong class="calibre7">( 'Adventure Works 52" LCD HDTV X790W Silver', 1, 1480.746000 ) ,</strong>
        <strong class="calibre7">( 'Adventure Works 52" LCD HDTV X790W Silver', 1, 1592.200000 )</strong>
    <strong class="calibre7">..[24 total tuples, not all displayed]};</strong></pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-3271"></span>Indeed, the following xmSQL query at line 10 of <a href="#calibre_link-1622" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-43</a> only differs from the latter in the final filter condition, which includes valid combinations of <em class="calibre5">Quantity</em> and <em class="calibre5">Net Price</em> for the Contoso Washer &amp; Dryer 21in E210 Blue product:</p>
<p class="codelink"><a href="#calibre_link-1626" id="calibre_link-2899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    <strong class="calibre7">DCOUNT ( 'DaxBook Sales'[CustomerKey] )</strong>
FROM 'DaxBook Sales'
    LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey]
WHERE
    ( COALESCE (  ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                             * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )  )
       &gt; COALESCE ( 1000.000000 )
    )
VAND (
        'DaxBook Product'[Product Name],
        'DaxBook Sales'[Quantity],
        'DaxBook Sales'[Net Price] )
    <strong class="calibre7">IN {</strong>
         <strong class="calibre7">( 'Contoso Washer &amp; Dryer 21in E210 Blue', 2, 1519.050000 ) ,</strong>
         <strong class="calibre7">( 'Contoso Washer &amp; Dryer 21in E210 Blue', 2, 1279.200000 ) ,</strong>
         <strong class="calibre7">( 'Contoso Washer &amp; Dryer 21in E210 Blue', 2, 1359.150000 ) ,</strong>
         <strong class="calibre7">( 'Contoso Washer &amp; Dryer 21in E210 Blue', 4, 1487.070000 ) ,</strong>
         <strong class="calibre7">( 'Contoso Washer &amp; Dryer 21in E210 Blue', 3, 1439.100000 ) ,</strong>
         <strong class="calibre7">( 'Contoso Washer &amp; Dryer 21in E210 Blue', 3, 1519.050000 ) ,</strong>
         <strong class="calibre7">( 'Contoso Washer &amp; Dryer 21in E210 Blue', 3, 1359.150000 ) ,</strong>
         <strong class="calibre7">( 'Contoso Washer &amp; Dryer 21in E210 Blue', 2, 1599.000000 ) ,</strong>
         <strong class="calibre7">( 'Contoso Washer &amp; Dryer 21in E210 Blue', 1, 1439.100000 ) ,</strong>
         <strong class="calibre7">( 'Contoso Washer &amp; Dryer 21in E210 Blue', 3, 1279.200000 )</strong>
    <strong class="calibre7">..[24 total tuples, not all displayed]};</strong></pre></div>
<p class="edition">The presence of multiple similar storage engine queries is also visible in the Query Plan pane shown in <a href="#calibre_link-1627" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-44</a>. Each row starting at line 15 corresponds to a single datacache with just one column produced by one of the storage engine queries described before.</p>
<figure id="calibre_link-1627" class="image-l">
<img src="images/000746.jpg" alt="The figure shows the query plan for Customers 1k (slow)." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-44</strong> Query Plan pane running the query for <em class="calibre5">Customers 1k (slow)</em>.</figcaption>
</figure>
<p class="edition">The presence of the table filter applied to the filter context forces a query plan that is not efficient. In this case, a table filter produces multiple storage engine queries instead of a single large materialization. However, the optimization required is always the same: Column filters are better than table filters <span type="pagebreak" id="calibre_link-3272"></span>in <em class="calibre5">CALCULATE</em> and <em class="calibre5">CALCULATETABLE</em>. The optimized version of the <em class="calibre5">Customer 1k</em> measure applies a filter over the two columns <em class="calibre5">Quantity</em> and <em class="calibre5">Net Price</em>, using <em class="calibre5">KEEPFILTERS</em> in order to use the filter semantic of the original measure. The following query produces the Server Timings results visible in <a href="#calibre_link-1628" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-45</a>:</p>
<p class="codelink"><a href="#calibre_link-1629" id="calibre_link-2900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Customers 1k (fast)] =
        CALCULATE (
            DISTINCTCOUNT ( Sales[CustomerKey] ),
            <strong class="calibre7">KEEPFILTERS (</strong>
                <strong class="calibre7">FILTER (</strong>
                    <strong class="calibre7">ALL (</strong>
                        <strong class="calibre7">Sales[Quantity],</strong>
                        <strong class="calibre7">Sales[Net Price]</strong>
                    <strong class="calibre7">),</strong>
                    <strong class="calibre7">Sales[Quantity] * Sales[Net Price] &gt; 1000</strong>
                <strong class="calibre7">)</strong>
            <strong class="calibre7">)</strong>
        )
EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL ( 'Product'[Product Name], "IsGrandTotalRowTotal" ),
        "Customers_1k__fast_", 'Sales'[Customers 1k (fast)]
    ),
    [IsGrandTotalRowTotal], 0,
    'Product'[Product Name], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Product'[Product Name]</pre></div>
<figure id="calibre_link-1628" class="image-l">
<img src="images/000739.jpg" alt="The figure shows the Server Timings for Customers 1k (fast)." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-45</strong> Server Timings running the query for <em class="calibre5">Customers 1k (fast)</em>.</figcaption>
</figure>
<p class="edition">The column filter in <em class="calibre5">CALCULATE</em> simplifies the query plan, which now only requires two storage engine queries&mdash;one for each granularity level of the result (one product versus total of all products). The following is the xmSQL query at line 4 in <a href="#calibre_link-1628" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-45</a>:</p>
<p class="codelink"><a href="#calibre_link-1630" id="calibre_link-2901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">SELECT
    'DaxBook Product'[Product Name],
    DCOUNT ( 'DaxBook Sales'[CustomerKey] )
FROM 'DaxBook Sales'
    <span type="pagebreak" id="calibre_link-1974"></span>LEFT OUTER JOIN 'DaxBook Product'
        ON 'DaxBook Sales'[ProductKey]='DaxBook Product'[ProductKey]
WHERE
    ( COALESCE (  ( CAST ( PFCAST ( 'DaxBook Sales'[Quantity] AS  INT ) AS  REAL )
                             * PFCAST ( 'DaxBook Sales'[Net Price] AS  REAL )  )  )
      &gt; COALESCE ( 1000.000000 )
    );</pre></div>
<p class="edition">The datacache obtained corresponds to the result of the DAX query. The formula engine does not have to do any further processing. This is an optimal condition for the performance of this query. The lesson here is that the number of storage engine queries can also matter. A large number of storage engine queries might be the result of a bad query plan. Non-additive measures combined with table filters or bidirectional filters could be one of the reasons for this behavior, impacting performance in a negative way.</p>
</section>
<section class="calibre4">
<h4 id="calibre_link-348" class="calibre13">Avoiding multiple evaluations by using variables</h4>
<p class="edition">When a DAX expression evaluates the same subexpression multiple times, it is usually a good idea to store the result of the subexpression in a variable, referencing the variable name in following parts of the original DAX expression. The use of variables is a best practice which improves code readability and can provide a better and more efficient query plan&mdash;with just some exceptions described later in this section.</p>
<p class="edition">For example, the report in <a href="#calibre_link-1631" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-46</a> shows a <em class="calibre5">Sales YOY %</em> measure computing the percentage difference between the value of <em class="calibre5">Sales Amount</em> displayed in the row of the report and the corresponding value in the previous year.</p>
<figure id="calibre_link-1631" class="image-l">
<img src="images/000760.jpg" alt="The report displays Sales Amount, Sales YOY % (slow), and Sales YOY % (fast) per year." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-46</strong> Difference in sales year over year reported by year and month.</figcaption>
</figure>
<p class="edition">The <em class="calibre5">Sales YOY %</em> measure uses other measures internally. In order to be able to modify each part of the calculation, it is useful to include all the underlying measures using the Define Dependent Measure feature in DAX Studio. The following query computes the original <em class="calibre5">Sales YOY % (slow)</em> measure in the previous report, generating the server timings results visible in <a href="#calibre_link-1632" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-47</a>:</p>
<p class="codelink"><a href="#calibre_link-1633" id="calibre_link-2902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Sales PY] =
        CALCULATE (
            <span type="pagebreak" id="calibre_link-3273"></span>[Sales Amount],
            SAMEPERIODLASTYEAR ( 'Date'[Date] )
        )
    MEASURE Sales[Sales YOY (slow)] =
        IF (
            NOT ISBLANK ( <strong class="calibre7">[Sales Amount]</strong> ) &amp;&amp; NOT ISBLANK ( <strong class="calibre7">[Sales PY]</strong> ),
            <strong class="calibre7">[Sales Amount]</strong> - <strong class="calibre7">[Sales PY]</strong>
        )
    MEASURE Sales[Sales Amount] =
        SUMX (
            Sales,
            Sales[Quantity] * Sales[Net Price]
        )
    MEASURE Sales[Sales YOY % (slow)] =
        DIVIDE (
            [Sales YOY (slow)],
            [Sales PY]
        )
EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL (
            ROLLUPGROUP (
                'Date'[Calendar Year Month],
                'Date'[Calendar Year Month Number]
            ), "IsGrandTotalRowTotal"
        ),
        "Sales_YOY____slow_", 'Sales'[Sales YOY % (slow)]
    ),
    [IsGrandTotalRowTotal], 0,
    'Date'[Calendar Year Month Number], 1,
    'Date'[Calendar Year Month], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Date'[Calendar Year Month Number],
    'Date'[Calendar Year Month]</pre></div>
<figure id="calibre_link-1632" class="image-l">
<img src="images/000753.jpg" alt="The figure shows the Server Timings for Sales YOY % (slow)." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-47</strong> Server Timings running the query for the <em class="calibre5">Sales YOY % (slow)</em> measure.</figcaption>
</figure>
<p class="edition">The description of the query plan includes 1,819 rows, not reported here. Moreover, there are four storage engine queries retrieved by the storage engine cache (<em class="calibre5">SE Cache</em>), even though we executed a clear cache command before running the query. This indicates that different parts of the query plan<span type="pagebreak" id="calibre_link-3274"></span> generate different requests for the same storage engine query. Although the cache improves the performance of the storage engine request, the presence of such redundancy in the query plan is an indicator that there is room for further improvements.</p>
<p class="edition">When a query plan is so complex and there are many storage engine queries, it is a good idea to review the DAX code and reduce redundant evaluations by using variables. Indeed, redundant evaluations could be responsible for these duplicated requests. In general, the DAX engine should be able to locate similar subexpressions executed within the same filter context, and reuse their results without multiple evaluations. However, the presence of logical conditions such as <em class="calibre5">IF</em> and <em class="calibre5">SWITCH</em> creating different branches of execution can easily stop this internal optimization.</p>
<p class="edition">For example, consider the <em class="calibre5">Sales YOY (slow)</em> measure implementation: the <em class="calibre5">Sales Amount</em> and <em class="calibre5">Sales PY</em> measures are executed in different branches of the evaluation. The first argument of the <em class="calibre5">IF</em> function must always be evaluated, whereas the second argument should only be evaluated whenever the first argument evaluates to <em class="calibre5">TRUE</em>. A DAX expression that is present in both the first and the second argument might be evaluated twice in the query plan, which might not consider the result obtained for the first argument as something that can be reused when evaluating the second argument. The technical reasons why this happens and when it turns out to be preferable are outside the scope of this book.</p>
<p class="edition">The following excerpt of the previous query highlights the measure references that might be evaluated twice because they are in both the first and the second argument:</p>
<p class="codelink"><a href="#calibre_link-1634" id="calibre_link-2903" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">MEASURE Sales[Sales YOY (slow)] =
    IF (
        NOT ISBLANK ( <strong class="calibre7">[Sales Amount]</strong> ) &amp;&amp; NOT ISBLANK ( <strong class="calibre7">[Sales PY]</strong> ),
        <strong class="calibre7">[Sales Amount]</strong> - <strong class="calibre7">[Sales PY]</strong>
    )</pre></div>
<p class="edition">By storing the values returned by the two measures <em class="calibre5">Sales Amount</em> and <em class="calibre5">Sales PY</em> in two variables, it is possible to instruct the DAX engine to enforce a single evaluation of the two measures before the <em class="calibre5">IF</em> condition, reusing the result in both the first and the second argument. The following excerpt of the <em class="calibre5">Sales YOY (fast)</em> measure shows how to implement this technique in the DAX code:</p>
<p class="codelink"><a href="#calibre_link-1635" id="calibre_link-2904" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">MEASURE Sales[Sales YOY (fast)] =
    VAR SalesPY = <strong class="calibre7">[Sales PY]</strong>
    VAR SalesAmount = <strong class="calibre7">[Sales Amount]</strong>
    RETURN
        IF (
            NOT ISBLANK ( SalesAmount ) &amp;&amp; NOT ISBLANK ( SalesPY ),
            SalesAmount - SalesPY
        )</pre></div>
<p class="edition">The following query includes a full implementation of the <em class="calibre5">Sales YOY (fast) %</em> measure, which internally relies on <em class="calibre5">Sales YOY (fast)</em> instead of <em class="calibre5">Sales YOY (slow)</em>. The execution of the query produces the server timings results visible in <a href="#calibre_link-1636" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Figure 20-48</a>:</p>
<p class="codelink"><a href="#calibre_link-1637" id="calibre_link-2905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">DEFINE
    MEASURE Sales[Sales PY] =
        CALCULATE (
            <span type="pagebreak" id="calibre_link-3275"></span>[Sales Amount],
            SAMEPERIODLASTYEAR ( 'Date'[Date] )
        )
    MEASURE Sales[Sales YOY (fast)] =
        VAR SalesPY = <strong class="calibre7">[Sales PY]</strong>
        VAR SalesAmount = <strong class="calibre7">[Sales Amount]</strong>
        RETURN
            IF (
                NOT ISBLANK ( SalesAmount ) &amp;&amp; NOT ISBLANK ( SalesPY ),
                SalesAmount - SalesPY
            )
    MEASURE Sales[Sales Amount] =
        SUMX (
            Sales,
            Sales[Quantity] * Sales[Net Price]
        )
    MEASURE Sales[Sales YOY % (fast)] =
        DIVIDE (
            [Sales YOY (fast)],
            [Sales PY]
        )
EVALUATE
TOPN (
    502,
    SUMMARIZECOLUMNS (
        ROLLUPADDISSUBTOTAL (
            ROLLUPGROUP (
                'Date'[Calendar Year Month],
                'Date'[Calendar Year Month Number]
            ), "IsGrandTotalRowTotal"
        ),
        "Sales_YOY____fast_", 'Sales'[Sales YOY % (fast)]
    ),
    [IsGrandTotalRowTotal], 0,
    'Date'[Calendar Year Month Number], 1,
    'Date'[Calendar Year Month], 1
)
ORDER BY
    [IsGrandTotalRowTotal] DESC,
    'Date'[Calendar Year Month Number],
    'Date'[Calendar Year Month]</pre></div>
<figure id="calibre_link-1636" class="image-l">
<img src="images/000774.jpg" alt="The figure shows the Server Timings for Sales YOY % (fast)." class="calibre11" />
<figcaption class="calibre12"><strong class="calibre7">Figure 20-48</strong> Server Timings running the query for <em class="calibre5">Sales YOY % (fast)</em>.</figcaption>
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-1897"></span>The description of the query plan includes 488 rows (not reported here), reducing the complexity of the query plan by 73%; the previous query plan was 1,819 rows long. The new query plan reduces the cost for the storage engine in terms of both execution time and number of queries, and it also reduces the execution time in the formula engine. Overall, the optimized measure reduces the execution time by about 50%, but the optimization could be even bigger in more complex models and expressions. If the same optimization were applied to nested measures, the improvement might be exponential.</p>
<p class="edition">However, pay attention to possible side effects of assigning variables before conditional statements. Only the subexpressions used in the first argument can be assigned to variables defined before an <em class="calibre5">IF</em> or <em class="calibre5">SWITCH</em> statement; otherwise, the effect could be the opposite, enforcing the evaluation of expressions that would otherwise be ignored. You should follow these guidelines:</p>
<ul class="sq">
<li class="calibre10"><p class="listp">When the same DAX expression is evaluated multiple times within the same filter context, assign it to a variable and reference the variable instead of the DAX expression.</p></li>
<li class="calibre10"><p class="listp">When a DAX expression is evaluated within the branches of an <em class="calibre5">IF</em> or <em class="calibre5">SWITCH</em>, whenever necessary assign the expression to a variable within the conditional branch.</p></li>
<li class="calibre10"><p class="listp">Do not assign a variable outside an <em class="calibre5">IF</em> or <em class="calibre5">SWITCH</em> statement if the variable is only used within the conditional branch.</p></li>
<li class="calibre10"><p class="listp">The first argument of <em class="calibre5">IF</em> and <em class="calibre5">SWITCH</em> can use variables defined before <em class="calibre5">IF</em> and <em class="calibre5">SWITCH</em> without it affecting performance.</p></li>
</ul>
<p class="edition">More examples about these guidelines are included in this article: <a href="https://www.sqlbi.com/articles/optimizing-if-and-switch-expressions-using-variables/" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">https://www.sqlbi.com/articles/optimizing-if-and-switch-expressions-using-variables/</a></p>
<div class="sidebar">
<p class="edition">Implementing alternative conditional statements</p>
<p class="edition">In the last example we used a simple <em class="calibre5">IF</em> statement to show a possible optimization using variables. While using variables is a best practice, it is worth mentioning that there are alternative ways to express the same conditional logic in DAX. For example, whenever an <em class="calibre5">IF</em> function returns a numeric value and the expression of the second argument does not raise an execution error when the condition of the first argument is <em class="calibre5">TRUE</em>, it is possible to convert this code:</p>
<p class="codelink"><a href="#calibre_link-1638" id="calibre_link-2906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">IF ( &lt;condition=, &lt;expression= )

   Into:

&lt;expression= * &lt;condition=</pre></div>
<p class="edition">For example, the Sales YOY (fast) measure can be implemented using this expression:</p>
<p class="codelink"><a href="#calibre_link-1639" id="calibre_link-2907" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">Click here to view code image</a></p>
<div class="program"><pre class="calibre14">MEASURE Sales[Sales YOY (fast)] =
    ( [Sales Amount] - [Sales PY] )
        * ( NOT ISBLANK ( [Sales Amount] ) &amp;&amp; NOT ISBLANK ( [Sales PY] ) )</pre></div>
<p class="edition"><span type="pagebreak" id="calibre_link-1898"></span>The result produces only 208 rows in the query plan, despite a very similar query duration. Nevertheless, in more complex models the reduction of the query plan might have more visible benefits. However, different versions of the engine will tend to produce different results. Consider this alternative coding style one of the options available in case you need to further optimize your code. Do not apply such techniques without checking the effects on performance and query plans, verifying whether they improve performance and whether they are worth reducing the readability of your code.</p>
</div>
</section>
</section>
<section class="calibre4">
<h3 id="calibre_link-349" class="h2a">Conclusions</h3>
<p class="edition">The lesson in this last chapter (to be honest, in the entire book) is that you must consider all the factors that affect a query plan in order to find the real bottleneck. Looking at the percentages of FE and SE shown in server timings is a good starting point, but you should always investigate the reason behind the numbers. Tools like DAX Studio and VertiPaq Analyzer provide you with the ability to measure the effects of a bad query plan, but these are only clues and pieces of evidence pointing to the reasons for a slow query.</p>
<p class="edition">Welcome to the DAX world!<span type="pagebreak" id="calibre_link-3276"></span></p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1640">
<div id="calibre_link-3277" class="calibre2">
<div id="calibre_link-3278" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-26"><span type="pagebreak" id="calibre_link-3279"></span>Index</h2>
<section class="calibre4">
<h3 id="calibre_link-3280" class="h2a">Numbers</h3>
<p class="edition" id="calibre_link-3281">1:1 relationships (data models), <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-3282" class="h2a">A</h3>
<p class="edition" id="calibre_link-3283">active relationships</p>
<p class="edition" id="calibre_link-3284">ambiguity, <a href="#calibre_link-1642" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">514</a>&ndash;<a href="#calibre_link-1643" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">515</a></p>
<p class="edition" id="calibre_link-3285">CALCULATETABLE function, <a href="#calibre_link-1644" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">451</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-3286">expanded tables and, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-3287">USERELATIONSHIP function, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1644" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">451</a></p>
<p class="edition" id="calibre_link-3288">ADDCOLUMNS function, <a href="#calibre_link-1647" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">223</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a>, <a href="#calibre_link-1649" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">366</a>&ndash;<a href="#calibre_link-1650" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">369</a>, <a href="#calibre_link-1651" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">371</a>&ndash;<a href="#calibre_link-1652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">372</a></p>
<p class="edition" id="calibre_link-3289">ADDCOLUMNS iterators, <a href="#calibre_link-1653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">196</a>&ndash;<a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-3290">ADDMISSINGITEMS function</p>
<p class="edition" id="calibre_link-3291">authoring queries, <a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a>&ndash;<a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>, <a href="#calibre_link-1657" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">432</a>&ndash;<a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a></p>
<p class="edition" id="calibre_link-3292">auto-exists feature (queries), <a href="#calibre_link-1657" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">432</a>&ndash;<a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a></p>
<p class="edition" id="calibre_link-3293">aggregation functions, xmSQL queries, <a href="#calibre_link-1659" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">625</a>&ndash;<a href="#calibre_link-1660" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">627</a></p>
<p class="edition" id="calibre_link-3294">aggregations, <a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a>&ndash;<a href="#calibre_link-1662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">571</a></p>
<p class="edition" id="calibre_link-3295">in data models, <a href="#calibre_link-1663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">587</a>&ndash;<a href="#calibre_link-1664" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">588</a>, <a href="#calibre_link-1665" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">647</a>&ndash;<a href="#calibre_link-1666" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">648</a></p>
<p class="edition" id="calibre_link-3296">SE, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-3297">VertiPaq aggregations, managing, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a>&ndash;<a href="#calibre_link-1669" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">607</a></p>
<p class="edition" id="calibre_link-3298">aggregators, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a>, <a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a>, <a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a>, <a href="#calibre_link-1673" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">45</a>&ndash;<a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3299">AVERAGE function, <a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a>&ndash;<a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a></p>
<p class="edition" id="calibre_link-3300">AVERAGEX function, <a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a></p>
<p class="edition" id="calibre_link-3301">COUNT function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3302">COUNTA function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3303">COUNTBLANK function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3304">COUNTROWS function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3305">DISTINCTCOUNT function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3306">DISTINCTCOUNTNOBLANK function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3307">MAX function, <a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a></p>
<p class="edition" id="calibre_link-3308">MIN function, <a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a></p>
<p class="edition" id="calibre_link-3309">SUM function, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a>&ndash;<a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a>, <a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a>&ndash;<a href="#calibre_link-1673" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">45</a></p>
<p class="edition" id="calibre_link-3310">SUMX function, <a href="#calibre_link-1673" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">45</a></p>
<p class="edition" id="calibre_link-3311">ALL function, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>&ndash;<a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a></p>
<p class="edition" id="calibre_link-3312">ALLEXCEPT function versus, <a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-3313">CALCULATE function and, <a href="#calibre_link-1679" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">125</a>&ndash;<a href="#calibre_link-1680" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">132</a>, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>, <a href="#calibre_link-1682" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">169</a>&ndash;<a href="#calibre_link-1683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">172</a></p>
<p class="edition" id="calibre_link-3314">calculated physical relationships, circular dependencies, <a href="#calibre_link-1684" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">478</a></p>
<p class="edition" id="calibre_link-3315">columns and, <a href="#calibre_link-1685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">64</a>&ndash;<a href="#calibre_link-1686" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">65</a></p>
<p class="edition" id="calibre_link-3316">computing percentages, <a href="#calibre_link-1679" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">125</a>&ndash;<a href="#calibre_link-1680" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">132</a></p>
<p class="edition" id="calibre_link-3317">context transitions, avoiding, <a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a>&ndash;<a href="#calibre_link-1687" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">330</a></p>
<p class="edition" id="calibre_link-3318">evaluation contexts, <a href="#calibre_link-1688" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">100</a>&ndash;<a href="#calibre_link-1689" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">101</a></p>
<p class="edition" id="calibre_link-3319">filter contexts, <a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a>&ndash;<a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>, <a href="#calibre_link-1691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">327</a>&ndash;<a href="#calibre_link-1687" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">330</a></p>
<p class="edition" id="calibre_link-3320">measures and, <a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a>&ndash;<a href="#calibre_link-1685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">64</a></p>
<p class="edition" id="calibre_link-3321">nonworking days between two dates, computing, <a href="#calibre_link-1693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">523</a>&ndash;<a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a></p>
<p class="edition" id="calibre_link-3322">percentages, computing, <a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a>&ndash;<a href="#calibre_link-1685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">64</a></p>
<p class="edition" id="calibre_link-3323">syntax of, <a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a></p>
<p class="edition" id="calibre_link-3324">top categories/subcategories example, <a href="#calibre_link-1695" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">66</a>&ndash;<a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a></p>
<p class="edition" id="calibre_link-3325">VALUES function and, <a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a>, <a href="#calibre_link-1691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">327</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-3326">ALL* functions, <a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a>&ndash;<a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a></p>
<p class="edition" id="calibre_link-3327">ALLCROSSFILTERED function, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a></p>
<p class="edition" id="calibre_link-3328">ALLEXCEPT function, <a href="#calibre_link-1686" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">65</a>&ndash;<a href="#calibre_link-1695" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">66</a>, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a></p>
<p class="edition" id="calibre_link-3329">ALL function versus, <a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-3330">computing percentages, <a href="#calibre_link-1698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">135</a></p>
<p class="edition" id="calibre_link-3331">filter contexts, <a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-3332">VALUES function versus, <a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-3333">ALLNOBLANKROW function, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a>, <a href="#calibre_link-1684" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">478</a></p>
<p class="edition" id="calibre_link-3334">ALLSELECTED function, <a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a>&ndash;<a href="#calibre_link-1700" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">75</a>, <a href="#calibre_link-1701" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">76</a>, <a href="#calibre_link-1702" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">455</a>&ndash;<a href="#calibre_link-1703" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">457</a>, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a></p>
<p class="edition" id="calibre_link-3335">CALCULATE function and, <a href="#calibre_link-1704" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">171</a>&ndash;<a href="#calibre_link-1683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">172</a></p>
<p class="edition" id="calibre_link-3336">computing percentages, <a href="#calibre_link-1700" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">75</a>&ndash;<a href="#calibre_link-1701" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">76</a></p>
<p class="edition" id="calibre_link-3337">iterated rows, returning, <a href="#calibre_link-1705" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">460</a>&ndash;<a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a></p>
<p class="edition" id="calibre_link-3338">shadow filter contexts, <a href="#calibre_link-1706" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">459</a>&ndash;<a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a></p>
<p class="edition" id="calibre_link-3339">alternate/primary keys column (tables), <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a>, <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a></p>
<p class="edition" id="calibre_link-3340">ambiguity in relationships, <a href="#calibre_link-1709" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">512</a>&ndash;<a href="#calibre_link-1710" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">513</a></p>
<p class="edition" id="calibre_link-3341">active relationships, <a href="#calibre_link-1642" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">514</a>&ndash;<a href="#calibre_link-1643" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">515</a></p>
<p class="edition" id="calibre_link-3342">non-active relationships, <a href="#calibre_link-1643" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">515</a>&ndash;<a href="#calibre_link-1711" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">517</a></p>
<p class="edition" id="calibre_link-3343">Analysis Services 2012/2014 and CallbackDataID function, <a href="#calibre_link-1712" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">644</a></p>
<p class="edition" id="calibre_link-3344">annual totals (moving), computing, <a href="#calibre_link-1713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">243</a>&ndash;<a href="#calibre_link-1714" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">244</a></p>
<p class="edition" id="calibre_link-3345">arbitrarily shaped filters, <a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-3346">best practices, <a href="#calibre_link-1716" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">343</a></p>
<p class="edition" id="calibre_link-3347">building, <a href="#calibre_link-1717" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">338</a>&ndash;<a href="#calibre_link-1716" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">343</a></p>
<p class="edition" id="calibre_link-3348"><span type="pagebreak" id="calibre_link-3349"></span>column filters versus, <a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-3350">defined, <a href="#calibre_link-1718" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">337</a>&ndash;<a href="#calibre_link-1717" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">338</a></p>
<p class="edition" id="calibre_link-3351">simple filters versus, <a href="#calibre_link-1718" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">337</a></p>
<p class="edition" id="calibre_link-3352">uses of, <a href="#calibre_link-1716" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">343</a></p>
<p class="edition" id="calibre_link-3353">arithmetic operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-3354">error-handling</p>
<p class="edition" id="calibre_link-3355">division by zero, <a href="#calibre_link-1720" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">32</a>&ndash;<a href="#calibre_link-1721" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">33</a></p>
<p class="edition" id="calibre_link-3356">empty/missing values, <a href="#calibre_link-1721" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">33</a>&ndash;<a href="#calibre_link-1722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">35</a></p>
<p class="edition" id="calibre_link-3357">xmSQL queries, <a href="#calibre_link-1660" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">627</a></p>
<p class="edition" id="calibre_link-3358">arrows (cross filter direction), <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-3359">attributes, data model optimization</p>
<p class="edition" id="calibre_link-3360">disabling attribute hierarchies, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a></p>
<p class="edition" id="calibre_link-3361">optimizing drill-through attributes, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a></p>
<p class="edition" id="calibre_link-3362">authoring queries, <a href="#calibre_link-1724" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">395</a></p>
<p class="edition" id="calibre_link-3363">ADDMISSINGITEMS function, <a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a>&ndash;<a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>, <a href="#calibre_link-1657" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">432</a>&ndash;<a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a></p>
<p class="edition" id="calibre_link-3364">auto-exists feature, <a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-3365">DAX Studio, <a href="#calibre_link-1724" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">395</a></p>
<p class="edition" id="calibre_link-3366">DEFINE sections</p>
<p class="edition" id="calibre_link-3367">MEASURE keyword in, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-3368">VAR keyword in, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-3369">EVALUATE statements</p>
<p class="edition" id="calibre_link-3370">ADDMISSINGITEMS function, <a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a>&ndash;<a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>, <a href="#calibre_link-1657" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">432</a>&ndash;<a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a></p>
<p class="edition" id="calibre_link-3371">example of, <a href="#calibre_link-1729" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">396</a></p>
<p class="edition" id="calibre_link-3372">expression variables and, <a href="#calibre_link-1730" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">398</a></p>
<p class="edition" id="calibre_link-3373">GENERATE function, <a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a>&ndash;<a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-3374">GENERATEALL function, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-3375">GROUPBY function, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>&ndash;<a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a></p>
<p class="edition" id="calibre_link-3376">ISONORAFTER function, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a>&ndash;<a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a></p>
<p class="edition" id="calibre_link-3377">NATURALINNERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-3378">NATURALLEFTOUTERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-3379">query variables and, <a href="#calibre_link-1730" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">398</a></p>
<p class="edition" id="calibre_link-3380">ROW function, <a href="#calibre_link-1735" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">400</a>&ndash;<a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-3381">SAMPLE function, <a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a>&ndash;<a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a></p>
<p class="edition" id="calibre_link-3382">SUBSTITUTEWITHINDEX function, <a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a>&ndash;<a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a></p>
<p class="edition" id="calibre_link-3383">SUMMARIZE function, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a>&ndash;<a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>, <a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-3384">SUMMARIZECOLUMNS function, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>, <a href="#calibre_link-1740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">429</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-3385">syntax of, <a href="#calibre_link-1729" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">396</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-3386">TOPN function, <a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>&ndash;<a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a></p>
<p class="edition" id="calibre_link-3387">TOPNSKIP function, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a></p>
<p class="edition" id="calibre_link-3388">expression variables, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-3389">GENERATE function, <a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a>&ndash;<a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-3390">GENERATEALL function, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-3391">GROUPBY function, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>&ndash;<a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a></p>
<p class="edition" id="calibre_link-3392">ISONORAFTER function, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a>&ndash;<a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a></p>
<p class="edition" id="calibre_link-3393">MEASURE in DEFINE sections, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-3394">measures</p>
<p class="edition" id="calibre_link-3395">query measures, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-3396">testing, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a>&ndash;<a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-3397">NATURALINNERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-3398">NATURALLEFTOUTERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-3399">query variables, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-3400">ROW function, testing measures, <a href="#calibre_link-1735" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">400</a>&ndash;<a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-3401">SAMPLE function, <a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a>&ndash;<a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a></p>
<p class="edition" id="calibre_link-3402">shadow filter contexts, <a href="#calibre_link-1703" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">457</a>&ndash;<a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a></p>
<p class="edition" id="calibre_link-3403">SUBSTITUTEWITHINDEX function, <a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a>&ndash;<a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a></p>
<p class="edition" id="calibre_link-3404">SUMMARIZE function, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a>&ndash;<a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>, <a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-3405">SUMMARIZECOLUMNS function, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>, <a href="#calibre_link-1740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">429</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-3406">TOPN function, <a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>&ndash;<a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a></p>
<p class="edition" id="calibre_link-3407">TOPNSKIP function, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a></p>
<p class="edition" id="calibre_link-3408">VAR in DEFINE sections, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-3409">Auto Date/Time (Power BI), <a href="#calibre_link-1741" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">218</a>&ndash;<a href="#calibre_link-1742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">219</a></p>
<p class="edition" id="calibre_link-3410">auto-exists feature (queries), <a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-3411">automatic date columns (Power Pivot for Excel), <a href="#calibre_link-1742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">219</a></p>
<p class="edition" id="calibre_link-3412">AVERAGE function, <a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a>&ndash;<a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a>, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-3413">AVERAGEA function, returning averages, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-3414">averages (means)</p>
<p class="edition" id="calibre_link-3415">computing averages, AVERAGEX function, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a>&ndash;<a href="#calibre_link-1743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">201</a></p>
<p class="edition" id="calibre_link-3416">moving averages, <a href="#calibre_link-1743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">201</a>&ndash;<a href="#calibre_link-1744" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">202</a></p>
<p class="edition" id="calibre_link-3417">returning averages</p>
<p class="edition" id="calibre_link-3418">AVERAGE function, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-3419">AVERAGEA function, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-3420">AVERAGEX function, <a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a></p>
<p class="edition" id="calibre_link-3421">computing averages, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a>&ndash;<a href="#calibre_link-1743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">201</a></p>
<p class="edition" id="calibre_link-3422">filter contexts, <a href="#calibre_link-1745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">111</a>&ndash;<a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-3423">AVERAGEX iterators, <a href="#calibre_link-1747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">188</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-3424" class="h2a">B</h3>
<p class="edition" id="calibre_link-3425">batch events (xmSQL queries), <a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a>&ndash;<a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a></p>
<p class="edition" id="calibre_link-3426">bidirectional cross-filter direction (physical relationships), <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1751" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">491</a>&ndash;<a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-3427">bidirectional filtering (relationships), <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a>&ndash;<a href="#calibre_link-1754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">4</a></p>
<p class="edition" id="calibre_link-3428">bidirectional relationships, <a href="#calibre_link-1755" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">106</a>, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-3429">Binary data type, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-3430">BLANK function, <a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a></p>
<p class="edition" id="calibre_link-3431">blank rows, invalid relationships, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a>&ndash;<a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-3432">Boolean calculated columns, data model optimization, <a href="#calibre_link-1760" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">597</a>&ndash;<a href="#calibre_link-1761" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">598</a></p>
<p class="edition" id="calibre_link-3433">Boolean conditions, CALCULATE function, <a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a>&ndash;<a href="#calibre_link-1763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">120</a>, <a href="#calibre_link-1764" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">123</a>&ndash;<a href="#calibre_link-1765" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">124</a></p>
<p class="edition" id="calibre_link-3434">Boolean data type, <a href="#calibre_link-1766" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">22</a></p>
<p class="edition" id="calibre_link-3435"><span type="pagebreak" id="calibre_link-3436"></span>Boolean logic, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-3437">bottlenecks, DAX optimization, <a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a>&ndash;<a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-3438">identifying SE/FE bottlenecks, <a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a>&ndash;<a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-3439">optimizing bottlenecks, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-3440">bridge tables, MMR (Many-Many Relationships), <a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a>&ndash;<a href="#calibre_link-1770" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">499</a></p>
<p class="edition" id="calibre_link-3441">budget/sales information (calculations), showing together, <a href="#calibre_link-1771" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">527</a>&ndash;<a href="#calibre_link-1772" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">530</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-3442" class="h2a">C</h3>
<p class="edition" id="calibre_link-3443">CALCULATE function, <a href="#calibre_link-1773" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">115</a></p>
<p class="edition" id="calibre_link-3444">ALL function, <a href="#calibre_link-1679" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">125</a>&ndash;<a href="#calibre_link-1680" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">132</a>, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>, <a href="#calibre_link-1682" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">169</a>&ndash;<a href="#calibre_link-1683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">172</a></p>
<p class="edition" id="calibre_link-3445">ALLSELECTED function, <a href="#calibre_link-1704" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">171</a>&ndash;<a href="#calibre_link-1683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">172</a></p>
<p class="edition" id="calibre_link-3446">Boolean conditions, <a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a>&ndash;<a href="#calibre_link-1763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">120</a>, <a href="#calibre_link-1764" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">123</a>&ndash;<a href="#calibre_link-1765" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">124</a></p>
<p class="edition" id="calibre_link-3447">calculated physical relationships, circular dependencies, <a href="#calibre_link-1684" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">478</a>&ndash;<a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a></p>
<p class="edition" id="calibre_link-3448">calculation items, applying to expressions, <a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a>&ndash;<a href="#calibre_link-1776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">299</a></p>
<p class="edition" id="calibre_link-3449">circular dependencies, <a href="#calibre_link-1777" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">161</a>&ndash;<a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a></p>
<p class="edition" id="calibre_link-3450">computing percentages, <a href="#calibre_link-1765" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">124</a>, <a href="#calibre_link-1698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">135</a></p>
<p class="edition" id="calibre_link-3451">ALL function, <a href="#calibre_link-1679" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">125</a>&ndash;<a href="#calibre_link-1680" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">132</a></p>
<p class="edition" id="calibre_link-3452">ALLEXCEPT function, <a href="#calibre_link-1698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">135</a></p>
<p class="edition" id="calibre_link-3453">VALUES function, <a href="#calibre_link-1778" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">133</a>&ndash;<a href="#calibre_link-1779" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">134</a></p>
<p class="edition" id="calibre_link-3454">context transitions, <a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a>, <a href="#calibre_link-1781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">151</a>&ndash;<a href="#calibre_link-1782" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">154</a></p>
<p class="edition" id="calibre_link-3455">calculated columns, <a href="#calibre_link-1782" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">154</a>&ndash;<a href="#calibre_link-1783" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">157</a></p>
<p class="edition" id="calibre_link-3456">measures, <a href="#calibre_link-1783" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">157</a>&ndash;<a href="#calibre_link-1784" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">160</a></p>
<p class="edition" id="calibre_link-3457">CROSSFILTER function, <a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a></p>
<p class="edition" id="calibre_link-3458">evaluation contexts, <a href="#calibre_link-1786" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">79</a></p>
<p class="edition" id="calibre_link-3459">evaluation order, <a href="#calibre_link-1787" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">144</a>&ndash;<a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a></p>
<p class="edition" id="calibre_link-3460">filter arguments, <a href="#calibre_link-1788" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">118</a>&ndash;<a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a>, <a href="#calibre_link-1789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">122</a>, <a href="#calibre_link-1764" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">123</a>, <a href="#calibre_link-1790" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">445</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-3461">filter contexts, <a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a>&ndash;<a href="#calibre_link-1781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">151</a></p>
<p class="edition" id="calibre_link-3462">filtering</p>
<p class="edition" id="calibre_link-3463">multiple columns, <a href="#calibre_link-1792" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">140</a>&ndash;<a href="#calibre_link-1793" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">143</a></p>
<p class="edition" id="calibre_link-3464">a single column, <a href="#calibre_link-1794" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">138</a>&ndash;<a href="#calibre_link-1792" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">140</a></p>
<p class="edition" id="calibre_link-3465">KEEPFILTERS function, <a href="#calibre_link-1698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">135</a>&ndash;<a href="#calibre_link-1794" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">138</a>, <a href="#calibre_link-1795" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">139</a>&ndash;<a href="#calibre_link-1793" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">143</a>, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>, <a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a>&ndash;<a href="#calibre_link-1682" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">169</a></p>
<p class="edition" id="calibre_link-3466">evaluation order, <a href="#calibre_link-1796" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">146</a>&ndash;<a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a></p>
<p class="edition" id="calibre_link-3467">filtering multiple columns, <a href="#calibre_link-1797" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">142</a>&ndash;<a href="#calibre_link-1793" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">143</a></p>
<p class="edition" id="calibre_link-3468">moving averages, <a href="#calibre_link-1743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">201</a>&ndash;<a href="#calibre_link-1744" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">202</a></p>
<p class="edition" id="calibre_link-3469">numbering sequences of events (calculations), <a href="#calibre_link-1798" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">537</a>&ndash;<a href="#calibre_link-1799" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">538</a></p>
<p class="edition" id="calibre_link-3470">overwriting filters, <a href="#calibre_link-1763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">120</a>&ndash;<a href="#calibre_link-1789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">122</a>, <a href="#calibre_link-1800" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">136</a></p>
<p class="edition" id="calibre_link-3471">Precedence calculation group, <a href="#calibre_link-1776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">299</a>&ndash;<a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a></p>
<p class="edition" id="calibre_link-3472">range-based relationships (calculated physical relationships), <a href="#calibre_link-1802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">474</a>&ndash;<a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-3473">RELATED function and, <a href="#calibre_link-1804" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">443</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-3474">row contexts, <a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a>&ndash;<a href="#calibre_link-1781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">151</a></p>
<p class="edition" id="calibre_link-3475">rules for, <a href="#calibre_link-1683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">172</a>&ndash;<a href="#calibre_link-1806" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">173</a></p>
<p class="edition" id="calibre_link-3476">semantics of, <a href="#calibre_link-1789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">122</a>&ndash;<a href="#calibre_link-1764" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">123</a></p>
<p class="edition" id="calibre_link-3477">syntax of, <a href="#calibre_link-1788" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">118</a>, <a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a>&ndash;<a href="#calibre_link-1763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">120</a></p>
<p class="edition" id="calibre_link-3478">table filters, <a href="#calibre_link-1807" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">382</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a>, <a href="#calibre_link-1790" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">445</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-3479">time intelligence calculations, <a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a>&ndash;<a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a></p>
<p class="edition" id="calibre_link-3480">transferring filters, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>&ndash;<a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-3481">UNION function and, <a href="#calibre_link-1815" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">376</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-3482">USERELATIONSHIP function, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>&ndash;<a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a></p>
<p class="edition" id="calibre_link-3483">calculated columns, <a href="#calibre_link-1817" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">25</a>&ndash;<a href="#calibre_link-1818" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">26</a></p>
<p class="edition" id="calibre_link-3484">Boolean calculated columns, data model optimization, <a href="#calibre_link-1760" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">597</a>&ndash;<a href="#calibre_link-1761" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">598</a></p>
<p class="edition" id="calibre_link-3485">context transitions, <a href="#calibre_link-1782" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">154</a>&ndash;<a href="#calibre_link-1783" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">157</a></p>
<p class="edition" id="calibre_link-3486">data model optimization, <a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a>&ndash;<a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a></p>
<p class="edition" id="calibre_link-3487">DISTINCT function, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-3488">expressions, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a></p>
<p class="edition" id="calibre_link-3489">measures, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-3490">choosing between calculated columns and measures, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a>&ndash;<a href="#calibre_link-1821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">30</a></p>
<p class="edition" id="calibre_link-3491">differences between calculated columns and measures, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a></p>
<p class="edition" id="calibre_link-3492">using measures in calculated columns, <a href="#calibre_link-1821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">30</a></p>
<p class="edition" id="calibre_link-3493">processing, <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a></p>
<p class="edition" id="calibre_link-3494">RELATED function, <a href="#calibre_link-1804" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">443</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-3495">SUM function, evaluation contexts, <a href="#calibre_link-1822" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">88</a>&ndash;<a href="#calibre_link-1823" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">89</a></p>
<p class="edition" id="calibre_link-3496">table functions, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-3497">VALUES function, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-3498">calculated physical relationships, <a href="#calibre_link-1825" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">471</a></p>
<p class="edition" id="calibre_link-3499">circular dependencies, <a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a>&ndash;<a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a></p>
<p class="edition" id="calibre_link-3500">multiple-column relationships, <a href="#calibre_link-1825" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">471</a>&ndash;<a href="#calibre_link-1826" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">473</a></p>
<p class="edition" id="calibre_link-3501">range-based relationships, <a href="#calibre_link-1802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">474</a>&ndash;<a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-3502">calculated tables, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-3503">creating, <a href="#calibre_link-1827" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">390</a>&ndash;<a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a></p>
<p class="edition" id="calibre_link-3504">DISTINCT function, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-3505">SELECTCOLUMNS function, <a href="#calibre_link-1827" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">390</a>&ndash;<a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a></p>
<p class="edition" id="calibre_link-3506">VALUES function, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-3507">CALCULATETABLE function, <a href="#calibre_link-1773" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">115</a>, <a href="#calibre_link-1829" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">363</a></p>
<p class="edition" id="calibre_link-3508">active relationships, <a href="#calibre_link-1644" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">451</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-3509">FILTER function versus, <a href="#calibre_link-1829" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">363</a>&ndash;<a href="#calibre_link-1830" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">365</a></p>
<p class="edition" id="calibre_link-3510">time intelligence functions, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">260</a>&ndash;<a href="#calibre_link-1833" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">261</a></p>
<p class="edition" id="calibre_link-3511">calculation granularity and iterators, <a href="#calibre_link-1834" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">211</a>&ndash;<a href="#calibre_link-1835" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">214</a></p>
<p class="edition" id="calibre_link-3512">calculation groups, <a href="#calibre_link-1836" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">279</a>&ndash;<a href="#calibre_link-1837" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">281</a></p>
<p class="edition" id="calibre_link-3513">calculation items and, <a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a></p>
<p class="edition" id="calibre_link-3514">creating, <a href="#calibre_link-1837" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">281</a>&ndash;<a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a></p>
<p class="edition" id="calibre_link-3515">defined, <a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a></p>
<p class="edition" id="calibre_link-3516">Name calculation group, <a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a></p>
<p class="edition" id="calibre_link-3517">Precedence calculation group, <a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a>, <a href="#calibre_link-1776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">299</a>&ndash;<a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a></p>
<p class="edition" id="calibre_link-3518">calculation items</p>
<p class="edition" id="calibre_link-3519">applying to expressions, <a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a></p>
<p class="edition" id="calibre_link-3520">CALCULATE function, <a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a>&ndash;<a href="#calibre_link-1776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">299</a></p>
<p class="edition" id="calibre_link-3521"><span type="pagebreak" id="calibre_link-3522"></span>DATESYTD function, <a href="#calibre_link-1839" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">293</a>&ndash;<a href="#calibre_link-1840" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">296</a></p>
<p class="edition" id="calibre_link-3523">YTD calculations, <a href="#calibre_link-1841" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">294</a></p>
<p class="edition" id="calibre_link-3524">best practices, <a href="#calibre_link-1842" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">311</a></p>
<p class="edition" id="calibre_link-3525">calculation groups and, <a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a></p>
<p class="edition" id="calibre_link-3526">Expression calculation item, <a href="#calibre_link-1843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">289</a></p>
<p class="edition" id="calibre_link-3527">format strings, <a href="#calibre_link-1843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">289</a>&ndash;<a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a></p>
<p class="edition" id="calibre_link-3528">including/excluding measures from calculation items, <a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a>&ndash;<a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a></p>
<p class="edition" id="calibre_link-3529">Name calculation item, <a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a></p>
<p class="edition" id="calibre_link-3530">Ordinal values, <a href="#calibre_link-1843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">289</a></p>
<p class="edition" id="calibre_link-3531">properties of, <a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a>&ndash;<a href="#calibre_link-1843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">289</a></p>
<p class="edition" id="calibre_link-3532">sideways recursion, <a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a>&ndash;<a href="#calibre_link-1842" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">311</a></p>
<p class="edition" id="calibre_link-3533">YOY calculation item, <a href="#calibre_link-1843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">289</a>&ndash;<a href="#calibre_link-1845" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">290</a></p>
<p class="edition" id="calibre_link-3534">YOY% calculation item, <a href="#calibre_link-1843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">289</a>&ndash;<a href="#calibre_link-1845" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">290</a></p>
<p class="edition" id="calibre_link-3535">calculations</p>
<p class="edition" id="calibre_link-3536">budget/sales information (calculations), showing together, <a href="#calibre_link-1771" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">527</a>&ndash;<a href="#calibre_link-1772" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">530</a></p>
<p class="edition" id="calibre_link-3537">nonworking days between two dates, computing, <a href="#calibre_link-1693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">523</a>&ndash;<a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a></p>
<p class="edition" id="calibre_link-3538">precomputing values (calculations), computing work days between two dates, <a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a>&ndash;<a href="#calibre_link-1771" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">527</a></p>
<p class="edition" id="calibre_link-3539">sales</p>
<p class="edition" id="calibre_link-3540">computing previous year sales up to last day sales (calculations), <a href="#calibre_link-1846" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">539</a>&ndash;<a href="#calibre_link-1847" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">544</a></p>
<p class="edition" id="calibre_link-3541">computing same-store sales, <a href="#calibre_link-1772" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">530</a>&ndash;<a href="#calibre_link-1848" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">536</a></p>
<p class="edition" id="calibre_link-3542">showing budget/sales information together, <a href="#calibre_link-1771" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">527</a>&ndash;<a href="#calibre_link-1772" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">530</a></p>
<p class="edition" id="calibre_link-3543">syntax of, <a href="#calibre_link-1849" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">17</a>&ndash;<a href="#calibre_link-1850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">18</a></p>
<p class="edition" id="calibre_link-3544">work days between two dates, computing, <a href="#calibre_link-1851" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">519</a>&ndash;<a href="#calibre_link-1693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">523</a></p>
<p class="edition" id="calibre_link-3545">nonworking days, <a href="#calibre_link-1693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">523</a>&ndash;<a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a></p>
<p class="edition" id="calibre_link-3546">precomputing values (calculations), <a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a>&ndash;<a href="#calibre_link-1771" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">527</a></p>
<p class="edition" id="calibre_link-3547">CALENDAR function, building date tables, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a></p>
<p class="edition" id="calibre_link-3548">CALENDARAUTO function, building date tables, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-3549">calendars (custom), time intelligence calculations, <a href="#calibre_link-1853" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">272</a></p>
<p class="edition" id="calibre_link-3550">DATESYTD function, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3551">weeks, <a href="#calibre_link-1853" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">272</a>&ndash;<a href="#calibre_link-1856" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">275</a></p>
<p class="edition" id="calibre_link-3552">CallbackDataID function</p>
<p class="edition" id="calibre_link-3553">Analysis Services 2012/2014 and, <a href="#calibre_link-1712" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">644</a></p>
<p class="edition" id="calibre_link-3554">DAX optimization, <a href="#calibre_link-1857" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">690</a>&ndash;<a href="#calibre_link-1858" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">693</a></p>
<p class="edition" id="calibre_link-3555">parallelism and, <a href="#calibre_link-1859" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">641</a></p>
<p class="edition" id="calibre_link-3556">VertiPaq and, <a href="#calibre_link-1860" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">640</a>&ndash;<a href="#calibre_link-1712" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">644</a></p>
<p class="edition" id="calibre_link-3557">capturing DAX queries, <a href="#calibre_link-1861" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">609</a>&ndash;<a href="#calibre_link-1862" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">611</a></p>
<p class="edition" id="calibre_link-3558">cardinality</p>
<p class="edition" id="calibre_link-3559">columns (tables)</p>
<p class="edition" id="calibre_link-3560">data model optimization, <a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a>&ndash;<a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a></p>
<p class="edition" id="calibre_link-3561">optimizing high-cardinality columns, <a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-3562">iterators, <a href="#calibre_link-1747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">188</a>&ndash;<a href="#calibre_link-1866" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">190</a></p>
<p class="edition" id="calibre_link-3563">relationships (data models), <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>&ndash;<a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1868" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">586</a>&ndash;<a href="#calibre_link-1663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">587</a>, <a href="#calibre_link-1869" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">590</a>&ndash;<a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a></p>
<p class="edition" id="calibre_link-3564">Cardinality column (VertiPaq Analyzer), <a href="#calibre_link-1870" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">581</a>, <a href="#calibre_link-1871" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">583</a></p>
<p class="edition" id="calibre_link-3565">categories/subcategories example, ALL function and, <a href="#calibre_link-1695" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">66</a>&ndash;<a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a></p>
<p class="edition" id="calibre_link-3566">cells (Excel), <a href="#calibre_link-1872" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">5</a></p>
<p class="edition" id="calibre_link-3567">chains (relationships), <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-3568">circular dependencies</p>
<p class="edition" id="calibre_link-3569">CALCULATE function and, <a href="#calibre_link-1777" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">161</a>&ndash;<a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a></p>
<p class="edition" id="calibre_link-3570">calculated physical relationships, <a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a>&ndash;<a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a></p>
<p class="edition" id="calibre_link-3571">code documentation, variables, <a href="#calibre_link-1873" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">183</a>&ndash;<a href="#calibre_link-1874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">184</a></p>
<p class="edition" id="calibre_link-3572">code maintenance/readability, FILTER function, <a href="#calibre_link-1875" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">62</a>&ndash;<a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a></p>
<p class="edition" id="calibre_link-3573">column filters</p>
<p class="edition" id="calibre_link-3574">arbitrarily shaped filters versus, <a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-3575">defined, <a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-3576">columnar databases, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a>&ndash;<a href="#calibre_link-1877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">553</a></p>
<p class="edition" id="calibre_link-3577">columns (tables), <a href="#calibre_link-1872" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">5</a>&ndash;<a href="#calibre_link-1878" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">7</a></p>
<p class="edition" id="calibre_link-3578">ADDCOLUMNS function, <a href="#calibre_link-1647" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">223</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a>, <a href="#calibre_link-1649" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">366</a>&ndash;<a href="#calibre_link-1650" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">369</a>, <a href="#calibre_link-1651" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">371</a>&ndash;<a href="#calibre_link-1652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">372</a></p>
<p class="edition" id="calibre_link-3579">ADDCOLUMNS iterators, <a href="#calibre_link-1653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">196</a>&ndash;<a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-3580">ALL function and, <a href="#calibre_link-1685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">64</a>&ndash;<a href="#calibre_link-1686" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">65</a></p>
<p class="edition" id="calibre_link-3581">ALLEXCEPT function and, <a href="#calibre_link-1686" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">65</a>&ndash;<a href="#calibre_link-1695" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">66</a></p>
<p class="edition" id="calibre_link-3582">automatic date columns (Power Pivot for Excel), <a href="#calibre_link-1742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">219</a></p>
<p class="edition" id="calibre_link-3583">Boolean calculated columns, data model optimization, <a href="#calibre_link-1760" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">597</a>&ndash;<a href="#calibre_link-1761" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">598</a></p>
<p class="edition" id="calibre_link-3584">calculated columns, <a href="#calibre_link-1817" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">25</a>&ndash;<a href="#calibre_link-1818" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">26</a>, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a>, <a href="#calibre_link-1804" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">443</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-3585">Boolean calculated columns, <a href="#calibre_link-1760" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">597</a>&ndash;<a href="#calibre_link-1761" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">598</a></p>
<p class="edition" id="calibre_link-3586">choosing between calculated columns and measures, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a>&ndash;<a href="#calibre_link-1821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">30</a></p>
<p class="edition" id="calibre_link-3587">context transitions, <a href="#calibre_link-1782" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">154</a>&ndash;<a href="#calibre_link-1783" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">157</a></p>
<p class="edition" id="calibre_link-3588">data model optimization, <a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a>&ndash;<a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a></p>
<p class="edition" id="calibre_link-3589">differences between calculated columns and measures, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a></p>
<p class="edition" id="calibre_link-3590">DISTINCT function, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-3591">expressions, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a></p>
<p class="edition" id="calibre_link-3592">processing, <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a></p>
<p class="edition" id="calibre_link-3593">SUM function, <a href="#calibre_link-1822" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">88</a>&ndash;<a href="#calibre_link-1823" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">89</a></p>
<p class="edition" id="calibre_link-3594">table functions, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-3595">using measures in calculated columns, <a href="#calibre_link-1821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">30</a></p>
<p class="edition" id="calibre_link-3596">VALUES function, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-3597">cardinality</p>
<p class="edition" id="calibre_link-3598">data model optimization, <a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a>&ndash;<a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a></p>
<p class="edition" id="calibre_link-3599">optimizing high-cardinality columns, <a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-3600">Date column, data model optimization, <a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a>&ndash;<a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a></p>
<p class="edition" id="calibre_link-3601">defined, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-3602">descriptive attributes column (tables), <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a>, <a href="#calibre_link-1879" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">601</a>&ndash;<a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-3603">filtering</p>
<p class="edition" id="calibre_link-3604"><span type="pagebreak" id="calibre_link-3605"></span>CALCULATE function, <a href="#calibre_link-1794" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">138</a>&ndash;<a href="#calibre_link-1792" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">140</a></p>
<p class="edition" id="calibre_link-3606">multiple columns, <a href="#calibre_link-1792" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">140</a>&ndash;<a href="#calibre_link-1793" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">143</a></p>
<p class="edition" id="calibre_link-3607">a single column, <a href="#calibre_link-1794" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">138</a>&ndash;<a href="#calibre_link-1792" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">140</a></p>
<p class="edition" id="calibre_link-3608">table filters versus, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-3609">measures, evaluation contexts, <a href="#calibre_link-1823" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">89</a>&ndash;<a href="#calibre_link-1881" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">90</a></p>
<p class="edition" id="calibre_link-3610">multiple columns</p>
<p class="edition" id="calibre_link-3611">DISTINCT function and, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-3612">VALUES function and, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-3613">primary/alternate keys column (tables), <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a>, <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a></p>
<p class="edition" id="calibre_link-3614">qualitative attributes column (tables), <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a>, <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a></p>
<p class="edition" id="calibre_link-3615">quantitative attributes column (tables), <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a>, <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a>&ndash;<a href="#calibre_link-1879" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">601</a></p>
<p class="edition" id="calibre_link-3616">referencing, <a href="#calibre_link-1849" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">17</a>&ndash;<a href="#calibre_link-1850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">18</a></p>
<p class="edition" id="calibre_link-3617">relationships, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-3618">row contexts, <a href="#calibre_link-1882" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">87</a></p>
<p class="edition" id="calibre_link-3619">SELECTCOLUMNS function, <a href="#calibre_link-1827" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">390</a>&ndash;<a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a>, <a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a>&ndash;<a href="#calibre_link-1884" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">394</a></p>
<p class="edition" id="calibre_link-3620">SELECTCOLUMNS iterators, <a href="#calibre_link-1653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">196</a>, <a href="#calibre_link-1885" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">197</a>&ndash;<a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-3621">split optimization, <a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a>&ndash;<a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-3622">storage optimization, <a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-3623">column split optimization, <a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a>&ndash;<a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-3624">high-cardinality columns, <a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-3625">storing, <a href="#calibre_link-1879" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">601</a>&ndash;<a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-3626">SUBSTITUTEWITHINDEX function, <a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a>&ndash;<a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a></p>
<p class="edition" id="calibre_link-3627">SUMMARIZE function and, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-3628">SUMMARIZECOLUMNS function, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>, <a href="#calibre_link-1740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">429</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-3629">technical attributes column (tables), <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a>, <a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-3630">Time column, data model optimization, <a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a>&ndash;<a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a></p>
<p class="edition" id="calibre_link-3631">VertiPaq Analyzer, <a href="#calibre_link-1886" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">580</a>&ndash;<a href="#calibre_link-1871" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">583</a></p>
<p class="edition" id="calibre_link-3632">Columns # column (VertiPaq Analyzer), <a href="#calibre_link-1887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">582</a></p>
<p class="edition" id="calibre_link-3633">Columns Hierarchies Size column (VertiPaq Analyzer), <a href="#calibre_link-1887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">582</a></p>
<p class="edition" id="calibre_link-3634">Columns Total Size column (VertiPaq Analyzer), <a href="#calibre_link-1870" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">581</a></p>
<p class="edition" id="calibre_link-3635">COMBINEVALUES function, multiple-column relationships (calculated physical relationships), <a href="#calibre_link-1888" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">472</a>&ndash;<a href="#calibre_link-1826" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">473</a></p>
<p class="edition" id="calibre_link-3636">comments</p>
<p class="edition" id="calibre_link-3637">at the end of expressions, <a href="#calibre_link-1850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">18</a></p>
<p class="edition" id="calibre_link-3638">expressions, comment placement in expressions, <a href="#calibre_link-1850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">18</a></p>
<p class="edition" id="calibre_link-3639">multi-line comments, <a href="#calibre_link-1850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">18</a></p>
<p class="edition" id="calibre_link-3640">single-line comments, <a href="#calibre_link-1850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">18</a></p>
<p class="edition" id="calibre_link-3641">comparison operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-3642">composite data models, <a href="#calibre_link-1889" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">646</a>&ndash;<a href="#calibre_link-1665" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">647</a></p>
<p class="edition" id="calibre_link-3643">DirectQuery mode, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-3644">VertiPaq mode, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-3645">compression (VertiPaq), <a href="#calibre_link-1877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">553</a>&ndash;<a href="#calibre_link-1891" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">554</a></p>
<p class="edition" id="calibre_link-3646">hash encoding, <a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a>&ndash;<a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a></p>
<p class="edition" id="calibre_link-3647">re-encoding, <a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-3648">RLE, <a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a>&ndash;<a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-3649">value encoding, <a href="#calibre_link-1891" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">554</a>&ndash;<a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a></p>
<p class="edition" id="calibre_link-3650">CONCATENATEX function</p>
<p class="edition" id="calibre_link-3651">iterators and, <a href="#calibre_link-1895" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">194</a>&ndash;<a href="#calibre_link-1653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">196</a></p>
<p class="edition" id="calibre_link-3652">tables as scalar values, <a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a></p>
<p class="edition" id="calibre_link-3653">conditional statements, <a href="#calibre_link-1896" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">24</a>&ndash;<a href="#calibre_link-1817" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">25</a>, <a href="#calibre_link-1897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">708</a>&ndash;<a href="#calibre_link-1898" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">709</a></p>
<p class="edition" id="calibre_link-3654">conditions</p>
<p class="edition" id="calibre_link-3655">DAX, <a href="#calibre_link-1899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">11</a></p>
<p class="edition" id="calibre_link-3656">SQL, <a href="#calibre_link-1899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">11</a></p>
<p class="edition" id="calibre_link-3657">CONTAINS function</p>
<p class="edition" id="calibre_link-3658">tables and, <a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a>&ndash;<a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a></p>
<p class="edition" id="calibre_link-3659">transferring filters, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-3660">CONTAINSROW function and tables, <a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a>&ndash;<a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a></p>
<p class="edition" id="calibre_link-3661">context transitions, <a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a></p>
<p class="edition" id="calibre_link-3662">ALL function and, <a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a>&ndash;<a href="#calibre_link-1687" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">330</a></p>
<p class="edition" id="calibre_link-3663">CALCULATE function and, <a href="#calibre_link-1781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">151</a>&ndash;<a href="#calibre_link-1782" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">154</a></p>
<p class="edition" id="calibre_link-3664">calculated columns, <a href="#calibre_link-1782" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">154</a>&ndash;<a href="#calibre_link-1783" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">157</a></p>
<p class="edition" id="calibre_link-3665">DAX optimization, <a href="#calibre_link-1903" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">672</a>&ndash;<a href="#calibre_link-1904" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">678</a></p>
<p class="edition" id="calibre_link-3666">expanded tables, <a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a>&ndash;<a href="#calibre_link-1702" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">455</a></p>
<p class="edition" id="calibre_link-3667">iterators, leveraging context transitions, <a href="#calibre_link-1866" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">190</a>&ndash;<a href="#calibre_link-1895" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">194</a></p>
<p class="edition" id="calibre_link-3668">measures, <a href="#calibre_link-1783" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">157</a>&ndash;<a href="#calibre_link-1784" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">160</a></p>
<p class="edition" id="calibre_link-3669">time intelligence functions, <a href="#calibre_link-1832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">260</a></p>
<p class="edition" id="calibre_link-3670">conversion functions, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-3671">CURRENCY function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-3672">DATE function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a>, <a href="#calibre_link-1907" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">52</a></p>
<p class="edition" id="calibre_link-3673">DATEVALUE function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-3674">FORMAT function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-3675">INT function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-3676">TIME function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a>, <a href="#calibre_link-1907" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">52</a></p>
<p class="edition" id="calibre_link-3677">VALUE function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-3678">conversions, error-handling, <a href="#calibre_link-1908" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">31</a>&ndash;<a href="#calibre_link-1720" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">32</a></p>
<p class="edition" id="calibre_link-3679">cores (number of), VertiPaq hardware selection, <a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a>, <a href="#calibre_link-1910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">576</a></p>
<p class="edition" id="calibre_link-3680">COUNT function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3681">COUNTA function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3682">COUNTBLANK function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3683">COUNTROWS function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3684">filter contexts and relationships, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-3685">nested row contexts on the same table, <a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a>&ndash;<a href="#calibre_link-1912" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">95</a></p>
<p class="edition" id="calibre_link-3686">tables as scalar values, <a href="#calibre_link-1913" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">73</a></p>
<p class="edition" id="calibre_link-3687">CPU model, VertiPaq hardware selection, <a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a>&ndash;<a href="#calibre_link-1914" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">575</a></p>
<p class="edition" id="calibre_link-3688">cross-filter directions (physical relationships), <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a></p>
<p class="edition" id="calibre_link-3689">bidirectional cross-filter direction, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1751" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">491</a>&ndash;<a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-3690">single cross-filter direction, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a></p>
<p class="edition" id="calibre_link-3691">cross-filtering, data model optimization, <a href="#calibre_link-1869" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">590</a></p>
<p class="edition" id="calibre_link-3692">cross-island relationships, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a></p>
<p class="edition" id="calibre_link-3693">CROSSFILTER function</p>
<p class="edition" id="calibre_link-3694">bidirectional relationships, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-3695">CALCULATE function and, <a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a></p>
<p class="edition" id="calibre_link-3696"><span type="pagebreak" id="calibre_link-3697"></span>CROSSJOIN function and tables, <a href="#calibre_link-1652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">372</a>&ndash;<a href="#calibre_link-1915" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">374</a>, <a href="#calibre_link-1916" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">383</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a></p>
<p class="edition" id="calibre_link-3698">Currency data type, <a href="#calibre_link-1917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">21</a></p>
<p class="edition" id="calibre_link-3699">CURRENCY function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-3700">custom calendars, time intelligence calculations, <a href="#calibre_link-1853" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">272</a></p>
<p class="edition" id="calibre_link-3701">DATESYTD function, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3702">weeks, <a href="#calibre_link-1853" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">272</a>&ndash;<a href="#calibre_link-1856" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">275</a></p>
<p class="edition" id="calibre_link-3703">customers (new), computing (tables), <a href="#calibre_link-1918" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">380</a>&ndash;<a href="#calibre_link-1919" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">381</a>, <a href="#calibre_link-1920" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">386</a>&ndash;<a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-3704" class="h2a">D</h3>
<p class="edition" id="calibre_link-3705">Daily AVG</p>
<p class="edition" id="calibre_link-3706">calculation group precedence, <a href="#calibre_link-1776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">299</a>&ndash;<a href="#calibre_link-1921" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">303</a></p>
<p class="edition" id="calibre_link-3707">calculation items, including/excluding measures, <a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a>&ndash;<a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a></p>
<p class="edition" id="calibre_link-3708">data lineage, <a href="#calibre_link-1922" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">332</a>&ndash;<a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a>&ndash;<a href="#calibre_link-1923" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">468</a></p>
<p class="edition" id="calibre_link-1987">data models</p>
<p class="edition" id="calibre_link-3709">aggregations, <a href="#calibre_link-1665" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">647</a>&ndash;<a href="#calibre_link-1666" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">648</a></p>
<p class="edition" id="calibre_link-3710">composite data models, <a href="#calibre_link-1889" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">646</a>&ndash;<a href="#calibre_link-1665" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">647</a></p>
<p class="edition" id="calibre_link-3711">DirectQuery mode, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-3712">VertiPaq mode, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-3713">defined, <a href="#calibre_link-1924" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">1</a>&ndash;<a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-1988">optimizing with VertiPaq, <a href="#calibre_link-1925" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">579</a></p>
<p class="edition" id="calibre_link-3714">aggregations, <a href="#calibre_link-1663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">587</a>&ndash;<a href="#calibre_link-1664" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">588</a>, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a>&ndash;<a href="#calibre_link-1669" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">607</a></p>
<p class="edition" id="calibre_link-3715">calculated columns, <a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a>&ndash;<a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a></p>
<p class="edition" id="calibre_link-3716">choosing columns for storage, <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a>&ndash;<a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-3717">column cardinality, <a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a>&ndash;<a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a></p>
<p class="edition" id="calibre_link-3718">cross-filtering, <a href="#calibre_link-1869" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">590</a></p>
<p class="edition" id="calibre_link-3719">Date column, <a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a>&ndash;<a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a></p>
<p class="edition" id="calibre_link-3720">denormalizing data, <a href="#calibre_link-1926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">584</a>&ndash;<a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a></p>
<p class="edition" id="calibre_link-3721">disabling attribute hierarchies, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a></p>
<p class="edition" id="calibre_link-3722">gathering data model information, <a href="#calibre_link-1925" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">579</a>&ndash;<a href="#calibre_link-1926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">584</a></p>
<p class="edition" id="calibre_link-3723">optimizing column storage, <a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a>&ndash;<a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-3724">optimizing drill-through attributes, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a></p>
<p class="edition" id="calibre_link-3725">relationship cardinality, <a href="#calibre_link-1868" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">586</a>&ndash;<a href="#calibre_link-1663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">587</a>, <a href="#calibre_link-1869" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">590</a>&ndash;<a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a></p>
<p class="edition" id="calibre_link-3726">Time column, <a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a>&ndash;<a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a></p>
<p class="edition" id="calibre_link-3727">relationships, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-3728">1:1 relationships, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-3729">active relationships, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-3730">bidirectional filtering, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a>&ndash;<a href="#calibre_link-1754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">4</a></p>
<p class="edition" id="calibre_link-3731">cardinality, <a href="#calibre_link-1868" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">586</a>&ndash;<a href="#calibre_link-1663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">587</a>, <a href="#calibre_link-1869" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">590</a>&ndash;<a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a></p>
<p class="edition" id="calibre_link-3732">chains, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-3733">columns, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-3734">cross filter direction, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-3735">DAX and SQL, <a href="#calibre_link-1927" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">9</a></p>
<p class="edition" id="calibre_link-3736">directions of, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a>&ndash;<a href="#calibre_link-1754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">4</a></p>
<p class="edition" id="calibre_link-3737">many-sided relationships, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a>, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-3738">one-sided relationships, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a>, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-3739">Relationship reports (VertiPaq Analyzer), <a href="#calibre_link-1926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">584</a></p>
<p class="edition" id="calibre_link-3740">unidirectional filtering, <a href="#calibre_link-1754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">4</a></p>
<p class="edition" id="calibre_link-3741">weak relationships, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-3742">single data models</p>
<p class="edition" id="calibre_link-3743">DirectQuery mode, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-3744">VertiPaq mode, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-3745">tables, defined, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-3746">weak relationships, <a href="#calibre_link-1928" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">439</a></p>
<p class="edition" id="calibre_link-3747">data refreshes, SSAS (SQL Server Analysis Services), <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a>&ndash;<a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a></p>
<p class="edition" id="calibre_link-3748">Data Size column (VertiPaq Analyzer), <a href="#calibre_link-1870" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">581</a></p>
<p class="edition" id="calibre_link-3749">data types, <a href="#calibre_link-1930" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">19</a></p>
<p class="edition" id="calibre_link-3750">Binary data type, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-3751">Boolean data type, <a href="#calibre_link-1766" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">22</a></p>
<p class="edition" id="calibre_link-3752">Currency data type, <a href="#calibre_link-1917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">21</a></p>
<p class="edition" id="calibre_link-3753">DateTime data type, <a href="#calibre_link-1917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">21</a>&ndash;<a href="#calibre_link-1766" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">22</a></p>
<p class="edition" id="calibre_link-3754">Decimal data type, <a href="#calibre_link-1917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">21</a></p>
<p class="edition" id="calibre_link-3755">Integer data type, <a href="#calibre_link-1917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">21</a></p>
<p class="edition" id="calibre_link-3756">operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-3757">arithmetic operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-3758">comparison operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-3759">logical operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-3760">overloading, <a href="#calibre_link-1930" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">19</a>&ndash;<a href="#calibre_link-1931" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">20</a></p>
<p class="edition" id="calibre_link-3761">parenthesis operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-3762">text concatenation operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-3763">string/number conversions, <a href="#calibre_link-1930" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">19</a>&ndash;<a href="#calibre_link-1917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">21</a></p>
<p class="edition" id="calibre_link-3764">strings, <a href="#calibre_link-1766" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">22</a></p>
<p class="edition" id="calibre_link-3765">Variant data type, <a href="#calibre_link-1766" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">22</a></p>
<p class="edition" id="calibre_link-3766">Database Size % column (VertiPaq Analyzer), <a href="#calibre_link-1887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">582</a></p>
<p class="edition" id="calibre_link-3767">databases (columnar), <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a>&ndash;<a href="#calibre_link-1877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">553</a></p>
<p class="edition" id="calibre_link-3768">datacaches</p>
<p class="edition" id="calibre_link-3769">FE, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-3770">SE, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-3771">VertiPaq, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a>, <a href="#calibre_link-1933" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">635</a>&ndash;<a href="#calibre_link-1934" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">637</a></p>
<p class="edition" id="calibre_link-3772">DATATABLE function, creating static tables, <a href="#calibre_link-1935" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">392</a>&ndash;<a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a></p>
<p class="edition" id="calibre_link-3773">Date column, data model optimization, <a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a>&ndash;<a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a></p>
<p class="edition" id="calibre_link-3774">DATE function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a>, <a href="#calibre_link-1907" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">52</a></p>
<p class="edition" id="calibre_link-3775">date table templates (Power Pivot for Excel), <a href="#calibre_link-1936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">220</a></p>
<p class="edition" id="calibre_link-3776">date tables</p>
<p class="edition" id="calibre_link-3777">building, <a href="#calibre_link-1936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">220</a>&ndash;<a href="#calibre_link-1937" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">221</a></p>
<p class="edition" id="calibre_link-3778">ADDCOLUMNS function, <a href="#calibre_link-1647" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">223</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-3779">CALENDAR function, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a></p>
<p class="edition" id="calibre_link-3780">CALENDARAUTO function, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-3781">date templates, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-3782">duplicating, <a href="#calibre_link-1938" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">227</a></p>
<p class="edition" id="calibre_link-3783">loading from other data sources, <a href="#calibre_link-1937" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">221</a></p>
<p class="edition" id="calibre_link-3784"><span type="pagebreak" id="calibre_link-3785"></span>Mark as Date Table, <a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a>&ndash;<a href="#calibre_link-1939" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">233</a></p>
<p class="edition" id="calibre_link-3786">multiple dates, managing, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-3787">multiple date tables, <a href="#calibre_link-1940" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">226</a>&ndash;<a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a></p>
<p class="edition" id="calibre_link-3788">multiple relationships to date tables, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a>&ndash;<a href="#calibre_link-1940" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">226</a></p>
<p class="edition" id="calibre_link-3789">naming, <a href="#calibre_link-1937" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">221</a></p>
<p class="edition" id="calibre_link-3790">date templates, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-3791">date/time-related calculations, <a href="#calibre_link-1941" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">217</a></p>
<p class="edition" id="calibre_link-3792">Auto Date/Time (Power BI), <a href="#calibre_link-1741" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">218</a>&ndash;<a href="#calibre_link-1742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">219</a></p>
<p class="edition" id="calibre_link-3793">automatic date columns (Power Pivot for Excel), <a href="#calibre_link-1742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">219</a></p>
<p class="edition" id="calibre_link-3794">basic calculations, <a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a>&ndash;<a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a></p>
<p class="edition" id="calibre_link-3795">basic functions, <a href="#calibre_link-1939" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">233</a>&ndash;<a href="#calibre_link-1942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">235</a></p>
<p class="edition" id="calibre_link-3796">CALCULATE function, <a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a>&ndash;<a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a></p>
<p class="edition" id="calibre_link-3797">CALCULATETABLE function, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">260</a>&ndash;<a href="#calibre_link-1833" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">261</a></p>
<p class="edition" id="calibre_link-3798">context transitions, <a href="#calibre_link-1832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">260</a></p>
<p class="edition" id="calibre_link-3799">custom calendars, <a href="#calibre_link-1853" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">272</a></p>
<p class="edition" id="calibre_link-3800">DATESYTD function, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3801">weeks, <a href="#calibre_link-1853" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">272</a>&ndash;<a href="#calibre_link-1856" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">275</a></p>
<p class="edition" id="calibre_link-3802">date tables</p>
<p class="edition" id="calibre_link-3803">ADDCOLUMNS function, <a href="#calibre_link-1647" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">223</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-3804">building, <a href="#calibre_link-1936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">220</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-3805">CALENDAR function, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a></p>
<p class="edition" id="calibre_link-3806">CALENDARAUTO function, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-3807">date table templates (Power Pivot for Excel), <a href="#calibre_link-1936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">220</a></p>
<p class="edition" id="calibre_link-3808">date templates, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-3809">duplicating, <a href="#calibre_link-1938" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">227</a></p>
<p class="edition" id="calibre_link-3810">loading from other data sources, <a href="#calibre_link-1937" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">221</a></p>
<p class="edition" id="calibre_link-3811">managing multiple dates, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a>&ndash;<a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a></p>
<p class="edition" id="calibre_link-3812">Mark as Date Table, <a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a>&ndash;<a href="#calibre_link-1939" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">233</a></p>
<p class="edition" id="calibre_link-3813">multiple date tables, <a href="#calibre_link-1940" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">226</a>&ndash;<a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a></p>
<p class="edition" id="calibre_link-3814">multiple relationships to date tables, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a>&ndash;<a href="#calibre_link-1940" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">226</a></p>
<p class="edition" id="calibre_link-3815">naming, <a href="#calibre_link-1937" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">221</a></p>
<p class="edition" id="calibre_link-3816">DATEADD function, <a href="#calibre_link-1943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">237</a>&ndash;<a href="#calibre_link-1944" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">238</a>, <a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>&ndash;<a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a></p>
<p class="edition" id="calibre_link-3817">DATESINPERIOD function, <a href="#calibre_link-1713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">243</a>&ndash;<a href="#calibre_link-1714" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">244</a></p>
<p class="edition" id="calibre_link-3818">DATESMTD function, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3819">DATESQTD function, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3820">DATESYTD function, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">260</a>, <a href="#calibre_link-1833" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">261</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3821">differences over previous periods, computing, <a href="#calibre_link-1947" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">241</a>&ndash;<a href="#calibre_link-1713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">243</a></p>
<p class="edition" id="calibre_link-3822">drillthrough operations, <a href="#calibre_link-1948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">271</a></p>
<p class="edition" id="calibre_link-3823">FILTER function, <a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a>&ndash;<a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a></p>
<p class="edition" id="calibre_link-3824">FIRSTDATE function, <a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a></p>
<p class="edition" id="calibre_link-3825">FIRSTNONBLANK function, <a href="#calibre_link-1950" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">256</a>&ndash;<a href="#calibre_link-1951" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">257</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a>&ndash;<a href="#calibre_link-1948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">271</a></p>
<p class="edition" id="calibre_link-3826">LASTDATE function, <a href="#calibre_link-1952" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">248</a>&ndash;<a href="#calibre_link-1953" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">249</a>, <a href="#calibre_link-1954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">254</a>, <a href="#calibre_link-1955" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">255</a>, <a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a>&ndash;<a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a></p>
<p class="edition" id="calibre_link-3827">LASTNONBLANK function, <a href="#calibre_link-1956" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">250</a>&ndash;<a href="#calibre_link-1954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">254</a>, <a href="#calibre_link-1955" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">255</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a>&ndash;<a href="#calibre_link-1948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">271</a></p>
<p class="edition" id="calibre_link-3828">mixing functions, <a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a>&ndash;<a href="#calibre_link-1947" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">241</a></p>
<p class="edition" id="calibre_link-3829">moving annual totals, computing, <a href="#calibre_link-1713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">243</a>&ndash;<a href="#calibre_link-1714" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">244</a></p>
<p class="edition" id="calibre_link-3830">MTD calculations, <a href="#calibre_link-1942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">235</a>&ndash;<a href="#calibre_link-1958" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">236</a>, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3831">nested functions, call order of, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-3832">NEXTDAY function, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-3833">nonworking days between two dates, computing, <a href="#calibre_link-1693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">523</a>&ndash;<a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a></p>
<p class="edition" id="calibre_link-3834">opening/closing balances, <a href="#calibre_link-1954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">254</a>&ndash;<a href="#calibre_link-1961" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">258</a></p>
<p class="edition" id="calibre_link-3835">PARALLELPERIOD function, <a href="#calibre_link-1944" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">238</a>&ndash;<a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a></p>
<p class="edition" id="calibre_link-3836">periods to date, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a></p>
<p class="edition" id="calibre_link-3837">PREVIOUSMONTH function, <a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a></p>
<p class="edition" id="calibre_link-3838">QTD calculations, <a href="#calibre_link-1942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">235</a>&ndash;<a href="#calibre_link-1958" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">236</a>, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3839">SAMEPERIODLASTYEAR function, <a href="#calibre_link-1943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">237</a>, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-3840">semi-additive calculations, <a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a>&ndash;<a href="#calibre_link-1952" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">248</a></p>
<p class="edition" id="calibre_link-3841">STARTOFQUARTER function, <a href="#calibre_link-1950" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">256</a>&ndash;<a href="#calibre_link-1951" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">257</a></p>
<p class="edition" id="calibre_link-3842">time periods, computing from prior periods, <a href="#calibre_link-1943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">237</a>&ndash;<a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a></p>
<p class="edition" id="calibre_link-3843">work days between two dates, computing, <a href="#calibre_link-1851" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">519</a>&ndash;<a href="#calibre_link-1693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">523</a></p>
<p class="edition" id="calibre_link-3844">nonworking days, <a href="#calibre_link-1693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">523</a>&ndash;<a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a></p>
<p class="edition" id="calibre_link-3845">precomputing values (calculations), <a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a>&ndash;<a href="#calibre_link-1771" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">527</a></p>
<p class="edition" id="calibre_link-3846">YTD calculations, <a href="#calibre_link-1942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">235</a>&ndash;<a href="#calibre_link-1958" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">236</a>, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3847">DATEADD function, time intelligence calculations, <a href="#calibre_link-1943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">237</a>&ndash;<a href="#calibre_link-1944" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">238</a>, <a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>&ndash;<a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a></p>
<p class="edition" id="calibre_link-3848">DATESINPERIOD function, computing moving annual totals, <a href="#calibre_link-1713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">243</a>&ndash;<a href="#calibre_link-1714" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">244</a></p>
<p class="edition" id="calibre_link-3849">DATESMTD function, time intelligence calculations, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3850">DATESQTD function, time intelligence calculations, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3851">DATESYTD function</p>
<p class="edition" id="calibre_link-3852">calculation items, applying to expressions, <a href="#calibre_link-1839" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">293</a>&ndash;<a href="#calibre_link-1840" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">296</a></p>
<p class="edition" id="calibre_link-3853">time intelligence calculations, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">260</a>, <a href="#calibre_link-1833" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">261</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-3854">DateTime data type, <a href="#calibre_link-1917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">21</a>&ndash;<a href="#calibre_link-1766" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">22</a></p>
<p class="edition" id="calibre_link-3855">DATEVALUE function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-3856">DAX (Data Analysis eXpressions), <a href="#calibre_link-1924" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">1</a></p>
<p class="edition" id="calibre_link-3857">conditions, <a href="#calibre_link-1899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">11</a></p>
<p class="edition" id="calibre_link-3858">data models</p>
<p class="edition" id="calibre_link-3859">defined, <a href="#calibre_link-1924" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">1</a>&ndash;<a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-3860">relationships, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a>&ndash;<a href="#calibre_link-1754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">4</a></p>
<p class="edition" id="calibre_link-3861">tables, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-3862">date templates, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-3863">DAX and, cells and tables, <a href="#calibre_link-1872" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">5</a>&ndash;<a href="#calibre_link-1878" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">7</a></p>
<p class="edition" id="calibre_link-3864">Excel and</p>
<p class="edition" id="calibre_link-3865">functional languages, <a href="#calibre_link-1878" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">7</a></p>
<p class="edition" id="calibre_link-3866">theories, <a href="#calibre_link-1962" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">8</a>&ndash;<a href="#calibre_link-1927" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">9</a></p>
<p class="edition" id="calibre_link-3867">expressions</p>
<p class="edition" id="calibre_link-3868"><span type="pagebreak" id="calibre_link-3869"></span>identifying a single DAX expression for optimization, <a href="#calibre_link-1963" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">658</a>&ndash;<a href="#calibre_link-1964" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">661</a></p>
<p class="edition" id="calibre_link-3870">optimizing bottlenecks, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-3871">as functional language, <a href="#calibre_link-1965" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">10</a></p>
<p class="edition" id="calibre_link-3872">functions, <a href="#calibre_link-1966" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">6</a>&ndash;<a href="#calibre_link-1878" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">7</a></p>
<p class="edition" id="calibre_link-3873">iterators, <a href="#calibre_link-1962" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">8</a></p>
<p class="edition" id="calibre_link-3874">MDX, <a href="#calibre_link-1967" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">12</a></p>
<p class="edition" id="calibre_link-3875">hierarchies, <a href="#calibre_link-1968" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">13</a>&ndash;<a href="#calibre_link-1969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">14</a></p>
<p class="edition" id="calibre_link-3876">leaf-level calculations, <a href="#calibre_link-1969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">14</a></p>
<p class="edition" id="calibre_link-3877">multidimensional versus tabular space, <a href="#calibre_link-1967" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">12</a></p>
<p class="edition" id="calibre_link-3878">as programming language, <a href="#calibre_link-1967" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">12</a>&ndash;<a href="#calibre_link-1968" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">13</a></p>
<p class="edition" id="calibre_link-3879">as querying language, <a href="#calibre_link-1967" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">12</a>&ndash;<a href="#calibre_link-1968" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">13</a></p>
<p class="edition" id="calibre_link-3880">queries, <a href="#calibre_link-1970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">613</a></p>
<p class="edition" id="calibre_link-3881">optimizing, <a href="#calibre_link-1971" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">657</a></p>
<p class="edition" id="calibre_link-3882">bottlenecks, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-3883">CallbackDataID function, <a href="#calibre_link-1857" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">690</a>&ndash;<a href="#calibre_link-1858" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">693</a></p>
<p class="edition" id="calibre_link-3884">change implementation, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-3885">conditional statements, <a href="#calibre_link-1897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">708</a>&ndash;<a href="#calibre_link-1898" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">709</a></p>
<p class="edition" id="calibre_link-3886">context transitions, <a href="#calibre_link-1903" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">672</a>&ndash;<a href="#calibre_link-1904" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">678</a></p>
<p class="edition" id="calibre_link-3887">creating reproduction queries, <a href="#calibre_link-1964" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">661</a>&ndash;<a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a></p>
<p class="edition" id="calibre_link-3888">DISTINCTCOUNT function, <a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a>&ndash;<a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a></p>
<p class="edition" id="calibre_link-3889">to-do list, <a href="#calibre_link-1963" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">658</a></p>
<p class="edition" id="calibre_link-3890">filter conditions, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a>&ndash;<a href="#calibre_link-1903" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">672</a></p>
<p class="edition" id="calibre_link-3891">identifying a single DAX expression for optimization, <a href="#calibre_link-1963" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">658</a>&ndash;<a href="#calibre_link-1964" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">661</a></p>
<p class="edition" id="calibre_link-3892">identifying SE/FE bottlenecks, <a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a>&ndash;<a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-3893">IF conditions, <a href="#calibre_link-1904" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">678</a>&ndash;<a href="#calibre_link-1857" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">690</a></p>
<p class="edition" id="calibre_link-3894">multiple evaluations, avoiding with variables, <a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a>&ndash;<a href="#calibre_link-1897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">708</a></p>
<p class="edition" id="calibre_link-3895">nested iterators, <a href="#calibre_link-1858" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">693</a>&ndash;<a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a></p>
<p class="edition" id="calibre_link-3896">query plans, <a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a>&ndash;<a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a></p>
<p class="edition" id="calibre_link-3897">rerunning test queries, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-3898">server timings, <a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a>&ndash;<a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a></p>
<p class="edition" id="calibre_link-3899">variables, <a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a>&ndash;<a href="#calibre_link-1897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">708</a></p>
<p class="edition" id="calibre_link-3900">Power BI and, <a href="#calibre_link-1969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">14</a>&ndash;<a href="#calibre_link-1975" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">15</a></p>
<p class="edition" id="calibre_link-3901">as programming language, <a href="#calibre_link-1965" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">10</a>&ndash;<a href="#calibre_link-1899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">11</a></p>
<p class="edition" id="calibre_link-3902">queries</p>
<p class="edition" id="calibre_link-3903">capturing, <a href="#calibre_link-1861" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">609</a>&ndash;<a href="#calibre_link-1862" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">611</a></p>
<p class="edition" id="calibre_link-3904">creating reproduction queries, <a href="#calibre_link-1964" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">661</a>&ndash;<a href="#calibre_link-1976" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">662</a></p>
<p class="edition" id="calibre_link-3905">DISTINCTCOUNT function, <a href="#calibre_link-1977" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">634</a>&ndash;<a href="#calibre_link-1933" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">635</a></p>
<p class="edition" id="calibre_link-3906">executing, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-3907">query plans, <a href="#calibre_link-1979" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">612</a>&ndash;<a href="#calibre_link-1970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">613</a></p>
<p class="edition" id="calibre_link-3908">collecting, <a href="#calibre_link-1970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">613</a>&ndash;<a href="#calibre_link-1980" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">614</a></p>
<p class="edition" id="calibre_link-3909">DAX Studio, <a href="#calibre_link-1981" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">617</a>&ndash;<a href="#calibre_link-1982" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">620</a></p>
<p class="edition" id="calibre_link-3910">logical query plans, <a href="#calibre_link-1979" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">612</a>, <a href="#calibre_link-1980" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">614</a></p>
<p class="edition" id="calibre_link-3911">physical query plans, <a href="#calibre_link-1979" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">612</a>&ndash;<a href="#calibre_link-1970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">613</a>, <a href="#calibre_link-1980" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">614</a>&ndash;<a href="#calibre_link-1983" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">616</a></p>
<p class="edition" id="calibre_link-3912">SQL Server Profiler, <a href="#calibre_link-1982" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">620</a>&ndash;<a href="#calibre_link-1984" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">623</a></p>
<p class="edition" id="calibre_link-3913">as querying language, <a href="#calibre_link-1965" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">10</a>&ndash;<a href="#calibre_link-1899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">11</a></p>
<p class="edition" id="calibre_link-3914">SQL and, <a href="#calibre_link-1927" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">9</a></p>
<p class="edition" id="calibre_link-3915">subqueries, <a href="#calibre_link-1899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">11</a></p>
<p class="edition" id="calibre_link-3916">DAX engines</p>
<p class="edition" id="calibre_link-3917">DirectQuery, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a>, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a>, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-3918">FE, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a>, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-3919">datacaches, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-3920">operators of, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-3921">single-threaded implementation, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-3922">SE, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-3923">aggregations, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-3924">datacaches, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-3925">DirectQuery, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a>, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-3926">operators of, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-3927">parallel implementations, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-3928">VertiPaq, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a>&ndash;<a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a>, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a>&ndash;<a href="#calibre_link-1985" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">577</a></p>
<p class="edition" id="calibre_link-3929">Tabular model and, <a href="#calibre_link-1986" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">545</a>&ndash;<a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-3930">VertiPaq, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a>, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a>&ndash;<a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a>, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a>. <em class="calibre5">See also</em> <a href="#calibre_link-1987" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">data models</a>, <a href="#calibre_link-1988" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">optimizing with VertiPaq</a></p>
<p class="edition" id="calibre_link-3931">aggregations, <a href="#calibre_link-1662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">571</a>&ndash;<a href="#calibre_link-1989" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">573</a></p>
<p class="edition" id="calibre_link-3932">columnar databases, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a>&ndash;<a href="#calibre_link-1877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">553</a></p>
<p class="edition" id="calibre_link-3933">compression, <a href="#calibre_link-1877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">553</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a></p>
<p class="edition" id="calibre_link-3934">datacaches, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-3935">DMV, <a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a>&ndash;<a href="#calibre_link-1992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">565</a></p>
<p class="edition" id="calibre_link-3936">hardware selection, <a href="#calibre_link-1989" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">573</a>&ndash;<a href="#calibre_link-1985" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">577</a></p>
<p class="edition" id="calibre_link-3937">hash encoding, <a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a>&ndash;<a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a></p>
<p class="edition" id="calibre_link-3938">hierarchies, <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a></p>
<p class="edition" id="calibre_link-3939">materialization, <a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a>&ndash;<a href="#calibre_link-1662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">571</a></p>
<p class="edition" id="calibre_link-3940">multithreaded implementations, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-3941">partitioning, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-3942">processing tables, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a></p>
<p class="edition" id="calibre_link-3943">re-encoding, <a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-3944">relationships (data models), <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>, <a href="#calibre_link-1992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">565</a>&ndash;<a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a></p>
<p class="edition" id="calibre_link-3945">RLE, <a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a>&ndash;<a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-3946">scan operations, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-3947">segmentation, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-3948">sort orders, <a href="#calibre_link-1994" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">560</a>&ndash;<a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a></p>
<p class="edition" id="calibre_link-3949">value encoding, <a href="#calibre_link-1891" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">554</a>&ndash;<a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a></p>
<p class="edition" id="calibre_link-3950">DAX Studio, <a href="#calibre_link-1724" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">395</a></p>
<p class="edition" id="calibre_link-3951">capturing DAX queries, <a href="#calibre_link-1861" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">609</a>&ndash;<a href="#calibre_link-1862" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">611</a></p>
<p class="edition" id="calibre_link-3952">Power BI and, <a href="#calibre_link-1861" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">609</a>&ndash;<a href="#calibre_link-1862" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">611</a></p>
<p class="edition" id="calibre_link-3953">query measures, creating, <a href="#calibre_link-1976" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">662</a>&ndash;<a href="#calibre_link-1995" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">663</a></p>
<p class="edition" id="calibre_link-3954">query plans, capturing profiling information, <a href="#calibre_link-1981" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">617</a>&ndash;<a href="#calibre_link-1982" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">620</a></p>
<p class="edition" id="calibre_link-3955">VertiPaq caches, <a href="#calibre_link-1996" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">639</a>&ndash;<a href="#calibre_link-1860" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">640</a></p>
<p class="edition" id="calibre_link-3956">DAXFormatter.com, <a href="#calibre_link-1997" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">41</a></p>
<p class="edition" id="calibre_link-3957">Decimal data type, <a href="#calibre_link-1917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">21</a></p>
<p class="edition" id="calibre_link-3958">DEFINE MEASURE clauses in EVALUATE statements, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-3959"><span type="pagebreak" id="calibre_link-3960"></span>DEFINE sections (authoring queries)</p>
<p class="edition" id="calibre_link-3961">MEASURE keyword in, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-3962">VAR keyword in, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-3963">denormalizing data and data model optimization, <a href="#calibre_link-1926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">584</a>&ndash;<a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a></p>
<p class="edition" id="calibre_link-3964">descriptive attributes column (tables), <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a>, <a href="#calibre_link-1879" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">601</a>&ndash;<a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-3965">DETAILROWS function, reusing table expressions, <a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a>&ndash;<a href="#calibre_link-1998" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">389</a></p>
<p class="edition" id="calibre_link-3966">dictionary encoding. <em class="calibre5">See</em> <a href="#calibre_link-1999" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">hash encoding</a></p>
<p class="edition" id="calibre_link-3967">Dictionary Size column (VertiPaq Analyzer), <a href="#calibre_link-1870" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">581</a></p>
<p class="edition" id="calibre_link-3968">DirectQuery, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a>&ndash;<a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a>, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a>, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a>, <a href="#calibre_link-1981" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">617</a></p>
<p class="edition" id="calibre_link-3969">calculated columns, <a href="#calibre_link-1817" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">25</a>&ndash;<a href="#calibre_link-1818" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">26</a></p>
<p class="edition" id="calibre_link-3970">composite data models, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-3971">End events (SQL Server Profiler), <a href="#calibre_link-2000" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">621</a></p>
<p class="edition" id="calibre_link-3972">SE, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-3973">composite data models, <a href="#calibre_link-1889" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">646</a>&ndash;<a href="#calibre_link-1665" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">647</a></p>
<p class="edition" id="calibre_link-3974">reading, <a href="#calibre_link-2001" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">645</a>&ndash;<a href="#calibre_link-1889" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">646</a></p>
<p class="edition" id="calibre_link-3975">single data models, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-3976">Disk I/O performance, VertiPaq hardware selection, <a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a>, <a href="#calibre_link-1910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">576</a>&ndash;<a href="#calibre_link-1985" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">577</a></p>
<p class="edition" id="calibre_link-3977">DISTINCT function, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-3978">blank rows and invalid relataionships, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a>, <a href="#calibre_link-2002" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">70</a>&ndash;<a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-3979">calculated columns, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-3980">calculated physical relationships</p>
<p class="edition" id="calibre_link-3981">circular dependencies, <a href="#calibre_link-2003" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">477</a>&ndash;<a href="#calibre_link-1684" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">478</a></p>
<p class="edition" id="calibre_link-3982">range-based relationships, <a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-3983">filter contexts, <a href="#calibre_link-1745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">111</a>&ndash;<a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-3984">multiple columns, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-3985">UNION function and, <a href="#calibre_link-2004" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">375</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-3986">VALUES function versus, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-3987">DISTINCTCOUNT function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3988">DAX optimization, <a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a>&ndash;<a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a></p>
<p class="edition" id="calibre_link-3989">same-store sales (calculations), computing, <a href="#calibre_link-2005" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">535</a>&ndash;<a href="#calibre_link-1848" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">536</a></p>
<p class="edition" id="calibre_link-3990">table filters, avoiding, <a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a>&ndash;<a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a></p>
<p class="edition" id="calibre_link-3991">VertiPaq SE queries, <a href="#calibre_link-1977" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">634</a>&ndash;<a href="#calibre_link-1933" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">635</a></p>
<p class="edition" id="calibre_link-3992">DISTINCTCOUNTNOBLANK function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-3993">DIVIDE function, DAX optimization, <a href="#calibre_link-2006" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">684</a>&ndash;<a href="#calibre_link-2007" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">687</a></p>
<p class="edition" id="calibre_link-3994">division by zero, arithmetic operators, <a href="#calibre_link-1720" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">32</a>&ndash;<a href="#calibre_link-1721" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">33</a></p>
<p class="edition" id="calibre_link-3995">DMV (Dynamic Management Views) and SSAS, <a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a>&ndash;<a href="#calibre_link-1992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">565</a></p>
<p class="edition" id="calibre_link-3996">documenting code, variables, <a href="#calibre_link-1873" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">183</a>&ndash;<a href="#calibre_link-1874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">184</a></p>
<p class="edition" id="calibre_link-3997">drill-through attributes, optimizing, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a></p>
<p class="edition" id="calibre_link-3998">drillthrough operations, time intelligence calculations, <a href="#calibre_link-1948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">271</a></p>
<p class="edition" id="calibre_link-3999">duplicating, date tables, <a href="#calibre_link-1938" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">227</a></p>
<p class="edition" id="calibre_link-4000">duration of an order example, <a href="#calibre_link-1818" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">26</a></p>
<p class="edition" id="calibre_link-4001">dynamic segmentation, virtual relationships and, <a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a>&ndash;<a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4002" class="h2a">E</h3>
<p class="edition" id="calibre_link-4003">EARLIER function, evaluation contexts, <a href="#calibre_link-2008" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">97</a>&ndash;<a href="#calibre_link-2009" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">98</a></p>
<p class="edition" id="calibre_link-4004">editing text, formatting DAX code, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-4005">empty/missing values, error-handling, <a href="#calibre_link-1721" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">33</a>&ndash;<a href="#calibre_link-1722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">35</a></p>
<p class="edition" id="calibre_link-4006">Encoding column (VertiPaq Analyzer), <a href="#calibre_link-1887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">582</a>, <a href="#calibre_link-1871" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">583</a></p>
<p class="edition" id="calibre_link-4007">error-handling</p>
<p class="edition" id="calibre_link-4008">BLANK function, <a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a></p>
<p class="edition" id="calibre_link-4009">Excel, empty/missing values, <a href="#calibre_link-1722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">35</a></p>
<p class="edition" id="calibre_link-4010">expressions, <a href="#calibre_link-1908" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">31</a></p>
<p class="edition" id="calibre_link-4011">arithmetic operator errors, <a href="#calibre_link-1720" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">32</a>&ndash;<a href="#calibre_link-1722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">35</a></p>
<p class="edition" id="calibre_link-4012">conversion errors, <a href="#calibre_link-1908" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">31</a>&ndash;<a href="#calibre_link-1720" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">32</a></p>
<p class="edition" id="calibre_link-4013">generating errors, <a href="#calibre_link-2010" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">38</a>&ndash;<a href="#calibre_link-2011" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">39</a></p>
<p class="edition" id="calibre_link-4014">IF function, <a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a>, <a href="#calibre_link-2012" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">37</a></p>
<p class="edition" id="calibre_link-4015">IFERROR function, <a href="#calibre_link-1722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">35</a>&ndash;<a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a>, <a href="#calibre_link-2012" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">37</a>&ndash;<a href="#calibre_link-2010" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">38</a></p>
<p class="edition" id="calibre_link-4016">ISBLANK function, <a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a></p>
<p class="edition" id="calibre_link-4017">ISERROR function, <a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a>, <a href="#calibre_link-2010" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">38</a></p>
<p class="edition" id="calibre_link-4018">SQRT function, <a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a></p>
<p class="edition" id="calibre_link-4019">variables, <a href="#calibre_link-2012" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">37</a></p>
<p class="edition" id="calibre_link-4020">EVALUATE statements</p>
<p class="edition" id="calibre_link-4021">ADDMISSINGITEMS function, <a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a>&ndash;<a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>, <a href="#calibre_link-1657" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">432</a>&ndash;<a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a></p>
<p class="edition" id="calibre_link-4022">DEFINE MEASURE clauses, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-4023">example of, <a href="#calibre_link-1729" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">396</a></p>
<p class="edition" id="calibre_link-4024">expression variables and, <a href="#calibre_link-1730" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">398</a></p>
<p class="edition" id="calibre_link-4025">GENERATE function, <a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a>&ndash;<a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-4026">GENERATEALL function, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-4027">GROUPBY function, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>&ndash;<a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a></p>
<p class="edition" id="calibre_link-4028">ISONORAFTER function, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a>&ndash;<a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a></p>
<p class="edition" id="calibre_link-4029">NATURALINNERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-4030">NATURALLEFTOUTERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-4031">ORDER BY clauses, <a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a></p>
<p class="edition" id="calibre_link-4032">query variables and, <a href="#calibre_link-1730" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">398</a></p>
<p class="edition" id="calibre_link-4033">ROW function, <a href="#calibre_link-1735" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">400</a>&ndash;<a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-4034">SAMPLE function, <a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a>&ndash;<a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a></p>
<p class="edition" id="calibre_link-4035">SUBSTITUTEWITHINDEX function, <a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a>&ndash;<a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a></p>
<p class="edition" id="calibre_link-4036">SUMMARIZE function, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a>&ndash;<a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>, <a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-4037">SUMMARIZECOLUMNS function, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>, <a href="#calibre_link-1740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">429</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-4038">syntax of, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a>&ndash;<a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a>, <a href="#calibre_link-1729" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">396</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-4039">TOPN function, <a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>&ndash;<a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a></p>
<p class="edition" id="calibre_link-4040">TOPNSKIP function, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a></p>
<p class="edition" id="calibre_link-4041">evaluation contexts, <a href="#calibre_link-1786" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">79</a></p>
<p class="edition" id="calibre_link-4042">ALL function, <a href="#calibre_link-1688" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">100</a>&ndash;<a href="#calibre_link-1689" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">101</a></p>
<p class="edition" id="calibre_link-4043">AVERAGEX function, filter contexts, <a href="#calibre_link-1745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">111</a>&ndash;<a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4044">CALCULATE function, <a href="#calibre_link-1786" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">79</a></p>
<p class="edition" id="calibre_link-4045">columns in measures, <a href="#calibre_link-1823" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">89</a>&ndash;<a href="#calibre_link-1881" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">90</a></p>
<p class="edition" id="calibre_link-4046">COUNTROWS function, filter contexts and relationships, <a href="#calibre_link-2014" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">107</a>&ndash;<a href="#calibre_link-2015" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">108</a></p>
<p class="edition" id="calibre_link-4047">defined, <a href="#calibre_link-2016" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">80</a></p>
<p class="edition" id="calibre_link-4048"><span type="pagebreak" id="calibre_link-4049"></span>DISTINCT function, filter contexts, <a href="#calibre_link-1745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">111</a>&ndash;<a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4050">EARLIER function, <a href="#calibre_link-2008" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">97</a>&ndash;<a href="#calibre_link-2009" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">98</a></p>
<p class="edition" id="calibre_link-4051">filter contexts, <a href="#calibre_link-2016" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">80</a>, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a>&ndash;<a href="#calibre_link-2017" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">110</a></p>
<p class="edition" id="calibre_link-4052">AVERAGEX function, <a href="#calibre_link-1745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">111</a>&ndash;<a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4053">CALCULATE function, <a href="#calibre_link-1788" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">118</a>&ndash;<a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a></p>
<p class="edition" id="calibre_link-4054">CALCULATE function and, <a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a>&ndash;<a href="#calibre_link-1781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">151</a></p>
<p class="edition" id="calibre_link-4055">creating, <a href="#calibre_link-1773" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">115</a>&ndash;<a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a></p>
<p class="edition" id="calibre_link-4056">DISTINCT function, <a href="#calibre_link-1745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">111</a>&ndash;<a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4057">examples of, <a href="#calibre_link-2016" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">80</a>&ndash;<a href="#calibre_link-2018" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">85</a></p>
<p class="edition" id="calibre_link-4058">filter arguments, <a href="#calibre_link-1788" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">118</a>&ndash;<a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a></p>
<p class="edition" id="calibre_link-4059">relationships and, <a href="#calibre_link-1755" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">106</a>&ndash;<a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-4060">row contexts versus, <a href="#calibre_link-2018" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">85</a></p>
<p class="edition" id="calibre_link-4061">SUMMARIZE function, <a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4062">FILTER function, <a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a>&ndash;<a href="#calibre_link-2019" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">93</a>, <a href="#calibre_link-2020" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">94</a>&ndash;<a href="#calibre_link-1912" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">95</a>, <a href="#calibre_link-2009" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">98</a>&ndash;<a href="#calibre_link-1689" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">101</a></p>
<p class="edition" id="calibre_link-4063">multiple tables, working with, <a href="#calibre_link-1689" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">101</a>&ndash;<a href="#calibre_link-2021" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">102</a></p>
<p class="edition" id="calibre_link-4064">filter contexts and relationships, <a href="#calibre_link-1755" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">106</a>&ndash;<a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-4065">row contexts and relationships, <a href="#calibre_link-2021" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">102</a>&ndash;<a href="#calibre_link-2022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">105</a></p>
<p class="edition" id="calibre_link-4066">RELATED function</p>
<p class="edition" id="calibre_link-4067">filter contexts and relationships, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-4068">nested row contexts on different tables, <a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a></p>
<p class="edition" id="calibre_link-4069">row contexts and relationships, <a href="#calibre_link-2023" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">103</a>&ndash;<a href="#calibre_link-2022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">105</a></p>
<p class="edition" id="calibre_link-4070">RELATEDTABLE function</p>
<p class="edition" id="calibre_link-4071">filter contexts and relationships, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-4072">nested row contexts on different tables, <a href="#calibre_link-2024" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">91</a>&ndash;<a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a></p>
<p class="edition" id="calibre_link-4073">row contexts and relationships, <a href="#calibre_link-2023" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">103</a>&ndash;<a href="#calibre_link-2022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">105</a></p>
<p class="edition" id="calibre_link-4074">relationships and, <a href="#calibre_link-1689" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">101</a>&ndash;<a href="#calibre_link-2021" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">102</a></p>
<p class="edition" id="calibre_link-4075">filter contexts, <a href="#calibre_link-1755" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">106</a>&ndash;<a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-4076">row contexts, <a href="#calibre_link-2021" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">102</a>&ndash;<a href="#calibre_link-2022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">105</a></p>
<p class="edition" id="calibre_link-4077">row contexts, <a href="#calibre_link-2016" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">80</a></p>
<p class="edition" id="calibre_link-4078">CALCULATE function and, <a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a>&ndash;<a href="#calibre_link-1781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">151</a></p>
<p class="edition" id="calibre_link-4079">column references, <a href="#calibre_link-1882" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">87</a></p>
<p class="edition" id="calibre_link-4080">examples of, <a href="#calibre_link-2025" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">86</a>&ndash;<a href="#calibre_link-1882" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">87</a></p>
<p class="edition" id="calibre_link-4081">filter contexts versus, <a href="#calibre_link-2018" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">85</a></p>
<p class="edition" id="calibre_link-4082">iterators and, <a href="#calibre_link-1881" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">90</a>&ndash;<a href="#calibre_link-2024" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">91</a></p>
<p class="edition" id="calibre_link-4083">nested row contexts on different tables, <a href="#calibre_link-2024" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">91</a>&ndash;<a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a></p>
<p class="edition" id="calibre_link-4084">nested row contexts on the same table, <a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a>&ndash;<a href="#calibre_link-2008" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">97</a></p>
<p class="edition" id="calibre_link-4085">relationships and, <a href="#calibre_link-2021" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">102</a>&ndash;<a href="#calibre_link-2022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">105</a></p>
<p class="edition" id="calibre_link-4086">SUM function, in calculated columns, <a href="#calibre_link-1822" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">88</a>&ndash;<a href="#calibre_link-1823" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">89</a></p>
<p class="edition" id="calibre_link-4087">SUMMARIZE function, filter contexts, <a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4088">evaluations (multiple), avoiding with variables, <a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a>&ndash;<a href="#calibre_link-1897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">708</a></p>
<p class="edition" id="calibre_link-4089">events (calculations), numbering sequences of, <a href="#calibre_link-1848" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">536</a>&ndash;<a href="#calibre_link-1846" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">539</a></p>
<p class="edition" id="calibre_link-4090">Excel</p>
<p class="edition" id="calibre_link-4091">calculations, <a href="#calibre_link-1962" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">8</a></p>
<p class="edition" id="calibre_link-4092">cells, <a href="#calibre_link-1872" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">5</a></p>
<p class="edition" id="calibre_link-4093">columns, <a href="#calibre_link-1872" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">5</a>&ndash;<a href="#calibre_link-1878" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">7</a></p>
<p class="edition" id="calibre_link-4094">DAX and</p>
<p class="edition" id="calibre_link-4095">cells and tables, <a href="#calibre_link-1872" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">5</a>&ndash;<a href="#calibre_link-1878" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">7</a></p>
<p class="edition" id="calibre_link-4096">functional languages, <a href="#calibre_link-1878" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">7</a></p>
<p class="edition" id="calibre_link-4097">theories, <a href="#calibre_link-1962" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">8</a>&ndash;<a href="#calibre_link-1927" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">9</a></p>
<p class="edition" id="calibre_link-4098">error-handling, empty/missing values, <a href="#calibre_link-1722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">35</a></p>
<p class="edition" id="calibre_link-4099">formulas, <a href="#calibre_link-1966" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">6</a></p>
<p class="edition" id="calibre_link-4100">functions, <a href="#calibre_link-1966" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">6</a>&ndash;<a href="#calibre_link-1878" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">7</a></p>
<p class="edition" id="calibre_link-4101">Power Pivot for Excel</p>
<p class="edition" id="calibre_link-4102">automatic date columns, <a href="#calibre_link-1742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">219</a></p>
<p class="edition" id="calibre_link-4103">date table templates, <a href="#calibre_link-1936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">220</a></p>
<p class="edition" id="calibre_link-4104">EXCEPT function, tables and, <a href="#calibre_link-2026" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">379</a>&ndash;<a href="#calibre_link-1919" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">381</a></p>
<p class="edition" id="calibre_link-4105">expanded tables</p>
<p class="edition" id="calibre_link-4106">active relationships, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-4107">column filters versus table filters, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-4108">context transitions, <a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a>&ndash;<a href="#calibre_link-1702" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">455</a></p>
<p class="edition" id="calibre_link-4109">filter contexts, <a href="#calibre_link-1928" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">439</a>&ndash;<a href="#calibre_link-2027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">441</a></p>
<p class="edition" id="calibre_link-4110">filtering, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-4111">active relationships and, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-4112">differences between table filters and expanded tables, <a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a>&ndash;<a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a></p>
<p class="edition" id="calibre_link-4113">RELATED function, <a href="#calibre_link-2027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">441</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-4114">relationships, <a href="#calibre_link-2028" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">437</a>&ndash;<a href="#calibre_link-2027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">441</a></p>
<p class="edition" id="calibre_link-4115">table filters</p>
<p class="edition" id="calibre_link-4116">column filters versus, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-4117">in measures, <a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a>&ndash;<a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a></p>
<p class="edition" id="calibre_link-4118">Expression calculation item, <a href="#calibre_link-1843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">289</a></p>
<p class="edition" id="calibre_link-4119">Expression Trees, <a href="#calibre_link-1979" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">612</a></p>
<p class="edition" id="calibre_link-4120">expressions</p>
<p class="edition" id="calibre_link-4121">calculated columns, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a></p>
<p class="edition" id="calibre_link-4122">calculation items, applying to expressions, <a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a></p>
<p class="edition" id="calibre_link-4123">CALCULATE function, <a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a>&ndash;<a href="#calibre_link-1776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">299</a></p>
<p class="edition" id="calibre_link-4124">DATESYTD function, <a href="#calibre_link-1839" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">293</a>&ndash;<a href="#calibre_link-1840" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">296</a></p>
<p class="edition" id="calibre_link-4125">YTD calculations, <a href="#calibre_link-1841" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">294</a></p>
<p class="edition" id="calibre_link-4126">comments, placement in expressions, <a href="#calibre_link-1850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">18</a></p>
<p class="edition" id="calibre_link-4127">DAX optimization, <a href="#calibre_link-1963" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">658</a>&ndash;<a href="#calibre_link-1964" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">661</a>, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-4128">error-handling, <a href="#calibre_link-1908" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">31</a></p>
<p class="edition" id="calibre_link-4129">arithmetic operator errors, <a href="#calibre_link-1720" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">32</a>&ndash;<a href="#calibre_link-1722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">35</a></p>
<p class="edition" id="calibre_link-4130">conversion errors, <a href="#calibre_link-1908" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">31</a>&ndash;<a href="#calibre_link-1720" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">32</a></p>
<p class="edition" id="calibre_link-4131">formatting, <a href="#calibre_link-2011" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">39</a>&ndash;<a href="#calibre_link-2029" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">40</a>, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-4132">MDX</p>
<p class="edition" id="calibre_link-4133">DAX and, <a href="#calibre_link-1967" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">12</a>&ndash;<a href="#calibre_link-1968" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">13</a>, <a href="#calibre_link-1969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">14</a></p>
<p class="edition" id="calibre_link-4134">queries, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a>, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a>, <a href="#calibre_link-1970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">613</a>, <a href="#calibre_link-1995" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">663</a>&ndash;<a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a></p>
<p class="edition" id="calibre_link-4135">query measures, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-4136">scalar expressions, <a href="#calibre_link-2030" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">57</a>&ndash;<a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a></p>
<p class="edition" id="calibre_link-4137">table expressions</p>
<p class="edition" id="calibre_link-4138">EVALUATE statements, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a>&ndash;<a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a></p>
<p class="edition" id="calibre_link-4139">reusing, <a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a>&ndash;<a href="#calibre_link-1998" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">389</a></p>
<p class="edition" id="calibre_link-4140">variables, <a href="#calibre_link-1821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">30</a>&ndash;<a href="#calibre_link-1908" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">31</a>, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4141" class="h2a"><span type="pagebreak" id="calibre_link-4142"></span>F</h3>
<p class="edition" id="calibre_link-4143">FE (Formula Engines), <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a>, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-4144">bottlenecks, identifying, <a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a>&ndash;<a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-4145">datacaches, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-4146">operators of, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-4147">query plans, reading, <a href="#calibre_link-2032" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">652</a>&ndash;<a href="#calibre_link-2033" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">653</a>, <a href="#calibre_link-2034" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">654</a>&ndash;<a href="#calibre_link-2035" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">655</a></p>
<p class="edition" id="calibre_link-4148">single-threaded implementation, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a>, <a href="#calibre_link-2036" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">642</a></p>
<p class="edition" id="calibre_link-2084">filter arguments</p>
<p class="edition" id="calibre_link-4149">CALCULATE function, <a href="#calibre_link-1788" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">118</a>&ndash;<a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a>, <a href="#calibre_link-1789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">122</a>, <a href="#calibre_link-1764" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">123</a>, <a href="#calibre_link-1790" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">445</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-4150">defined, <a href="#calibre_link-1763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">120</a></p>
<p class="edition" id="calibre_link-4151">multiple column references, <a href="#calibre_link-1792" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">140</a></p>
<p class="edition" id="calibre_link-4152">SUMMARIZECOLUMNS function, <a href="#calibre_link-2037" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">406</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a></p>
<p class="edition" id="calibre_link-4153">filter contexts, <a href="#calibre_link-2016" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">80</a>, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a>&ndash;<a href="#calibre_link-2017" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">110</a>, <a href="#calibre_link-2038" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">313</a>, <a href="#calibre_link-1716" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">343</a>&ndash;<a href="#calibre_link-2039" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">344</a></p>
<p class="edition" id="calibre_link-4154">ALL function, <a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a>&ndash;<a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>, <a href="#calibre_link-1691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">327</a>&ndash;<a href="#calibre_link-1687" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">330</a></p>
<p class="edition" id="calibre_link-4155">ALLEXCEPT function, <a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-4156">arbitrarily shaped filters, <a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-4157">best practices, <a href="#calibre_link-1716" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">343</a></p>
<p class="edition" id="calibre_link-4158">building, <a href="#calibre_link-1717" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">338</a>&ndash;<a href="#calibre_link-1716" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">343</a></p>
<p class="edition" id="calibre_link-4159">column filters versus, <a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-4160">defined, <a href="#calibre_link-1718" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">337</a>&ndash;<a href="#calibre_link-1717" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">338</a></p>
<p class="edition" id="calibre_link-4161">simple filters versus, <a href="#calibre_link-1718" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">337</a></p>
<p class="edition" id="calibre_link-4162">uses of, <a href="#calibre_link-1716" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">343</a></p>
<p class="edition" id="calibre_link-4163">AVERAGEX function, <a href="#calibre_link-1745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">111</a>&ndash;<a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4164">CALCULATE function, <a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a>&ndash;<a href="#calibre_link-1781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">151</a></p>
<p class="edition" id="calibre_link-4165">filter arguments, <a href="#calibre_link-1788" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">118</a>&ndash;<a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a></p>
<p class="edition" id="calibre_link-4166">overwriting filters, <a href="#calibre_link-1763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">120</a>&ndash;<a href="#calibre_link-1789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">122</a></p>
<p class="edition" id="calibre_link-4167">column filters</p>
<p class="edition" id="calibre_link-4168">arbitrarily shaped filters versus, <a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-4169">defined, <a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-4170">creating, <a href="#calibre_link-1773" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">115</a>&ndash;<a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a></p>
<p class="edition" id="calibre_link-4171">data lineage, <a href="#calibre_link-1922" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">332</a>&ndash;<a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-4172">DISTINCT function, <a href="#calibre_link-1745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">111</a>&ndash;<a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4173">examples of, <a href="#calibre_link-2016" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">80</a>&ndash;<a href="#calibre_link-2018" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">85</a></p>
<p class="edition" id="calibre_link-4174">expanded tables, <a href="#calibre_link-1928" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">439</a>&ndash;<a href="#calibre_link-2027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">441</a></p>
<p class="edition" id="calibre_link-4175">FILTERS function, <a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a>&ndash;<a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a></p>
<p class="edition" id="calibre_link-4176">HASONVALUE function, <a href="#calibre_link-2041" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">314</a>&ndash;<a href="#calibre_link-2042" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">318</a></p>
<p class="edition" id="calibre_link-4177">ISCROSSFILTERED function, <a href="#calibre_link-2043" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">319</a>&ndash;<a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a></p>
<p class="edition" id="calibre_link-4178">ISEMPTY function, <a href="#calibre_link-1687" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">330</a>&ndash;<a href="#calibre_link-1922" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">332</a></p>
<p class="edition" id="calibre_link-4179">ISFILTERED function, <a href="#calibre_link-2043" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">319</a>, <a href="#calibre_link-2044" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">320</a>&ndash;<a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a></p>
<p class="edition" id="calibre_link-4180">nesting in variables, <a href="#calibre_link-1874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">184</a>&ndash;<a href="#calibre_link-2045" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">185</a></p>
<p class="edition" id="calibre_link-4181">relationships and, <a href="#calibre_link-1755" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">106</a>&ndash;<a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-4182">row contexts versus, <a href="#calibre_link-2018" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">85</a></p>
<p class="edition" id="calibre_link-4183">SELECTEDVALUE function, <a href="#calibre_link-2042" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">318</a>&ndash;<a href="#calibre_link-2043" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">319</a></p>
<p class="edition" id="calibre_link-4184">simple filters</p>
<p class="edition" id="calibre_link-4185">arbitrarily shaped filters versus, <a href="#calibre_link-1718" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">337</a></p>
<p class="edition" id="calibre_link-4186">defined, <a href="#calibre_link-1718" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">337</a></p>
<p class="edition" id="calibre_link-4187">SUMMARIZE function, <a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4188">TREATAS function, <a href="#calibre_link-2046" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">334</a>&ndash;<a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-4189">VALUES function, <a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a>&ndash;<a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a>, <a href="#calibre_link-1691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">327</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-4190">FILTER function, <a href="#calibre_link-2030" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">57</a>&ndash;<a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a></p>
<p class="edition" id="calibre_link-4191">CALCULATETABLE function versus, <a href="#calibre_link-1829" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">363</a>&ndash;<a href="#calibre_link-1830" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">365</a></p>
<p class="edition" id="calibre_link-4192">code maintenance/readability, <a href="#calibre_link-1875" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">62</a>&ndash;<a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a></p>
<p class="edition" id="calibre_link-4193">evaluation contexts, <a href="#calibre_link-2009" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">98</a>&ndash;<a href="#calibre_link-1689" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">101</a></p>
<p class="edition" id="calibre_link-4194">as iterator, <a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a>&ndash;<a href="#calibre_link-2047" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">61</a></p>
<p class="edition" id="calibre_link-4195">nested row contexts on the same table, <a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a>&ndash;<a href="#calibre_link-2019" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">93</a>, <a href="#calibre_link-2020" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">94</a>&ndash;<a href="#calibre_link-1912" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">95</a></p>
<p class="edition" id="calibre_link-4196">nesting, <a href="#calibre_link-2047" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">61</a>&ndash;<a href="#calibre_link-1875" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">62</a></p>
<p class="edition" id="calibre_link-4197">range-based relationships (calculated physical relationships), <a href="#calibre_link-1802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">474</a>&ndash;<a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-4198">syntax of, <a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a></p>
<p class="edition" id="calibre_link-4199">time intelligence calculations, <a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a>&ndash;<a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a></p>
<p class="edition" id="calibre_link-4200">transferring filters, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-4201">filter operations, xmSQL queries, <a href="#calibre_link-2048" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">628</a>&ndash;<a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a></p>
<p class="edition" id="calibre_link-4202">filtering</p>
<p class="edition" id="calibre_link-4203">ALLCROSSFILTERED function, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a></p>
<p class="edition" id="calibre_link-4204">columns (tables) versus table filters, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-4205">DAX optimization, filter conditions, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a>&ndash;<a href="#calibre_link-1903" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">672</a></p>
<p class="edition" id="calibre_link-4206">expanded tables</p>
<p class="edition" id="calibre_link-4207">differences between table filters and expanded tables, <a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a>&ndash;<a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a></p>
<p class="edition" id="calibre_link-4208">table filters and active relationships, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-4209">FILTER function</p>
<p class="edition" id="calibre_link-4210">range-based relationships (calculated physical relationships), <a href="#calibre_link-1802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">474</a>&ndash;<a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-4211">transferring filters, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-4212">KEEPFILTERS function, <a href="#calibre_link-2049" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">461</a>&ndash;<a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a>, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>&ndash;<a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-4213">relationships</p>
<p class="edition" id="calibre_link-4214">bidirectional filtering, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a>&ndash;<a href="#calibre_link-1754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">4</a></p>
<p class="edition" id="calibre_link-4215">unidirectional filtering, <a href="#calibre_link-1754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">4</a></p>
<p class="edition" id="calibre_link-4216">shadow filter contexts, <a href="#calibre_link-1703" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">457</a>&ndash;<a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a></p>
<p class="edition" id="calibre_link-4217">tables, <a href="#calibre_link-1919" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">381</a></p>
<p class="edition" id="calibre_link-4218">CALCULATE function and, <a href="#calibre_link-1790" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">445</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-4219">column filters versus, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-4220">differences between table filters and expanded tables, <a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a>&ndash;<a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a></p>
<p class="edition" id="calibre_link-4221">DISTINCTCOUNT function, <a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a>&ndash;<a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a></p>
<p class="edition" id="calibre_link-4222">in measures, <a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a>&ndash;<a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a></p>
<p class="edition" id="calibre_link-4223">OR conditions, <a href="#calibre_link-1919" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">381</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a></p>
<p class="edition" id="calibre_link-4224">table filters and active relationships, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-4225">transferring filters, <a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a>&ndash;<a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a></p>
<p class="edition" id="calibre_link-4226">CALCULATE function, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a></p>
<p class="edition" id="calibre_link-4227"><span type="pagebreak" id="calibre_link-4228"></span>CONTAINS function, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a></p>
<p class="edition" id="calibre_link-4229">FILTER function, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-4230">INTERSECT function, <a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>&ndash;<a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-4231">TREATAS function, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>&ndash;<a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-4232">FILTERS function</p>
<p class="edition" id="calibre_link-4233">filter contexts, <a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a>&ndash;<a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a></p>
<p class="edition" id="calibre_link-4234">VALUES function versus, <a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a>&ndash;<a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a></p>
<p class="edition" id="calibre_link-4235">FIRSTDATE function, time intelligence calculations, <a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a></p>
<p class="edition" id="calibre_link-4236">FIRSTNONBLANK function, time intelligence calculations, <a href="#calibre_link-1950" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">256</a>&ndash;<a href="#calibre_link-1951" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">257</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a>&ndash;<a href="#calibre_link-1948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">271</a></p>
<p class="edition" id="calibre_link-4237">FORMAT function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-4238">format strings</p>
<p class="edition" id="calibre_link-4239">calculation items and, <a href="#calibre_link-1843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">289</a>&ndash;<a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a></p>
<p class="edition" id="calibre_link-4240">defined, <a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a></p>
<p class="edition" id="calibre_link-4241">SELECTEDMEASUREFORMATSTRING function, <a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a></p>
<p class="edition" id="calibre_link-4242">formatting DAX code, <a href="#calibre_link-2011" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">39</a>, <a href="#calibre_link-1997" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">41</a>&ndash;<a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-4243">DAXFormatter.com, <a href="#calibre_link-1997" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">41</a></p>
<p class="edition" id="calibre_link-4244">editing text, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-4245">expressions, <a href="#calibre_link-2011" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">39</a>&ndash;<a href="#calibre_link-2029" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">40</a>, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-4246">formulas, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-4247">help, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-4248">variables, <a href="#calibre_link-2029" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">40</a>&ndash;<a href="#calibre_link-1997" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">41</a></p>
<p class="edition" id="calibre_link-4249">formulas</p>
<p class="edition" id="calibre_link-4250">Excel, <a href="#calibre_link-1966" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">6</a></p>
<p class="edition" id="calibre_link-4251">formatting, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-4252">IN function, tables and, <a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a>&ndash;<a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a></p>
<p class="edition" id="calibre_link-4253">functions</p>
<p class="edition" id="calibre_link-4254">ADDCOLUMNS function, <a href="#calibre_link-1647" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">223</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a>, <a href="#calibre_link-1649" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">366</a>&ndash;<a href="#calibre_link-1650" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">369</a>, <a href="#calibre_link-1651" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">371</a>&ndash;<a href="#calibre_link-1652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">372</a></p>
<p class="edition" id="calibre_link-4255">ADDMISSINGITEMS function</p>
<p class="edition" id="calibre_link-4256">authoring queries, <a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a>&ndash;<a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>, <a href="#calibre_link-1657" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">432</a>&ndash;<a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a></p>
<p class="edition" id="calibre_link-4257">auto-exists feature (queries), <a href="#calibre_link-1657" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">432</a>&ndash;<a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a></p>
<p class="edition" id="calibre_link-4258">aggregation functions, xmSQL queries, <a href="#calibre_link-1659" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">625</a>&ndash;<a href="#calibre_link-1660" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">627</a></p>
<p class="edition" id="calibre_link-4259">aggregators, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a>, <a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a>, <a href="#calibre_link-1673" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">45</a>&ndash;<a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-4260">AVERAGE function, <a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a>&ndash;<a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a></p>
<p class="edition" id="calibre_link-4261">AVERAGEX function, <a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a></p>
<p class="edition" id="calibre_link-4262">COUNT function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-4263">COUNTA function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-4264">COUNTBLANK function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-4265">COUNTROWS function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-4266">DISTINCTCOUNT function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-4267">DISTINCTCOUNTNOBLANK function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a></p>
<p class="edition" id="calibre_link-4268">MAX function, <a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a></p>
<p class="edition" id="calibre_link-4269">MIN function, <a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a></p>
<p class="edition" id="calibre_link-4270">SUM function, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a>&ndash;<a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a>, <a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a>&ndash;<a href="#calibre_link-1673" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">45</a></p>
<p class="edition" id="calibre_link-4271">SUMX function, <a href="#calibre_link-1673" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">45</a></p>
<p class="edition" id="calibre_link-4272">ALL function, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>&ndash;<a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a></p>
<p class="edition" id="calibre_link-4273">ALLEXCEPT function versus, <a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-4274">CALCULATE function and, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>, <a href="#calibre_link-1682" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">169</a>&ndash;<a href="#calibre_link-1683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">172</a></p>
<p class="edition" id="calibre_link-4275">calculated physical relationships and circular dependencies, <a href="#calibre_link-1684" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">478</a></p>
<p class="edition" id="calibre_link-4276">computing nonworking days between two dates, <a href="#calibre_link-1693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">523</a>&ndash;<a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a></p>
<p class="edition" id="calibre_link-4277">computing percentages, <a href="#calibre_link-1679" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">125</a>&ndash;<a href="#calibre_link-1680" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">132</a></p>
<p class="edition" id="calibre_link-4278">context transitions, <a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a>&ndash;<a href="#calibre_link-1687" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">330</a></p>
<p class="edition" id="calibre_link-4279">evaluation contexts, <a href="#calibre_link-1688" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">100</a>&ndash;<a href="#calibre_link-1689" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">101</a></p>
<p class="edition" id="calibre_link-4280">filter contexts, <a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a>&ndash;<a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>, <a href="#calibre_link-1691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">327</a>&ndash;<a href="#calibre_link-1687" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">330</a></p>
<p class="edition" id="calibre_link-4281">VALUES function and, <a href="#calibre_link-1691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">327</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-4282">ALL* functions, <a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a>&ndash;<a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a></p>
<p class="edition" id="calibre_link-4283">ALLCROSSFILTERED function, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a></p>
<p class="edition" id="calibre_link-4284">ALLEXCEPT function, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a></p>
<p class="edition" id="calibre_link-4285">ALL function versus, <a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-4286">computing percentages, <a href="#calibre_link-1698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">135</a></p>
<p class="edition" id="calibre_link-4287">filter contexts, <a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-4288">VALUES function versus, <a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-4289">ALLNOBLANKROW function, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a>, <a href="#calibre_link-1684" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">478</a></p>
<p class="edition" id="calibre_link-4290">ALLSELECTED function, <a href="#calibre_link-1702" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">455</a>&ndash;<a href="#calibre_link-1703" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">457</a>, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a></p>
<p class="edition" id="calibre_link-4291">CALCULATE function and, <a href="#calibre_link-1704" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">171</a>&ndash;<a href="#calibre_link-1683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">172</a></p>
<p class="edition" id="calibre_link-4292">returning iterated rows, <a href="#calibre_link-1705" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">460</a>&ndash;<a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a></p>
<p class="edition" id="calibre_link-4293">shadow filter contexts, <a href="#calibre_link-1706" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">459</a>&ndash;<a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a></p>
<p class="edition" id="calibre_link-4294">AVERAGE function, returning averages, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-4295">AVERAGEA function, returning averages, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-4296">AVERAGEX function</p>
<p class="edition" id="calibre_link-4297">computing averages, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a>&ndash;<a href="#calibre_link-1743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">201</a></p>
<p class="edition" id="calibre_link-4298">filter contexts, <a href="#calibre_link-1745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">111</a>&ndash;<a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4299">Boolean conditions, <a href="#calibre_link-1764" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">123</a>&ndash;<a href="#calibre_link-1765" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">124</a></p>
<p class="edition" id="calibre_link-4300">CALCULATE function, <a href="#calibre_link-1773" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">115</a></p>
<p class="edition" id="calibre_link-4301">ALL function, <a href="#calibre_link-1679" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">125</a>&ndash;<a href="#calibre_link-1680" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">132</a>, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>, <a href="#calibre_link-1682" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">169</a>&ndash;<a href="#calibre_link-1683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">172</a></p>
<p class="edition" id="calibre_link-4302">ALLSELECTED function, <a href="#calibre_link-1704" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">171</a>&ndash;<a href="#calibre_link-1683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">172</a></p>
<p class="edition" id="calibre_link-4303">Boolean conditions, <a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a>&ndash;<a href="#calibre_link-1763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">120</a></p>
<p class="edition" id="calibre_link-4304">calculated physical relationships and circular dependencies, <a href="#calibre_link-1684" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">478</a>&ndash;<a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a></p>
<p class="edition" id="calibre_link-4305">calculation items, applying to expressions, <a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a>&ndash;<a href="#calibre_link-1776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">299</a></p>
<p class="edition" id="calibre_link-4306">circular dependencies, <a href="#calibre_link-1777" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">161</a>&ndash;<a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a></p>
<p class="edition" id="calibre_link-4307">computing percentages, <a href="#calibre_link-1765" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">124</a>&ndash;<a href="#calibre_link-1698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">135</a></p>
<p class="edition" id="calibre_link-4308">context transitions, <a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a>, <a href="#calibre_link-1781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">151</a>&ndash;<a href="#calibre_link-1784" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">160</a></p>
<p class="edition" id="calibre_link-4309">CROSSFILTER function, <a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a></p>
<p class="edition" id="calibre_link-4310">evaluation contexts, <a href="#calibre_link-1786" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">79</a></p>
<p class="edition" id="calibre_link-4311">evaluation order, <a href="#calibre_link-1787" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">144</a>&ndash;<a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a></p>
<p class="edition" id="calibre_link-4312"><span type="pagebreak" id="calibre_link-4313"></span>filter arguments, <a href="#calibre_link-1788" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">118</a>&ndash;<a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a>, <a href="#calibre_link-1789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">122</a>, <a href="#calibre_link-1764" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">123</a>, <a href="#calibre_link-1790" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">445</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-4314">filter contexts, <a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a>&ndash;<a href="#calibre_link-1781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">151</a></p>
<p class="edition" id="calibre_link-4315">filtering a single column, <a href="#calibre_link-1794" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">138</a>&ndash;<a href="#calibre_link-1792" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">140</a></p>
<p class="edition" id="calibre_link-4316">filtering multiple columns, <a href="#calibre_link-1792" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">140</a>&ndash;<a href="#calibre_link-1793" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">143</a></p>
<p class="edition" id="calibre_link-4317">KEEPFILTERS function, <a href="#calibre_link-1698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">135</a>&ndash;<a href="#calibre_link-1794" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">138</a>, <a href="#calibre_link-1795" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">139</a>&ndash;<a href="#calibre_link-1793" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">143</a>, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>, <a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a>&ndash;<a href="#calibre_link-1682" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">169</a></p>
<p class="edition" id="calibre_link-4318">KEEPFILTERS function and, <a href="#calibre_link-1796" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">146</a>&ndash;<a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a></p>
<p class="edition" id="calibre_link-4319">moving averages, <a href="#calibre_link-1743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">201</a>&ndash;<a href="#calibre_link-1744" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">202</a></p>
<p class="edition" id="calibre_link-4320">numbering sequences of events (calculations), <a href="#calibre_link-1798" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">537</a>&ndash;<a href="#calibre_link-1799" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">538</a></p>
<p class="edition" id="calibre_link-4321">overwriting filters, <a href="#calibre_link-1763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">120</a>&ndash;<a href="#calibre_link-1789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">122</a></p>
<p class="edition" id="calibre_link-4322">Precedence calculation group, <a href="#calibre_link-1776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">299</a>&ndash;<a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a></p>
<p class="edition" id="calibre_link-4323">range-based relationships (calculated physical relationships), <a href="#calibre_link-1802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">474</a>&ndash;<a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-4324">RELATED function and, <a href="#calibre_link-1804" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">443</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-4325">row contexts, <a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a>&ndash;<a href="#calibre_link-1781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">151</a></p>
<p class="edition" id="calibre_link-4326">rules for, <a href="#calibre_link-1683" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">172</a>&ndash;<a href="#calibre_link-1806" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">173</a></p>
<p class="edition" id="calibre_link-4327">semantics of, <a href="#calibre_link-1789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">122</a>&ndash;<a href="#calibre_link-1764" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">123</a></p>
<p class="edition" id="calibre_link-4328">syntax of, <a href="#calibre_link-1788" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">118</a>, <a href="#calibre_link-1762" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">119</a>&ndash;<a href="#calibre_link-1763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">120</a></p>
<p class="edition" id="calibre_link-4329">table filters, <a href="#calibre_link-1790" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">445</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-4330">tables as filters, <a href="#calibre_link-1807" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">382</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a></p>
<p class="edition" id="calibre_link-4331">time intelligence calculations, <a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a>&ndash;<a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a></p>
<p class="edition" id="calibre_link-4332">transferring filters, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>&ndash;<a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-4333">UNION function and, <a href="#calibre_link-1815" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">376</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-4334">USERELATIONSHIP function, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>&ndash;<a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a></p>
<p class="edition" id="calibre_link-4335">CALCULATETABLE function, <a href="#calibre_link-1773" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">115</a>, <a href="#calibre_link-1829" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">363</a></p>
<p class="edition" id="calibre_link-4336">active relationships, <a href="#calibre_link-1644" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">451</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-4337">FILTER function versus, <a href="#calibre_link-1829" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">363</a>&ndash;<a href="#calibre_link-1830" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">365</a></p>
<p class="edition" id="calibre_link-4338">time intelligence functions, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">260</a>&ndash;<a href="#calibre_link-1833" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">261</a></p>
<p class="edition" id="calibre_link-4339">CALENDAR function, date tables, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a></p>
<p class="edition" id="calibre_link-4340">CALENDARAUTO function, date tables, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-4341">CallbackDataID function</p>
<p class="edition" id="calibre_link-4342">Analysis Services 2012/2014 and, <a href="#calibre_link-1712" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">644</a></p>
<p class="edition" id="calibre_link-4343">DAX optimization, <a href="#calibre_link-1857" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">690</a>&ndash;<a href="#calibre_link-1858" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">693</a></p>
<p class="edition" id="calibre_link-4344">parallelism and, <a href="#calibre_link-1859" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">641</a></p>
<p class="edition" id="calibre_link-4345">VertiPaq and, <a href="#calibre_link-1860" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">640</a>&ndash;<a href="#calibre_link-1712" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">644</a></p>
<p class="edition" id="calibre_link-4346">COMBINEVALUES function, multiple-column relationships (calculated physical relationships), <a href="#calibre_link-1888" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">472</a>&ndash;<a href="#calibre_link-1826" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">473</a></p>
<p class="edition" id="calibre_link-4347">CONCATENATEX function</p>
<p class="edition" id="calibre_link-4348">iterators and, <a href="#calibre_link-1895" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">194</a>&ndash;<a href="#calibre_link-1653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">196</a></p>
<p class="edition" id="calibre_link-4349">tables as scalar values, <a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a></p>
<p class="edition" id="calibre_link-4350">CONTAINS function</p>
<p class="edition" id="calibre_link-4351">tables and, <a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a>&ndash;<a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a></p>
<p class="edition" id="calibre_link-4352">transferring filters, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-4353">CONTAINSROW function, tables and, <a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a>&ndash;<a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a></p>
<p class="edition" id="calibre_link-4354">conversion functions, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-4355">COUNTROWS function</p>
<p class="edition" id="calibre_link-4356">filter contexts and relationships, <a href="#calibre_link-2014" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">107</a>&ndash;<a href="#calibre_link-2015" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">108</a></p>
<p class="edition" id="calibre_link-4357">nested row contexts on the same table, <a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a>&ndash;<a href="#calibre_link-1912" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">95</a></p>
<p class="edition" id="calibre_link-4358">tables as scalar values, <a href="#calibre_link-1913" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">73</a></p>
<p class="edition" id="calibre_link-4359">CROSSFILTER function</p>
<p class="edition" id="calibre_link-4360">bidirectional relationships, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-4361">CALCULATE function and, <a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a></p>
<p class="edition" id="calibre_link-4362">CROSSJOIN function, tables and, <a href="#calibre_link-1652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">372</a>&ndash;<a href="#calibre_link-1915" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">374</a>, <a href="#calibre_link-1916" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">383</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a></p>
<p class="edition" id="calibre_link-4363">CURRENCY function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-4364">DATATABLE function, creating static tables, <a href="#calibre_link-1935" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">392</a>&ndash;<a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a></p>
<p class="edition" id="calibre_link-4365">DATE function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a>, <a href="#calibre_link-1907" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">52</a></p>
<p class="edition" id="calibre_link-4366">DATEADD function, time intelligence calculations, <a href="#calibre_link-1943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">237</a>&ndash;<a href="#calibre_link-1944" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">238</a>, <a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>&ndash;<a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a></p>
<p class="edition" id="calibre_link-4367">DATESINPERIOD function, moving annual totals, <a href="#calibre_link-1713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">243</a>&ndash;<a href="#calibre_link-1714" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">244</a></p>
<p class="edition" id="calibre_link-4368">DATESMTD function, time intelligence calculations, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-4369">DATESQTD function, time intelligence calculations, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-4370">DATESYTD function</p>
<p class="edition" id="calibre_link-4371">calculation items, applying to expressions, <a href="#calibre_link-1839" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">293</a>&ndash;<a href="#calibre_link-1840" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">296</a></p>
<p class="edition" id="calibre_link-4372">time intelligence calculations, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">260</a>, <a href="#calibre_link-1833" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">261</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-4373">DATEVALUE function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-4374">DETAILROWS function, reusing table expressions, <a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a>&ndash;<a href="#calibre_link-1998" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">389</a></p>
<p class="edition" id="calibre_link-4375">DISTINCT function</p>
<p class="edition" id="calibre_link-4376">calculated physical relationships and circular dependencies, <a href="#calibre_link-2003" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">477</a>&ndash;<a href="#calibre_link-1684" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">478</a></p>
<p class="edition" id="calibre_link-4377">filter contexts, <a href="#calibre_link-1745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">111</a>&ndash;<a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4378">range-based relationships (calculated physical relationships), <a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-4379">UNION function and, <a href="#calibre_link-2004" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">375</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-4380">DISTINCTCOUNT function</p>
<p class="edition" id="calibre_link-4381">avoiding table filters, <a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a>&ndash;<a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a></p>
<p class="edition" id="calibre_link-4382">computing same-store sales, <a href="#calibre_link-2005" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">535</a>&ndash;<a href="#calibre_link-1848" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">536</a></p>
<p class="edition" id="calibre_link-4383">DAX optimization, <a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a>&ndash;<a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a></p>
<p class="edition" id="calibre_link-4384">DIVIDE function, DAX optimization, <a href="#calibre_link-2006" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">684</a>&ndash;<a href="#calibre_link-2007" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">687</a></p>
<p class="edition" id="calibre_link-4385">EARLIER function, evaluation contexts, <a href="#calibre_link-2008" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">97</a>&ndash;<a href="#calibre_link-2009" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">98</a></p>
<p class="edition" id="calibre_link-4386">Excel, <a href="#calibre_link-1966" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">6</a>&ndash;<a href="#calibre_link-1878" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">7</a></p>
<p class="edition" id="calibre_link-4387">EXCEPT function, tables and, <a href="#calibre_link-2026" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">379</a>&ndash;<a href="#calibre_link-1919" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">381</a></p>
<p class="edition" id="calibre_link-4388">FILTER function</p>
<p class="edition" id="calibre_link-4389">CALCULATETABLE function versus, <a href="#calibre_link-1829" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">363</a>&ndash;<a href="#calibre_link-1830" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">365</a></p>
<p class="edition" id="calibre_link-4390">evaluation contexts, <a href="#calibre_link-2009" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">98</a>&ndash;<a href="#calibre_link-1689" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">101</a></p>
<p class="edition" id="calibre_link-4391"><span type="pagebreak" id="calibre_link-4392"></span>nested row contexts on the same table, <a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a>&ndash;<a href="#calibre_link-2019" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">93</a>, <a href="#calibre_link-2020" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">94</a>&ndash;<a href="#calibre_link-1912" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">95</a></p>
<p class="edition" id="calibre_link-4393">range-based relationships (calculated physical relationships), <a href="#calibre_link-1802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">474</a>&ndash;<a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-4394">time intelligence calculations, <a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a>&ndash;<a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a></p>
<p class="edition" id="calibre_link-4395">transferring filters, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-4396">FILTERS function</p>
<p class="edition" id="calibre_link-4397">filter contexts, <a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a>&ndash;<a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a></p>
<p class="edition" id="calibre_link-4398">VALUES function versus, <a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a>&ndash;<a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a></p>
<p class="edition" id="calibre_link-4399">FIRSTDATE function, time intelligence calculations, <a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a></p>
<p class="edition" id="calibre_link-4400">FIRSTNONBLANK function, time intelligence calculations, <a href="#calibre_link-1950" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">256</a>&ndash;<a href="#calibre_link-1951" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">257</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a>&ndash;<a href="#calibre_link-1948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">271</a></p>
<p class="edition" id="calibre_link-4401">FORMAT function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-4402">IN function, tables and, <a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a>&ndash;<a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a></p>
<p class="edition" id="calibre_link-4403">GENERATE function, authoring queries, <a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a>&ndash;<a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-4404">GENERATEALL function, authoring queries, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-4405">GENERATESERIES function, tables and, <a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a>&ndash;<a href="#calibre_link-1884" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">394</a></p>
<p class="edition" id="calibre_link-4406">GROUPBY function</p>
<p class="edition" id="calibre_link-4407">authoring queries, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>&ndash;<a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a></p>
<p class="edition" id="calibre_link-4408">SUMMARIZE function and, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>&ndash;<a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a></p>
<p class="edition" id="calibre_link-4409">HASONEVALUE function</p>
<p class="edition" id="calibre_link-4410">filter contexts, <a href="#calibre_link-2041" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">314</a>&ndash;<a href="#calibre_link-2042" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">318</a></p>
<p class="edition" id="calibre_link-4411">tables as scalar values, <a href="#calibre_link-1913" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">73</a></p>
<p class="edition" id="calibre_link-4412">information functions, <a href="#calibre_link-2050" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">48</a>&ndash;<a href="#calibre_link-2051" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">49</a></p>
<p class="edition" id="calibre_link-4413">INT function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-4414">INTERSECT function</p>
<p class="edition" id="calibre_link-4415">tables and, <a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a>&ndash;<a href="#calibre_link-2026" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">379</a></p>
<p class="edition" id="calibre_link-4416">transferring filters, <a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>&ndash;<a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-4417">ISCROSSFILTERED function, filter contexts, <a href="#calibre_link-2043" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">319</a>&ndash;<a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a></p>
<p class="edition" id="calibre_link-4418">ISEMPTY function, filter contexts, <a href="#calibre_link-1687" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">330</a>&ndash;<a href="#calibre_link-1922" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">332</a></p>
<p class="edition" id="calibre_link-4419">ISFILTERED function</p>
<p class="edition" id="calibre_link-4420">filter contexts, <a href="#calibre_link-2043" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">319</a>, <a href="#calibre_link-2044" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">320</a>&ndash;<a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a></p>
<p class="edition" id="calibre_link-4421">time intelligence calculations, <a href="#calibre_link-2052" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">268</a>&ndash;<a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a></p>
<p class="edition" id="calibre_link-4422">ISNUMBER function, <a href="#calibre_link-2050" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">48</a>&ndash;<a href="#calibre_link-2051" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">49</a></p>
<p class="edition" id="calibre_link-4423">ISONORAFTER function</p>
<p class="edition" id="calibre_link-4424">authoring queries, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a>&ndash;<a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a></p>
<p class="edition" id="calibre_link-4425">TOPN function and, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a>&ndash;<a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a></p>
<p class="edition" id="calibre_link-4426">ISSELECTEDMEASURE function, including/excluding measures from calculation items, <a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a>&ndash;<a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a></p>
<p class="edition" id="calibre_link-4427">ISSUBTOTAL function and SUMMARIZE function, <a href="#calibre_link-2053" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">402</a>&ndash;<a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a></p>
<p class="edition" id="calibre_link-4428">KEEPFILTERS function, <a href="#calibre_link-2049" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">461</a>&ndash;<a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a></p>
<p class="edition" id="calibre_link-4429">CALCULATE function and, <a href="#calibre_link-1698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">135</a>&ndash;<a href="#calibre_link-1794" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">138</a>, <a href="#calibre_link-1797" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">142</a>&ndash;<a href="#calibre_link-1793" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">143</a>, <a href="#calibre_link-1796" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">146</a>&ndash;<a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a>, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>, <a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a>&ndash;<a href="#calibre_link-1682" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">169</a></p>
<p class="edition" id="calibre_link-4430">evaluation order, <a href="#calibre_link-1796" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">146</a>&ndash;<a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a></p>
<p class="edition" id="calibre_link-4431">transferring filters, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>&ndash;<a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-4432">LASTDATE function, time intelligence calculations, <a href="#calibre_link-1952" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">248</a>&ndash;<a href="#calibre_link-1953" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">249</a>, <a href="#calibre_link-1954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">254</a>, <a href="#calibre_link-1955" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">255</a>, <a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a>&ndash;<a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a></p>
<p class="edition" id="calibre_link-4433">LASTNONBLANK function, <a href="#calibre_link-1956" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">250</a>&ndash;<a href="#calibre_link-1954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">254</a>, <a href="#calibre_link-1955" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">255</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a>&ndash;<a href="#calibre_link-1948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">271</a></p>
<p class="edition" id="calibre_link-4434">logical functions</p>
<p class="edition" id="calibre_link-4435">IF function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a>&ndash;<a href="#calibre_link-2054" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">47</a></p>
<p class="edition" id="calibre_link-4436">IFERROR function, <a href="#calibre_link-2054" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">47</a></p>
<p class="edition" id="calibre_link-4437">SWITCH function, <a href="#calibre_link-2054" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">47</a>&ndash;<a href="#calibre_link-2050" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">48</a></p>
<p class="edition" id="calibre_link-4438">LOOKUPVALUE function, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>, <a href="#calibre_link-1826" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">473</a></p>
<p class="edition" id="calibre_link-4439">mathematical functions, <a href="#calibre_link-2051" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">49</a></p>
<p class="edition" id="calibre_link-4440">NATURALINNERJOIN function, authoring queries, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-4441">NATURALLEFTOUTERJOIN function, authoring queries, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-4442">nested functions, call order of time intelligence functions, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-4443">NEXTDAY function, call order of nested time intelligence functions, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-4444">PARALLELPERIOD function, time intelligence calculations, <a href="#calibre_link-1944" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">238</a>&ndash;<a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a></p>
<p class="edition" id="calibre_link-4445">PREVIOUSMONTH function, time intelligence calculations, <a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a></p>
<p class="edition" id="calibre_link-4446">RANK.EQ function, <a href="#calibre_link-2055" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">210</a></p>
<p class="edition" id="calibre_link-4447">RANKX function, numbering sequences of events (calculations), <a href="#calibre_link-1799" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">538</a>&ndash;<a href="#calibre_link-1846" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">539</a></p>
<p class="edition" id="calibre_link-4448">RELATED function</p>
<p class="edition" id="calibre_link-4449">CALCULATE function and, <a href="#calibre_link-1804" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">443</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-4450">calculated columns, <a href="#calibre_link-1804" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">443</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-4451">context transitions in expanded tables, <a href="#calibre_link-1702" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">455</a></p>
<p class="edition" id="calibre_link-4452">expanded tables, <a href="#calibre_link-2027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">441</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-4453">filter contexts and relationships, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-4454">nested row contexts on different tables, <a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a></p>
<p class="edition" id="calibre_link-4455">row contexts and relationships, <a href="#calibre_link-2023" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">103</a>&ndash;<a href="#calibre_link-2022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">105</a></p>
<p class="edition" id="calibre_link-4456">table filters and expanded tables, <a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a></p>
<p class="edition" id="calibre_link-4457">RELATEDTABLE function</p>
<p class="edition" id="calibre_link-4458">filter contexts and relationships, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-4459">nested row contexts on different tables, <a href="#calibre_link-2024" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">91</a>&ndash;<a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a></p>
<p class="edition" id="calibre_link-4460">row contexts and relationships, <a href="#calibre_link-2023" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">103</a>&ndash;<a href="#calibre_link-2022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">105</a></p>
<p class="edition" id="calibre_link-4461">relational functions, <a href="#calibre_link-2056" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">53</a>&ndash;<a href="#calibre_link-2057" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">54</a></p>
<p class="edition" id="calibre_link-4462">ROLLUP function, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a>&ndash;<a href="#calibre_link-2053" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">402</a>, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a></p>
<p class="edition" id="calibre_link-4463">ROW function</p>
<p class="edition" id="calibre_link-4464">creating static tables, <a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a>&ndash;<a href="#calibre_link-1935" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">392</a></p>
<p class="edition" id="calibre_link-4465">testing measures, <a href="#calibre_link-1735" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">400</a>&ndash;<a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-4466">SAMEPERIODLASTYEAR function</p>
<p class="edition" id="calibre_link-4467">call order of nested time intelligence functions, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-4468">computing previous year sales up to last day sales (calculations), <a href="#calibre_link-2058" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">540</a>&ndash;<a href="#calibre_link-1847" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">544</a></p>
<p class="edition" id="calibre_link-4469">time intelligence calculations, <a href="#calibre_link-1943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">237</a></p>
<p class="edition" id="calibre_link-4470"><span type="pagebreak" id="calibre_link-4471"></span>SAMPLE function, authoring queries, <a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a>&ndash;<a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a></p>
<p class="edition" id="calibre_link-4472">SELECTCOLUMNS function, <a href="#calibre_link-1827" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">390</a>&ndash;<a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a>, <a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a>&ndash;<a href="#calibre_link-1884" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">394</a></p>
<p class="edition" id="calibre_link-4473">SELECTEDMEASURE function, including/excluding measures from calculation items, <a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a>&ndash;<a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a></p>
<p class="edition" id="calibre_link-4474">SELECTEDMEASUREFORMATSTRING function, <a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a></p>
<p class="edition" id="calibre_link-4475">SELECTEDVALUE function</p>
<p class="edition" id="calibre_link-4476">calculated physical relationships and circular dependencies, <a href="#calibre_link-2059" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">479</a>&ndash;<a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a></p>
<p class="edition" id="calibre_link-4477">computing same-store sales, <a href="#calibre_link-2060" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">533</a>&ndash;<a href="#calibre_link-2061" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">534</a></p>
<p class="edition" id="calibre_link-4478">context transitions in expanded tables, <a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a>&ndash;<a href="#calibre_link-1702" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">455</a></p>
<p class="edition" id="calibre_link-4479">filter contexts, <a href="#calibre_link-2042" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">318</a>&ndash;<a href="#calibre_link-2043" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">319</a></p>
<p class="edition" id="calibre_link-4480">tables as scalar values, <a href="#calibre_link-1913" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">73</a>&ndash;<a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a></p>
<p class="edition" id="calibre_link-4481">STARTOFQUARTER function, time intelligence calculations, <a href="#calibre_link-1950" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">256</a>&ndash;<a href="#calibre_link-1951" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">257</a></p>
<p class="edition" id="calibre_link-4482">SUBSTITUTEWITHINDEX function, authoring queries, <a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a>&ndash;<a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a></p>
<p class="edition" id="calibre_link-4483">SUM function in calculated columns, <a href="#calibre_link-1822" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">88</a>&ndash;<a href="#calibre_link-1823" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">89</a></p>
<p class="edition" id="calibre_link-4484">SUMMARIZE function</p>
<p class="edition" id="calibre_link-4485">authoring queries, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a>&ndash;<a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>, <a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-4486">auto-exists feature (queries), <a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-4487">columns (tables) and, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-4488">filter contexts, <a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-4489">GROUPBY function and, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>&ndash;<a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a></p>
<p class="edition" id="calibre_link-4490">ISSUBTOTAL function and, <a href="#calibre_link-2053" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">402</a>&ndash;<a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a></p>
<p class="edition" id="calibre_link-4491">ROLLUP function and, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a>&ndash;<a href="#calibre_link-2053" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">402</a>, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a></p>
<p class="edition" id="calibre_link-4492">table filters and expanded tables, <a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a>&ndash;<a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a></p>
<p class="edition" id="calibre_link-4493">tables and, <a href="#calibre_link-1650" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">369</a>&ndash;<a href="#calibre_link-1652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">372</a>, <a href="#calibre_link-2062" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">373</a>&ndash;<a href="#calibre_link-1915" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">374</a>, <a href="#calibre_link-1916" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">383</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a></p>
<p class="edition" id="calibre_link-4494">transferring filters, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-4495">SUMMARIZECOLUMNS function</p>
<p class="edition" id="calibre_link-4496">authoring queries, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>, <a href="#calibre_link-1740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">429</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-4497">auto-exists feature (queries), <a href="#calibre_link-1740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">429</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-4498">filter arguments, <a href="#calibre_link-2037" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">406</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a></p>
<p class="edition" id="calibre_link-4499">IGNORE modifier, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-2063" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">404</a></p>
<p class="edition" id="calibre_link-4500">ROLLUPADDISSUBTOTAL modifier, <a href="#calibre_link-2063" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">404</a>&ndash;<a href="#calibre_link-2037" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">406</a></p>
<p class="edition" id="calibre_link-4501">ROLLUPGROUP modifier, <a href="#calibre_link-2037" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">406</a></p>
<p class="edition" id="calibre_link-4502">TREATAS function and, <a href="#calibre_link-2064" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">407</a>&ndash;<a href="#calibre_link-2065" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">408</a></p>
<p class="edition" id="calibre_link-4503">table functions, <a href="#calibre_link-2030" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">57</a></p>
<p class="edition" id="calibre_link-4504">ALL function, <a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a>&ndash;<a href="#calibre_link-1686" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">65</a>, <a href="#calibre_link-1695" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">66</a>&ndash;<a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a></p>
<p class="edition" id="calibre_link-4505">ALLEXCEPT function, <a href="#calibre_link-1686" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">65</a>&ndash;<a href="#calibre_link-1695" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">66</a></p>
<p class="edition" id="calibre_link-4506">ALLSELECTED function, <a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a>&ndash;<a href="#calibre_link-1701" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">76</a></p>
<p class="edition" id="calibre_link-4507">calculated columns and, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-4508">calculated tables, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-4509">DISTINCT function, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a>, <a href="#calibre_link-2002" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">70</a>&ndash;<a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-4510">FILTER function, <a href="#calibre_link-2030" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">57</a>&ndash;<a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a>, <a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a>&ndash;<a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a></p>
<p class="edition" id="calibre_link-4511">measures and, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-4512">nesting, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a>&ndash;<a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-4513">RELATEDTABLE function, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a>&ndash;<a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-4514">VALUES function, <a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a>&ndash;<a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a></p>
<p class="edition" id="calibre_link-4515">text functions, <a href="#calibre_link-2066" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">50</a>&ndash;<a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-4516">TIME function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a>, <a href="#calibre_link-1907" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">52</a></p>
<p class="edition" id="calibre_link-4517">time intelligence functions (nested), call order of, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-4518">TOPN function</p>
<p class="edition" id="calibre_link-4519">authoring queries, <a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>&ndash;<a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a></p>
<p class="edition" id="calibre_link-4520">ISONORAFTER function and, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a>&ndash;<a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a></p>
<p class="edition" id="calibre_link-4521">sort order, <a href="#calibre_link-2067" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">410</a></p>
<p class="edition" id="calibre_link-4522">TOPNSKIP function, authoring queries, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a></p>
<p class="edition" id="calibre_link-4523">TREATAS function, <a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-4524">data lineage, <a href="#calibre_link-2068" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">467</a>&ndash;<a href="#calibre_link-1923" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">468</a></p>
<p class="edition" id="calibre_link-4525">filter contexts and data lineage, <a href="#calibre_link-2046" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">334</a>&ndash;<a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-4526">SUMMARIZECOLUMNS function and, <a href="#calibre_link-2064" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">407</a>&ndash;<a href="#calibre_link-2065" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">408</a></p>
<p class="edition" id="calibre_link-4527">transferring filters, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>&ndash;<a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-4528">UNION function and, <a href="#calibre_link-2069" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">377</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-4529">trigonometric functions, <a href="#calibre_link-2066" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">50</a></p>
<p class="edition" id="calibre_link-4530">UNION function</p>
<p class="edition" id="calibre_link-4531">CALCULATE function and, <a href="#calibre_link-1815" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">376</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-4532">DISTINCT function and, <a href="#calibre_link-2004" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">375</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-4533">tables and, <a href="#calibre_link-1915" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">374</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-4534">TREATAS function and, <a href="#calibre_link-2069" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">377</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-4535">USERELATIONSHIP function</p>
<p class="edition" id="calibre_link-4536">active relationships, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1644" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">451</a></p>
<p class="edition" id="calibre_link-4537">CALCULATE function and, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>&ndash;<a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a></p>
<p class="edition" id="calibre_link-4538">non-active relationships and ambiguity, <a href="#calibre_link-2070" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">516</a>&ndash;<a href="#calibre_link-1711" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">517</a></p>
<p class="edition" id="calibre_link-4539">VALUE function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-4540">VALUES function</p>
<p class="edition" id="calibre_link-4541">ALL function and, <a href="#calibre_link-1691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">327</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-4542">ALLEXCEPT function versus, <a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-4543">calculated physical relationships and circular dependencies, <a href="#calibre_link-2003" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">477</a>&ndash;<a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a></p>
<p class="edition" id="calibre_link-4544">computing percentages, <a href="#calibre_link-1778" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">133</a>&ndash;<a href="#calibre_link-1779" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">134</a></p>
<p class="edition" id="calibre_link-4545">filter contexts, <a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a>&ndash;<a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a>, <a href="#calibre_link-1691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">327</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-4546">FILTERS function versus, <a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a>&ndash;<a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a></p>
<p class="edition" id="calibre_link-4547">range-based relationships (calculated physical relationships), <a href="#calibre_link-1802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">474</a>&ndash;<a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4548" class="h2a">G</h3>
<p class="edition" id="calibre_link-4549">GENERATE function, authoring queries, <a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a>&ndash;<a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-4550">GENERATEALL function, authoring queries, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-4551">GENERATESERIES function, tables and, <a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a>&ndash;<a href="#calibre_link-1884" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">394</a></p>
<p class="edition" id="calibre_link-4552">generating errors (error-handling), <a href="#calibre_link-2010" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">38</a>&ndash;<a href="#calibre_link-2011" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">39</a></p>
<p class="edition" id="calibre_link-4553">granularity</p>
<p class="edition" id="calibre_link-4554">calculations and iterators, <a href="#calibre_link-1834" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">211</a>&ndash;<a href="#calibre_link-1835" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">214</a></p>
<p class="edition" id="calibre_link-4555">relationships (data models), <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a>&ndash;<a href="#calibre_link-1709" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">512</a></p>
<p class="edition" id="calibre_link-4556"><span type="pagebreak" id="calibre_link-4557"></span>GROUPBY function</p>
<p class="edition" id="calibre_link-4558">authoring queries, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>&ndash;<a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a></p>
<p class="edition" id="calibre_link-4559">SUMMARIZE function and, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>&ndash;<a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4560" class="h2a">H</h3>
<p class="edition" id="calibre_link-1999">hash encoding (VertiPaq compression), <a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a>&ndash;<a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a></p>
<p class="edition" id="calibre_link-4561">HASONEVALUE function</p>
<p class="edition" id="calibre_link-4562">filter contexts, <a href="#calibre_link-2041" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">314</a>&ndash;<a href="#calibre_link-2042" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">318</a></p>
<p class="edition" id="calibre_link-4563">tables as scalar values, <a href="#calibre_link-1913" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">73</a></p>
<p class="edition" id="calibre_link-4564">help, formatting DAX code, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-4565">hierarchies, <a href="#calibre_link-2071" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">345</a>, <a href="#calibre_link-2072" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">362</a></p>
<p class="edition" id="calibre_link-4566">attribute hierarchies (data model optimization), disabling, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a></p>
<p class="edition" id="calibre_link-4567">Columns Hierarchies Size column (VertiPaq Analyzer), <a href="#calibre_link-1887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">582</a></p>
<p class="edition" id="calibre_link-4568">DAX, <a href="#calibre_link-1968" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">13</a>&ndash;<a href="#calibre_link-1969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">14</a></p>
<p class="edition" id="calibre_link-4569">MDX, <a href="#calibre_link-1968" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">13</a>&ndash;<a href="#calibre_link-1969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">14</a></p>
<p class="edition" id="calibre_link-4570">P/C (Parent/Child) hierarchies, <a href="#calibre_link-2073" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">350</a>&ndash;<a href="#calibre_link-2074" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">361</a>, <a href="#calibre_link-2072" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">362</a></p>
<p class="edition" id="calibre_link-4571">percentages, computing, <a href="#calibre_link-2071" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">345</a></p>
<p class="edition" id="calibre_link-4572">IF conditions, <a href="#calibre_link-2075" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">349</a></p>
<p class="edition" id="calibre_link-4573">PercOnCategory measures, <a href="#calibre_link-2076" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">348</a></p>
<p class="edition" id="calibre_link-4574">PercOnParent measures, <a href="#calibre_link-2077" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">346</a>&ndash;<a href="#calibre_link-2075" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">349</a></p>
<p class="edition" id="calibre_link-4575">ratio to parent calculations, <a href="#calibre_link-2071" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">345</a></p>
<p class="edition" id="calibre_link-4576">SSAS and, <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a></p>
<p class="edition" id="calibre_link-4577">Use Hierarchies Size column (VertiPaq Analyzer), <a href="#calibre_link-1887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">582</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4578" class="h2a">I</h3>
<p class="edition" id="calibre_link-4579">IF conditions</p>
<p class="edition" id="calibre_link-4580">computing percentages over hierarchies, <a href="#calibre_link-2075" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">349</a></p>
<p class="edition" id="calibre_link-4581">DAX optimization, <a href="#calibre_link-1904" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">678</a>&ndash;<a href="#calibre_link-2078" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">679</a></p>
<p class="edition" id="calibre_link-4582">DIVIDE function and, <a href="#calibre_link-2006" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">684</a>&ndash;<a href="#calibre_link-2007" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">687</a></p>
<p class="edition" id="calibre_link-4583">iterators, <a href="#calibre_link-2007" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">687</a>&ndash;<a href="#calibre_link-1857" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">690</a></p>
<p class="edition" id="calibre_link-4584">in measures, <a href="#calibre_link-2078" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">679</a>&ndash;<a href="#calibre_link-2079" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">683</a></p>
<p class="edition" id="calibre_link-4585">IF function, <a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a>, <a href="#calibre_link-2012" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">37</a>, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a>&ndash;<a href="#calibre_link-2054" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">47</a></p>
<p class="edition" id="calibre_link-4586">IFERROR function, <a href="#calibre_link-1722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">35</a>&ndash;<a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a>, <a href="#calibre_link-2012" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">37</a>&ndash;<a href="#calibre_link-2010" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">38</a>, <a href="#calibre_link-2054" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">47</a></p>
<p class="edition" id="calibre_link-4587">IGNORE modifier, SUMMARIZECOLUMNS function, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-2063" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">404</a></p>
<p class="edition" id="calibre_link-4588">information functions, <a href="#calibre_link-2050" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">48</a>&ndash;<a href="#calibre_link-2051" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">49</a></p>
<p class="edition" id="calibre_link-4589">INT function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-4590">Integer data type, <a href="#calibre_link-1917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">21</a></p>
<p class="edition" id="calibre_link-4591">INTERSECT function</p>
<p class="edition" id="calibre_link-4592">tables and, <a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a>&ndash;<a href="#calibre_link-2026" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">379</a></p>
<p class="edition" id="calibre_link-4593">transferring filters, <a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>&ndash;<a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-4594">intra-island relationships, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a></p>
<p class="edition" id="calibre_link-4595">invalid relationships, blank rows and, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a>&ndash;<a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-4596">ISBLANK function, <a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a></p>
<p class="edition" id="calibre_link-4597">ISCROSSFILTERED function, filter contexts, <a href="#calibre_link-2043" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">319</a>&ndash;<a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a></p>
<p class="edition" id="calibre_link-4598">ISEMPTY function, filter contexts, <a href="#calibre_link-1687" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">330</a>&ndash;<a href="#calibre_link-1922" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">332</a></p>
<p class="edition" id="calibre_link-4599">ISERROR function, <a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a>, <a href="#calibre_link-2010" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">38</a></p>
<p class="edition" id="calibre_link-4600">ISFILTERED function</p>
<p class="edition" id="calibre_link-4601">filter contexts, <a href="#calibre_link-2043" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">319</a>, <a href="#calibre_link-2044" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">320</a>&ndash;<a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a></p>
<p class="edition" id="calibre_link-4602">time intelligence calculations, <a href="#calibre_link-2052" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">268</a>&ndash;<a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a></p>
<p class="edition" id="calibre_link-4603">ISNUMBER function, <a href="#calibre_link-2050" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">48</a>&ndash;<a href="#calibre_link-2051" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">49</a></p>
<p class="edition" id="calibre_link-4604">ISONORAFTER function</p>
<p class="edition" id="calibre_link-4605">authoring queries, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a>&ndash;<a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a></p>
<p class="edition" id="calibre_link-4606">TOPN function and, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a>&ndash;<a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a></p>
<p class="edition" id="calibre_link-4607">ISSELECTEDMEASURE function, including/excluding measures from calculation items, <a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a>&ndash;<a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a></p>
<p class="edition" id="calibre_link-4608">ISSUBTOTAL function, <a href="#calibre_link-2053" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">402</a>&ndash;<a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a></p>
<p class="edition" id="calibre_link-4609">iterators, <a href="#calibre_link-1962" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">8</a>, <a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a>, <a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a>, <a href="#calibre_link-2080" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">209</a>&ndash;<a href="#calibre_link-2081" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">215</a></p>
<p class="edition" id="calibre_link-4610">ADDCOLUMNS iterators, <a href="#calibre_link-1653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">196</a>&ndash;<a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-4611">averages (means)</p>
<p class="edition" id="calibre_link-4612">computing with AVERAGEX function, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a>&ndash;<a href="#calibre_link-1743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">201</a></p>
<p class="edition" id="calibre_link-4613">moving averages, <a href="#calibre_link-1743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">201</a>&ndash;<a href="#calibre_link-1744" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">202</a></p>
<p class="edition" id="calibre_link-4614">returning with AVERAGE function, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-4615">returning with AVERAGEA function, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-4616">AVERAGEX iterators, <a href="#calibre_link-1747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">188</a></p>
<p class="edition" id="calibre_link-4617">behavior of, <a href="#calibre_link-2024" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">91</a></p>
<p class="edition" id="calibre_link-4618">calculation granularity, <a href="#calibre_link-1834" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">211</a>&ndash;<a href="#calibre_link-1835" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">214</a></p>
<p class="edition" id="calibre_link-4619">cardinality, <a href="#calibre_link-1747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">188</a>&ndash;<a href="#calibre_link-1866" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">190</a></p>
<p class="edition" id="calibre_link-4620">CONCATENATEX function and, <a href="#calibre_link-1895" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">194</a>&ndash;<a href="#calibre_link-1653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">196</a></p>
<p class="edition" id="calibre_link-4621">context transitions, leveraging, <a href="#calibre_link-1866" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">190</a>&ndash;<a href="#calibre_link-1895" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">194</a></p>
<p class="edition" id="calibre_link-4622">DAX optimization</p>
<p class="edition" id="calibre_link-4623">IF conditions, <a href="#calibre_link-2007" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">687</a>&ndash;<a href="#calibre_link-1857" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">690</a></p>
<p class="edition" id="calibre_link-4624">nested iterators, <a href="#calibre_link-1858" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">693</a>&ndash;<a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a></p>
<p class="edition" id="calibre_link-4625">FILTER function as, <a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a>&ndash;<a href="#calibre_link-2047" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">61</a></p>
<p class="edition" id="calibre_link-4626">nested iterators</p>
<p class="edition" id="calibre_link-4627">DAX optimization, <a href="#calibre_link-1858" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">693</a>&ndash;<a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a></p>
<p class="edition" id="calibre_link-4628">leveraging context transitions, <a href="#calibre_link-1866" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">190</a>&ndash;<a href="#calibre_link-1895" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">194</a></p>
<p class="edition" id="calibre_link-4629">parameters of, <a href="#calibre_link-2082" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">187</a>&ndash;<a href="#calibre_link-1747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">188</a></p>
<p class="edition" id="calibre_link-4630">RANK.EQ function, <a href="#calibre_link-2055" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">210</a></p>
<p class="edition" id="calibre_link-4631">RANKX iterators, <a href="#calibre_link-1747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">188</a>, <a href="#calibre_link-1744" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">202</a>&ndash;<a href="#calibre_link-2055" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">210</a></p>
<p class="edition" id="calibre_link-4632">ROW CONTEXT iterators, <a href="#calibre_link-2082" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">187</a>&ndash;<a href="#calibre_link-1747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">188</a></p>
<p class="edition" id="calibre_link-4633">row contexts and, <a href="#calibre_link-1881" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">90</a>&ndash;<a href="#calibre_link-2024" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">91</a></p>
<p class="edition" id="calibre_link-4634">SELECTCOLUMNS iterators, <a href="#calibre_link-1653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">196</a>, <a href="#calibre_link-1885" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">197</a>&ndash;<a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-4635">SUMX iterators, <a href="#calibre_link-2082" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">187</a>&ndash;<a href="#calibre_link-1747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">188</a></p>
<p class="edition" id="calibre_link-4636">tables, returning, <a href="#calibre_link-1653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">196</a>&ndash;<a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4637" class="h2a">J</h3>
<p class="edition" id="calibre_link-4638">join operators, xmSQL queries, <a href="#calibre_link-2048" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">628</a>&ndash;<a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4639" class="h2a"><span type="pagebreak" id="calibre_link-4640"></span>K</h3>
<p class="edition" id="calibre_link-4641">KEEPFILTERS function, <a href="#calibre_link-2049" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">461</a>&ndash;<a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a></p>
<p class="edition" id="calibre_link-4642">CALCULATE function and, <a href="#calibre_link-1698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">135</a>&ndash;<a href="#calibre_link-1794" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">138</a>, <a href="#calibre_link-1795" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">139</a>&ndash;<a href="#calibre_link-1793" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">143</a>, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>, <a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a>&ndash;<a href="#calibre_link-1682" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">169</a></p>
<p class="edition" id="calibre_link-4643">evaluation order, <a href="#calibre_link-1796" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">146</a>&ndash;<a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a></p>
<p class="edition" id="calibre_link-4644">filtering multiple columns, <a href="#calibre_link-1797" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">142</a>&ndash;<a href="#calibre_link-1793" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">143</a></p>
<p class="edition" id="calibre_link-4645">transferring filters, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>&ndash;<a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4646" class="h2a">L</h3>
<p class="edition" id="calibre_link-4647">last day sales (calculations), computing previous year sales up to, <a href="#calibre_link-1846" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">539</a>&ndash;<a href="#calibre_link-1847" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">544</a></p>
<p class="edition" id="calibre_link-4648">LASTDATE function, time intelligence calculations, <a href="#calibre_link-1952" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">248</a>&ndash;<a href="#calibre_link-1953" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">249</a>, <a href="#calibre_link-1954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">254</a>, <a href="#calibre_link-1955" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">255</a>, <a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a>&ndash;<a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a></p>
<p class="edition" id="calibre_link-4649">LASTNONBLANK function, time intelligence calculations, <a href="#calibre_link-1956" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">250</a>&ndash;<a href="#calibre_link-1954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">254</a>, <a href="#calibre_link-1955" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">255</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a>&ndash;<a href="#calibre_link-1948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">271</a></p>
<p class="edition" id="calibre_link-4650">lazy evaluations, variables, <a href="#calibre_link-2083" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">181</a>&ndash;<a href="#calibre_link-1873" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">183</a></p>
<p class="edition" id="calibre_link-4651">leaf-level calculations</p>
<p class="edition" id="calibre_link-4652">DAX, <a href="#calibre_link-1969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">14</a></p>
<p class="edition" id="calibre_link-4653">MDX, <a href="#calibre_link-1969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">14</a></p>
<p class="edition" id="calibre_link-4654">leap year bug, <a href="#calibre_link-1766" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">22</a></p>
<p class="edition" id="calibre_link-4655">list of values. <em class="calibre5">See</em> <a href="#calibre_link-2084" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">filter arguments</a></p>
<p class="edition" id="calibre_link-4656">logical functions</p>
<p class="edition" id="calibre_link-4657">IF function, <a href="#calibre_link-1674" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">46</a>&ndash;<a href="#calibre_link-2054" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">47</a></p>
<p class="edition" id="calibre_link-4658">IFERROR function, <a href="#calibre_link-2054" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">47</a></p>
<p class="edition" id="calibre_link-4659">SWITCH function, <a href="#calibre_link-2054" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">47</a>&ndash;<a href="#calibre_link-2050" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">48</a></p>
<p class="edition" id="calibre_link-4660">logical operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-4661">logical query plans, <a href="#calibre_link-1979" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">612</a>, <a href="#calibre_link-1980" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">614</a>, <a href="#calibre_link-2085" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">650</a>&ndash;<a href="#calibre_link-2086" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">651</a></p>
<p class="edition" id="calibre_link-4662">LOOKUPVALUE function, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>, <a href="#calibre_link-1826" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">473</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4663" class="h2a">M</h3>
<p class="edition" id="calibre_link-4664">maintenance (code), FILTER function, <a href="#calibre_link-1875" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">62</a>&ndash;<a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a></p>
<p class="edition" id="calibre_link-4665">many-sided relationships (data models), <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a>, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-2087">many-to-many relationships. <em class="calibre5">See</em> <a href="#calibre_link-2087" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">MMR</a></p>
<p class="edition" id="calibre_link-4666">Mark as Date Table, <a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a>&ndash;<a href="#calibre_link-1939" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">233</a></p>
<p class="edition" id="calibre_link-4667">materialization (queries), <a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a>&ndash;<a href="#calibre_link-1662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">571</a></p>
<p class="edition" id="calibre_link-4668">mathematical functions, <a href="#calibre_link-2051" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">49</a></p>
<p class="edition" id="calibre_link-4669">MAX function, <a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a></p>
<p class="edition" id="calibre_link-4670">MDX (Multidimensional Expressions)</p>
<p class="edition" id="calibre_link-4671">DAX and, <a href="#calibre_link-1967" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">12</a></p>
<p class="edition" id="calibre_link-4672">hierarchies, <a href="#calibre_link-1968" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">13</a>&ndash;<a href="#calibre_link-1969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">14</a></p>
<p class="edition" id="calibre_link-4673">leaf-level calculations, <a href="#calibre_link-1969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">14</a></p>
<p class="edition" id="calibre_link-4674">multidimensional versus tabular space, <a href="#calibre_link-1967" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">12</a></p>
<p class="edition" id="calibre_link-4675">as programming language, <a href="#calibre_link-1967" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">12</a>&ndash;<a href="#calibre_link-1968" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">13</a></p>
<p class="edition" id="calibre_link-4676">as querying language, <a href="#calibre_link-1967" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">12</a>&ndash;<a href="#calibre_link-1968" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">13</a></p>
<p class="edition" id="calibre_link-4677">queries, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-4678">attribute hierarchies (data model optimization), disabling, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a></p>
<p class="edition" id="calibre_link-4679">DAX and, <a href="#calibre_link-1970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">613</a></p>
<p class="edition" id="calibre_link-4680">executing, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-4681">reproduction queries, creating, <a href="#calibre_link-1995" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">663</a>&ndash;<a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a></p>
<p class="edition" id="calibre_link-4682">means (averages)</p>
<p class="edition" id="calibre_link-4683">computing averages, AVERAGEX function, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a>&ndash;<a href="#calibre_link-1743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">201</a></p>
<p class="edition" id="calibre_link-4684">moving averages, <a href="#calibre_link-1743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">201</a>&ndash;<a href="#calibre_link-1744" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">202</a></p>
<p class="edition" id="calibre_link-4685">returning averages</p>
<p class="edition" id="calibre_link-4686">AVERAGE function, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-4687">AVERAGEA function, <a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-4688">MEASURE keyword, DEFINE sections (authoring queries), <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-4689">measures, <a href="#calibre_link-1818" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">26</a>&ndash;<a href="#calibre_link-2088" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">28</a></p>
<p class="edition" id="calibre_link-4690">ALL function and, <a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a>&ndash;<a href="#calibre_link-1685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">64</a></p>
<p class="edition" id="calibre_link-4691">calculated columns, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-4692">choosing between calculated columns and measures, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a>&ndash;<a href="#calibre_link-1821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">30</a></p>
<p class="edition" id="calibre_link-4693">differences between calculated columns and measures, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a></p>
<p class="edition" id="calibre_link-4694">using measures in calculated columns, <a href="#calibre_link-1821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">30</a></p>
<p class="edition" id="calibre_link-4695">calculation items, including/excluding measures from, <a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a>&ndash;<a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a></p>
<p class="edition" id="calibre_link-4696">columns in, evaluation contexts, <a href="#calibre_link-1823" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">89</a>&ndash;<a href="#calibre_link-1881" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">90</a></p>
<p class="edition" id="calibre_link-4697">context transitions, <a href="#calibre_link-1783" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">157</a>&ndash;<a href="#calibre_link-1784" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">160</a></p>
<p class="edition" id="calibre_link-4698">DEFINE MEASURE clauses in EVALUATE statements, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-4699">defining in tables, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a></p>
<p class="edition" id="calibre_link-4700">expressions, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a></p>
<p class="edition" id="calibre_link-4701">IF conditions, DAX optimization, <a href="#calibre_link-2078" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">679</a>&ndash;<a href="#calibre_link-2079" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">683</a></p>
<p class="edition" id="calibre_link-4702">ISSELECTEDMEASURE function, including/excluding measures from calculation items, <a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a>&ndash;<a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a></p>
<p class="edition" id="calibre_link-4703">PercOnCategory measures, computing percentages over hierarchies, <a href="#calibre_link-2076" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">348</a></p>
<p class="edition" id="calibre_link-4704">PercOnParent measures, computing percentages over hierarchies, <a href="#calibre_link-2077" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">346</a>&ndash;<a href="#calibre_link-2075" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">349</a></p>
<p class="edition" id="calibre_link-4705">query measures, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a>, <a href="#calibre_link-1976" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">662</a>&ndash;<a href="#calibre_link-1995" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">663</a></p>
<p class="edition" id="calibre_link-4706">SELECTEDMEASURE function, including/excluding measures from calculation items, <a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a>&ndash;<a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a></p>
<p class="edition" id="calibre_link-4707">table filters in, <a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a>&ndash;<a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a></p>
<p class="edition" id="calibre_link-4708">table functions, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-4709">testing, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a>&ndash;<a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-4710">VALUES function and, <a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a>&ndash;<a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-4711">memory size, VertiPaq hardware selection, <a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a>, <a href="#calibre_link-1910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">576</a></p>
<p class="edition" id="calibre_link-4712">memory speed, VertiPaq hardware selection, <a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a>, <a href="#calibre_link-1914" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">575</a>&ndash;<a href="#calibre_link-1910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">576</a></p>
<p class="edition" id="calibre_link-4713">MIN function, <a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a></p>
<p class="edition" id="calibre_link-4714"><span type="pagebreak" id="calibre_link-4715"></span>MMR (Many-Many Relationships), <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-4716">bridge tables, <a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a>&ndash;<a href="#calibre_link-1770" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">499</a></p>
<p class="edition" id="calibre_link-4717">common dimensionality, <a href="#calibre_link-2089" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">500</a>&ndash;<a href="#calibre_link-2090" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">504</a></p>
<p class="edition" id="calibre_link-4718">weak relationships, <a href="#calibre_link-2090" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">504</a>&ndash;<a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a></p>
<p class="edition" id="calibre_link-4719">moving annual totals, computing, <a href="#calibre_link-1713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">243</a>&ndash;<a href="#calibre_link-1714" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">244</a></p>
<p class="edition" id="calibre_link-4720">moving averages, CALCULATE function, <a href="#calibre_link-1743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">201</a>&ndash;<a href="#calibre_link-1744" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">202</a></p>
<p class="edition" id="calibre_link-4721">MTD (Month-to-Date) calculations, time intelligence calculations, <a href="#calibre_link-1942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">235</a>&ndash;<a href="#calibre_link-1958" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">236</a>, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-4722">multi-line comments, <a href="#calibre_link-1850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">18</a></p>
<p class="edition" id="calibre_link-4723">multiple columns</p>
<p class="edition" id="calibre_link-4724">DISTINCT function and, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-4725">multiple-column relationships (calculated physical relationships), <a href="#calibre_link-1825" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">471</a>&ndash;<a href="#calibre_link-1826" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">473</a></p>
<p class="edition" id="calibre_link-4726">VALUES function and, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-4727">MultipleItemSales variable, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4728" class="h2a">N</h3>
<p class="edition" id="calibre_link-4729">Name calculation group, <a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a></p>
<p class="edition" id="calibre_link-4730">Name calculation item, <a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a></p>
<p class="edition" id="calibre_link-4731">naming variables, <a href="#calibre_link-2092" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">182</a></p>
<p class="edition" id="calibre_link-4732">narrowing table computations, <a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a>&ndash;<a href="#calibre_link-1920" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">386</a></p>
<p class="edition" id="calibre_link-4733">NATURALINNERJOIN function, authoring queries, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-4734">NATURALLEFTOUTERJOIN function, authoring queries, <a href="#calibre_link-2093" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">424</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-4735">nested functions, call order of time intelligence functions, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-4736">nested iterators</p>
<p class="edition" id="calibre_link-4737">DAX optimization, <a href="#calibre_link-1858" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">693</a>&ndash;<a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a></p>
<p class="edition" id="calibre_link-4738">leveraging context transitions, <a href="#calibre_link-1866" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">190</a>&ndash;<a href="#calibre_link-1895" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">194</a></p>
<p class="edition" id="calibre_link-4739">nesting</p>
<p class="edition" id="calibre_link-4740">filter contexts, in variables, <a href="#calibre_link-1874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">184</a>&ndash;<a href="#calibre_link-2045" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">185</a></p>
<p class="edition" id="calibre_link-4741">FILTER functions, <a href="#calibre_link-2047" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">61</a>&ndash;<a href="#calibre_link-1875" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">62</a></p>
<p class="edition" id="calibre_link-4742">multiple rows, in variables, <a href="#calibre_link-1874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">184</a></p>
<p class="edition" id="calibre_link-4743">row contexts</p>
<p class="edition" id="calibre_link-4744">on different tables, <a href="#calibre_link-2024" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">91</a>&ndash;<a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a></p>
<p class="edition" id="calibre_link-4745">on the same table, <a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a>&ndash;<a href="#calibre_link-2008" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">97</a></p>
<p class="edition" id="calibre_link-4746">table functions, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a>&ndash;<a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-4747">VAR/RETURN statements, <a href="#calibre_link-2094" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">179</a>&ndash;<a href="#calibre_link-2095" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">180</a></p>
<p class="edition" id="calibre_link-4748">new customers, computing (tables), <a href="#calibre_link-1918" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">380</a>&ndash;<a href="#calibre_link-1919" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">381</a>, <a href="#calibre_link-1920" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">386</a>&ndash;<a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a></p>
<p class="edition" id="calibre_link-4749">NEXTDAY function, call order of nested time intelligence functions, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-4750">non-active relationships, ambiguity, <a href="#calibre_link-1643" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">515</a>&ndash;<a href="#calibre_link-1711" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">517</a></p>
<p class="edition" id="calibre_link-4751">nonworking days between two dates, computing, <a href="#calibre_link-1693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">523</a>&ndash;<a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a></p>
<p class="edition" id="calibre_link-4752">numbering sequences of events (calculations), <a href="#calibre_link-1848" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">536</a>&ndash;<a href="#calibre_link-1846" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">539</a></p>
<p class="edition" id="calibre_link-4753">numbers, conversions, <a href="#calibre_link-1930" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">19</a>&ndash;<a href="#calibre_link-1917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">21</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4754" class="h2a">O</h3>
<p class="edition" id="calibre_link-4755">one-sided relationships (data models), <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a>, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-4756">one-to-many relationships. <em class="calibre5">See</em> <a href="#calibre_link-2096" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">SMR</a></p>
<p class="edition" id="calibre_link-4757">one-to-one relationships. <em class="calibre5">See</em> <a href="#calibre_link-2097" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">SSR</a></p>
<p class="edition" id="calibre_link-4758">opening/closing balances (time intelligence calculations), <a href="#calibre_link-1954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">254</a>&ndash;<a href="#calibre_link-1961" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">258</a></p>
<p class="edition" id="calibre_link-4759">operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-4760">arithmetic operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-4761">division by zero, <a href="#calibre_link-1720" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">32</a>&ndash;<a href="#calibre_link-1721" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">33</a></p>
<p class="edition" id="calibre_link-4762">empty/missing values, <a href="#calibre_link-1721" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">33</a>&ndash;<a href="#calibre_link-1722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">35</a></p>
<p class="edition" id="calibre_link-4763">error-handling, <a href="#calibre_link-1720" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">32</a>&ndash;<a href="#calibre_link-1722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">35</a></p>
<p class="edition" id="calibre_link-4764">comparison operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-4765">logical operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-4766">overloading, <a href="#calibre_link-1930" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">19</a>&ndash;<a href="#calibre_link-1931" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">20</a></p>
<p class="edition" id="calibre_link-4767">parenthesis operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-4768">text concatenation operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-4769">optimizing</p>
<p class="edition" id="calibre_link-4770">columns</p>
<p class="edition" id="calibre_link-4771">high-cardinality columns, <a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-4772">split optimization, <a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a>&ndash;<a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-4773">storage optimization, <a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a>&ndash;<a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-4774">data models with VertiPac, <a href="#calibre_link-1925" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">579</a></p>
<p class="edition" id="calibre_link-4775">aggregations, <a href="#calibre_link-1663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">587</a>&ndash;<a href="#calibre_link-1664" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">588</a></p>
<p class="edition" id="calibre_link-4776">cross-filtering, <a href="#calibre_link-1869" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">590</a></p>
<p class="edition" id="calibre_link-4777">denormalizing data, <a href="#calibre_link-1926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">584</a>&ndash;<a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a></p>
<p class="edition" id="calibre_link-4778">gathering data model information, <a href="#calibre_link-1925" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">579</a>&ndash;<a href="#calibre_link-1926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">584</a></p>
<p class="edition" id="calibre_link-4779">relationship cardinality, <a href="#calibre_link-1868" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">586</a>&ndash;<a href="#calibre_link-1663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">587</a></p>
<p class="edition" id="calibre_link-4780">DAX, <a href="#calibre_link-1971" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">657</a></p>
<p class="edition" id="calibre_link-4781">bottlenecks, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-4782">CallbackDataID function, <a href="#calibre_link-1857" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">690</a>&ndash;<a href="#calibre_link-1858" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">693</a></p>
<p class="edition" id="calibre_link-4783">change implementation, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-4784">conditional statements, <a href="#calibre_link-1897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">708</a>&ndash;<a href="#calibre_link-1898" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">709</a></p>
<p class="edition" id="calibre_link-4785">context transitions, <a href="#calibre_link-1903" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">672</a>&ndash;<a href="#calibre_link-1904" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">678</a></p>
<p class="edition" id="calibre_link-4786">DISTINCTCOUNT function, <a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a>&ndash;<a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a></p>
<p class="edition" id="calibre_link-4787">expressions, identifying a single DAX expression for optimization, <a href="#calibre_link-1963" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">658</a>&ndash;<a href="#calibre_link-1964" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">661</a></p>
<p class="edition" id="calibre_link-4788">filter conditions, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a>&ndash;<a href="#calibre_link-1903" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">672</a></p>
<p class="edition" id="calibre_link-4789">IF conditions, <a href="#calibre_link-1904" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">678</a>&ndash;<a href="#calibre_link-2079" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">683</a>, <a href="#calibre_link-2006" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">684</a>&ndash;<a href="#calibre_link-1857" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">690</a></p>
<p class="edition" id="calibre_link-4790">multiple evaluations, avoiding with variables, <a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a>&ndash;<a href="#calibre_link-1897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">708</a></p>
<p class="edition" id="calibre_link-4791">nested iterators, <a href="#calibre_link-1858" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">693</a>&ndash;<a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a></p>
<p class="edition" id="calibre_link-4792">query plans, <a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a>&ndash;<a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a></p>
<p class="edition" id="calibre_link-4793">reproduction queries, creating, <a href="#calibre_link-1964" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">661</a>&ndash;<a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a></p>
<p class="edition" id="calibre_link-4794">SE/FE bottlenecks, identifying, <a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a>&ndash;<a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-4795">server timings, <a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a>&ndash;<a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a></p>
<p class="edition" id="calibre_link-4796"><span type="pagebreak" id="calibre_link-4797"></span>test queries, rerunning, <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-4798">to-do list, <a href="#calibre_link-1963" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">658</a></p>
<p class="edition" id="calibre_link-4799">variables, <a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a>&ndash;<a href="#calibre_link-1897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">708</a></p>
<p class="edition" id="calibre_link-4800">OR conditions, tables as filters, <a href="#calibre_link-1919" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">381</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a></p>
<p class="edition" id="calibre_link-4801">ORDER BY clauses in EVALUATE statements, <a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a></p>
<p class="edition" id="calibre_link-4802">orders (example), computing duration of, <a href="#calibre_link-1818" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">26</a></p>
<p class="edition" id="calibre_link-4803">Ordinal values, calculated items, <a href="#calibre_link-1843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">289</a></p>
<p class="edition" id="calibre_link-4804">overwriting filters, CALCULATE function, <a href="#calibre_link-1763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">120</a>&ndash;<a href="#calibre_link-1789" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">122</a>, <a href="#calibre_link-1800" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">136</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4805" class="h2a">P</h3>
<p class="edition" id="calibre_link-4806">P/C (Parent/Child) hierarchies, <a href="#calibre_link-2073" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">350</a>&ndash;<a href="#calibre_link-2074" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">361</a>, <a href="#calibre_link-2072" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">362</a></p>
<p class="edition" id="calibre_link-4807">paging, VertiPaq hardware selection, <a href="#calibre_link-1910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">576</a>&ndash;<a href="#calibre_link-1985" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">577</a></p>
<p class="edition" id="calibre_link-4808">parallelism</p>
<p class="edition" id="calibre_link-4809">CallbackDataID function, <a href="#calibre_link-1859" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">641</a></p>
<p class="edition" id="calibre_link-4810">VertiPaq SE queries, <a href="#calibre_link-1859" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">641</a></p>
<p class="edition" id="calibre_link-4811">PARALLELPERIOD function, time intelligence calculations, <a href="#calibre_link-1944" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">238</a>&ndash;<a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a></p>
<p class="edition" id="calibre_link-4812">parenthesis operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-4813">partitioning and SSAS, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-4814">Partitions # column (VertiPaq Analyzer), <a href="#calibre_link-1887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">582</a></p>
<p class="edition" id="calibre_link-4815">percentages, computing, <a href="#calibre_link-1698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">135</a></p>
<p class="edition" id="calibre_link-4816">ALL function, <a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a>&ndash;<a href="#calibre_link-1685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">64</a></p>
<p class="edition" id="calibre_link-4817">ALLSELECTED function, <a href="#calibre_link-1700" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">75</a>&ndash;<a href="#calibre_link-1701" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">76</a></p>
<p class="edition" id="calibre_link-4818">CALCULATE function, <a href="#calibre_link-1765" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">124</a></p>
<p class="edition" id="calibre_link-4819">ALL function, <a href="#calibre_link-1679" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">125</a>&ndash;<a href="#calibre_link-1680" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">132</a></p>
<p class="edition" id="calibre_link-4820">ALLEXCEPT function, <a href="#calibre_link-1698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">135</a></p>
<p class="edition" id="calibre_link-4821">VALUES function, <a href="#calibre_link-1778" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">133</a>&ndash;<a href="#calibre_link-1779" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">134</a></p>
<p class="edition" id="calibre_link-4822">hierarchies, <a href="#calibre_link-2071" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">345</a></p>
<p class="edition" id="calibre_link-4823">IF conditions, <a href="#calibre_link-2075" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">349</a></p>
<p class="edition" id="calibre_link-4824">PercOnCategory measures, <a href="#calibre_link-2076" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">348</a></p>
<p class="edition" id="calibre_link-4825">PercOnParent measures, <a href="#calibre_link-2077" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">346</a>&ndash;<a href="#calibre_link-2075" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">349</a></p>
<p class="edition" id="calibre_link-4826">ratio to parent calculations, <a href="#calibre_link-2071" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">345</a></p>
<p class="edition" id="calibre_link-4827">PercOnCategory measures, computing percentages over hierarchies, <a href="#calibre_link-2076" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">348</a></p>
<p class="edition" id="calibre_link-4828">PercOnParent measures, computing percentages over hierarchies, <a href="#calibre_link-2077" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">346</a>, <a href="#calibre_link-2076" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">348</a>&ndash;<a href="#calibre_link-2075" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">349</a></p>
<p class="edition" id="calibre_link-4829">PercOnSubcategory measures, computing percentages over hierarchies, <a href="#calibre_link-2077" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">346</a>&ndash;<a href="#calibre_link-2076" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">348</a></p>
<p class="edition" id="calibre_link-4830">physical query plans, <a href="#calibre_link-1979" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">612</a>&ndash;<a href="#calibre_link-1970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">613</a>, <a href="#calibre_link-1980" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">614</a>&ndash;<a href="#calibre_link-1983" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">616</a>, <a href="#calibre_link-2086" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">651</a>&ndash;<a href="#calibre_link-2032" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">652</a></p>
<p class="edition" id="calibre_link-4831">physical relationships</p>
<p class="edition" id="calibre_link-4832">calculated physical relationships, <a href="#calibre_link-1825" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">471</a>&ndash;<a href="#calibre_link-1826" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">473</a></p>
<p class="edition" id="calibre_link-4833">circular dependencies, <a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a>&ndash;<a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a></p>
<p class="edition" id="calibre_link-4834">range-based relationships, <a href="#calibre_link-1802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">474</a>&ndash;<a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-4835">cardinality, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>&ndash;<a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a></p>
<p class="edition" id="calibre_link-4836">choosing, <a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a>&ndash;<a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-4837">cross-filter directions, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a></p>
<p class="edition" id="calibre_link-4838">bidirectional cross-filter direction, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1751" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">491</a>&ndash;<a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-4839">single cross-filter direction, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a></p>
<p class="edition" id="calibre_link-4840">cross-island relationships, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a></p>
<p class="edition" id="calibre_link-4841">intra-island relationships, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a></p>
<p class="edition" id="calibre_link-4842">MMR, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-4843">bridge tables, <a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a>&ndash;<a href="#calibre_link-1770" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">499</a></p>
<p class="edition" id="calibre_link-4844">common dimensionality, <a href="#calibre_link-2089" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">500</a>&ndash;<a href="#calibre_link-2090" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">504</a></p>
<p class="edition" id="calibre_link-4845">weak relationships, <a href="#calibre_link-2090" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">504</a>&ndash;<a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a></p>
<p class="edition" id="calibre_link-4846">SMR, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-4847">SSR, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>&ndash;<a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a></p>
<p class="edition" id="calibre_link-4848">strong relationships, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-4849">virtual relationships versus, <a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a>&ndash;<a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-4850">weak relationships, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a>, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-2090" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">504</a>&ndash;<a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a></p>
<p class="edition" id="calibre_link-4851">Power BI</p>
<p class="edition" id="calibre_link-4852">Auto Date/Time, <a href="#calibre_link-1741" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">218</a>&ndash;<a href="#calibre_link-1742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">219</a></p>
<p class="edition" id="calibre_link-4853">DAX and, <a href="#calibre_link-1969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">14</a>&ndash;<a href="#calibre_link-1975" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">15</a></p>
<p class="edition" id="calibre_link-4854">DAX Studio and, <a href="#calibre_link-1861" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">609</a>&ndash;<a href="#calibre_link-1862" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">611</a></p>
<p class="edition" id="calibre_link-4855">filter contexts, <a href="#calibre_link-2098" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">84</a>&ndash;<a href="#calibre_link-2018" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">85</a></p>
<p class="edition" id="calibre_link-4856">Power BI reports and DAX queries, <a href="#calibre_link-1861" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">609</a>&ndash;<a href="#calibre_link-2099" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">610</a></p>
<p class="edition" id="calibre_link-4857">Power Pivot for Excel</p>
<p class="edition" id="calibre_link-4858">automatic date columns, <a href="#calibre_link-1742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">219</a></p>
<p class="edition" id="calibre_link-4859">date table templates, <a href="#calibre_link-1936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">220</a></p>
<p class="edition" id="calibre_link-4860">Precedence calculation group, <a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a>, <a href="#calibre_link-1776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">299</a>&ndash;<a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a></p>
<p class="edition" id="calibre_link-4861">precomputing values (calculations), computing work days between two dates, <a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a>&ndash;<a href="#calibre_link-1771" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">527</a></p>
<p class="edition" id="calibre_link-4862">previous year sales up to last day sales (calculations), computing, <a href="#calibre_link-1846" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">539</a>&ndash;<a href="#calibre_link-1847" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">544</a></p>
<p class="edition" id="calibre_link-4863">PREVIOUSMONTH function, time intelligence calculations, <a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a></p>
<p class="edition" id="calibre_link-4864">Primary/Alternate Keys column (tables), <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a></p>
<p class="edition" id="calibre_link-4865">primary/alternate keys column (tables), <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a></p>
<p class="edition" id="calibre_link-4866">processing tables, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a></p>
<p class="edition" id="calibre_link-4867">PYTD (Previous Year-To-Date) calculations, calculation items and sideways recursion, <a href="#calibre_link-2100" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">307</a>&ndash;<a href="#calibre_link-2101" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">308</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4868" class="h2a">Q</h3>
<p class="edition" id="calibre_link-4869">QTD (Quarter-to-Date) calculations, time intelligence calculations, <a href="#calibre_link-1942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">235</a>&ndash;<a href="#calibre_link-1958" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">236</a>, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-4870">qualitative attributes column (tables), <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a>, <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a></p>
<p class="edition" id="calibre_link-4871">quantitative attributes column (tables), <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a>, <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a>&ndash;<a href="#calibre_link-1879" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">601</a></p>
<p class="edition" id="calibre_link-4872">queries</p>
<p class="edition" id="calibre_link-4873">DAX queries</p>
<p class="edition" id="calibre_link-4874">capturing, <a href="#calibre_link-1861" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">609</a>&ndash;<a href="#calibre_link-1862" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">611</a></p>
<p class="edition" id="calibre_link-4875">DISTINCTCOUNT function, <a href="#calibre_link-1977" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">634</a>&ndash;<a href="#calibre_link-1933" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">635</a></p>
<p class="edition" id="calibre_link-4876">executing, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-4877">DAX query plans, <a href="#calibre_link-1979" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">612</a>&ndash;<a href="#calibre_link-1970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">613</a></p>
<p class="edition" id="calibre_link-4878"><span type="pagebreak" id="calibre_link-4879"></span>DirectQuery, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a>, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a>, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a>, <a href="#calibre_link-1981" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">617</a></p>
<p class="edition" id="calibre_link-4880">DirectQuery SE queries</p>
<p class="edition" id="calibre_link-4881">composite data models, <a href="#calibre_link-1889" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">646</a>&ndash;<a href="#calibre_link-1665" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">647</a></p>
<p class="edition" id="calibre_link-4882">reading, <a href="#calibre_link-2001" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">645</a>&ndash;<a href="#calibre_link-1889" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">646</a></p>
<p class="edition" id="calibre_link-4883">Expression Trees, <a href="#calibre_link-1979" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">612</a></p>
<p class="edition" id="calibre_link-4884">FE, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a>, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-4885">datacaches, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-4886">operators of, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-4887">single-threaded implementation, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-4888">materialization, <a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a>&ndash;<a href="#calibre_link-1662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">571</a></p>
<p class="edition" id="calibre_link-4889">MDX queries, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-4890">DAX and, <a href="#calibre_link-1970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">613</a></p>
<p class="edition" id="calibre_link-4891">disabling attribute hierarchies (data model optimization), <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a></p>
<p class="edition" id="calibre_link-4892">executing, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-4893">query measures, creating with DAX Studio, <a href="#calibre_link-1976" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">662</a>&ndash;<a href="#calibre_link-1995" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">663</a></p>
<p class="edition" id="calibre_link-4894">reproduction queries, creating</p>
<p class="edition" id="calibre_link-4895">creating query measures with DAX Studio, <a href="#calibre_link-1976" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">662</a>&ndash;<a href="#calibre_link-1995" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">663</a></p>
<p class="edition" id="calibre_link-4896">in DAX, <a href="#calibre_link-1964" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">661</a>&ndash;<a href="#calibre_link-1976" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">662</a></p>
<p class="edition" id="calibre_link-4897">in MDX, <a href="#calibre_link-1995" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">663</a>&ndash;<a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a></p>
<p class="edition" id="calibre_link-4898">SE, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a>, <a href="#calibre_link-1983" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">616</a>&ndash;<a href="#calibre_link-1981" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">617</a></p>
<p class="edition" id="calibre_link-4899">aggregations, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-4900">datacaches, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-4901">DirectQuery, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-4902">operators of, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-4903">parallel implementations, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-4904">VertiPaq, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a>&ndash;<a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a>, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a>&ndash;<a href="#calibre_link-1985" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">577</a></p>
<p class="edition" id="calibre_link-4905">test queries, rerunning (DAX optimization), <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-4906">VertiPaq, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a>, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a>&ndash;<a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a>, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a>. <em class="calibre5">See also</em> <a href="#calibre_link-1987" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">data models</a>, <a href="#calibre_link-1988" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">optimizing with VertiPaq</a></p>
<p class="edition" id="calibre_link-4907">aggregations, <a href="#calibre_link-1662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">571</a>&ndash;<a href="#calibre_link-1989" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">573</a></p>
<p class="edition" id="calibre_link-4908">columnar databases, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a>&ndash;<a href="#calibre_link-1877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">553</a></p>
<p class="edition" id="calibre_link-4909">compression, <a href="#calibre_link-1877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">553</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a></p>
<p class="edition" id="calibre_link-4910">datacaches, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-4911">DMV, <a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a>&ndash;<a href="#calibre_link-1992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">565</a></p>
<p class="edition" id="calibre_link-4912">hardware selection, <a href="#calibre_link-1989" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">573</a>&ndash;<a href="#calibre_link-1985" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">577</a></p>
<p class="edition" id="calibre_link-4913">hash encoding, <a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a>&ndash;<a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a></p>
<p class="edition" id="calibre_link-4914">hierarchies, <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a></p>
<p class="edition" id="calibre_link-4915">materialization, <a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a>&ndash;<a href="#calibre_link-1662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">571</a></p>
<p class="edition" id="calibre_link-4916">multithreaded implementations, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-4917">partitioning, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-4918">processing tables, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a></p>
<p class="edition" id="calibre_link-4919">re-encoding, <a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-4920">relationships (data models), <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>, <a href="#calibre_link-1992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">565</a>&ndash;<a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a></p>
<p class="edition" id="calibre_link-4921">RLE, <a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a>&ndash;<a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-4922">scan operations, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-4923">segmentation, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-4924">sort orders, <a href="#calibre_link-1994" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">560</a>&ndash;<a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a></p>
<p class="edition" id="calibre_link-4925">value encoding, <a href="#calibre_link-1891" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">554</a>&ndash;<a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a></p>
<p class="edition" id="calibre_link-4926">VertiPaq SE queries, <a href="#calibre_link-2102" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">624</a></p>
<p class="edition" id="calibre_link-4927">composite data models, <a href="#calibre_link-1889" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">646</a>&ndash;<a href="#calibre_link-1665" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">647</a></p>
<p class="edition" id="calibre_link-4928">datacaches and parallelism, <a href="#calibre_link-1933" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">635</a>&ndash;<a href="#calibre_link-1934" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">637</a></p>
<p class="edition" id="calibre_link-4929">DISTINCTCOUNT function, <a href="#calibre_link-1977" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">634</a>&ndash;<a href="#calibre_link-1933" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">635</a></p>
<p class="edition" id="calibre_link-4930">scan time, <a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a>&ndash;<a href="#calibre_link-1977" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">634</a></p>
<p class="edition" id="calibre_link-4931">xmSQL queries and, <a href="#calibre_link-2102" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">624</a>&ndash;<a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a></p>
<p class="edition" id="calibre_link-4932">xmSQL queries, <a href="#calibre_link-2102" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">624</a></p>
<p class="edition" id="calibre_link-4933">aggregation functions, <a href="#calibre_link-1659" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">625</a>&ndash;<a href="#calibre_link-1660" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">627</a></p>
<p class="edition" id="calibre_link-4934">arithmetical operations, <a href="#calibre_link-1660" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">627</a></p>
<p class="edition" id="calibre_link-4935">batch events, <a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a>&ndash;<a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a></p>
<p class="edition" id="calibre_link-4936">filter operations, <a href="#calibre_link-2048" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">628</a>&ndash;<a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a></p>
<p class="edition" id="calibre_link-4937">join operators, <a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a></p>
<p class="edition" id="calibre_link-4938">queries, authoring, <a href="#calibre_link-1724" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">395</a></p>
<p class="edition" id="calibre_link-4939">ADDMISSINGITEMS function, <a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a>&ndash;<a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>, <a href="#calibre_link-1657" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">432</a>&ndash;<a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a></p>
<p class="edition" id="calibre_link-4940">auto-exists feature, <a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-4941">DAX Studio, <a href="#calibre_link-1724" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">395</a></p>
<p class="edition" id="calibre_link-4942">DEFINE sections</p>
<p class="edition" id="calibre_link-4943">MEASURE keyword in, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-4944">VAR keyword in, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-4945">EVALUATE statements</p>
<p class="edition" id="calibre_link-4946">ADDMISSINGITEMS function, <a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a>&ndash;<a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>, <a href="#calibre_link-1657" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">432</a>&ndash;<a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a></p>
<p class="edition" id="calibre_link-4947">example of, <a href="#calibre_link-1729" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">396</a></p>
<p class="edition" id="calibre_link-4948">expression variables and, <a href="#calibre_link-1730" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">398</a></p>
<p class="edition" id="calibre_link-4949">GENERATE function, <a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a>&ndash;<a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-4950">GENERATEALL function, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-4951">GROUPBY function, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>&ndash;<a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a></p>
<p class="edition" id="calibre_link-4952">ISONORAFTER function, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a>&ndash;<a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a></p>
<p class="edition" id="calibre_link-4953">NATURALINNERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-4954">NATURALLEFTOUTERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-4955">query variables and, <a href="#calibre_link-1730" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">398</a></p>
<p class="edition" id="calibre_link-4956">ROW function, <a href="#calibre_link-1735" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">400</a>&ndash;<a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-4957">SAMPLE function, <a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a>&ndash;<a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a></p>
<p class="edition" id="calibre_link-4958">SUBSTITUTEWITHINDEX function, <a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a>&ndash;<a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a></p>
<p class="edition" id="calibre_link-4959">SUMMARIZE function, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a>&ndash;<a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>, <a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-4960">SUMMARIZECOLUMNS function, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>, <a href="#calibre_link-1740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">429</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-4961">syntax of, <a href="#calibre_link-1729" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">396</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-4962">TOPN function, <a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>&ndash;<a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a></p>
<p class="edition" id="calibre_link-4963">TOPNSKIP function, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a></p>
<p class="edition" id="calibre_link-4964">expression variables, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-4965">GENERATE function, <a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a>&ndash;<a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-4966"><span type="pagebreak" id="calibre_link-4967"></span>GENERATEALL function, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a></p>
<p class="edition" id="calibre_link-4968">GROUPBY function, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>&ndash;<a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a></p>
<p class="edition" id="calibre_link-4969">ISONORAFTER function, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a>&ndash;<a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a></p>
<p class="edition" id="calibre_link-4970">MEASURE in DEFINE sections, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-4971">measures</p>
<p class="edition" id="calibre_link-4972">query measures, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-4973">testing, <a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a>&ndash;<a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-4974">NATURALINNERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-4975">NATURALLEFTOUTERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-4976">query variables, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-4977">ROW function, testing measures, <a href="#calibre_link-1735" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">400</a>&ndash;<a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-4978">SAMPLE function, <a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a>&ndash;<a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a></p>
<p class="edition" id="calibre_link-4979">shadow filter contexts, <a href="#calibre_link-1703" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">457</a>&ndash;<a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a></p>
<p class="edition" id="calibre_link-4980">SUBSTITUTEWITHINDEX function, <a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a>&ndash;<a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a></p>
<p class="edition" id="calibre_link-4981">SUMMARIZE function, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a>&ndash;<a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>, <a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-4982">SUMMARIZECOLUMNS function, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>, <a href="#calibre_link-1740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">429</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-4983">TOPN function, <a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>&ndash;<a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a></p>
<p class="edition" id="calibre_link-4984">TOPNSKIP function, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a></p>
<p class="edition" id="calibre_link-4985">VAR in DEFINE sections, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-4986">Query End events (SQL Server Profiler), <a href="#calibre_link-2000" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">621</a></p>
<p class="edition" id="calibre_link-4987">query plans</p>
<p class="edition" id="calibre_link-4988">capturing queries</p>
<p class="edition" id="calibre_link-4989">DAX Studio, <a href="#calibre_link-1981" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">617</a>&ndash;<a href="#calibre_link-1982" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">620</a></p>
<p class="edition" id="calibre_link-4990">SQL Server Profiler, <a href="#calibre_link-1982" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">620</a>&ndash;<a href="#calibre_link-1984" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">623</a></p>
<p class="edition" id="calibre_link-4991">collecting, <a href="#calibre_link-1970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">613</a>&ndash;<a href="#calibre_link-1980" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">614</a></p>
<p class="edition" id="calibre_link-4992">DAX optimization, <a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a>&ndash;<a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a></p>
<p class="edition" id="calibre_link-4993">logical query plans, <a href="#calibre_link-1979" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">612</a>, -614, <a href="#calibre_link-2085" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">650</a>&ndash;<a href="#calibre_link-2086" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">651</a></p>
<p class="edition" id="calibre_link-4994">physical query plans, <a href="#calibre_link-1979" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">612</a>&ndash;<a href="#calibre_link-1970" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">613</a>, <a href="#calibre_link-1980" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">614</a>&ndash;<a href="#calibre_link-1983" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">616</a>, <a href="#calibre_link-2086" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">651</a>&ndash;<a href="#calibre_link-2032" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">652</a></p>
<p class="edition" id="calibre_link-4995">reading, <a href="#calibre_link-2103" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">649</a>&ndash;<a href="#calibre_link-2035" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">655</a></p>
<p class="edition" id="calibre_link-4996">query variables, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-4997" class="h2a">R</h3>
<p class="edition" id="calibre_link-4998">range-based relationships (calculated physical relationships), <a href="#calibre_link-1802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">474</a>&ndash;<a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-4999">RANK.EQ function, <a href="#calibre_link-2055" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">210</a></p>
<p class="edition" id="calibre_link-5000">RANKX function, numbering sequences of events (calculations), <a href="#calibre_link-1799" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">538</a>&ndash;<a href="#calibre_link-1846" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">539</a></p>
<p class="edition" id="calibre_link-5001">RANKX iterators, <a href="#calibre_link-1747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">188</a>, <a href="#calibre_link-1744" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">202</a>&ndash;<a href="#calibre_link-2055" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">210</a></p>
<p class="edition" id="calibre_link-5002">ratio to parent calculations, computing percentages over hierarchies, <a href="#calibre_link-2071" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">345</a></p>
<p class="edition" id="calibre_link-5003">readability (code), FILTER function, <a href="#calibre_link-1875" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">62</a>&ndash;<a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a></p>
<p class="edition" id="calibre_link-5004">recursion (sideways), calculation items, <a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a>&ndash;<a href="#calibre_link-1842" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">311</a></p>
<p class="edition" id="calibre_link-5005">re-encoding</p>
<p class="edition" id="calibre_link-5006">SSAS and, <a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-5007">VertiPaq, <a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-5008">referencing columns in tables, <a href="#calibre_link-1849" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">17</a>&ndash;<a href="#calibre_link-1850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">18</a></p>
<p class="edition" id="calibre_link-5009">refreshing data, SSAS (SQL Server Analysis Services), <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a>&ndash;<a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a></p>
<p class="edition" id="calibre_link-5010">RELATED function</p>
<p class="edition" id="calibre_link-5011">CALCULATE function and, <a href="#calibre_link-1804" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">443</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-5012">calculated columns, <a href="#calibre_link-1804" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">443</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-5013">context transitions in expanded tables, <a href="#calibre_link-1702" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">455</a></p>
<p class="edition" id="calibre_link-5014">expanded tables, <a href="#calibre_link-2027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">441</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-5015">filter contexts, relationships and, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-5016">nested row contexts on different tables, <a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a></p>
<p class="edition" id="calibre_link-5017">row contexts and relationships, <a href="#calibre_link-2023" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">103</a>&ndash;<a href="#calibre_link-2022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">105</a></p>
<p class="edition" id="calibre_link-5018">table filters and expanded tables, <a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a></p>
<p class="edition" id="calibre_link-5019">RELATEDTABLE function, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a>&ndash;<a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-5020">filter contexts, relationships and, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-5021">nested row contexts on different tables, <a href="#calibre_link-2024" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">91</a>&ndash;<a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a></p>
<p class="edition" id="calibre_link-5022">row contexts and relationships, <a href="#calibre_link-2023" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">103</a>&ndash;<a href="#calibre_link-2022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">105</a></p>
<p class="edition" id="calibre_link-5023">relational functions, <a href="#calibre_link-2056" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">53</a>&ndash;<a href="#calibre_link-2057" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">54</a></p>
<p class="edition" id="calibre_link-5024">relationships (data models), <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-5025">1:1 relationships, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-5026">active relationships</p>
<p class="edition" id="calibre_link-5027">ambiguity, <a href="#calibre_link-1642" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">514</a>&ndash;<a href="#calibre_link-1643" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">515</a></p>
<p class="edition" id="calibre_link-5028">CALCULATETABLE function, <a href="#calibre_link-1644" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">451</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-5029">expanded tables and, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-5030">USERELATIONSHIP function, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1644" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">451</a></p>
<p class="edition" id="calibre_link-5031">ambiguity, <a href="#calibre_link-1709" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">512</a>&ndash;<a href="#calibre_link-1710" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">513</a></p>
<p class="edition" id="calibre_link-5032">active relationships, <a href="#calibre_link-1642" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">514</a>&ndash;<a href="#calibre_link-1643" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">515</a></p>
<p class="edition" id="calibre_link-5033">non-active relationships, <a href="#calibre_link-1643" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">515</a>&ndash;<a href="#calibre_link-1711" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">517</a></p>
<p class="edition" id="calibre_link-5034">bidirectional filtering, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a>&ndash;<a href="#calibre_link-1754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">4</a></p>
<p class="edition" id="calibre_link-5035">bidirectional relationships, <a href="#calibre_link-1755" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">106</a>, <a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-5036">calculated physical relationships, <a href="#calibre_link-1825" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">471</a></p>
<p class="edition" id="calibre_link-5037">circular dependencies, <a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a>&ndash;<a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a></p>
<p class="edition" id="calibre_link-5038">multiple-column relationships, <a href="#calibre_link-1825" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">471</a>&ndash;<a href="#calibre_link-1826" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">473</a></p>
<p class="edition" id="calibre_link-5039">range-based relationships, <a href="#calibre_link-1802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">474</a>&ndash;<a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-5040">cardinality, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>&ndash;<a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1868" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">586</a>&ndash;<a href="#calibre_link-1663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">587</a>, <a href="#calibre_link-1869" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">590</a>&ndash;<a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a></p>
<p class="edition" id="calibre_link-5041">chains, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-5042">columns, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-5043">cross-filter directions, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a></p>
<p class="edition" id="calibre_link-5044">bidirectional cross-filter direction, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1751" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">491</a>&ndash;<a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5045">single cross-filter direction, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a></p>
<p class="edition" id="calibre_link-5046">cross-island relationships, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a></p>
<p class="edition" id="calibre_link-5047">DAX and SQL, <a href="#calibre_link-1927" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">9</a></p>
<p class="edition" id="calibre_link-5048">directions of, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a>&ndash;<a href="#calibre_link-1754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">4</a></p>
<p class="edition" id="calibre_link-5049">evaluation contexts and, <a href="#calibre_link-1689" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">101</a>&ndash;<a href="#calibre_link-2021" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">102</a></p>
<p class="edition" id="calibre_link-5050">filter contexts, <a href="#calibre_link-1755" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">106</a>&ndash;<a href="#calibre_link-1756" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">109</a></p>
<p class="edition" id="calibre_link-5051">row contexts, <a href="#calibre_link-2021" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">102</a>&ndash;<a href="#calibre_link-2022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">105</a></p>
<p class="edition" id="calibre_link-5052">expanded tables, <a href="#calibre_link-2028" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">437</a>&ndash;<a href="#calibre_link-2027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">441</a></p>
<p class="edition" id="calibre_link-5053"><span type="pagebreak" id="calibre_link-5054"></span>granularity, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a>&ndash;<a href="#calibre_link-1709" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">512</a></p>
<p class="edition" id="calibre_link-5055">intra-island relationships, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a></p>
<p class="edition" id="calibre_link-5056">invalid relationships and blank rows, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a>&ndash;<a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5057">many-sided relationships, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a>, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-5058">MMR, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5059">bridge tables, <a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a>&ndash;<a href="#calibre_link-1770" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">499</a></p>
<p class="edition" id="calibre_link-5060">common dimensionality, <a href="#calibre_link-2089" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">500</a>&ndash;<a href="#calibre_link-2090" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">504</a></p>
<p class="edition" id="calibre_link-5061">weak relationships, <a href="#calibre_link-2090" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">504</a>&ndash;<a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a></p>
<p class="edition" id="calibre_link-5062">non-active relationships, ambiguity, <a href="#calibre_link-1643" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">515</a>&ndash;<a href="#calibre_link-1711" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">517</a></p>
<p class="edition" id="calibre_link-5063">one-sided relationships, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a>, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-5064">performance, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5065">physical relationships</p>
<p class="edition" id="calibre_link-5066">calculated physical relationships, <a href="#calibre_link-1825" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">471</a>&ndash;<a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a></p>
<p class="edition" id="calibre_link-5067">cardinality, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>&ndash;<a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a></p>
<p class="edition" id="calibre_link-5068">choosing, <a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a>&ndash;<a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5069">cross-filter directions, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>&ndash;<a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a></p>
<p class="edition" id="calibre_link-5070">cross-island relationships, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a></p>
<p class="edition" id="calibre_link-5071">intra-island relationships, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a></p>
<p class="edition" id="calibre_link-5072">MMR, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a>&ndash;<a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5073">SMR, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5074">SSR, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>&ndash;<a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a></p>
<p class="edition" id="calibre_link-5075">strong relationships, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-5076">virtual relationships versus, <a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a>&ndash;<a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5077">weak relationships, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a>, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-2090" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">504</a>&ndash;<a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a></p>
<p class="edition" id="calibre_link-5078">Relationship reports (VertiPaq Analyzer), <a href="#calibre_link-1926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">584</a></p>
<p class="edition" id="calibre_link-5079">Relationship Size column (VertiPaq Analyzer), <a href="#calibre_link-1887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">582</a></p>
<p class="edition" id="calibre_link-5080">relationships, expanded tables, <a href="#calibre_link-2028" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">437</a>&ndash;<a href="#calibre_link-2027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">441</a></p>
<p class="edition" id="calibre_link-5081">shallow relationships in batch events (xmSQL queries), <a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a>&ndash;<a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a></p>
<p class="edition" id="calibre_link-5082">SMR, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5083">SSAS and, <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a></p>
<p class="edition" id="calibre_link-5084">SSR, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>&ndash;<a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a></p>
<p class="edition" id="calibre_link-5085">strong relationships, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-5086">transferring filters, <a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a>&ndash;<a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a></p>
<p class="edition" id="calibre_link-5087">CALCULATE function, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a></p>
<p class="edition" id="calibre_link-5088">CONTAINS function, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a></p>
<p class="edition" id="calibre_link-5089">FILTER function, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-5090">INTERSECT function, <a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>&ndash;<a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-5091">TREATAS function, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>&ndash;<a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-5092">unidirectional filtering, <a href="#calibre_link-1754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">4</a></p>
<p class="edition" id="calibre_link-5093">USERELATIONSHIP function, non-active relationships and ambiguity, <a href="#calibre_link-2070" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">516</a>&ndash;<a href="#calibre_link-1711" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">517</a></p>
<p class="edition" id="calibre_link-5094">VertiPaq and, <a href="#calibre_link-1992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">565</a>&ndash;<a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a></p>
<p class="edition" id="calibre_link-5095">virtual relationships, <a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5096">dynamic segmentation, <a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a>&ndash;<a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-5097">physical relationships versus, <a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a>&ndash;<a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5098">transferring filters, <a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-5099">weak relationships, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a>, <a href="#calibre_link-1928" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">439</a>, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a>, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-2090" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">504</a>&ndash;<a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a></p>
<p class="edition" id="calibre_link-5100">reproduction queries, creating</p>
<p class="edition" id="calibre_link-5101">in DAX, <a href="#calibre_link-1964" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">661</a>&ndash;<a href="#calibre_link-1976" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">662</a></p>
<p class="edition" id="calibre_link-5102">in MDX, <a href="#calibre_link-1995" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">663</a>&ndash;<a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a></p>
<p class="edition" id="calibre_link-5103">query measures, creating with DAX Studio, <a href="#calibre_link-1976" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">662</a>&ndash;<a href="#calibre_link-1995" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">663</a></p>
<p class="edition" id="calibre_link-5104">reusing table expressions, <a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a>&ndash;<a href="#calibre_link-1998" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">389</a></p>
<p class="edition" id="calibre_link-5105">RLE (Run Length Encoding), VertiPaq, <a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a>&ndash;<a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-5106">ROLLUP function, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a>&ndash;<a href="#calibre_link-2053" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">402</a>, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a></p>
<p class="edition" id="calibre_link-5107">ROLLUPADDISSUBTOTAL modifier, SUMMARIZECOLUMNS function, <a href="#calibre_link-2063" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">404</a>&ndash;<a href="#calibre_link-2037" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">406</a></p>
<p class="edition" id="calibre_link-5108">ROLLUPGROUP modifier, SUMMARIZECOLUMNS function, <a href="#calibre_link-2037" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">406</a></p>
<p class="edition" id="calibre_link-5109">ROW CONTEXT iterators, <a href="#calibre_link-2082" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">187</a>&ndash;<a href="#calibre_link-1747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">188</a></p>
<p class="edition" id="calibre_link-5110">row contexts, <a href="#calibre_link-2016" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">80</a></p>
<p class="edition" id="calibre_link-5111">CALCULATE function and, <a href="#calibre_link-1780" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">148</a>&ndash;<a href="#calibre_link-1781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">151</a></p>
<p class="edition" id="calibre_link-5112">column references, <a href="#calibre_link-1882" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">87</a></p>
<p class="edition" id="calibre_link-5113">examples of, <a href="#calibre_link-2025" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">86</a>&ndash;<a href="#calibre_link-1882" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">87</a></p>
<p class="edition" id="calibre_link-5114">filter contexts versus, <a href="#calibre_link-2018" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">85</a></p>
<p class="edition" id="calibre_link-5115">iterators and, <a href="#calibre_link-1881" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">90</a>&ndash;<a href="#calibre_link-2024" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">91</a></p>
<p class="edition" id="calibre_link-5116">nested row contexts</p>
<p class="edition" id="calibre_link-5117">on different tables, <a href="#calibre_link-2024" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">91</a>&ndash;<a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a></p>
<p class="edition" id="calibre_link-5118">on the same table, <a href="#calibre_link-1911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">92</a>&ndash;<a href="#calibre_link-2008" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">97</a></p>
<p class="edition" id="calibre_link-5119">relationships and, <a href="#calibre_link-2021" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">102</a>&ndash;<a href="#calibre_link-2022" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">105</a></p>
<p class="edition" id="calibre_link-5120">ROW function</p>
<p class="edition" id="calibre_link-5121">static tables, creating, <a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a>&ndash;<a href="#calibre_link-1935" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">392</a></p>
<p class="edition" id="calibre_link-5122">testing measures, <a href="#calibre_link-1735" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">400</a>&ndash;<a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-5123">rows (tables)</p>
<p class="edition" id="calibre_link-5124">ALLNOBLANKROW function, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a></p>
<p class="edition" id="calibre_link-5125">blank rows, invalid relationships, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a>&ndash;<a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5126">CONTAINSROW function, <a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a>&ndash;<a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a></p>
<p class="edition" id="calibre_link-5127">DETAILROWS function, <a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a>&ndash;<a href="#calibre_link-1998" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">389</a></p>
<p class="edition" id="calibre_link-5128">nesting in variables, <a href="#calibre_link-1874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">184</a></p>
<p class="edition" id="calibre_link-5129">SAMPLE function, <a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a>&ndash;<a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a></p>
<p class="edition" id="calibre_link-5130">TOPN function, <a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>&ndash;<a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a></p>
<p class="edition" id="calibre_link-5131">Rows column (VertiPaq Analyzer), <a href="#calibre_link-1870" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">581</a>, <a href="#calibre_link-1871" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">583</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-5132" class="h2a">S</h3>
<p class="edition" id="calibre_link-5133">sales</p>
<p class="edition" id="calibre_link-5134">budget/sales information (calculations), showing together, <a href="#calibre_link-1771" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">527</a>&ndash;<a href="#calibre_link-1772" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">530</a></p>
<p class="edition" id="calibre_link-5135">previous year sales up to last day sales (calculations), computing, <a href="#calibre_link-1846" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">539</a>&ndash;<a href="#calibre_link-1847" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">544</a></p>
<p class="edition" id="calibre_link-5136">same-store sales (calculations), computing, <a href="#calibre_link-1772" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">530</a>&ndash;<a href="#calibre_link-1848" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">536</a></p>
<p class="edition" id="calibre_link-5137">same-store sales (calculations), computing, <a href="#calibre_link-1772" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">530</a>&ndash;<a href="#calibre_link-1848" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">536</a></p>
<p class="edition" id="calibre_link-5138">SAMEPERIODLASTYEAR function</p>
<p class="edition" id="calibre_link-5139"><span type="pagebreak" id="calibre_link-5140"></span>computing previous year sales up to last day sales (calculations), <a href="#calibre_link-2058" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">540</a>&ndash;<a href="#calibre_link-1847" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">544</a></p>
<p class="edition" id="calibre_link-5141">nested time intelligence functions, call order of, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-5142">time intelligence calculations, <a href="#calibre_link-1943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">237</a></p>
<p class="edition" id="calibre_link-5143">SAMPLE function, authoring queries, <a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a>&ndash;<a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a></p>
<p class="edition" id="calibre_link-5144">scalar expressions, <a href="#calibre_link-2030" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">57</a>&ndash;<a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a></p>
<p class="edition" id="calibre_link-5145">scalar values</p>
<p class="edition" id="calibre_link-5146">storing in variables, <a href="#calibre_link-2104" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">176</a>, <a href="#calibre_link-2083" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">181</a></p>
<p class="edition" id="calibre_link-5147">tables as, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a>&ndash;<a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a></p>
<p class="edition" id="calibre_link-5148">SE (Storage Engines), <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-5149">aggregations, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-5150">bottlenecks, identifying, <a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a>&ndash;<a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-5151">datacaches, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-5152">DirectQuery, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a>, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-5153">operators of, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a></p>
<p class="edition" id="calibre_link-5154">parallel implementations, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-5155">queries, <a href="#calibre_link-1983" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">616</a>&ndash;<a href="#calibre_link-1981" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">617</a></p>
<p class="edition" id="calibre_link-5156">SE queries, copy VertiPaq SE queries entries</p>
<p class="edition" id="calibre_link-5157">VertiPaq, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a>&ndash;<a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a>, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a>. <em class="calibre5">See also</em> <a href="#calibre_link-1987" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">data models</a>, <a href="#calibre_link-1988" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">optimizing with VertiPaq</a></p>
<p class="edition" id="calibre_link-5158">aggregations, <a href="#calibre_link-1662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">571</a>&ndash;<a href="#calibre_link-1989" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">573</a></p>
<p class="edition" id="calibre_link-5159">columnar databases, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a>&ndash;<a href="#calibre_link-1877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">553</a></p>
<p class="edition" id="calibre_link-5160">compression, <a href="#calibre_link-1877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">553</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a></p>
<p class="edition" id="calibre_link-5161">datacaches, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-5162">DMV, <a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a>&ndash;<a href="#calibre_link-1992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">565</a></p>
<p class="edition" id="calibre_link-5163">hardware selection, <a href="#calibre_link-1989" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">573</a>&ndash;<a href="#calibre_link-1985" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">577</a></p>
<p class="edition" id="calibre_link-5164">hash encoding, <a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a>&ndash;<a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a></p>
<p class="edition" id="calibre_link-5165">hierarchies, <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a></p>
<p class="edition" id="calibre_link-5166">materialization, <a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a>&ndash;<a href="#calibre_link-1662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">571</a></p>
<p class="edition" id="calibre_link-5167">multithreaded implementations, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-5168">partitioning, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-5169">processing tables, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a></p>
<p class="edition" id="calibre_link-5170">re-encoding, <a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-5171">relationships (data models), <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>, <a href="#calibre_link-1992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">565</a>&ndash;<a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a></p>
<p class="edition" id="calibre_link-5172">RLE, <a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a>&ndash;<a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-5173">scan operations, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-5174">segmentation, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-5175">sort orders, <a href="#calibre_link-1994" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">560</a>&ndash;<a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a></p>
<p class="edition" id="calibre_link-5176">value encoding, <a href="#calibre_link-1891" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">554</a>&ndash;<a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a></p>
<p class="edition" id="calibre_link-5177">VertiPaq SE queries, <a href="#calibre_link-2102" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">624</a>&ndash;<a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a></p>
<p class="edition" id="calibre_link-5178">segmentation</p>
<p class="edition" id="calibre_link-5179">dynamic segmentation and virtual relationships, <a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a>&ndash;<a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-5180">SSAS and, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-5181">Segments # column (VertiPaq Analyzer), <a href="#calibre_link-1887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">582</a></p>
<p class="edition" id="calibre_link-5182">SELECTCOLUMNS function, <a href="#calibre_link-1827" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">390</a>&ndash;<a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a>, <a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a>&ndash;<a href="#calibre_link-1884" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">394</a></p>
<p class="edition" id="calibre_link-5183">SELECTCOLUMNS iterators, <a href="#calibre_link-1653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">196</a>, <a href="#calibre_link-1885" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">197</a>&ndash;<a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-5184">SELECTEDMEASURE function, including/excluding measures from calculation items, <a href="#calibre_link-1801" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">304</a>&ndash;<a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a></p>
<p class="edition" id="calibre_link-5185">SELECTEDMEASUREFORMATSTRING function, <a href="#calibre_link-1775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">291</a></p>
<p class="edition" id="calibre_link-5186">SELECTEDVALUE function</p>
<p class="edition" id="calibre_link-5187">calculated physical relationships, circular dependencies, <a href="#calibre_link-2059" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">479</a>&ndash;<a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a></p>
<p class="edition" id="calibre_link-5188">context transitions in expanded tables, <a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a>&ndash;<a href="#calibre_link-1702" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">455</a></p>
<p class="edition" id="calibre_link-5189">filter contexts, <a href="#calibre_link-2042" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">318</a>&ndash;<a href="#calibre_link-2043" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">319</a></p>
<p class="edition" id="calibre_link-5190">same-store sales (calculations), computing, <a href="#calibre_link-2060" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">533</a>&ndash;<a href="#calibre_link-2061" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">534</a></p>
<p class="edition" id="calibre_link-5191">tables as scalar values, <a href="#calibre_link-1913" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">73</a>&ndash;<a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a></p>
<p class="edition" id="calibre_link-5192">semi-additive calculations, time intelligence calculations, <a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a>&ndash;<a href="#calibre_link-1952" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">248</a></p>
<p class="edition" id="calibre_link-5193">sequences of events (calculations), numbering, <a href="#calibre_link-1848" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">536</a>&ndash;<a href="#calibre_link-1846" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">539</a></p>
<p class="edition" id="calibre_link-5194">server timings, DAX optimization, <a href="#calibre_link-1972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">664</a>&ndash;<a href="#calibre_link-1767" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">667</a></p>
<p class="edition" id="calibre_link-5195">shadow filter contexts, <a href="#calibre_link-1703" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">457</a>&ndash;<a href="#calibre_link-1697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">462</a></p>
<p class="edition" id="calibre_link-5196">shallow relationships in batch events (xmSQL queries), <a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a>&ndash;<a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a></p>
<p class="edition" id="calibre_link-5197">sideways recursion, calculation items, <a href="#calibre_link-1844" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">306</a>&ndash;<a href="#calibre_link-1842" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">311</a></p>
<p class="edition" id="calibre_link-5198">simple filters</p>
<p class="edition" id="calibre_link-5199">arbitrarily shaped filters versus, <a href="#calibre_link-1718" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">337</a></p>
<p class="edition" id="calibre_link-5200">defined, <a href="#calibre_link-1718" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">337</a></p>
<p class="edition" id="calibre_link-5201">single cross-filter direction (physical relationships), <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a></p>
<p class="edition" id="calibre_link-5202">single data models</p>
<p class="edition" id="calibre_link-5203">DirectQuery mode, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-5204">VertiPaq mode, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-5205">single-line comments, <a href="#calibre_link-1850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">18</a></p>
<p class="edition" id="calibre_link-2096">SMR (Single-Many Relationships), <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5206">sort order, determining, ORDER BY clauses, <a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a></p>
<p class="edition" id="calibre_link-5207">sort orders</p>
<p class="edition" id="calibre_link-5208">SSAS and, <a href="#calibre_link-1994" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">560</a>&ndash;<a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a></p>
<p class="edition" id="calibre_link-5209">VertiPaq, <a href="#calibre_link-1994" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">560</a>&ndash;<a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a></p>
<p class="edition" id="calibre_link-5210">SQL (Structured Query Language)</p>
<p class="edition" id="calibre_link-5211">conditions, <a href="#calibre_link-1899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">11</a></p>
<p class="edition" id="calibre_link-5212">DAX and, <a href="#calibre_link-1927" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">9</a></p>
<p class="edition" id="calibre_link-5213">as declarative language, <a href="#calibre_link-1965" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">10</a></p>
<p class="edition" id="calibre_link-5214">error-handling, empty/missing values, <a href="#calibre_link-1722" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">35</a></p>
<p class="edition" id="calibre_link-5215">subqueries, <a href="#calibre_link-1899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">11</a></p>
<p class="edition" id="calibre_link-5216">SQL Server Profiler</p>
<p class="edition" id="calibre_link-5217">DirectQuery End events, <a href="#calibre_link-2000" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">621</a></p>
<p class="edition" id="calibre_link-5218">Query End events, <a href="#calibre_link-2000" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">621</a></p>
<p class="edition" id="calibre_link-5219">query plans, capturing profiling information, <a href="#calibre_link-1982" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">620</a>&ndash;<a href="#calibre_link-1984" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">623</a></p>
<p class="edition" id="calibre_link-5220">VertiPaq SE Query Cache Match events, <a href="#calibre_link-2000" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">621</a></p>
<p class="edition" id="calibre_link-5221">VertiPaq SE Query End events, <a href="#calibre_link-2000" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">621</a></p>
<p class="edition" id="calibre_link-5222"><span type="pagebreak" id="calibre_link-5223"></span>SQRT function, <a href="#calibre_link-1757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">36</a></p>
<p class="edition" id="calibre_link-5224">SSAS (SQL Server Analysis Services)</p>
<p class="edition" id="calibre_link-5225">data refreshes, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a>&ndash;<a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a></p>
<p class="edition" id="calibre_link-5226">DMV, <a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a>&ndash;<a href="#calibre_link-1992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">565</a></p>
<p class="edition" id="calibre_link-5227">hierarchies, <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a></p>
<p class="edition" id="calibre_link-5228">partitioning, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-5229">processing tables, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a></p>
<p class="edition" id="calibre_link-5230">re-encoding, <a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-5231">relationships (data models), <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a></p>
<p class="edition" id="calibre_link-5232">segmentation, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-5233">sort orders, <a href="#calibre_link-1994" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">560</a>&ndash;<a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a></p>
<p class="edition" id="calibre_link-2097">SSR (Single-Single Relationships), <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-1750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">490</a>, <a href="#calibre_link-1752" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">493</a>&ndash;<a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a></p>
<p class="edition" id="calibre_link-5234">star schemas, denormalizing data and data model optimization, <a href="#calibre_link-1868" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">586</a></p>
<p class="edition" id="calibre_link-5235">STARTOFQUARTER function, time intelligence calculations, <a href="#calibre_link-1950" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">256</a>&ndash;<a href="#calibre_link-1951" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">257</a></p>
<p class="edition" id="calibre_link-5236">static tables, creating</p>
<p class="edition" id="calibre_link-5237">DATATABLE function, <a href="#calibre_link-1935" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">392</a>&ndash;<a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a></p>
<p class="edition" id="calibre_link-5238">ROW function, <a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a>&ndash;<a href="#calibre_link-1935" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">392</a></p>
<p class="edition" id="calibre_link-5239">storing</p>
<p class="edition" id="calibre_link-5240">blockz, in variables, <a href="#calibre_link-2104" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">176</a>, <a href="#calibre_link-2083" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">181</a></p>
<p class="edition" id="calibre_link-5241">columns (tables), <a href="#calibre_link-1879" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">601</a>&ndash;<a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-5242">partial results of calculations, in variables, <a href="#calibre_link-2104" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">176</a>&ndash;<a href="#calibre_link-2105" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">177</a></p>
<p class="edition" id="calibre_link-5243">scalar values, in variables, <a href="#calibre_link-2104" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">176</a>, <a href="#calibre_link-2083" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">181</a></p>
<p class="edition" id="calibre_link-5244">tables, in variables, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a></p>
<p class="edition" id="calibre_link-5245">string conversions, <a href="#calibre_link-1930" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">19</a>&ndash;<a href="#calibre_link-1917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">21</a></p>
<p class="edition" id="calibre_link-5246">strong relationships, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-5247">subcategories/categories example, ALL function and, <a href="#calibre_link-1695" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">66</a>&ndash;<a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a></p>
<p class="edition" id="calibre_link-5248">subqueries</p>
<p class="edition" id="calibre_link-5249">DAX, <a href="#calibre_link-1899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">11</a></p>
<p class="edition" id="calibre_link-5250">SQL, <a href="#calibre_link-1899" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">11</a></p>
<p class="edition" id="calibre_link-5251">SUBSTITUTEWITHINDEX function, authoring queries, <a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a>&ndash;<a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a></p>
<p class="edition" id="calibre_link-5252">SUM function, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a>&ndash;<a href="#calibre_link-1671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">43</a>, <a href="#calibre_link-1672" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">44</a>&ndash;<a href="#calibre_link-1673" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">45</a>, <a href="#calibre_link-1822" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">88</a>&ndash;<a href="#calibre_link-1823" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">89</a></p>
<p class="edition" id="calibre_link-5253">SUMMARIZE function</p>
<p class="edition" id="calibre_link-5254">authoring queries, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a>&ndash;<a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>, <a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-5255">auto-exists feature (queries), <a href="#calibre_link-1658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">433</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-5256">columns (tables) and, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-5257">filter contexts, <a href="#calibre_link-1746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">112</a></p>
<p class="edition" id="calibre_link-5258">GROUPBY function and, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a>&ndash;<a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a></p>
<p class="edition" id="calibre_link-5259">ISSUBTOTAL function and, <a href="#calibre_link-2053" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">402</a>&ndash;<a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a></p>
<p class="edition" id="calibre_link-5260">ROLLUP function and, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a>&ndash;<a href="#calibre_link-2053" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">402</a>, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a></p>
<p class="edition" id="calibre_link-5261">table filters and expanded tables, <a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a>&ndash;<a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a></p>
<p class="edition" id="calibre_link-5262">tables and, <a href="#calibre_link-1650" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">369</a>&ndash;<a href="#calibre_link-1652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">372</a>, <a href="#calibre_link-2062" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">373</a>&ndash;<a href="#calibre_link-1915" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">374</a>, <a href="#calibre_link-1916" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">383</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a></p>
<p class="edition" id="calibre_link-5263">transferring filters, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-5264">SUMMARIZECOLUMNS function</p>
<p class="edition" id="calibre_link-5265">authoring queries, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>, <a href="#calibre_link-1740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">429</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-5266">auto-exists feature (queries), <a href="#calibre_link-1740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">429</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-5267">filter arguments, <a href="#calibre_link-2037" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">406</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a></p>
<p class="edition" id="calibre_link-5268">IGNORE modifier, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-2063" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">404</a></p>
<p class="edition" id="calibre_link-5269">ROLLUPADDISSUBTOTAL modifier, <a href="#calibre_link-2063" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">404</a>&ndash;<a href="#calibre_link-2037" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">406</a></p>
<p class="edition" id="calibre_link-5270">ROLLUPGROUP modifier, <a href="#calibre_link-2037" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">406</a></p>
<p class="edition" id="calibre_link-5271">TREATAS function and, <a href="#calibre_link-2064" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">407</a>&ndash;<a href="#calibre_link-2065" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">408</a></p>
<p class="edition" id="calibre_link-5272">SUMX function, <a href="#calibre_link-1673" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">45</a></p>
<p class="edition" id="calibre_link-5273">SUMX iterators, <a href="#calibre_link-2082" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">187</a>&ndash;<a href="#calibre_link-1747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">188</a></p>
<p class="edition" id="calibre_link-5274">SWITCH function, <a href="#calibre_link-2054" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">47</a>&ndash;<a href="#calibre_link-2050" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">48</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-5275" class="h2a">T</h3>
<p class="edition" id="calibre_link-5276">table constructors, <a href="#calibre_link-1896" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">24</a></p>
<p class="edition" id="calibre_link-5277">table expressions, EVALUATE statements, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a>&ndash;<a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a></p>
<p class="edition" id="calibre_link-5278">table filters, DISTINCTCOUNT function, <a href="#calibre_link-1973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">699</a>&ndash;<a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a></p>
<p class="edition" id="calibre_link-5279">table functions, <a href="#calibre_link-2030" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">57</a></p>
<p class="edition" id="calibre_link-5280">ALL function</p>
<p class="edition" id="calibre_link-5281">columns and, <a href="#calibre_link-1685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">64</a>&ndash;<a href="#calibre_link-1686" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">65</a></p>
<p class="edition" id="calibre_link-5282">computing percentages, <a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a>&ndash;<a href="#calibre_link-1685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">64</a></p>
<p class="edition" id="calibre_link-5283">measures and, <a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a>&ndash;<a href="#calibre_link-1685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">64</a></p>
<p class="edition" id="calibre_link-5284">syntax of, <a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a></p>
<p class="edition" id="calibre_link-5285">top categories/subcategories example, <a href="#calibre_link-1695" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">66</a>&ndash;<a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a></p>
<p class="edition" id="calibre_link-5286">VALUES function versus, <a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a></p>
<p class="edition" id="calibre_link-5287">ALLEXCEPT function, <a href="#calibre_link-1686" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">65</a>&ndash;<a href="#calibre_link-1695" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">66</a></p>
<p class="edition" id="calibre_link-5288">ALLSELECTED function, <a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a>&ndash;<a href="#calibre_link-1701" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">76</a></p>
<p class="edition" id="calibre_link-5289">calculated columns and, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-5290">calculated tables, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-5291">DISTINCT function, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5292">blank rows and invalid relationships, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a>, <a href="#calibre_link-2002" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">70</a>&ndash;<a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5293">calculated columns, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5294">multiple columns, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5295">VALUES function versus, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5296">FILTER function, <a href="#calibre_link-2030" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">57</a>&ndash;<a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a></p>
<p class="edition" id="calibre_link-5297">code maintenance/readability, <a href="#calibre_link-1875" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">62</a>&ndash;<a href="#calibre_link-1692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">63</a></p>
<p class="edition" id="calibre_link-5298">as iterator, <a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a>&ndash;<a href="#calibre_link-2047" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">61</a></p>
<p class="edition" id="calibre_link-5299">nesting, <a href="#calibre_link-2047" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">61</a>&ndash;<a href="#calibre_link-1875" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">62</a></p>
<p class="edition" id="calibre_link-5300">syntax of, <a href="#calibre_link-2013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">60</a></p>
<p class="edition" id="calibre_link-5301">measures and, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-5302">nesting, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a>&ndash;<a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-5303">RELATEDTABLE function, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a>&ndash;<a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-5304">VALUES function, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5305">ALL function versus, <a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a></p>
<p class="edition" id="calibre_link-5306">blank rows and invalid relationships, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a>&ndash;<a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5307"><span type="pagebreak" id="calibre_link-5308"></span>calculated columns, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5309">calculated tables, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5310">DISTINCT function versus, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5311">measures and, <a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a>&ndash;<a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5312">multiple columns, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5313">tables as scalar values, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a>&ndash;<a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a></p>
<p class="edition" id="calibre_link-5314">Table Size % column (VertiPaq Analyzer), <a href="#calibre_link-1887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">582</a></p>
<p class="edition" id="calibre_link-5315">Table Size column (VertiPaq Analyzer), <a href="#calibre_link-1870" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">581</a></p>
<p class="edition" id="calibre_link-5316">table variables, <a href="#calibre_link-2083" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">181</a>&ndash;<a href="#calibre_link-2092" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">182</a></p>
<p class="edition" id="calibre_link-5317">tables, <a href="#calibre_link-1829" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">363</a></p>
<p class="edition" id="calibre_link-5318">ADDCOLUMNS function, <a href="#calibre_link-1649" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">366</a>&ndash;<a href="#calibre_link-1650" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">369</a>, <a href="#calibre_link-1651" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">371</a>&ndash;<a href="#calibre_link-1652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">372</a></p>
<p class="edition" id="calibre_link-5319">blank rows, invalid relationships, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a>&ndash;<a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5320">bridge tables, MMR, <a href="#calibre_link-1769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">494</a>&ndash;<a href="#calibre_link-1770" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">499</a></p>
<p class="edition" id="calibre_link-5321">CALCULATE function, tables as filters, <a href="#calibre_link-1807" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">382</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a></p>
<p class="edition" id="calibre_link-5322">calculated columns, <a href="#calibre_link-1817" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">25</a>&ndash;<a href="#calibre_link-1818" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">26</a>, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-5323">choosing between calculated columns and measures, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a>&ndash;<a href="#calibre_link-1821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">30</a></p>
<p class="edition" id="calibre_link-5324">differences between calculated columns and measures, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a></p>
<p class="edition" id="calibre_link-5325">expressions, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a></p>
<p class="edition" id="calibre_link-5326">using measures in calculated columns, <a href="#calibre_link-1821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">30</a></p>
<p class="edition" id="calibre_link-5327">calculated tables, <a href="#calibre_link-1824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">59</a></p>
<p class="edition" id="calibre_link-5328">creating, <a href="#calibre_link-1827" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">390</a>&ndash;<a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a></p>
<p class="edition" id="calibre_link-5329">DISTINCT function, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5330">SELECTCOLUMNS function, <a href="#calibre_link-1827" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">390</a>&ndash;<a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a></p>
<p class="edition" id="calibre_link-5331">VALUES function, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5332">CALCULATETABLE function, <a href="#calibre_link-1829" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">363</a>&ndash;<a href="#calibre_link-1830" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">365</a></p>
<p class="edition" id="calibre_link-5333">columns</p>
<p class="edition" id="calibre_link-5334">ADDCOLUMNS function, <a href="#calibre_link-1649" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">366</a>&ndash;<a href="#calibre_link-1650" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">369</a>, <a href="#calibre_link-1651" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">371</a>&ndash;<a href="#calibre_link-1652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">372</a></p>
<p class="edition" id="calibre_link-5335">Boolean calculated columns, <a href="#calibre_link-1760" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">597</a>&ndash;<a href="#calibre_link-1761" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">598</a></p>
<p class="edition" id="calibre_link-5336">calculated columns and data model optimization, <a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a>&ndash;<a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a></p>
<p class="edition" id="calibre_link-5337">calculated columns, RELATED function, <a href="#calibre_link-1804" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">443</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-5338">cardinality, <a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-5339">cardinality and data model optimization, <a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a>&ndash;<a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a></p>
<p class="edition" id="calibre_link-5340">Date column, <a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a>&ndash;<a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a></p>
<p class="edition" id="calibre_link-5341">defined, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-5342">descriptive attributes column (tables), <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a>, <a href="#calibre_link-1879" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">601</a>&ndash;<a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-5343">filtering, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-5344">optimizing high-cardinality columns, <a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-5345">Primary/Alternate Keys column (tables), <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a></p>
<p class="edition" id="calibre_link-5346">primary/alternate keys column (tables), <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a></p>
<p class="edition" id="calibre_link-5347">qualitative attributes column (tables), <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a>, <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a></p>
<p class="edition" id="calibre_link-5348">quantitative attributes column (tables), <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a>, <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a>&ndash;<a href="#calibre_link-1879" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">601</a></p>
<p class="edition" id="calibre_link-5349">referencing, <a href="#calibre_link-1849" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">17</a>&ndash;<a href="#calibre_link-1850" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">18</a></p>
<p class="edition" id="calibre_link-5350">relationships, <a href="#calibre_link-1723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">3</a></p>
<p class="edition" id="calibre_link-5351">SELECTCOLUMNS function, <a href="#calibre_link-1827" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">390</a>&ndash;<a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a>, <a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a>&ndash;<a href="#calibre_link-1884" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">394</a></p>
<p class="edition" id="calibre_link-5352">storage optimization, <a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a>&ndash;<a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-5353">storing, <a href="#calibre_link-1879" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">601</a>&ndash;<a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-5354">SUBSTITUTEWITHINDEX function, <a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a>&ndash;<a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a></p>
<p class="edition" id="calibre_link-5355">SUMMARIZE function and, <a href="#calibre_link-1736" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">401</a></p>
<p class="edition" id="calibre_link-5356">SUMMARIZECOLUMNS function, <a href="#calibre_link-1738" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">403</a>&ndash;<a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>, <a href="#calibre_link-1740" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">429</a>&ndash;<a href="#calibre_link-1726" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">434</a></p>
<p class="edition" id="calibre_link-5357">technical attributes column (tables), <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a>, <a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-5358">Time column, <a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a>&ndash;<a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a></p>
<p class="edition" id="calibre_link-5359">VertiPaq Analyzer, <a href="#calibre_link-1886" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">580</a>&ndash;<a href="#calibre_link-1871" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">583</a></p>
<p class="edition" id="calibre_link-5360">computing new customers, <a href="#calibre_link-1918" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">380</a>&ndash;<a href="#calibre_link-1919" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">381</a>, <a href="#calibre_link-1920" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">386</a>&ndash;<a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a></p>
<p class="edition" id="calibre_link-5361">CONTAINS function, <a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a>&ndash;<a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a></p>
<p class="edition" id="calibre_link-5362">CONTAINSROW function, <a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a>&ndash;<a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a></p>
<p class="edition" id="calibre_link-5363">CROSSJOIN function, <a href="#calibre_link-1652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">372</a>&ndash;<a href="#calibre_link-1915" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">374</a>, <a href="#calibre_link-1916" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">383</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a></p>
<p class="edition" id="calibre_link-5364">date tables</p>
<p class="edition" id="calibre_link-5365">ADDCOLUMNS function, <a href="#calibre_link-1647" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">223</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-5366">building, <a href="#calibre_link-1936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">220</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-5367">CALENDAR function, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a></p>
<p class="edition" id="calibre_link-5368">CALENDARAUTO function, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-5369">date table templates (Power Pivot for Excel), <a href="#calibre_link-1936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">220</a></p>
<p class="edition" id="calibre_link-5370">date templates, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-5371">duplicating, <a href="#calibre_link-1938" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">227</a></p>
<p class="edition" id="calibre_link-5372">loading from other data sources, <a href="#calibre_link-1937" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">221</a></p>
<p class="edition" id="calibre_link-5373">managing multiple dates, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a>&ndash;<a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a></p>
<p class="edition" id="calibre_link-5374">Mark as Date Table, <a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a>&ndash;<a href="#calibre_link-1939" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">233</a></p>
<p class="edition" id="calibre_link-5375">multiple date tables, <a href="#calibre_link-1940" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">226</a>&ndash;<a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a></p>
<p class="edition" id="calibre_link-5376">multiple relationships to date tables, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a>&ndash;<a href="#calibre_link-1940" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">226</a></p>
<p class="edition" id="calibre_link-5377">naming, <a href="#calibre_link-1937" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">221</a></p>
<p class="edition" id="calibre_link-5378">defined, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-5379">DETAILROWS function, <a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a>&ndash;<a href="#calibre_link-1998" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">389</a></p>
<p class="edition" id="calibre_link-5380">EXCEPT function, <a href="#calibre_link-2026" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">379</a>&ndash;<a href="#calibre_link-1919" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">381</a></p>
<p class="edition" id="calibre_link-5381">expanded tables</p>
<p class="edition" id="calibre_link-5382">active relationships, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-5383">column filters versus table filters, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-5384">context transitions, <a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a>&ndash;<a href="#calibre_link-1702" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">455</a></p>
<p class="edition" id="calibre_link-5385">differences between table filters and expanded tables, <a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a>&ndash;<a href="#calibre_link-1905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">454</a></p>
<p class="edition" id="calibre_link-5386">filter contexts, <a href="#calibre_link-1928" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">439</a>&ndash;<a href="#calibre_link-2027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">441</a></p>
<p class="edition" id="calibre_link-5387">filtering, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a>, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">453</a></p>
<p class="edition" id="calibre_link-5388">RELATED function, <a href="#calibre_link-2027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">441</a>&ndash;<a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a></p>
<p class="edition" id="calibre_link-5389">relationships, <a href="#calibre_link-2028" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">437</a>&ndash;<a href="#calibre_link-2027" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">441</a></p>
<p class="edition" id="calibre_link-5390">table filters in measures, <a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a>&ndash;<a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a></p>
<p class="edition" id="calibre_link-5391">table filters versus column filters, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-5392"><span type="pagebreak" id="calibre_link-5393"></span>expressions, reusing, <a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a>&ndash;<a href="#calibre_link-1998" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">389</a></p>
<p class="edition" id="calibre_link-5394">FILTER function versus CALCULATETABLE function, <a href="#calibre_link-1829" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">363</a>&ndash;<a href="#calibre_link-1830" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">365</a></p>
<p class="edition" id="calibre_link-5395">filtering</p>
<p class="edition" id="calibre_link-5396">CALCULATE function and, <a href="#calibre_link-1790" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">445</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-5397">column filters versus, <a href="#calibre_link-1805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">444</a>&ndash;<a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a></p>
<p class="edition" id="calibre_link-5398">in measures, <a href="#calibre_link-1791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">447</a>&ndash;<a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a></p>
<p class="edition" id="calibre_link-5399">as filters, <a href="#calibre_link-1919" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">381</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a></p>
<p class="edition" id="calibre_link-5400">GENERATESERIES function, <a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a>&ndash;<a href="#calibre_link-1884" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">394</a></p>
<p class="edition" id="calibre_link-5401">IN function, <a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a>&ndash;<a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a></p>
<p class="edition" id="calibre_link-5402">INTERSECT function, <a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a>&ndash;<a href="#calibre_link-2026" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">379</a></p>
<p class="edition" id="calibre_link-5403">iterators, returning tables with, <a href="#calibre_link-1653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">196</a>&ndash;<a href="#calibre_link-1654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">199</a></p>
<p class="edition" id="calibre_link-5404">measures, defining in tables, <a href="#calibre_link-1820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">29</a></p>
<p class="edition" id="calibre_link-5405">narrowing computations, <a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a>&ndash;<a href="#calibre_link-1920" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">386</a></p>
<p class="edition" id="calibre_link-5406">NATURALINNERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-5407">NATURALLEFTOUTERJOIN function, <a href="#calibre_link-1733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">423</a>&ndash;<a href="#calibre_link-1734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">425</a></p>
<p class="edition" id="calibre_link-5408">processing, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a></p>
<p class="edition" id="calibre_link-5409">records, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a></p>
<p class="edition" id="calibre_link-5410">reusing expressions, <a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a>&ndash;<a href="#calibre_link-1998" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">389</a></p>
<p class="edition" id="calibre_link-5411">rows</p>
<p class="edition" id="calibre_link-5412">ALLNOBLANKROW function, <a href="#calibre_link-1675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">464</a>, <a href="#calibre_link-1676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">465</a></p>
<p class="edition" id="calibre_link-5413">CONTAINSROW function, <a href="#calibre_link-1900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">387</a>&ndash;<a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a></p>
<p class="edition" id="calibre_link-5414">DETAILROWS function, <a href="#calibre_link-1901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">388</a>&ndash;<a href="#calibre_link-1998" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">389</a></p>
<p class="edition" id="calibre_link-5415">SAMPLE function, <a href="#calibre_link-1737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">427</a>&ndash;<a href="#calibre_link-1725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">428</a></p>
<p class="edition" id="calibre_link-5416">TOPN function, <a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>&ndash;<a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a></p>
<p class="edition" id="calibre_link-5417">as scalar values, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a>&ndash;<a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a></p>
<p class="edition" id="calibre_link-5418">SELECTCOLUMNS function, <a href="#calibre_link-1827" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">390</a>&ndash;<a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a>, <a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a>&ndash;<a href="#calibre_link-1884" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">394</a></p>
<p class="edition" id="calibre_link-5419">static tables</p>
<p class="edition" id="calibre_link-5420">creating with DATATABLE function, <a href="#calibre_link-1935" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">392</a>&ndash;<a href="#calibre_link-1883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">393</a></p>
<p class="edition" id="calibre_link-5421">creating with ROW function, <a href="#calibre_link-1828" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">391</a>&ndash;<a href="#calibre_link-1935" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">392</a></p>
<p class="edition" id="calibre_link-5422">storing in variables, <a href="#calibre_link-2104" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">176</a>, <a href="#calibre_link-2083" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">181</a></p>
<p class="edition" id="calibre_link-5423">SUMMARIZE function, <a href="#calibre_link-1650" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">369</a>&ndash;<a href="#calibre_link-1652" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">372</a>, <a href="#calibre_link-2062" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">373</a>&ndash;<a href="#calibre_link-1915" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">374</a>, <a href="#calibre_link-1916" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">383</a>&ndash;<a href="#calibre_link-1808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">384</a></p>
<p class="edition" id="calibre_link-5424">temporary tables in batch events (xmSQL queries), <a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a>&ndash;<a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a></p>
<p class="edition" id="calibre_link-5425">TOPN function, <a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>&ndash;<a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a></p>
<p class="edition" id="calibre_link-5426">UNION function, <a href="#calibre_link-1915" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">374</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-5427">variables, storing tables in, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a></p>
<p class="edition" id="calibre_link-5428">Tabular model</p>
<p class="edition" id="calibre_link-5429">calculation groups, creating, <a href="#calibre_link-1837" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">281</a>&ndash;<a href="#calibre_link-1838" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">288</a></p>
<p class="edition" id="calibre_link-5430">DAX engines and, <a href="#calibre_link-1986" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">545</a>&ndash;<a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-5431">DAX queries, executing, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-5432">DirectQuery, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-5433">MDX queries, executing, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-5434">VertiPaq, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a></p>
<p class="edition" id="calibre_link-5435">technical attributes column (tables), <a href="#calibre_link-1708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">600</a>, <a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-5436">templates</p>
<p class="edition" id="calibre_link-5437">date table templates (Power Pivot for Excel), <a href="#calibre_link-1936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">220</a></p>
<p class="edition" id="calibre_link-5438">date templates, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-5439">temporary tables in batch events (xmSQL queries), <a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a>&ndash;<a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a></p>
<p class="edition" id="calibre_link-5440">test queries, rerunning (DAX optimization), <a href="#calibre_link-1768" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">668</a></p>
<p class="edition" id="calibre_link-5441">text</p>
<p class="edition" id="calibre_link-5442">concatenation operators, <a href="#calibre_link-1719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">23</a></p>
<p class="edition" id="calibre_link-5443">editing, formatting DAX code, <a href="#calibre_link-1670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">42</a></p>
<p class="edition" id="calibre_link-5444">text functions, <a href="#calibre_link-2066" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">50</a>&ndash;<a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-5445">Time column, data model optimization, <a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a>&ndash;<a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a></p>
<p class="edition" id="calibre_link-5446">TIME function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a>, <a href="#calibre_link-1907" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">52</a></p>
<p class="edition" id="calibre_link-5447">time intelligence calculations, <a href="#calibre_link-1941" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">217</a></p>
<p class="edition" id="calibre_link-5448">Auto Date/Time (Power BI), <a href="#calibre_link-1741" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">218</a>&ndash;<a href="#calibre_link-1742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">219</a></p>
<p class="edition" id="calibre_link-5449">automatic date columns (Power Pivot for Excel), <a href="#calibre_link-1742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">219</a></p>
<p class="edition" id="calibre_link-5450">basic calculations, <a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a>&ndash;<a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a></p>
<p class="edition" id="calibre_link-5451">basic functions, <a href="#calibre_link-1939" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">233</a>&ndash;<a href="#calibre_link-1942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">235</a></p>
<p class="edition" id="calibre_link-5452">CALCULATE function, <a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a>&ndash;<a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a></p>
<p class="edition" id="calibre_link-5453">CALCULATETABLE function, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">260</a>&ndash;<a href="#calibre_link-1833" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">261</a></p>
<p class="edition" id="calibre_link-5454">context transitions, <a href="#calibre_link-1832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">260</a></p>
<p class="edition" id="calibre_link-5455">custom calendars, <a href="#calibre_link-1853" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">272</a></p>
<p class="edition" id="calibre_link-5456">DATESYTD function, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-5457">weeks, <a href="#calibre_link-1853" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">272</a>&ndash;<a href="#calibre_link-1856" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">275</a></p>
<p class="edition" id="calibre_link-5458">date tables</p>
<p class="edition" id="calibre_link-5459">ADDCOLUMNS function, <a href="#calibre_link-1647" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">223</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-5460">building, <a href="#calibre_link-1936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">220</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-5461">CALENDAR function, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a></p>
<p class="edition" id="calibre_link-5462">CALENDARAUTO function, <a href="#calibre_link-1852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">222</a>&ndash;<a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-5463">date table templates (Power Pivot for Excel), <a href="#calibre_link-1936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">220</a></p>
<p class="edition" id="calibre_link-5464">date templates, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a></p>
<p class="edition" id="calibre_link-5465">duplicating, <a href="#calibre_link-1938" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">227</a></p>
<p class="edition" id="calibre_link-5466">loading from other data sources, <a href="#calibre_link-1937" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">221</a></p>
<p class="edition" id="calibre_link-5467">managing multiple dates, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a>&ndash;<a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a></p>
<p class="edition" id="calibre_link-5468">Mark as Date Table, <a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a>&ndash;<a href="#calibre_link-1939" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">233</a></p>
<p class="edition" id="calibre_link-5469">multiple date tables, <a href="#calibre_link-1940" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">226</a>&ndash;<a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a></p>
<p class="edition" id="calibre_link-5470">multiple relationships to date tables, <a href="#calibre_link-1648" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">224</a>&ndash;<a href="#calibre_link-1940" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">226</a></p>
<p class="edition" id="calibre_link-5471">naming, <a href="#calibre_link-1937" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">221</a></p>
<p class="edition" id="calibre_link-5472">DATEADD function, <a href="#calibre_link-1943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">237</a>&ndash;<a href="#calibre_link-1944" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">238</a>, <a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>&ndash;<a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a></p>
<p class="edition" id="calibre_link-5473">DATESINPERIOD function, <a href="#calibre_link-1713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">243</a>&ndash;<a href="#calibre_link-1714" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">244</a></p>
<p class="edition" id="calibre_link-5474">DATESMTD function, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-5475">DATESQTD function, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-5476">DATESYTD function, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>, <a href="#calibre_link-1832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">260</a>, <a href="#calibre_link-1833" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">261</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-5477">differences over previous periods, computing, <a href="#calibre_link-1947" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">241</a>&ndash;<a href="#calibre_link-1713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">243</a></p>
<p class="edition" id="calibre_link-5478">drillthrough operations, <a href="#calibre_link-1948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">271</a></p>
<p class="edition" id="calibre_link-5479">FILTER function, <a href="#calibre_link-1809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">228</a>&ndash;<a href="#calibre_link-1810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">232</a></p>
<p class="edition" id="calibre_link-5480">FIRSTDATE function, <a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a></p>
<p class="edition" id="calibre_link-5481">FIRSTNONBLANK function, <a href="#calibre_link-1950" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">256</a>&ndash;<a href="#calibre_link-1951" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">257</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a>&ndash;<a href="#calibre_link-1948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">271</a></p>
<p class="edition" id="calibre_link-5482"><span type="pagebreak" id="calibre_link-5483"></span>LASTDATE function, <a href="#calibre_link-1952" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">248</a>&ndash;<a href="#calibre_link-1953" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">249</a>, <a href="#calibre_link-1954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">254</a>, <a href="#calibre_link-1955" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">255</a>, <a href="#calibre_link-1946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">269</a>&ndash;<a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a></p>
<p class="edition" id="calibre_link-5484">LASTNONBLANK function, <a href="#calibre_link-1956" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">250</a>&ndash;<a href="#calibre_link-1954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">254</a>, <a href="#calibre_link-1955" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">255</a>, <a href="#calibre_link-1949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">270</a>&ndash;<a href="#calibre_link-1948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">271</a></p>
<p class="edition" id="calibre_link-5485">mixing functions, <a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a>&ndash;<a href="#calibre_link-1947" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">241</a></p>
<p class="edition" id="calibre_link-5486">moving annual totals, computing, <a href="#calibre_link-1713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">243</a>&ndash;<a href="#calibre_link-1714" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">244</a></p>
<p class="edition" id="calibre_link-5487">MTD calculations, <a href="#calibre_link-1942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">235</a>&ndash;<a href="#calibre_link-1958" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">236</a>, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-5488">nested functions, call order of, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-5489">NEXTDAY function, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-5490">opening/closing balances, <a href="#calibre_link-1954" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">254</a>&ndash;<a href="#calibre_link-1961" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">258</a></p>
<p class="edition" id="calibre_link-5491">PARALLELPERIOD function, <a href="#calibre_link-1944" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">238</a>&ndash;<a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a></p>
<p class="edition" id="calibre_link-5492">periods to date, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a></p>
<p class="edition" id="calibre_link-5493">PREVIOUSMONTH function, <a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a></p>
<p class="edition" id="calibre_link-5494">QTD calculations, <a href="#calibre_link-1942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">235</a>&ndash;<a href="#calibre_link-1958" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">236</a>, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-5495">SAMEPERIODLASTYEAR function, <a href="#calibre_link-1943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">237</a>, <a href="#calibre_link-1959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">245</a>&ndash;<a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a></p>
<p class="edition" id="calibre_link-5496">semi-additive calculations, <a href="#calibre_link-1960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">246</a>&ndash;<a href="#calibre_link-1952" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">248</a></p>
<p class="edition" id="calibre_link-5497">STARTOFQUARTER function, <a href="#calibre_link-1950" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">256</a>&ndash;<a href="#calibre_link-1951" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">257</a></p>
<p class="edition" id="calibre_link-5498">time periods, computing from prior periods, <a href="#calibre_link-1943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">237</a>&ndash;<a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a></p>
<p class="edition" id="calibre_link-5499">YTD calculations, <a href="#calibre_link-1942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">235</a>&ndash;<a href="#calibre_link-1958" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">236</a>, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a></p>
<p class="edition" id="calibre_link-5500">time periods, computing from prior periods, <a href="#calibre_link-1943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">237</a>&ndash;<a href="#calibre_link-1957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">239</a></p>
<p class="edition" id="calibre_link-5501">top categories/subcategories example, ALL function and, <a href="#calibre_link-1695" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">66</a>&ndash;<a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a></p>
<p class="edition" id="calibre_link-5502">TOPN function</p>
<p class="edition" id="calibre_link-5503">authoring queries, <a href="#calibre_link-1739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">409</a>&ndash;<a href="#calibre_link-1731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">414</a></p>
<p class="edition" id="calibre_link-5504">ISONORAFTER function and, <a href="#calibre_link-1732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">417</a>&ndash;<a href="#calibre_link-1655" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">419</a></p>
<p class="edition" id="calibre_link-5505">sort order, <a href="#calibre_link-2067" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">410</a></p>
<p class="edition" id="calibre_link-5506">TOPNSKIP function, authoring queries, <a href="#calibre_link-1656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">420</a></p>
<p class="edition" id="calibre_link-5507">transferring filters, <a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a>&ndash;<a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a></p>
<p class="edition" id="calibre_link-5508">CALCULATE function, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a></p>
<p class="edition" id="calibre_link-5509">CONTAINS function, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a></p>
<p class="edition" id="calibre_link-5510">FILTER function, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-5511">INTERSECT function, <a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>&ndash;<a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-5512">TREATAS function, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>&ndash;<a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-5513">TREATAS function, <a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-5514">data lineage, <a href="#calibre_link-2068" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">467</a>&ndash;<a href="#calibre_link-1923" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">468</a></p>
<p class="edition" id="calibre_link-5515">filter contexts and data lineage, <a href="#calibre_link-2046" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">334</a>&ndash;<a href="#calibre_link-1715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">336</a></p>
<p class="edition" id="calibre_link-5516">SUMMARIZECOLUMNS function and, <a href="#calibre_link-2064" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">407</a>&ndash;<a href="#calibre_link-2065" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">408</a></p>
<p class="edition" id="calibre_link-5517">transferring filters, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>&ndash;<a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-5518">UNION function and, <a href="#calibre_link-2069" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">377</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-5519">trigonometric functions, <a href="#calibre_link-2066" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">50</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-5520" class="h2a">U</h3>
<p class="edition" id="calibre_link-5521">unary operators, P/C (Parent/Child) hierarchies, <a href="#calibre_link-2072" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">362</a></p>
<p class="edition" id="calibre_link-5522">unidirectional filtering (relationships), <a href="#calibre_link-1754" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">4</a></p>
<p class="edition" id="calibre_link-5523">UNION function</p>
<p class="edition" id="calibre_link-5524">CALCULATE function and, <a href="#calibre_link-1815" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">376</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-5525">DISTINCT function and, <a href="#calibre_link-2004" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">375</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-5526">tables and, <a href="#calibre_link-1915" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">374</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-5527">TREATAS function and, <a href="#calibre_link-2069" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">377</a>&ndash;<a href="#calibre_link-1816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">378</a></p>
<p class="edition" id="calibre_link-5528">Use Hierarchies Size column (VertiPaq Analyzer), <a href="#calibre_link-1887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">582</a></p>
<p class="edition" id="calibre_link-5529">USERELATIONSHIP function</p>
<p class="edition" id="calibre_link-5530">active relationships, <a href="#calibre_link-1646" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">450</a>&ndash;<a href="#calibre_link-1644" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">451</a></p>
<p class="edition" id="calibre_link-5531">CALCULATE function and, <a href="#calibre_link-1681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">164</a>&ndash;<a href="#calibre_link-1785" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">168</a></p>
<p class="edition" id="calibre_link-5532">non-active relationships and ambiguity, <a href="#calibre_link-2070" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">516</a>&ndash;<a href="#calibre_link-1711" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">517</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-5533" class="h2a">V</h3>
<p class="edition" id="calibre_link-5534">value encoding (VertiPaq compression), <a href="#calibre_link-1891" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">554</a>&ndash;<a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a></p>
<p class="edition" id="calibre_link-5535">VALUE function, <a href="#calibre_link-1906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">51</a></p>
<p class="edition" id="calibre_link-5536">values, list of. <em class="calibre5">See</em> <a href="#calibre_link-2084" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">filter arguments</a></p>
<p class="edition" id="calibre_link-5537">VALUES function, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5538">ALL function and, <a href="#calibre_link-1691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">327</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-5539">ALL function versus, <a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a></p>
<p class="edition" id="calibre_link-5540">ALLEXCEPT function versus, <a href="#calibre_link-1677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">326</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-5541">blank rows and invalid relataionships, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a>&ndash;<a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5542">calculated columns, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5543">calculated physical relationships</p>
<p class="edition" id="calibre_link-5544">circular dependencies, <a href="#calibre_link-2003" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">477</a>&ndash;<a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a></p>
<p class="edition" id="calibre_link-5545">range-based relationships, <a href="#calibre_link-1802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">474</a>&ndash;<a href="#calibre_link-1803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">476</a></p>
<p class="edition" id="calibre_link-5546">calculated tables, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5547">computing percentages, <a href="#calibre_link-1778" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">133</a>&ndash;<a href="#calibre_link-1779" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">134</a></p>
<p class="edition" id="calibre_link-5548">DISTINCT function versus, <a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5549">filter contexts, <a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a>&ndash;<a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a>, <a href="#calibre_link-1691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">327</a>&ndash;<a href="#calibre_link-1678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">328</a></p>
<p class="edition" id="calibre_link-5550">FILTERS function versus, <a href="#calibre_link-2040" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">322</a>&ndash;<a href="#calibre_link-1690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">324</a></p>
<p class="edition" id="calibre_link-5551">measures and, <a href="#calibre_link-1696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">67</a>&ndash;<a href="#calibre_link-1758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">68</a></p>
<p class="edition" id="calibre_link-5552">multiple columns, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a></p>
<p class="edition" id="calibre_link-5553">tables as scalar values, <a href="#calibre_link-1759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">71</a>&ndash;<a href="#calibre_link-1699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">74</a></p>
<p class="edition" id="calibre_link-5554">VAR keyword, DEFINE sections (authoring queries), <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-5555">variables, <a href="#calibre_link-1821" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">30</a>&ndash;<a href="#calibre_link-1908" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">31</a>, <a href="#calibre_link-2106" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">175</a></p>
<p class="edition" id="calibre_link-5556">as a constant, <a href="#calibre_link-2105" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">177</a>&ndash;<a href="#calibre_link-2107" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">178</a></p>
<p class="edition" id="calibre_link-5557">defining, <a href="#calibre_link-2104" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">176</a>, <a href="#calibre_link-2107" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">178</a>&ndash;<a href="#calibre_link-2095" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">180</a></p>
<p class="edition" id="calibre_link-5558">documenting code, <a href="#calibre_link-1873" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">183</a>&ndash;<a href="#calibre_link-1874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">184</a></p>
<p class="edition" id="calibre_link-5559">error-handling, <a href="#calibre_link-2012" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">37</a></p>
<p class="edition" id="calibre_link-5560">expression variables, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-5561">formatting, <a href="#calibre_link-2029" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">40</a>&ndash;<a href="#calibre_link-1997" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">41</a></p>
<p class="edition" id="calibre_link-5562">lazy evaluations, <a href="#calibre_link-2083" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">181</a>&ndash;<a href="#calibre_link-1873" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">183</a></p>
<p class="edition" id="calibre_link-5563">multiple evaluations, avoiding with variables, <a href="#calibre_link-1974" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">704</a>&ndash;<a href="#calibre_link-1897" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">708</a></p>
<p class="edition" id="calibre_link-5564"><span type="pagebreak" id="calibre_link-5565"></span>MultipleItemSales variable, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a></p>
<p class="edition" id="calibre_link-5566">names, <a href="#calibre_link-2092" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">182</a></p>
<p class="edition" id="calibre_link-5567">nesting</p>
<p class="edition" id="calibre_link-5568">filter contexts, <a href="#calibre_link-1874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">184</a>&ndash;<a href="#calibre_link-2045" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">185</a></p>
<p class="edition" id="calibre_link-5569">multiple rows, <a href="#calibre_link-1874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">184</a></p>
<p class="edition" id="calibre_link-5570">query variables, <a href="#calibre_link-1728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">397</a>&ndash;<a href="#calibre_link-1727" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">399</a></p>
<p class="edition" id="calibre_link-5571">scalar values, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a></p>
<p class="edition" id="calibre_link-5572">scope of, <a href="#calibre_link-2107" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">178</a>&ndash;<a href="#calibre_link-2095" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">180</a></p>
<p class="edition" id="calibre_link-5573">storing</p>
<p class="edition" id="calibre_link-5574">partial results of calculations, <a href="#calibre_link-2104" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">176</a>&ndash;<a href="#calibre_link-2105" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">177</a></p>
<p class="edition" id="calibre_link-5575">scalar values, <a href="#calibre_link-2104" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">176</a>, <a href="#calibre_link-2083" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">181</a></p>
<p class="edition" id="calibre_link-5576">tables, <a href="#calibre_link-2104" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">176</a>, <a href="#calibre_link-2083" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">181</a></p>
<p class="edition" id="calibre_link-5577">table variables, <a href="#calibre_link-2083" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">181</a>&ndash;<a href="#calibre_link-2092" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">182</a></p>
<p class="edition" id="calibre_link-5578">tables, storing, <a href="#calibre_link-2031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">58</a></p>
<p class="edition" id="calibre_link-5579">VAR syntax, <a href="#calibre_link-2106" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">175</a>&ndash;<a href="#calibre_link-2105" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">177</a></p>
<p class="edition" id="calibre_link-5580">VAR/RETURN blocks, <a href="#calibre_link-2106" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">175</a>&ndash;<a href="#calibre_link-2105" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">177</a>, <a href="#calibre_link-2095" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">180</a></p>
<p class="edition" id="calibre_link-5581">VAR/RETURN statements, nesting, <a href="#calibre_link-2094" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">179</a>&ndash;<a href="#calibre_link-2095" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">180</a></p>
<p class="edition" id="calibre_link-5582">Variant data type, <a href="#calibre_link-1766" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">22</a></p>
<p class="edition" id="calibre_link-5583">VertiPaq, <a href="#calibre_link-1978" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">546</a>, <a href="#calibre_link-1932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">547</a>&ndash;<a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a>, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a></p>
<p class="edition" id="calibre_link-5584">aggregations, <a href="#calibre_link-1662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">571</a>&ndash;<a href="#calibre_link-1989" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">573</a>, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a>&ndash;<a href="#calibre_link-1669" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">607</a></p>
<p class="edition" id="calibre_link-5585">caches, <a href="#calibre_link-1934" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">637</a>&ndash;<a href="#calibre_link-1860" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">640</a></p>
<p class="edition" id="calibre_link-5586">CallbackDataID function, <a href="#calibre_link-1860" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">640</a>&ndash;<a href="#calibre_link-1712" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">644</a></p>
<p class="edition" id="calibre_link-5587">columnar databases, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a>&ndash;<a href="#calibre_link-1877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">553</a></p>
<p class="edition" id="calibre_link-5588">compression, <a href="#calibre_link-1877" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">553</a>&ndash;<a href="#calibre_link-1891" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">554</a></p>
<p class="edition" id="calibre_link-5589">hash encoding, <a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a>&ndash;<a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a></p>
<p class="edition" id="calibre_link-5590">re-encoding, <a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-5591">RLE, <a href="#calibre_link-1893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">556</a>&ndash;<a href="#calibre_link-1894" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">559</a></p>
<p class="edition" id="calibre_link-5592">value encoding, <a href="#calibre_link-1891" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">554</a>&ndash;<a href="#calibre_link-1892" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">555</a></p>
<p class="edition" id="calibre_link-5593">data model optimization, <a href="#calibre_link-1925" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">579</a></p>
<p class="edition" id="calibre_link-5594">aggregations, <a href="#calibre_link-1663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">587</a>&ndash;<a href="#calibre_link-1664" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">588</a>, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a>&ndash;<a href="#calibre_link-1669" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">607</a></p>
<p class="edition" id="calibre_link-5595">calculated columns, <a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a>&ndash;<a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a></p>
<p class="edition" id="calibre_link-5596">choosing columns for storage, <a href="#calibre_link-1707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">599</a>&ndash;<a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a></p>
<p class="edition" id="calibre_link-5597">column cardinality, <a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a>&ndash;<a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a></p>
<p class="edition" id="calibre_link-5598">cross-filtering, <a href="#calibre_link-1869" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">590</a></p>
<p class="edition" id="calibre_link-5599">Date column, <a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a>&ndash;<a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a></p>
<p class="edition" id="calibre_link-5600">denormalizing data, <a href="#calibre_link-1926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">584</a>&ndash;<a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a></p>
<p class="edition" id="calibre_link-5601">disabling attribute hierarchies, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a></p>
<p class="edition" id="calibre_link-5602">gathering data model information, <a href="#calibre_link-1925" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">579</a>&ndash;<a href="#calibre_link-1926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">584</a></p>
<p class="edition" id="calibre_link-5603">optimizing column storage, <a href="#calibre_link-1880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">602</a>&ndash;<a href="#calibre_link-1865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">603</a></p>
<p class="edition" id="calibre_link-5604">optimizing drill-through attributes, <a href="#calibre_link-1668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">604</a></p>
<p class="edition" id="calibre_link-5605">relationship cardinality, <a href="#calibre_link-1868" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">586</a>&ndash;<a href="#calibre_link-1663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">587</a>, <a href="#calibre_link-1869" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">590</a>&ndash;<a href="#calibre_link-1863" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">591</a></p>
<p class="edition" id="calibre_link-5606">Time column, <a href="#calibre_link-1864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">592</a>&ndash;<a href="#calibre_link-1819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">595</a></p>
<p class="edition" id="calibre_link-5607">datacaches, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-5608">DMV, <a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a>&ndash;<a href="#calibre_link-1992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">565</a></p>
<p class="edition" id="calibre_link-5609">hardware selection, <a href="#calibre_link-1989" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">573</a></p>
<p class="edition" id="calibre_link-5610">best practices, <a href="#calibre_link-1985" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">577</a></p>
<p class="edition" id="calibre_link-5611">CPU model, <a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a>&ndash;<a href="#calibre_link-1914" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">575</a></p>
<p class="edition" id="calibre_link-5612">Disk I/O performance, <a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a>, <a href="#calibre_link-1910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">576</a>&ndash;<a href="#calibre_link-1985" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">577</a></p>
<p class="edition" id="calibre_link-5613">memory size, <a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a>, <a href="#calibre_link-1910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">576</a></p>
<p class="edition" id="calibre_link-5614">memory speed, <a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a>, <a href="#calibre_link-1914" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">575</a>&ndash;<a href="#calibre_link-1910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">576</a></p>
<p class="edition" id="calibre_link-5615">number of cores, <a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a>, <a href="#calibre_link-1910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">576</a></p>
<p class="edition" id="calibre_link-5616">as an option, <a href="#calibre_link-1989" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">573</a>&ndash;<a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a></p>
<p class="edition" id="calibre_link-5617">paging, <a href="#calibre_link-1910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">576</a>&ndash;<a href="#calibre_link-1985" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">577</a></p>
<p class="edition" id="calibre_link-5618">setting priorities, <a href="#calibre_link-1909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">574</a>&ndash;<a href="#calibre_link-1910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">576</a></p>
<p class="edition" id="calibre_link-5619">hierarchies, <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a></p>
<p class="edition" id="calibre_link-5620">materialization, <a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a>&ndash;<a href="#calibre_link-1662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">571</a></p>
<p class="edition" id="calibre_link-5621">multithreaded implementations, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-5622">partitioning, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-5623">processing tables, <a href="#calibre_link-1876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">550</a></p>
<p class="edition" id="calibre_link-5624">relationships (data models), <a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a>&ndash;<a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>, <a href="#calibre_link-1992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">565</a>&ndash;<a href="#calibre_link-1661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">568</a></p>
<p class="edition" id="calibre_link-5625">row-level security, <a href="#calibre_link-1996" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">639</a></p>
<p class="edition" id="calibre_link-5626">scan operations, <a href="#calibre_link-1929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">549</a></p>
<p class="edition" id="calibre_link-5627">segmentation, <a href="#calibre_link-1990" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">562</a>&ndash;<a href="#calibre_link-1991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">563</a></p>
<p class="edition" id="calibre_link-5628">sort orders, <a href="#calibre_link-1994" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">560</a>&ndash;<a href="#calibre_link-1993" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">561</a></p>
<p class="edition" id="calibre_link-5629">VertiPaq Analyzer</p>
<p class="edition" id="calibre_link-5630">columns (tables), <a href="#calibre_link-1886" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">580</a>&ndash;<a href="#calibre_link-1871" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">583</a></p>
<p class="edition" id="calibre_link-5631">gathering data model information, <a href="#calibre_link-1925" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">579</a>&ndash;<a href="#calibre_link-1926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">584</a></p>
<p class="edition" id="calibre_link-5632">VertiPaq Analyzer, Relationship reports, <a href="#calibre_link-1926" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">584</a></p>
<p class="edition" id="calibre_link-5633">VertiPaq mode, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a>&ndash;<a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a></p>
<p class="edition" id="calibre_link-5634">composite data models, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-5635">single data models, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-5636">VertiPaq SE queries, <a href="#calibre_link-2102" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">624</a></p>
<p class="edition" id="calibre_link-5637">composite data models, <a href="#calibre_link-1889" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">646</a>&ndash;<a href="#calibre_link-1665" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">647</a></p>
<p class="edition" id="calibre_link-5638">datacaches, parallelism and, <a href="#calibre_link-1933" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">635</a>&ndash;<a href="#calibre_link-1934" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">637</a></p>
<p class="edition" id="calibre_link-5639">DISTINCTCOUNT function, <a href="#calibre_link-1977" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">634</a>&ndash;<a href="#calibre_link-1933" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">635</a></p>
<p class="edition" id="calibre_link-5640">scan time, <a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a>&ndash;<a href="#calibre_link-1977" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">634</a></p>
<p class="edition" id="calibre_link-5641">xmSQL queries and, <a href="#calibre_link-2102" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">624</a></p>
<p class="edition" id="calibre_link-5642">aggregation functions, <a href="#calibre_link-1659" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">625</a>&ndash;<a href="#calibre_link-1660" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">627</a></p>
<p class="edition" id="calibre_link-5643">arithmetical operations, <a href="#calibre_link-1660" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">627</a></p>
<p class="edition" id="calibre_link-5644">batch events, <a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a>&ndash;<a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a></p>
<p class="edition" id="calibre_link-5645">filter operations, <a href="#calibre_link-2048" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">628</a>&ndash;<a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a></p>
<p class="edition" id="calibre_link-5646">join operators, <a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a></p>
<p class="edition" id="calibre_link-5647">VertiPaq SE Query Cache Match events (SQL Server Profiler), <a href="#calibre_link-2000" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">621</a></p>
<p class="edition" id="calibre_link-5648">VertiPaq SE Query End events (SQL Server Profiler), <a href="#calibre_link-2000" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">621</a></p>
<p class="edition" id="calibre_link-5649">virtual relationships, <a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a>, <a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5650">dynamic segmentation, <a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a>&ndash;<a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a></p>
<p class="edition" id="calibre_link-5651">physical relationships versus, <a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a>&ndash;<a href="#calibre_link-1753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">507</a></p>
<p class="edition" id="calibre_link-5652">transferring filters, <a href="#calibre_link-1774" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">480</a>&ndash;<a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a></p>
<p class="edition" id="calibre_link-5653">CALCULATE function, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a></p>
<p class="edition" id="calibre_link-5654">CONTAINS function, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a></p>
<p class="edition" id="calibre_link-5655">FILTER function, <a href="#calibre_link-1902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">481</a>&ndash;<a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a>&ndash;<a href="#calibre_link-1814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">485</a></p>
<p class="edition" id="calibre_link-5656">INTERSECT function, <a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>&ndash;<a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
<p class="edition" id="calibre_link-5657">TREATAS function, <a href="#calibre_link-1811" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">482</a>&ndash;<a href="#calibre_link-1812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">483</a>, <a href="#calibre_link-1813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">484</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-5658" class="h2a"><span type="pagebreak" id="calibre_link-5659"></span>W</h3>
<p class="edition" id="calibre_link-5660">weak relationships, <a href="#calibre_link-1641" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">2</a>, <a href="#calibre_link-1928" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">439</a>, <a href="#calibre_link-1890" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">488</a>, <a href="#calibre_link-1867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">489</a>, <a href="#calibre_link-2090" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">504</a>&ndash;<a href="#calibre_link-2091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">506</a></p>
<p class="edition" id="calibre_link-5661">weeks (custom calendars), time intelligence calculations, <a href="#calibre_link-1853" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">272</a>&ndash;<a href="#calibre_link-1856" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">275</a></p>
<p class="edition" id="calibre_link-5662">work days between two dates, computing, <a href="#calibre_link-1851" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">519</a>&ndash;<a href="#calibre_link-1693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">523</a></p>
<p class="edition" id="calibre_link-5663">nonworking days, <a href="#calibre_link-1693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">523</a>&ndash;<a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a></p>
<p class="edition" id="calibre_link-5664">precomputing values (calculations), <a href="#calibre_link-1694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">525</a>&ndash;<a href="#calibre_link-1771" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">527</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-5665" class="h2a">X</h3>
<p class="edition" id="calibre_link-5666">xmSQL</p>
<p class="edition" id="calibre_link-5667">CallbackDataID function</p>
<p class="edition" id="calibre_link-5668">parallelism and, <a href="#calibre_link-1859" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">641</a></p>
<p class="edition" id="calibre_link-5669">VertiPaq and, <a href="#calibre_link-1860" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">640</a>&ndash;<a href="#calibre_link-1712" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">644</a></p>
<p class="edition" id="calibre_link-5670">VertiPaq queries, <a href="#calibre_link-1667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">548</a></p>
<p class="edition" id="calibre_link-5671">xmSQL queries, <a href="#calibre_link-2102" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">624</a></p>
<p class="edition" id="calibre_link-5672">aggregation functions, <a href="#calibre_link-1659" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">625</a>&ndash;<a href="#calibre_link-1660" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">627</a></p>
<p class="edition" id="calibre_link-5673">arithmetic operations, <a href="#calibre_link-1660" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">627</a></p>
<p class="edition" id="calibre_link-5674">batch events, <a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a>&ndash;<a href="#calibre_link-1749" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">632</a></p>
<p class="edition" id="calibre_link-5675">filter operations, <a href="#calibre_link-2048" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">628</a>&ndash;<a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a></p>
<p class="edition" id="calibre_link-5676">join operators, <a href="#calibre_link-1748" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">630</a></p>
</section>
<section class="calibre4">
<h3 id="calibre_link-5677" class="h2a">Y</h3>
<p class="edition" id="calibre_link-5678">YOY (Year-Over-Year) calculation item, <a href="#calibre_link-1843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">289</a>&ndash;<a href="#calibre_link-1845" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">290</a></p>
<p class="edition" id="calibre_link-5679">YOY% (Year-Over-Year Percentage) calculation item, <a href="#calibre_link-1843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">289</a>&ndash;<a href="#calibre_link-1845" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">290</a></p>
<p class="edition" id="calibre_link-5680">YTD (Year-to-Date) calculations</p>
<p class="edition" id="calibre_link-5681">calculation group precedence, <a href="#calibre_link-1776" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">299</a>&ndash;<a href="#calibre_link-1921" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">303</a></p>
<p class="edition" id="calibre_link-5682">calculation items</p>
<p class="edition" id="calibre_link-5683">applying to expressions, <a href="#calibre_link-1841" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">294</a></p>
<p class="edition" id="calibre_link-5684">sideways recursion, <a href="#calibre_link-2100" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">307</a></p>
<p class="edition" id="calibre_link-5685">time intelligence calculations, <a href="#calibre_link-1942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">235</a>&ndash;<a href="#calibre_link-1958" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">236</a>, <a href="#calibre_link-1831" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">259</a>&ndash;<a href="#calibre_link-1945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">262</a>, <a href="#calibre_link-1854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">276</a>&ndash;<a href="#calibre_link-1855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">277</a><span type="pagebreak" id="calibre_link-5686"></span><span type="pagebreak" id="calibre_link-5687"></span></p>
</section>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2108">
<div id="calibre_link-5688" class="calibre2">
<div id="calibre_link-5689" class="calibre3"><section type="chapter" class="calibre4">
<figure class="image-l">
<img src="images/000326.jpg" alt="Image" class="calibre11" />
</figure>
<figure class="image-l">
<img src="images/000310.jpg" alt="Image" class="calibre11" />
</figure>
<p class="edition"><span type="pagebreak" id="calibre_link-5690"></span><strong class="calibre7">Marco Russo</strong> and <strong class="calibre7">Alberto Ferrari</strong> are the founders of sqlbi.com, where they regularly publish articles about Microsoft Power BI, Power Pivot, DAX, and SQL Server Analysis Services. They have worked with DAX since the first beta version of Power Pivot in 2009 and, during these years, sqlbi.com became one of the major sources for DAX articles and tutorials. Their courses, both in-person and online, are the major source of learning for many DAX enthusiasts.</p>
<p class="edition">They both provide consultancy and mentoring on business intelligence (BI) using Microsoft technologies. They have written several books and papers about Power BI, DAX, and Analysis Services. They constantly help the community of DAX users providing content for the websites daxpatterns.com, daxformatter.com, and dax.guide.</p>
<p class="edition">Marco and Alberto are also regular speakers at major international conferences, including Microsoft Ignite, PASS Summit, and SQLBits. Contact Marco at <a href="mailto:marco.russo@sqlbi.com" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">marco.russo@sqlbi.com</a>, and contact Alberto at <a href="mailto:alberto.ferrari@sqlbi.com" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8">alberto.ferrari@sqlbi.com</a></p>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2109">
<div id="calibre_link-5691" class="calibre2">
<div id="calibre_link-5692" class="calibre3"><section type="chapter" class="calibre4">
<h2 class="h2a" id="calibre_link-5693">Code Snippets</h2>
<p class="edition">Many titles include programming code or configuration examples. To optimize the presentation of these elements, view the eBook in single-column, landscape mode and adjust the font size to the smallest setting. In addition to presenting code and configurations in the reflowable text format, we have included images of the code that mimic the presentation found in the print book; therefore, where the reflowable format may compromise the presentation of the code listing, you will see a “Click here to view code image” link. Click the link to view the print-fidelity code image. To return to the previous page viewed, click the Back button on your device or app.</p>
<div class="image-p"><a href="#calibre_link-2110" id="calibre_link-360" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000857.jpg" alt="Image" class="calibre28" /></a></div>
<div class="image-p"><a href="#calibre_link-2111" id="calibre_link-361" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000865.jpg" alt="Image" class="calibre29" /></a></div>
<div class="image-p"><a href="#calibre_link-2112" id="calibre_link-363" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001043.jpg" alt="Image" class="calibre30" /></a></div>
<div class="image-p"><a href="#calibre_link-2113" id="calibre_link-364" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000105.jpg" alt="Image" class="calibre31" /></a></div>
<div class="image-p"><a href="#calibre_link-2114" id="calibre_link-365" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000258.jpg" alt="Image" class="calibre32" /></a></div>
<div class="image-p"><a href="#calibre_link-2115" id="calibre_link-366" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000266.jpg" alt="Image" class="calibre33" /></a></div>
<div class="image-p"><a href="#calibre_link-2116" id="calibre_link-367" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000542.jpg" alt="Image" class="calibre34" /></a></div>
<div class="image-p"><a href="#calibre_link-2117" id="calibre_link-368" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000549.jpg" alt="Image" class="calibre35" /></a></div>
<div class="image-p"><a href="#calibre_link-2118" id="calibre_link-369" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000777.jpg" alt="Image" class="calibre36" /></a></div>
<div class="image-p"><a href="#calibre_link-2119" id="calibre_link-370" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000784.jpg" alt="Image" class="calibre37" /></a></div>
<div class="image-p"><a href="#calibre_link-2120" id="calibre_link-371" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000078.jpg" alt="Image" class="calibre38" /></a></div>
<div class="image-p"><a href="#calibre_link-2121" id="calibre_link-372" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000086.jpg" alt="Image" class="calibre39" /></a></div>
<div class="image-p"><a href="#calibre_link-2122" id="calibre_link-373" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000360.jpg" alt="Image" class="calibre40" /></a></div>
<div class="image-p"><a href="#calibre_link-2123" id="calibre_link-374" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000367.jpg" alt="Image" class="calibre41" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2124">
<div id="calibre_link-5694" class="calibre2">
<div id="calibre_link-5695" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2125" id="calibre_link-376" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000114.jpg" alt="Image" class="calibre42" /></a></div>
<div class="image-p"><a href="#calibre_link-2126" id="calibre_link-377" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000122.jpg" alt="Image" class="calibre43" /></a></div>
<div class="image-p"><a href="#calibre_link-2127" id="calibre_link-378" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000130.jpg" alt="Image" class="calibre44" /></a></div>
<div class="image-p"><a href="#calibre_link-2128" id="calibre_link-381" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000434.jpg" alt="Image" class="calibre45" /></a></div>
<div class="image-p"><a href="#calibre_link-2129" id="calibre_link-382" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000767.jpg" alt="Image" class="calibre46" /></a></div>
<div class="image-p"><a href="#calibre_link-2130" id="calibre_link-383" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000875.jpg" alt="Image" class="calibre47" /></a></div>
<div class="image-p"><a href="#calibre_link-2131" id="calibre_link-384" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000867.jpg" alt="Image" class="calibre48" /></a></div>
<div class="image-p"><a href="#calibre_link-2132" id="calibre_link-386" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000997.jpg" alt="Image" class="calibre49" /></a></div>
<div class="image-p"><a href="#calibre_link-2133" id="calibre_link-387" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001022.jpg" alt="Image" class="calibre50" /></a></div>
<div class="image-p"><a href="#calibre_link-2134" id="calibre_link-388" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001137.jpg" alt="Image" class="calibre51" /></a></div>
<div class="image-p"><a href="#calibre_link-2135" id="calibre_link-389" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001130.jpg" alt="Image" class="calibre52" /></a></div>
<div class="image-p"><a href="#calibre_link-2136" id="calibre_link-390" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001151.jpg" alt="Image" class="calibre53" /></a></div>
<div class="image-p"><a href="#calibre_link-2137" id="calibre_link-391" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001144.jpg" alt="Image" class="calibre54" /></a></div>
<div class="image-p"><a href="#calibre_link-2138" id="calibre_link-392" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001166.jpg" alt="Image" class="calibre55" /></a></div>
<div class="image-p"><a href="#calibre_link-2139" id="calibre_link-393" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000083.jpg" alt="Image" class="calibre56" /></a></div>
<div class="image-p"><a href="#calibre_link-2140" id="calibre_link-394" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000075.jpg" alt="Image" class="calibre57" /></a></div>
<div class="image-p"><a href="#calibre_link-2141" id="calibre_link-396" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000203.jpg" alt="Image" class="calibre58" /></a></div>
<div class="image-p"><a href="#calibre_link-2142" id="calibre_link-397" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000220.jpg" alt="Image" class="calibre56" /></a></div>
<div class="image-p"><a href="#calibre_link-2143" id="calibre_link-400" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000268.jpg" alt="Image" class="calibre59" /></a></div>
<div class="image-p"><a href="#calibre_link-2144" id="calibre_link-402" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000543.jpg" alt="Image" class="calibre28" /></a></div>
<div class="image-p"><a href="#calibre_link-2145" id="calibre_link-403" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000550.jpg" alt="Image" class="calibre60" /></a></div>
<div class="image-p"><a href="#calibre_link-2146" id="calibre_link-404" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000557.jpg" alt="Image" class="calibre61" /></a></div>
<div class="image-p"><a href="#calibre_link-2147" id="calibre_link-405" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000648.jpg" alt="Image" class="calibre62" /></a></div>
<div class="image-p"><a href="#calibre_link-2148" id="calibre_link-406" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000722.jpg" alt="Image" class="calibre63" /></a></div>
<div class="image-p"><a href="#calibre_link-2149" id="calibre_link-408" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000842.jpg" alt="Image" class="calibre64" /></a></div>
<div class="image-p"><a href="#calibre_link-2150" id="calibre_link-409" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000849.jpg" alt="Image" class="calibre65" /></a></div>
<div class="image-p"><a href="#calibre_link-2151" id="calibre_link-410" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000917.jpg" alt="Image" class="calibre66" /></a></div>
<div class="image-p"><a href="#calibre_link-2152" id="calibre_link-411" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000924.jpg" alt="Image" class="calibre67" /></a></div>
<div class="image-p"><a href="#calibre_link-2153" id="calibre_link-412" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000931.jpg" alt="Image" class="calibre68" /></a></div>
<div class="image-p"><a href="#calibre_link-2154" id="calibre_link-413" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000938.jpg" alt="Image" class="calibre69" /></a></div>
<div class="image-p"><a href="#calibre_link-2155" id="calibre_link-414" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000945.jpg" alt="Image" class="calibre70" /></a></div>
<div class="image-p"><a href="#calibre_link-2156" id="calibre_link-415" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000994.jpg" alt="Image" class="calibre71" /></a></div>
<div class="image-p"><a href="#calibre_link-2157" id="calibre_link-416" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001098.jpg" alt="Image" class="calibre72" /></a></div>
<div class="image-p"><a href="#calibre_link-2158" id="calibre_link-417" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001105.jpg" alt="Image" class="calibre73" /></a></div>
<div class="image-p"><a href="#calibre_link-2159" id="calibre_link-418" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001231.jpg" alt="Image" class="calibre74" /></a></div>
<div class="image-p"><a href="#calibre_link-2160" id="calibre_link-419" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001064.jpg" alt="Image" class="calibre75" /></a></div>
<div class="image-p"><a href="#calibre_link-2161" id="calibre_link-420" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001071.jpg" alt="Image" class="calibre76" /></a></div>
<div class="image-p"><a href="#calibre_link-2162" id="calibre_link-421" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001170.jpg" alt="Image" class="calibre77" /></a></div>
<div class="image-p"><a href="#calibre_link-2163" id="calibre_link-422" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001177.jpg" alt="Image" class="calibre78" /></a></div>
<div class="image-p"><a href="#calibre_link-2164" id="calibre_link-423" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001184.jpg" alt="Image" class="calibre79" /></a></div>
<div class="image-p"><a href="#calibre_link-2165" id="calibre_link-424" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000911.jpg" alt="Image" class="calibre80" /></a></div>
<div class="image-p"><a href="#calibre_link-2166" id="calibre_link-425" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000293.jpg" alt="Image" class="calibre81" /></a></div>
<div class="image-p"><a href="#calibre_link-2167" id="calibre_link-426" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000175.jpg" alt="Image" class="calibre82" /></a></div>
<div class="image-p"><a href="#calibre_link-2168" id="calibre_link-427" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000183.jpg" alt="Image" class="calibre83" /></a></div>
<div class="image-p"><a href="#calibre_link-2169" id="calibre_link-429" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000248.jpg" alt="Image" class="calibre57" /></a></div>
<div class="image-p"><a href="#calibre_link-2170" id="calibre_link-430" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000345.jpg" alt="Image" class="calibre84" /></a></div>
<div class="image-p"><a href="#calibre_link-2171" id="calibre_link-432" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000353.jpg" alt="Image" class="calibre85" /></a></div>
<div class="image-p"><a href="#calibre_link-2172" id="calibre_link-433" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000440.jpg" alt="Image" class="calibre86" /></a></div>
<div class="image-p"><a href="#calibre_link-2173" id="calibre_link-434" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000583.jpg" alt="Image" class="calibre87" /></a></div>
<div class="image-p"><a href="#calibre_link-2174" id="calibre_link-435" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000590.jpg" alt="Image" class="calibre88" /></a></div>
<div class="image-p"><a href="#calibre_link-2175" id="calibre_link-436" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000597.jpg" alt="Image" class="calibre89" /></a></div>
<div class="image-p"><a href="#calibre_link-2176" id="calibre_link-437" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000013.jpg" alt="Image" class="calibre90" /></a></div>
<div class="image-p"><a href="#calibre_link-2177" id="calibre_link-438" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000677.jpg" alt="Image" class="calibre91" /></a></div>
<div class="image-p"><a href="#calibre_link-2178" id="calibre_link-439" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000712.jpg" alt="Image" class="calibre92" /></a></div>
<div class="image-p"><a href="#calibre_link-2179" id="calibre_link-441" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000719.jpg" alt="Image" class="calibre93" /></a></div>
<div class="image-p"><a href="#calibre_link-2180" id="calibre_link-443" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000747.jpg" alt="Image" class="calibre94" /></a></div>
<div class="image-p"><a href="#calibre_link-2181" id="calibre_link-444" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000797.jpg" alt="Image" class="calibre95" /></a></div>
<div class="image-p"><a href="#calibre_link-2182" id="calibre_link-445" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000804.jpg" alt="Image" class="calibre96" /></a></div>
<div class="image-p"><a href="#calibre_link-2183" id="calibre_link-447" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000907.jpg" alt="Image" class="calibre97" /></a></div>
<div class="image-p"><a href="#calibre_link-2184" id="calibre_link-449" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000984.jpg" alt="Image" class="calibre98" /></a></div>
<div class="image-p"><a href="#calibre_link-2185" id="calibre_link-450" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000991.jpg" alt="Image" class="calibre99" /></a></div>
<div class="image-p"><a href="#calibre_link-2186" id="calibre_link-452" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001197.jpg" alt="Image" class="calibre100" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2187">
<div id="calibre_link-5696" class="calibre2">
<div id="calibre_link-5697" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2188" id="calibre_link-455" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000035.jpg" alt="Image" class="calibre101" /></a></div>
<div class="image-p"><a href="#calibre_link-2189" id="calibre_link-456" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000042.jpg" alt="Image" class="calibre102" /></a></div>
<div class="image-p"><a href="#calibre_link-2190" id="calibre_link-457" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000064.jpg" alt="Image" class="calibre103" /></a></div>
<div class="image-p"><a href="#calibre_link-2191" id="calibre_link-458" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000072.jpg" alt="Image" class="calibre104" /></a></div>
<div class="image-p"><a href="#calibre_link-2192" id="calibre_link-459" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000080.jpg" alt="Image" class="calibre105" /></a></div>
<div class="image-p"><a href="#calibre_link-2193" id="calibre_link-460" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000176.jpg" alt="Image" class="calibre106" /></a></div>
<div class="image-p"><a href="#calibre_link-2194" id="calibre_link-461" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000184.jpg" alt="Image" class="calibre107" /></a></div>
<div class="image-p"><a href="#calibre_link-2195" id="calibre_link-462" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000192.jpg" alt="Image" class="calibre108" /></a></div>
<div class="image-p"><a href="#calibre_link-2196" id="calibre_link-463" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000262.jpg" alt="Image" class="calibre109" /></a></div>
<div class="image-p"><a href="#calibre_link-2197" id="calibre_link-465" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000273.jpg" alt="Image" class="calibre110" /></a></div>
<div class="image-p"><a href="#calibre_link-2198" id="calibre_link-466" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000330.jpg" alt="Image" class="calibre111" /></a></div>
<div class="image-p"><a href="#calibre_link-2199" id="calibre_link-467" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000338.jpg" alt="Image" class="calibre112" /></a></div>
<div class="image-p"><a href="#calibre_link-2200" id="calibre_link-468" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000346.jpg" alt="Image" class="calibre113" /></a></div>
<div class="image-p"><a href="#calibre_link-2201" id="calibre_link-470" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000548.jpg" alt="Image" class="calibre114" /></a></div>
<div class="image-p"><a href="#calibre_link-2202" id="calibre_link-471" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000551.jpg" alt="Image" class="calibre115" /></a></div>
<div class="image-p"><a href="#calibre_link-2203" id="calibre_link-472" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000621.jpg" alt="Image" class="calibre116" /></a></div>
<div class="image-p"><a href="#calibre_link-2204" id="calibre_link-473" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000628.jpg" alt="Image" class="calibre117" /></a></div>
<div class="image-p"><a href="#calibre_link-2205" id="calibre_link-474" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000635.jpg" alt="Image" class="calibre111" /></a></div>
<div class="image-p"><a href="#calibre_link-2206" id="calibre_link-476" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000748.jpg" alt="Image" class="calibre100" /></a></div>
<div class="image-p"><a href="#calibre_link-2207" id="calibre_link-477" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000755.jpg" alt="Image" class="calibre118" /></a></div>
<div class="image-p"><a href="#calibre_link-2208" id="calibre_link-478" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000762.jpg" alt="Image" class="calibre119" /></a></div>
<div class="image-p"><a href="#calibre_link-2209" id="calibre_link-480" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000769.jpg" alt="Image" class="calibre120" /></a></div>
<div class="image-p"><a href="#calibre_link-2210" id="calibre_link-483" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000833.jpg" alt="Image" class="calibre121" /></a></div>
<div class="image-p"><a href="#calibre_link-2211" id="calibre_link-484" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000922.jpg" alt="Image" class="calibre122" /></a></div>
<div class="image-p"><a href="#calibre_link-2212" id="calibre_link-485" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001031.jpg" alt="Image" class="calibre123" /></a></div>
<div class="image-p"><a href="#calibre_link-2213" id="calibre_link-487" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001110.jpg" alt="Image" class="calibre124" /></a></div>
<div class="image-p"><a href="#calibre_link-2214" id="calibre_link-490" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001193.jpg" alt="Image" class="calibre125" /></a></div>
<div class="image-p"><a href="#calibre_link-2215" id="calibre_link-492" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000046.jpg" alt="Image" class="calibre126" /></a></div>
<div class="image-p"><a href="#calibre_link-2216" id="calibre_link-494" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000053.jpg" alt="Image" class="calibre127" /></a></div>
<div class="image-p"><a href="#calibre_link-2217" id="calibre_link-496" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000060.jpg" alt="Image" class="calibre128" /></a></div>
<div class="image-p"><a href="#calibre_link-2218" id="calibre_link-497" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000068.jpg" alt="Image" class="calibre129" /></a></div>
<div class="image-p"><a href="#calibre_link-2219" id="calibre_link-499" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000076.jpg" alt="Image" class="calibre130" /></a></div>
<div class="image-p"><a href="#calibre_link-2220" id="calibre_link-501" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000084.jpg" alt="Image" class="calibre131" /></a></div>
<div class="image-p"><a href="#calibre_link-2221" id="calibre_link-502" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000092.jpg" alt="Image" class="calibre132" /></a></div>
<div class="image-p"><a href="#calibre_link-2222" id="calibre_link-503" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000100.jpg" alt="Image" class="calibre133" /></a></div>
<div class="image-p"><a href="#calibre_link-2223" id="calibre_link-505" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000108.jpg" alt="Image" class="calibre134" /></a></div>
<div class="image-p"><a href="#calibre_link-2224" id="calibre_link-508" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000116.jpg" alt="Image" class="calibre135" /></a></div>
<div class="image-p"><a href="#calibre_link-2225" id="calibre_link-510" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000124.jpg" alt="Image" class="calibre136" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2226">
<div id="calibre_link-5698" class="calibre2">
<div id="calibre_link-5699" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2227" id="calibre_link-513" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000132.jpg" alt="Image" class="calibre102" /></a></div>
<div class="image-p"><a href="#calibre_link-2228" id="calibre_link-520" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000140.jpg" alt="Image" class="calibre102" /></a></div>
<div class="image-p"><a href="#calibre_link-2229" id="calibre_link-521" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000148.jpg" alt="Image" class="calibre137" /></a></div>
<div class="image-p"><a href="#calibre_link-2230" id="calibre_link-522" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000156.jpg" alt="Image" class="calibre95" /></a></div>
<div class="image-p"><a href="#calibre_link-2231" id="calibre_link-523" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000164.jpg" alt="Image" class="calibre138" /></a></div>
<div class="image-p"><a href="#calibre_link-2232" id="calibre_link-524" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000172.jpg" alt="Image" class="calibre139" /></a></div>
<div class="image-p"><a href="#calibre_link-2233" id="calibre_link-526" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000180.jpg" alt="Image" class="calibre140" /></a></div>
<div class="image-p"><a href="#calibre_link-2234" id="calibre_link-527" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000188.jpg" alt="Image" class="calibre141" /></a></div>
<div class="image-p"><a href="#calibre_link-2235" id="calibre_link-528" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000196.jpg" alt="Image" class="calibre142" /></a></div>
<div class="image-p"><a href="#calibre_link-2236" id="calibre_link-529" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000204.jpg" alt="Image" class="calibre143" /></a></div>
<div class="image-p"><a href="#calibre_link-2237" id="calibre_link-531" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000212.jpg" alt="Image" class="calibre144" /></a></div>
<div class="image-p"><a href="#calibre_link-2238" id="calibre_link-532" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000221.jpg" alt="Image" class="calibre145" /></a></div>
<div class="image-p"><a href="#calibre_link-2239" id="calibre_link-533" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000229.jpg" alt="Image" class="calibre146" /></a></div>
<div class="image-p"><a href="#calibre_link-2240" id="calibre_link-534" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000237.jpg" alt="Image" class="calibre147" /></a></div>
<div class="image-p"><a href="#calibre_link-2241" id="calibre_link-535" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000245.jpg" alt="Image" class="calibre148" /></a></div>
<div class="image-p"><a href="#calibre_link-2242" id="calibre_link-536" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000253.jpg" alt="Image" class="calibre149" /></a></div>
<div class="image-p"><a href="#calibre_link-2243" id="calibre_link-538" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000261.jpg" alt="Image" class="calibre150" /></a></div>
<div class="image-p"><a href="#calibre_link-2244" id="calibre_link-540" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000269.jpg" alt="Image" class="calibre151" /></a></div>
<div class="image-p"><a href="#calibre_link-2245" id="calibre_link-541" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000277.jpg" alt="Image" class="calibre152" /></a></div>
<div class="image-p"><a href="#calibre_link-2246" id="calibre_link-544" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000285.jpg" alt="Image" class="calibre152" /></a></div>
<div class="image-p"><a href="#calibre_link-2247" id="calibre_link-546" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000294.jpg" alt="Image" class="calibre153" /></a></div>
<div class="image-p"><a href="#calibre_link-2248" id="calibre_link-547" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000302.jpg" alt="Image" class="calibre154" /></a></div>
<div class="image-p"><a href="#calibre_link-2249" id="calibre_link-550" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000274.jpg" alt="Image" class="calibre154" /></a></div>
<div class="image-p"><a href="#calibre_link-2250" id="calibre_link-553" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000282.jpg" alt="Image" class="calibre155" /></a></div>
<div class="image-p"><a href="#calibre_link-2251" id="calibre_link-554" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000290.jpg" alt="Image" class="calibre156" /></a></div>
<div class="image-p"><a href="#calibre_link-2252" id="calibre_link-555" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000299.jpg" alt="Image" class="calibre157" /></a></div>
<div class="image-p"><a href="#calibre_link-2253" id="calibre_link-557" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000307.jpg" alt="Image" class="calibre158" /></a></div>
<div class="image-p"><a href="#calibre_link-2254" id="calibre_link-558" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000315.jpg" alt="Image" class="calibre159" /></a></div>
<div class="image-p"><a href="#calibre_link-2255" id="calibre_link-559" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000323.jpg" alt="Image" class="calibre160" /></a></div>
<div class="image-p"><a href="#calibre_link-2256" id="calibre_link-562" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000331.jpg" alt="Image" class="calibre161" /></a></div>
<div class="image-p"><a href="#calibre_link-2257" id="calibre_link-565" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000339.jpg" alt="Image" class="calibre55" /></a></div>
<div class="image-p"><a href="#calibre_link-2258" id="calibre_link-568" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000556.jpg" alt="Image" class="calibre162" /></a></div>
<div class="image-p"><a href="#calibre_link-2259" id="calibre_link-569" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000563.jpg" alt="Image" class="calibre163" /></a></div>
<div class="image-p"><a href="#calibre_link-2260" id="calibre_link-571" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000570.jpg" alt="Image" class="calibre164" /></a></div>
<div class="image-p"><a href="#calibre_link-2261" id="calibre_link-573" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000577.jpg" alt="Image" class="calibre165" /></a></div>
<div class="image-p"><a href="#calibre_link-2262" id="calibre_link-574" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000584.jpg" alt="Image" class="calibre166" /></a></div>
<div class="image-p"><a href="#calibre_link-2263" id="calibre_link-575" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000591.jpg" alt="Image" class="calibre167" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2264">
<div id="calibre_link-5700" class="calibre2">
<div id="calibre_link-5701" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2265" id="calibre_link-577" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000598.jpg" alt="Image" class="calibre168" /></a></div>
<div class="image-p"><a href="#calibre_link-2266" id="calibre_link-580" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000605.jpg" alt="Image" class="calibre169" /></a></div>
<div class="image-p"><a href="#calibre_link-2267" id="calibre_link-581" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000612.jpg" alt="Image" class="calibre170" /></a></div>
<div class="image-p"><a href="#calibre_link-2268" id="calibre_link-583" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000619.jpg" alt="Image" class="calibre171" /></a></div>
<div class="image-p"><a href="#calibre_link-2269" id="calibre_link-584" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000626.jpg" alt="Image" class="calibre172" /></a></div>
<div class="image-p"><a href="#calibre_link-2270" id="calibre_link-585" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000633.jpg" alt="Image" class="calibre171" /></a></div>
<div class="image-p"><a href="#calibre_link-2271" id="calibre_link-586" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000640.jpg" alt="Image" class="calibre173" /></a></div>
<div class="image-p"><a href="#calibre_link-2272" id="calibre_link-587" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000791.jpg" alt="Image" class="calibre174" /></a></div>
<div class="image-p"><a href="#calibre_link-2273" id="calibre_link-588" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000799.jpg" alt="Image" class="calibre175" /></a></div>
<div class="image-p"><a href="#calibre_link-2274" id="calibre_link-593" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000806.jpg" alt="Image" class="calibre176" /></a></div>
<div class="image-p"><a href="#calibre_link-2275" id="calibre_link-594" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000813.jpg" alt="Image" class="calibre177" /></a></div>
<div class="image-p"><a href="#calibre_link-2276" id="calibre_link-596" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000820.jpg" alt="Image" class="calibre178" /></a></div>
<div class="image-p"><a href="#calibre_link-2277" id="calibre_link-598" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000827.jpg" alt="Image" class="calibre179" /></a></div>
<div class="image-p"><a href="#calibre_link-2278" id="calibre_link-602" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000834.jpg" alt="Image" class="calibre180" /></a></div>
<div class="image-p"><a href="#calibre_link-2279" id="calibre_link-604" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000841.jpg" alt="Image" class="calibre181" /></a></div>
<div class="image-p"><a href="#calibre_link-2280" id="calibre_link-607" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001016.jpg" alt="Image" class="calibre182" /></a></div>
<div class="image-p"><a href="#calibre_link-2281" id="calibre_link-609" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001024.jpg" alt="Image" class="calibre183" /></a></div>
<div class="image-p"><a href="#calibre_link-2282" id="calibre_link-611" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001032.jpg" alt="Image" class="calibre184" /></a></div>
<div class="image-p"><a href="#calibre_link-2283" id="calibre_link-614" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001039.jpg" alt="Image" class="calibre185" /></a></div>
<div class="image-p"><a href="#calibre_link-2284" id="calibre_link-616" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001047.jpg" alt="Image" class="calibre186" /></a></div>
<div class="image-p"><a href="#calibre_link-2285" id="calibre_link-619" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001055.jpg" alt="Image" class="calibre187" /></a></div>
<div class="image-p"><a href="#calibre_link-2286" id="calibre_link-621" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001062.jpg" alt="Image" class="calibre188" /></a></div>
<div class="image-p"><a href="#calibre_link-2287" id="calibre_link-622" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001069.jpg" alt="Image" class="calibre189" /></a></div>
<div class="image-p"><a href="#calibre_link-2288" id="calibre_link-623" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001076.jpg" alt="Image" class="calibre190" /></a></div>
<div class="image-p"><a href="#calibre_link-2289" id="calibre_link-624" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001083.jpg" alt="Image" class="calibre191" /></a></div>
<div class="image-p"><a href="#calibre_link-2290" id="calibre_link-625" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000094.jpg" alt="Image" class="calibre192" /></a></div>
<div class="image-p"><a href="#calibre_link-2291" id="calibre_link-626" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000102.jpg" alt="Image" class="calibre193" /></a></div>
<div class="image-p"><a href="#calibre_link-2292" id="calibre_link-627" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000110.jpg" alt="Image" class="calibre194" /></a></div>
<div class="image-p"><a href="#calibre_link-2293" id="calibre_link-631" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000118.jpg" alt="Image" class="calibre195" /></a></div>
<div class="image-p"><a href="#calibre_link-2294" id="calibre_link-632" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000126.jpg" alt="Image" class="calibre196" /></a></div>
<div class="image-p"><a href="#calibre_link-2295" id="calibre_link-634" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000134.jpg" alt="Image" class="calibre194" /></a></div>
<div class="image-p"><a href="#calibre_link-2296" id="calibre_link-635" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000142.jpg" alt="Image" class="calibre197" /></a></div>
<div class="image-p"><a href="#calibre_link-2297" id="calibre_link-636" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000150.jpg" alt="Image" class="calibre198" /></a></div>
<div class="image-p"><a href="#calibre_link-2297" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000158.jpg" alt="Image" class="calibre199" /></a></div>
<div class="image-p"><a href="#calibre_link-2298" id="calibre_link-637" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000166.jpg" alt="Image" class="calibre200" /></a></div>
<div class="image-p"><a href="#calibre_link-2299" id="calibre_link-638" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000174.jpg" alt="Image" class="calibre201" /></a></div>
<div class="image-p"><a href="#calibre_link-2300" id="calibre_link-640" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000182.jpg" alt="Image" class="calibre202" /></a></div>
<div class="image-p"><a href="#calibre_link-2301" id="calibre_link-642" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000190.jpg" alt="Image" class="calibre203" /></a></div>
<div class="image-p"><a href="#calibre_link-2302" id="calibre_link-645" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000198.jpg" alt="Image" class="calibre204" /></a></div>
<div class="image-p"><a href="#calibre_link-2303" id="calibre_link-647" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000374.jpg" alt="Image" class="calibre205" /></a></div>
<div class="image-p"><a href="#calibre_link-2304" id="calibre_link-649" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000383.jpg" alt="Image" class="calibre105" /></a></div>
<div class="image-p"><a href="#calibre_link-2305" id="calibre_link-650" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000390.jpg" alt="Image" class="calibre206" /></a></div>
<div class="image-p"><a href="#calibre_link-2306" id="calibre_link-651" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000397.jpg" alt="Image" class="calibre207" /></a></div>
<div class="image-p"><a href="#calibre_link-2307" id="calibre_link-653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000405.jpg" alt="Image" class="calibre208" /></a></div>
<div class="image-p"><a href="#calibre_link-2308" id="calibre_link-654" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000412.jpg" alt="Image" class="calibre209" /></a></div>
<div class="image-p"><a href="#calibre_link-2309" id="calibre_link-656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000420.jpg" alt="Image" class="calibre210" /></a></div>
<div class="image-p"><a href="#calibre_link-2310" id="calibre_link-658" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000430.jpg" alt="Image" class="calibre211" /></a></div>
<div class="image-p"><a href="#calibre_link-2311" id="calibre_link-659" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000438.jpg" alt="Image" class="calibre212" /></a></div>
<div class="image-p"><a href="#calibre_link-2312" id="calibre_link-660" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000445.jpg" alt="Image" class="calibre213" /></a></div>
<div class="image-p"><a href="#calibre_link-2313" id="calibre_link-661" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000452.jpg" alt="Image" class="calibre214" /></a></div>
<div class="image-p"><a href="#calibre_link-2314" id="calibre_link-662" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000459.jpg" alt="Image" class="calibre215" /></a></div>
<div class="image-p"><a href="#calibre_link-2315" id="calibre_link-663" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000731.jpg" alt="Image" class="calibre216" /></a></div>
<div class="image-p"><a href="#calibre_link-2316" id="calibre_link-664" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000738.jpg" alt="Image" class="calibre217" /></a></div>
<div class="image-p"><a href="#calibre_link-2317" id="calibre_link-665" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000745.jpg" alt="Image" class="calibre218" /></a></div>
<div class="image-p"><a href="#calibre_link-2318" id="calibre_link-666" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000752.jpg" alt="Image" class="calibre119" /></a></div>
<div class="image-p"><a href="#calibre_link-2319" id="calibre_link-667" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000759.jpg" alt="Image" class="calibre219" /></a></div>
<div class="image-p"><a href="#calibre_link-2320" id="calibre_link-668" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000766.jpg" alt="Image" class="calibre220" /></a></div>
<div class="image-p"><a href="#calibre_link-2321" id="calibre_link-669" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000773.jpg" alt="Image" class="calibre221" /></a></div>
<div class="image-p"><a href="#calibre_link-2322" id="calibre_link-670" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000780.jpg" alt="Image" class="calibre222" /></a></div>
<div class="image-p"><a href="#calibre_link-2323" id="calibre_link-671" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000787.jpg" alt="Image" class="calibre223" /></a></div>
<div class="image-p"><a href="#calibre_link-2324" id="calibre_link-673" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000795.jpg" alt="Image" class="calibre224" /></a></div>
<div class="image-p"><a href="#calibre_link-2325" id="calibre_link-675" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000802.jpg" alt="Image" class="calibre225" /></a></div>
<div class="image-p"><a href="#calibre_link-2326" id="calibre_link-676" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000809.jpg" alt="Image" class="calibre226" /></a></div>
<div class="image-p"><a href="#calibre_link-2327" id="calibre_link-677" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000816.jpg" alt="Image" class="calibre227" /></a></div>
<div class="image-p"><a href="#calibre_link-2328" id="calibre_link-678" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000823.jpg" alt="Image" class="calibre228" /></a></div>
<div class="image-p"><a href="#calibre_link-2329" id="calibre_link-679" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000830.jpg" alt="Image" class="calibre229" /></a></div>
<div class="image-p"><a href="#calibre_link-2330" id="calibre_link-680" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000837.jpg" alt="Image" class="calibre230" /></a></div>
<div class="image-p"><a href="#calibre_link-2331" id="calibre_link-681" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000844.jpg" alt="Image" class="calibre231" /></a></div>
<div class="image-p"><a href="#calibre_link-2332" id="calibre_link-684" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000954.jpg" alt="Image" class="calibre232" /></a></div>
<div class="image-p"><a href="#calibre_link-2333" id="calibre_link-685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000961.jpg" alt="Image" class="calibre233" /></a></div>
<div class="image-p"><a href="#calibre_link-2334" id="calibre_link-686" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000968.jpg" alt="Image" class="calibre234" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2335">
<div id="calibre_link-5702" class="calibre2">
<div id="calibre_link-5703" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2336" id="calibre_link-688" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000975.jpg" alt="Image" class="calibre235" /></a></div>
<div class="image-p"><a href="#calibre_link-2337" id="calibre_link-689" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000982.jpg" alt="Image" class="calibre236" /></a></div>
<div class="image-p"><a href="#calibre_link-2338" id="calibre_link-690" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000989.jpg" alt="Image" class="calibre237" /></a></div>
<div class="image-p"><a href="#calibre_link-2339" id="calibre_link-691" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000996.jpg" alt="Image" class="calibre238" /></a></div>
<div class="image-p"><a href="#calibre_link-2340" id="calibre_link-692" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001004.jpg" alt="Image" class="calibre239" /></a></div>
<div class="image-p"><a href="#calibre_link-2341" id="calibre_link-693" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001012.jpg" alt="Image" class="calibre240" /></a></div>
<div class="image-p"><a href="#calibre_link-2342" id="calibre_link-694" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001021.jpg" alt="Image" class="calibre241" /></a></div>
<div class="image-p"><a href="#calibre_link-2343" id="calibre_link-695" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001028.jpg" alt="Image" class="calibre242" /></a></div>
<div class="image-p"><a href="#calibre_link-2344" id="calibre_link-696" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001036.jpg" alt="Image" class="calibre243" /></a></div>
<div class="image-p"><a href="#calibre_link-2345" id="calibre_link-697" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001044.jpg" alt="Image" class="calibre244" /></a></div>
<div class="image-p"><a href="#calibre_link-2346" id="calibre_link-698" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001052.jpg" alt="Image" class="calibre245" /></a></div>
<div class="image-p"><a href="#calibre_link-2347" id="calibre_link-699" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001059.jpg" alt="Image" class="calibre246" /></a></div>
<div class="image-p"><a href="#calibre_link-2348" id="calibre_link-700" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001173.jpg" alt="Image" class="calibre247" /></a></div>
<div class="image-p"><a href="#calibre_link-2349" id="calibre_link-701" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001180.jpg" alt="Image" class="calibre248" /></a></div>
<div class="image-p"><a href="#calibre_link-2350" id="calibre_link-702" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001187.jpg" alt="Image" class="calibre249" /></a></div>
<div class="image-p"><a href="#calibre_link-2351" id="calibre_link-703" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001195.jpg" alt="Image" class="calibre250" /></a></div>
<div class="image-p"><a href="#calibre_link-2352" id="calibre_link-704" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001203.jpg" alt="Image" class="calibre251" /></a></div>
<div class="image-p"><a href="#calibre_link-2353" id="calibre_link-705" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001210.jpg" alt="Image" class="calibre252" /></a></div>
<div class="image-p"><a href="#calibre_link-2354" id="calibre_link-706" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001218.jpg" alt="Image" class="calibre253" /></a></div>
<div class="image-p"><a href="#calibre_link-2355" id="calibre_link-707" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001226.jpg" alt="Image" class="calibre254" /></a></div>
<div class="image-p"><a href="#calibre_link-2356" id="calibre_link-708" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001235.jpg" alt="Image" class="calibre255" /></a></div>
<div class="image-p"><a href="#calibre_link-2357" id="calibre_link-709" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001242.jpg" alt="Image" class="calibre256" /></a></div>
<div class="image-p"><a href="#calibre_link-2358" id="calibre_link-710" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001251.jpg" alt="Image" class="calibre257" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2359">
<div id="calibre_link-5704" class="calibre2">
<div id="calibre_link-5705" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2360" id="calibre_link-712" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001259.jpg" alt="Image" class="calibre164" /></a></div>
<div class="image-p"><a href="#calibre_link-2361" id="calibre_link-713" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000001.jpg" alt="Image" class="calibre258" /></a></div>
<div class="image-p"><a href="#calibre_link-2362" id="calibre_link-714" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000008.jpg" alt="Image" class="calibre259" /></a></div>
<div class="image-p"><a href="#calibre_link-2363" id="calibre_link-715" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000015.jpg" alt="Image" class="calibre260" /></a></div>
<div class="image-p"><a href="#calibre_link-2364" id="calibre_link-716" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000023.jpg" alt="Image" class="calibre261" /></a></div>
<div class="image-p"><a href="#calibre_link-2365" id="calibre_link-717" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000030.jpg" alt="Image" class="calibre262" /></a></div>
<div class="image-p"><a href="#calibre_link-2366" id="calibre_link-718" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000005.jpg" alt="Image" class="calibre263" /></a></div>
<div class="image-p"><a href="#calibre_link-2367" id="calibre_link-719" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000138.jpg" alt="Image" class="calibre264" /></a></div>
<div class="image-p"><a href="#calibre_link-2368" id="calibre_link-720" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000146.jpg" alt="Image" class="calibre265" /></a></div>
<div class="image-p"><a href="#calibre_link-2369" id="calibre_link-721" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000154.jpg" alt="Image" class="calibre266" /></a></div>
<div class="image-p"><a href="#calibre_link-2370" id="calibre_link-723" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000162.jpg" alt="Image" class="calibre267" /></a></div>
<div class="image-p"><a href="#calibre_link-2371" id="calibre_link-725" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000170.jpg" alt="Image" class="calibre268" /></a></div>
<div class="image-p"><a href="#calibre_link-2372" id="calibre_link-728" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000178.jpg" alt="Image" class="calibre269" /></a></div>
<div class="image-p"><a href="#calibre_link-2373" id="calibre_link-729" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000186.jpg" alt="Image" class="calibre270" /></a></div>
<div class="image-p"><a href="#calibre_link-2374" id="calibre_link-731" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000194.jpg" alt="Image" class="calibre271" /></a></div>
<div class="image-p"><a href="#calibre_link-2375" id="calibre_link-733" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000202.jpg" alt="Image" class="calibre272" /></a></div>
<div class="image-p"><a href="#calibre_link-2376" id="calibre_link-734" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000210.jpg" alt="Image" class="calibre273" /></a></div>
<div class="image-p"><a href="#calibre_link-2377" id="calibre_link-735" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000219.jpg" alt="Image" class="calibre274" /></a></div>
<div class="image-p"><a href="#calibre_link-2378" id="calibre_link-737" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000528.jpg" alt="Image" class="calibre275" /></a></div>
<div class="image-p"><a href="#calibre_link-2379" id="calibre_link-739" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000471.jpg" alt="Image" class="calibre276" /></a></div>
<div class="image-p"><a href="#calibre_link-2380" id="calibre_link-742" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000044.jpg" alt="Image" class="calibre277" /></a></div>
<div class="image-p"><a href="#calibre_link-2381" id="calibre_link-745" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000012.jpg" alt="Image" class="calibre278" /></a></div>
<div class="image-p"><a href="#calibre_link-2382" id="calibre_link-747" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000449.jpg" alt="Image" class="calibre279" /></a></div>
<div class="image-p"><a href="#calibre_link-2383" id="calibre_link-750" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000456.jpg" alt="Image" class="calibre142" /></a></div>
<div class="image-p"><a href="#calibre_link-2384" id="calibre_link-751" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000179.jpg" alt="Image" class="calibre280" /></a></div>
<div class="image-p"><a href="#calibre_link-2385" id="calibre_link-753" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000375.jpg" alt="Image" class="calibre281" /></a></div>
<div class="image-p"><a href="#calibre_link-2386" id="calibre_link-755" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000391.jpg" alt="Image" class="calibre282" /></a></div>
<div class="image-p"><a href="#calibre_link-2387" id="calibre_link-757" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000788.jpg" alt="Image" class="calibre137" /></a></div>
<div class="image-p"><a href="#calibre_link-2388" id="calibre_link-758" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000781.jpg" alt="Image" class="calibre283" /></a></div>
<div class="image-p"><a href="#calibre_link-2389" id="calibre_link-759" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000803.jpg" alt="Image" class="calibre284" /></a></div>
<div class="image-p"><a href="#calibre_link-2390" id="calibre_link-761" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000796.jpg" alt="Image" class="calibre133" /></a></div>
<div class="image-p"><a href="#calibre_link-2391" id="calibre_link-763" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000817.jpg" alt="Image" class="calibre285" /></a></div>
<div class="image-p"><a href="#calibre_link-2392" id="calibre_link-766" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000810.jpg" alt="Image" class="calibre286" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2393">
<div id="calibre_link-5706" class="calibre2">
<div id="calibre_link-5707" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2394" id="calibre_link-772" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000831.jpg" alt="Image" class="calibre287" /></a></div>
<div class="image-p"><a href="#calibre_link-2395" id="calibre_link-773" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000824.jpg" alt="Image" class="calibre288" /></a></div>
<div class="image-p"><a href="#calibre_link-2396" id="calibre_link-775" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000845.jpg" alt="Image" class="calibre289" /></a></div>
<div class="image-p"><a href="#calibre_link-2397" id="calibre_link-777" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000838.jpg" alt="Image" class="calibre290" /></a></div>
<div class="image-p"><a href="#calibre_link-2398" id="calibre_link-781" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000859.jpg" alt="Image" class="calibre291" /></a></div>
<div class="image-p"><a href="#calibre_link-2399" id="calibre_link-782" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000852.jpg" alt="Image" class="calibre292" /></a></div>
<div class="image-p"><a href="#calibre_link-2400" id="calibre_link-784" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000891.jpg" alt="Image" class="calibre254" /></a></div>
<div class="image-p"><a href="#calibre_link-2401" id="calibre_link-786" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000883.jpg" alt="Image" class="calibre293" /></a></div>
<div class="image-p"><a href="#calibre_link-2402" id="calibre_link-787" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000906.jpg" alt="Image" class="calibre294" /></a></div>
<div class="image-p"><a href="#calibre_link-2403" id="calibre_link-788" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000899.jpg" alt="Image" class="calibre295" /></a></div>
<div class="image-p"><a href="#calibre_link-2404" id="calibre_link-791" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000920.jpg" alt="Image" class="calibre293" /></a></div>
<div class="image-p"><a href="#calibre_link-2405" id="calibre_link-792" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000914.jpg" alt="Image" class="calibre296" /></a></div>
<div class="image-p"><a href="#calibre_link-2406" id="calibre_link-793" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000934.jpg" alt="Image" class="calibre297" /></a></div>
<div class="image-p"><a href="#calibre_link-2407" id="calibre_link-795" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000927.jpg" alt="Image" class="calibre298" /></a></div>
<div class="image-p"><a href="#calibre_link-2408" id="calibre_link-796" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000948.jpg" alt="Image" class="calibre299" /></a></div>
<div class="image-p"><a href="#calibre_link-2409" id="calibre_link-797" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000941.jpg" alt="Image" class="calibre300" /></a></div>
<div class="image-p"><a href="#calibre_link-2410" id="calibre_link-798" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000962.jpg" alt="Image" class="calibre301" /></a></div>
<div class="image-p"><a href="#calibre_link-2411" id="calibre_link-799" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000955.jpg" alt="Image" class="calibre302" /></a></div>
<div class="image-p"><a href="#calibre_link-2412" id="calibre_link-800" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000976.jpg" alt="Image" class="calibre96" /></a></div>
<div class="image-p"><a href="#calibre_link-2413" id="calibre_link-802" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000969.jpg" alt="Image" class="calibre303" /></a></div>
<div class="image-p"><a href="#calibre_link-2414" id="calibre_link-803" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000990.jpg" alt="Image" class="calibre304" /></a></div>
<div class="image-p"><a href="#calibre_link-2415" id="calibre_link-805" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000983.jpg" alt="Image" class="calibre305" /></a></div>
<div class="image-p"><a href="#calibre_link-2416" id="calibre_link-806" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001005.jpg" alt="Image" class="calibre306" /></a></div>
<div class="image-p"><a href="#calibre_link-2417" id="calibre_link-808" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001013.jpg" alt="Image" class="calibre307" /></a></div>
<div class="image-p"><a href="#calibre_link-2418" id="calibre_link-809" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001037.jpg" alt="Image" class="calibre308" /></a></div>
<div class="image-p"><a href="#calibre_link-2419" id="calibre_link-810" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001029.jpg" alt="Image" class="calibre309" /></a></div>
<div class="image-p"><a href="#calibre_link-2420" id="calibre_link-812" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001053.jpg" alt="Image" class="calibre301" /></a></div>
<div class="image-p"><a href="#calibre_link-2421" id="calibre_link-813" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001045.jpg" alt="Image" class="calibre310" /></a></div>
<div class="image-p"><a href="#calibre_link-2422" id="calibre_link-814" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001067.jpg" alt="Image" class="calibre311" /></a></div>
<div class="image-p"><a href="#calibre_link-2423" id="calibre_link-815" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001060.jpg" alt="Image" class="calibre312" /></a></div>
<div class="image-p"><a href="#calibre_link-2424" id="calibre_link-816" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001081.jpg" alt="Image" class="calibre313" /></a></div>
<div class="image-p"><a href="#calibre_link-2425" id="calibre_link-818" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001074.jpg" alt="Image" class="calibre314" /></a></div>
<div class="image-p"><a href="#calibre_link-2426" id="calibre_link-819" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001095.jpg" alt="Image" class="calibre315" /></a></div>
<div class="image-p"><a href="#calibre_link-2427" id="calibre_link-820" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001088.jpg" alt="Image" class="calibre316" /></a></div>
<div class="image-p"><a href="#calibre_link-2428" id="calibre_link-822" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001109.jpg" alt="Image" class="calibre317" /></a></div>
<div class="image-p"><a href="#calibre_link-2429" id="calibre_link-823" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001103.jpg" alt="Image" class="calibre317" /></a></div>
<div class="image-p"><a href="#calibre_link-2430" id="calibre_link-824" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001123.jpg" alt="Image" class="calibre315" /></a></div>
<div class="image-p"><a href="#calibre_link-2431" id="calibre_link-829" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001117.jpg" alt="Image" class="calibre318" /></a></div>
<div class="image-p"><a href="#calibre_link-2432" id="calibre_link-832" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001160.jpg" alt="Image" class="calibre319" /></a></div>
<div class="image-p"><a href="#calibre_link-2433" id="calibre_link-834" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001181.jpg" alt="Image" class="calibre320" /></a></div>
<div class="image-p"><a href="#calibre_link-2434" id="calibre_link-836" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001174.jpg" alt="Image" class="calibre321" /></a></div>
<div class="image-p"><a href="#calibre_link-2435" id="calibre_link-840" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001196.jpg" alt="Image" class="calibre322" /></a></div>
<div class="image-p"><a href="#calibre_link-2436" id="calibre_link-841" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001188.jpg" alt="Image" class="calibre323" /></a></div>
<div class="image-p"><a href="#calibre_link-2437" id="calibre_link-843" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001211.jpg" alt="Image" class="calibre320" /></a></div>
<div class="image-p"><a href="#calibre_link-2438" id="calibre_link-845" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001204.jpg" alt="Image" class="calibre324" /></a></div>
<div class="image-p"><a href="#calibre_link-2439" id="calibre_link-846" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001227.jpg" alt="Image" class="calibre325" /></a></div>
<div class="image-p"><a href="#calibre_link-2440" id="calibre_link-847" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001219.jpg" alt="Image" class="calibre326" /></a></div>
<div class="image-p"><a href="#calibre_link-2441" id="calibre_link-848" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001243.jpg" alt="Image" class="calibre327" /></a></div>
<div class="image-p"><a href="#calibre_link-2442" id="calibre_link-849" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001236.jpg" alt="Image" class="calibre328" /></a></div>
<div class="image-p"><a href="#calibre_link-2443" id="calibre_link-851" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001260.jpg" alt="Image" class="calibre329" /></a></div>
<div class="image-p"><a href="#calibre_link-2444" id="calibre_link-852" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001252.jpg" alt="Image" class="calibre330" /></a></div>
<div class="image-p"><a href="#calibre_link-2445" id="calibre_link-853" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000009.jpg" alt="Image" class="calibre331" /></a></div>
<div class="image-p"><a href="#calibre_link-2446" id="calibre_link-854" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000002.jpg" alt="Image" class="calibre332" /></a></div>
<div class="image-p"><a href="#calibre_link-2447" id="calibre_link-855" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000024.jpg" alt="Image" class="calibre333" /></a></div>
<div class="image-p"><a href="#calibre_link-2448" id="calibre_link-856" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000016.jpg" alt="Image" class="calibre334" /></a></div>
<div class="image-p"><a href="#calibre_link-2449" id="calibre_link-857" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000038.jpg" alt="Image" class="calibre335" /></a></div>
<div class="image-p"><a href="#calibre_link-2450" id="calibre_link-864" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000031.jpg" alt="Image" class="calibre336" /></a></div>
<div class="image-p"><a href="#calibre_link-2451" id="calibre_link-865" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000052.jpg" alt="Image" class="calibre337" /></a></div>
<div class="image-p"><a href="#calibre_link-2452" id="calibre_link-867" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000045.jpg" alt="Image" class="calibre338" /></a></div>
<div class="image-p"><a href="#calibre_link-2453" id="calibre_link-868" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000067.jpg" alt="Image" class="calibre339" /></a></div>
<div class="image-p"><a href="#calibre_link-2454" id="calibre_link-869" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000059.jpg" alt="Image" class="calibre340" /></a></div>
<div class="image-p"><a href="#calibre_link-2455" id="calibre_link-870" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000099.jpg" alt="Image" class="calibre341" /></a></div>
<div class="image-p"><a href="#calibre_link-2456" id="calibre_link-871" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000091.jpg" alt="Image" class="calibre342" /></a></div>
<div class="image-p"><a href="#calibre_link-2457" id="calibre_link-872" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000115.jpg" alt="Image" class="calibre343" /></a></div>
<div class="image-p"><a href="#calibre_link-2458" id="calibre_link-873" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000107.jpg" alt="Image" class="calibre344" /></a></div>
<div class="image-p"><a href="#calibre_link-2459" id="calibre_link-874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000131.jpg" alt="Image" class="calibre345" /></a></div>
<div class="image-p"><a href="#calibre_link-2460" id="calibre_link-875" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000123.jpg" alt="Image" class="calibre346" /></a></div>
<div class="image-p"><a href="#calibre_link-2461" id="calibre_link-876" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000147.jpg" alt="Image" class="calibre347" /></a></div>
<div class="image-p"><a href="#calibre_link-2462" id="calibre_link-878" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000139.jpg" alt="Image" class="calibre348" /></a></div>
<div class="image-p"><a href="#calibre_link-2463" id="calibre_link-880" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000163.jpg" alt="Image" class="calibre349" /></a></div>
<div class="image-p"><a href="#calibre_link-2464" id="calibre_link-882" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000155.jpg" alt="Image" class="calibre350" /></a></div>
<div class="image-p"><a href="#calibre_link-2465" id="calibre_link-883" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000187.jpg" alt="Image" class="calibre351" /></a></div>
<div class="image-p"><a href="#calibre_link-2466" id="calibre_link-884" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000195.jpg" alt="Image" class="calibre352" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2467">
<div id="calibre_link-5708" class="calibre2">
<div id="calibre_link-5709" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2468" id="calibre_link-886" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000211.jpg" alt="Image" class="calibre353" /></a></div>
<div class="image-p"><a href="#calibre_link-2469" id="calibre_link-887" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000228.jpg" alt="Image" class="calibre354" /></a></div>
<div class="image-p"><a href="#calibre_link-2470" id="calibre_link-888" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000439.jpg" alt="Image" class="calibre355" /></a></div>
<div class="image-p"><a href="#calibre_link-2471" id="calibre_link-889" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000413.jpg" alt="Image" class="calibre258" /></a></div>
<div class="image-p"><a href="#calibre_link-2472" id="calibre_link-893" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000236.jpg" alt="Image" class="calibre356" /></a></div>
<div class="image-p"><a href="#calibre_link-2473" id="calibre_link-900" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000244.jpg" alt="Image" class="calibre357" /></a></div>
<div class="image-p"><a href="#calibre_link-2474" id="calibre_link-901" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000260.jpg" alt="Image" class="calibre358" /></a></div>
<div class="image-p"><a href="#calibre_link-2475" id="calibre_link-904" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000276.jpg" alt="Image" class="calibre359" /></a></div>
<div class="image-p"><a href="#calibre_link-2476" id="calibre_link-905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000284.jpg" alt="Image" class="calibre360" /></a></div>
<div class="image-p"><a href="#calibre_link-2477" id="calibre_link-906" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000292.jpg" alt="Image" class="calibre361" /></a></div>
<div class="image-p"><a href="#calibre_link-2478" id="calibre_link-907" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000301.jpg" alt="Image" class="calibre362" /></a></div>
<div class="image-p"><a href="#calibre_link-2479" id="calibre_link-908" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000309.jpg" alt="Image" class="calibre363" /></a></div>
<div class="image-p"><a href="#calibre_link-2480" id="calibre_link-909" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000317.jpg" alt="Image" class="calibre364" /></a></div>
<div class="image-p"><a href="#calibre_link-2481" id="calibre_link-910" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000325.jpg" alt="Image" class="calibre365" /></a></div>
<div class="image-p"><a href="#calibre_link-2482" id="calibre_link-911" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000333.jpg" alt="Image" class="calibre366" /></a></div>
<div class="image-p"><a href="#calibre_link-2483" id="calibre_link-912" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000341.jpg" alt="Image" class="calibre367" /></a></div>
<div class="image-p"><a href="#calibre_link-2484" id="calibre_link-914" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000349.jpg" alt="Image" class="calibre368" /></a></div>
<div class="image-p"><a href="#calibre_link-2485" id="calibre_link-915" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000357.jpg" alt="Image" class="calibre369" /></a></div>
<div class="image-p"><a href="#calibre_link-2486" id="calibre_link-917" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000365.jpg" alt="Image" class="calibre370" /></a></div>
<div class="image-p"><a href="#calibre_link-2487" id="calibre_link-918" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000372.jpg" alt="Image" class="calibre371" /></a></div>
<div class="image-p"><a href="#calibre_link-2488" id="calibre_link-919" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000380.jpg" alt="Image" class="calibre372" /></a></div>
<div class="image-p"><a href="#calibre_link-2489" id="calibre_link-920" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000388.jpg" alt="Image" class="calibre373" /></a></div>
<div class="image-p"><a href="#calibre_link-2490" id="calibre_link-921" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000395.jpg" alt="Image" class="calibre374" /></a></div>
<div class="image-p"><a href="#calibre_link-2491" id="calibre_link-923" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000403.jpg" alt="Image" class="calibre375" /></a></div>
<div class="image-p"><a href="#calibre_link-2492" id="calibre_link-924" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000410.jpg" alt="Image" class="calibre376" /></a></div>
<div class="image-p"><a href="#calibre_link-2493" id="calibre_link-925" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000418.jpg" alt="Image" class="calibre377" /></a></div>
<div class="image-p"><a href="#calibre_link-2494" id="calibre_link-927" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000426.jpg" alt="Image" class="calibre378" /></a></div>
<div class="image-p"><a href="#calibre_link-2495" id="calibre_link-928" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000435.jpg" alt="Image" class="calibre379" /></a></div>
<div class="image-p"><a href="#calibre_link-2496" id="calibre_link-929" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000442.jpg" alt="Image" class="calibre380" /></a></div>
<div class="image-p"><a href="#calibre_link-2497" id="calibre_link-931" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000450.jpg" alt="Image" class="calibre381" /></a></div>
<div class="image-p"><a href="#calibre_link-2498" id="calibre_link-932" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000457.jpg" alt="Image" class="calibre382" /></a></div>
<div class="image-p"><a href="#calibre_link-2499" id="calibre_link-934" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000464.jpg" alt="Image" class="calibre383" /></a></div>
<div class="image-p"><a href="#calibre_link-2500" id="calibre_link-935" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000472.jpg" alt="Image" class="calibre384" /></a></div>
<div class="image-p"><a href="#calibre_link-2501" id="calibre_link-936" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000479.jpg" alt="Image" class="calibre385" /></a></div>
<div class="image-p"><a href="#calibre_link-2502" id="calibre_link-937" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000486.jpg" alt="Image" class="calibre386" /></a></div>
<div class="image-p"><a href="#calibre_link-2503" id="calibre_link-939" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000493.jpg" alt="Image" class="calibre386" /></a></div>
<div class="image-p"><a href="#calibre_link-2504" id="calibre_link-940" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000500.jpg" alt="Image" class="calibre387" /></a></div>
<div class="image-p"><a href="#calibre_link-2505" id="calibre_link-941" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000507.jpg" alt="Image" class="calibre388" /></a></div>
<div class="image-p"><a href="#calibre_link-2506" id="calibre_link-942" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000514.jpg" alt="Image" class="calibre389" /></a></div>
<div class="image-p"><a href="#calibre_link-2507" id="calibre_link-943" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000521.jpg" alt="Image" class="calibre390" /></a></div>
<div class="image-p"><a href="#calibre_link-2508" id="calibre_link-944" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000529.jpg" alt="Image" class="calibre391" /></a></div>
<div class="image-p"><a href="#calibre_link-2509" id="calibre_link-945" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000536.jpg" alt="Image" class="calibre392" /></a></div>
<div class="image-p"><a href="#calibre_link-2510" id="calibre_link-946" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000564.jpg" alt="Image" class="calibre393" /></a></div>
<div class="image-p"><a href="#calibre_link-2511" id="calibre_link-947" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000571.jpg" alt="Image" class="calibre394" /></a></div>
<div class="image-p"><a href="#calibre_link-2512" id="calibre_link-948" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000578.jpg" alt="Image" class="calibre395" /></a></div>
<div class="image-p"><a href="#calibre_link-2513" id="calibre_link-949" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000585.jpg" alt="Image" class="calibre396" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2514">
<div id="calibre_link-5710" class="calibre2">
<div id="calibre_link-5711" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2515" id="calibre_link-951" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000592.jpg" alt="Image" class="calibre297" /></a></div>
<div class="image-p"><a href="#calibre_link-2516" id="calibre_link-953" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000599.jpg" alt="Image" class="calibre397" /></a></div>
<div class="image-p"><a href="#calibre_link-2517" id="calibre_link-957" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000606.jpg" alt="Image" class="calibre398" /></a></div>
<div class="image-p"><a href="#calibre_link-2518" id="calibre_link-958" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000613.jpg" alt="Image" class="calibre399" /></a></div>
<div class="image-p"><a href="#calibre_link-2519" id="calibre_link-959" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000620.jpg" alt="Image" class="calibre302" /></a></div>
<div class="image-p"><a href="#calibre_link-2520" id="calibre_link-960" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000627.jpg" alt="Image" class="calibre400" /></a></div>
<div class="image-p"><a href="#calibre_link-2521" id="calibre_link-961" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000634.jpg" alt="Image" class="calibre401" /></a></div>
<div class="image-p"><a href="#calibre_link-2522" id="calibre_link-962" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000641.jpg" alt="Image" class="calibre402" /></a></div>
<div class="image-p"><a href="#calibre_link-2523" id="calibre_link-964" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000655.jpg" alt="Image" class="calibre403" /></a></div>
<div class="image-p"><a href="#calibre_link-2524" id="calibre_link-966" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000661.jpg" alt="Image" class="calibre404" /></a></div>
<div class="image-p"><a href="#calibre_link-2525" id="calibre_link-967" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000667.jpg" alt="Image" class="calibre405" /></a></div>
<div class="image-p"><a href="#calibre_link-2526" id="calibre_link-969" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000673.jpg" alt="Image" class="calibre406" /></a></div>
<div class="image-p"><a href="#calibre_link-2527" id="calibre_link-972" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000680.jpg" alt="Image" class="calibre407" /></a></div>
<div class="image-p"><a href="#calibre_link-2528" id="calibre_link-973" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000687.jpg" alt="Image" class="calibre402" /></a></div>
<div class="image-p"><a href="#calibre_link-2529" id="calibre_link-976" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000694.jpg" alt="Image" class="calibre408" /></a></div>
<div class="image-p"><a href="#calibre_link-2530" id="calibre_link-980" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000701.jpg" alt="Image" class="calibre409" /></a></div>
<div class="image-p"><a href="#calibre_link-2531" id="calibre_link-982" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000708.jpg" alt="Image" class="calibre410" /></a></div>
<div class="image-p"><a href="#calibre_link-2532" id="calibre_link-983" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000715.jpg" alt="Image" class="calibre411" /></a></div>
<div class="image-p"><a href="#calibre_link-2533" id="calibre_link-984" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000729.jpg" alt="Image" class="calibre412" /></a></div>
<div class="image-p"><a href="#calibre_link-2534" id="calibre_link-986" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000736.jpg" alt="Image" class="calibre413" /></a></div>
<div class="image-p"><a href="#calibre_link-2535" id="calibre_link-987" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000743.jpg" alt="Image" class="calibre414" /></a></div>
<div class="image-p"><a href="#calibre_link-2536" id="calibre_link-988" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000750.jpg" alt="Image" class="calibre415" /></a></div>
<div class="image-p"><a href="#calibre_link-2537" id="calibre_link-991" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000757.jpg" alt="Image" class="calibre416" /></a></div>
<div class="image-p"><a href="#calibre_link-2538" id="calibre_link-992" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000764.jpg" alt="Image" class="calibre417" /></a></div>
<div class="image-p"><a href="#calibre_link-2539" id="calibre_link-994" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000771.jpg" alt="Image" class="calibre418" /></a></div>
<div class="image-p"><a href="#calibre_link-2540" id="calibre_link-995" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000778.jpg" alt="Image" class="calibre419" /></a></div>
<div class="image-p"><a href="#calibre_link-2541" id="calibre_link-996" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000785.jpg" alt="Image" class="calibre420" /></a></div>
<div class="image-p"><a href="#calibre_link-2542" id="calibre_link-997" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000792.jpg" alt="Image" class="calibre421" /></a></div>
<div class="image-p"><a href="#calibre_link-2543" id="calibre_link-998" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000800.jpg" alt="Image" class="calibre422" /></a></div>
<div class="image-p"><a href="#calibre_link-2544" id="calibre_link-999" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000807.jpg" alt="Image" class="calibre423" /></a></div>
<div class="image-p"><a href="#calibre_link-2545" id="calibre_link-1000" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000814.jpg" alt="Image" class="calibre424" /></a></div>
<div class="image-p"><a href="#calibre_link-2546" id="calibre_link-1001" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000821.jpg" alt="Image" class="calibre425" /></a></div>
<div class="image-p"><a href="#calibre_link-2547" id="calibre_link-1002" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000828.jpg" alt="Image" class="calibre426" /></a></div>
<div class="image-p"><a href="#calibre_link-2548" id="calibre_link-1005" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000835.jpg" alt="Image" class="calibre427" /></a></div>
<div class="image-p"><a href="#calibre_link-2549" id="calibre_link-1007" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000856.jpg" alt="Image" class="calibre318" /></a></div>
<div class="image-p"><a href="#calibre_link-2550" id="calibre_link-1009" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000863.jpg" alt="Image" class="calibre428" /></a></div>
<div class="image-p"><a href="#calibre_link-2551" id="calibre_link-1010" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000871.jpg" alt="Image" class="calibre429" /></a></div>
<div class="image-p"><a href="#calibre_link-2552" id="calibre_link-1011" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000879.jpg" alt="Image" class="calibre430" /></a></div>
<div class="image-p"><a href="#calibre_link-2553" id="calibre_link-1013" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000887.jpg" alt="Image" class="calibre193" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2554">
<div id="calibre_link-5712" class="calibre2">
<div id="calibre_link-5713" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2555" id="calibre_link-1016" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000895.jpg" alt="Image" class="calibre80" /></a></div>
<div class="image-p"><a href="#calibre_link-2556" id="calibre_link-1018" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000903.jpg" alt="Image" class="calibre431" /></a></div>
<div class="image-p"><a href="#calibre_link-2557" id="calibre_link-1020" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000910.jpg" alt="Image" class="calibre432" /></a></div>
<div class="image-p"><a href="#calibre_link-2558" id="calibre_link-1026" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000952.jpg" alt="Image" class="calibre433" /></a></div>
<div class="image-p"><a href="#calibre_link-2559" id="calibre_link-1028" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000959.jpg" alt="Image" class="calibre434" /></a></div>
<div class="image-p"><a href="#calibre_link-2560" id="calibre_link-1031" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000966.jpg" alt="Image" class="calibre435" /></a></div>
<div class="image-p"><a href="#calibre_link-2561" id="calibre_link-1034" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000973.jpg" alt="Image" class="calibre436" /></a></div>
<div class="image-p"><a href="#calibre_link-2562" id="calibre_link-1036" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000980.jpg" alt="Image" class="calibre437" /></a></div>
<div class="image-p"><a href="#calibre_link-2563" id="calibre_link-1038" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000987.jpg" alt="Image" class="calibre438" /></a></div>
<div class="image-p"><a href="#calibre_link-2564" id="calibre_link-1042" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001001.jpg" alt="Image" class="calibre439" /></a></div>
<div class="image-p"><a href="#calibre_link-2565" id="calibre_link-1044" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001009.jpg" alt="Image" class="calibre440" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2566">
<div id="calibre_link-5714" class="calibre2">
<div id="calibre_link-5715" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2567" id="calibre_link-1046" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001017.jpg" alt="Image" class="calibre441" /></a></div>
<div class="image-p"><a href="#calibre_link-2568" id="calibre_link-1047" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001025.jpg" alt="Image" class="calibre442" /></a></div>
<div class="image-p"><a href="#calibre_link-2569" id="calibre_link-1048" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001033.jpg" alt="Image" class="calibre443" /></a></div>
<div class="image-p"><a href="#calibre_link-2570" id="calibre_link-1050" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001040.jpg" alt="Image" class="calibre443" /></a></div>
<div class="image-p"><a href="#calibre_link-2571" id="calibre_link-1052" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001048.jpg" alt="Image" class="calibre444" /></a></div>
<div class="image-p"><a href="#calibre_link-2572" id="calibre_link-1053" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001056.jpg" alt="Image" class="calibre445" /></a></div>
<div class="image-p"><a href="#calibre_link-2573" id="calibre_link-1054" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001063.jpg" alt="Image" class="calibre446" /></a></div>
<div class="image-p"><a href="#calibre_link-2574" id="calibre_link-1056" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001070.jpg" alt="Image" class="calibre447" /></a></div>
<div class="image-p"><a href="#calibre_link-2575" id="calibre_link-1058" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001077.jpg" alt="Image" class="calibre448" /></a></div>
<div class="image-p"><a href="#calibre_link-2576" id="calibre_link-1059" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001084.jpg" alt="Image" class="calibre449" /></a></div>
<div class="image-p"><a href="#calibre_link-2577" id="calibre_link-1061" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001091.jpg" alt="Image" class="calibre450" /></a></div>
<div class="image-p"><a href="#calibre_link-2578" id="calibre_link-1063" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001112.jpg" alt="Image" class="calibre451" /></a></div>
<div class="image-p"><a href="#calibre_link-2579" id="calibre_link-1065" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001119.jpg" alt="Image" class="calibre452" /></a></div>
<div class="image-p"><a href="#calibre_link-2580" id="calibre_link-1066" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001126.jpg" alt="Image" class="calibre453" /></a></div>
<div class="image-p"><a href="#calibre_link-2581" id="calibre_link-1067" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001133.jpg" alt="Image" class="calibre454" /></a></div>
<div class="image-p"><a href="#calibre_link-2582" id="calibre_link-1068" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001140.jpg" alt="Image" class="calibre455" /></a></div>
<div class="image-p"><a href="#calibre_link-2583" id="calibre_link-1069" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001147.jpg" alt="Image" class="calibre456" /></a></div>
<div class="image-p"><a href="#calibre_link-2584" id="calibre_link-1070" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001155.jpg" alt="Image" class="calibre457" /></a></div>
<div class="image-p"><a href="#calibre_link-2585" id="calibre_link-1071" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001162.jpg" alt="Image" class="calibre458" /></a></div>
<div class="image-p"><a href="#calibre_link-2586" id="calibre_link-1073" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001169.jpg" alt="Image" class="calibre459" /></a></div>
<div class="image-p"><a href="#calibre_link-2587" id="calibre_link-1075" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001176.jpg" alt="Image" class="calibre460" /></a></div>
<div class="image-p"><a href="#calibre_link-2588" id="calibre_link-1077" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001183.jpg" alt="Image" class="calibre461" /></a></div>
<div class="image-p"><a href="#calibre_link-2589" id="calibre_link-1079" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001191.jpg" alt="Image" class="calibre462" /></a></div>
<div class="image-p"><a href="#calibre_link-2590" id="calibre_link-1080" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001199.jpg" alt="Image" class="calibre463" /></a></div>
<div class="image-p"><a href="#calibre_link-2591" id="calibre_link-1081" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001206.jpg" alt="Image" class="calibre464" /></a></div>
<div class="image-p"><a href="#calibre_link-2592" id="calibre_link-1082" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001215.jpg" alt="Image" class="calibre465" /></a></div>
<div class="image-p"><a href="#calibre_link-2593" id="calibre_link-1084" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001223.jpg" alt="Image" class="calibre466" /></a></div>
<div class="image-p"><a href="#calibre_link-2594" id="calibre_link-1086" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001239.jpg" alt="Image" class="calibre467" /></a></div>
<div class="image-p"><a href="#calibre_link-2595" id="calibre_link-1087" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001247.jpg" alt="Image" class="calibre468" /></a></div>
<div class="image-p"><a href="#calibre_link-2596" id="calibre_link-1089" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001255.jpg" alt="Image" class="calibre469" /></a></div>
<div class="image-p"><a href="#calibre_link-2597" id="calibre_link-1091" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000421.jpg" alt="Image" class="calibre470" /></a></div>
<div class="image-p"><a href="#calibre_link-2598" id="calibre_link-1092" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000171.jpg" alt="Image" class="calibre471" /></a></div>
<div class="image-p"><a href="#calibre_link-2599" id="calibre_link-1093" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000398.jpg" alt="Image" class="calibre472" /></a></div>
<div class="image-p"><a href="#calibre_link-2600" id="calibre_link-1095" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000431.jpg" alt="Image" class="calibre473" /></a></div>
<div class="image-p"><a href="#calibre_link-2601" id="calibre_link-1097" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001010.jpg" alt="Image" class="calibre474" /></a></div>
<div class="image-p"><a href="#calibre_link-2602" id="calibre_link-1098" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000872.jpg" alt="Image" class="calibre475" /></a></div>
<div class="image-p"><a href="#calibre_link-2603" id="calibre_link-1099" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001002.jpg" alt="Image" class="calibre476" /></a></div>
<div class="image-p"><a href="#calibre_link-2604" id="calibre_link-1100" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001018.jpg" alt="Image" class="calibre297" /></a></div>
<div class="image-p"><a href="#calibre_link-2605" id="calibre_link-1101" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001026.jpg" alt="Image" class="calibre391" /></a></div>
<div class="image-p"><a href="#calibre_link-2606" id="calibre_link-1102" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001049.jpg" alt="Image" class="calibre477" /></a></div>
<div class="image-p"><a href="#calibre_link-2607" id="calibre_link-1103" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001057.jpg" alt="Image" class="calibre478" /></a></div>
<div class="image-p"><a href="#calibre_link-2608" id="calibre_link-1104" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001078.jpg" alt="Image" class="calibre479" /></a></div>
<div class="image-p"><a href="#calibre_link-2609" id="calibre_link-1106" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001085.jpg" alt="Image" class="calibre480" /></a></div>
<div class="image-p"><a href="#calibre_link-2610" id="calibre_link-1108" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001092.jpg" alt="Image" class="calibre481" /></a></div>
<div class="image-p"><a href="#calibre_link-2611" id="calibre_link-1109" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001099.jpg" alt="Image" class="calibre482" /></a></div>
<div class="image-p"><a href="#calibre_link-2612" id="calibre_link-1111" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001106.jpg" alt="Image" class="calibre483" /></a></div>
<div class="image-p"><a href="#calibre_link-2613" id="calibre_link-1113" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001113.jpg" alt="Image" class="calibre484" /></a></div>
<div class="image-p"><a href="#calibre_link-2614" id="calibre_link-1115" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001120.jpg" alt="Image" class="calibre485" /></a></div>
<div class="image-p"><a href="#calibre_link-2615" id="calibre_link-1116" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001127.jpg" alt="Image" class="calibre486" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2616">
<div id="calibre_link-5716" class="calibre2">
<div id="calibre_link-5717" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2617" id="calibre_link-1119" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001134.jpg" alt="Image" class="calibre402" /></a></div>
<div class="image-p"><a href="#calibre_link-2618" id="calibre_link-1120" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001141.jpg" alt="Image" class="calibre487" /></a></div>
<div class="image-p"><a href="#calibre_link-2619" id="calibre_link-1122" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001148.jpg" alt="Image" class="calibre488" /></a></div>
<div class="image-p"><a href="#calibre_link-2620" id="calibre_link-1123" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001156.jpg" alt="Image" class="calibre489" /></a></div>
<div class="image-p"><a href="#calibre_link-2621" id="calibre_link-1124" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001163.jpg" alt="Image" class="calibre490" /></a></div>
<div class="image-p"><a href="#calibre_link-2622" id="calibre_link-1126" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001192.jpg" alt="Image" class="calibre491" /></a></div>
<div class="image-p"><a href="#calibre_link-2623" id="calibre_link-1129" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001200.jpg" alt="Image" class="calibre492" /></a></div>
<div class="image-p"><a href="#calibre_link-2624" id="calibre_link-1131" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001207.jpg" alt="Image" class="calibre493" /></a></div>
<div class="image-p"><a href="#calibre_link-2625" id="calibre_link-1133" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001216.jpg" alt="Image" class="calibre494" /></a></div>
<div class="image-p"><a href="#calibre_link-2626" id="calibre_link-1135" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001224.jpg" alt="Image" class="calibre495" /></a></div>
<div class="image-p"><a href="#calibre_link-2627" id="calibre_link-1137" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001232.jpg" alt="Image" class="calibre496" /></a></div>
<div class="image-p"><a href="#calibre_link-2628" id="calibre_link-1139" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001240.jpg" alt="Image" class="calibre497" /></a></div>
<div class="image-p"><a href="#calibre_link-2629" id="calibre_link-1141" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001248.jpg" alt="Image" class="calibre498" /></a></div>
<div class="image-p"><a href="#calibre_link-2630" id="calibre_link-1143" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001256.jpg" alt="Image" class="calibre499" /></a></div>
<div class="image-p"><a href="#calibre_link-2631" id="calibre_link-1146" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000381.jpg" alt="Image" class="calibre500" /></a></div>
<div class="image-p"><a href="#calibre_link-2632" id="calibre_link-1147" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001041.jpg" alt="Image" class="calibre501" /></a></div>
<div class="image-p"><a href="#calibre_link-2633" id="calibre_link-1148" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000896.jpg" alt="Image" class="calibre502" /></a></div>
<div class="image-p"><a href="#calibre_link-2634" id="calibre_link-1149" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000880.jpg" alt="Image" class="calibre503" /></a></div>
<div class="image-p"><a href="#calibre_link-2635" id="calibre_link-1150" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000864.jpg" alt="Image" class="calibre503" /></a></div>
<div class="image-p"><a href="#calibre_link-2636" id="calibre_link-1151" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000888.jpg" alt="Image" class="calibre504" /></a></div>
<div class="image-p"><a href="#calibre_link-2637" id="calibre_link-1152" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000645.jpg" alt="Image" class="calibre505" /></a></div>
<div class="image-p"><a href="#calibre_link-2638" id="calibre_link-1154" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001030.jpg" alt="Image" class="calibre506" /></a></div>
<div class="image-p"><a href="#calibre_link-2639" id="calibre_link-1156" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001038.jpg" alt="Image" class="calibre507" /></a></div>
<div class="image-p"><a href="#calibre_link-2640" id="calibre_link-1158" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001054.jpg" alt="Image" class="calibre508" /></a></div>
<div class="image-p"><a href="#calibre_link-2641" id="calibre_link-1160" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000019.jpg" alt="Image" class="calibre509" /></a></div>
<div class="image-p"><a href="#calibre_link-2642" id="calibre_link-1162" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000027.jpg" alt="Image" class="calibre505" /></a></div>
<div class="image-p"><a href="#calibre_link-2643" id="calibre_link-1164" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000034.jpg" alt="Image" class="calibre510" /></a></div>
<div class="image-p"><a href="#calibre_link-2644" id="calibre_link-1166" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000041.jpg" alt="Image" class="calibre510" /></a></div>
<div class="image-p"><a href="#calibre_link-2645" id="calibre_link-1168" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000048.jpg" alt="Image" class="calibre511" /></a></div>
<div class="image-p"><a href="#calibre_link-2646" id="calibre_link-1172" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000055.jpg" alt="Image" class="calibre512" /></a></div>
<div class="image-p"><a href="#calibre_link-2647" id="calibre_link-1173" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000063.jpg" alt="Image" class="calibre513" /></a></div>
<div class="image-p"><a href="#calibre_link-2648" id="calibre_link-1175" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000071.jpg" alt="Image" class="calibre514" /></a></div>
<div class="image-p"><a href="#calibre_link-2649" id="calibre_link-1176" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000079.jpg" alt="Image" class="calibre515" /></a></div>
<div class="image-p"><a href="#calibre_link-2650" id="calibre_link-1179" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000087.jpg" alt="Image" class="calibre516" /></a></div>
<div class="image-p"><a href="#calibre_link-2651" id="calibre_link-1180" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000095.jpg" alt="Image" class="calibre517" /></a></div>
<div class="image-p"><a href="#calibre_link-2652" id="calibre_link-1181" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000103.jpg" alt="Image" class="calibre518" /></a></div>
<div class="image-p"><a href="#calibre_link-2653" id="calibre_link-1183" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000111.jpg" alt="Image" class="calibre519" /></a></div>
<div class="image-p"><a href="#calibre_link-2653" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000119.jpg" alt="Image" class="calibre520" /></a></div>
<div class="image-p"><a href="#calibre_link-2654" id="calibre_link-1185" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000127.jpg" alt="Image" class="calibre521" /></a></div>
<div class="image-p"><a href="#calibre_link-2655" id="calibre_link-1186" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000135.jpg" alt="Image" class="calibre522" /></a></div>
<div class="image-p"><a href="#calibre_link-2656" id="calibre_link-1188" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000143.jpg" alt="Image" class="calibre523" /></a></div>
<div class="image-p"><a href="#calibre_link-2656" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000151.jpg" alt="Image" class="calibre455" /></a></div>
<div class="image-p"><a href="#calibre_link-2657" id="calibre_link-1191" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000159.jpg" alt="Image" class="calibre524" /></a></div>
<div class="image-p"><a href="#calibre_link-2658" id="calibre_link-1193" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000167.jpg" alt="Image" class="calibre525" /></a></div>
<div class="image-p"><a href="#calibre_link-2659" id="calibre_link-1196" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000191.jpg" alt="Image" class="calibre526" /></a></div>
<div class="image-p"><a href="#calibre_link-2660" id="calibre_link-1198" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000199.jpg" alt="Image" class="calibre527" /></a></div>
<div class="image-p"><a href="#calibre_link-2661" id="calibre_link-1200" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000207.jpg" alt="Image" class="calibre528" /></a></div>
<div class="image-p"><a href="#calibre_link-2662" id="calibre_link-1201" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000215.jpg" alt="Image" class="calibre529" /></a></div>
<div class="image-p"><a href="#calibre_link-2663" id="calibre_link-1203" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000224.jpg" alt="Image" class="calibre530" /></a></div>
<div class="image-p"><a href="#calibre_link-2664" id="calibre_link-1205" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000232.jpg" alt="Image" class="calibre531" /></a></div>
<div class="image-p"><a href="#calibre_link-2665" id="calibre_link-1206" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000240.jpg" alt="Image" class="calibre532" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2666">
<div id="calibre_link-5718" class="calibre2">
<div id="calibre_link-5719" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2667" id="calibre_link-1212" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000256.jpg" alt="Image" class="calibre402" /></a></div>
<div class="image-p"><a href="#calibre_link-2668" id="calibre_link-1214" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000265.jpg" alt="Image" class="calibre363" /></a></div>
<div class="image-p"><a href="#calibre_link-2669" id="calibre_link-1215" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000272.jpg" alt="Image" class="calibre533" /></a></div>
<div class="image-p"><a href="#calibre_link-2670" id="calibre_link-1218" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000280.jpg" alt="Image" class="calibre534" /></a></div>
<div class="image-p"><a href="#calibre_link-2671" id="calibre_link-1219" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000288.jpg" alt="Image" class="calibre535" /></a></div>
<div class="image-p"><a href="#calibre_link-2672" id="calibre_link-1220" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000297.jpg" alt="Image" class="calibre536" /></a></div>
<div class="image-p"><a href="#calibre_link-2673" id="calibre_link-1222" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000305.jpg" alt="Image" class="calibre537" /></a></div>
<div class="image-p"><a href="#calibre_link-2674" id="calibre_link-1223" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000313.jpg" alt="Image" class="calibre538" /></a></div>
<div class="image-p"><a href="#calibre_link-2675" id="calibre_link-1224" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000321.jpg" alt="Image" class="calibre181" /></a></div>
<div class="image-p"><a href="#calibre_link-2676" id="calibre_link-1226" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000329.jpg" alt="Image" class="calibre539" /></a></div>
<div class="image-p"><a href="#calibre_link-2677" id="calibre_link-1228" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000337.jpg" alt="Image" class="calibre540" /></a></div>
<div class="image-p"><a href="#calibre_link-2678" id="calibre_link-1229" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000361.jpg" alt="Image" class="calibre541" /></a></div>
<div class="image-p"><a href="#calibre_link-2679" id="calibre_link-1230" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000368.jpg" alt="Image" class="calibre542" /></a></div>
<div class="image-p"><a href="#calibre_link-2680" id="calibre_link-1232" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000376.jpg" alt="Image" class="calibre543" /></a></div>
<div class="image-p"><a href="#calibre_link-2681" id="calibre_link-1238" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000384.jpg" alt="Image" class="calibre544" /></a></div>
<div class="image-p"><a href="#calibre_link-2682" id="calibre_link-1239" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000392.jpg" alt="Image" class="calibre545" /></a></div>
<div class="image-p"><a href="#calibre_link-2683" id="calibre_link-1240" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000399.jpg" alt="Image" class="calibre546" /></a></div>
<div class="image-p"><a href="#calibre_link-2684" id="calibre_link-1243" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000407.jpg" alt="Image" class="calibre547" /></a></div>
<div class="image-p"><a href="#calibre_link-2685" id="calibre_link-1244" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000414.jpg" alt="Image" class="calibre548" /></a></div>
<div class="image-p"><a href="#calibre_link-2685" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000422.jpg" alt="Image" class="calibre549" /></a></div>
<div class="image-p"><a href="#calibre_link-2686" id="calibre_link-1245" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000432.jpg" alt="Image" class="calibre550" /></a></div>
<div class="image-p"><a href="#calibre_link-2687" id="calibre_link-1247" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000447.jpg" alt="Image" class="calibre550" /></a></div>
<div class="image-p"><a href="#calibre_link-2688" id="calibre_link-1249" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000453.jpg" alt="Image" class="calibre551" /></a></div>
<div class="image-p"><a href="#calibre_link-2689" id="calibre_link-1252" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000461.jpg" alt="Image" class="calibre552" /></a></div>
<div class="image-p"><a href="#calibre_link-2690" id="calibre_link-1253" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000468.jpg" alt="Image" class="calibre553" /></a></div>
<div class="image-p"><a href="#calibre_link-2691" id="calibre_link-1254" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000476.jpg" alt="Image" class="calibre554" /></a></div>
<div class="image-p"><a href="#calibre_link-2692" id="calibre_link-1255" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000483.jpg" alt="Image" class="calibre555" /></a></div>
<div class="image-p"><a href="#calibre_link-2693" id="calibre_link-1256" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000491.jpg" alt="Image" class="calibre556" /></a></div>
<div class="image-p"><a href="#calibre_link-2694" id="calibre_link-1258" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000498.jpg" alt="Image" class="calibre557" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2695">
<div id="calibre_link-5720" class="calibre2">
<div id="calibre_link-5721" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2696" id="calibre_link-1262" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000505.jpg" alt="Image" class="calibre558" /></a></div>
<div class="image-p"><a href="#calibre_link-2697" id="calibre_link-1263" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000512.jpg" alt="Image" class="calibre559" /></a></div>
<div class="image-p"><a href="#calibre_link-2698" id="calibre_link-1265" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000519.jpg" alt="Image" class="calibre560" /></a></div>
<div class="image-p"><a href="#calibre_link-2699" id="calibre_link-1266" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000526.jpg" alt="Image" class="calibre561" /></a></div>
<div class="image-p"><a href="#calibre_link-2700" id="calibre_link-1267" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000533.jpg" alt="Image" class="calibre562" /></a></div>
<div class="image-p"><a href="#calibre_link-2701" id="calibre_link-1269" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000540.jpg" alt="Image" class="calibre563" /></a></div>
<div class="image-p"><a href="#calibre_link-2702" id="calibre_link-1270" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000547.jpg" alt="Image" class="calibre564" /></a></div>
<div class="image-p"><a href="#calibre_link-2703" id="calibre_link-1271" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000555.jpg" alt="Image" class="calibre565" /></a></div>
<div class="image-p"><a href="#calibre_link-2704" id="calibre_link-1272" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000562.jpg" alt="Image" class="calibre566" /></a></div>
<div class="image-p"><a href="#calibre_link-2705" id="calibre_link-1273" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000569.jpg" alt="Image" class="calibre563" /></a></div>
<div class="image-p"><a href="#calibre_link-2706" id="calibre_link-1274" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000576.jpg" alt="Image" class="calibre567" /></a></div>
<div class="image-p"><a href="#calibre_link-2707" id="calibre_link-1275" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000604.jpg" alt="Image" class="calibre568" /></a></div>
<div class="image-p"><a href="#calibre_link-2708" id="calibre_link-1277" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000610.jpg" alt="Image" class="calibre569" /></a></div>
<div class="image-p"><a href="#calibre_link-2709" id="calibre_link-1279" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000618.jpg" alt="Image" class="calibre570" /></a></div>
<div class="image-p"><a href="#calibre_link-2710" id="calibre_link-1280" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000625.jpg" alt="Image" class="calibre571" /></a></div>
<div class="image-p"><a href="#calibre_link-2711" id="calibre_link-1281" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000632.jpg" alt="Image" class="calibre572" /></a></div>
<div class="image-p"><a href="#calibre_link-2712" id="calibre_link-1284" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000639.jpg" alt="Image" class="calibre573" /></a></div>
<div class="image-p"><a href="#calibre_link-2713" id="calibre_link-1285" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000652.jpg" alt="Image" class="calibre574" /></a></div>
<div class="image-p"><a href="#calibre_link-2714" id="calibre_link-1294" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000684.jpg" alt="Image" class="calibre575" /></a></div>
<div class="image-p"><a href="#calibre_link-2715" id="calibre_link-1296" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000691.jpg" alt="Image" class="calibre576" /></a></div>
<div class="image-p"><a href="#calibre_link-2716" id="calibre_link-1297" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000698.jpg" alt="Image" class="calibre577" /></a></div>
<div class="image-p"><a href="#calibre_link-2717" id="calibre_link-1298" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000705.jpg" alt="Image" class="calibre578" /></a></div>
<div class="image-p"><a href="#calibre_link-2718" id="calibre_link-1304" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000726.jpg" alt="Image" class="calibre579" /></a></div>
<div class="image-p"><a href="#calibre_link-2719" id="calibre_link-1306" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000733.jpg" alt="Image" class="calibre580" /></a></div>
<div class="image-p"><a href="#calibre_link-2720" id="calibre_link-1307" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000740.jpg" alt="Image" class="calibre581" /></a></div>
<div class="image-p"><a href="#calibre_link-2721" id="calibre_link-1318" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000754.jpg" alt="Image" class="calibre582" /></a></div>
<div class="image-p"><a href="#calibre_link-2722" id="calibre_link-1319" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000761.jpg" alt="Image" class="calibre583" /></a></div>
<div class="image-p"><a href="#calibre_link-2723" id="calibre_link-1324" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000768.jpg" alt="Image" class="calibre584" /></a></div>
<div class="image-p"><a href="#calibre_link-2724" id="calibre_link-1327" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000775.jpg" alt="Image" class="calibre585" /></a></div>
<div class="image-p"><a href="#calibre_link-2725" id="calibre_link-1329" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000782.jpg" alt="Image" class="calibre586" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2726">
<div id="calibre_link-5722" class="calibre2">
<div id="calibre_link-5723" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2727" id="calibre_link-1331" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000789.jpg" alt="Image" class="calibre587" /></a></div>
<div class="image-p"><a href="#calibre_link-2728" id="calibre_link-1332" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000811.jpg" alt="Image" class="calibre588" /></a></div>
<div class="image-p"><a href="#calibre_link-2729" id="calibre_link-1334" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000818.jpg" alt="Image" class="calibre589" /></a></div>
<div class="image-p"><a href="#calibre_link-2730" id="calibre_link-1335" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000825.jpg" alt="Image" class="calibre590" /></a></div>
<div class="image-p"><a href="#calibre_link-2731" id="calibre_link-1336" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000832.jpg" alt="Image" class="calibre591" /></a></div>
<div class="image-p"><a href="#calibre_link-2732" id="calibre_link-1337" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000839.jpg" alt="Image" class="calibre592" /></a></div>
<div class="image-p"><a href="#calibre_link-2732" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000846.jpg" alt="Image" class="calibre593" /></a></div>
<div class="image-p"><a href="#calibre_link-2733" id="calibre_link-1338" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000853.jpg" alt="Image" class="calibre594" /></a></div>
<div class="image-p"><a href="#calibre_link-2734" id="calibre_link-1339" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000860.jpg" alt="Image" class="calibre115" /></a></div>
<div class="image-p"><a href="#calibre_link-2735" id="calibre_link-1340" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000868.jpg" alt="Image" class="calibre595" /></a></div>
<div class="image-p"><a href="#calibre_link-2736" id="calibre_link-1341" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000876.jpg" alt="Image" class="calibre596" /></a></div>
<div class="image-p"><a href="#calibre_link-2737" id="calibre_link-1343" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000884.jpg" alt="Image" class="calibre597" /></a></div>
<div class="image-p"><a href="#calibre_link-2738" id="calibre_link-1345" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000892.jpg" alt="Image" class="calibre598" /></a></div>
<div class="image-p"><a href="#calibre_link-2739" id="calibre_link-1346" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000900.jpg" alt="Image" class="calibre599" /></a></div>
<div class="image-p"><a href="#calibre_link-2740" id="calibre_link-1348" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000427.jpg" alt="Image" class="calibre600" /></a></div>
<div class="image-p"><a href="#calibre_link-2741" id="calibre_link-1353" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000928.jpg" alt="Image" class="calibre601" /></a></div>
<div class="image-p"><a href="#calibre_link-2742" id="calibre_link-1354" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000935.jpg" alt="Image" class="calibre602" /></a></div>
<div class="image-p"><a href="#calibre_link-2743" id="calibre_link-1356" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000942.jpg" alt="Image" class="calibre603" /></a></div>
<div class="image-p"><a href="#calibre_link-2743" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000949.jpg" alt="Image" class="calibre604" /></a></div>
<div class="image-p"><a href="#calibre_link-2744" id="calibre_link-1358" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000956.jpg" alt="Image" class="calibre605" /></a></div>
<div class="image-p"><a href="#calibre_link-2745" id="calibre_link-1359" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000963.jpg" alt="Image" class="calibre606" /></a></div>
<div class="image-p"><a href="#calibre_link-2746" id="calibre_link-1360" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000970.jpg" alt="Image" class="calibre607" /></a></div>
<div class="image-p"><a href="#calibre_link-2746" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000977.jpg" alt="Image" class="calibre608" /></a></div>
<div class="image-p"><a href="#calibre_link-2747" id="calibre_link-1362" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000998.jpg" alt="Image" class="calibre609" /></a></div>
<div class="image-p"><a href="#calibre_link-2748" id="calibre_link-1364" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001006.jpg" alt="Image" class="calibre610" /></a></div>
<div class="image-p"><a href="#calibre_link-2749" id="calibre_link-1366" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001014.jpg" alt="Image" class="calibre611" /></a></div>
<div class="image-p"><a href="#calibre_link-2750" id="calibre_link-1368" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001153.jpg" alt="Image" class="calibre612" /></a></div>
<div class="image-p"><a href="#calibre_link-2751" id="calibre_link-1369" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001189.jpg" alt="Image" class="calibre613" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2752">
<div id="calibre_link-5724" class="calibre2">
<div id="calibre_link-5725" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2753" id="calibre_link-1373" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001208.jpg" alt="Image" class="calibre614" /></a></div>
<div class="image-p"><a href="#calibre_link-2754" id="calibre_link-1375" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001213.jpg" alt="Image" class="calibre615" /></a></div>
<div class="image-p"><a href="#calibre_link-2755" id="calibre_link-1382" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001221.jpg" alt="Image" class="calibre616" /></a></div>
<div class="image-p"><a href="#calibre_link-2756" id="calibre_link-1385" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001229.jpg" alt="Image" class="calibre617" /></a></div>
<div class="image-p"><a href="#calibre_link-2757" id="calibre_link-1386" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001237.jpg" alt="Image" class="calibre618" /></a></div>
<div class="image-p"><a href="#calibre_link-2758" id="calibre_link-1387" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001245.jpg" alt="Image" class="calibre619" /></a></div>
<div class="image-p"><a href="#calibre_link-2759" id="calibre_link-1390" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001253.jpg" alt="Image" class="calibre620" /></a></div>
<div class="image-p"><a href="#calibre_link-2760" id="calibre_link-1391" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000006.jpg" alt="Image" class="calibre621" /></a></div>
<div class="image-p"><a href="#calibre_link-2761" id="calibre_link-1392" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000921.jpg" alt="Image" class="calibre622" /></a></div>
<div class="image-p"><a href="#calibre_link-2762" id="calibre_link-1393" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001046.jpg" alt="Image" class="calibre623" /></a></div>
<div class="image-p"><a href="#calibre_link-2763" id="calibre_link-1394" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001023.jpg" alt="Image" class="calibre624" /></a></div>
<div class="image-p"><a href="#calibre_link-2764" id="calibre_link-1397" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000028.jpg" alt="Image" class="calibre625" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2765">
<div id="calibre_link-5726" class="calibre2">
<div id="calibre_link-5727" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2766" id="calibre_link-1410" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000049.jpg" alt="Image" class="calibre626" /></a></div>
<div class="image-p"><a href="#calibre_link-2767" id="calibre_link-1412" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000056.jpg" alt="Image" class="calibre627" /></a></div>
<div class="image-p"><a href="#calibre_link-2768" id="calibre_link-1415" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000088.jpg" alt="Image" class="calibre628" /></a></div>
<div class="image-p"><a href="#calibre_link-2769" id="calibre_link-1417" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000096.jpg" alt="Image" class="calibre629" /></a></div>
<div class="image-p"><a href="#calibre_link-2769" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000104.jpg" alt="Image" class="calibre630" /></a></div>
<div class="image-p"><a href="#calibre_link-2770" id="calibre_link-1418" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000112.jpg" alt="Image" class="calibre631" /></a></div>
<div class="image-p"><a href="#calibre_link-2771" id="calibre_link-1419" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000120.jpg" alt="Image" class="calibre632" /></a></div>
<div class="image-p"><a href="#calibre_link-2772" id="calibre_link-1420" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000128.jpg" alt="Image" class="calibre633" /></a></div>
<div class="image-p"><a href="#calibre_link-2773" id="calibre_link-1421" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000136.jpg" alt="Image" class="calibre634" /></a></div>
<div class="image-p"><a href="#calibre_link-2774" id="calibre_link-1422" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000144.jpg" alt="Image" class="calibre635" /></a></div>
<div class="image-p"><a href="#calibre_link-2775" id="calibre_link-1423" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000152.jpg" alt="Image" class="calibre636" /></a></div>
<div class="image-p"><a href="#calibre_link-2776" id="calibre_link-1424" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000160.jpg" alt="Image" class="calibre637" /></a></div>
<div class="image-p"><a href="#calibre_link-2777" id="calibre_link-1425" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000168.jpg" alt="Image" class="calibre638" /></a></div>
<div class="image-p"><a href="#calibre_link-2778" id="calibre_link-1426" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000200.jpg" alt="Image" class="calibre639" /></a></div>
<div class="image-p"><a href="#calibre_link-2779" id="calibre_link-1427" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000208.jpg" alt="Image" class="calibre640" /></a></div>
<div class="image-p"><a href="#calibre_link-2780" id="calibre_link-1428" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000216.jpg" alt="Image" class="calibre641" /></a></div>
<div class="image-p"><a href="#calibre_link-2781" id="calibre_link-1429" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000225.jpg" alt="Image" class="calibre642" /></a></div>
<div class="image-p"><a href="#calibre_link-2782" id="calibre_link-1430" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000233.jpg" alt="Image" class="calibre643" /></a></div>
<div class="image-p"><a href="#calibre_link-2783" id="calibre_link-1431" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000241.jpg" alt="Image" class="calibre644" /></a></div>
<div class="image-p"><a href="#calibre_link-2784" id="calibre_link-1433" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000249.jpg" alt="Image" class="calibre645" /></a></div>
<div class="image-p"><a href="#calibre_link-2785" id="calibre_link-1434" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000257.jpg" alt="Image" class="calibre646" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2786">
<div id="calibre_link-5728" class="calibre2">
<div id="calibre_link-5729" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2787" id="calibre_link-1441" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000281.jpg" alt="Image" class="calibre647" /></a></div>
<div class="image-p"><a href="#calibre_link-2788" id="calibre_link-1444" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000289.jpg" alt="Image" class="calibre648" /></a></div>
<div class="image-p"><a href="#calibre_link-2789" id="calibre_link-1446" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000298.jpg" alt="Image" class="calibre649" /></a></div>
<div class="image-p"><a href="#calibre_link-2790" id="calibre_link-1447" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000306.jpg" alt="Image" class="calibre650" /></a></div>
<div class="image-p"><a href="#calibre_link-2791" id="calibre_link-1448" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000314.jpg" alt="Image" class="calibre651" /></a></div>
<div class="image-p"><a href="#calibre_link-2792" id="calibre_link-1449" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000322.jpg" alt="Image" class="calibre652" /></a></div>
<div class="image-p"><a href="#calibre_link-2793" id="calibre_link-1454" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000354.jpg" alt="Image" class="calibre653" /></a></div>
<div class="image-p"><a href="#calibre_link-2794" id="calibre_link-1456" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000362.jpg" alt="Image" class="calibre654" /></a></div>
<div class="image-p"><a href="#calibre_link-2795" id="calibre_link-1457" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000369.jpg" alt="Image" class="calibre655" /></a></div>
<div class="image-p"><a href="#calibre_link-2796" id="calibre_link-1458" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000377.jpg" alt="Image" class="calibre656" /></a></div>
<div class="image-p"><a href="#calibre_link-2797" id="calibre_link-1459" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000385.jpg" alt="Image" class="calibre657" /></a></div>
<div class="image-p"><a href="#calibre_link-2798" id="calibre_link-1460" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000393.jpg" alt="Image" class="calibre658" /></a></div>
<div class="image-p"><a href="#calibre_link-2799" id="calibre_link-1461" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000400.jpg" alt="Image" class="calibre659" /></a></div>
<div class="image-p"><a href="#calibre_link-2800" id="calibre_link-1462" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000408.jpg" alt="Image" class="calibre660" /></a></div>
<div class="image-p"><a href="#calibre_link-2801" id="calibre_link-1463" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000415.jpg" alt="Image" class="calibre661" /></a></div>
<div class="image-p"><a href="#calibre_link-2802" id="calibre_link-1464" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000423.jpg" alt="Image" class="calibre662" /></a></div>
<div class="image-p"><a href="#calibre_link-2803" id="calibre_link-1465" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000428.jpg" alt="Image" class="calibre663" /></a></div>
<div class="image-p"><a href="#calibre_link-2804" id="calibre_link-1466" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000436.jpg" alt="Image" class="calibre664" /></a></div>
<div class="image-p"><a href="#calibre_link-2805" id="calibre_link-1467" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000443.jpg" alt="Image" class="calibre665" /></a></div>
<div class="image-p"><a href="#calibre_link-2806" id="calibre_link-1468" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000454.jpg" alt="Image" class="calibre666" /></a></div>
<div class="image-p"><a href="#calibre_link-2807" id="calibre_link-1469" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000462.jpg" alt="Image" class="calibre667" /></a></div>
<div class="image-p"><a href="#calibre_link-2808" id="calibre_link-1470" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000469.jpg" alt="Image" class="calibre189" /></a></div>
<div class="image-p"><a href="#calibre_link-2809" id="calibre_link-1471" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000477.jpg" alt="Image" class="calibre668" /></a></div>
<div class="image-p"><a href="#calibre_link-2810" id="calibre_link-1472" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000484.jpg" alt="Image" class="calibre669" /></a></div>
<div class="image-p"><a href="#calibre_link-2811" id="calibre_link-1473" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000487.jpg" alt="Image" class="calibre670" /></a></div>
<div class="image-p"><a href="#calibre_link-2812" id="calibre_link-1474" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000494.jpg" alt="Image" class="calibre671" /></a></div>
<div class="image-p"><a href="#calibre_link-2813" id="calibre_link-1475" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000501.jpg" alt="Image" class="calibre672" /></a></div>
<div class="image-p"><a href="#calibre_link-2814" id="calibre_link-1476" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000508.jpg" alt="Image" class="calibre673" /></a></div>
<div class="image-p"><a href="#calibre_link-2815" id="calibre_link-1477" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000515.jpg" alt="Image" class="calibre674" /></a></div>
<div class="image-p"><a href="#calibre_link-2816" id="calibre_link-1478" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000522.jpg" alt="Image" class="calibre675" /></a></div>
<div class="image-p"><a href="#calibre_link-2817" id="calibre_link-1479" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000534.jpg" alt="Image" class="calibre676" /></a></div>
<div class="image-p"><a href="#calibre_link-2818" id="calibre_link-1480" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000541.jpg" alt="Image" class="calibre677" /></a></div>
<div class="image-p"><a href="#calibre_link-2819" id="calibre_link-1481" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000558.jpg" alt="Image" class="calibre678" /></a></div>
<div class="image-p"><a href="#calibre_link-2820" id="calibre_link-1482" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000565.jpg" alt="Image" class="calibre679" /></a></div>
<div class="image-p"><a href="#calibre_link-2821" id="calibre_link-1483" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000572.jpg" alt="Image" class="calibre680" /></a></div>
<div class="image-p"><a href="#calibre_link-2822" id="calibre_link-1485" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000579.jpg" alt="Image" class="calibre681" /></a></div>
<div class="image-p"><a href="#calibre_link-2822" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000586.jpg" alt="Image" class="calibre682" /></a></div>
<div class="image-p"><a href="#calibre_link-2823" id="calibre_link-1486" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000593.jpg" alt="Image" class="calibre683" /></a></div>
<div class="image-p"><a href="#calibre_link-2824" id="calibre_link-1488" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000600.jpg" alt="Image" class="calibre684" /></a></div>
<div class="image-p"><a href="#calibre_link-2825" id="calibre_link-1491" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000611.jpg" alt="Image" class="calibre685" /></a></div>
<div class="image-p"><a href="#calibre_link-2826" id="calibre_link-1496" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000614.jpg" alt="Image" class="calibre686" /></a></div>
<div class="image-p"><a href="#calibre_link-2827" id="calibre_link-1497" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000646.jpg" alt="Image" class="calibre687" /></a></div>
<div class="image-p"><a href="#calibre_link-2828" id="calibre_link-1498" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000653.jpg" alt="Image" class="calibre688" /></a></div>
<div class="image-p"><a href="#calibre_link-2829" id="calibre_link-1499" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000659.jpg" alt="Image" class="calibre689" /></a></div>
<div class="image-p"><a href="#calibre_link-2830" id="calibre_link-1500" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000665.jpg" alt="Image" class="calibre690" /></a></div>
<div class="image-p"><a href="#calibre_link-2831" id="calibre_link-1501" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000671.jpg" alt="Image" class="calibre691" /></a></div>
<div class="image-p"><a href="#calibre_link-2832" id="calibre_link-1503" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000678.jpg" alt="Image" class="calibre692" /></a></div>
<div class="image-p"><a href="#calibre_link-2833" id="calibre_link-1504" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000685.jpg" alt="Image" class="calibre693" /></a></div>
<div class="image-p"><a href="#calibre_link-2834" id="calibre_link-1506" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000692.jpg" alt="Image" class="calibre690" /></a></div>
<div class="image-p"><a href="#calibre_link-2835" id="calibre_link-1507" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000699.jpg" alt="Image" class="calibre694" /></a></div>
<div class="image-p"><a href="#calibre_link-2836" id="calibre_link-1510" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000706.jpg" alt="Image" class="calibre695" /></a></div>
<div class="image-p"><a href="#calibre_link-2837" id="calibre_link-1511" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000713.jpg" alt="Image" class="calibre696" /></a></div>
<div class="image-p"><a href="#calibre_link-2838" id="calibre_link-1513" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000720.jpg" alt="Image" class="calibre697" /></a></div>
<div class="image-p"><a href="#calibre_link-2839" id="calibre_link-1515" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000727.jpg" alt="Image" class="calibre698" /></a></div>
<div class="image-p"><a href="#calibre_link-2840" id="calibre_link-1518" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000734.jpg" alt="Image" class="calibre699" /></a></div>
<div class="image-p"><a href="#calibre_link-2841" id="calibre_link-1520" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000741.jpg" alt="Image" class="calibre700" /></a></div>
<div class="image-p"><a href="#calibre_link-2842" id="calibre_link-1523" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000776.jpg" alt="Image" class="calibre701" /></a></div>
<div class="image-p"><a href="#calibre_link-2843" id="calibre_link-1524" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000783.jpg" alt="Image" class="calibre702" /></a></div>
<div class="image-p"><a href="#calibre_link-2844" id="calibre_link-1526" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000790.jpg" alt="Image" class="calibre703" /></a></div>
<div class="image-p"><a href="#calibre_link-2845" id="calibre_link-1528" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000798.jpg" alt="Image" class="calibre704" /></a></div>
<div class="image-p"><a href="#calibre_link-2846" id="calibre_link-1529" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000805.jpg" alt="Image" class="calibre703" /></a></div>
<div class="image-p"><a href="#calibre_link-2847" id="calibre_link-1531" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000812.jpg" alt="Image" class="calibre705" /></a></div>
</section>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-2848">
<div id="calibre_link-5730" class="calibre2">
<div id="calibre_link-5731" class="calibre3"><section type="chapter" class="calibre4">
<div class="image-p"><a href="#calibre_link-2849" id="calibre_link-1534" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000819.jpg" alt="Image" class="calibre706" /></a></div>
<div class="image-p"><a href="#calibre_link-2850" id="calibre_link-1535" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000826.jpg" alt="Image" class="calibre707" /></a></div>
<div class="image-p"><a href="#calibre_link-2851" id="calibre_link-1537" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000840.jpg" alt="Image" class="calibre708" /></a></div>
<div class="image-p"><a href="#calibre_link-2852" id="calibre_link-1538" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000847.jpg" alt="Image" class="calibre709" /></a></div>
<div class="image-p"><a href="#calibre_link-2853" id="calibre_link-1539" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000854.jpg" alt="Image" class="calibre710" /></a></div>
<div class="image-p"><a href="#calibre_link-2854" id="calibre_link-1540" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000861.jpg" alt="Image" class="calibre711" /></a></div>
<div class="image-p"><a href="#calibre_link-2855" id="calibre_link-1541" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000869.jpg" alt="Image" class="calibre712" /></a></div>
<div class="image-p"><a href="#calibre_link-2856" id="calibre_link-1543" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000877.jpg" alt="Image" class="calibre713" /></a></div>
<div class="image-p"><a href="#calibre_link-2857" id="calibre_link-1544" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000885.jpg" alt="Image" class="calibre714" /></a></div>
<div class="image-p"><a href="#calibre_link-2858" id="calibre_link-1545" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000893.jpg" alt="Image" class="calibre715" /></a></div>
<div class="image-p"><a href="#calibre_link-2859" id="calibre_link-1546" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000901.jpg" alt="Image" class="calibre716" /></a></div>
<div class="image-p"><a href="#calibre_link-2860" id="calibre_link-1547" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000908.jpg" alt="Image" class="calibre717" /></a></div>
<div class="image-p"><a href="#calibre_link-2861" id="calibre_link-1555" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000915.jpg" alt="Image" class="calibre718" /></a></div>
<div class="image-p"><a href="#calibre_link-2862" id="calibre_link-1557" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000929.jpg" alt="Image" class="calibre719" /></a></div>
<div class="image-p"><a href="#calibre_link-2863" id="calibre_link-1559" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000936.jpg" alt="Image" class="calibre720" /></a></div>
<div class="image-p"><a href="#calibre_link-2864" id="calibre_link-1561" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000943.jpg" alt="Image" class="calibre721" /></a></div>
<div class="image-p"><a href="#calibre_link-2865" id="calibre_link-1564" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000950.jpg" alt="Image" class="calibre722" /></a></div>
<div class="image-p"><a href="#calibre_link-2866" id="calibre_link-1566" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000957.jpg" alt="Image" class="calibre723" /></a></div>
<div class="image-p"><a href="#calibre_link-2867" id="calibre_link-1567" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000964.jpg" alt="Image" class="calibre724" /></a></div>
<div class="image-p"><a href="#calibre_link-2868" id="calibre_link-1568" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000971.jpg" alt="Image" class="calibre116" /></a></div>
<div class="image-p"><a href="#calibre_link-2869" id="calibre_link-1569" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000978.jpg" alt="Image" class="calibre725" /></a></div>
<div class="image-p"><a href="#calibre_link-2870" id="calibre_link-1571" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000985.jpg" alt="Image" class="calibre726" /></a></div>
<div class="image-p"><a href="#calibre_link-2871" id="calibre_link-1575" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000992.jpg" alt="Image" class="calibre727" /></a></div>
<div class="image-p"><a href="#calibre_link-2872" id="calibre_link-1576" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000999.jpg" alt="Image" class="calibre728" /></a></div>
<div class="image-p"><a href="#calibre_link-2873" id="calibre_link-1579" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001007.jpg" alt="Image" class="calibre727" /></a></div>
<div class="image-p"><a href="#calibre_link-2874" id="calibre_link-1581" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001015.jpg" alt="Image" class="calibre729" /></a></div>
<div class="image-p"><a href="#calibre_link-2874" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001019.jpg" alt="Image" class="calibre730" /></a></div>
<div class="image-p"><a href="#calibre_link-2875" id="calibre_link-1583" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001034.jpg" alt="Image" class="calibre731" /></a></div>
<div class="image-p"><a href="#calibre_link-2876" id="calibre_link-1584" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001042.jpg" alt="Image" class="calibre732" /></a></div>
<div class="image-p"><a href="#calibre_link-2877" id="calibre_link-1587" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001050.jpg" alt="Image" class="calibre733" /></a></div>
<div class="image-p"><a href="#calibre_link-2878" id="calibre_link-1588" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001061.jpg" alt="Image" class="calibre734" /></a></div>
<div class="image-p"><a href="#calibre_link-2879" id="calibre_link-1591" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001068.jpg" alt="Image" class="calibre735" /></a></div>
<div class="image-p"><a href="#calibre_link-2880" id="calibre_link-1592" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001075.jpg" alt="Image" class="calibre736" /></a></div>
<div class="image-p"><a href="#calibre_link-2881" id="calibre_link-1594" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001082.jpg" alt="Image" class="calibre737" /></a></div>
<div class="image-p"><a href="#calibre_link-2882" id="calibre_link-1597" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001089.jpg" alt="Image" class="calibre738" /></a></div>
<div class="image-p"><a href="#calibre_link-2883" id="calibre_link-1598" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001096.jpg" alt="Image" class="calibre739" /></a></div>
<div class="image-p"><a href="#calibre_link-2884" id="calibre_link-1600" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001100.jpg" alt="Image" class="calibre740" /></a></div>
<div class="image-p"><a href="#calibre_link-2885" id="calibre_link-1604" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001114.jpg" alt="Image" class="calibre741" /></a></div>
<div class="image-p"><a href="#calibre_link-2886" id="calibre_link-1605" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001124.jpg" alt="Image" class="calibre726" /></a></div>
<div class="image-p"><a href="#calibre_link-2887" id="calibre_link-1606" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001131.jpg" alt="Image" class="calibre742" /></a></div>
<div class="image-p"><a href="#calibre_link-2888" id="calibre_link-1608" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001138.jpg" alt="Image" class="calibre743" /></a></div>
<div class="image-p"><a href="#calibre_link-2889" id="calibre_link-1611" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001145.jpg" alt="Image" class="calibre744" /></a></div>
<div class="image-p"><a href="#calibre_link-2890" id="calibre_link-1612" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001152.jpg" alt="Image" class="calibre745" /></a></div>
<div class="image-p"><a href="#calibre_link-2891" id="calibre_link-1614" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001157.jpg" alt="Image" class="calibre744" /></a></div>
<div class="image-p"><a href="#calibre_link-2892" id="calibre_link-1616" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001167.jpg" alt="Image" class="calibre739" /></a></div>
<div class="image-p"><a href="#calibre_link-2893" id="calibre_link-1617" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001171.jpg" alt="Image" class="calibre746" /></a></div>
<div class="image-p"><a href="#calibre_link-2894" id="calibre_link-1618" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001178.jpg" alt="Image" class="calibre747" /></a></div>
<div class="image-p"><a href="#calibre_link-2895" id="calibre_link-1620" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001185.jpg" alt="Image" class="calibre748" /></a></div>
<div class="image-p"><a href="#calibre_link-2896" id="calibre_link-1623" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001201.jpg" alt="Image" class="calibre749" /></a></div>
<div class="image-p"><a href="#calibre_link-2897" id="calibre_link-1624" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001212.jpg" alt="Image" class="calibre147" /></a></div>
<div class="image-p"><a href="#calibre_link-2898" id="calibre_link-1625" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001220.jpg" alt="Image" class="calibre750" /></a></div>
<div class="image-p"><a href="#calibre_link-2899" id="calibre_link-1626" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001228.jpg" alt="Image" class="calibre750" /></a></div>
<div class="image-p"><a href="#calibre_link-2900" id="calibre_link-1629" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001233.jpg" alt="Image" class="calibre751" /></a></div>
<div class="image-p"><a href="#calibre_link-2901" id="calibre_link-1630" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001244.jpg" alt="Image" class="calibre752" /></a></div>
<div class="image-p"><a href="#calibre_link-2902" id="calibre_link-1633" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001249.jpg" alt="Image" class="calibre753" /></a></div>
<div class="image-p"><a href="#calibre_link-2902" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/001257.jpg" alt="Image" class="calibre754" /></a></div>
<div class="image-p"><a href="#calibre_link-2903" id="calibre_link-1634" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000003.jpg" alt="Image" class="calibre755" /></a></div>
<div class="image-p"><a href="#calibre_link-2904" id="calibre_link-1635" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000010.jpg" alt="Image" class="calibre756" /></a></div>
<div class="image-p"><a href="#calibre_link-2905" id="calibre_link-1637" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000017.jpg" alt="Image" class="calibre757" /></a></div>
<div class="image-p"><a href="#calibre_link-2905" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000020.jpg" alt="Image" class="calibre758" /></a></div>
<div class="image-p"><a href="#calibre_link-2906" id="calibre_link-1638" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000032.jpg" alt="Image" class="calibre759" /></a></div>
<div class="image-p"><a href="#calibre_link-2907" id="calibre_link-1639" class="pcalibre pcalibre3 pcalibre1 pcalibre2 calibre8"><img src="images/000039.jpg" alt="Image" class="calibre760" /></a></div>
</section>
</div>
</div>
</div>


</body></html>